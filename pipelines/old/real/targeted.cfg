!title Targeted Sequencing

#To include this, must define:
# all keys required by common.cfg

lap_home=/home/unix/flannick/lap

# lap_home=/home/flannick/broad/lap

lap_trunk=$lap_home/trunk
lap_projects=$lap_home/projects
targeted_base_dir=/humgen/gsa-hpprojects/pfizer/projects/targeted/scratch/flannick
common_bin_dir=$lap_projects/common
targeted_bin_dir=$targeted_base_dir/bin

r_212_cmd=/broad/software/free/Linux/redhat_5_x86_64/pkgs/r_2.12.0/bin/R
r_cmd=R
r_215_cmd=/broad/software/free/Linux/redhat_5_x86_64/pkgs/r_2.15.1/bin/R

!include $lap_trunk/config/common.cfg
pdflatex_cmd=/broad/software/free/Linux/redhat_5_x86_64/pkgs/texlive-20110510/bin/x86_64-linux/pdflatex

#Pipeline specific stuff

#types
class project=Project with marker,seq_batch,sample_qc_filter,var_qc_filter,project_sample_subset,project_variant_subset,project_merge_subset
minor class project_sample_subset=Sample Subset parent project with marker_variant_subset
minor class project_variant_subset=Variant Subset parent project with marker_variant_subset
minor class project_merge_subset=Merge Subset parent project
minor class sample_qc_filter=Sample QC Filter parent project
minor class var_qc_filter=Variant QC Filter parent project
minor class marker=Marker parent project with marker_sample_subset,marker_variant_subset
minor class marker_sample_subset=Marker Sample Subset parent project_sample_subset consistent marker
minor class marker_variant_subset=Marker Variant Subset parent project_variant_subset consistent marker 
minor class seq_batch=Seq Batch parent project
class pheno=Phenotype parent project with pheno_qc_filter,pheno_variant_subset,pheno_sample_subset,burden,pheno_test
minor class pheno_value=Phenotype Value parent pheno
minor class pheno_variant_subset=Pheno Subset parent pheno consistent project_variant_subset 
minor class pheno_sample_subset=Pheno Sample Subset parent pheno consistent project_sample_subset 
minor class pheno_variant_qc_strata=Pheno QC Strata parent pheno with pheno_variant_qc_strata_variant_subset,pheno_variant_qc_pheno_strata
minor class pheno_variant_qc_strata_variant_subset=Pheno QC Strata Subset parent pheno_variant_qc_strata consistent project_variant_subset
minor class pheno_variant_qc_pheno_strata=Pheno QC Pheno Strata parent pheno with pheno_variant_qc_pheno_strata_variant_subset,pheno_variant_qc_strata
minor class pheno_variant_qc_pheno_strata_variant_subset=Pheno QC Pheno Strata Subset parent pheno_variant_qc_pheno_strata consistent project_variant_subset
minor class pheno_qc_filter=Pheno QC Filter parent pheno
class pheno_test=SV Test parent pheno with pheno_test_variant_subset
minor class pheno_test_variant_subset=SV Test Subset parent pheno_test consistent pheno_variant_subset,project_variant_subset 
class annot=Annot parent project with annot_var_qc_filter,annot_variant_subset
minor class annot_var_qc_filter=Annot Variant QC Filter parent annot
minor class annot_variant_subset=Annot Subset parent annot consistent project_variant_subset 
class burden=Burden parent pheno with burden_test consistent annot
minor class burden_variant_subset=Burden Subset parent burden consistent pheno_variant_subset,project_variant_subset,annot_variant_subset 
class burden_test=Burden Test parent burden with burden_variant_subset,burden_test_variant_subset
minor class burden_test_variant_subset=Burden Test Subset parent burden_test consistent burden_variant_subset,pheno_variant_subset,project_variant_subset,annot_variant_subset
minor class region=Region parent project
minor class locus=Locus parent pheno consistent region
class gene=Gene parent locus with gene_burden,variant consistent pheno_variant_subset,project_variant_subset
minor class gene_burden=Gene Burden parent gene consistent burden,annot with transcript_burden
minor class transcript_burden=Transcript Burden parent gene_burden
minor class variant=Variant parent gene
minor class call_set=Call Set parent project
minor class call_set_subset=Call Set Subset parent call_set with call_set_sample_subset
minor class call_set_sample_subset=Call Set Sample Subset parent call_set_subset
#minor class project_subset=Project Subset parent project
class sample=Sample parent project

#directories
sortable mkdir path projects_dir=$unix_out_dir/projects
sortable mkdir path project_dir=$projects_dir/@project class_level project
sortable mkdir path project_sample_subsets_dir=$project_dir/project_sample_subsets class_level project
sortable mkdir path project_sample_subset_dir=$project_sample_subsets_dir/@project_sample_subset class_level project_sample_subset
sortable mkdir path project_variant_subsets_dir=$project_dir/project_variant_subsets class_level project
sortable mkdir path project_variant_subset_dir=$project_variant_subsets_dir/@project_variant_subset class_level project_variant_subset
sortable mkdir path project_merge_subsets_dir=$project_dir/project_merge_subsets class_level project
sortable mkdir path project_merge_subset_dir=$project_merge_subsets_dir/@project_merge_subset class_level project_merge_subset
sortable mkdir path pheno_variant_qc_stratas_dir=$project_dir/pheno_variant_qc_stratas class_level project
sortable mkdir path pheno_variant_qc_strata_variant_subsets_dir=$project_dir/pheno_variant_qc_strata_variant_subsets class_level project
sortable mkdir path pheno_variant_qc_pheno_stratas_dir=$project_dir/pheno_variant_qc_pheno_stratas class_level project
sortable mkdir path pheno_variant_qc_pheno_strata_variant_subsets_dir=$project_dir/pheno_variant_qc_pheno_strata_variant_subsets class_level project
sortable mkdir path markers_dir=$project_dir/markers class_level project
sortable mkdir path marker_dir=$markers_dir/@marker class_level marker
sortable mkdir path marker_sample_subsets_dir=$project_sample_subset_dir/marker_sample_subsets class_level project_sample_subset
sortable mkdir path marker_sample_subset_dir=$marker_sample_subsets_dir/@marker_sample_subset class_level marker_sample_subset
sortable mkdir path marker_variant_subsets_dir=$project_variant_subset_dir/marker_variant_subsets class_level project_variant_subset
sortable mkdir path marker_variant_subset_dir=$marker_variant_subsets_dir/@marker_variant_subset class_level marker_variant_subset
sortable mkdir path call_sets_dir=$project_dir/call_sets class_level project
sortable mkdir path call_set_dir=$call_sets_dir/@call_set class_level call_set
sortable mkdir path call_set_subsets_dir=$call_set_dir/call_set_subsets_dir class_level call_set
sortable mkdir path call_set_sample_subsets_dir=$call_set_dir/call_set_sample_subsets_dir class_level call_set
#sortable mkdir path project_subsets_dir=$project_dir/project_subsets_dir class_level project
sortable mkdir path seq_batches_dir=$project_dir/seq_batches class_level project
sortable mkdir path seq_batch_dir=$seq_batches_dir/@seq_batch class_level seq_batch
sortable mkdir path phenos_dir=$project_dir/phenos class_level project
sortable mkdir path pheno_dir=$phenos_dir/@pheno class_level pheno
sortable mkdir path pheno_variant_subsets_dir=$pheno_dir/pheno_variant_subsets class_level pheno
sortable mkdir path pheno_variant_subset_dir=$pheno_variant_subsets_dir/@pheno_variant_subset class_level pheno_variant_subset
sortable mkdir path pheno_sample_subsets_dir=$pheno_dir/pheno_sample_subsets class_level pheno
sortable mkdir path pheno_sample_subset_dir=$pheno_sample_subsets_dir/@pheno_sample_subset class_level pheno_sample_subset
sortable mkdir path pheno_tests_dir=$pheno_dir/pheno_tests class_level pheno
sortable mkdir path pheno_test_dir=$pheno_tests_dir/@pheno_test class_level pheno_test
sortable mkdir path pheno_test_variant_subsets_dir=$pheno_test_dir/pheno_test_variant_subsets class_level pheno_test
sortable mkdir path pheno_test_variant_subset_dir=$pheno_test_variant_subsets_dir/@pheno_test_variant_subset class_level pheno_test_variant_subset
sortable mkdir path annots_dir=$project_dir/annots class_level project
sortable mkdir path annot_dir=$annots_dir/@annot class_level annot
sortable mkdir path annot_variant_subsets_dir=$annot_dir/annot_variant_subsets class_level annot
sortable mkdir path annot_variant_subset_dir=$annot_variant_subsets_dir/@annot_variant_subset class_level annot_variant_subset
sortable mkdir path burdens_dir=$pheno_dir/burdens class_level pheno
sortable mkdir path burden_dir=$burdens_dir/@burden class_level burden
sortable mkdir path burden_variant_subsets_dir=$burden_dir/burden_variant_subsets class_level burden
sortable mkdir path burden_variant_subset_dir=$burden_variant_subsets_dir/@burden_variant_subset class_level burden_variant_subset
sortable mkdir path burden_tests_dir=$burden_dir/burden_tests class_level burden
sortable mkdir path burden_test_dir=$burden_tests_dir/@burden_test class_level burden_test
sortable mkdir path burden_test_variant_subsets_dir=$burden_test_dir/burden_test_variant_subsets class_level burden_test
sortable mkdir path burden_test_variant_subset_dir=$burden_test_variant_subsets_dir/@burden_test_variant_subset class_level burden_test_variant_subset
sortable mkdir path regions_dir=$project_dir/regions class_level project
sortable mkdir path region_dir=$regions_dir/@region class_level region
sortable mkdir path loci_dir=$pheno_dir/loci class_level pheno
sortable mkdir path locus_dir=$loci_dir/@locus class_level locus
sortable mkdir path genes_dir=$pheno_dir/genes class_level pheno
sortable mkdir path gene_dir=$genes_dir/@gene class_level gene
sortable mkdir path gene_burdens_dir=$gene_dir/gene_burdens class_level gene
sortable mkdir path gene_burden_dir=$gene_burdens_dir/@gene_burden class_level gene_burden
sortable mkdir path transcript_burdens_dir=$gene_burden_dir/transcript_burdens class_level gene_burden
sortable mkdir path transcript_burden_dir=$transcript_burdens_dir/@transcript_burden class_level transcript_burden
sortable mkdir path variants_dir=$gene_dir/variants class_level gene
sortable mkdir path variant_dir=$variants_dir/@variant class_level variant
sortable mkdir path samples_dir=$project_dir/samples class_level project
sortable mkdir path sample_dir=$samples_dir/@sample class_level sample

#command classes/memory
cmd_class epstopdf_cmd_class=epstopdf env_mod TEMP:$tmp_dir
cmd_class python_cmd_class=python env_mod PYTHONPATH:$lib_dir/python
#cmd_class javac_cmd_class=javac umask_mod 002 
vstats_plot_mem=2000
pseq_gstats_mem=4000
pseq_pathway_mem=4000
pseq_gene_mem=4000
pseq_mem=2000
epacts_vassoc_mem=2000
epacts_eigen_mem=2000
recode_call_set_vcf_mem=5000
clean_vcf_mem=2000
epacts_gassoc_mem=2000
#cmd_class pseq_cmd_class=pseq env_mod LD_LIBRARY_PATH:$plinkseq_share_lib_dir

epacts_share_dir=$lib_dir/epacts/EPACTS-3.2.4/lib
cmd_class epacts_cmd_class=epacts env_mod R_LIBS_USER:$epacts_share_dir
cmd_class gstats_cmd_class=g-stats rusage_mod $pseq_gstats_mem
samtools_mem=4000
cmd_class samtools_cmd_class=samtools rusage_mod $samtools_mem
impute2_mem=2000
cmd_class impute2_cmd_class=$impute2_cmd rusage_mod $impute2_mem
cmd_class vep_cmd_class=$vep_cmd env_mod PATH:$tabix_dir,PERL5LIB:$vep_plugin_dir

mds_mem=2000
cmd_class mds_plot_cmd_class=mds-plot rusage_mod $mds_mem
cmd_class smart_pca_cmd_class=$smart_pca_cmd env_mod PATH:$eigensoft_dir
cmd_class multiallelic_qc_cmd_class=multiallelic_QC_metrics.R env_mod R_LIBS_USER:$lib_dir/pseq/pseq-0.08.2

hidden_output_class vcf_class=.vcf.gz update_ext tbi

merge_vcf_mem=3000
initial_vcf_mem=3000
initial_merge_vcf_mem=2000
missed_sites_mem=2000
recessive_full_hwe_mem=4000
project_plink_mem=2000
score_test_mem=2000
project_plinkseq_bfile_mem=2000
project_sample_subset_plinkseq_bfile_mem=2000
all_marker_mem=2000
genome_pdf_mem=2000
load_sample_db_mem=2000
pheno_genome_mem=2000
kin_mem=2000
vep_mem=2000
trait_vassoc_annot_mem=2000

smart_pca_mem=2000

snpeff_heap=4g
gatk_heap=3g

#IMPORTANT PROPERTIES/KEYS

#END IMPORTANT PROPERTIES/KEYS

#external files/directories

#pseq stuff
pseq_exons_loc_group=genes-unmerged
pseq_genes_loc_group=genes

plinkseq_local_home=$lib_dir/pseq
plinkseq_r_home=$plinkseq_local_home/R
plinkseq_rplinkseq_lib=$plinkseq_local_home/R/Rplinkseq/lib
plinkseq_global_home=/psych/genetics/pseq
#plinkseq_resources_dir=$plinkseq_global_home/resources
#plinkseq_share_lib_dir=$plinkseq_global_home/share/lib
#plinkseq_share_lib_dir=$plinkseq_local_home/share/lib
#pseq_cmd=$plinkseq_global_home/client/pseq
#pseq_cmd=$plinkseq_local_home/client/pseq
pseq_dir=$lib_dir/pseq/pseq-0.08.2
pseq_cmd=$pseq_dir/client/pseq

plinkseq_okay_err='conflicting type'

epacts_cmd=$lib_dir/epacts/EPACTS-3.2.4/bin/epacts
#epacts_old_cmd=$lib_dir/epacts/epacts2.01/epacts

mantra_cmd=$lib_dir/mantra/MANTRA_software/mantra.v2.1
dmatcal_cmd=$lib_dir/mantra/MANTRA_software/dmatcal

metasoft_cmd=java -jar $lib_dir/metasoft/Metasoft.jar
metasoft_pvalue_table=$lib_dir/metasoft/HanEskinPvalueTable.txt

metal_cmd=$lib_dir/metal/generic-metal/metal

#heng stuff
samtools_dir=$lib_dir/samtools/samtools-0.1.12a
bcftools_cmd=$samtools_dir/bcftools/bcftools
samtools_cmd=$samtools_dir/samtools
tabix_dir=/broad/software/free/Linux/redhat_5_x86_64/pkgs/tabix/tabix_0.2.2/bin
tabix_cmd=$tabix_dir/tabix
bgzip_cmd=$tabix_dir/bgzip

fetch_ucsc_cmd=sleep 15 && python $lib_dir/fetch_ucsc/fetch_ucsc.py

#CMD: perl -e 'print "chr1:109698512-109698676\nchr1:109686159-109686303"' | xargs -i ../lib/samtools/samtools-0.1.12a/samtools mpileup -r {} -C50 -DSug -f /seq/references/Homo_sapiens_assembly18/v0/Homo_sapiens_assembly18.fasta -b test.bam.list > a.bcf

score_seq_cmd=$lib_dir/score_seq/SCORE-Seq

#to use a different hg build, define :
hg_build=19
ensembl_version=74

plink_chrX=23
plink_chrY=24
plink_chrXY=25
plink_chrM=26

plink_male=1
plink_female=2

chrX=X
chrY=Y
chrXY=XY
chrM=MT

chrX_par=60001-2699520 154931044-155260560

snpeff_db_dir=$snpeff_dir/db
snpeff_genome=GRCh37.74
snpeff_dbsnp=$snpeff_db_dir/dbSnp.vcf
#snpeff_gwas_cat=$snpeff_db_dir/gwascatalog.txt
snpeff_dbnsfp=$snpeff_db_dir/dbNSFP2.4.txt.gz
dbnsfp_cols_start=9
dbnsfp_cols_ignore=SLR

ensembl_reference=$lib_dir/ensembl/reference/hg19/Homo_sapiens_assembly19.fasta 

hg_refflat=hg${hg_build}_refFlat
#dbsnp_vcf_file=/humgen/gsa-hpprojects/GATK/bundle/current/hg$hg_build/dbsnp_132.hg$hg_build.vcf
dbsnp_vcf_file=/humgen/gsa-hpprojects/GATK/bundle/current/b37/dbsnp_137.b37.vcf
reference_file=/seq/references/Homo_sapiens_assembly19/v1/Homo_sapiens_assembly19.fasta 
plinkseq_resources_dir=$plinkseq_local_home/resources/hg$hg_build

#plinkseq_refdb=$plinkseq_resources_dir/refdb
#plinkseq_seqdb=$plinkseq_resources_dir/seqdb
#plinkseq_ref_locdb_file=$plinkseq_resources_dir/locdb
#plinkseq_pph2db_file=$plinkseq_resources_dir/pph2.db
#Near as I can tell, pph2 does not depend on hg build
#when Shaun updates hg19 with link to pph2.db, uncomment above
pph2_whess_file=$lib_dir/pph2/whess/hg$hg_build/pph2.all.transcripts.bed.gz
genetic_map_file=/fg/software/Tagger/assocplot/genetic_map_chr@1.txt
#For the strand file the coordinates dont matter --- just the strands
genetic_strand_file=/fg/software/Tagger/assocplot/known_genes_build35_050307_chr@{1}.txt
#end reference defines
conservation_dir=$lib_dir/conservation/hg$hg_build

lib_dir=$targeted_base_dir/lib

gatk_home=$lib_dir/gatk
gatk_dir=$gatk_home/dist
gatk_jar=$gatk_dir/GenomeAnalysisTK.jar
gatk_dt=BY_SAMPLE
gatk_dcov=600
gatk_cmd_no_info_no_heap=java -Xmx@2 -jar $gatk_jar -R $reference_file -dt $gatk_dt -dcov $gatk_dcov -U LENIENT_VCF_PROCESSING -T @1
gatk_cmd_no_info=$gatk_cmd_no_info_no_heap(@1,$gatk_heap)
gatk_cmd_no_interval_no_heap=$gatk_cmd_no_info_no_heap(@1,@2)
gatk_cmd_no_interval=$gatk_cmd_no_info(@1)
gatk_cmd_no_heap=$gatk_cmd_no_interval_no_heap(@1,@2) !{input,-L,project_expanded_interval_list_file,if_prop=expand_targets,allow_empty=1} !{input,-L,project_interval_list_file,unless_prop=expand_targets,allow_empty=1}
gatk_cmd=$gatk_cmd_no_interval(@1) !{input,-L,project_expanded_interval_list_file,if_prop=expand_targets,allow_empty=1} !{input,-L,project_interval_list_file,unless_prop=expand_targets,allow_empty=1} 
gatk_cmd_dbsnp=$gatk_cmd(@1) --dbsnp $dbsnp_vcf_file 
gatk_cmd_dbsnp_no_heap=$gatk_cmd_no_heap(@1,@2) --dbsnp $dbsnp_vcf_file

queue_dir=$gatk_dir
queue_jar=$queue_dir/Queue.jar
sg_combine_scala_script=$targeted_bin_dir/SGCombine.scala

germline_dir=$lib_dir/germline
bgl_to_ped_cmd=$germline_dir/parser/bgl_to_ped
germline_cmd=$germline_dir/germline-1-4-2/germline

igv_jar=$lib_dir/igv/IGV_2.0.9/igv.jar
haploview_jar=$lib_dir/haploview/Haploview4.1/Haploview.jar

beagle_jar=$lib_dir/beagle/beagle.jar
nsamples=1
omitprefix=true
beagle_mem=2g
beagle_missing=0

snpeff_dir=$lib_dir/snpEff/snpEff
snpeff_jar=$snpeff_dir/snpEff.jar
snpsift_dir=$lib_dir/snpEff/snpEff
snpsift_jar=$snpsift_dir/SnpSift.jar
snpeff_config=$snpeff_dir/snpEff.config

chaos_cmd=perl $lib_dir/chaos/chaos_hg$hg_build/xchaos
map_effects_cmd=perl $lib_dir/annot/annot.v2/bin/mapCat2.pl

vep_dir=$lib_dir/ensembl/variant_effect_predictor
vep_plugin_dir=$vep_dir/VEP_plugins
vep_condel_config_dir=$vep_plugin_dir/config/Condel/config
loftee_human_ancestor_path=$vep_plugin_dir/loftee-master/human_ancestor.fa.rz
ensembl_cache_dir=$lib_dir/ensembl/cache

vep_cmd=perl $vep_dir/variant_effect_predictor.pl

vep_custom_tabix=$conservation_dir/29way.omega.v2.allchr.bed.gz $conservation_dir/gerp.allchr.bed.gz $conservation_dir/phyloP.allchr.bed.gz $conservation_dir/1kg.20101123.snps_indels_sv.sites.bed.gz
vep_custom_names=29_mammals_omega GERP_UCSC_RS PhyloP 1000G

vep_custom_tabix=$conservation_dir/29way.omega.v2.allchr.bed.gz $conservation_dir/gerp.allchr.bed.gz
vep_custom_names=29_mammals_omega GERP_UCSC_RS

#local_plinkseq_home=$lib_dir/pseq
#nalt=NMIN
nalt=NALT

open_vnc_display=export DISPLAY=`python $common_bin_dir/open_vncdisplay.py`
close_vnc_display=out=\$?; vncserver -kill \$DISPLAY; exit \$out

plink_cmd=plink --noweb
plink2_cmd=$lib_dir/plink/plink2
plink108_cmd=$lib_dir/plink/plink108 --noweb
plink_mds_cmd=$lib_dir/plink/plink-1.07-src/plink --noweb
plink_mv_log_cmd=sleep 1 && mv @1.log @2
plinkseq_exome_browser_url=http://plinkseq.broadinstitute.org/cgi-bin/pbrowse.cgi

#ASSOCIATION TESTS
##=====================

#There are 4 steps to define association tests for a phenotype
#1. At pheno level, define whether to cluster and compute MDS and which traits should be used as covariates
#2. At the burden level, define the class of variants (using annotations)
#3. At the pheno test level, define the tests to run and give them properties
#4. At the burden test level, define the tests to run and give them properties


##TEST INPUTS
##============

##For stratification control
prop strata_traits=list #traits to use to stratify samples (for permutations and for clustering). Must override or set run_raw to turn off at test level 
prop covar_traits=list #potential traits to use as covariates. Must override or set run_raw to turn off at test level 

prop num_mds_calc=scalar default 10 #number of MDS values to compute
prop num_mds_plot=scalar default 4 #number of MDS values to plot
prop extra_traits=list #include additional traits in pheno file

prop run_cluster=scalar default 0 #must set to 1 if want any tests to use clustering


#for inclusion in clean annot --- display of top single variant hits
#Variants with differential missingness lower than this p-value will be removed
#i.e. .01
prop min_clean_p_missing=scalar
#Variants with call rates below this fraction will be removed
#i.e. .9
prop min_clean_geno=scalar
#Variants with HWE p-values below this number will be removed
#i.e. 1e-6
prop min_clean_hwe=scalar


##ANNOTATIONS
##====================

#the following annotation must appear as a column in the master annotation file
vcf_type_annot=Consequence
vcf_protein_change_annot=Protein_change
#Type must also have values representing these three classes
vcf_type_synonymous_annot=synonymous_variant
vcf_type_missense_annot=missense_variant
vcf_type_nonsense_annot=stop_gained

#These are added to vassoc annot file
#prop vassoc_meta_annot=list default "Codons SNPEFF_Effect SIFT_PRED SIFT_SCORE PolyPhen_PRED PolyPhen_SCORE Condel_PRED Condel_SCORE SNPEFF_dbNSFP_aapos_SIFT	SNPEFF_dbNSFP_SIFT_score	SNPEFF_dbNSFP_SIFT_converted_rankscore	SNPEFF_dbNSFP_SIFT_pred	SNPEFF_dbNSFP_Polyphen2_HDIV_score	SNPEFF_dbNSFP_Polyphen2_HDIV_rankscore	SNPEFF_dbNSFP_Polyphen2_HDIV_pred	SNPEFF_dbNSFP_Polyphen2_HVAR_score	SNPEFF_dbNSFP_Polyphen2_HVAR_rankscore	SNPEFF_dbNSFP_Polyphen2_HVAR_pred	SNPEFF_dbNSFP_LRT_score	SNPEFF_dbNSFP_LRT_converted_rankscore	SNPEFF_dbNSFP_LRT_pred	SNPEFF_dbNSFP_MutationTaster_score	SNPEFF_dbNSFP_MutationTaster_converted_rankscore	SNPEFF_dbNSFP_MutationTaster_pred	SNPEFF_dbNSFP_MutationAssessor_score	SNPEFF_dbNSFP_MutationAssessor_rankscore	SNPEFF_dbNSFP_MutationAssessor_pred	SNPEFF_dbNSFP_FATHMM_score	SNPEFF_dbNSFP_FATHMM_rankscore	SNPEFF_dbNSFP_FATHMM_pred	SNPEFF_dbNSFP_RadialSVM_score	SNPEFF_dbNSFP_RadialSVM_rankscore	SNPEFF_dbNSFP_RadialSVM_pred	SNPEFF_dbNSFP_LR_score	SNPEFF_dbNSFP_LR_rankscore	SNPEFF_dbNSFP_LR_pred	SNPEFF_dbNSFP_Reliability_index	SNPEFF_dbNSFP_CADD_raw_rankscore	SNPEFF_dbNSFP_CADD_raw	SNPEFF_dbNSFP_CADD_phred	SNPEFF_dbNSFP_phyloP46way_primate_rankscore	SNPEFF_dbNSFP_phyloP46way_primate	SNPEFF_dbNSFP_phyloP46way_placental	SNPEFF_dbNSFP_phyloP46way_placental_rankscore	SNPEFF_dbNSFP_phyloP100way_vertebrate	SNPEFF_dbNSFP_phyloP100way_vertebrate_rankscore	SNPEFF_dbNSFP_phastCons46way_primate	SNPEFF_dbNSFP_phastCons46way_primate_rankscore	SNPEFF_dbNSFP_phastCons46way_placental_rankscore	SNPEFF_dbNSFP_phastCons46way_placental	SNPEFF_dbNSFP_phastCons100way_vertebrate	SNPEFF_dbNSFP_phastCons100way_vertebrate_rankscore	SNPEFF_dbNSFP_SiPhy_29way_pi	SNPEFF_dbNSFP_SiPhy_29way_logOdds_rankscore	SNPEFF_dbNSFP_SiPhy_29way_logOdds	SNPEFF_dbNSFP_LRT_Omega	SNPEFF_dbNSFP_UniSNP_ids	SNPEFF_dbNSFP_1000Gp1_AC	SNPEFF_dbNSFP_1000Gp1_AFR_AF	SNPEFF_dbNSFP_1000Gp1_AFR_AC	SNPEFF_dbNSFP_1000Gp1_AF	SNPEFF_dbNSFP_1000Gp1_EUR_AC	SNPEFF_dbNSFP_1000Gp1_EUR_AF	SNPEFF_dbNSFP_1000Gp1_AMR_AC	SNPEFF_dbNSFP_1000Gp1_AMR_AF	SNPEFF_dbNSFP_1000Gp1_ASN_AC	SNPEFF_dbNSFP_1000Gp1_ASN_AF	SNPEFF_dbNSFP_ESP6500_AA_AF	SNPEFF_dbNSFP_ESP6500_EA_AF"
prop vassoc_meta_annot=list default "Codons SNPEFF_Effect SIFT_PRED SIFT_SCORE PolyPhen_PRED PolyPhen_SCORE Condel_PRED Condel_SCORE "
#These are the fields in the display tables
prop vassoc_meta_disp=list default "$vcf_type_annot $vcf_protein_change_annot SIFT_PRED PolyPhen_PRED Condel_PRED"
#Must be same length as vassoc_meta_disp; the values to insert for headers
prop vassoc_meta_headers=list default "Type Change SIFT PPH Condel"

#original entries in cells to change
prop old_disp_annots=list
#new entries in cells to change; must be same length as old disp annots
prop new_disp annots=list

#to specify the annotation mask for a burden test, you can specify an OR of AND clauses
#each element in the list is an AND clause; the clauses are ORed together
#elements in the AND clause should be separated by $burden_and_delim
#each element should first have the value to filter on, and then the filter (separated by $burden_filter_delim)
#lists (multiple OR clauses) can be specified on one line by separating clauses by a , within {}
#otherwise, multiple lines can be used (must be done when adding an AND clause unless $burden_and_delim is changed
select_and_delim=&
select_filter_delim=;
prop annot_mask=list

prop annot_genes=list #only consider variants from these genes
prop only_for_interesting=list #run this burden only for interesting genes

prop use_raw_variants=scalar #use raw variants rather than clean variants

#-----
#Example masks
#-----
#nonsynonymous or nonsense or readthrough
#!key vcf_readthrough_annot STOP_LOST
#burden_ns burden_annot_mask {$vcf_type_annot;eq:$vcf_missense_annot,$vcf_type_annot;eq:$vcf_nonsense_annot,$vcf_type_annot;eq:$vcf_readthrough_annot}
#loss of function
#burden_lof burden_annot_mask {SNPEFF_Effect;eq:SPLICE_SITE_DONOR,SNPEFF_Effect;eq:SPLICE_SITE_ACCEPTOR,$vcf_type_annot;eq:$vcf_nonsense_annot,$vcf_type_annot;eq:$vcf_readthrough_annot}
#severe
#burden_severe burden_annot_mask {SNPEFF_Effect;eq:SPLICE_SITE_DONOR,SNPEFF_Effect;eq:SPLICE_SITE_ACCEPTOR,$vcf_type_annot;eq:$vcf_nonsense_annot,$vcf_type_annot;eq:$vcf_readthrough_annot}
#burden_severe burden_annot_mask PolyPhen_PRED;probably damaging,SIFT_PRED;damaging
#-----


#-----
#example burden test entries in meta file
#-----
#{type_annot,missense_annot,synonymous_annot,nonsense_annot,readthrough_annot,snpeff_effect_annot,splice_acceptor_annot,splice_donor_annot,protein_change_annot,pph_annot,sift_annot,pph2_annot,condel_annot,complex_indel_annot,frameshift_annot} prop scalar
#project {type_annot,missense_annot,synonymous_annot,nonsense_annot,readthrough_annot,snpeff_effect_annot,splice_acceptor_annot,splice_donor_annot,protein_change_annot,pph_annot,sift_annot,pph2_annot,condel_annot,complex_indel_annot,frameshift_annot} {Consequence,NON_SYNONYMOUS_CODING,SYNONYMOUS_CODING,STOP_GAINED,STOP_LOST,SNPEFF_Effect,SPLICE_SITE_ACCEPTOR,SPLICE_SITE_DONOR,Protein_change,PolyPhen_PRED,SIFT_PRED,PPH2_hdiv_class,Condel_SCORE,COMPLEX_IN/DEL,FRAMESHIFT_CODING}
#project key_as_prop annot_missing_field

#macros to use for masks
#!macro :coding_mask: @protein_change_annot;ne:@annot_missing_field
#!macro :syn_mask: @type_annot;eq:@synonymous_annot

#setting up an internal macro
#!macro :lof_maski: @snpeff_effect_annot;eq:@splice_donor_annot,@snpeff_effect_annot;eq:@splice_acceptor_annot,@type_annot;eq:@nonsense_annot,@type_annot;eq:@readthrough_annot,@type_annot;eq:@complex_indel_annot,@type_annot;eq:@frameshift_annot

#expands all ',' in :lof_maski:, so treated as multiple entries (list) with OR semantics
#!macro :lof_mask: {:lof_maski:}

#lof OR missense
#!macro :ns_mask: {:lof_maski:,@type_annot;eq:@missense_annot}

#all polyphen damaging
#!macro :pph_mask: @pph_annot;damaging

#not in {}, so does not expand and recognized as a sigle entry, with ',' indicating AND
#!macro :pph_and_sift_mask: @pph_annot;damaging,@sift_annot;deleterious

#in {}, so expands and recognized as two entries, indicating OR
#!macro :pph_or_sift_mask: {@pph_annot;damaging,@sift_annot;deleterious}

#example masks

#coding
#burden_coding burden_annot_mask :coding_mask:

#loss of function
#burden_lof burden_annot_mask :lof_mask:

#example pph and sift: first entry has AND semantics, then OR with second (lof). Then cap MAF < 1%
#burden_pph_and_sift_1pct burden_annot_mask :pph_and_sift_mask:
#burden_pph_and_sift_1pct burden_annot_mask :lof_mask:
#burden_pph_and_sift_1pct burden_maf .01

#When create interesting variants, add this annotation
col_for_var_annot=PolyPhen_SCORE
disp_for_var_annot=PPH

#for annot: apply extended qc of variants (defined by is_extended_filter)
prop apply_extended_qc=scalar
#for annot: apply extended strict qc of variants (defined by is_extended_strict_filter)
prop apply_extended_strict_qc=scalar

#for annot: union multiple annots to get this one
prop union_annots=list

#MAF/MAC filters (applied on top of any annotation filters)

#at level of annot (project wide)
prop annot_maf=scalar #calculated averaged over all samples
prop annot_mac_lb=scalar
prop annot_mac_ub=scalar
prop annot_strat_maf_summary=scalar #could be mean,max,min,geometric,harmonic,contraharmonic


#for burden: union multiple burdens to get this one
prop union_burdens=list

#at level of burden (for non-missing phenotype data)
prop burden_maf=scalar #calculated averaged over all samples
prop burden_mac_lb=scalar
prop burden_mac_ub=scalar
prop burden_strat_maf_summary=scalar #could be mean,max,min,geometric,harmonic,contraharmonic


#to aid display
prop no_var_filter=scalar #dont display a table with top variants
prop no_var_qq=scalar #dont display a QQ plot
prop no_gene_qq=scalar #dont display a gene QQ plot
prop no_gene_burden=scalar #dont create a gene burden

prop max_associated_maf=scalar #maximum MAF to display variants in table of top hits
prop min_pheno_mac=scalar default 3 #minimum minor allele count to appear on slide of top associated (or QQ plot)



##ASSOCIATION TESTS
##====================

prop strat_cluster=scalar #use clusters to correct for stratification
prop strata_traits=list #stratify by traits to correct for stratification
prop strat_covar=scalar default 1 #use PCs to correct for stratification
prop num_mds_covar=scalar default 10 #num MDS to use for strat control
prop covar_traits=list #include traits as covariates to correct for stratification (if dont want these and defined at pheno level, make sure to override)
prop alternate_pheno=list #swap in alternate phenotype to run
prop extra_covar_traits=list #include extra traits as available for covariates specific to this burden test. Does not work for PLINK/SEQ. Must also make sure to specify in covar_traits the specific covariates to include.
prop manual_covar_traits=list #hard code these in as covariates.
prop run_raw=scalar #dont correct for stratification (overrides everything)
prop include_related=scalar #include related samples

prop test_tag=scalar #what to display as a tag in master join files
prop test_software=scalar #FOR SV: either pseq or epacts or plink or R #FOR BURDEN: either pseq or epacts
prop test_name=list #passed to software with the test flag
prop test_options=list #passed to software as additional test options

prop use_for_interesting=scalar default 1 #use this test statistic to define interesting genes or variants
prop use_for_display=scalar default 1 #display this test in summary tables


#EPACTS specific
prop epacts_gt_field=scalar default $thresholded_nalt_field #which field to use fo epacts (PL, GT, DOS also acceptable)

#PSEQ specific
#how to handle missing data in burden tests
#If true, permute phenotypes only of samples with non-missing genotypes
#If have a lot of missing data, setting true will kill power
#If have differential missingness, setting false will produce huge artifacts
#i.e. 0
prop fix_null=scalar 

#MANTRA/METAL SPECIFIC
#the pheno_test id to meta-analyze
prop meta_test=list
#flag if the meta test has no subsets (e.g. if it is METAL or has been changed to have no subsets)
prop meta_test_no_subsets=scalar

prop metal_scheme=scalar default STDERR
#gc correct metal input files
prop gc_correct=scalar 
#minimum mac for meta-analysis
prop min_mantra_mac=scalar default 0


##SV TEST SPECIFIC
##====================

#what the P value column is in the small annot file produced
#prop p_col=scalar default P
#what the OR column is in the small annot file produced
#prop or_col=scalar
#what should be displayed for the OR column
#prop or_disp=scalar default OR

prop use_for_or=scalar default 1 #treat output as valid odds ratio

#these will be available in the small vassoc file (if they can be produced from the test)
id_col_disp=ID
n_col_disp=N
neff_col_disp=N_EFF
ncase_col_disp=N_CASE
ncontrol_col_disp=N_CTRL
maf_col_disp=MAF
p_col_disp=P
or_col_disp=OR
dir_col_disp=DIR
bf_col_disp=LOG_BF
beta_col_disp=BETA
zscore_col_disp=ZSCORE
se_col_disp=SE
ref_col_disp=REF
alt_col_disp=ALT


##BURDEN TEST SPECIFIC
##====================

#PSEQ specific
prop make_two_sided=scalar #for pseq, set to TRUE to run case and control and then combine
prop analytic=scalar default 0 #for pseq, do not use permutations for p-values
#max frac missing genotypes to include in burden tests
#If value is too high, and if fix_null is true, may lose power
#i.e. .2
prop max_assoc_null=scalar
prop min_test_p_missing=scalar #max p_missing to include in burden tests
prop min_test_p_hwe=scalar #max p_hwe to include in burden tests
prop phenos_for_p_hwe=list #compute p_hwe across all of these and exclude if missing in any
prop custom_burden_test_exclude_filters=list #custom filters from vstats file to exclude variants


##SELECTION OF INTERESTING VARIANTS & GENES
#==========================================
prop max_interesting_variant_p_value=scalar default 0 #any single variant with p-value less than this is interesting, regardless of gene
prop min_interesting_variant_p_missing_value=scalar default .05 #must have p-missing greater than this  to be interesting
prop max_interesting_variant_maf=scalar default .05 #must have maf less than this to be interesting
prop min_pheno_interesting_mac=scalar default 3 #minimum minor allele count for any variant (or combination of variants) to consider a gene interesting
prop min_pheno_gene_interesting_mac=scalar default 2 #minimum minor allele count for any variant (or combination of variants) within an intereting gene to be considered interesting
prop interesting_variant_gene_combinations=list #mark genes as interesting if there are multiple variants:; each entry is comma delimited and have p-value,number that must be lower


prop max_interesting_gene_p_value=scalar default 0 #require this p-value from a test for a gene to be interesting
prop max_interesting_gene_variant_p_value=scalar default 0 #within an interesting gene, variants with p-values below this are interesting
prop min_interesting_gene_variant_p_missing_value=scalar default 0 #within an already interesting gene, must have p-missing greater than this  to be interesting
prop all_variants_interesting=scalar #mark all variants as interesting in genes identified through this burden

prop extra_interesting_genes=list #manual interesting genes
prop extra_interesting_variants=list #manual interesting variants


#Set all regions to be interesting
prop all_regions_interesting=scalar
prop all_loci_interesting=scalar



#ADDITIONAL ANNOTATIONS FOR PLINKSEQ, VCF
##====================

1kg_label=g1k
dbsnp_label=dbSNP130
db_mask=ref.req=$1kg_label,$dbsnp_label
nondb_mask=ref.ex=$1kg_label,$dbsnp_label

vcf_mq0_annot=MQ0
vcf_het_ad_annot=HET_AD
vcf_het_ab_annot=HET_AB




#external databases

impute2_cmd=$lib_dir/impute/impute2/impute2
snptest_cmd=$lib_dir/impute/snptest/snptest

eigensoft_dir=$lib_dir/eigensoft/bin
smart_pca_cmd=perl $eigensoft_dir/smartpca.perl

gcta_cmd=$lib_dir/gcta/gcta

#--------
#display categories
#--------

cat cat_project_slide_data=null disp "For Slides" class_level project

cat cat_project_slide_master_data=null disp "Master" parent cat_project_slide_data
cat cat_project_slide_coverage_data=null disp "Coverage" parent cat_project_slide_data
cat cat_project_slide_sites_data=null disp "Sites" parent cat_project_slide_data
cat cat_project_slide_qc_data=null disp "QC Data" parent cat_project_slide_data
cat cat_project_slide_qc_ind_data=null disp "Samples" parent cat_project_slide_qc_data
#cat cat_project_slide_qc_ind_box_data=null disp "Box Plots" parent cat_project_slide_qc_ind_data
cat cat_project_slide_qc_ind_hist_data=null disp "Hist Plots" parent cat_project_slide_qc_ind_data
cat cat_project_slide_qc_ind_minus_data=null disp "Qc -" parent cat_project_slide_qc_ind_data
cat cat_project_slide_qc_var_data=null disp "Variants" parent cat_project_slide_qc_data

cat cat_project_meta_data=null disp "Meta Data" class_level project
!!expand:,:project,parentt:project,meta_data:project_variant_subset,variant_data! \
cat cat_project_target_data=null disp "Target Data" parent cat_project_parentt
cat cat_project_picard_data=null disp "Picard Data" parent cat_project_meta_data
cat cat_project_extra_sample_data=null disp "Extra Sample Data" parent cat_project_meta_data
cat cat_project_failure_data=null disp "Failures" parent cat_project_meta_data
cat cat_project_region_data=null disp "Regions" parent cat_project_meta_data
cat cat_project_subset_meta_data=null disp "Subset meta data" parent cat_project_meta_data

!!expand:project:project:project_merge_subset! \
cat cat_project_variant_data=null disp "Variants" class_level project

!!expand:type:variant:sample! \
cat cat_project_type_subset_all_variant_data=null disp "All variant data" class_level project_type_subset

!!expand:type:variant:sample! \
cat cat_project_type_subset_variant_data=null disp "Variants" parent cat_project_type_subset_all_variant_data

!|expand:project:project:project_merge_subset:project_variant_subset| \
cat cat_project_all_call_data=null disp "All" parent cat_project_variant_data
!!expand:project:project:project_sample_subset:project_variant_subset:project_merge_subset! \
cat cat_project_snp_call_data=null disp "SNPs" parent cat_project_variant_data
!!expand:project:project:project_sample_subset:project_variant_subset:project_merge_subset! \
cat cat_project_indel_call_data=null disp "Indels" parent cat_project_variant_data
!!expand:project:project:project_sample_subset:project_variant_subset:project_merge_subset! \
cat cat_project_multiallelic_call_data=null disp "Multiallelics" parent cat_project_variant_data
!!expand:project:project:project_variant_subset! \
cat cat_project_annot_data=null disp "Annotations" parent cat_project_variant_data
!!expand:project:project:project_variant_subset! \
cat cat_project_mask_data=null disp "Masks" parent cat_project_variant_data

!|expand:project:project:project_merge_subset:project_variant_subset| \
cat cat_project_all_variant_call_data=null disp "Variants" parent cat_project_all_call_data
!!expand:project:project:project_sample_subset:project_variant_subset:project_merge_subset! \
cat cat_project_snp_variant_call_data=null disp "Variants" parent cat_project_snp_call_data
!!expand:project:project:project_sample_subset:project_variant_subset:project_merge_subset! \
cat cat_project_indel_variant_call_data=null disp "Variants" parent cat_project_indel_call_data
!!expand:project:project:project_sample_subset:project_variant_subset:project_merge_subset! \
cat cat_project_multiallelic_variant_call_data=null disp "Variants" parent cat_project_multiallelic_call_data

#cat cat_project_samtools_call_data=null disp "Samtools" parent cat_project_call_data
cat cat_project_call_all_bulk_properties_data=null disp "Bulk Properties" parent cat_project_snp_call_data
cat cat_project_call_titv_bulk_properties_data=null disp "TiTv" parent cat_project_call_all_bulk_properties_data
cat cat_project_call_theta_bulk_properties_data=null disp "Theta" parent cat_project_call_all_bulk_properties_data

cat cat_project_plinkseq_data=null disp "Plink/Seq" class_level project
!!expand:type:variant:sample! \
cat cat_project_type_subset_plinkseq_data=null disp "Plink/Seq" parent cat_project_type_subset_all_variant_data

!!expand:projectt:project:project_sample_subset:project_variant_subset! \
cat cat_projectt_plinkseq_project_data=null disp "Project Information" parent cat_projectt_plinkseq_data
!!expand:projectt:project:project_sample_subset:project_variant_subset! \
cat cat_projectt_plinkseq_clean_project_data=null disp "Clean Project Information" parent cat_projectt_plinkseq_data
#!!expand:projectt:project:project_sample_subset:project_variant_subset! \
#cat cat_projectt_plinkseq_indel_project_data=null disp "Indel Project Information" parent cat_projectt_plinkseq_data
#cat cat_project_plinkseq_samtools_clean_project_data=null disp "Samtools Clean Project Information" parent cat_project_plinkseq_data


!!expand:type:variant:sample! \
cat cat_project_type_subset_qc_data=null disp "QC" class_level project_type_subset

cat cat_project_qc_ind_data=null disp "Individual QC" class_level project

!!expand:type:variant:sample! \
cat cat_project_type_subset_qc_ind_data=null disp "Individual QC" parent cat_project_type_subset_qc_data


cat cat_project_qc_ind_data=null disp "Individual QC" class_level project

!!expand:project:project:project_sample_subset! \
!!expand:,:type,tname:raw,Raw:qc_pass,QC Pass:qc_plus,QC +! \
cat cat_project_type_istats_data=null disp "tname i-stats" parent cat_project_qc_ind_data

!!expand:project:project:project_variant_subset:project_sample_subset! \
cat cat_project_plink_output_data=null disp "Plink Outputs" parent cat_project_qc_ind_data

!!expand:project:project:project_variant_subset! \
cat cat_project_plink_qc_pass_output_data=null disp "QC Pass" parent cat_project_plink_output_data
!!expand:project:project:project_variant_subset! \
cat cat_project_plink_qc_plus_output_data=null disp "QC Plus" parent cat_project_plink_output_data

!!expand:project:project:project_sample_subset! \
cat cat_project_qc_ind_stats_data=null disp "Stats" parent cat_project_qc_ind_data

cat cat_project_qc_ind_plots_data=null disp "Plots" parent cat_project_qc_ind_data
cat cat_project_sample_qc_filter_data=null disp "Exclude" parent cat_project_qc_ind_data

!!expand:project:project! \
cat cat_project_qc_loc_data=null disp "Loci QC" class_level project

cat cat_project_variant_subset_qc_loc_data=null disp "Loci QC" parent cat_project_variant_subset_qc_data

!!expand:project:project:project_variant_subset! \
cat cat_project_qc_var_data=null disp "Variants" parent cat_project_qc_loc_data

!!expand:project:project:project_variant_subset! \
!!expand:,:type,tname:raw,Raw:qc_pass,QC Pass:qc_plus,QC +! cat cat_project_type_var_stats_data=null disp "tname v-stats" parent cat_project_qc_ind_data
!!expand:project:project:project_variant_subset! \
cat cat_project_qc_var_stats_data=null disp "Stats" parent cat_project_qc_var_data
cat cat_project_qc_var_plots_data=null disp "Plots" parent cat_project_qc_var_data

cat cat_project_qc_var_exclude_data=null disp "Exclude" parent cat_project_qc_var_data

!!expand:project:project:project_variant_subset! \
cat cat_project_qc_gene_data=null disp "Genes" parent cat_project_qc_loc_data
!!expand:project:project:project_variant_subset! \
cat cat_project_qc_gene_stats_data=null disp "Stats" parent cat_project_qc_gene_data
cat cat_project_qc_gene_plots_data=null disp "Plots" parent cat_project_qc_gene_data
cat cat_project_qc_gene_gc_plots_data=null disp "GC" parent cat_project_qc_gene_plots_data

cat cat_project_coverage_data=null disp "Coverage" class_level project
cat cat_project_sample_coverage_data=null disp "Samples" parent cat_project_coverage_data
cat cat_project_ind_sample_coverage_data=null disp "Individual" parent cat_project_sample_coverage_data
cat cat_project_sample_cum_coverage_data=null disp "Cumulative" parent cat_project_sample_coverage_data

!!expand:,:type,Type:gene,Gene:exon,Exon:bait,Bait! \
cat cat_project_type_coverage_data=null disp "Types" parent cat_project_coverage_data

!!expand:type:gene:exon:bait! \
cat cat_project_type_dist_coverage_data=null disp "Sample distribution" parent cat_project_type_coverage_data

!!expand:type:gene:exon:bait! \
cat cat_project_alphabetical_type_dist_coverage_data=null disp "Alphabetical" parent cat_project_type_coverage_data

cat cat_project_lowest_gene_dist_coverage_data=null disp "Lowest" parent cat_project_gene_coverage_data

!!expand:type:gene:exon:bait! \
cat cat_project_type_cum_coverage_data=null disp "Cumulative \\#types covered" parent cat_project_type_coverage_data

!!expand:whichlevel:sample:pheno! \
cat cat_whichlevel_qc_filter_data=null disp "QC Filter" class_level whichlevel_qc_filter
!!expand:whichlevel:sample:pheno! \
cat cat_whichlevel_qc_filter_trait_data=null disp "Trait filter" parent cat_whichlevel_qc_filter_data
!!expand:whichlevel:sample:pheno! \
cat cat_whichlevel_qc_filter_metric_data=null disp "Metric filter" parent cat_whichlevel_qc_filter_data

cat cat_var_qc_filter_data=null disp "QC Filter" class_level var_qc_filter

!!expand:pheno_variant_qc_strata:pheno_variant_qc_strata:pheno_variant_qc_strata_variant_subset! \
cat cat_pheno_variant_qc_strata_data=null disp "QC Strata" class_level pheno_variant_qc_strata
!!expand:pheno_variant_qc_pheno_strata:pheno_variant_qc_pheno_strata:pheno_variant_qc_pheno_strata_variant_subset! \
cat cat_pheno_variant_qc_pheno_strata_data=null disp "QC Strata" class_level pheno_variant_qc_pheno_strata

cat cat_pheno_qc_filter_data=null disp "QC Filter" class_level pheno_qc_filter

!!expand:marker:marker:marker_sample_subset:marker_variant_subset! \
cat cat_marker_data=null disp "Marker Data" class_level marker
cat cat_marker_all_genotype_data=null disp "All Genotypes" parent cat_marker_data
cat cat_marker_initial_all_genotype_data=null disp "Initial" parent cat_marker_all_genotype_data
cat cat_marker_filtered_all_genotype_data=null disp "Filtered" parent cat_marker_all_genotype_data
cat cat_marker_filtered_for_merge_all_genotype_data=null disp "Filtered for merging" parent cat_marker_all_genotype_data
cat cat_marker_sample_genotype_data=null disp "Project Sample Genotypes" parent cat_marker_data
!!expand:marker:marker:marker_sample_subset:marker_variant_subset! \
cat cat_marker_concordance_data=null disp "Concordance" parent cat_marker_data
cat cat_marker_meta_data=null disp "Meta" parent cat_marker_data

cat cat_project_plink_data=null disp "Plink Data" class_level project

!!expand:type:variant:sample! \
cat cat_project_type_subset_plink_data=null disp "Plink Data" parent cat_project_type_subset_all_variant_data

!!expand:project:project:project_sample_subset:project_variant_subset! \
cat cat_project_plink_seq_data=null disp "Seq" parent cat_project_plink_data
cat cat_project_plink_seq_meta_data=null disp "Meta" parent cat_project_plink_seq_data
!!expand:project:project:project_sample_subset:project_variant_subset! \
cat cat_project_plink_seq_qc_pass_data=null disp "QC Pass" parent cat_project_plink_seq_data
!!expand:project:project:project_sample_subset:project_variant_subset! \
cat cat_project_plink_seq_qc_plus_data=null disp "QC Plus" parent cat_project_plink_seq_data

cat cat_project_plink_marker_data=null disp "Marker" parent cat_project_plink_data
cat cat_project_plink_all_marker_data=null disp "All Samples" parent cat_project_plink_marker_data
cat cat_project_plink_all_marker_meta_data=null disp "Meta" parent cat_project_plink_all_marker_data
cat cat_project_plink_all_marker_ped_data=null disp "Ped" parent cat_project_plink_all_marker_data
cat cat_project_plink_sample_marker_data=null disp "Project Samples" parent cat_project_plink_marker_data

cat cat_project_plink_sample_marker_meta_data=null disp "Meta" parent cat_project_plink_sample_marker_data
cat cat_project_plink_sample_marker_ped_data=null disp "Ped" parent cat_project_plink_sample_marker_data
cat cat_project_plink_sample_marker_pruned_ped_data=null disp "Pruned Ped" parent cat_project_plink_sample_marker_data

cat cat_project_plink_sample_non_seq_plink_data=null disp "Non seq" parent cat_project_plink_sample_marker_data
cat cat_project_plink_sample_non_seq_meta_data=null disp "Meta" parent cat_project_plink_sample_non_seq_plink_data
cat cat_project_plink_sample_non_seq_ped_data=null disp "Ped" parent cat_project_plink_sample_non_seq_plink_data

cat cat_project_plink_extra_marker_data=null disp "Extra Samples" parent cat_project_plink_marker_data
cat cat_project_plink_extra_marker_ped_data=null disp "Ped" parent cat_project_plink_extra_marker_data

cat cat_project_plink_combined_data=null disp "Combined" parent cat_project_plink_data
cat cat_project_plink_sample_combined_data=null disp "Project Samples" parent cat_project_plink_combined_data
cat cat_project_plink_sample_combined_ped_data=null disp "Ped" parent cat_project_plink_sample_combined_data

cat cat_project_ibd_data=null disp "IBD Data" class_level project
cat cat_project_sample_subset_ibd_data=null disp "IBD Data" parent cat_project_sample_subset_qc_data

cat cat_project_all_ibd_data=null disp "All Samples" parent cat_project_ibd_data
cat cat_project_sample_ibd_data=null disp "Project Samples" parent cat_project_ibd_data
cat cat_project_sample_subset_sample_ibd_data=null disp "Project Samples" parent cat_project_sample_subset_ibd_data

!!expand:,:soft,Soft:plink,PLINK:eigen,EIGENSTRAT! \
cat cat_project_all_soft_ibd_data=null disp "Soft" parent cat_project_all_ibd_data

!!expand:,:soft,Soft:plink,PLINK:eigen,EIGENSTRAT! \
!!expand:project:project:project_sample_subset! \
cat cat_project_sample_soft_ibd_data=null disp "Soft" parent cat_project_sample_ibd_data

!!expand:,:soft,Soft:epacts,EPACTS! \
cat cat_project_sample_soft_ibd_data=null disp "Soft" parent cat_project_sample_ibd_data

cat cat_project_region_exclude_ibd_data=null disp "Exclude Regions" parent cat_project_ibd_data

!!expand:project:project:pheno! \
cat cat_project_sample_subset_coverage_data=null disp "Coverage Data" parent cat_project_sample_subset_qc_data

cat cat_seq_batch_picard_data=null disp "Picard Data" class_level seq_batch

meta constant cat_pheno_qt=@pheno_qt disp "QT" class_level pheno

cat cat_pheno_slide_data=null disp "For Slides" class_level pheno
cat cat_pheno_slide_master_data=null disp "Master" parent cat_pheno_slide_data
cat cat_pheno_slide_coverage_data=null disp "Coverage" parent cat_pheno_slide_data
#cat cat_pheno_slide_dirty_data=null disp "Dirty Data" parent cat_pheno_slide_data
cat cat_pheno_slide_sample_qc_data=null disp "Sample QC" parent cat_pheno_slide_data
#cat cat_pheno_slide_variants_data=null disp "Variants" parent cat_pheno_slide_data
#cat cat_pheno_slide_genes_data=null disp "Genes" parent cat_pheno_slide_data
#cat cat_pheno_dirty_variant_assoc_data=null disp "Variant associations" parent cat_pheno_slide_dirty_data
#cat cat_pheno_dirty_all_variant_assoc_data=null disp "All Sites" parent cat_pheno_dirty_variant_assoc_data
#cat cat_pheno_dirty_qc_pass_variant_assoc_data=null disp "QC Pass" parent cat_pheno_dirty_variant_assoc_data

#cat cat_pheno_dirty_gene_assoc_data=null disp "Gene associations" parent cat_pheno_slide_dirty_data
#cat cat_pheno_dirty_gene_assoc_data=null disp "Gene associations" parent cat_pheno_slide_dirty_data
#cat cat_pheno_dirty_all_gene_assoc_data=null disp "All Sites" parent cat_pheno_dirty_gene_assoc_data
#cat cat_pheno_dirty_qc_pass_gene_assoc_data=null disp "QC Pass" parent cat_pheno_dirty_gene_assoc_data

cat cat_pheno_meta_info=null disp "Meta Info" class_level pheno
cat cat_pheno_sample_info=null disp "Sample Info" parent cat_pheno_meta_info
cat cat_pheno_meta_data=null disp "Meta Data" parent cat_pheno_sample_info
cat cat_pheno_passed_meta_data=null disp "Passed" parent cat_pheno_meta_data
cat cat_pheno_failed_meta_data=null disp "Failed" parent cat_pheno_meta_data
cat cat_pheno_all_meta_data=null disp "All" parent cat_pheno_meta_data
cat cat_pheno_sample_coverage_data=null disp "Coverage Data" parent cat_pheno_sample_info
cat cat_pheno_interesting_info=null disp "Interesting Genes & Variants" parent cat_pheno_meta_info
cat cat_pheno_trait_info=null disp "Trait Info" parent cat_pheno_meta_info
cat cat_pheno_test_info=null disp "Test Info" parent cat_pheno_meta_info
cat cat_pheno_subset_info=null disp "Variant Subsets" parent cat_pheno_meta_info

!!expand:pheno:pheno:pheno_sample_subset! \
cat cat_pheno_qc_data=null disp "QC Data" class_level pheno
!!expand:pheno:pheno:pheno_sample_subset! \
cat cat_pheno_sample_qc_data=null disp "Sample QC" parent cat_pheno_qc_data

cat cat_pheno_sstats_qc_data=null disp "Pre Seq" parent cat_pheno_sample_qc_data
cat cat_pheno_sstats_qc_stats_data=null disp "Stats" parent cat_pheno_sstats_qc_data
cat cat_pheno_sstats_qc_plot_data=null disp "Plots" parent cat_pheno_sstats_qc_data

!!expand:pheno:pheno:pheno_sample_subset! \
cat cat_pheno_popgen_qc_data=null disp "Popgen" parent cat_pheno_sample_qc_data
!!expand:pheno:pheno:pheno_sample_subset! \
cat cat_pheno_popgen_qc_stats_data=null disp "Stats" parent cat_pheno_popgen_qc_data
cat cat_pheno_popgen_qc_plot_data=null disp "Plots" parent cat_pheno_popgen_qc_data

!!expand:pheno:pheno:pheno_sample_subset! \
cat cat_pheno_ibd_qc_data=null disp "IBD" parent cat_pheno_sample_qc_data
!!expand:pheno:pheno:pheno_sample_subset! \
cat cat_pheno_ibd_qc_stats_data=null disp "Stats" parent cat_pheno_ibd_qc_data
cat cat_pheno_ibd_qc_plot_data=null disp "Plots" parent cat_pheno_ibd_qc_data

!!expand:pheno:pheno:pheno_sample_subset! \
cat cat_pheno_covar_qc_data=null disp "Covar" parent cat_pheno_sample_qc_data
!!expand:pheno:pheno:pheno_sample_subset! \
cat cat_pheno_covar_qc_stats_data=null disp "Stats" parent cat_pheno_covar_qc_data
cat cat_pheno_covar_qc_plot_data=null disp "Plots" parent cat_pheno_covar_qc_data

cat cat_pheno_cluster_qc_data=null disp "Cluster" parent cat_pheno_sample_qc_data
cat cat_pheno_cluster_qc_stats_data=null disp "Stats" parent cat_pheno_cluster_qc_data
cat cat_pheno_cluster_qc_plot_data=null disp "Plots" parent cat_pheno_cluster_qc_data

cat cat_pheno_variant_subset_meta_data=null disp "Meta Data" parent cat_pheno_variant_subset_genotype_data
cat cat_pheno_variant_subset_qc_data=null disp "QC Data" parent cat_pheno_variant_subset_genotype_data

cat cat_pheno_genotype_data=null disp "Genotype Data" class_level pheno
cat cat_pheno_variant_subset_genotype_data=null disp "Pheno Subset Data" class_level pheno_variant_subset
!!expand:pheno:pheno:pheno_variant_subset! \
cat cat_pheno_plinkseq_data=null disp "Plink/Seq Data" parent cat_pheno_genotype_data
cat cat_pheno_plinkseq_phe_data=null disp "Phe" parent cat_pheno_plinkseq_data
!!expand:,:type,Type:all,All:unrelated,Unrelated! \
cat cat_pheno_plinkseq_type_include_data=null disp "Type Include" parent cat_pheno_plinkseq_data
!!expand:pheno:pheno:pheno_variant_subset! \
cat cat_pheno_plinkseq_raw_data=null disp "Raw" parent cat_pheno_plinkseq_data
!!expand:pheno:pheno:pheno_variant_subset! \
cat cat_pheno_plinkseq_clean_data=null disp "Clean" parent cat_pheno_plinkseq_data
!!expand:pheno:pheno:pheno_variant_subset! \
cat cat_pheno_plinkseq_strat_data=null disp "Strat" parent cat_pheno_plinkseq_data
!!expand:pheno:pheno:pheno_variant_subset! \
cat cat_pheno_plink_data=null disp "Plink Data" parent cat_pheno_genotype_data
cat cat_pheno_plink_phe_data=null disp "Phe" parent cat_pheno_plink_data
!!expand:type:all:unrelated! \
cat cat_pheno_plink_type_include_data=null disp "Include" parent cat_pheno_plink_data
cat cat_pheno_epacts_data=null disp "EPACTS Data" parent cat_pheno_genotype_data
cat cat_pheno_epacts_phe_data=null disp "Phe" parent cat_pheno_epacts_data

!!expand:pheno:pheno:pheno_variant_subset! \
cat cat_pheno_plink_seq_data=null disp "Seq" parent cat_pheno_plink_data
cat cat_pheno_plink_pruned_marker_data=null disp "Pruned Marker" parent cat_pheno_plink_data
cat cat_pheno_plink_combined_data=null disp "Combined" parent cat_pheno_plink_data

!!expand:pheno:pheno:pheno_variant_subset! \
cat cat_pheno_variant_qc_data=null disp "Variant QC" parent cat_pheno_qc_data
!!expand:pheno:pheno:pheno_variant_subset! \
cat cat_pheno_variant_qc_stats_data=null disp "Variant Stats" parent cat_pheno_variant_qc_data
!!expand:pheno:pheno:pheno_variant_subset! \
cat cat_pheno_qc_gene_stats_data=null disp "Gene Stats" parent cat_pheno_variant_qc_data
!!expand:pheno:pheno:pheno_variant_subset! \
cat cat_pheno_variant_qc_plink_data=null disp "Plink" parent cat_pheno_variant_qc_data

cat cat_pheno_assoc_data=null disp "Associations" class_level pheno
cat cat_pheno_variant_assoc_data=null disp "Variant associations" parent cat_pheno_assoc_data
cat cat_pheno_variant_subset_variant_assoc_data=null disp "Variant associations" parent cat_pheno_variant_subset_genotype_data
cat cat_pheno_gene_assoc_data=null disp "Gene associations" parent cat_pheno_assoc_data
cat cat_pheno_pathway_assoc_data=null disp "Pathway associations" parent cat_pheno_assoc_data
cat cat_pheno_variant_imputation_data=null disp "Variant imputation" parent cat_pheno_assoc_data

cat cat_pheno_fine_mapping_data=null disp "Fine mapping" class_level pheno
cat cat_pheno_top_hits_data=null disp "Top Hits" parent cat_pheno_fine_mapping_data

!!expand:pheno_test:pheno_test:pheno_test_variant_subset! \
cat cat_pheno_test_data=null disp "SV test files" class_level pheno_test

!!expand:,:annot,Annot:annot,Annot:annot_variant_subset,Annot Subset! \
cat cat_annot_data=null disp "Annot Data" class_level annot
!!expand:annotl:annot:annot_variant_subset! \
cat cat_annotl_var_data=null disp "Variants to use in this annot" parent cat_annotl_data
cat cat_annot_subset_info=null disp "Variant Subsets" parent cat_annot_data

cat cat_annot_var_qc_filter_data=null disp "QC Filter" class_level annot_var_qc_filter

!!expand:,:burden,Burden:burden,Burden:burden_variant_subset,Burden Subset! \
cat cat_burden_data=null disp "Burden Data" class_level burden
cat cat_burden_slide_master_data=null disp "Master" parent cat_burden_data
cat cat_burden_info_data=null disp "Info" parent cat_burden_data
!!expand:burden:burden:burden_variant_subset! \
cat cat_burden_association_data=null disp "Output of association results" parent cat_burden_data
!!expand:burden:burden:burden_variant_subset! \
cat cat_burden_association_display_data=null disp "Display results" parent cat_burden_association_data
cat cat_burden_association_test_data=null disp "Test results" parent cat_burden_association_data
cat cat_burden_interesting_data=null disp "Interesting gene/variant information" parent cat_burden_data
!!expand:burdenl:burden:burden_variant_subset! \
cat cat_burdenl_var_data=null disp "Variants to use in this burden" parent cat_burdenl_data
cat cat_burden_summary_data=null disp "Summary of association results" parent cat_burden_data
!!expand:burden:burden:annot! \
cat cat_burden_pathway_association_data=null disp "Output of pathway association results" parent cat_burden_data
#cat cat_burden_detail_data=null disp "Detailed Analysis" class_level burden
#cat cat_burden_recessive_test_data=null disp "Variant recessive test" parent cat_burden_detail_data
#cat cat_burden_haplotype_burden_data=null disp "Variant haplotype burden" parent cat_burden_detail_data
cat cat_burden_subset_info=null disp "Variant Subsets" parent cat_burden_data

!!expand:,:burden_test,Burden:burden_test,Burden Test:burden_test_variant_subset,Burden Test Subset! \
cat cat_burden_test_data=null disp "Burden Data" class_level burden_test
cat cat_burden_test_info_data=null disp "Info" parent cat_burden_test_data

cat cat_burden_test_samp_data=null disp "Samples to use in this burden test" parent cat_burden_test_data
!!expand:burden_test:burden_test:burden_test_variant_subset! \
cat cat_burden_test_input_association_data=null disp "Input to association results" parent cat_burden_test_data
!!expand:burden_test:burden_test:burden_test_variant_subset! \
cat cat_burden_test_association_data=null disp "Output of association results" parent cat_burden_test_data
cat cat_burden_test_pathway_association_data=null disp "Output of pathway association results" parent cat_burden_test_data

meta constant cat_variant_consequence=@consequence disp "Consequence" class_level variant
meta constant cat_variant_protein_change=@proteinchange disp "Change" class_level variant
#meta constant cat_variant_var_annot=@var_annot disp "$disp_for_var_annot" class_level variant
meta constant cat_variant_ncase=@ncase disp "Ncase" class_level variant
meta constant cat_variant_ncontrol=@ncontrol disp "Ncontrol" class_level variant
cat cat_variant_data=null disp "Variant Data" class_level variant
cat cat_variant_slide_master_data=null disp "Master" parent cat_variant_data
cat cat_variant_meta_data=null disp "Meta data" parent cat_variant_data
cat cat_variant_qc_data=null disp "QC data" parent cat_variant_data
cat cat_variant_plot_data=null disp "Plot data" parent cat_variant_data
cat cat_variant_ld_data=null disp "LD data" parent cat_variant_data
cat cat_variant_haplotype_analysis_data=null disp "Haplotype Analysis" parent cat_variant_data
cat cat_variant_imputation_data=null disp "Imputation" parent cat_variant_data
cat cat_variant_hap_imputation_data=null disp "Haplotype" parent cat_variant_imputation_data
cat cat_variant_traditional_imputation_data=null disp "Traditional" parent cat_variant_imputation_data

#region/locus files

!!expand:rorl:region:locus! \
meta constant cat_rorl_range=@rorl_range disp "Range" class_level rorl

cat cat_locus_summary_data=null disp "Summary" class_level locus
cat cat_locus_slide_master_data=null disp "Master" parent cat_locus_summary_data
cat cat_locus_coverage_data=null disp "Coverage" parent cat_locus_summary_data
cat cat_locus_association_data=null disp "Association" parent cat_locus_summary_data
cat cat_locus_marker_association_data=null disp "Marker Association" parent cat_locus_summary_data
cat cat_locus_haplotype_burden_data=null disp "Haplotype Burden" parent cat_locus_summary_data

!!expand:rorl:region:locus! \
cat cat_rorl_ped_data=null disp "Ped data" class_level rorl
!!expand:rorl:region:locus! \
cat cat_rorl_meta_data=null disp "Meta data" parent cat_rorl_ped_data
!!expand:rorl:region:locus! \
cat cat_rorl_ped_marker_data=null disp "Markers" parent cat_rorl_ped_data
!!expand:rorl:region:locus! \
cat cat_rorl_ped_all_marker_data=null disp "All" parent cat_rorl_ped_marker_data
!!expand:rorl:region:locus! \
cat cat_rorl_ped_common_marker_data=null disp "Common" parent cat_rorl_ped_marker_data
!!expand:rorl:region:locus! \
cat cat_rorl_ped_seq_data=null disp "Sequence" parent cat_rorl_ped_data
!!expand:rorl:region:locus! \
cat cat_rorl_ped_all_seq_data=null disp "All" parent cat_rorl_ped_seq_data
!!expand:rorl:region:locus! \
cat cat_rorl_ped_non_marker_seq_data=null disp "Non Marker" parent cat_rorl_ped_seq_data
!!expand:rorl:region:locus! \
cat cat_rorl_ped_combined_data=null disp "Combined" parent cat_rorl_ped_data

!!expand:rorl:region:locus! \
cat cat_rorl_other_data=null disp "Imputation data" class_level rorl
!!expand:rorl:region:locus! \
cat cat_rorl_beagle_data=null disp "Beagle" parent cat_rorl_other_data
!!expand:rorl:region! \
cat cat_rorl_beagle_input_data=null disp "Input" parent cat_rorl_beagle_data
!!expand:rorl:region:locus! \
cat cat_rorl_beagle_output_data=null disp "Output" parent cat_rorl_beagle_data

!!expand:rorl:region:locus! \
cat cat_rorl_impute2_data=null disp "Impute2" parent cat_rorl_other_data
!!expand:rorl:region:locus! \
cat cat_rorl_impute2_input_data=null disp "Input" parent cat_rorl_impute2_data
!!expand:rorl:region:locus! \
cat cat_rorl_impute2_output_data=null disp "Output" parent cat_rorl_impute2_data
!!expand:rorl:locus! \
cat cat_rorl_impute2_association_data=null disp "Association" parent cat_rorl_impute2_data

cat cat_region_marker_association_data=null disp "Marker Association" parent cat_region_other_data


cat cat_gene_summary_data=null disp "Summaries" class_level gene
cat cat_gene_slide_master_data=null disp "Master" parent cat_gene_summary_data
cat cat_gene_plot_plink_data=null disp "Sequence Plink Data" parent cat_gene_summary_data
#cat cat_gene_plot_data=null disp "Plots" parent cat_gene_summary_data
cat cat_gene_meta_data=null disp "Meta data" parent cat_gene_summary_data
cat cat_gene_annot_data=null disp "Annotations" parent cat_gene_summary_data
cat cat_gene_qc_data=null disp "QC Data" parent cat_gene_summary_data
cat cat_gene_ld_data=null disp "LD Data" parent cat_gene_summary_data
cat cat_gene_all_ld_data=null disp "Marker + Seq" parent cat_gene_ld_data
cat cat_gene_seq_ld_data=null disp "Seq" parent cat_gene_ld_data
cat cat_gene_assoc_data=null disp "Association Data" parent cat_gene_summary_data
cat cat_gene_imputation_assoc_data=null disp "Imputation" parent cat_gene_assoc_data
cat cat_gene_seq_assoc_data=null disp "Sequence" parent cat_gene_assoc_data

cat cat_gene_burden_data=null disp "Gene Burden Data" class_level gene_burden
cat cat_transcript_burden_data=null disp "Transcript Burden Data" class_level transcript_burden

cat cat_call_set_sequence_data=null disp "Sequence Data" class_level call_set
#cat cat_call_set_picard_data=null disp "Picard Data" parent cat_call_set_sequence_data
cat cat_call_set_call_data=null disp "Calls" parent cat_call_set_sequence_data
cat cat_call_set_meta_call_data=null disp "Meta" parent cat_call_set_call_data
cat cat_call_set_variant_call_data=null disp "Variants" parent cat_call_set_call_data
cat cat_call_set_all_call_data=null disp "All" parent cat_call_set_call_data

#cat cat_call_set_unfiltered_call_data=null disp "Unfiltered" parent cat_call_set_call_data

#cat cat_call_set_coverage_data=null disp "Coverage" class_level call_set
#cat cat_call_set_sample_coverage_data=null disp "Samples" parent cat_call_set_coverage_data
#cat cat_call_set_gene_coverage_data=null disp "Genes" parent cat_call_set_coverage_data
#cat cat_call_set_gene_dist_coverage_data=null disp "Sample distribution" parent cat_call_set_gene_coverage_data
#cat cat_call_set_gene_cum_coverage_data=null disp "Cumulative \#genes covered" parent cat_call_set_gene_coverage_data

#cat cat_project_subset_call_data=null disp "Calls" class_level project_subset
#cat cat_project_subset_samtools_data=null disp "Samtools" parent cat_project_subset_call_data

!!expand:call_set_subset:call_set_subset:call_set_sample_subset! \
cat cat_call_set_subset_call_data=null disp "Calls" class_level call_set_subset

cat cat_call_set_subset_variant_call_data=null disp "Input files" parent cat_call_set_subset_call_data

!!expand:call_set_subset:call_set_subset:call_set_sample_subset! \
cat cat_call_set_subset_missed_variants_data=null disp "Missed Variants" parent cat_call_set_subset_call_data
cat cat_sample_sequence_data=null disp "Sequence Data" class_level sample
meta constant cat_sample_failed=@failed disp "Failed" class_level sample
cat cat_sample_read_data=null disp "Read Data" parent cat_sample_sequence_data
cat cat_sample_coverage_data=null disp "Coverage" parent cat_sample_sequence_data

###BEGIN Uncomment this section to have files generated by Sample_UnifiedGenotyperToEval
#cat cat_sample_single_sample_snp_call_data=null disp "Single Sample SNP Calls" parent cat_sample_sequence_data
#cat cat_sample_meta_call_data=null disp "Meta" parent cat_sample_single_sample_snp_call_data
#cat cat_sample_all_call_data=null disp "All" parent cat_sample_single_sample_snp_call_data
#cat cat_sample_filtered_call_data=null disp "Filtered" parent cat_sample_single_sample_snp_call_data
#cat cat_sample_unfiltered_call_data=null disp "Unfiltered" parent cat_sample_single_sample_snp_call_data
###BEGIN Uncomment this section to have files generated by Sample_UnifiedGenotyperToEval

##BEGIN Uncomment to get files for indels
#cat cat_sample_indel_call_data=null disp "Indel Calls" parent cat_sample_sequence_data
##END Uncomment to get files for indels

#--------
#files
#--------

#project
minor file path project_interval_list_file=@project.interval_list dir project_dir disp ".interval_list" parent cat_project_target_data class_level project comment "Interval list of all regions in study"

minor file path project_expanded_interval_list_file=@project.expanded.interval_list dir project_dir disp ".expanded.interval_list" parent cat_project_target_data class_level project comment "Interval list of all regions in study -- expanded by $expand_interval_size bp"

file path project_chr_map_file=@project.chr.map.txt dir project_dir disp ".chr.map.txt" parent cat_project_target_data class_level project comment "File to use to map input chromsome names to output chromosome names"

minor file path project_target_length_file=@project.target.length dir project_dir disp ".target.length" parent cat_project_target_data class_level project comment "The length of the target region"
!!expand:project:project:project_variant_subset! \
minor table nohead file path project_genes_gtf_file=@project.genes.gtf dir project_dir disp ".genes.gtf" parent cat_project_target_data class_level project comment "GTF file of all genes in study"

minor table nohead file path project_variant_subset_region_file=@project_variant_subset.regions dir project_variant_subset_dir disp ".regions" parent cat_project_variant_subset_target_data class_level project_variant_subset comment "Regions in gtf file to use for this subset" 

table nohead file path project_bait_target_file=@project.bait.targets dir project_dir disp ".bait.targets" parent cat_project_target_data class_level project comment "All baits in study: has bait, chr, start, stop"
table nohead file path project_exon_target_file=@project.exon.targets dir project_dir disp ".exon.targets" parent cat_project_target_data class_level project comment "All exons in study: has gene, exon, chr, start, stop"
table nohead file path project_expanded_exon_target_file=@project.expanded.exon.targets dir project_dir disp ".expanded.exon.targets" parent cat_project_target_data class_level project comment "All exons in study: has gene, exon, chr, start, stop  -- expanded by $expand_interval_size bp"
table nohead file path project_variant_gene_annotation_file=@project.variant.gene.annot dir project_dir disp ".variant.gene.annot" parent cat_project_target_data class_level project comment "For each variant, lists the gene it lies in"

table nohead file path project_gene_target_file=@project.gene.targets dir project_dir disp ".gene.targets" parent cat_project_target_data class_level project comment "All genes in study: has name, chr, start, stop"

table nohead file path project_transcript_target_file=@project.transcript.targets dir project_dir disp ".transcript.targets" parent cat_project_target_data class_level project comment "All transcripts in study (for use solely in partitioning regions up)"

table nohead file path project_closest_gene_file=@project.closest.gene dir project_dir disp ".closest.gene" parent cat_project_target_data class_level project comment "Lists which regions are closest to each gene"

table nohead file path project_disjoint_gene_target_file=@project.disjoint.gene.targets dir project_dir disp ".disjoint.gene.targets" parent cat_project_target_data class_level project comment "All genes in study: has name, chr, start, stop; flattened to have all regions disjoint"

!!expand:project:project:project_variant_subset! \
table file path project_transcript_gene_map_file=@project.transcript.gene.map dir project_dir disp ".transcript.gene.map" parent cat_project_annot_data class_level project comment "Full list of all transcripts for each gene"

table file path project_transcript_gene_alias_file=@project.transcript.gene.alias dir project_dir disp ".transcript.gene.alias" parent cat_project_annot_data class_level project comment "Full list of all transcripts for each gene"

table nohead file path project_gene_interesting_transcript_file=@project.gene.interesting.transcript dir project_dir disp ".gene.interesting.transcript" parent cat_project_target_data class_level project comment "Externally specified: list of valid transcripts to count as interesting for a gene; space delimited with first col gene, second transcript"

table file path project_picard_file=@project.picard.metrics.tsv dir project_dir disp ".picard.metrics.tsv" parent cat_project_picard_data class_level project comment "Dump of all picard metrics generated for this project"
#file path project_picard_pdf_file=@project.picard.metrics.pdf dir project_dir disp ".picard.metrics.pdf" parent cat_project_picard_data class_level project comment "Plot of select picard metrics for all values in the picard file --- may not correspond one to one with samples"

table file path project_extra_sample_info_file=@project.extra.sample.info dir project_dir disp ".info" parent cat_project_extra_sample_data class_level project comment "Extra sample information --- should be tab delimited, with a header, first column id, each other column desired metrics"


file path project_passed_sample_list_file=@project.passed.samples dir project_dir disp ".passed.samples" parent cat_project_failure_data class_level project comment "List of passed samples"
file path project_failed_sample_list_file=@project.failed.samples dir project_dir disp ".failed.samples" parent cat_project_failure_data class_level project comment "List of failed samples"
table file path project_sample_failure_status_file=@project.samples.failure.status dir project_dir disp ".failure.status" parent cat_project_failure_data class_level project comment "Columns for each fail/pass designation"
#contains information about the regions in the project
table nohead file path project_region_list_file=@project.region.list dir project_dir disp ".region.list" parent cat_project_region_data class_level project comment "List of all regions in the target file"

table nohead file path project_all_regions_dat_file=@project.all_regions.dat dir project_dir disp ".all_regions.dat" parent cat_project_region_data class_level project comment "Dat file listing all regions for this project"

table nohead file path project_interesting_regions_dat_file=@project.interesting_regions.dat dir project_dir disp ".interesting_regions.dat" parent cat_project_region_data class_level project comment "Dat file listing regions that are interesting for this project"

meta_table file path project_interesting_regions_meta_file=@project.interesting_regions.meta dir project_dir disp ".interesting_regions.meta" parent cat_project_region_data class_level project comment "Meta file to specify interesting regions for this project" meta_level region


#contains the variants called by the UG
minor file path project_sample_vcf_id_to_sample_id_file=@project.sample.vcf_id.to.sample_id dir project_dir disp ".sample.vcf_id.to.sample_id" parent cat_project_extra_sample_data class_level project comment "First column: id in VCF file; second column: id in project"

minor file path project_sample_to_call_set_file=@project.sample.to.call_set dir project_dir disp ".sample.to.call_set" parent cat_project_extra_sample_data class_level project comment "First column: id in VCF file; second column: potential call sets; absent samples can come from any call set"

minor file path project_genetic_sex_sexcheck_file=@project.genetic_sex.sexcheck dir project_dir disp ".genetic_sex.sexcheck" parent cat_project_extra_sample_data class_level project comment "Output of sexcheck on genetic sex file"

minor file path project_genetic_sex_sexcheck_log_file=@project.genetic_sex.sexcheck.log dir project_dir disp ".genetic_sex.sexcheck.log" parent cat_project_extra_sample_data class_level project comment "Log file for sexcheck on genetic sex file"

minor file path project_sample_genetic_sex_file=@project.sample.genetic_sex dir project_dir disp ".sample.genetic_sex" parent cat_project_extra_sample_data class_level project comment "Sample ID and genetically determined sex from VCF file"

file path project_sample_bam_list_file=@project.sample.bam.list dir project_dir disp ".sample.bam.list" parent cat_project_extra_sample_data class_level project comment "First column: sample; second column: bam file"

file path project_bam_list_file=@project.bam.list dir project_dir disp ".bam.list" parent cat_project_extra_sample_data class_level project comment "Bam list to feed into calling at all passed samples in project"

file path project_subset_vars_file=@project.subset.vars dir project_dir disp ".subset.vars" parent cat_project_subset_meta_data class_level project comment "Cached list of variants for variant subset"

!!expand:stype:sample:variant! \
meta_table file path project_project_stype_subset_meta_file=@project.project_stype_subset.meta dir project_dir disp ".project_stype_subset.meta" parent cat_project_subset_meta_data class_level project comment "Meta file to load in project_stype_subsets" meta_level project_stype_subset

file path project_project_variant_subset_pheno_expand_subset_file=@project.project_variant_subset.pheno_expand_subset dir project_dir disp ".pheno_expand_subset" parent cat_project_subset_meta_data class_level project comment "Represents the number of pheno subsets each project variant subset should be expanded to" 

meta_table file path project_project_merge_subset_meta_file=@project.project_merge_subset.meta dir project_dir disp ".project_merge_subset.meta" parent cat_project_subset_meta_data class_level project comment "Meta file to load in project_merge_subsets" meta_level project_merge_subset

!!expand:,:type,cattouse:variant,all:snp,snp:indel,indel:multiallelic,multiallelic! \
file path project_type_site_vcf_file=@project.type.site.vcf dir project_dir disp ".type.site.vcf" parent cat_project_cattouse_variant_call_data class_level project comment "An interval list containing all types called at any call_set -- in vcf format -- used for tracking the alleles"

!!expand:project:project:project_merge_subset! \
!!expand:,:type,cattouse:snp,snp:indel,indel! \
file path project_type_id_site_vcf_file=@project.type.id.site.vcf dir project_dir disp ".type.id.site.vcf" parent cat_project_cattouse_variant_call_data class_level project comment "Contains ids and alleles in final VCF; distinct from project_type_site_vcf_file because the ids may change after remerging"

file path nohead table project_variant_subset_var_keep_file=@project_variant_subset.var.keep dir project_variant_subset_dir disp ".var.keep" parent cat_project_variant_subset_all_variant_call_data class_level project_variant_subset comment "List of variants to keep for this subset"

file path nohead table project_variant_subset_interval_list_file=@project_variant_subset.interval_list dir project_variant_subset_dir disp ".interval_list" parent cat_project_variant_subset_all_variant_call_data class_level project_variant_subset comment "Intervals to keep for this subset"

file path project_variant_subset_variant_site_vcf_file=@project_variant_subset.variant.site.vcf dir project_variant_subset_dir disp ".variant.site.vcf" parent cat_project_variant_subset_all_variant_call_data class_level project_variant_subset comment "An interval list containing all variants called at any call_set -- in vcf format -- used for tracking the alleles"

!!expand:project:project:project_variant_subset! \
file path project_clean_all_variant_site_vcf_file=@project.clean.all.variant.site.vcf dir project_dir disp ".variant.site.vcf" parent cat_project_all_variant_call_data class_level project comment "An interval list containing all variants in clean all vcf -- in vcf format -- used for tracking the alleles"

!!expand:,:keyext,fileext:,:_clean,.clean:_indel,.indel:_clean_indel,.clean.indel:_multiallelic,.multiallelic:_clean_multiallelic,.clean.multiallelic! \
file path project_project_merge_subsetkeyext_vcf_list_file=@projectfileext.vcf.list dir project_dir disp "fileext.vcf.list" parent cat_project_all_variant_call_data class_level project comment "List of fileext VCFs to filter"

!!expand:,:keyext,fileext:,:_clean,.clean:_indel,.indel:_clean_indel,.clean.indel:_multiallelic,.multiallelic:_clean_multiallelic,.clean.multiallelic! \
file path project_variant_subset_project_merge_subsetkeyext_vcf_list_file=@project_variant_subsetfileext.vcf.list dir project_variant_subset_dir disp "fileext.vcf.list" parent cat_project_variant_subset_all_variant_call_data class_level project_variant_subset comment "List of fileext VCFs to filter"

!|expand:project:project:project_merge_subset| \
file path project_variant_site_interval_list_file=@project.variant.site.interval_list dir project_dir disp ".variant.site.interval_list" parent cat_project_all_variant_call_data class_level project comment "An interval list containing all types called at any call_set -- in interval list format -- used for tracking the locations"

file path project_merge_subset_call_set_vcf_list_file=@project_merge_subset.call_set.vcf.list dir project_merge_subset_dir disp ".call_set.vcf.list" parent cat_project_merge_subset_all_variant_call_data class_level project_merge_subset comment "List of call sets to use for merge"

#minor file path doubcom table project_initial_sites_vcf_file=@project.initial.sites.vcf dir project_dir disp ".initial.sites.vcf" parent cat_project_variant_call_data class_level project comment "The sites that were called in any batch; merged with intersection. Difference between this and initial_vcf is that this merge is only over batches in which variant was called, rather than all batches"

!|expand:project:project:project_merge_subset| \
file path doubcom table project_merged_vcf_file=@project.merged.vcf@zip_vcf dir project_dir disp ".merged.vcf" parent cat_project_all_variant_call_data class_level project comment "Output of raw CombineVariants step on call set VCF files"

!|expand:project:project:project_merge_subset| \
path project_for_genetic_sex_plink_file=@project.for_genetic_sex dir project_dir

!|expand:ext:tped:tfam| \
!|expand:project:project:project_merge_subset| \
file path doubcom table project_for_genetic_sex_ext_file=$project_for_genetic_sex_plink_file.ext dir project_dir disp ".for_genetic_sex.ext" parent cat_project_all_variant_call_data class_level project comment "Variants on the X chromosome to be used for genetic sex determination; ext file"

#!|expand:project:project:project_merge_subset| \
#file path doubcom table project_initial_annotated_site_vcf_file=@project.initial.annotated.vcf dir project_dir disp ".initial.annotated.vcf" parent cat_project_all_variant_call_data class_level project comment "VCF file with annotations --- not yet processed to make final initial file "

#!|expand:project:project:project_merge_subset| \
#file path doubcom table project_annotated_vcf_file=@project.annotated.vcf@zip_vcf dir project_dir disp ".annotated.vcf" parent cat_project_all_variant_call_data class_level project comment "VCF file with annotations --- processed to make final initial file "

#!|expand:project:project:project_merge_subset| \
#!!expand:,:type,ext:snp,:indel,.indel! \
#file path doubcom table project_initial_type_vcf_file=@project.initialext.vcf@zip_vcf dir project_dir disp ".initialext.vcf" parent cat_project_type_variant_call_data class_level project comment "All type calls for the project. Generated via multisample caller by firehose for each call_set and then merged"

#!|expand:project:project:project_merge_subset| \
#!!expand:,:type,ext:snp,:indel,.indel! \
#file path doubcom table project_subsetted_type_vcf_file=@project.subsettedext.vcf@zip_vcf dir project_dir disp ".subsetted.vcf" parent cat_project_type_variant_call_data class_level project comment "Initial type VCF file subsetted to include only passed samples present in the project"

file path onecol nohead table project_sample_subset_samp_keep_file=@project_sample_subset.samp.keep dir project_sample_subset_dir disp ".samp.keep" parent cat_project_sample_subset_snp_variant_call_data class_level project_sample_subset comment "List of samples to keep for this subset"

file path onecol nohead table project_sample_subset_samp_exclude_file=@project_sample_subset.samp.exclude dir project_sample_subset_dir disp ".samp.exclude" parent cat_project_sample_subset_snp_variant_call_data class_level project_sample_subset comment "List of samples to exclude for this subset"

file path onecol nohead table project_sample_subset_clean_samp_keep_file=@project_sample_subset.clean.samp.keep dir project_sample_subset_dir disp ".clean.samp.keep" parent cat_project_sample_subset_snp_variant_call_data class_level project_sample_subset comment "List of samples that are in this subset for the clean file"

!!expand:project:project:project_sample_subset:project_variant_subset:project_merge_subset! \
major file path doubcom table project_vcf_file=@project.vcf@zip_vcf dir project_dir disp ".vcf" parent cat_project_snp_variant_call_data class_level project comment "VCF file for project; initial file with extra degeneracy annotation"

!!expand:project:project:project_sample_subset:project_variant_subset:project_merge_subset! \
major file path doubcom table project_indel_vcf_file=@project.indel.vcf@zip_vcf dir project_dir disp ".indel.vcf" parent cat_project_indel_variant_call_data class_level project comment "Indel VCF file for project"

!!expand:project:project:project_sample_subset:project_variant_subset:project_merge_subset! \
major file path doubcom table project_multiallelic_vcf_file=@project.multiallelic.vcf@zip_vcf dir project_dir disp ".multiallelic.vcf" parent cat_project_multiallelic_variant_call_data class_level project comment "Multiallelic VCF file for project"

!!expand:project:project:project_merge_subset! \
minor file path table project_pos_transcript_file=@project.pos.transcript dir project_dir disp ".pos.transcript" parent cat_project_all_variant_call_data class_level project comment "Annotation of each variant position with transcript"

#!!expand:projectt:project:project_sample_subset:project_variant_subset! \
#constant projectt_indel_project_exon_browser=Open disp "Exon Browser" parent cat_projectt_plinkseq_indel_project_data goto_url ${plinkseq_exome_browser_url}?proj=*projectt_plinkseq_indel_project_file&loc=$pseq_genes_loc_group comment "Link to Plink/Seq exon browser for indel projectt variants"
!!expand:projectt:project:project_sample_subset:project_variant_subset! \
#table nohead file path projectt_plinkseq_indel_project_file=@projectt.plinkseq.indel.project dir projectt_dir disp ".plinkseq.indel.project" parent cat_projectt_plinkseq_indel_project_data class_level projectt comment "Plink/Seq indel project file"
#!!expand:projectt:project:project_sample_subset:project_variant_subset! \
#mkdir path projectt_plinkseq_indel_project_out_dir=*{projectt_plinkseq_indel_project_file}_out class_level projectt chmod 777
#!!expand:projectt:project:project_sample_subset:project_variant_subset! \
#mkdir path projectt_plinkseq_indel_project_temp_dir=*{projectt_plinkseq_indel_project_file}_temp class_level projectt chmod 777
#!!expand:projectt:project:project_sample_subset:project_variant_subset! \
#file path projectt_plinkseq_indel_vardb_file=vardb dir projectt_plinkseq_indel_project_out_dir disp "vardb" parent cat_projectt_plinkseq_indel_project_data class_level projectt comment "Indel Plink/Seq vardb file"
#!!expand:projectt:project:project_sample_subset:project_variant_subset! \
#file path projectt_plinkseq_indel_inddb_file=inddb dir projectt_plinkseq_indel_project_out_dir disp "inddb" parent cat_projectt_plinkseq_indel_project_data class_level projectt comment "Indel Plink/Seq inddb file"

#!!expand:projectt:project:project_sample_subset:project_variant_subset! \
#file path projectt_plinkseq_indel_project_done_file=.$projectt_plinkseq_indel_project_file.done dir projectt_dir disp "project.done" parent cat_projectt_plinkseq_indel_project_data class_level projectt comment "Signifies that indel project was done"
#!!expand:projectt:project:project_sample_subset:project_variant_subset! \
#file path projectt_plinkseq_indel_db_done_file=db.done dir projectt_plinkseq_indel_project_out_dir disp "db.done" parent cat_projectt_plinkseq_indel_project_data class_level projectt comment "Signifies that indel db was done"
#!!expand:projectt:project:project_sample_subset:project_variant_subset! \
#file path projectt_plinkseq_indel_temp_done_file=temp.done dir projectt_plinkseq_indel_project_temp_dir disp "temp.done" parent cat_projectt_plinkseq_indel_project_data class_level projectt comment "Signifies that indel temp dir was made"

#major file path doubcom table project_samtools_vcf_file=@project.samtools.vcf dir project_dir disp ".samtools.vcf" parent cat_project_samtools_call_data class_level project comment "VCF file for project --- generated by SAMTOOLS"

#minor file path doubcom table project_plinkseq_vcf_file=@project.plinkseq.vcf dir project_dir disp ".plinkseq.vcf" parent cat_project_call_data class_level project comment "VCF file for project in format Plinkseq can read; bug in reading 4.0"

!!expand:project:project:project_sample_subset:project_variant_subset:project_merge_subset! \
major file path doubcom table project_clean_vcf_file=@project.clean.vcf@zip_vcf dir project_dir disp ".clean.vcf" parent cat_project_snp_variant_call_data class_level project comment "Clean VCF file for project; outlier samples and variants removed"

!!expand:project:project:project_sample_subset:project_variant_subset:project_merge_subset! \
major file path doubcom table project_clean_indel_vcf_file=@project.clean.indel.vcf@zip_vcf dir project_dir disp ".clean.indel.vcf" parent cat_project_indel_variant_call_data class_level project comment "Clean Indel VCF file for project"

!!expand:project:project:project_sample_subset:project_variant_subset:project_merge_subset! \
major file path doubcom table project_clean_multiallelic_vcf_file=@project.clean.multiallelic.vcf@zip_vcf dir project_dir disp ".clean.multiallelic.vcf" parent cat_project_multiallelic_variant_call_data class_level project comment "Clean multiallelic VCF file for project"

!!expand:project:project:project_variant_subset:project_merge_subset! \
major file path doubcom table project_clean_all_vcf_file=@project.clean.all.vcf.gz dir project_dir disp ".clean.all.vcf" parent cat_project_all_variant_call_data class_level project comment "Clean VCF file with all variants for project"

#major file path doubcom table project_samtools_clean_vcf_file=@project.samtools.clean.vcf dir project_dir disp ".samtools.clean.vcf" parent cat_project_samtools_call_data class_level project comment "VCF file for project with QC- samples removed --- generated by SAMTOOLS"

!!expand:project:project:project_variant_subset! \
file path doubcom table project_gene_variant_file=@project.gene.variant.tsv dir project_dir disp ".gene.variant.tsv" parent cat_project_all_variant_call_data class_level project comment "List of gene, variant for each variant in vcf file"

!!expand:project:project:project_variant_subset! \
file path doubcom table project_clean_gene_variant_file=@project.clean.gene.variant.tsv dir project_dir disp ".clean.gene.variant.tsv" parent cat_project_all_variant_call_data class_level project comment "List of gene, variant for each variant in clean vcf file"

minor file path doubcom table project_variant_subset_gene_burden_size_file=@project_variant_subset.gene_burden.size dir project_variant_subset_dir disp ".gene_burden.size" parent cat_project_variant_subset_annot_data class_level project_variant_subset comment "Helper file listing the 'size' of this variant subset for use in splitting later at the pheno level"


#minor file path doubcom table project_clean_plinkseq_vcf_file=@project.clean.plinkseq.vcf dir project_dir disp ".clean.plinkseq.vcf" parent cat_project_call_data class_level project comment "Clean VCF file for project; outlier samples and variants removed; format Plinkseq can read"

major file path project_vcf_eval_file=@project.eval dir project_dir disp ".eval" parent cat_project_call_all_bulk_properties_data class_level project comment "Eval statistics on project variants" child_order -1

table file path project_theta_eval_file=@project.eval.theta.csv dir project_dir disp ".theta.csv" parent cat_project_call_theta_bulk_properties_data class_level project comment "Estimates of theta based on variant and genotype calls"

#!!expand:,:ext,weblevel:dat,table:pdf,major! \
#!!expand:qc_type:qc_pass! \
#weblevel file path project_qc_type_theta_ac_ext_file=@project.qc_type.theta.ac.ext dir project_dir disp ".qc_type.theta.ac.ext" parent cat_project_call_theta_bulk_properties_data class_level project comment "Plot of theta estimate for each allele count --- ext file for qc_type variants"

table file path project_titv_eval_file=@project.eval.titv.csv dir project_dir disp ".titv.csv" parent cat_project_call_titv_bulk_properties_data class_level project comment "Estimates of transition transversion ratio based on variant calls"

table file path project_titv_ac_file=@project.titv.ac.csv dir project_dir disp ".titv.ac.csv" parent cat_project_call_titv_bulk_properties_data class_level project comment "TiTv by allele count"
table file path project_titv_ac_binned_file=@project.titv.ac.binned.csv dir project_dir disp ".titv.ac.binned.csv" parent cat_project_call_titv_bulk_properties_data class_level project comment "TiTv by allele count; binned to have at least $num_per_titv_ac_bin variants per bin"
major file path project_titv_ac_pdf_file=@project.titv.ac.pdf dir project_dir disp ".titv.ac.pdf" parent cat_project_call_titv_bulk_properties_data class_level project comment "TiTv by allele count; binned to have at least $num_per_titv_ac_bin variants per bin; pdf file"

!!expand:project:project:project_variant_subset! \
table file path project_snpeff_file=@project.snpeff.tsv dir project_dir disp ".snpeff" parent cat_project_annot_data class_level project comment "List of SNPEff annotations for all variants"

!!expand:project:project:project_variant_subset! \
table file path project_snpsift_file=@project.snpsift.tsv dir project_dir disp ".snpsift" parent cat_project_annot_data class_level project comment "List of SNPSift annotations for all variants"

!!expand:project:project:project_variant_subset! \
table file path project_chaos_vcf_file=@project.chaos.vcf dir project_dir disp ".chaos.vcf" parent cat_project_annot_data class_level project comment "List of Chaos annotations for all variants, in VCF format"

!!expand:project:project:project_variant_subset! \
table file path project_chaos_file=@project.chaos dir project_dir disp ".chaos" parent cat_project_annot_data class_level project comment "List of Chaos annotations for all variants, extracted from VCF"

!!expand:project:project:project_variant_subset! \
table file path project_vep_file=@project.vep.tsv dir project_dir disp ".vep" parent cat_project_annot_data class_level project comment "List of Variant Effect Predictor annotations for all variants"

!!expand:project:project:project_variant_subset! \
table file path project_parsed_vep_file=@project.parsed_vep.tsv dir project_dir disp ".parsed_vep" parent cat_project_annot_data class_level project comment "List of Variant Effect Predictor annotations for all variants; parsed for better formatting"

!!expand:project:project:project_variant_subset! \
table file path project_var_transcript_file=@project.var_transcript.tsv dir project_dir disp ".var_transcript.tsv" parent cat_project_annot_data class_level project comment "Transcript to use for each variant (global annotations)"

!!expand:project:project:project_variant_subset! \
table file path project_pph2_pos_file=@project.pph2.pos.tsv dir project_dir disp ".pph2.pos" parent cat_project_annot_data class_level project comment "List of PPH2 scores for all locations that contain variants"

!!expand:project:project:project_variant_subset! \
table file path project_pph2_file=@project.pph2.tsv dir project_dir disp ".pph2" parent cat_project_annot_data class_level project comment "List of PPH2 scores for all variants"

table file path project_reduced_trans_file=@project.reduced.trans dir project_dir disp ".reduced.trans" parent cat_project_annot_data class_level project comment "List of transcripts to restrict annotations to (specify this directly)"

table file path project_effect_size_map_file=@project.effect_size.map dir project_dir disp ".effect_size.map" parent cat_project_annot_data class_level project comment "Numerical mapping to effect size; format is TAG (one of VEP, SNPEFF, CHAOS), an comma delimited entry of effects to match exactly, and a number (smaller is more impactful). Specify this directly."

!!expand:project:project:project_variant_subset! \
table file path project_custom_var_annot_file=@project.custom_var_annot.tsv dir project_dir disp ".custom_var_annot" parent cat_project_annot_data class_level project comment "List of custom annotations (if specified)"

!!expand:project:project:project_variant_subset! \
table file path project_custom_trans_annot_file=@project.custom_trans_annot.tsv dir project_dir disp ".custom_trans_annot" parent cat_project_annot_data class_level project comment "List of custom annotations (with transcript key added)"

!!expand:project:project:project_variant_subset! \
table file path project_complete_full_annot_file=@project.complete.full_annot.tsv dir project_dir disp ".complete.full_annot" parent cat_project_annot_data class_level project comment "Full list of all combined annotations"

!!expand:project:project:project_variant_subset! \
table file path project_full_annot_file=@project.full_annot.tsv dir project_dir disp ".full_annot" parent cat_project_annot_data class_level project comment "Full list of all combined annotations; subset to allowable transcripts"

!!expand:project:project:project_variant_subset! \
table file path project_full_var_annot_file=@project.full_var_annot.tsv dir project_dir disp ".full_var_annot" parent cat_project_annot_data class_level project comment "Full list of all combined annotations, with most severe annotation chosen for each variant"

!!expand:project:project:project_variant_subset! \
!!expand:,:maskkey,masktype,maskdescrip:syn,syn.,synonymous:ns,ns.,non-synonymous:nonsense,nonsense.,nonsense:coding,coding.,coding! \
 table file path project_plinkseq_maskkey_reg_file=@project.masktypereg dir project_dir disp ".masktypereg" parent cat_project_mask_data class_level project comment "Mask for Plink/Seq i-stats using maskdescrip variants"


#!!expand:project:project:project_variant_subset! \
#table file path project_annot_pseq_file=@project.annot.pseq dir project_dir disp ".annot.pseq" parent cat_project_annot_data class_level project comment "Annotations converted into Plink/SEQ format"

#plinkseq data
!!expand:projectt:project:project_sample_subset:project_variant_subset! \
constant projectt_project_exon_browser=Open disp "Exon Browser" parent cat_projectt_plinkseq_project_data goto_url ${plinkseq_exome_browser_url}?proj=*projectt_plinkseq_project_file&loc=$pseq_genes_loc_group comment "Link to Plink/Seq exon browser for projectt variants"
!!expand:projectt:project:project_sample_subset:project_variant_subset! \
table nohead file path projectt_plinkseq_project_file=@projectt.plinkseq.project.pseq dir projectt_dir disp ".plinkseq.project" parent cat_projectt_plinkseq_project_data class_level projectt comment "Plink/Seq project file"
!!expand:projectt:project:project_sample_subset! \
nohead table file path projectt_plinkseq_ind_info_file=@projectt.ind.info dir projectt_dir disp ".ind.info" parent cat_projectt_plinkseq_project_data class_level projectt comment "Ind file for import into Plink/Seq"

!!expand:projectt:project:project_sample_subset:project_variant_subset! \
mkdir path projectt_plinkseq_project_out_dir=*{projectt_plinkseq_project_file}_out class_level projectt chmod 777
!!expand:projectt:project:project_sample_subset:project_variant_subset! \
mkdir path projectt_plinkseq_project_temp_dir=*{projectt_plinkseq_project_file}_temp class_level projectt chmod 777
!!expand:projectt:project:project_sample_subset:project_variant_subset! \
file path projectt_plinkseq_vardb_file=vardb dir projectt_plinkseq_project_out_dir disp "vardb" parent cat_projectt_plinkseq_project_data class_level projectt comment "Plink/Seq vardb file"
!!expand:projectt:project:project_sample_subset:project_variant_subset! \
file path projectt_plinkseq_inddb_file=inddb dir projectt_plinkseq_project_out_dir disp "inddb" parent cat_projectt_plinkseq_project_data class_level projectt comment "Plink/Seq inddb file"
!!expand:projectt:project:project_sample_subset:project_variant_subset! \
file path projectt_plinkseq_project_done_file=.$projectt_plinkseq_project_file.done dir projectt_dir disp "project.done" parent cat_projectt_plinkseq_project_data class_level projectt comment "Signifies the varproject was built"
!!expand:projectt:project:project_sample_subset:project_variant_subset! \
ignore_md5 file path projectt_plinkseq_db_done_file=db.done dir projectt_plinkseq_project_out_dir disp "db.done" parent cat_projectt_plinkseq_project_data class_level projectt comment "Signifies the vardb was built"
!!expand:projectt:project:project_sample_subset:project_variant_subset! \
file path projectt_plinkseq_temp_done_file=temp.done dir projectt_plinkseq_project_temp_dir disp "temp.done" parent cat_projectt_plinkseq_project_data class_level projectt comment "Signifies the temp dir was made"
!!expand:projectt:project:project_variant_subset! \
file path projectt_plinkseq_locdb_file=locdb dir projectt_dir disp "locdb" parent cat_projectt_plinkseq_project_data class_level projectt comment "Plink/Seq locdb file"

file path project_plinkseq_seqdb_file=seqdb dir project_dir disp "seqdb" parent cat_project_plinkseq_project_data class_level project comment "Plink/Seq seqdb file"

#table nohead file path project_generic_locset_file=@project.generic.locset.list dir project_dir disp "generic.locset.list" parent cat_project_plinkseq_project_data class_level project comment "List of locsets for pathways; generic list applicable to any project"

table nohead file path project_custom_locset_file=@project.custom.locset.list dir project_dir disp "custom.locset.list" parent cat_project_plinkseq_project_data class_level project comment "List of locsets custom to this project"

!!expand:pathwayburdentype:custom! \
table nohead file path project_pathway_pathwayburdentype_flat_locset_file=@project.pathwayburdentype.flat.locset.list dir project_dir disp "pathwayburdentype.flat.locset.list" parent cat_project_plinkseq_project_data class_level project comment "List of locsets pathwayburdentype to this project --- one row per gene set"

!!expand:projectt:project:project_sample_subset:project_variant_subset! \
constant projectt_clean_project_exon_browser=Open disp "Exon Browser" parent cat_projectt_plinkseq_clean_project_data goto_url ${plinkseq_exome_browser_url}?proj=*projectt_plinkseq_clean_project_file&loc=$pseq_genes_loc_group comment "Link to Plink/Seq exon browser for clean projectt variants"
!!expand:projectt:project:project_sample_subset:project_variant_subset! \
table nohead file path projectt_plinkseq_clean_project_file=@projectt.plinkseq.clean.project.pseq dir projectt_dir disp ".plinkseq.clean.project" parent cat_projectt_plinkseq_clean_project_data class_level projectt comment "Plink/Seq clean project file"
!!expand:projectt:project:project_sample_subset:project_variant_subset! \
mkdir path projectt_plinkseq_clean_project_out_dir=*{projectt_plinkseq_clean_project_file}_out class_level projectt chmod 777
!!expand:projectt:project:project_sample_subset:project_variant_subset! \
mkdir path projectt_plinkseq_clean_project_temp_dir=*{projectt_plinkseq_clean_project_file}_temp class_level projectt chmod 777
!!expand:projectt:project:project_sample_subset:project_variant_subset! \
file path projectt_plinkseq_clean_vardb_file=vardb dir projectt_plinkseq_clean_project_out_dir disp "vardb" parent cat_projectt_plinkseq_clean_project_data class_level projectt comment "Clean Plink/Seq vardb file"
!!expand:projectt:project:project_sample_subset:project_variant_subset! \
file path projectt_plinkseq_clean_inddb_file=inddb dir projectt_plinkseq_clean_project_out_dir disp "inddb" parent cat_projectt_plinkseq_clean_project_data class_level projectt comment "Clean Plink/Seq inddb file"
!!expand:projectt:project:project_sample_subset:project_variant_subset! \
file path projectt_plinkseq_clean_project_done_file=.$projectt_plinkseq_clean_project_file.done dir projectt_dir disp "project.done" parent cat_projectt_plinkseq_clean_project_data class_level projectt comment "Signifies that clean project was done"
!!expand:projectt:project:project_sample_subset:project_variant_subset! \
ignore_md5 file path projectt_plinkseq_clean_db_done_file=db.done dir projectt_plinkseq_clean_project_out_dir disp "db.done" parent cat_projectt_plinkseq_clean_project_data class_level projectt comment "Signifies that clean db was done"
!!expand:projectt:project:project_sample_subset:project_variant_subset! \
file path projectt_plinkseq_clean_temp_done_file=temp.done dir projectt_plinkseq_clean_project_temp_dir disp "temp.done" parent cat_projectt_plinkseq_clean_project_data class_level projectt comment "Signifies that clean temp dir was made"

#constant samtools_clean_project_exon_browser=Open disp "Exon Browser" parent cat_project_plinkseq_samtools_clean_project_data goto_url ${plinkseq_exome_browser_url}?proj=*project_plinkseq_samtools_clean_project_file&loc=$pseq_genes_loc_group comment "Link to Plink/Seq exon browser for samtools clean project variants"
#table nohead file path project_plinkseq_samtools_clean_project_file=@project.plinkseq.samtools.clean.project dir project_dir disp ".plinkseq.samtools.clean.project" parent cat_project_plinkseq_samtools_clean_project_data class_level project comment "Plink/Seq samtools clean project file"
#mkdir path project_plinkseq_samtools_clean_project_out_dir=*{project_plinkseq_samtools_clean_project_file}_out class_level project chmod 777
#mkdir path project_plinkseq_samtools_clean_project_temp_dir=*{project_plinkseq_samtools_clean_project_file}_temp class_level project chmod 777
#minor file path project_plinkseq_samtools_clean_vardb_file=vardb dir project_plinkseq_samtools_clean_project_out_dir disp "vardb" parent cat_project_plinkseq_samtools_clean_project_data class_level project comment "Samtools clean Plink/Seq vardb file"
#minor file path project_plinkseq_samtools_clean_inddb_file=inddb dir project_plinkseq_samtools_clean_project_out_dir disp "inddb" parent cat_project_plinkseq_samtools_clean_project_data class_level project comment "Samtools clean Plink/Seq inddb file"
#minor file path project_plinkseq_samtools_clean_db_done_file=db.done dir project_plinkseq_samtools_clean_project_out_dir disp "db.done" parent cat_project_plinkseq_samtools_clean_project_data class_level project comment "Signifies that samtools clean db was done"


!!expand:qctype:qc_pass:qc_plus! \
file path project_qctype_all_merge_list_file=@project.qctype.all.merge.list dir project_dir disp ".all.merge.list" parent cat_project_plink_seq_qctype_data class_level project comment "List of all marker files"

!!expand:qctype:qc_pass:qc_plus! \
file path project_qctype_plink_list_file=@project.qctype.plink.list dir project_dir disp ".plink.list" parent cat_project_plink_seq_qctype_data class_level project comment "List of plink trunks of marker files for merging --- have this to make sure the first file passed into the merge is always the first file in the merge list"

!!expand:qctype:qc_pass:qc_plus! \
file path project_qctype_merge_list_file=@project.qctype.merge.list dir project_dir disp ".merge.list" parent cat_project_plink_seq_qctype_data class_level project comment "List of marker files for merging"

!!expand:project:project:project_sample_subset:project_variant_subset! \
!!expand:qctype:qc_pass:qc_plus! \
path project_plinkseq_qctype_plink_file=@project.qctype dir project_dir

!!expand:project:project:project_sample_subset:project_variant_subset! \
!!expand:qctype:qc_pass:qc_plus! \
!!expand:,:keytype,ext:tped,tped:tfam,tfam:renamed_tfam,renamed.tfam:bed,bed:bim,bim:fam,fam:with_sex_fam,with.sex.fam! \
file path project_plinkseq_qctype_keytype_file=@project.qctype.ext dir project_dir disp ".ext" parent cat_project_plink_seq_qctype_data class_level project comment "ext file format for qctype vcf file"

!!expand:project:project:project_sample_subset:project_variant_subset! \
!!expand:qctype:qc_pass:qc_plus! \
minor file path project_plinkseq_qctype_make_bed_log_file=@project.qctype.make_bed.log dir project_dir disp ".make_bed.log" parent cat_project_plink_seq_qctype_data class_level project comment "Log file for make-bed command"


!!expand:project:project:project_variant_subset! \
path project_plinkseq_qc_pass_unthresholded_plink_file=@project.qc_pass.unthresholded dir project_dir

!!expand:project:project:project_variant_subset! \
!!expand:,:keytype,ext:tped,tped:tfam,tfam:renamed_tfam,renamed.tfam:bed,bed:bim,bim:fam,fam:with_sex_fam,with.sex.fam! \
file path project_plinkseq_qc_pass_unthresholded_keytype_file=@project.qc_pass.unthresholded.ext dir project_dir disp ".unthresholded.ext" parent cat_project_plink_seq_qc_pass_data class_level project comment "ext file format for qc_pass vcf file; no threshold based on genotype quality"

!!expand:project:project:project_variant_subset! \
minor file path project_plinkseq_qc_pass_unthresholded_make_bed_log_file=@project.qc_pass.unthresholded.make_bed.log dir project_dir disp ".unthresholded.make_bed.log" parent cat_project_plink_seq_qc_pass_data class_level project comment "Log file for make-bed command for unthresholded file"



table file path project_seq_iid_fid_map_file=@project.seq.iid.fid.map dir project_dir disp ".iid.fid.map" parent cat_project_plink_seq_meta_data class_level project comment "Map from iid to fid for all samples with sequence data in the project"

!!expand:project:project:project_variant_subset! \
!!expand:qctype:qc_pass:qc_plus! \
table file path project_plinkseq_qctype_frq_file=$project_plinkseq_qctype_plink_file.frq dir project_dir disp ".frq" parent cat_project_plink_qctype_output_data class_level project comment "Frequency for all samples computed based on qctype plink file"

!!expand:qctype:qc_pass:qc_plus! \
!!expand:project:project:project_variant_subset! \
minor file path project_plinkseq_qctype_frq_log_file=$project_plinkseq_qctype_frq_file.log dir project_dir disp ".frq.log" parent cat_project_plink_qctype_output_data class_level project comment "Log file for frq command"

!!expand:project:project:project_variant_subset! \
table file path project_multiallelic_frq_file=@project.multiallelic.frq dir project_dir disp ".multiallelic.frq" parent cat_project_plink_qc_pass_output_data class_level project comment "Frequency for QC+ samples computed based on QC pass plink file at multialellic variants"

!!expand:qctype:qc_pass:qc_plus! \
!!expand:project:project:project_variant_subset! \
table file path project_plinkseq_qctype_combined_frq_file=$project_plinkseq_qctype_plink_file.combined.frq dir project_dir disp ".combined.frq" parent cat_project_plink_qctype_output_data class_level project comment "Combined frq file for single variants and multiallelics"


!!expand:qc_plus:qc_plus:qc_pass! \
!!expand:project:project:project_variant_subset! \
table file path project_plinkseq_qc_plus_strata_frq_file=$project_plinkseq_qc_plus_plink_file.strata.frq dir project_dir disp ".strata.frq" parent cat_project_plink_qc_plus_output_data class_level project comment "Frequency for all samples computed based on qc_plus plink file, stratified by specified maf_strata_trait"

!!expand:qc_plus:qc_plus:qc_pass! \
!!expand:project:project:project_variant_subset! \
minor file path project_plinkseq_qc_plus_strata_frq_log_file=$project_plinkseq_qc_plus_strata_frq_file.log dir project_dir disp ".strata.frq.log" parent cat_project_plink_qc_plus_output_data class_level project comment "Log file for strata frq command"

table file path project_multiallelic_strata_frq_file=@project.multiallelic.strata.frq dir project_dir disp ".multiallelic.strata.frq" parent cat_project_plink_qc_pass_output_data class_level project comment "Frequency for QC+ samples computed based on qc_pass plink file, stratified by specified maf_strata_trait"

!!expand:qc_plus:qc_plus:qc_pass! \
!!expand:project:project:project_variant_subset! \
table file path project_plinkseq_qc_plus_combined_strata_frq_file=$project_plinkseq_qc_plus_plink_file.combined.strata.frq dir project_dir disp ".combined.strata.frq" parent cat_project_plink_qc_plus_output_data class_level project comment "Combined strata.frq files for single variants and multialellics"

!!expand:qc_plus:qc_plus:qc_pass! \
!!expand:project:project:project_variant_subset! \
table file path project_plinkseq_qc_plus_strata_frq_summary_file=$project_plinkseq_qc_plus_plink_file.strata.frq.summary dir project_dir disp ".qc_plus.strata.frq.summary" parent cat_project_plink_qc_plus_output_data class_level project comment "Summaries of frequencies across strata"

!!expand:project:project:project_variant_subset! \
minor file path project_plinkseq_qc_plus_frq_log_file=$project_plinkseq_qc_plus_frq_file.log dir project_dir disp ".frq.log" parent cat_project_plink_qc_plus_output_data class_level project comment "Log file for frq command"

!!expand:project:project:project_variant_subset! \
!!expand:qctype:qc_pass:qc_plus! \
table file path project_plinkseq_qctype_counts_file=$project_plinkseq_qctype_plink_file.counts dir project_dir disp ".counts" parent cat_project_plink_qctype_output_data class_level project comment "Minor allele counts for all samples computed based on qctype plink file"

!!expand:qctype:qc_pass:qc_plus! \
table file path project_plinkseq_qctype_sing_reg_list_file=$project_plinkseq_qctype_plink_file.sing.reg.list dir project_dir disp ".sing.reg.list" parent cat_project_plink_qctype_output_data class_level project comment "Singleton variants"

table file path project_plinkseq_qc_pass_doub_reg_list_file=$project_plinkseq_qc_pass_plink_file.doub.reg.list dir project_dir disp ".doub.reg.list" parent cat_project_plink_qc_pass_output_data class_level project comment "Doubleton variants"

!!expand:,:_frequency,.frequency,Frequency:,,all:_high,.high,common:_low,.low,low frequency! \
!!expand:project:project:project_sample_subset! \
table file path project_plinkseq_frequency_het_file=$project_plinkseq_qc_pass_plink_file.frequency.het dir project_dir disp ".frequency.het" parent cat_project_plink_output_data class_level project comment "Heterozygosity for all samples computed based on qc_pass plink file (Frequency SNPs)"

!!expand:,:_frequency,.frequency,Frequency:,,all:_high,.high,common! \
!!expand:project:project:project_sample_subset! \
minor file path project_plinkseq_frequency_het_log_file=$project_plinkseq_frequency_het_file.log dir project_dir disp ".frequency.het.log" parent cat_project_plink_output_data class_level project comment "Log file for het command for Frequency SNPs"

!!expand:project:project:project_sample_subset! \
table file path project_plinkseq_sexcheck_file=$project_plinkseq_qc_pass_plink_file.sexcheck dir project_dir disp ".sexcheck" parent cat_project_plink_output_data class_level project comment "Sex check for all samples computed based on qc_pass plink file"

!!expand:project:project:project_sample_subset! \
minor file path project_plinkseq_sexcheck_log_file=$project_plinkseq_sexcheck_file.log dir project_dir disp ".sexcheck.log" parent cat_project_plink_output_data class_level project comment "Log file for sex check command"

!!expand:project:project:project_sample_subset! \
!!expand:,:maskkey,masktype,maskdescrip:all,,all:syn,syn.,synonymous:ns,ns.,non-synonymous:nonsense,nonsense.,nonsense:noncoding,noncoding.,noncoding! \
!!expand:,:tname,description:raw,were called:qc_pass,pass filters:qc_plus,pass QC! \ 
 table file path project_plinkseq_tname_maskkey_istats_file=@project.tname.masktypeistats dir project_dir disp ".tname.masktypeistats" parent cat_project_tname_istats_data class_level project comment "Dumped by Plink/Seq i-stats using maskdescrip variants that description"

!!expand:project:project:project_sample_subset! \
!!expand:,:tname,description:qc_pass,pass filters:qc_plus,pass QC! \ 
table file path project_plinkseq_tname_sing_istats_file=@project.tname.sing.istats dir project_dir disp ".tname.sing.istats" parent cat_project_tname_istats_data class_level project comment "Dumped by Plink/Seq i-stats using singleton variants that description"

!!expand:project:project:project_sample_subset! \
 table file path project_plinkseq_qc_pass_doub_istats_file=@project.qc_pass.doub.istats dir project_dir disp ".qc_pass.doub" parent cat_project_qc_pass_istats_data class_level project comment "Dumped by Plink/Seq i-stats using doubleton variants that pass filters"

!!expand:project:project:project_sample_subset! \
 table file path project_plinkseq_qc_pass_snp_istats_file=@project.qc_pass.snp.istats dir project_dir disp ".qc_pass.snp" parent cat_project_qc_pass_istats_data class_level project comment "Dumped by Plink/Seq i-stats using SNP variants that pass filters"

!!expand:project:project:project_sample_subset! \
 table file path project_plinkseq_qc_pass_indel_istats_file=@project.qc_pass.indel.istats dir project_dir disp ".qc_pass.indel" parent cat_project_qc_pass_istats_data class_level project comment "Dumped by Plink/Seq i-stats using indel variants that pass filters"

!!expand:project:project:project_sample_subset! \
 table file path project_plinkseq_qc_pass_multiallelic_istats_file=@project.qc_pass.multiallelic.istats dir project_dir disp ".qc_pass.multiallelic" parent cat_project_qc_pass_istats_data class_level project comment "Dumped by Plink/Seq i-stats using multiallelic variants that pass filters"

!!expand:project:project:project_sample_subset! \
table file path project_plinkseq_filtered_istats_file=@project.filtered.istats dir project_dir disp ".filtered.istats" parent cat_project_qc_ind_stats_data class_level project comment "Dumped by Plink/Seq i-stats using variants that fail filters"

!!expand:,:type:snps:indels:multiallelics! \
!!expand:,:project,cattouse:project,cat_project_qc_var_stats_data:project_variant_subset,cat_project_variant_subset_qc_var_stats_data! \
table file path project_plinkseq_type_vmatrix_file=@project.type.vmatrix dir project_dir disp ".type.vmatrix" parent cattouse class_level project comment "Dumped by Plink/Seq v-matrix using type that pass filters; no quality threshold"

!!expand:project:project:project_sample_subset! \
!!expand:metatype:gq:dp:ab:sing_ab! \
table file path project_plinkseq_metatype_vmetamatrix_file=@project.metatype.vmetamatrix dir project_dir disp ".metatype.vmetamatrix" parent cat_project_qc_ind_stats_data class_level project comment "Dumped by Plink/Seq v-meta-matrix --name metatype using variants that pass filters"

!!expand:project:project:project_sample_subset! \
!!expand:metatype:dp! \
table file path project_plinkseq_metatype_qcfail_vmetamatrix_file=@project.metatype.qcfail.vmetamatrix dir project_dir disp ".metatype.qcfail.vmetamatrix" parent cat_project_qc_ind_stats_data class_level project comment "Dumped by Plink/Seq v-meta-matrix --name metatype using variants that failed filters"

!!expand:project:project:project_sample_subset! \
table file path project_plinkseq_qcfail_vmatrix_file=@project.qcfail.vmatrix dir project_dir disp ".qcfail.vmatrix" parent cat_project_qc_ind_stats_data class_level project comment "Dumped by Plink/Seq v-matrix using variants that fail filters"

!!expand:project:project:project_sample_subset! \
table file path project_plinkseq_extra_istats_file=@project.extra.istats dir project_dir disp ".extra.istats" parent cat_project_qc_ind_stats_data class_level project comment "Additional sample statistics to append to i-stats"

table file project_sample_custom_exclude_file=@project.sample.custom.exclude dir project_dir disp ".sample.custom.exclude" parent cat_project_qc_ind_stats_data class_level project comment "Custom list of samples to exclude"

#table file path project_unfiltered_marker_istats_file=@project.unfiltered.marker.istats dir project_dir disp ".marker.istats" parent cat_project_qc_ind_stats_data class_level project comment "Sample statistics based on marker file --- no samples removed"

major table file path project_sstats_file=@project.sstats dir project_dir disp ".sstats" parent cat_project_qc_ind_stats_data class_level project comment "All relevant sample statistics"

major table file path project_traits_file=@project.traits dir project_dir disp ".traits" parent cat_project_qc_ind_stats_data class_level project comment "All relevant sample traits"

major table file path project_sample_outlier_file=@project.sample.outliers.csv dir project_dir disp ".outliers.csv" parent cat_project_sample_qc_filter_data class_level project comment "Outlier values from all sample statistics"

major file path project_sstats_initial_pdf_file=@project.sstats.initial.pdf dir project_dir disp ".sstats.pdf" parent cat_project_qc_ind_plots_data class_level project comment "Plot of various sample metrics across all samples --- hist plots"
major file path project_sstats_highlighted_pdf_file=@project.sstats.highlighted.pdf dir project_dir disp ".highlighted.pdf" parent cat_project_qc_ind_plots_data class_level project comment "Plot of various sample metrics across all samples with outlier samples highlighted --- hist plot"

major file path project_sstats_final_pdf_file=@project.sstats.final.pdf dir project_dir disp ".final.pdf" parent cat_project_qc_ind_plots_data class_level project comment "Plot of various sample metrics across all samples with outlier samples removed --- hist plot"

!!expand:ext:ps:pdf! \
major file path project_pheno_sstats_initial_ext_file=@project.pheno.sstats.initial.ext dir project_dir disp ".pheno.sstats.ext" parent cat_project_qc_ind_plots_data class_level project comment "Plot of various sample metrics across all samples stratified by phenotype --- hist plots"

!!expand:ext:ps:pdf! \
major file path project_pheno_sstats_highlighted_ext_file=@project.pheno.sstats.highlighted.ext dir project_dir disp ".pheno.highlighted.ext" parent cat_project_qc_ind_plots_data class_level project comment "Plot of various sample metrics across all samples stratified by phenotype with outlier samples highlighted --- hist plot"

!!expand:ext:ps:pdf! \
major file path project_pheno_sstats_final_ext_file=@project.pheno.sstats.final.ext dir project_dir disp ".pheno.final.ext" parent cat_project_qc_ind_plots_data class_level project comment "Plot of various sample metrics across all samples stratified by phenotype with outlier samples removed --- hist plot"

major file path project_sstats_extreme_pdf_file=@project.sstats.extreme.pdf dir project_dir disp ".extreme.pdf" parent cat_project_qc_ind_plots_data class_level project comment "Plot of various sample metrics across all samples with outlier samples removed --- highlighting extreme samples"

table file path project_sample_exclude_detail_file=@project.sample.exclude.detail dir project_dir disp ".sample.exclude.detail" parent cat_project_sample_qc_filter_data class_level project comment "Samples excluded because they are outliers on one or more measures --- with information about the metrics that caused them to fail"

!!expand:type:seq! \
file path project_sample_type_exclude_file=@project.sample.type.exclude dir project_dir disp ".sample.type.exclude" parent cat_project_sample_qc_filter_data class_level project comment "Samples excluded because they are outliers on one or more type measures"

file path project_sample_exclude_file=@project.sample.exclude dir project_dir disp ".sample.exclude" parent cat_project_sample_qc_filter_data class_level project comment "Samples excluded because they are outliers on one or more seq measures"

file path project_sample_include_file=@project.sample.include dir project_dir disp ".sample.include" parent cat_project_sample_qc_filter_data class_level project comment "Samples includeded because they are outliers on zero measures"

file path project_plink_sample_exclude_file=@project.plink.sample.exclude dir project_dir disp ".plink.sample.exclude" parent cat_project_sample_qc_filter_data class_level project comment "Samples excluded augmented with family ids in the plink tfam file"

project_slide_vcounts_trunk=@project.slide.vcounts
file path project_slide_vcounts_tex_file=$project_slide_vcounts_trunk.tex dir project_dir disp ".vcounts.tex" parent cat_project_slide_sites_data class_level project trunk $project_slide_vcounts_trunk comment "Bulk number of variant sites -- tex file"
file path project_slide_vcounts_pdf_file=$project_slide_vcounts_trunk.pdf dir project_dir disp ".vcounts.pdf" parent cat_project_slide_sites_data class_level project comment "Bulk number of variant sites -- pdf file"

project_slide_var_pass_counts_trunk=@project.slide.var.pass.counts
file path project_slide_var_pass_counts_tex_file=$project_slide_var_pass_counts_trunk.tex dir project_dir disp ".var.pass.counts.tex" parent cat_project_slide_sites_data class_level project trunk $project_slide_var_pass_counts_trunk comment "Number of variants passing various filters -- tex file"
file path project_slide_var_pass_counts_pdf_file=$project_slide_var_pass_counts_trunk.pdf dir project_dir disp ".var.pass.counts.pdf" parent cat_project_slide_sites_data class_level project comment "Number of variants passing various filters -- pdf file"

project_slide_sample_var_pass_counts_trunk=@project.slide.sample.var.pass.counts
file path project_slide_sample_var_pass_counts_tex_file=$project_slide_sample_var_pass_counts_trunk.tex dir project_dir disp ".sample.var.pass.counts.tex" parent cat_project_slide_sites_data class_level project trunk $project_slide_sample_var_pass_counts_trunk comment "Number of variants per sample passing various filters -- tex file"
file path project_slide_sample_var_pass_counts_pdf_file=$project_slide_sample_var_pass_counts_trunk.pdf dir project_dir disp ".sample.var.pass.counts.pdf" parent cat_project_slide_sites_data class_level project comment "Number of variants per sample passing various filters -- pdf file"



project_slide_titv_trunk=@project.slide.titv
file path project_slide_titv_tex_file=$project_slide_titv_trunk.tex dir project_dir disp ".titv.tex" parent cat_project_slide_sites_data class_level project trunk $project_slide_titv_trunk comment "Ti/Tv table for variants -- tex file"
file path project_slide_titv_pdf_file=$project_slide_titv_trunk.pdf dir project_dir disp ".titv.pdf" parent cat_project_slide_sites_data class_level project comment "Ti/Tv table for variants -- pdf file"

project_slide_ref_theta_trunk=@project.slide.ref.theta
file path project_slide_ref_theta_tex_file=$project_slide_ref_theta_trunk.tex dir project_dir disp ".ref.theta.tex" parent cat_project_slide_sites_data class_level project trunk $project_slide_ref_theta_trunk comment "Known theta table for variants -- tex file"
file path project_slide_ref_theta_pdf_file=$project_slide_ref_theta_trunk.pdf dir project_dir disp ".ref.theta.pdf" parent cat_project_slide_sites_data class_level project comment "Known theta table for variants -- pdf file"

project_slide_theta_trunk=@project.slide.theta
file path project_slide_theta_tex_file=$project_slide_theta_trunk.tex dir project_dir disp ".theta.tex" parent cat_project_slide_sites_data class_level project trunk $project_slide_theta_trunk comment "Theta table for variants -- tex file"
file path project_slide_theta_pdf_file=$project_slide_theta_trunk.pdf dir project_dir disp ".theta.pdf" parent cat_project_slide_sites_data class_level project comment "Theta table for variants -- pdf file"

minor file path project_slide_master_ps_file=@project.slide.master.ps dir project_dir disp ".ps" parent cat_project_slide_master_data class_level project comment "Master join file of all relevant slides --- ps file"
major file path project_slide_master_pdf_file=@project.slide.master.pdf dir project_dir disp ".pdf" parent cat_project_slide_master_data class_level project comment "Master join file of all relevant slides --- pdf file"

!!expand:,:ext,majmin:tex,minor:pdf,minor! \
majmin file path project_title_slide_ext_file=@project.title.ext dir project_dir disp "title.ext" trunk @project.title parent cat_project_slide_master_data class_level project comment "Master title slide --- ext file"

!!expand:,:ext,majmin:tex,minor:pdf,major! \
majmin file path project_additional_slide_ext_file=@project.additional.ext dir project_dir disp "additional.ext" trunk @project.additional parent cat_project_slide_master_data class_level project comment "Separator for additional slide section --- ext file"

project_slide_failures_trunk=@project.slide.failures
file path project_slide_failures_tex_file=$project_slide_failures_trunk.tex dir project_dir disp ".failures.tex" parent cat_project_slide_coverage_data class_level project trunk $project_slide_failures_trunk comment "Sample failure table -- tex file"
major file path project_slide_failures_pdf_file=$project_slide_failures_trunk.pdf dir project_dir disp ".failures.pdf" parent cat_project_slide_coverage_data class_level project comment "Sample failure table -- pdf file"

!!expand:type:gene:exon:bait! \
project_slide_types_trunk=@project.slide.types
!!expand:,:type,Type:gene,Gene:exon,Exon:bait,Bait! \
file path project_slide_types_tex_file=$project_slide_types_trunk.tex dir project_dir disp ".types.tex" parent cat_project_slide_coverage_data class_level project trunk $project_slide_types_trunk comment "Type coverage table -- tex file"

!!expand:type:gene:exon:bait! \
file path project_slide_types_pdf_file=$project_slide_types_trunk.pdf dir project_dir disp ".types.pdf" parent cat_project_slide_coverage_data class_level project comment "Type coverage table -- pdf file"

file path project_slide_sstats_initial_pdf_file=@project.slide.sstats.initial.pdf dir project_dir disp ".initial.pdf" parent cat_project_slide_qc_ind_hist_data class_level project comment "Shows all sample metrics that ultimately went into filtering out samples --- hist plot"

file path project_slide_sstats_highlighted_pdf_file=@project.slide.sstats.highlighted.pdf dir project_dir disp ".highlighted.pdf" parent cat_project_slide_qc_ind_hist_data class_level project comment "Shows all sample metrics that ultimately went into filtering out samples, with samples excluded based on each metric separately highlighted --- hist plot"

file path project_slide_sstats_final_pdf_file=@project.slide.sstats.final.pdf dir project_dir disp ".final.pdf" parent cat_project_slide_qc_ind_hist_data class_level project comment "Shows all sample metrics that ultimately went into filtering out samples, with only passed samples present --- plot"

file path project_slide_sstats_extreme_pdf_file=@project.slide.sstats.extreme.pdf dir project_dir disp ".extreme.pdf" parent cat_project_slide_qc_ind_hist_data class_level project comment "Shows select sample metrics, with only passed samples present --- extremes highlighted"

!!expand:type:seq! \
project_slide_type_qc_failures_trunk=@project.slide.type.qc_failures

!!expand:type:seq! \
file path project_slide_type_qc_failures_tex_file=$project_slide_type_qc_failures_trunk.tex dir project_dir disp ".type.failures.tex" parent cat_project_slide_qc_ind_minus_data class_level project trunk $project_slide_type_qc_failures_trunk comment "Sample type qc failure table -- tex file"

!!expand:type:seq! \
file path project_slide_type_qc_failures_pdf_file=$project_slide_type_qc_failures_trunk.pdf dir project_dir disp ".type.failures.pdf" parent cat_project_slide_qc_ind_minus_data class_level project comment "Sample type qc failure table -- pdf file"

project_slide_var_qc_failures_trunk=@project.slide.var.qc_failures
file path project_slide_var_qc_failures_tex_file=$project_slide_var_qc_failures_trunk.tex dir project_dir disp ".failures.tex" parent cat_project_slide_qc_var_data class_level project trunk $project_slide_var_qc_failures_trunk comment "Variant qc failure table -- tex file"
file path project_slide_var_qc_failures_pdf_file=$project_slide_var_qc_failures_trunk.pdf dir project_dir disp ".failures.pdf" parent cat_project_slide_qc_var_data class_level project comment "Variant qc failure table -- pdf file"


!!expand:project:project:project_variant_subset! \
!!expand:,:maskkey,masktype,maskdescrip:all,,all:syn,syn.,synonymous:ns,ns.,non-synonymous:nonsense,nonsense.,nonsense:noncoding,noncoding.,noncoding! \
!!expand:,:tname,description:raw,were called:qc_pass,pass filters:qc_plus,pass QC! \ 
table nohead file path project_tname_maskkey_vcounts_file=@project.tname.masktypevcounts dir project_dir disp ".tname.masktypevcounts" parent cat_project_tname_var_stats_data class_level project comment "Dumped by pseq v-stats using maskdescrip variants that description"

!!expand:,:maskkey,masktype,maskdescrip:all,,all:syn,syn.,synonymous:ns,ns.,non-synonymous:nonsense,nonsense.,nonsense:noncoding,noncoding.,noncoding! \

!!expand:project:project:project_variant_subset! \
!!expand:,:tname,description:qc_plus,pass QC! \ 
!!expand:,:tstrat,tdescrip:all,over all samples:strata,stratified by maf_strata_trait! \ 
table nohead file path project_tname_annotated_tstrat_pre_vcounts_file=@project.tname.annotated.tstrat.pre.vcounts dir project_dir disp ".tname.annotated.tstrat.pre.vcounts" parent cat_project_tname_var_stats_data class_level project comment "Helper file for the number of variants that description for each annotation tdescrip"

!!expand:project:project:project_variant_subset! \
!!expand:,:tname,description:qc_plus,pass QC! \ 
!!expand:,:tstrat,tdescrip:all,over all samples:strata,stratified by maf_strata_trait! \ 
table nohead file path project_tname_annotated_tstrat_vcounts_file=@project.tname.annotated.tstrat.vcounts dir project_dir disp ".tname.annotated.tstrat.vcounts" parent cat_project_tname_var_stats_data class_level project comment "The number of variants that description for each annotation tdescrip"

!!expand:project:project:project_variant_subset! \
!!expand:,:tname,description:qc_plus,pass QC! \ 
!!expand:,:tstrat,tdescrip:all,over all samples:strata,stratified by maf_strata_trait! \ 
table nohead file path project_tname_annotated_tstrat_sample_vcounts_file=@project.tname.annotated.tstrat.sample.vcounts dir project_dir disp ".tname.annotated.tstrat.sample.vcounts" parent cat_project_tname_var_stats_data class_level project comment "The number of variants per sample that description for each annotation tdescrip"

!!expand:project:project:project_variant_subset! \
table file path project_mean_alt_gq_file=@project.mean_alt_gq.dat dir project_dir disp ".mean_alt_gq.dat" parent cat_project_qc_var_stats_data class_level project comment "Mean GQ at alternate calls"

!!expand:meta:gq:dp! \
!!expand:project:project:project_variant_subset! \
table file path project_mean_meta_file=@project.mean_meta.dat dir project_dir disp ".mean_meta.dat" parent cat_project_qc_var_stats_data class_level project comment "Mean GQ "

!!expand:project:project:project_variant_subset! \
table file path project_dev_dp_file=@project.dev_dp.dat dir project_dir disp ".dev_dp.dat" parent cat_project_qc_var_stats_data class_level project comment "Dev GQ"

!!expand:project:project:project_variant_subset! \
table file path project_vstats_file=@project.vstats dir project_dir disp ".vstats" parent cat_project_qc_var_stats_data class_level project comment "All relevant variant statistics"

!!expand:project:project:project_variant_subset! \
table file path project_extended_vstats_file=@project.extended.vstats dir project_dir disp ".extended.vstats" parent cat_project_qc_var_stats_data class_level project comment "All relevant variant statistics"

!!expand:,:typeu,typed:,:snps_,snps.:indels_,indels.:multiallelics_,multiallelics.! \
!!expand:project:project:project_variant_subset! \
table file path project_typeuvfreq_file=@project.typedvfreq dir project_dir disp ".typedvfreq" parent cat_project_qc_var_stats_data class_level project comment "Dumped by pseq vfreq; descript"

#!!expand:project:project:project_variant_subset! \
#table file path project_vfreq_file=@project.vfreq dir project_dir disp ".vfreq" parent cat_project_qc_var_stats_data class_level project comment "Dumped by pseq vfreq; descript"

table file path project_custom_vstats_annot_file=@project.custom.vstats.annot dir project_dir disp ".custom.vstats.annot" parent cat_project_qc_var_stats_data class_level project comment "Custom file to use to add annotations to vstats"

major table file path project_variant_outlier_file=@project.variant.outliers.csv dir project_dir disp ".outliers.csv" parent cat_project_qc_var_stats_data class_level project comment "Outlier values from all variant statistics"

table file path project_variant_exclude_detail_file=@project.variant.exclude.detail dir project_dir disp ".variant.exclude.detail" parent cat_project_qc_var_exclude_data class_level project comment "Variants excluded because they are outliers on one or more measures --- with information about the metrics that caused them to fail"

file path project_variant_custom_exclude_file=@project.variant.custom.exclude dir project_dir disp ".variant.custom.exclude" parent cat_project_qc_var_exclude_data class_level project comment "Specify a file with (additional) custom exclusions"

file path project_variant_exclude_file=@project.variant.exclude dir project_dir disp ".variant.exclude" parent cat_project_qc_var_exclude_data class_level project comment "Variants excluded because they are outliers on one or more measures"

table file path project_extended_variant_exclude_detail_file=@project.extended.variant.exclude.detail dir project_dir disp ".extended.variant.exclude.detail" parent cat_project_qc_var_exclude_data class_level project comment "Variants excluded because they are outliers on one or more measures --- with information about the metrics that caused them to fail (extended filters)"

file path project_extended_variant_custom_exclude_file=@project.extended.variant.custom.exclude dir project_dir disp ".extended.variant.custom.exclude" parent cat_project_qc_var_exclude_data class_level project comment "Specify a file with (additional) custom extended exclusions"

file path project_extended_variant_exclude_file=@project.extended.variant.exclude dir project_dir disp ".extended.variant.exclude" parent cat_project_qc_var_exclude_data class_level project comment "Variants excluded because they are outliers on one or more measures (extended filters)"

table file path project_extended_strict_variant_exclude_detail_file=@project.extended.strict.variant.exclude.detail dir project_dir disp ".extended.strict.variant.exclude.detail" parent cat_project_qc_var_exclude_data class_level project comment "Variants excluded because they are outliers on one or more measures --- with information about the metrics that caused them to fail (extended strict filters)"

file path project_extended_strict_variant_custom_exclude_file=@project.extended.strict.variant.custom.exclude dir project_dir disp ".extended.strict.variant.custom.exclude" parent cat_project_qc_var_exclude_data class_level project comment "Specify a file with (additional) custom extended strict exclusions"

file path project_extended_strict_variant_exclude_file=@project.extended.strict.variant.exclude dir project_dir disp ".extended.strict.variant.exclude" parent cat_project_qc_var_exclude_data class_level project comment "Variants excluded because they are outliers on one or more measures (extended strict filters)"


!!expand:project:project:project_merge_subset! \
file path project_snp_indel_overlap_file=@project.snp.indel.overlap dir project_dir disp ".snp.indel.overlap" parent cat_project_all_variant_call_data class_level project comment "Variant positions that are both SNPs and indels"

!!expand:,:_vstats,.vstats:_vstats,.vstats:_extended_vstats,.extended.vstats! \
major file path project_vstats_initial_pdf_file=@project.vstats.initial.pdf dir project_dir disp ".initial.pdf" parent cat_project_qc_var_plots_data class_level project comment "Plot of various variant metrics across all variants --- hist plots"
!!expand:,:_vstats,.vstats:_vstats,.vstats:_extended_vstats,.extended.vstats! \
major file path project_vstats_highlighted_pdf_file=@project.vstats.highlighted.pdf dir project_dir disp ".highlighted.pdf" parent cat_project_qc_var_plots_data class_level project comment "Plot of various variant metrics across all variants with outlier variants highlighted --- hist plots"
!!expand:,:_vstats,.vstats:_vstats,.vstats:_extended_vstats,.extended.vstats! \
major file path project_vstats_final_pdf_file=@project.vstats.final.pdf dir project_dir disp ".final.pdf" parent cat_project_qc_var_plots_data class_level project comment "Plot of various variant metrics across all variants with outlier variants removed --- hist plots"

file table path project_plinkseq_gene_locstats_file=@project.locstats dir project_dir disp ".locstats" parent cat_project_qc_gene_stats_data class_level project comment "Dumped by Plink/Seq loc-stats"

file table path project_plinkseq_exon_locstats_file=@project.exon.locstats dir project_dir disp ".exon.locstats" parent cat_project_qc_gene_stats_data class_level project comment "Dumped by Plink/Seq loc-stats"

!!expand:,:vartype,ext:,:_syn,.syn:_ns,.ns! \
!!expand:,:stattype,dtype:gstats,genes:estats,exons! \
!!expand:project:project:project_variant_subset:pheno:pheno_variant_subset! \
file table path project_plinkseq_qc_passvartype_stattype_file=@project.qc_passext.stattype dir project_dir disp ".qc_passext.stattype" parent cat_project_qc_gene_stats_data class_level project comment "Dumped by Plink/Seq dtype g-stats on qc pass variants"

!!expand:project:project:project_variant_subset! \
file table path project_plinkseq_filtered_gstats_file=@project.filtered.gstats dir project_dir disp ".filtered.gstats" parent cat_project_qc_gene_stats_data class_level project comment "Dumped by Plink/Seq g-stats; uses only qc fail variants"

file table path project_gstats_file=@project.gstats dir project_dir disp ".gstats" parent cat_project_qc_gene_stats_data class_level project comment "All metrics for genes in project"

major table file path project_gene_outlier_file=@project.gene.outliers.csv dir project_dir disp ".outliers.csv" parent cat_project_qc_gene_stats_data class_level project comment "Outlier values from all gne statistics"

table file path project_gene_exclude_detail_file=@project.gene.exclude.detail dir project_dir disp ".gene.exclude.detail" parent cat_project_qc_gene_stats_data class_level project comment "Genes that are outliers on one or more measures --- with information about the metrics that caused them to fail"

major file path project_gstats_pdf_file=@project.gstats.pdf dir project_dir disp ".pdf" parent cat_project_qc_gene_plots_data class_level project comment "Plot of various gene metrics across all genes --- hist plot"
major file path project_gstats_highlighted_pdf_file=@project.gstats.highlighted.pdf dir project_dir disp ".highlighted.pdf" parent cat_project_qc_gene_plots_data class_level project comment "Plot of various variant metrics across all genes with outlier genes highlighted --- hist plot"

major file path project_gene_gc_pdf_file=@project.gene.gc.pdf dir project_dir disp ".pdf" parent cat_project_qc_gene_gc_plots_data class_level project comment "Plot of various gene metrics as a function of GC content"

#qc filter properties
major table file path sample_qc_filter_trait_exclude_file=@project.@sample_qc_filter.trait.exclude dir project_dir disp ".trait.exclude" parent cat_sample_qc_filter_trait_data class_level sample_qc_filter comment "Filter samples based on a trait"

major table file path sample_qc_filter_metric_exclude_file=@project.@sample_qc_filter.sstats.exclude dir project_dir disp ".metric.exclude" parent cat_sample_qc_filter_metric_data class_level sample_qc_filter comment "Filter samples based on a metric"

major table file path sample_qc_filter_exclude_file=@project.@sample_qc_filter.exclude dir project_dir disp ".exclude" parent cat_sample_qc_filter_metric_data class_level sample_qc_filter comment "Filter samples based on intersection of metrics"


major table file path var_qc_filter_exclude_file=@project.@var_qc_filter.exclude dir project_dir disp ".exclude" parent cat_var_qc_filter_data class_level var_qc_filter comment "Filter variants based on intersection of metrics"

major table file path var_qc_filter_modifier_exclude_file=@project.@var_qc_filter.modifier.exclude dir project_dir disp ".modifier.exclude" parent cat_var_qc_filter_data class_level var_qc_filter comment "Restricted list of variants to intersect with var_qc_filter_exclude_file"

major table file path annot_var_qc_filter_exclude_file=@annot.@annot_var_qc_filter.exclude dir annot_dir disp ".exclude" parent cat_annot_var_qc_filter_data class_level annot_var_qc_filter comment "Filter variants based on intersection of metrics"

#files to compute variant QC metrics (potentially) stratified by a separate trait

!!expand:pheno_variant_qc_strata:pheno_variant_qc_strata:pheno_variant_qc_pheno_strata! \
major table file path pheno_variant_qc_strata_sample_include_file=@pheno.@pheno_variant_qc_strata.sample.include dir pheno_variant_qc_stratas_dir disp ".sample.include" parent cat_pheno_variant_qc_strata_data class_level pheno_variant_qc_strata comment "Samples to run variant metrics on (plink include file)"

meta_table file path pheno_variant_qc_strata_pheno_variant_qc_strata_variant_subset_meta_file=@pheno.@pheno_variant_qc_strata.variant_subset.meta dir pheno_variant_qc_stratas_dir disp ".variant_subset.meta" parent cat_pheno_variant_qc_strata_data class_level pheno_variant_qc_strata comment "Load in variant subsets" meta_level pheno_variant_qc_strata_variant_subset

major table file path pheno_variant_qc_pheno_strata_sample_phe_file=@pheno.@pheno_variant_qc_pheno_strata.sample.phe dir pheno_variant_qc_pheno_stratas_dir disp ".sample.phe" parent cat_pheno_variant_qc_pheno_strata_data class_level pheno_variant_qc_pheno_strata comment "Samples to run variant metrics on (plink include file), with phenotype"

meta_table file path pheno_variant_qc_pheno_strata_pheno_variant_qc_pheno_strata_variant_subset_meta_file=@pheno.@pheno_variant_qc_pheno_strata.variant_subset.meta dir pheno_variant_qc_pheno_stratas_dir disp ".variant_subset.meta" parent cat_pheno_variant_qc_pheno_strata_data class_level pheno_variant_qc_pheno_strata comment "Load in variant subsets" meta_level pheno_variant_qc_pheno_strata_variant_subset

!!expand:pheno_variant_qc_strata:pheno_variant_qc_strata:pheno_variant_qc_strata_variant_subset! \
!!expand:type:lmiss:hwe:frq:het! \
major table file path pheno_variant_qc_strata_type_file=@pheno.@pheno_variant_qc_strata.type dir pheno_variant_qc_stratas_dir disp ".type" parent cat_pheno_variant_qc_strata_data class_level pheno_variant_qc_strata comment "Output of --type command"

!!expand:pheno_variant_qc_strata:pheno_variant_qc_strata:pheno_variant_qc_strata_variant_subset! \
!!expand:type:lmiss:hwe:frq:het! \
major table file path pheno_variant_qc_strata_type_log_file=@pheno.@pheno_variant_qc_strata.type.log dir pheno_variant_qc_stratas_dir disp ".type.log" parent cat_pheno_variant_qc_strata_data class_level pheno_variant_qc_strata comment "Log file for output of --type command"

!!expand:pheno_variant_qc_strata:pheno_variant_qc_strata:pheno_variant_qc_strata_variant_subset! \
!!expand:type:lmiss! \
major table file path pheno_variant_qc_strata_unthresholded_type_file=@pheno.@pheno_variant_qc_strata.unthresholded.type dir pheno_variant_qc_stratas_dir disp ".unthresholded.type" parent cat_pheno_variant_qc_strata_data class_level pheno_variant_qc_strata comment "Output of --type command on unthresholded PLINK file"

!!expand:pheno_variant_qc_strata:pheno_variant_qc_strata:pheno_variant_qc_strata_variant_subset! \
!!expand:type:lmiss! \
major table file path pheno_variant_qc_strata_unthresholded_type_log_file=@pheno.@pheno_variant_qc_strata.unthresholded.type.log dir pheno_variant_qc_stratas_dir disp ".unthresholded.type.log" parent cat_pheno_variant_qc_strata_data class_level pheno_variant_qc_strata comment "Log file for output of --type command on unthresholded PLINK file"

!!expand:,:_unthresholded,.unthresholded:_unthresholded,.unthresholded:,! \
!!expand:pheno_variant_qc_strata:pheno_variant_qc_strata:pheno_variant_qc_strata_variant_subset! \
major table file path pheno_variant_qc_strata_multiallelic_unthresholded_stats_file=@pheno.@pheno_variant_qc_strata.multiallelic.unthresholded.stats dir pheno_variant_qc_stratas_dir disp ".unthresholded.multiallelic.stats" parent cat_pheno_variant_qc_strata_data class_level pheno_variant_qc_strata comment "Statistics on multiallelics"

!!expand:pheno_variant_qc_strata:pheno_variant_qc_strata:pheno_variant_qc_strata_variant_subset! \
major table file path pheno_variant_qc_strata_vstats_file=@pheno.@pheno_variant_qc_strata.vstats dir pheno_variant_qc_stratas_dir disp ".vstats" parent cat_pheno_variant_qc_strata_data class_level pheno_variant_qc_strata comment "Summary of variant stats"

!!expand:pheno_variant_qc_pheno_strata:pheno_variant_qc_pheno_strata:pheno_variant_qc_pheno_strata_variant_subset! \
!!expand:type:p_missing! \
major table file path pheno_variant_qc_pheno_strata_type_file=@pheno.@pheno_variant_qc_pheno_strata.type dir pheno_variant_qc_pheno_stratas_dir disp ".type" parent cat_pheno_variant_qc_pheno_strata_data class_level pheno_variant_qc_pheno_strata comment "Output of --type command"

!!expand:pheno_variant_qc_pheno_strata:pheno_variant_qc_pheno_strata:pheno_variant_qc_pheno_strata_variant_subset! \
!!expand:type:p_missing! \
major table file path pheno_variant_qc_pheno_strata_type_log_file=@pheno.@pheno_variant_qc_pheno_strata.type.log dir pheno_variant_qc_pheno_stratas_dir disp ".type.log" parent cat_pheno_variant_qc_pheno_strata_data class_level pheno_variant_qc_pheno_strata comment "Log file for output of --type command"

!!expand:pheno_variant_qc_pheno_strata:pheno_variant_qc_pheno_strata:pheno_variant_qc_pheno_strata_variant_subset! \
!!expand:type:p_missing! \
major table file path pheno_variant_qc_pheno_strata_unthresholded_type_file=@pheno.@pheno_variant_qc_pheno_strata.unthresholded.type dir pheno_variant_qc_pheno_stratas_dir disp ".unthresholded.type" parent cat_pheno_variant_qc_pheno_strata_data class_level pheno_variant_qc_pheno_strata comment "Output of --type command on unthresholded PLINK file"
!!expand:pheno_variant_qc_pheno_strata:pheno_variant_qc_pheno_strata:pheno_variant_qc_pheno_strata_variant_subset! \
!!expand:type:p_missing! \
major table file path pheno_variant_qc_pheno_strata_unthresholded_type_log_file=@pheno.@pheno_variant_qc_pheno_strata.unthresholded.type.log dir pheno_variant_qc_pheno_stratas_dir disp ".unthresholded.type.log" parent cat_pheno_variant_qc_pheno_strata_data class_level pheno_variant_qc_pheno_strata comment "Log file for output of --type command for unthresholded file"

!!expand:,:_unthresholded,.unthresholded:_unthresholded,.unthresholded:,! \
!!expand:pheno_variant_qc_pheno_strata:pheno_variant_qc_pheno_strata:pheno_variant_qc_pheno_strata_variant_subset! \
major table file path pheno_variant_qc_pheno_strata_multiallelic_unthresholded_stats_file=@pheno.@pheno_variant_qc_pheno_strata.multiallelic.unthresholded.stats dir pheno_variant_qc_pheno_stratas_dir disp ".unthresholded.multiallelic.stats" parent cat_pheno_variant_qc_pheno_strata_data class_level pheno_variant_qc_pheno_strata comment "Additional statistics on multiallelics"

!!expand:pheno_variant_qc_pheno_strata:pheno_variant_qc_pheno_strata:pheno_variant_qc_pheno_strata_variant_subset! \
major table file path pheno_variant_qc_pheno_strata_vstats_file=@pheno.@pheno_variant_qc_pheno_strata.vstats dir pheno_variant_qc_pheno_stratas_dir disp ".vstats" parent cat_pheno_variant_qc_pheno_strata_data class_level pheno_variant_qc_pheno_strata comment "Summary of variant stats"

major table file path pheno_qc_filter_trait_exclude_file=@pheno.@pheno_qc_filter.trait.exclude dir pheno_dir disp ".trait.exclude" parent cat_pheno_qc_filter_trait_data class_level pheno_qc_filter comment "Filter samples at pheno level based on a trait"

major table file path pheno_qc_filter_metric_exclude_file=@pheno.@pheno_qc_filter.sstats.exclude dir pheno_dir disp ".metric.exclude" parent cat_pheno_qc_filter_metric_data class_level pheno_qc_filter comment "Filter samples at pheno level based on a metric"

major table file path pheno_qc_filter_exclude_file=@pheno.@pheno_qc_filter.exclude dir pheno_dir disp ".exclude" parent cat_pheno_qc_filter_metric_data class_level pheno_qc_filter comment "Filter samples at pheno level based on intersection of metrics"

!!expand:marker:marker:marker_variant_subset! \
marker_initial_plink_file=@marker.initial dir marker_dir class_level marker
!!expand:,:ext:bed:bim:fam! \
file path marker_initial_ext_file=$marker_initial_plink_file.ext dir marker_dir disp ".initial.ext" parent cat_marker_initial_all_genotype_data class_level marker comment "Marker ext file: specified by user"

file path marker_sample_keep_file=$marker_initial_plink_file.keep dir marker_dir disp ".keep" parent cat_marker_initial_all_genotype_data class_level marker comment "Samples to keep for any use of marker file"
file path marker_snp_exclude_file=$marker_initial_plink_file.exclude dir marker_dir disp ".exclude" parent cat_marker_initial_all_genotype_data class_level marker comment "SNPs to exclude for any use of marker file"

!!expand:marker:marker:marker_variant_subset! \
marker_initial_filtered_plink_file=@marker.initial.filtered dir marker_dir class_level marker
!!expand:,:ext:bed:bim:fam! \
file path marker_initial_filtered_ext_file=$marker_initial_filtered_plink_file.ext dir marker_dir disp ".initial.ext" parent cat_marker_initial_all_genotype_data class_level marker comment "Marker ext file: after any custom filters; used in analyses downstream"
file path marker_initial_filtered_make_bed_log_file=$marker_initial_filtered_plink_file.make_bed.log dir marker_dir disp ".make_bed.log" parent cat_marker_initial_all_genotype_data class_level marker comment "Log file for make bed"

file path marker_strand_discordant_file=$marker_initial_filtered_plink_file.strand.discordant dir marker_dir disp ".strand.discordant" parent cat_marker_initial_all_genotype_data class_level marker comment "SNPs that have discordant alelles between sequence data and marker data"
file path marker_project_non_overlap_file=$marker_initial_filtered_plink_file.project.non_overlap dir marker_dir disp ".project.non_overlap" parent cat_marker_initial_all_genotype_data class_level marker comment "SNPs that are not present in the project VCF file --- used for efficient site discordance checking"
file path marker_initial_corrected_bim_file=$marker_initial_filtered_plink_file.corrected.bim dir marker_dir disp ".initial.corrected.bim" parent cat_marker_initial_all_genotype_data class_level marker comment "Initial marker bim file, with strand corrected to match sequence data"
!!expand:marker:marker:marker_variant_subset! \
file path marker_initial_diff_file=$marker_initial_filtered_plink_file.diff dir marker_dir disp ".diff" parent cat_marker_concordance_data class_level marker comment "Discordant genotypes between sequence and marker"
!!expand:marker:marker:marker_variant_subset! \
file path marker_initial_diff_log_file=$marker_initial_filtered_plink_file.diff.log dir marker_dir disp ".diff.log" parent cat_marker_concordance_data class_level marker comment "Log file for diff cmd"
!!expand:marker:marker:marker_variant_subset! \
file path marker_initial_snp_pct_discordant_file=$marker_initial_filtered_plink_file.snp.pct_discordant dir marker_dir disp ".snp.pct_discordant" parent cat_marker_concordance_data class_level marker comment "For each SNP, list of fraction samples discordant between marker and seq"
file path marker_snp_discordant_file=$marker_initial_filtered_plink_file.snp.discordant dir marker_dir disp ".snp.discordant" parent cat_marker_initial_all_genotype_data class_level marker comment "SNPs that have high discordances between marker and seq data"
file path marker_snp_flipped_file=$marker_initial_filtered_plink_file.snp.flipped dir marker_dir disp ".snp.flipped" parent cat_marker_initial_all_genotype_data class_level marker comment "SNPs that appear to be flipped (discordances near zero)"
file path marker_initial_snp_corrected_bim_file=$marker_initial_filtered_plink_file.snp_corrected.bim dir marker_dir disp ".initial.snp_corrected.bim" parent cat_marker_initial_all_genotype_data class_level marker comment "Initial marker bim file, with SNPs corrected to reduce seq/marker discordances"
marker_filtered_plink_file=@marker.filtered dir marker_dir class_level marker
!!expand:,:ext:bed:bim:fam! \
file path marker_filtered_ext_file=$marker_filtered_plink_file.ext dir marker_dir disp ".filtered.ext" parent cat_marker_filtered_all_genotype_data class_level marker comment "Filtered marker ext file"
file path marker_filtered_make_bed_log_file=$marker_filtered_plink_file.make_bed.log dir marker_dir disp ".make_bed.log" parent cat_marker_filtered_all_genotype_data class_level marker comment "Log file for make bed cmd"
file path marker_project_sample_include_file=@marker.project.sample.list dir marker_dir disp ".project.sample.list" parent cat_marker_sample_genotype_data class_level marker comment "List of marker samples in the project who are also in sample keep file"

file path marker_filtered_frq_file=$marker_filtered_plink_file.frq dir marker_dir disp ".filtered.frq" parent cat_marker_filtered_all_genotype_data class_level marker comment "Filtered marker frq file"
file path marker_filtered_frq_log_file=$marker_filtered_plink_file.frq.log dir marker_dir disp ".frq.log" parent cat_marker_filtered_all_genotype_data class_level marker comment "Log file for frq cmd"

marker_filtered_for_merge_plink_file=@marker.filtered.for_merge dir marker_dir class_level marker
file path marker_filtered_for_merge_exclude_file=$marker_filtered_for_merge_plink_file.exclude dir marker_dir disp ".filtered.for_merge.exclude" parent cat_marker_filtered_for_merge_all_genotype_data class_level marker comment "SNPs to remove for merging (SNPs with contrasting alleles removed)"
file path marker_filtered_for_merge_initial_bim_file=$marker_filtered_for_merge_plink_file.initial.bim dir marker_dir disp ".initial.bim" parent cat_marker_filtered_for_merge_all_genotype_data class_level marker comment "Same SNPs as filtered, but with IDs/ref/alt adjusted"

!!expand:,:ext:bed:bim:fam! \
file path marker_filtered_for_merge_ext_file=$marker_filtered_for_merge_plink_file.ext dir marker_dir disp ".filtered.for_merge.ext" parent cat_marker_filtered_for_merge_all_genotype_data class_level marker comment "Filtered marker ext file (for merging: ambiguous SNPs removed)"
file path marker_filtered_for_merge_make_bed_log_file=$marker_filtered_for_merge_plink_file.make_bed.log dir marker_dir disp ".make_bed.log" parent cat_marker_filtered_for_merge_all_genotype_data class_level marker comment "Log file for make bed cmd"

#file path marker_filtered_for_merge_ld_file=$marker_filtered_for_merge_plink_file.ld dir marker_dir disp ".filtered.for_merge.ld" parent cat_marker_filtered_for_merge_all_genotype_data class_level marker comment "Filtered marker ld file"
#file path marker_filtered_for_merge_ld_log_file=$marker_filtered_for_merge_plink_file.ld.log dir marker_dir disp ".ld.log" parent cat_marker_filtered_for_merge_all_genotype_data class_level marker comment "Log file for ld cmd"

marker_sample_strand_filtered_overlap_plink_file=@marker.sample.strand.filtered.overlap dir marker_dir class_level marker
!!expand:,:ext:bed:bim:fam! \
file path marker_sample_strand_filtered_overlap_ext_file=$marker_sample_strand_filtered_overlap_plink_file.ext dir marker_dir disp ".sample.strand.filtered.overlap.ext" parent cat_marker_sample_genotype_data class_level marker comment "Plink marker ext file for project samples; removed discordant strand SNPs"
file path marker_sample_strand_filtered_overlap_make_bed_log_file=$marker_sample_strand_filtered_overlap_plink_file.make_bed.log dir marker_dir disp ".make_bed.log" parent cat_marker_sample_genotype_data class_level marker comment "Log file for make bed cmd"
!!expand:marker:marker:marker_variant_subset! \

marker_sample_filtered_plink_file=@marker.sample.filtered dir marker_dir class_level marker
file path marker_sample_filtered_snp_include_file=$marker_sample_filtered_plink_file.snp.include dir marker_dir disp ".sample.filtered.snp.include" parent cat_marker_sample_genotype_data class_level marker comment "List of SNPs to go into making VCF file"
file path marker_sample_filtered_vcf_file=$marker_sample_filtered_plink_file.vcf dir marker_dir disp ".sample.filtered.vcf" parent cat_marker_sample_genotype_data class_level marker comment "Filtered marker VCF file for project samples only; removed discordant strand SNPs and discordant SNPs"
file path marker_sample_filtered_recode_vcf_log_file=$marker_sample_filtered_plink_file.recode_vcf.log dir marker_dir disp ".sample.recode_vcf.log" parent cat_marker_sample_genotype_data class_level marker comment "Log file for recode vcf cmd for project samples only"
file path marker_sample_filtered_fixed_vcf_file=$marker_sample_filtered_plink_file.fixed.vcf dir marker_dir disp ".sample.filtered.fixed.vcf" parent cat_marker_sample_genotype_data class_level marker comment "Fixed IDs in VCF file"
!!expand:marker:marker:marker_sample_subset! \
major file path marker_positive_control_eval_file=@marker.positive_control.eval dir marker_dir disp ".eval" parent cat_marker_concordance_data class_level marker comment "Eval statistics on calls"

table file path marker_positive_control_genotype_concordance_file=@marker.positive_control.genotype.concordance.csv dir marker_dir disp ".csv" parent cat_marker_concordance_data class_level marker comment "Reformatted plink diff file"

marker_positive_control_genotype_concordance_sum_trunk=@marker.positive_control.genotype.marker.sum

file path marker_positive_control_genotype_concordance_sum_tex_file=$marker_positive_control_genotype_concordance_sum_trunk.tex dir marker_dir disp ".sum.tex" parent cat_marker_concordance_data trunk $marker_positive_control_genotype_concordance_sum_trunk class_level marker comment "Summary of overall marker for all samples --- tex file"

major file path marker_positive_control_genotype_concordance_sum_pdf_file=$marker_positive_control_genotype_concordance_sum_trunk.pdf dir marker_dir disp ".sum.pdf" parent cat_marker_concordance_data class_level marker comment "Summary of overall marker for all samples --- pdf file"

table file path marker_sample_concordance_file=@marker.sample.concordance.tsv dir marker_dir disp ".concordance.tsv" parent cat_marker_concordance_data class_level marker comment "Overall concordance for each sample"

table file path marker_sample_full_concordance_file=@marker.sample.full.marker.tsv dir marker_dir disp ".full.concordance.tsv" parent cat_marker_concordance_data class_level marker comment "Concordance for all samples --- NA inserted for those missing"

table nohead file path marker_sample_exclude_detail_file=@marker.sample.exclude.detail dir marker_dir disp ".sample.exclude.detail" parent cat_marker_concordance_data class_level marker comment "Samples excluded due to low concordances"

!!expand:stype:sample:variant! \
meta_table file path marker_marker_stype_subset_meta_file=@marker.marker_stype_subset.meta dir marker_dir disp ".marker_stype_subset.meta" parent cat_marker_meta_data class_level marker comment "Meta file to load in marker_stype_subsets" meta_level marker_stype_subset

!!expand:,:project,type:project,all:project,sample:project_sample_subset,sample:project,extra! \
project_type_marker_plink_file=@project.type.marker dir project_dir class_level project

file path project_all_marker_all_merge_list_file=@project.all.marker.all.merge.list dir project_dir disp ".all.merge.list" parent cat_project_plink_all_marker_meta_data class_level project comment "List of all marker files"

file path project_all_marker_plink_list_file=@project.all.marker.plink.list dir project_dir disp ".plink.list" parent cat_project_plink_all_marker_meta_data class_level project comment "List of plink trunks of marker files for merging --- have this to make sure the first file passed into the merge is always the first file in the merge list"

file path project_all_marker_merge_list_file=@project.all.marker.merge.list dir project_dir disp ".merge.list" parent cat_project_plink_all_marker_meta_data class_level project comment "List of marker files for merging"

!!expand:,:type,description:all,all:sample,project:extra,non-project! \
!!expand:,:fileext:bed:bim:fam! \
file path project_type_marker_fileext_file=$project_type_marker_plink_file.fileext dir project_dir disp ".fileext" parent cat_project_plink_type_marker_ped_data class_level project comment "Marker fileext file for description samples"

!!expand:,:type:all:sample:extra! \
file path project_type_marker_make_bed_log_file=$project_type_marker_plink_file.make_bed.log dir project_dir disp ".make_bed.log" parent cat_project_plink_type_marker_ped_data class_level project comment "Log file for make bed cmd"

project_extra_marker_pruned_plink_file=@project.extra.marker.pruned dir project_dir class_level project

!!expand:,:fileext:bed:bim:fam! \
file path project_extra_marker_pruned_fileext_file=$project_extra_marker_pruned_plink_file.fileext dir project_dir disp ".fileext" parent cat_project_plink_extra_marker_ped_data class_level project comment "Ready for merging for for_pca file (if add_for_pca)"

file path project_extra_marker_pruned_make_bed_log_file=$project_extra_marker_pruned_plink_file.make_bed.log dir project_dir disp ".make_bed.log" parent cat_project_plink_extra_marker_ped_data class_level project comment "Log file for make bed cmd"

#file path project_all_marker_ld_file=$project_all_marker_plink_file.ld dir project_dir disp ".ld" parent cat_project_plink_all_marker_meta_data class_level project comment "R2 values for all marker SNPs after merge"
#file path project_all_marker_ld_log_file=$project_all_marker_plink_file.ld.log dir project_dir disp ".ld.log" parent cat_project_plink_all_marker_meta_data class_level project comment "Log file for R2 calculation"

project_sample_marker_pruned_plink_file=@project.sample.marker.pruned dir project_dir class_level project
!!expand:,:fileext:bed:bim:fam! \
file path project_sample_marker_pruned_fileext_file=$project_sample_marker_pruned_plink_file.fileext dir project_dir disp ".pruned.fileext" parent cat_project_plink_sample_marker_pruned_ped_data class_level project comment "Marker fileext file for project samples, LD pruned"

file path project_sample_marker_pruned_make_bed_log_file=$project_sample_marker_plink_file.pruned.make_bed.log dir project_dir disp ".pruned.make_bed.log" parent cat_project_plink_sample_marker_pruned_ped_data class_level project comment "Log file for make bed cmd"

!!expand:,:keyt,extt,descript:initial_,initial.,-- individuals not necessarily sorted:,,! \
file path project_sample_marker_pruned_keytvcf_file=$project_sample_marker_pruned_plink_file.exttvcf.gz dir project_dir disp ".pruned.exttvcf.gz" parent cat_project_plink_sample_marker_pruned_ped_data class_level project comment "Marker vcf file for project samples, LD pruned descript"

file path project_sample_marker_pruned_recode_vcf_log_file=$project_sample_marker_pruned_plink_file.pruned.recode_vcf.log dir project_dir disp ".pruned.recode_vcf.log" parent cat_project_plink_sample_marker_pruned_ped_data class_level project comment "Log file for make bed cmd"

project_sample_for_pca_plink_file=@project.sample.for.pca dir project_dir class_level project

!!expand:,:fileext:bed:bim:fam! \
file path project_sample_for_pca_fileext_file=$project_sample_for_pca_plink_file.fileext dir project_dir disp ".for_pca.fileext" parent cat_project_plink_sample_marker_pruned_ped_data class_level project comment "Marker fileext file for project samples, LD pruned"

file path project_sample_for_pca_make_bed_log_file=$project_sample_for_pca_plink_file.pruned.make_bed.log dir project_dir disp ".for_pca.make_bed.log" parent cat_project_plink_sample_marker_pruned_ped_data class_level project comment "Log file for make bed cmd"


!!expand:,:num:1:2! \
file path project_sample_subset_sample_marker_genome_listnum_file=$project_sample_subset_sample_marker_plink_file.genome.listnum dir project_sample_subset_dir disp ".genome.listnum" parent cat_project_sample_subset_sample_plink_ibd_data class_level project_sample_subset comment "List of samples to run --genome for"

file path project_sample_marker_seq_snp_file=@project.sample.marker.seq.snps dir project_dir disp ".marker.seq.snps" parent cat_project_plink_sample_non_seq_meta_data class_level project comment "SNPs in both marker file and sequence data"

project_sample_non_seq_plink_file=@project.sample.non_seq dir project_dir class_level project
!!expand:,:fileext:bed:bim:fam! \
file path project_sample_non_seq_fileext_file=$project_sample_non_seq_plink_file.fileext dir project_dir disp ".fileext" parent cat_project_plink_sample_non_seq_ped_data class_level project comment "Marker + Seq fileext file for project samples"
file path project_sample_non_seq_make_bed_log_file=$project_sample_non_seq_plink_file.make_bed.log dir project_dir disp ".make_bed.log" parent cat_project_plink_sample_non_seq_ped_data class_level project comment "Marker + Seq make_bed log file"

project_sample_combined_plink_file=@project.sample.combined dir project_dir class_level project
!!expand:,:fileext:bed:bim:fam! \
file path project_sample_combined_fileext_file=$project_sample_combined_plink_file.fileext dir project_dir disp ".fileext" parent cat_project_plink_sample_combined_ped_data class_level project comment "Marker + Seq fileext file for project samples"

file path project_sample_combined_merge_log_file=$project_sample_combined_plink_file.merge.log dir project_dir disp ".merge.log" parent cat_project_plink_sample_combined_ped_data class_level project comment "Marker + Seq merge log file"

#file path project_all_marker_sample_keep_file=$project_all_marker_plink_file.keep dir project_dir disp ".keep" parent cat_project_all_marker_data class_level project comment "Samples to keep for any use of marker file"

#file path project_all_marker_snp_exclude_file=$project_all_marker_plink_file.exclude dir project_dir disp ".exclude" parent cat_project_all_marker_data class_level project comment "SNPs to exclude for any use of marker file"

file path project_all_marker_pheno_file=$project_all_marker_plink_file.pheno.tsv dir project_dir disp ".pheno.tsv" parent cat_project_plink_all_marker_meta_data class_level project comment "Phenotype file for all samples in the marker file"

file table path project_all_marker_assoc_covars_file=$project_all_marker_plink_file.assoc.covars dir project_dir disp ".assoc.covars.tsv" parent cat_project_plink_all_marker_meta_data class_level project comment "Covariates for any association testing in all marker file"

file path project_all_marker_assoc_sample_keep_file=$project_all_marker_plink_file.assoc.keep dir project_dir disp ".assoc.keep" parent cat_project_plink_all_marker_meta_data class_level project comment "Samples to keep for any association testing in all marker file"

file path project_sample_marker_input_frq_file=$project_sample_marker_plink_file.input.frq dir project_dir disp ".input.frq" parent cat_project_sample_plink_ibd_data class_level project comment "Use these frequencies for sites to go into all marker calculations"

!!expand:,:allorsample:all:sample! \
file path project_allorsample_marker_ld_prune_restrict_file=$project_allorsample_marker_plink_file.prune.restrict dir project_dir disp ".prune.restrict" parent cat_project_allorsample_plink_ibd_data class_level project comment "Restrict LD pruning to these sites"

!!expand:,:allorsample:all:sample! \
!!expand:,:type:in:in_range:out:log! \
file path project_allorsample_marker_ld_prune_type_file=$project_allorsample_marker_plink_file.prune.type dir project_dir disp ".prune.type" parent cat_project_allorsample_plink_ibd_data class_level project comment "Result of LD pruning --- prune.type file"

file path project_sample_marker_keep_file=$project_sample_marker_plink_file.keep dir project_dir disp ".keep" parent cat_project_plink_sample_marker_meta_data class_level project comment "List sequenced individuals to keep in the sample marker file"

table file path project_sample_marker_frq_file=$project_sample_marker_plink_file.frq dir project_dir disp ".frq" parent cat_project_sample_plink_ibd_data class_level project comment "Frequencies for all variants from marker file"

minor file path project_sample_marker_frq_log_file=$project_sample_marker_frq_file.log dir project_dir disp ".frq.log" parent cat_project_sample_plink_ibd_data class_level project comment "Log file for frq command"

!!expand:,:project,type,description:project,all,all:project,sample,project:project_sample_subset,sample,project_sample_subset! \
table file path project_type_marker_genome_file=$project_type_marker_plink_file.genome.gz dir project_dir disp ".genome" parent cat_project_type_plink_ibd_data class_level project comment "Genome file for description samples"
!!expand:,:project,type,description:project,all,all:project,sample,project:project_sample_subset,sample,project_sample_subset! \
file path project_type_marker_genome_log_file=$project_type_marker_plink_file.genome.log dir project_dir disp ".genome.log" parent cat_project_type_plink_ibd_data class_level project comment "Log file for genome cmd"

table nohead path file project_duplicate_exclude_custom_rank_file=@project.duplicate.exclude.custom.rank dir project_dir disp ".duplicate.exclude.custom.rank" parent cat_project_sample_plink_ibd_data class_level project comment "Custom rank samples to exclude: higher number means preferentially include"

table file path project_duplicate_exclude_rank_file=@project.duplicate.exclude.rank dir project_dir disp ".duplicate.exclude.rank" parent cat_project_sample_plink_ibd_data class_level project comment "Rank samples to include based on duplicates"

table file path project_duplicate_exclude_file=@project.duplicate.exclude dir project_dir disp ".duplicate.exclude" parent cat_project_sample_plink_ibd_data class_level project comment "Samples excluded due to outliers according to duplicate"

mkdir path project_epacts_dir=$project_dir/epacts class_level project chmod 777
table path file project_epacts_ready_file=@project.epacts.ready dir project_epacts_dir disp ".epacts.ready"  class_level project comment "Dummy file to indicate ready to run epacts"

project_epacts_trunk=@project.epacts dir project_epacts_dir

table file path project_kinship_file=$project_epacts_trunk.kinf dir project_dir disp ".kinf" parent cat_project_sample_epacts_ibd_data class_level project comment "Kinship matrix for samples --- computed by EMMAX"

!!expand:,:project,type:project,all:project,sample:project_sample_subset,sample! \
project_type_marker_smart_pca_trunk=$project_sample_marker_plink_file.type.pca dir project_dir

file path project_sample_marker_smart_pca_map_file=$project_sample_marker_smart_pca_trunk.map dir project_dir disp ".pca.map" parent cat_project_sample_eigen_ibd_data class_level project comment "Map file for smartpca for description samples (maps project ID to pca ID)"

!!expand:,:filetype,Filetype:poplist,Poplist! \
!!expand:,:project,type,description:project,all,all:project,sample,project! \
file path project_type_marker_smart_pca_filetype_file=$project_type_marker_smart_pca_trunk.filetype dir project_dir disp ".pca.filetype" parent cat_project_type_eigen_ibd_data class_level project comment "Filetype file for smartpca for description samples"

!!expand:,:filetype,Filetype:evec,Evec:eval,Eval:weights,Weidht:log,Log:fam,Fam! \
!!expand:,:project,type,description:project,all,all:project,sample,project:project_sample_subset,sample,project_sample_subset! \
file path project_type_marker_smart_pca_filetype_file=$project_type_marker_smart_pca_trunk.filetype dir project_dir disp ".pca.filetype" parent cat_project_type_eigen_ibd_data class_level project comment "Filetype file for smartpca for description samples"

!!expand:project:project:project_sample_subset! \
table file path project_sample_marker_mds_file=$project_sample_marker_plink_file.mds dir project_dir disp ".mds" parent cat_project_sample_plink_ibd_data class_level project comment "MDS file for samples in project"

file path project_sample_marker_mds_log_file=$project_sample_marker_plink_file.mds.log dir project_dir disp ".mds.log" parent cat_project_sample_plink_ibd_data class_level project comment "Log file for mds cmd"

file path project_marker_custom_region_exclude_file=@project.sample.marker.custom.reg.exclude dir project_dir disp ".custom.reg.exclude" parent cat_project_region_exclude_ibd_data class_level project comment "Additional regions to exclude when computing genome/MDS"

file path project_marker_region_exclude_file=@project.sample.marker.all.reg.exclude dir project_dir disp ".reg.exclude" parent cat_project_region_exclude_ibd_data class_level project comment "Additional regions to exclude when computing genome/MDS"

#coverage metrics

!!expand:project:project:pheno! \
file path project_sample_subset_bam_list_file=@project_sample_subset.bam.list dir project_sample_subset_dir disp ".bam.list" parent cat_project_sample_subset_coverage_data class_level project_sample_subset comment "Bam list to feed into coverage computation for this collection of samples"

!!expand:project:project:pheno! \
table file path project_sample_subset_coverage_file=@project_sample_subset.coverage.txt.gz dir project_sample_subset_dir disp ".coverage.txt.gz" parent cat_project_sample_subset_coverage_data class_level project_sample_subset comment "Coverage at each base for this collection of samples; generated by DepthOfCoverageWalker"

!!expand:type:gene:exon:bait! \
file project_sample_type_coverage_stats_file_list=@project.sample.type.coverage.stats.list disp ".sample.stats.list" dir project_dir parent cat_project_type_dist_coverage_data class_level project comment "List of sample type coverage stats file for use in generating project type dist coverage dat file" child_order -1

file project_sample_coverage_file_list=@project.sample.coverage.list disp ".sample.coverage.list" dir project_dir parent cat_project_sample_coverage_data class_level project comment "List of sample coverage files" child_order -1

!!expand:type:gene:exon:bait! \
table file path project_type_dist_coverage_dat_file=@project.type.coverage.csv dir project_dir disp ".csv" parent cat_project_alphabetical_type_dist_coverage_data class_level project comment "Coverage for each sample stratified by type"
major file path project_gene_dist_coverage_pdf_file=@project.gene.coverage.pdf dir project_dir disp ".pdf" parent cat_project_alphabetical_gene_dist_coverage_data class_level project comment "Plot of coverage for each sample stratified by gene -- sorted alphabetically by gene name"

table file path project_lowest_gene_dist_coverage_dat_file=@project.gene.lowest.coverage.csv dir project_dir disp ".csv" parent cat_project_lowest_gene_dist_coverage_data class_level project comment "Coverage for each sample stratified by gene -- with a column for mean gene value"
major file path project_lowest_gene_dist_coverage_pdf_file=@project.gene.lowest.coverage.pdf dir project_dir disp ".pdf" parent cat_project_lowest_gene_dist_coverage_data class_level project comment "Plot of coverage for each sample stratified by gene -- sorted by lowest mean coverage"

!!expand:type:gene:exon:bait! \
table file path project_type_dist_mean_coverage_dat_file=@project.type.coverage.mean.csv dir project_dir disp ".mean.csv" parent cat_project_type_cum_coverage_data class_level project comment "Mean coverage for each sample stratified by type"

!!expand:type:gene:exon:bait! \
table nohead file path project_type_cum_coverage_dat_file=@project.type.cum.coverage.csv dir project_dir disp ".csv" parent cat_project_type_cum_coverage_data class_level project comment "Cumulative coverage distribution for all types"

!!expand:type:gene:exon:bait! \
major file path project_type_cum_coverage_pdf_file=@project.type.cum.coverage.pdf dir project_dir disp ".pdf" parent cat_project_type_cum_coverage_data class_level project comment "Plot of cumulative coverage distribution for all types"

file project_sample_coverage_stats_file_list=@project.sample.coverage.stats.list disp ".sample.list" dir project_dir parent cat_project_ind_sample_coverage_data class_level project comment "List of sample coverage stats file for use in generating project sample coverage dat file"

table file path project_sample_coverage_dat_file=@project.coverage.csv dir project_dir disp ".coverage.csv" parent cat_project_ind_sample_coverage_data class_level project comment "Coverage values for each passed sample"

table nohead file path project_sample_cum_coverage_dat_file=@project.sample.cum.coverage.csv dir project_dir disp ".csv" parent cat_project_sample_cum_coverage_data class_level project comment "Cumulative coverage for all samples --- includes failed"
major file path project_sample_cum_coverage_pdf_file=@project.sample.cum.coverage.pdf dir project_dir disp ".pdf" parent cat_project_sample_cum_coverage_data class_level project comment "Cumulative coverage for all samples --- includes failed"

#seq_batch

table file path seq_batch_picard_sort_file=@seq_batch.picard.sort.tsv dir seq_batch_dir disp ".picard.sort.tsv" parent cat_seq_batch_picard_data class_level seq_batch comment "Helper file mapping possible seq_batchtype values in the picard file to a sort order. The values in the picard file may not be the internal or disp seq_batch value; the entries in this file pertain to those in the picard file"

table file path seq_batch_picard_map_file=@seq_batch.picard.map dir seq_batch_dir disp ".picard.map" parent cat_seq_batch_picard_data class_level seq_batch comment "Helper file mapping unique ids to their batch"

table file path seq_batch_picard_file=@seq_batch.picard.tsv dir seq_batch_dir disp ".picard.tsv" parent cat_seq_batch_picard_data class_level seq_batch comment "Augmented picard file with batch information"


file path seq_batch_picard_pdf_file=@seq_batch.picard.metrics.pdf dir seq_batch_dir disp ".picard.metrics.pdf" parent cat_seq_batch_picard_data class_level seq_batch comment "Plot of select picard metrics stratified by seq_batch value in the picard file"

#pheno

!!expand:ktype:keep:exclude! \
table onecol nohead path file pheno_sample_ktype_file=@pheno.sample.ktype dir pheno_dir disp ".sample.ktype" parent cat_pheno_passed_meta_data class_level pheno comment "List of samples to ktype if meta_strata and meta_strata_value are specified"

table nohead path file pheno_sample_pheno_file=@pheno.sample.pheno dir pheno_dir disp ".sample.pheno" parent cat_pheno_passed_meta_data class_level pheno comment "Custom way to define phenotypes for samples"

table nohead path file pheno_non_missing_sample_pheno_file=@pheno.non_missing.sample.pheno dir pheno_dir disp ".non_missing.sample.pheno" parent cat_pheno_passed_meta_data class_level pheno comment "List of samples with non-missing phenotypes and their values for this phenotype --- only those that passed"

table nohead path file pheno_non_missing_sample_info_file=@pheno.non_missing.sample.info dir pheno_dir disp ".non_missing.sample.info" parent cat_pheno_passed_meta_data class_level pheno comment "List of samples with non-missing phenotypes and their values + disp values for this phenotype --- only those that passed"
table nohead path file pheno_missing_sample_info_file=@pheno.missing.sample.info dir pheno_dir disp ".missing.sample.info" parent cat_pheno_passed_meta_data class_level pheno comment "List of samples with missing phenotypes and their values for this phenotype --- passed samples"
doubcom table path file pheno_all_sample_info_file=@pheno.all.sample.info dir pheno_dir disp ".all.sample.info" parent cat_pheno_passed_meta_data class_level pheno comment "List of all samples and their values for this phenotype --- passed samples"

doubcom table path file pheno_plinkseq_indicator_phe_file_body=@pheno.plinkseq.indicator.phe.body dir pheno_dir disp ".indicator.phe.body" parent cat_pheno_passed_meta_data class_level pheno comment "Phe body file with indicator variables"

table nohead path file pheno_failed_non_missing_sample_pheno_file=@pheno.failed.non_missing.sample.pheno dir pheno_dir disp ".non_missing.sample.pheno" parent cat_pheno_failed_meta_data class_level pheno comment "List of samples with non-missing phenotypes and their values for this phenotype --- only those that failed"
table nohead path file pheno_failed_non_missing_sample_info_file=@pheno.failed.non_missing.sample.info dir pheno_dir disp ".non_missing.sample.info" parent cat_pheno_failed_meta_data class_level pheno comment "List of samples with non-missing phenotypes and their values + disp values for this phenotype --- only those that failed"
table nohead path file pheno_failed_missing_sample_info_file=@pheno.failed.missing.sample.info dir pheno_dir disp ".missing.sample.info" parent cat_pheno_failed_meta_data class_level pheno comment "List of samples with missing phenotypes and their values for this phenotype --- failed samples"

minor path file pheno_sample_info_header_file=@pheno.sample.info.header dir pheno_dir disp ".sample.info.header" parent cat_pheno_all_meta_data class_level pheno comment "Header for sample info file"

minor path file pheno_indicator_list_file=@pheno.indicator.list dir pheno_dir disp ".indicator.list" parent cat_pheno_all_meta_data class_level pheno comment "List of indicator values"

minor path file pheno_variable_covars_file=@pheno.variable.covars dir pheno_dir disp ".variable.covars" parent cat_pheno_all_meta_data class_level pheno comment "List of covariates that are variable in these samples"

minor path file pheno_plinkseq_indicator_phe_file_header1=@pheno.plinkseq.indicator.phe.header1 dir pheno_dir disp ".indicator.phe.header1" parent cat_pheno_all_meta_data class_level pheno comment "Header for sample indicator file"

minor path file pheno_disp_order_file=@pheno.disp.order.tsv dir pheno_dir disp ".disp.order" parent cat_pheno_all_meta_data class_level pheno comment "Simple map from disp to order\n"

table path file pheno_quantile_file=@pheno.quantile dir pheno_dir disp ".quantile" parent cat_pheno_all_meta_data class_level pheno comment "List of quantile for this phenotype; grouped for passed, failed, and all samples"

doubcom table path file pheno_sequenced_all_sample_info_file=@pheno.sequenced.all.sample.info dir pheno_dir disp ".all.sample.info" parent cat_pheno_all_meta_data class_level pheno comment "List of all samples and their values for this phenotype --- passed and failed samples"

doubcom table path file pheno_sequenced_all_sample_box_info_file=@pheno.all.sample.box.info dir pheno_dir disp ".all.sample.box.info" parent cat_pheno_all_meta_data class_level pheno comment "Trait values for each sample, ready for box plotting"

doubcom table path file pheno_sequenced_all_trait_all_sample_box_info_file=@pheno.all_trait.all.sample.info dir pheno_dir disp ".all_trait.all.sample.info" parent cat_pheno_all_meta_data class_level pheno comment "List of all samples and their values for this as well as related phenotypes --- passed and failed samples"

table path file pheno_sample_failure_status_file=@pheno.samples.failure.status dir pheno_dir disp ".failure.status" parent cat_pheno_all_meta_data class_level pheno comment "Columns for each fail/pass designation; like project level file but with additional ibd removal information for this phenotype"

doubcom table file path pheno_cross_classification_phe_file=@pheno.cross.phe dir pheno_dir disp ".cross.phe" parent cat_pheno_all_meta_data class_level pheno comment "Modified phenotype file with two differences: (1) Only have traits suitable for cross classification as specified in meta file and (2) Showing display names rather than internal names"


minor file path pheno_plinkseq_phe_file_header1=@pheno.plinkseq.phe.header1 dir pheno_dir disp ".phe.header1" parent cat_pheno_plinkseq_phe_data class_level pheno comment "First header lines for Plink/Seq phe file"

minor file path pheno_plinkseq_phe_file_body=@pheno.plinkseq.phe.body dir pheno_dir disp ".phe.body" parent cat_pheno_plinkseq_phe_data class_level pheno comment "Plink/Seq phe body file"

file table doubcom path pheno_plinkseq_phe_file=@pheno.plinkseq.phe dir pheno_dir disp ".phe" parent cat_pheno_plinkseq_phe_data class_level pheno comment "Plink/Seq phe file"

minor file path pheno_plinkseq_strata_phe_file_header1=@pheno.plinkseq.strata.phe.header1 dir pheno_dir disp ".strata.phe.header1" parent cat_pheno_plinkseq_phe_data class_level pheno comment "First header lines for Plink/Seq strata phe file"
minor file path pheno_plinkseq_strata_phe_file_body=@pheno.plinkseq.strata.phe.body dir pheno_dir disp ".strata.phe.body" parent cat_pheno_plinkseq_phe_data class_level pheno comment "Body lines for Plink/Seq strata phe file"
doubcom table file path pheno_plinkseq_strata_phe_file=@pheno.plinkseq.strata.phe dir pheno_dir disp ".strata.phe" parent cat_pheno_plinkseq_phe_data class_level pheno comment "Strata phenotype file for import into Plink/Seq"

doubcom table file path pheno_plinkseq_covar_phe_file=@pheno.covar.phe dir pheno_dir disp ".covar.phe" parent cat_pheno_plinkseq_phe_data class_level pheno comment "Additional covar phenotype file for import into Plink/Seq"

doubcom table file path pheno_plinkseq_cluster_phe_file=@pheno.cluster.phe dir pheno_dir disp ".cluster.phe" parent cat_pheno_plinkseq_phe_data class_level pheno comment "Additional cluster phenotype file for import into Plink/Seq"

#table file path pheno_score_seq_phe_file=@pheno.score_seq.phe dir pheno_dir disp ".score_seq.phe" parent cat_pheno_plinkseq_phe_data class_level pheno comment "Phenotypes in format for Score/SEQ"

#table file path pheno_score_seq_phe_covar_file=@pheno.score_seq.phe.covar dir pheno_dir disp ".score_seq.phe.covar" parent cat_pheno_plinkseq_phe_data class_level pheno comment "Phenotypes + covariates in format for Score/SEQ"

#table file path pheno_score_seq_reverse_phe_file=@pheno.score_seq.rev.phe dir pheno_dir disp ".score_seq.rev.phe" parent cat_pheno_plinkseq_phe_data class_level pheno comment "Phenotypes in format for Score/SEQ --- case/ctrl flipped"

#table file path pheno_score_seq_reverse_phe_covar_file=@pheno.score_seq.rev.phe.covar dir pheno_dir disp ".score_seq.rev.phe.covar" parent cat_pheno_plinkseq_phe_data class_level pheno comment "Phenotypes + covariates in format for Score/SEQ --- case/ctrl flipped"

!!expand:type:all:unrelated! \
onecol table nohead path file pheno_sample_non_missing_type_include_file=@pheno.sample.non_missing.type.include dir pheno_dir disp ".sample.non_missing.type.include" parent cat_pheno_plinkseq_type_include_data class_level pheno comment "Samples (type) included for analysis in this phenotype (passing QC + non missing phenotype)"

!!expand:type:all:unrelated! \
onecol table nohead path file pheno_sample_basic_type_include_file=@pheno.sample.basic.type.include dir pheno_dir disp ".sample.basic.type.include" parent cat_pheno_plinkseq_type_include_data class_level pheno comment "Samples (type) included for analysis in this phenotype (passing QC + non missing phenotype)"

!!expand:type:all:unrelated! \
onecol table nohead path file pheno_sample_popgen_type_include_file=@pheno.sample.popgen.type.include dir pheno_dir disp ".sample.popgen.type.include" parent cat_pheno_plinkseq_type_include_data class_level pheno comment "Samples (type) included for analysis in this phenotype (passing QC + Popgen)"

#jason onecol table file path pheno_sample_filtered_mds_include_file=@pheno.sample.filtered.mds.include dir pheno_dir disp ".sample.filtered.mds.include" parent cat_pheno_plinkseq_include_data class_level pheno comment "Samples included due to outliers on MDS scale"

!!expand:type:all:unrelated! \
!!expand:,:filetype,description:covar,not removed during MDS computation or during MDS outlier evaluation:cluster,not removed during MDS computation or MDS outlier evaluation or clustering! \
onecol table nohead file path pheno_sample_filetype_type_include_file=@pheno.sample.filetype.type.include dir pheno_dir disp ".sample.filetype.type.include" parent cat_pheno_plinkseq_type_include_data class_level pheno comment "Samples (type) to include during filetype evaluation: description"


!!expand:pheno:pheno:pheno_variant_subset! \
constant pheno_project_exon_browser=Open disp "Exon Browser" parent cat_pheno_plinkseq_raw_data goto_url ${plinkseq_exome_browser_url}?proj=*pheno_plinkseq_project_file&loc=$pseq_genes_loc_group comment "Link to Plink/Seq exon browser for raw pheno project"
!!expand:pheno:pheno:pheno_variant_subset! \
table nohead file path pheno_plinkseq_project_file=@pheno.plinkseq.project.pseq dir pheno_dir disp ".plinkseq.project" parent cat_pheno_plinkseq_raw_data class_level pheno comment "Plink/Seq raw pheno project file"
!!expand:pheno:pheno:pheno_variant_subset! \
mkdir path pheno_plinkseq_project_out_dir=*{pheno_plinkseq_project_file}_out class_level pheno chmod 777
!!expand:pheno:pheno:pheno_variant_subset! \
mkdir path pheno_plinkseq_project_temp_dir=*{pheno_plinkseq_project_file}_temp class_level pheno chmod 777
!!expand:pheno:pheno:pheno_variant_subset! \
file path pheno_plinkseq_inddb_file=inddb dir pheno_plinkseq_project_out_dir disp "inddb" parent cat_pheno_plinkseq_raw_data class_level pheno comment "Plink/Seq raw pheno inddb file"
!!expand:pheno:pheno:pheno_variant_subset! \
file path pheno_plinkseq_project_done_file=.$pheno_plinkseq_project_file.done dir pheno_dir disp "project.done" parent cat_pheno_plinkseq_raw_data class_level pheno comment "Signifies that raw pheno project was done"
!!expand:pheno:pheno:pheno_variant_subset! \
ignore_md5 file path pheno_plinkseq_db_done_file=db.done dir pheno_plinkseq_project_out_dir disp "db.done" parent cat_pheno_plinkseq_raw_data class_level pheno comment "Signifies that raw pheno db was done"
!!expand:pheno:pheno:pheno_variant_subset! \
file path pheno_plinkseq_temp_done_file=temp.done dir pheno_plinkseq_project_temp_dir disp "temp.done" parent cat_pheno_plinkseq_raw_data class_level pheno comment "Signifies that raw pheno temp dir was done"

!!expand:pheno:pheno:pheno_variant_subset! \
constant pheno_clean_project_exon_browser=Open disp "Exon Browser" parent cat_pheno_plinkseq_clean_data goto_url ${plinkseq_exome_browser_url}?proj=*pheno_plinkseq_clean_project_file&loc=$pseq_genes_loc_group comment "Link to Plink/Seq exon browser for clean pheno project"
!!expand:pheno:pheno:pheno_variant_subset! \
table nohead file path pheno_plinkseq_clean_project_file=@pheno.plinkseq.clean.project.pseq dir pheno_dir disp ".plinkseq.project" parent cat_pheno_plinkseq_clean_data class_level pheno comment "Plink/Seq clean pheno project file"
!!expand:pheno:pheno:pheno_variant_subset! \
mkdir path pheno_plinkseq_clean_project_out_dir=*{pheno_plinkseq_clean_project_file}_out class_level pheno chmod 777
!!expand:pheno:pheno:pheno_variant_subset! \
mkdir path pheno_plinkseq_clean_project_temp_dir=*{pheno_plinkseq_clean_project_file}_temp class_level pheno chmod 777
!!expand:pheno:pheno:pheno_variant_subset! \
file path pheno_plinkseq_clean_inddb_file=inddb dir pheno_plinkseq_clean_project_out_dir disp "inddb" parent cat_pheno_plinkseq_clean_data class_level pheno comment "Plink/Seq clean pheno inddb file"
!!expand:pheno:pheno:pheno_variant_subset! \
file path pheno_plinkseq_clean_project_done_file=.$pheno_plinkseq_clean_project_file.done dir pheno_dir disp "project.done" parent cat_pheno_plinkseq_clean_data class_level pheno comment "Signifies that clean pheno project was done"
!!expand:pheno:pheno:pheno_variant_subset! \
ignore_md5 file path pheno_plinkseq_clean_db_done_file=db.done dir pheno_plinkseq_clean_project_out_dir disp "db.done" parent cat_pheno_plinkseq_clean_data class_level pheno comment "Signifies that clean pheno db was done"
!!expand:pheno:pheno:pheno_variant_subset! \
file path pheno_plinkseq_clean_temp_done_file=temp.done dir pheno_plinkseq_clean_project_temp_dir disp "temp.done" parent cat_pheno_plinkseq_clean_data class_level pheno comment "Signifies that clean pheno temp dir was done"

!!expand:pheno:pheno:pheno_variant_subset! \
constant pheno_strat_project_exon_browser=Open disp "Exon Browser" parent cat_pheno_plinkseq_strat_data goto_url ${plinkseq_exome_browser_url}?proj=*pheno_plinkseq_strat_project_file&loc=$pseq_genes_loc_group comment "Link to Plink/Seq exon browser for strat pheno project"
!!expand:pheno:pheno:pheno_variant_subset! \
table nohead file path pheno_plinkseq_strat_project_file=@pheno.plinkseq.strat.project.pseq dir pheno_dir disp ".plinkseq.project" parent cat_pheno_plinkseq_strat_data class_level pheno comment "Plink/Seq strat pheno project file"
!!expand:pheno:pheno:pheno_variant_subset! \
mkdir path pheno_plinkseq_strat_project_out_dir=*{pheno_plinkseq_strat_project_file}_out class_level pheno chmod 777
!!expand:pheno:pheno:pheno_variant_subset! \
mkdir path pheno_plinkseq_strat_project_temp_dir=*{pheno_plinkseq_strat_project_file}_temp class_level pheno chmod 777
!!expand:pheno:pheno:pheno_variant_subset! \
file path pheno_plinkseq_strat_inddb_file=inddb dir pheno_plinkseq_strat_project_out_dir disp "inddb" parent cat_pheno_plinkseq_strat_data class_level pheno comment "Plink/Seq strat pheno inddb file"
!!expand:pheno:pheno:pheno_variant_subset! \
file path pheno_plinkseq_strat_project_done_file=.$pheno_plinkseq_strat_project_file.done dir pheno_dir disp "project.done" parent cat_pheno_plinkseq_strat_data class_level pheno comment "Signifies that strat pheno project was done"
!!expand:pheno:pheno:pheno_variant_subset! \
ignore_md5 file path pheno_plinkseq_strat_db_done_file=db.done dir pheno_plinkseq_strat_project_out_dir disp "db.done" parent cat_pheno_plinkseq_strat_data class_level pheno comment "Signifies that strat pheno db was done"
!!expand:pheno:pheno:pheno_variant_subset! \
file path pheno_plinkseq_strat_temp_done_file=temp.done dir pheno_plinkseq_strat_project_temp_dir disp "temp.done" parent cat_pheno_plinkseq_strat_data class_level pheno comment "Signifies that strat pheno temp dir was done"

table nohead file path pheno_plink_phe_file=@pheno.plink.phe dir pheno_dir disp ".plink.phe" parent cat_pheno_plink_phe_data class_level pheno comment "Phenotype file for loading into plink"

table file path pheno_plink_alternate_phe_file=@pheno.plink.alternate.phe dir pheno_dir disp ".plink.alternate.phe" parent cat_pheno_plink_phe_data class_level pheno comment "Phenotype file for loading into plink --- has all traits in plinkseq pheno file"

table file path pheno_plink_covar_file=@pheno.plink.covar dir pheno_dir disp ".plink.covar" parent cat_pheno_plink_phe_data class_level pheno comment "Covar file for loading into plink"

table file path pheno_plink_covar_cluster_file=@pheno.plink.covar.cluster dir pheno_dir disp ".plink.covar.cluster" parent cat_pheno_plink_phe_data class_level pheno comment "Covar file for loading into plink (has cluster info as well)"

!!expand:type:all:unrelated! \
table file path pheno_epacts_type_ped_file=@pheno.epacts.type.ped dir pheno_dir disp ".epacts.type.ped" parent cat_pheno_epacts_phe_data class_level pheno comment "Phenotype file for loading into EPACTS --- includes all samples samples with non-missing phenotypes"

!!expand:type:all:unrelated! \
table file path pheno_epacts_popgen_type_ped_file=@pheno.epacts.popgen.type.ped dir pheno_dir disp ".epacts.popgen.type.ped" parent cat_pheno_epacts_phe_data class_level pheno comment "Phenotype file for loading into EPACTS --- includes popgen+ samples only"

!!expand:type:all:unrelated! \
table file path pheno_epacts_covar_type_ped_file=@pheno.epacts.covar.type.ped dir pheno_dir disp ".epacts.covar.type.ped" parent cat_pheno_epacts_phe_data class_level pheno comment "Phenotype file for loading into EPACTS --- includes covar+ samples only"

!!expand:type:all:unrelated! \
onecol table nohead path file pheno_sample_plink_non_missing_type_include_file=@pheno.sample.plink.non_missing.type.include dir pheno_dir disp ".sample.plink.non_missing.type.include" parent cat_pheno_plink_type_include_data class_level pheno comment "Samples (type) included for analysis in this phenotype (passing QC+ with non-missing phenotype)"

!!expand:type:all:unrelated! \
onecol table nohead path file pheno_sample_plink_basic_type_include_file=@pheno.sample.plink.basic.type.include dir pheno_dir disp ".sample.plink.basic.type.include" parent cat_pheno_plink_type_include_data class_level pheno comment "Samples (type) included for analysis in this phenotype (passing QC+ with non-missing phenotype)"

!!expand:type:all:unrelated! \
onecol table nohead path file pheno_sample_plink_popgen_type_include_file=@pheno.sample.plink.popgen.type.include dir pheno_dir disp ".sample.plink.popgen.type.include" parent cat_pheno_plink_type_include_data class_level pheno comment "Samples (type) included for analysis in this phenotype (passing QC + Popgen)"

#onecol table nohead path file pheno_sample_plink_filtered_mds_type_include_file=@pheno.sample.plink.filtered.mds.include dir pheno_dir disp ".sample.plink.filtered.mds.include" parent cat_pheno_plink_include_data class_level pheno comment "Samples included due to outliers on MDS scale"

!!expand:type:all:unrelated! \
!!expand:filetype:covar:cluster! \
onecol table nohead file path pheno_sample_plink_filetype_type_include_file=@pheno.sample.plink.filetype.type.include dir pheno_dir disp ".sample.plink.filetype.type.include" parent cat_pheno_plink_type_include_data class_level pheno comment "Samples (type) to include during filetype evaluation"


table file path pheno_sstats_file=@pheno.sstats dir pheno_dir disp ".sstats" parent cat_pheno_sstats_qc_stats_data class_level pheno comment "Project level sstats projected to this phenotype"

major file path pheno_trait_hist_pdf_file=@pheno.trait.hist.pdf dir pheno_dir disp ".trait.hist.pdf" parent cat_pheno_slide_sample_qc_data class_level pheno comment "Histogram of sample trait values"

!!expand:,:slidedot,slideunder,cattouse,extracomment:slide.,slide_,cat_pheno_slide_sample_qc_data,-- fewer columns for inclusion in slides:,,cat_pheno_phenocat_data,! \
!!expand:,:tval,tname,phenocat\
:all,all,sstats_qc_plot\
:highlighted,highlighted outlier,sstats_qc_plot\
:filtered,QC+,sstats_qc_plot\
:extreme,QC+,sstats_qc_plot\
:popgen,QC/Popgen+,popgen_qc_plot!\
major file path pheno_slideundertval_sstats_pdf_file=@pheno.slidedottval.sstats.pdf dir pheno_dir disp ".tval.sstats.pdf" parent cattouse class_level pheno comment "Plot of various sample metrics across all samples stratified by phenotype value; tname samples extracomment"

#pheno_sample_marker_type_nearest_file defined above

table file path pheno_project_mds_file=@pheno.project.mds dir pheno_dir disp ".project.mds" parent cat_pheno_covar_qc_stats_data class_level pheno comment "Project level MDS values projected to this phenotype --- only includes QC+ samples"

table file path pheno_mds_exclude_file=@pheno.mds.exclude dir pheno_dir disp ".mds.exclude" parent cat_pheno_plinkseq_all_include_data class_level pheno comment "Samples excluded due to outliers according to mds"

onecol table nohead path file pheno_basic_exclude_file=@pheno.sample.basic.exclude dir pheno_dir disp ".sample.basic.exclude" parent cat_pheno_plinkseq_all_include_data class_level pheno comment "Exclude these samples from any phenotype specific analysis: potential combination of MDS outliers, sex check discordances, duplicates"

!!expand:pheno:pheno:pheno_sample_subset! \
!!expand:,:type,parent_cat\
:all,cat_pheno_all_qc_stats_data\
:unrelated,cat_pheno_unrelated_qc_stats_data! \
pheno_sample_marker_type_nearest_trunk=@pheno.type dir pheno_dir

!!expand:,:type,parent_cat\
:all,cat_pheno_popgen_qc_stats_data\
:unrelated,cat_pheno_popgen_qc_stats_data! \
table file path pheno_sample_marker_type_nearest_file=$pheno_sample_marker_type_nearest_trunk.nearest dir pheno_dir disp ".type.nearest" parent parent_cat class_level pheno comment "Nearest file for type QC+ samples in project"

!!expand:,:type,parent_cat\
:all,cat_pheno_popgen_qc_stats_data\
:unrelated,cat_pheno_popgen_qc_stats_data! \
file path pheno_sample_marker_type_nearest_log_file=@pheno.type.nearest.log dir pheno_dir disp ".type.nearest.log" parent parent_cat class_level pheno comment "Log file for type nearest cmd"

!!expand:pheno:pheno:pheno_sample_subset! \
!!expand:,:type,removal_t,cat_t:all,no,popgen:unrelated,popgen- and related,popgen! \
table file path pheno_type_popgen_istats_file=@pheno.type.popgen.istats dir pheno_dir disp ".type.popgen.istats" parent cat_pheno_cat_t_qc_stats_data class_level pheno comment "Sample statistics based on popgen metrics --- bad samples removed; removal_t samples removed"

major table file path pheno_popgen_outlier_file=@pheno.popgen.outliers.csv dir pheno_dir disp ".popgen.outliers.csv" parent cat_pheno_popgen_qc_stats_data class_level pheno comment "Outlier values from popgen statistics"

onecol table file path pheno_additional_popgen_exclude_file=@pheno.additional.popgen.exclude dir pheno_dir disp ".additional.popgen.exclude" parent cat_pheno_popgen_qc_stats_data class_level pheno comment "Custom samples to exclude; will exclude from MDS computation as well"

table file path pheno_additional_popgen_plink_exclude_file=@pheno.additional.popgen.plink.exclude dir pheno_dir disp ".additional.popgen.plink.exclude" parent cat_pheno_popgen_qc_stats_data class_level pheno comment "Custom samples to exclude (plink format)"

table file path pheno_popgen_exclude_detail_file=@pheno.popgen.exclude.detail dir pheno_dir disp ".popgen.exclude.detail" parent cat_pheno_popgen_qc_stats_data class_level pheno comment "Samples excluded because they are outliers on popgen measures"

onecol table nohead path file pheno_popgen_exclude_file=@pheno.popgen.exclude dir pheno_dir disp ".popgen.exclude" parent cat_pheno_popgen_qc_stats_data class_level pheno comment "Samples excluded based on popgen measures"

table nohead path file pheno_related_exclude_custom_rank_file=@pheno.related.exclude.custom.rank dir pheno_dir disp ".related.exclude.custom.rank" parent cat_pheno_ibd_qc_stats_data class_level pheno comment "Custom rank samples to exclude: higher number means preferentially include"

table nohead path file pheno_related_exclude_rank_file=@pheno.related.exclude.rank dir pheno_dir disp ".related.exclude.rank" parent cat_pheno_ibd_qc_stats_data class_level pheno comment "Rank samples to exclude: higher number means preferentially include"


onecol table nohead path file pheno_custom_related_exclude_file=@pheno.custom.related.exclude dir pheno_dir disp ".custom.related.exclude" parent cat_pheno_ibd_qc_stats_data class_level pheno comment "Custom samples to exclude for relatedness"

onecol table nohead path file pheno_basic_related_exclude_file=@pheno.basic.related.exclude dir pheno_dir disp ".basic.related.exclude" parent cat_pheno_ibd_qc_stats_data class_level pheno comment "Samples excluded from basic include file based on relatedness"

!!expand:,:_type,.type,Type:_all,.all,all:_unrelated,.unrelated,unrelated! \
major file path pheno_type_related_pdf_file=@pheno.type.related.pdf dir pheno_dir disp ".type.related.pdf" parent cat_pheno_ibd_qc_plot_data class_level pheno comment "Histogram of relatedness counts among Type samples"

!!expand:,:type,cattouse:all,popgen:highlighted,popgen:final,popgen:unrelated,popgen! \
major file path pheno_popgen_type_pdf_file=@pheno.popgen.type.pdf dir pheno_dir disp ".popgen.type.pdf" parent cat_pheno_cattouse_qc_plot_data class_level pheno comment "Plot of popgen sample metrics across all samples --- type plots"

!!expand:type:popgen! \
pheno_slide_type_qc_failures_trunk=@pheno.slide.type.qc_failures

!!expand:type:popgen! \
file path pheno_slide_type_qc_failures_tex_file=$pheno_slide_type_qc_failures_trunk.tex dir pheno_dir disp ".type.failures.tex" parent cat_pheno_popgen_qc_plot_data class_level pheno trunk $pheno_slide_type_qc_failures_trunk comment "Sample type qc failure table -- tex file"

!!expand:type:popgen! \
file path pheno_slide_type_qc_failures_pdf_file=$pheno_slide_type_qc_failures_trunk.pdf dir pheno_dir disp ".type.failures.pdf" parent cat_pheno_popgen_qc_plot_data class_level pheno comment "Sample type qc failure table -- pdf file"

table file path pheno_with_genome_file=@pheno.with.genome dir pheno_dir disp ".with.genome" parent cat_pheno_ibd_qc_stats_data class_level pheno comment "Helper file: pheno non missing file projected to those samples in the project genome file"

!!expand:pheno:pheno:pheno_sample_subset! \
pheno_genome_trunk=@pheno dir pheno_dir

!!expand:pheno:pheno:pheno_sample_subset! \
table file path pheno_genome_file=$pheno_genome_trunk.genome.gz dir pheno_dir disp ".genome" parent cat_pheno_ibd_qc_stats_data class_level pheno comment "Project level genome values projected to this phenotype --- only includes QC+ samples"

table file path pheno_sample_subset_genome_for_cat_file=$pheno_sample_subset_genome_trunk.genome.for_cat.gz dir pheno_sample_subset_dir disp ".genome.for_cat" parent cat_pheno_sample_subset_ibd_qc_stats_data class_level pheno_sample_subset comment "Pheno sample subset genome file projected so when catted together have unique pairs"

table file path pheno_annotated_genome_file=$pheno_genome_trunk.annotated.genome.gz dir pheno_dir disp ".annotated.genome" parent cat_pheno_ibd_qc_stats_data class_level pheno comment "Project level genome values projected to this phenotype --- only includes QC+ samples"

!!expand:pheno:pheno:pheno_sample_subset! \
table file path pheno_genome_log_file=$pheno_genome_trunk.genome.log dir pheno_dir disp ".genome.log" parent cat_pheno_ibd_qc_stats_data class_level pheno comment "Log file for genome command"

mkdir path pheno_epacts_dir=$pheno_dir/epacts class_level pheno chmod 777
table path file pheno_epacts_ready_file=@pheno.epacts.ready dir pheno_epacts_dir disp ".epacts.ready"  class_level pheno comment "Dummy file to indicate ready to run epacts"

pheno_epacts_trunk=@pheno.epacts dir pheno_epacts_dir

table file path pheno_kinship_file=$pheno_epacts_trunk.kinf dir pheno_dir disp ".kinf" parent cat_pheno_ibd_qc_stats_data class_level pheno comment "Kinship matrix for samples --- computed by EMMAX"

!!expand:,:_type,.type,Type:_all,.all,all:_unrelated,.unrelated,unrelated! \
file path pheno_type_related_dat_file=@pheno.type.related.dat dir pheno_dir disp ".type.related.dat" parent cat_pheno_ibd_qc_stats_data class_level pheno comment "Dat file for histogram of relatedness counts among Type samples"

!!expand:pheno:pheno:pheno_sample_subset! \
pheno_smart_pca_trunk=@pheno.pca dir pheno_dir

!!expand:pheno:pheno:pheno_sample_subset! \
!!expand:,:filetype,Filetype:evec,Evec:eval,Eval:weights,Weight:log,Log:fam,Fam! \
file path pheno_smart_pca_filetype_file=$pheno_smart_pca_trunk.filetype dir pheno_dir disp ".pca.filetype" parent cat_pheno_covar_qc_stats_data class_level pheno comment "Filetype file for smartpca"

#!!expand:pheno:pheno:pheno_sample_subset! \
#file path pheno_smart_pca_log_file=@pheno.pca.log dir pheno_dir disp ".pca.log" parent cat_pheno_covar_qc_stats_data class_level pheno comment "Par file for smartpca"

table file path pheno_custom_mds_file=@pheno.custom.mds dir pheno_dir disp ".custom.mds" parent cat_pheno_covar_qc_stats_data class_level pheno comment "Specify custom PCs to use"

!!expand:pheno:pheno:pheno_sample_subset! \
pheno_mds_trunk=@pheno dir pheno_dir
!!expand:pheno:pheno:pheno_sample_subset! \
table file path pheno_mds_file=$pheno_mds_trunk.mds dir pheno_dir disp ".mds" parent cat_pheno_covar_qc_stats_data class_level pheno comment "Recomputation of mds file using only samples at this pheno level"

file path pheno_mds_log_file=$pheno_mds_trunk.mds.log dir pheno_dir disp ".mds.log" parent cat_pheno_covar_qc_stats_data class_level pheno comment "Recomputation of mds file using only samples at this pheno level -- log file"

table file path pheno_annotated_mds_file=@pheno.annotated.mds dir pheno_dir disp ".annotated.mds" parent cat_pheno_covar_qc_stats_data class_level pheno comment "Mds file annotated with phenotype"

table file nohead path pheno_plink_match_file=@pheno.plink.match dir pheno_dir disp ".plink.match" parent cat_pheno_cluster_qc_stats_data class_level pheno comment "Match file for loading into plink"

!!expand:clusterlevel:0:1:2:3! \
table nohead file path pheno_sample_marker_clusterclusterlevel_file=$pheno_sample_marker_plink_file.clusterclusterlevel dir pheno_dir disp ".clusterclusterlevel" parent cat_pheno_cluster_qc_stats_data class_level pheno comment "Cluster clusterlevel file for samples in project; using this phenotype for any case/control matching"
file path pheno_sample_marker_cluster_log_file=$pheno_sample_marker_plink_file.cluster.log dir pheno_dir disp ".cluster.log" parent cat_pheno_cluster_qc_stats_data class_level pheno comment "Log file for cluster cmd"

file path pheno_cluster_avg_stats_file=@pheno.cluster.avg.stats dir pheno_dir disp ".cluster.avg.stats" parent cat_pheno_cluster_qc_stats_data class_level pheno comment "Stats on strata clusters that come from averages over samples" 

table file path pheno_cluster_stats_file=@pheno.cluster.stats dir pheno_dir disp ".cluster.stats" parent cat_pheno_cluster_qc_stats_data class_level pheno comment "Stats on strata clusters" 

!!expand:tval:top! \
major file path pheno_tval_project_mds_pdf_file=@pheno.tval.project.mds.pdf dir pheno_dir disp ".tval.project.mds.pdf" parent cat_pheno_covar_qc_plot_data class_level pheno comment "Plot of tval MDS values for all samples -- made from project level PCA"


!!expand:tval:top:all! \
major file path pheno_tval_mds_pdf_file=@pheno.tval.mds.pdf dir pheno_dir disp ".tval.mds.pdf" parent cat_pheno_covar_qc_plot_data class_level pheno comment "Plot of tval MDS values for popgen+ samples"

major file path pheno_genome_pdf_file=@pheno.genome.pdf dir pheno_dir disp ".genome.pdf" parent cat_pheno_ibd_qc_plot_data class_level pheno comment "Plot of IBD sharing stratified by phenotype"

major file path pheno_cluster_assign_mds_pdf_file=@pheno.cluster.assign.mds.pdf dir pheno_dir disp ".cluster.assign.mds.pdf" parent cat_pheno_cluster_qc_plot_data class_level pheno comment "Plot of MDS values for samples, samples in a common cluster connected"

major file path pheno_cluster_stats_pdf_file=@pheno.cluster.stats.pdf dir pheno_dir disp ".cluster.stats.pdf" parent cat_pheno_cluster_qc_plot_data class_level pheno comment "Plot of stats for clusters"

#post strat

#!!expand:filetype:covar:cluster! \
#onecol table nohead file path pheno_filetype_exclude_file=@pheno.filetype.exclude dir pheno_dir disp ".filetype.exclude" parent cat_pheno_post_strat_qc_stats_data class_level pheno comment "Samples to exclude during filetype evaluation"

!!expand:pheno:pheno:pheno_variant_subset! \
pheno_plink_file=@pheno dir pheno_dir
!!expand:pheno:pheno:pheno_variant_subset! \
file path pheno_bed_file=@pheno.bed dir pheno_dir disp ".bed" parent cat_pheno_plink_seq_data class_level pheno comment "Bed file format for qc_plus vcf file; phenotypes specific to this trait"
!!expand:pheno:pheno:pheno_variant_subset! \
nohead table file path pheno_fam_file=@pheno.fam dir pheno_dir disp ".fam" parent cat_pheno_plink_seq_data class_level pheno comment "Fam file format for qc_plus vcf file; phenotypes specific to this trait"
!!expand:pheno:pheno:pheno_variant_subset! \
nohead table file path pheno_bim_file=@pheno.bim dir pheno_dir disp ".bim" parent cat_pheno_plink_seq_data class_level pheno comment "Bim file format for qc_plus vcf file; phenotypes specific to this trait"

!!expand:pheno:pheno:pheno_variant_subset! \
minor file path pheno_make_bed_log_file=@pheno.make_bed.log dir pheno_dir disp ".make_bed.log" parent cat_pheno_plink_seq_data class_level pheno comment "Log file for make-bed command"

pheno_sample_marker_plink_file=@pheno.sample.marker dir pheno_dir
pheno_sample_pruned_marker_plink_file=@pheno.sample.pruned.marker dir pheno_dir

major file path doubcom table pheno_variant_subset_clean_all_vcf_file=@pheno_variant_subset.clean.all.vcf.gz dir pheno_variant_subset_dir disp ".clean.all.vcf" parent cat_pheno_variant_subset_plink_seq_data class_level pheno_variant_subset comment "Clean VCF file with all variants for pheno_variant_subset"

!!expand:,:type:in:in_range:out:log! \
file path pheno_sample_marker_ld_prune_type_file=$pheno_sample_marker_plink_file.prune.type dir pheno_dir disp ".prune.type" parent cat_pheno_plink_pruned_marker_data class_level pheno comment "Result of LD pruning at pheno level --- prune.type file"

!!expand:ext:bed:bim:fam! \
file path pheno_sample_pruned_marker_ext_file=$pheno_sample_pruned_marker_plink_file.ext dir pheno_dir disp ".ext" parent cat_pheno_plink_pruned_marker_data class_level pheno comment "Already LD pruned filtered sample marker plink file, projected to include only samples with non missing phenotype --- ext file"

minor file path pheno_sample_pruned_marker_make_bed_log_file=$pheno_sample_pruned_marker_plink_file.make_bed.log dir pheno_dir disp ".make_bed.log" parent cat_pheno_plink_pruned_marker_data class_level pheno comment "Log file for make-bed command"

!!expand:,:keyt,extt,descript:initial_,initial.,-- individuals not necessarily sorted:,,! \
file path pheno_sample_marker_pruned_keytvcf_file=$pheno_sample_pruned_marker_plink_file.exttvcf.gz dir pheno_dir disp ".pruned.exttvcf.gz" parent cat_pheno_plink_pruned_marker_data class_level pheno comment "Marker vcf file for pheno samples, LD pruned descript"

file path pheno_sample_pruned_marker_recode_vcf_log_file=$pheno_sample_pruned_marker_plink_file.pruned.recode_vcf.log dir pheno_dir disp ".pruned.recode_vcf.log" parent cat_pheno_plink_pruned_marker_data class_level pheno comment "Log file for make bed cmd"

pheno_sample_for_pca_plink_file=@pheno.for.pca dir pheno_dir

file path pheno_sample_for_pca_map_file=$pheno_sample_for_pca_plink_file.map dir pheno_dir disp ".for_pca.map" parent cat_pheno_plink_pruned_marker_data class_level pheno comment "Map from ID in file to FID/IID"

!!expand:ext:bed:bim:fam! \
file path pheno_sample_for_pca_ext_file=$pheno_sample_for_pca_plink_file.ext dir pheno_dir disp ".for_pca.ext" parent cat_pheno_plink_pruned_marker_data class_level pheno comment "Use this file for PCA; could contain additional samples if requested outside of project --- ext file"

minor file path pheno_sample_for_pca_make_bed_log_file=$pheno_sample_for_pca_plink_file.make_bed.log dir pheno_dir disp ".make_bed.log" parent cat_pheno_plink_pruned_marker_data class_level pheno comment "Log file for make-bed command"


pheno_sample_combined_plink_file=@pheno.sample.combined dir pheno_dir
!!expand:ext:bed:bim:fam! \
file path pheno_sample_combined_ext_file=$pheno_sample_combined_plink_file.ext dir pheno_dir disp ".ext" parent cat_pheno_plink_combined_data class_level pheno comment "Combined seq + marker data, projected to include only samples for this phenotype --- ext file"

minor file path pheno_sample_combined_make_bed_log_file=$pheno_sample_combined_plink_file.make_bed.log dir pheno_dir disp ".make_bed.log" parent cat_pheno_plink_combined_data class_level pheno comment "Log file for make-bed command"


table file path pheno_all_marker_top_hits_file=@pheno.marker.top.hits dir pheno_dir disp ".top.hits" parent cat_pheno_top_hits_data class_level pheno comment "List of variants to use as top hits in downstream plots"

table file path pheno_top_hits_snp_ids_file=@pheno.top.hits.snp.ids dir pheno_dir disp ".snp.ids" parent cat_pheno_top_hits_data class_level pheno comment "List of variants in marker or seq file"

pheno_top_hits_ld_trunk=@pheno.top.hits dir pheno_dir
table file path pheno_top_hits_ld_file=$pheno_top_hits_ld_trunk.ld dir pheno_dir disp ".ld" parent cat_pheno_top_hits_data class_level pheno comment "List of variants in LD with top hits"

minor file path pheno_top_hits_ld_log_file=@pheno.top.hits.ld.log dir pheno_dir disp ".ld.log" parent cat_pheno_top_hits_data class_level pheno comment "List of variants in LD with top hits -- log file"

table file path pheno_top_hits_ld_chr_pos_list=$pheno_top_hits_ld_trunk.ld.chr_pos.list dir pheno_dir disp ".ld.chr_pos.list" parent cat_pheno_top_hits_data class_level pheno comment "List of chr pos in LD with top hits"

table file path pheno_top_hits_ld_seq_var_list=$pheno_top_hits_ld_trunk.ld.seq_var.list dir pheno_dir disp ".ld.seq_var.list" parent cat_pheno_top_hits_data class_level pheno comment "List of seq variant ids in LD with top hits"

!!expand:pheno:pheno:pheno_variant_subset! \
table file path pheno_test_missing_file=$pheno_plink_file.missing dir pheno_dir disp ".missing" parent cat_pheno_variant_qc_plink_data class_level pheno comment "Pheno specific missingness test"

!!expand:pheno:pheno:pheno_variant_subset! \
minor file path pheno_test_missing_log_file=$pheno_test_missing_file.log dir pheno_dir disp ".missing.log" parent cat_pheno_variant_qc_plink_data class_level pheno comment "Pheno specific missingness test --- log file"

!!expand:pheno:pheno:pheno_variant_subset! \
table file path pheno_hwe_file=$pheno_plink_file.hwe dir pheno_dir disp ".hwe" parent cat_pheno_variant_qc_plink_data class_level pheno comment "Pheno specific hwe test"

!!expand:pheno:pheno:pheno_variant_subset! \
minor file path pheno_hwe_log_file=$pheno_hwe_file.log dir pheno_dir disp ".hwe.log" parent cat_pheno_variant_qc_plink_data class_level pheno comment "Pheno specific hwe test --- log file"

!!expand:male:male:female! \
!!expand:pheno:pheno:pheno_variant_subset! \
pheno_male_plink_trunk=@pheno.male

!!expand:male:male:female! \
!!expand:pheno:pheno:pheno_variant_subset! \
table file path pheno_male_hwe_file=$pheno_male_plink_trunk.hwe dir pheno_dir disp ".male.hwe" parent cat_pheno_variant_qc_plink_data class_level pheno comment "Pheno specific hwe test for males"

!!expand:male:male:female! \
!!expand:pheno:pheno:pheno_variant_subset! \
minor file path pheno_male_hwe_log_file=$pheno_male_plink_trunk.hwe.log dir pheno_dir disp ".male.hwe.log" parent cat_pheno_variant_qc_plink_data class_level pheno comment "Pheno specific hwe test for males --- log file"

!!expand:pheno:pheno:pheno_variant_subset! \
table file path pheno_lmiss_file=$pheno_plink_file.lmiss dir pheno_dir disp ".lmiss" parent cat_pheno_variant_qc_plink_data class_level pheno comment "Pheno specific lmiss test"

!!expand:pheno:pheno:pheno_variant_subset! \
minor file path pheno_lmiss_log_file=$pheno_lmiss_file.log dir pheno_dir disp ".lmiss.log" parent cat_pheno_variant_qc_plink_data class_level pheno comment "Pheno specific lmiss test --- log file"

!!expand:pheno:pheno:pheno_variant_subset! \
table file path pheno_frq_file=$pheno_plink_file.frq dir pheno_dir disp ".frq" parent cat_pheno_variant_qc_plink_data class_level pheno comment "Pheno specific frq test"

!!expand:pheno:pheno:pheno_variant_subset! \
minor file path pheno_frq_log_file=$pheno_frq_file.log dir pheno_dir disp ".frq.log" parent cat_pheno_variant_qc_plink_data class_level pheno comment "Pheno specific frq test --- log file"

!!expand:pheno:pheno:pheno_variant_subset! \
table file path pheno_sex_frq_file=$pheno_plink_file.sex.frq dir pheno_dir disp ".sex.frq" parent cat_pheno_variant_qc_plink_data class_level pheno comment "Pheno specific frq test stratified by sex"

!!expand:pheno:pheno:pheno_variant_subset! \
minor file path pheno_sex_frq_log_file=$pheno_sex_frq_file.log dir pheno_dir disp ".sex.frq.log" parent cat_pheno_variant_qc_plink_data class_level pheno comment "Pheno specific frq test stratified by sex  --- log file"

!!expand:pheno:pheno:pheno_variant_subset! \
table file path pheno_multiallelic_frq_file=$pheno_plink_file.multiallelic.frq dir pheno_dir disp ".multialellic.frq" parent cat_pheno_variant_qc_plink_data class_level pheno comment "Pheno specific frq test for multialellics"

!!expand:pheno:pheno:pheno_variant_subset! \
table file path pheno_multiallelic_group_frq_file=$pheno_plink_file.multiallelic.group.frq dir pheno_dir disp ".multialellic.group.frq" parent cat_pheno_variant_qc_plink_data class_level pheno comment "Pheno specific p_missing test for multialellics"

!!expand:pheno:pheno:pheno_variant_subset! \
table file path pheno_combined_frq_file=$pheno_plink_file.combined.frq dir pheno_dir disp ".combined.frq" parent cat_pheno_variant_qc_plink_data class_level pheno comment "Pheno specific frq test, combined over multiallelics and biallelics"

table file path pheno_high_test_missing_file=$pheno_plink_file.high.missing dir pheno_dir disp ".high.missing" parent cat_pheno_variant_qc_plink_data class_level pheno comment "List of variants with low test missing p-values"

#file path pheno_strata_vdist_file=@pheno.strata.vdist dir pheno_dir disp ".strata.vdist" parent cat_pheno_variant_qc_stats_data class_level pheno comment "Dump of plinkseq v-dist -- stratified by cluster"

#file path pheno_vdist_file=@pheno.vdist dir pheno_dir disp ".vdist" parent cat_pheno_variant_qc_stats_data class_level pheno comment "Dump of plinkseq v-dist"

!!expand:pheno:pheno:pheno_variant_subset! \
table file path pheno_counts_file=@pheno.counts dir pheno_dir disp ".counts" parent cat_pheno_variant_qc_stats_data class_level pheno comment "Dump of plinkseq counts"

!!expand:pheno:pheno:pheno_variant_subset! \
table file path pheno_variant_qc_strata_vstats_summary_file=@pheno.variant.qc_strata.vstats.summary dir pheno_dir disp ".qc_strata.vstats.summary" parent cat_pheno_variant_qc_stats_data class_level pheno comment "Summary of statistics for qc_strata"

!!expand:phenol:pheno:pheno_variant_subset! \
table file path phenol_variant_qc_pheno_strata_vstats_summary_file=@phenol.variant.qc_pheno_strata.vstats.summary dir phenol_dir disp ".qc_pheno_strata.vstats.summary" parent cat_phenol_variant_qc_stats_data class_level phenol comment "Summary of statistics for qc_pheno_strata"

minor file path pheno_slide_master_ps_file=@pheno.slide.master.ps dir pheno_dir disp ".ps" parent cat_pheno_slide_master_data class_level pheno comment "Master join file of all relevant slides --- ps file"
major file path pheno_slide_master_pdf_file=@pheno.slide.master.pdf dir pheno_dir disp ".pdf" parent cat_pheno_slide_master_data class_level pheno comment "Master join file of all relevant slides --- pdf file"

minor file path pheno_slide_master_qc_ps_file=@pheno.slide.master.qc.ps dir pheno_dir disp ".qc.ps" parent cat_pheno_slide_master_data class_level pheno comment "Master join file of all relevant QC slides --- ps file"
major file path pheno_slide_master_qc_pdf_file=@pheno.slide.master.qc.pdf dir pheno_dir disp ".qc.pdf" parent cat_pheno_slide_master_data class_level pheno comment "Master join file of all relevant QC slides --- pdf file"

minor file path pheno_slide_master_assoc_ps_file=@pheno.slide.master.assoc.ps dir pheno_dir disp ".assoc.ps" parent cat_pheno_slide_master_data class_level pheno comment "Master join file of all relevant association slides --- ps file"
major file path pheno_slide_master_assoc_pdf_file=@pheno.slide.master.assoc.pdf dir pheno_dir disp ".assoc.pdf" parent cat_pheno_slide_master_data class_level pheno comment "Master join file of all relevant association slides --- pdf file"

minor file path pheno_slide_master_genes_ps_file=@pheno.slide.master.genes.ps dir pheno_dir disp ".genes.ps" parent cat_pheno_slide_master_data class_level pheno comment "Master join file of all relevant gene slides --- ps file"
major file path pheno_slide_master_genes_pdf_file=@pheno.slide.master.genes.pdf dir pheno_dir disp ".genes.pdf" parent cat_pheno_slide_master_data class_level pheno comment "Master join file of all relevant gene slides --- pdf file"

!!expand:,:ext,majmin:tex,minor:pdf,minor! \
majmin file path pheno_title_slide_ext_file=@pheno.title.ext dir pheno_dir disp "title.ext" trunk @pheno.title parent cat_pheno_slide_master_data class_level pheno comment "Master title slide --- ext file"

!!expand:titletype:qc:assoc:gene! \
!!expand:,:ext,majmin:tex,minor:pdf,minor! \
majmin file path pheno_titletype_title_slide_ext_file=@pheno.titletype.title.ext dir pheno_dir disp "titletype.title.ext" trunk @pheno.titletype.title parent cat_pheno_slide_master_data class_level pheno comment "Master titletype title slide --- ext file"


#pheno_slide_nonsense_variants_trunk=@pheno.slide.nonsense
#!!expand:filetype:tex:pdf! minor file path pheno_slide_nonsense_variants_filetype_file=$pheno_slide_nonsense_variants_trunk.filetype trunk pheno_slide_nonsense_variants_trunk dir pheno_dir disp ".nonsense.filetype" parent cat_pheno_slide_variants_data class_level pheno comment "List of nonsense variants --- filetype file"

#!!expand:variant_type:all:ns:nondb:pph! \
#!!expand:,:filetype,major_level:tex,minor:pdf,major! \
#major_level file path pheno_slide_variant_type_associated_variants_filetype_file=@pheno.slide.variant_type.associated.filetype trunk @pheno.slide.variant_type.associated dir pheno_dir disp ".variant_type.associated.filetype" parent cat_pheno_slide_variants_data class_level pheno comment "List of associated variant_type variants --- filetype file"

#!!expand:variant_type:all:ns:nondb:pph:nonsense! \
#!!expand:,:filetype,major_level:tex,minor:pdf,major! \
#major_level file path pheno_slide_variant_type_associated_genes_filetype_file=@pheno.slide.variant_type.associated.genes.filetype trunk @pheno.slide.variant_type.associated.genes dir pheno_dir disp ".variant_type.associated.filetype" parent cat_pheno_slide_genes_data class_level pheno comment "List of associated variant_type genes --- filetype file"

pheno_slide_failures_trunk=@pheno.slide.failures
file path pheno_slide_failures_tex_file=$pheno_slide_failures_trunk.tex dir pheno_dir disp ".failures.tex" parent cat_pheno_slide_coverage_data class_level pheno trunk $pheno_slide_failures_trunk comment "Sample failure table -- tex file"
major file path pheno_slide_failures_pdf_file=$pheno_slide_failures_trunk.pdf dir pheno_dir disp ".failures.pdf" parent cat_pheno_slide_coverage_data class_level pheno comment "Sample failure table -- pdf file"

major file path pheno_slide_failures_dat_file=$pheno_slide_failures_trunk.dat dir pheno_dir disp ".failures.dat" parent cat_pheno_slide_coverage_data class_level pheno comment "Sample failure table -- dat file"

major file path pheno_slide_failures_bar_pdf_file=$pheno_slide_failures_trunk.bar.pdf dir pheno_dir disp ".failures.bar.pdf" parent cat_pheno_slide_coverage_data class_level pheno comment "Sample failure table -- bar plot"

pheno_slide_cross_failures_trunk=@pheno.slide.cross.failures
file path pheno_slide_cross_failures_tex_file=$pheno_slide_cross_failures_trunk.tex dir pheno_dir disp ".cross.failures.tex" parent cat_pheno_slide_coverage_data class_level pheno trunk $pheno_slide_cross_failures_trunk comment "Sample failure table stratified by cross classification phenotypes -- tex file"
file path pheno_slide_cross_failures_pdf_file=$pheno_slide_cross_failures_trunk.pdf dir pheno_dir disp ".cross.failures.pdf" parent cat_pheno_slide_coverage_data class_level pheno comment "Sample failure table stratified by cross classification phenotypes -- pdf file"

!!expand:curpheno:case:control! \
table file path pheno_curpheno_sample_coverage_file_list=@pheno.curpheno.sample.coverage.list dir pheno_dir disp "curpheno.sample.coverage.list" parent cat_pheno_sample_coverage_data class_level pheno comment "List of sample coverage file for curphenos"

table file path pheno_sample_coverage_dat_file=@pheno.coverage.csv dir pheno_dir disp ".csv" parent cat_pheno_sample_coverage_data class_level pheno comment "Coverage for each sample stratified by phenotype value"
major file path pheno_sample_coverage_pdf_file=@pheno.coverage.pdf dir pheno_dir disp ".pdf" parent cat_pheno_sample_coverage_data class_level pheno comment "Plot of coverage for each sample stratified by phenotype"

table nohead onecol file path pheno_interesting_genes_dat_file=@pheno.interesting_genes.dat dir pheno_dir disp ".interesting_genes.dat" parent cat_pheno_interesting_info class_level pheno comment "Dat file listing genes that are interesting for this phenotype"

table nohead file path pheno_gene_sort_values_file=@pheno.gene.sort.values dir pheno_dir disp ".gene.sort.values" parent cat_pheno_interesting_info class_level pheno comment "Gene Sort positions"

meta_table file path pheno_interesting_genes_meta_file=@pheno.interesting_genes.meta dir pheno_dir disp ".interesting_genes.meta" parent cat_pheno_interesting_info class_level pheno comment "Meta file to specify interesting genes for this phenotype" meta_level gene

!!expand:dat:dat:reg! \
table nohead onecol file path pheno_interesting_variants_dat_file=@pheno.interesting_variants.dat dir pheno_dir disp ".interesting_variants.dat" parent cat_pheno_interesting_info class_level pheno comment "Dat file listing interesting variants"

file path pheno_interesting_variants_pre_meta_file=@pheno.interesting_variants.pre_meta dir pheno_dir disp ".interesting_variants.pre_meta" parent cat_pheno_interesting_info class_level pheno comment "Information for meta file to specify interesting variants for this phenotype" 

meta_table file path pheno_interesting_variants_meta_file=@pheno.interesting_variants.meta dir pheno_dir disp ".interesting_variants.meta" parent cat_pheno_interesting_info class_level pheno comment "Meta file to specify interesting variants for this phenotype" meta_level variant

!!expand:ext:tex:pdf! \
file path pheno_interesting_counts_ext_file=@pheno.interesting_counts.ext dir pheno_dir disp "interesting_counts.ext" trunk @pheno.interesting_counts parent cat_pheno_interesting_info class_level pheno comment "Counts of interesting genes/variants by burden level"

!!expand:ext:tex:pdf! \
file path pheno_pheno_test_info_ext_file=@pheno.pheno_test.info.ext dir pheno_dir disp "pheno_test.info.ext" trunk @pheno.pheno_test.info parent cat_pheno_test_info class_level pheno comment "Information on which tests were run"

table file path pheno_all_marker_snp_pvalues_file=@pheno.marker.snp.pvalues dir pheno_dir disp ".snp.pvalues" parent cat_pheno_interesting_info class_level pheno comment "List of p-values for a subset of the SNPs in the master marker file"

file path pheno_marker_initial_pheno_file=@pheno.marker.initial.pheno dir pheno_dir disp ".marker.initial.pheno" parent cat_pheno_interesting_info class_level pheno comment "Specifies phenotypes for samples in the marker file; if specified takes precedence over project_all_marker_pheno_file "

file path pheno_all_marker_assoc_sample_keep_file=@pheno.marker.assoc.keep dir pheno_dir disp ".assoc.keep" parent cat_pheno_interesting_info class_level pheno comment "Samples to keep for any association testing in all marker file; if specified takes precedence over project_all_marker_assoc_sample_keep_file"

file path pheno_marker_pheno_file=@pheno.marker.pheno dir pheno_dir disp ".marker.pheno" parent cat_pheno_interesting_info class_level pheno comment "Specifies phenotypes for samples in the marker file"

table nohead onecol file path pheno_interesting_loci_dat_file=@pheno.interesting_loci.dat dir pheno_dir disp ".interesting_loci.dat" parent cat_pheno_interesting_info class_level pheno comment "Dat file listing loci that are interesting for this phenotype"

table nohead file path pheno_loci_sort_values_file=@pheno.loci.sort.values dir pheno_dir disp ".loci.sort.values" parent cat_pheno_interesting_info class_level pheno comment "Loci sort positions"

meta_table file path pheno_interesting_loci_meta_file=@pheno.interesting_loci.meta dir pheno_dir disp ".interesting_loci.meta" parent cat_pheno_interesting_info class_level pheno comment "Meta file to specify interesting loci for this phenotype" meta_level locus

minor file path pheno_is_trait_file=@pheno.is_trait dir pheno_dir disp ".is_trait" parent cat_pheno_trait_info class_level pheno comment "Placeholder file to indicate this is a trait"

minor file path pheno_ucsc_browser_file=@pheno.ucsc.browser dir pheno_dir disp ".ucsc.browser" parent cat_pheno_trait_info class_level pheno comment "Browser information for UCSC screenshot fetching"

minor file path pheno_ucsc_tracks_file=@pheno.ucsc.tracks dir pheno_dir disp ".ucsc.tracks" parent cat_pheno_trait_info class_level pheno comment "Track information for UCSC screenshot fetching"

meta_table file path pheno_pheno_variant_qc_strata_meta_file=@pheno.pheno_variant_qc_strata.meta dir pheno_dir disp ".pheno_variant_qc_strata.meta" parent cat_pheno_subset_info class_level pheno comment "Meta file to load in pheno_variant_qc_strata instances" meta_level pheno_variant_qc_strata

meta_table file path pheno_pheno_variant_qc_pheno_strata_meta_file=@pheno.pheno_variant_qc_pheno_strata.meta dir pheno_dir disp ".pheno_variant_qc_pheno_strata.meta" parent cat_pheno_subset_info class_level pheno comment "Meta file to load in pheno_variant_qc_pheno instances" meta_level pheno_variant_qc_pheno_strata

meta_table file path pheno_pheno_variant_subset_meta_file=@pheno.pheno_variant_subset.meta dir pheno_dir disp ".pheno_variant_subset.meta" parent cat_pheno_subset_info class_level pheno comment "Meta file to load in pheno_variant_subsets" meta_level pheno_variant_subset

meta_table file path pheno_pheno_sample_subset_meta_file=@pheno.pheno_sample_subset.meta dir pheno_dir disp ".pheno_sample_subset.meta" parent cat_pheno_subset_info class_level pheno comment "Meta file to load in pheno_sample_subsets" meta_level pheno_sample_subset

meta_table file path pheno_pheno_test_variant_subset_meta_file=@pheno.pheno_test_variant_subset.meta dir pheno_dir disp ".pheno_test_variant_subset.meta" parent cat_pheno_subset_info class_level pheno comment "Meta file to load in pheno_test_variant_subsets" meta_level pheno_test_variant_subset

file path pheno_variant_subset_region_file=@pheno_variant_subset.regions dir pheno_variant_subset_dir disp ".regions" parent cat_pheno_variant_subset_meta_data class_level pheno_variant_subset comment "Regions in gtf file to use for this subset" 

!!expand:keeptype:var_chr_pos:var:chr_pos! \
file path pheno_variant_subset_keeptype_keep_file=@pheno_variant_subset.keeptype.keep dir pheno_variant_subset_dir disp ".keeptype.keep" parent cat_pheno_variant_subset_meta_data class_level pheno_variant_subset comment "keeptype to keep in pheno_variant_subset" 

!!expand:,:pheno,category:pheno,cat_pheno_subset_info:pheno_variant_subset,cat_pheno_variant_subset_meta_data! \
table nohead file path pheno_gene_to_variant_subset_map=@pheno.gene.to.variant_subset.map dir pheno_dir disp ".gene.to.variant_subset.map" parent category class_level pheno comment "Map of pheno variant subset for each gene"

!!expand:pheno_test:pheno_test:pheno_test_variant_subset! \
mkdir path pheno_test_epacts_dir=$pheno_test_dir/epacts class_level pheno_test chmod 777

!!expand:pheno_test:pheno_test:pheno_test_variant_subset! \
table path file pheno_test_epacts_ready_file=@pheno_test.epacts.ready dir pheno_test_epacts_dir disp ".epacts.ready"  class_level pheno_test comment "Dummy file to indicate ready to run epacts"

!!expand:pheno:pheno:pheno_variant_subset! \
table path file pheno_vassoc_counts_file=@pheno.vassoc.counts dir pheno_dir disp ".vassoc.counts" parent cat_pheno_variant_assoc_data class_level pheno comment "Count information for vassoc file"

table path file pheno_test_info_file=@pheno_test.info dir pheno_test_dir disp ".info" parent cat_pheno_test_data class_level pheno_test comment "Information on test run"

onecol table path file pheno_test_sample_include_file=@pheno_test.sample.include dir pheno_test_dir disp "sample.include" parent cat_pheno_test_data class_level pheno_test comment "Specify special list of samples to include (intersected with popgen+)"

table path file pheno_test_sample_include_aux_file=@pheno_test.sample.include.aux dir pheno_test_dir disp "sample.include.aux" parent cat_pheno_test_data class_level pheno_test comment "Auxiliary file used to implement pheno_test_sample_include_file; could be either samples to include or exclude, depending on the software used."

table path file pheno_test_alternate_pheno_file=@pheno_test.alternate.pheno dir pheno_test_dir disp "alternate.pheno" parent cat_pheno_test_data class_level pheno_test comment "Specify alternate list of phenotypes"

table path file pheno_test_extra_covars_file=@pheno_test.extra.covars dir pheno_test_dir disp "extra.covars" parent cat_pheno_test_data class_level pheno_test comment "Specify special list of extra covariates (intersected with popgen+)"

table path file pheno_test_variable_covars_file=@pheno_test.variable.covars dir pheno_test_dir disp "variable.covars" parent cat_pheno_test_data class_level pheno_test comment "Extra covars that are variable"

table path file pheno_test_covars_aux_file=@pheno_test.covars.aux dir pheno_test_dir disp ".covars.aux" parent cat_pheno_test_data class_level pheno_test comment "Auxiliary file used to implement pheno_test_extra_covars_file; could be whatever format accepted by the testing software."

!!expand:pheno_test:pheno_test:pheno_test_variant_subset! \
!!expand:num:1:2:3:4! \
path file pheno_test_in_auxnum_file=@pheno_test.in.auxnum dir pheno_test_dir disp ".in.auxnum" parent cat_pheno_test_data class_level pheno_test comment "Auxilary input file num for this test"

!!expand:pheno_test:pheno_test:pheno_test_variant_subset! \
!!expand:num:1! \
path file pheno_test_out_auxnum_file=@pheno_test.out.auxnum dir pheno_test_dir disp ".out.auxnum" parent cat_pheno_test_data class_level pheno_test comment "Auxilary output file num for this test"

!!expand:pheno_test:pheno_test:pheno_test_variant_subset! \
doubcom table path file pheno_test_vassoc_file=@pheno_test.vassoc dir pheno_test_dir disp ".vassoc" parent cat_pheno_test_data class_level pheno_test comment "Single variant associations"

!!expand:pheno_test:pheno_test:pheno_test_variant_subset! \
table path file pheno_test_small_vassoc_file=@pheno_test.small.vassoc dir pheno_test_dir disp ".small.vassoc" parent cat_pheno_test_data class_level pheno_test comment "Single variant association; cleaned and with reduced set of columns for joining"

table path file pheno_test_clean_include_file=@pheno_test.clean.include dir pheno_test_dir disp ".clean.include" parent cat_pheno_test_data class_level pheno_test comment "Variants to include to make pheno_test_clean_small_vassoc_file"

path file pheno_test_lambda_file=@pheno_test.lambda dir pheno_test_dir disp ".lambda" parent cat_pheno_test_data class_level pheno_test comment "Lambda value to apply for GC correction"

!!expand:pheno_test:pheno_test:pheno_test_variant_subset! \
table path file pheno_test_clean_small_vassoc_file=@pheno_test.clean.small.vassoc dir pheno_test_dir disp ".clean.small.vassoc" parent cat_pheno_test_data class_level pheno_test comment "Vassoc files with variants excluded and optional GC correction applied"

#!!expand:pheno_test:pheno_test:pheno_test_variant_subset! \
#table path file pheno_test_small_full_vassoc_file=@pheno_test.small.full.vassoc dir pheno_test_dir disp ".small.full.vassoc" parent cat_pheno_test_data class_level pheno_test comment "Small vassoc file filled with NA for variants not output by test for some reason"

!!expand:pheno_test:pheno_test:pheno_test_variant_subset! \
pheno_test_vassoc_epacts_trunk=@pheno_test.epacts dir pheno_test_epacts_dir

!!expand:pheno_test:pheno_test:pheno_test_variant_subset! \
pheno_test_vassoc_plink_trunk=@pheno_test.plink dir pheno_test_dir

file path doubcom table pheno_variant_subset_gene_variant_file=@pheno_variant_subset.gene.variant.tsv dir pheno_variant_subset_dir disp ".gene.variant.tsv" parent cat_pheno_variant_subset_variant_assoc_data class_level pheno_variant_subset comment "List of gene, variant for each variant in vcf file --- link from project_variant_subset"

file path doubcom table pheno_variant_subset_clean_gene_variant_file=@pheno_variant_subset.clean.gene.variant.tsv dir pheno_variant_subset_dir disp ".clean.gene.variant.tsv" parent cat_pheno_variant_subset_variant_assoc_data class_level pheno_variant_subset comment "List of gene, variant for each variant in clean vcf file --- link from project_variant_subset"

!!expand:pheno:pheno:pheno_variant_subset! \
major table path file pheno_vassoc_pre_annot_file=@pheno.vassoc.pre.annot dir pheno_dir disp ".vassoc.pre.annot" parent cat_pheno_variant_assoc_data class_level pheno comment "Annotations for variant level associations"

!!expand:pheno:pheno:pheno_variant_subset! \
major table path file pheno_vassoc_annot_file=@pheno.vassoc.annot dir pheno_dir disp ".vassoc.annot" parent cat_pheno_variant_assoc_data class_level pheno comment "Variant level associations dumped by pseq --- with additional annotations"

table path file pheno_vassoc_clean_include_file=@pheno.vassoc.clean.include dir pheno_dir disp ".vassoc.clean.include" parent cat_pheno_variant_assoc_data class_level pheno comment "Variants that pass clean vassoc filters"

major table path file pheno_vassoc_clean_annot_file=@pheno.vassoc.clean.annot dir pheno_dir disp ".vassoc.clean.annot" parent cat_pheno_variant_assoc_data class_level pheno comment "Associations after filters applied"

major table path file pheno_small_vassoc_annot_file=@pheno.small.vassoc.annot dir pheno_dir disp ".small.vassoc.annot" parent cat_pheno_variant_assoc_data class_level pheno comment "Vassoc file with smaller set of columns"

!!expand:ctype:all:meta! \
table path file pheno_ctype_trait_vassoc_annot_file=@pheno.ctype_trait.vassoc.annot dir pheno_dir disp ".vassoc.ctype_trait.annot" parent cat_pheno_variant_assoc_data class_level pheno comment "Basic association data for this trait and ctype related traits"

#!!expand:type:all:ns:nondb:pph! \
#major path file pheno_type_vassoc_qq_pdf_file=@pheno.type.vassoc.pdf dir pheno_dir disp ".type.vassoc.pdf" parent cat_pheno_variant_assoc_data class_level pheno comment "Variant level associations dumped by pseq --- qq-plot for type variants"

!!expand:impute_type:hap:traditional! \
path file pheno_imputation_impute_type_gene_list_file=@pheno.impute_type.gene.list dir pheno_dir disp ".impute_type.gene.list" parent cat_pheno_variant_imputation_data class_level pheno comment "List of files that will be merged to make pheno_imputation_impute_type_summary_file"

path file pheno_snptest_locus_list_file=@pheno.snptest.locus.list dir pheno_dir disp ".snptest.locus.list" parent cat_pheno_variant_imputation_data class_level pheno comment "List of files that will be merged to make pheno_snptest_summary_file"


!!expand:impute_type:hap:traditional! \
major table path file pheno_imputation_impute_type_summary_file=@pheno.impute_type.summary dir pheno_dir disp ".impute_type.summary" parent cat_pheno_variant_imputation_data class_level pheno comment "Summary of imputation of all interesting variants for this phenotype --- impute_type imputation"

major table path file pheno_snptest_summary_file=@pheno.snptest.summary dir pheno_dir disp ".snptest.summary" parent cat_pheno_variant_imputation_data class_level pheno comment "Summary of snptests for all marker variants  for this phenotype --- traditional phenotype"

#file path pheno_haplotype_burden_input_list_file=@pheno.hap.burden.input.list dir pheno_dir disp ".hap.burden.input.list" parent cat_pheno_haplotype_burden_data class_level pheno comment "List of files to go into haplotype burden analysis" skip_if not_trait

#major table path file pheno_dirty_vassoc_file=@pheno.dirty.vassoc dir pheno_dir disp ".vassoc" parent cat_pheno_dirty_all_variant_assoc_data class_level pheno comment "Variant level associations dumped by pseq --- no samples or variants excluded"

#major path file pheno_dirty_vassoc_qq_pdf_file=@pheno.dirty.vassoc.qq.pdf dir pheno_dir disp ".vassoc.pdf" parent cat_pheno_dirty_all_variant_assoc_data class_level pheno comment "Variant level associations dumped by pseq --- no samples or variants excluded --- qq-plot"

#major table path file pheno_dirty_qc_pass_vassoc_file=@pheno.dirty.qc_pass.vassoc dir pheno_dir disp ".vassoc" parent cat_pheno_dirty_qc_pass_variant_assoc_data class_level pheno comment "Variant level associations dumped by pseq --- no samples or variants excluded but sites excluded"

#major path file pheno_dirty_qc_pass_vassoc_qq_pdf_file=@pheno.dirty.qc_pass.vassoc.qq.pdf dir pheno_dir disp ".vassoc.pdf" parent cat_pheno_dirty_qc_pass_variant_assoc_data class_level pheno comment "Variant level associations dumped by pseq --- no samples or variants excluded but sites excluded --- qq-plot"


#!!expand:,:lname,ldescrip:1,initial:2,most associated initial:3,most associated level1! \
#!!expand:,:type,tname:all,all:ns,nonsynonymous:nondb,nondb:pph,pph deleterious! major table path file pheno_type_levellname_gassoc_file=@pheno.type.levellname.gassoc dir pheno_dir disp ".type.levellname.gassoc" parent cat_pheno_gene_assoc_data class_level pheno comment "Gene level associations dumped by pseq for ldescrip: for tname variants"

table path file pheno_gassoc_file=@pheno.gassoc dir pheno_dir disp ".gassoc" parent cat_pheno_gene_assoc_data class_level pheno comment "Combination of all gene level associations from burden level extradescription"

major table path file pheno_flat_gassoc_file=@pheno.flat.gassoc dir pheno_dir disp ".flat.gassoc" parent cat_pheno_gene_assoc_data class_level pheno comment "Combination of all gene level associations from burden level --- with one column for each different test"

!!expand:pathwayburdentype:custom! \
doubcom major table path file pheno_pathway_pathwayburdentype_gassoc_file=@pheno.pathway.pathwayburdentype.gassoc dir pheno_dir disp ".pathway.pathwayburdentype.gassoc" parent cat_pheno_pathway_assoc_data class_level pheno comment "Combination of all pathwayburdentype pathway level associations from burden level"

#burden files

minor file path burden_slide_master_ps_file=@burden.slide.master.ps dir burden_dir disp ".ps" parent cat_burden_slide_master_data class_level burden comment "Master join file of all relevant slides --- ps file"
major file path burden_slide_master_pdf_file=@burden.slide.master.pdf dir burden_dir disp ".pdf" parent cat_burden_slide_master_data class_level burden comment "Master join file of all relevant slides --- pdf file"

!!expand:,:ext,majmin:tex,minor:pdf,minor! \
majmin file path burden_title_slide_ext_file=@burden.title.ext dir burden_dir disp "title.ext" trunk @burden.title parent cat_burden_slide_master_data class_level burden comment "Master title slide --- ext file"

!!expand:ext:tex:pdf! \
file path burden_burden_test_info_ext_file=@burden.burden_test.info.ext dir burden_dir disp "burden_test.info.ext" trunk @burden.burden_test.info parent cat_burden_info_data class_level burden comment "Information on which tests were run"

#!!expand:,:lname,ldescrip:1,initial:2,most associated initial:3,most associated level1! \
#major table path file burden_levellname_gassoc_file=@burden.levellname.gassoc dir burden_dir disp ".levellname.gassoc" parent cat_burden_association_data class_level burden comment "Gene level associations dumped by pseq for ldescrip"

#!!expand:lname:2:3! \
#table nohead onecol path file burden_levellname_gene_list_file=@burden.levellname.gene.list dir burden_dir disp ".levellname.gene.list" parent cat_burden_association_data class_level burden comment "Genes to be run at level levellname"

!!expand:burden_test:burden_test:burden_test_variant_subset! \
mkdir path burden_test_epacts_dir=$burden_test_dir/epacts class_level burden_test chmod 777

!!expand:burden_test:burden_test:burden_test_variant_subset! \
table path file burden_test_epacts_ready_file=@burden_test.epacts.ready dir burden_test_epacts_dir disp ".epacts.ready"  class_level burden_test comment "Dummy file to indicate ready to run epacts"

!!expand:direction:case_side:control_side! \
!!expand:burden_test:burden_test:burden_test_variant_subset! \
burden_test_direction_gassoc_epacts_trunk=@burden_test.direction.epacts dir burden_test_epacts_dir

table path file burden_test_info_file=@burden_test.info dir burden_test_dir disp ".info" parent cat_burden_test_info_data class_level burden_test comment "Information on test run"

onecol table path file burden_test_sample_include_file=@burden_test.sample.include dir burden_test_dir disp "sample.include" parent cat_burden_test_samp_data class_level burden_test comment "Specify special list of samples to include (intersected with popgen+)"

table path file burden_test_sample_include_aux_file=@burden_test.sample.include.aux dir burden_test_dir disp "sample.include.aux" parent cat_burden_test_samp_data class_level burden_test comment "Auxiliary file used to implement burden_test_sample_include_file; could be either samples to include or exclude, depending on the software used."

table path file burden_test_alternate_pheno_file=@burden_test.alternate.pheno dir burden_test_dir disp "alternate.pheno" parent cat_burden_test_samp_data class_level burden_test comment "Specify special alternate phenotypes"

table path file burden_test_extra_covars_file=@burden_test.extra.covars dir burden_test_dir disp "extra.covars" parent cat_burden_test_samp_data class_level burden_test comment "Specify special list of extra covariates (intersected with popgen+)"

table path file burden_test_variable_covars_file=@burden_test.variable.covars dir burden_test_dir disp "variable.covars" parent cat_burden_test_samp_data class_level burden_test comment "Extra covars that are variable"

table path file burden_test_covars_aux_file=@burden_test.covars.aux dir burden_test_dir disp ".covars.aux" parent cat_burden_test_samp_data class_level burden_test comment "Auxiliary file used to implement burden_test_extra_covars_file; could be whatever format accepted by the testing software."

!!expand:burden_test:burden_test:burden_test_variant_subset! \
!!expand:num:1:2! \
path file burden_test_in_auxnum_file=@burden_test.in.auxnum dir burden_test_dir disp ".in.auxnum" parent cat_burden_test_input_association_data class_level burden_test comment "Auxilary input file num for this test"

!!expand:burden_test:burden_test:burden_test_variant_subset! \
!!expand:num:1! \
path file burden_test_out_auxnum_file=@burden_test.out.auxnum dir burden_test_dir disp ".out.auxnum" parent cat_burden_test_association_data class_level burden_test comment "Auxilary output file num for this test"

table path file burden_chr_pos_exclude_file=@burden.chr.pos.exclude dir burden_dir disp "chr.pos.exclude" parent cat_burden_var_data class_level burden comment "Specify two columns (chr, pos) to exclude from burden tests"

!!expand:burden_test:burden_test:burden_test_variant_subset! \
!!expand:direction:case_side:control_side! \
doubcom major table path file burden_test_direction_gassoc_file=@burden_test.direction.gassoc dir burden_test_dir disp ".direction.gassoc" parent cat_burden_test_association_data class_level burden_test comment "Gene level associations; for direction" 

!!expand:burden:burden:burden_variant_subset! \
major table path file burden_gassoc_counts_data_file=@burden.gassoc.counts.data dir burden_dir disp ".gassoc.counts.data" parent cat_burden_association_display_data class_level burden comment "Raw associations; input to display variant counts in tables" 

major table path file burden_gassoc_counts_file=@burden.gassoc.counts dir burden_dir disp ".gassoc.counts" parent cat_burden_association_display_data class_level burden comment "Gene level associations; for displaying variant counts in tables" 

major table path file burden_gassoc_file=@burden.gassoc dir burden_dir disp ".gassoc" parent cat_burden_association_test_data class_level burden comment "Gene level associations; aggregate of all tests" 

!!expand:burden_test:burden_test:burden_test_variant_subset! \
doubcom major table path file burden_test_gassoc_file=@burden_test.gassoc dir burden_test_dir disp ".gassoc" parent cat_burden_test_association_data class_level burden_test comment "Gene level associations" 

major table path file burden_test_small_gassoc_file=@burden_test.small.gassoc dir burden_test_dir disp ".small.gassoc" parent cat_burden_test_association_data class_level burden_test comment "Gene level associations with essential columns and uniform format across software" 

major table path file burden_gassoc_file=@burden.gassoc dir burden_dir disp ".gassoc" parent cat_burden_association_test_data class_level burden comment "Gene level associations" 

#!!expand:burden:burden:burden_variant_subset! \
#table path file burden_qt_gassoc_file=@burden.qt.gassoc dir burden_dir disp ".qt.gassoc" parent cat_burden_association_data class_level burden comment "Gene level associations for full distribution of QT (if applicable)" 

#!!expand:burden:burden:burden_variant_subset! \
#path file burden_qt_gassoc_qq_file=@burden.qt.gassoc.qq.pdf dir burden_dir disp ".qt.gassoc.qq.pdf" parent cat_burden_association_data class_level burden comment "QQ plot Gene level associations for full distribution of QT (if applicable)" 

major table path file burden_flat_gassoc_file=@burden.flat.gassoc dir burden_dir disp ".flat.gassoc" parent cat_burden_association_test_data class_level burden comment "Gene level associations --- gassoc file flattened to have one line per gene and different columns for different tests"

nohead onecol table path file burden_interesting_variant_genes_dat_file=@burden.interesting_variant_genes.dat dir burden_dir disp ".interesting_variant_genes.dat" parent cat_burden_interesting_data class_level burden comment "Interesting genes according to variants filtered by this burden test"

nohead onecol table path file burden_interesting_genes_dat_file=@burden.interesting_genes.dat dir burden_dir disp ".interesting_genes.dat" parent cat_burden_interesting_data class_level burden comment "Interesting genes according to this burden test"

meta_table file path burden_interesting_gene_burdens_meta_file=@burden.interesting_gene_burdens.meta dir burden_dir disp ".interesting_gene_burdens.meta" parent cat_burden_interesting_data class_level burden comment "Meta file to specify interesting gene burdens for this burden" meta_level gene_burden

nohead onecol table path file burden_interesting_gene_variants_dat_file=@burden.interesting_gene_variants.dat dir burden_dir disp ".interesting_gene_variants.dat" parent cat_burden_interesting_data class_level burden comment "Interesting variants within interesting genes"

nohead onecol table path file burden_all_interesting_gene_variants_dat_file=@burden.all.interesting_gene_variants.dat dir burden_dir disp ".all.interesting_gene_variants.dat" parent cat_burden_interesting_data class_level burden comment "All variants within interesting genes"

nohead table path file burden_gene_sort_values_file=@burden.gene.sort.values dir burden_dir disp ".gene.sort.values" parent cat_burden_interesting_data class_level burden comment "Sort values for each gene based on this burden level"
minor path file annot_manual_variant_list_file=@annot.manual.variant.list dir annot_dir disp ".manual.variant.list" parent cat_annot_var_data class_level annot comment "List of variants within this annot grouping --- can specify this by hand for custom set"

minor path file annot_manual_gene_list_file=@annot.manual.gene.list dir annot_dir disp ".manual.gene.list" parent cat_annot_var_data class_level annot comment "List of genes within this annot grouping --- can specify this by hand for custom set"

minor path file annot_manual_gene_variant_list_file=@annot.manual.gene.variant.list dir annot_dir disp ".manual.gene.variant.list" parent cat_annot_var_data class_level annot comment "List of genes within this annot grouping --- can specify this by hand for custom set"

!!expand:annotl:annot:annot_variant_subset! \
path file annotl_annot_variant_list_file=@annotl.annot.variant.list dir annotl_dir disp ".annot.variant.list" parent cat_annotl_var_data class_level annotl comment "List of variants within this annot grouping, according to annotations specified at the gene level"

path file burden_only_interesting_variant_list_file=@burden.only_interesting.variant.list dir burden_dir disp ".only_interesting.variant.list" parent cat_burden_var_data class_level burden comment "List of variants in interesting genes; includes ALL variants"

path file annot_variant_exclude_detail_file=@annot.variant.exclude.detail dir annot_dir disp ".variant.exclude.detail" parent cat_annot_var_data class_level annot comment "Extra variants to exclude with filters; with metrics"

path file annot_variant_exclude_file=@annot.variant.exclude dir annot_dir disp ".variant.exclude" parent cat_annot_var_data class_level annot comment "Extra variants to exclude with filters"

!!expand:burden:burden:burden_variant_subset:annot:annot_variant_subset! \
path file burden_non_annot_variant_list_file=@burden.non_annot.variant.list dir burden_dir disp ".non_annot.variant.list" parent cat_burden_var_data class_level burden comment "List of variants within this burden grouping, according to additional freq/etc. thresholds that are not annotation based"

!!expand:burden:burden:burden_variant_subset:annot:annot_variant_subset! \
path file burden_all_variant_list_file=@burden.all.variant.list dir burden_dir disp ".all.variant.list" parent cat_burden_var_data class_level burden comment "List of variants within this burden grouping. Annotations are at the gene level"

!!expand:burden:burden:burden_variant_subset! \
path file burden_idex_file=@burden.id.ex dir burden_dir disp ".id.ex" parent cat_burden_var_data class_level burden comment "List of variants to exclude from this burden"

!!expand:burden:burden:burden_variant_subset! \
path file burden_regex_file=@burden.reg.ex dir burden_dir disp ".reg.ex" parent cat_burden_var_data class_level burden comment "List of variants to exclude from this burden"

!!expand:annot:annot:annot_variant_subset! \
path file annot_locdb_detail_reg_file=@annot.locdb.detail.reg dir annot_dir disp ".locdb.detail.reg" parent cat_annot_var_data class_level annot comment "Details about grouping of variants by gene/transcript"

!!expand:burden:burden:burden_variant_subset! \
path file burden_locdb_detail_reg_file=@burden.locdb.detail.reg dir burden_dir disp ".locdb.detail.reg" parent cat_burden_var_data class_level burden comment "Details about grouping of variants by gene/transcript"

!!expand:burden:burden:burden_variant_subset! \
path file burden_locdb_reg_file=@burden.locdb.reg dir burden_dir disp ".locdb.reg" parent cat_burden_var_data class_level burden comment "Input file to load into locdb --- annotations at both the gene and transcript level"

!!expand:burden:burden:burden_variant_subset! \
path file burden_reg_file=@burden.reg dir burden_dir disp ".reg" parent cat_burden_var_data class_level burden comment "Input file to load into locdb --- annotations at both the gene and transcript level"

!!expand:burden:burden:burden_variant_subset! \
path file burden_locdb_file=@burden.locdb dir burden_dir disp ".locdb" parent cat_burden_var_data class_level burden comment "Custom locdb for this mask"

!!expand:burden:annot:annot_variant_subset:burden:burden_variant_subset! \
path file burden_setid_file=@burden.SetID dir burden_dir disp ".SetID" parent cat_burden_var_data class_level burden comment "SetID file for meta-skat"

!!expand:burden:annot:annot_variant_subset:burden:burden_variant_subset! \
path file burden_epacts_group_file=@burden.epacts.group dir burden_dir disp ".epacts.group" parent cat_burden_var_data class_level burden comment "Group file for EPACTs"

!!expand:pathwayburdentype:custom! \
file path burden_pathway_pathwayburdentype_locdb_file=pathway.pathwayburdentype.locdb dir burden_dir disp "pathway.pathwayburdentype.locdb" parent cat_burden_pathway_association_data class_level burden comment "Plink/Seq locdb file for use in pathway burden testing --- for pathwayburdentype locsets"

!!expand:pathwayburdentype:custom! \
burden_test_pathway_pathwayburdentype_gassoc_epacts_trunk=@burden_test.pathway.pathwayburdentype.epacts dir burden_test_epacts_dir

!!expand:burden:burden:annot! \
!!expand:pathwayburdentype:custom! \
file path burden_pathway_pathwayburdentype_epacts_group_file=pathway.pathwayburdentype.epacts.group dir burden_dir disp "pathway.pathwayburdentype.epacts.group" parent cat_burden_pathway_association_data class_level burden comment "EPACTS group file for use in pathway burden testing --- for pathwayburdentype locsets"

path file burden_clean_variant_list_file=@burden.clean.variant.list dir burden_dir disp ".clean.variant.list" parent cat_burden_var_data class_level burden comment "List of variants within this burden grouping (annotations at the gene level) --- includes only those that pass clean vassoc"

#!!expand:burden:burden:burden_variant_subset! \
#table file path burden_score_seq_map_file=@burden.score_seq.map dir burden_dir disp ".score_seq.map" parent cat_burden_var_data class_level burden comment "Map file for SCORE-Seq"

!!expand:freqtype:common:uncommon:rare! \
major path file burden_freqtype_vassoc_qq_pdf_file=@burden.freqtype.vassoc.qq.pdf dir burden_dir disp ".freqtype.vassoc.qq.pdf" parent cat_burden_summary_data class_level burden comment "Variant level associations dumped by pseq for this burden grouping --- qq-plot of freqtype variants"

major path file burden_gassoc_qq_pdf_file=@burden.gassoc.qq.pdf dir burden_dir disp ".gassoc.qq.pdf" parent cat_burden_summary_data class_level burden comment "Gene level associations dumped by pseq for this burden grouping --- qq-plot"

burden_slide_common_vassoc_trunk=@burden.slide.common.vassoc

!!expand:,:filetype,weblevel:tex,minor:pdf,major! \
weblevel file path burden_slide_common_vassoc_filetype_file=$burden_slide_common_vassoc_trunk.filetype trunk burden_slide_common_vassoc_trunk dir burden_dir disp ".slide.common.vassoc.filetype" parent cat_burden_summary_data class_level burden comment "List of top associated variants under this burden grouping --- filetype file"

burden_slide_vassoc_trunk=@burden.slide.vassoc

!!expand:,:filetype,weblevel:tex,minor:pdf,major! \
weblevel file path burden_slide_vassoc_filetype_file=$burden_slide_vassoc_trunk.filetype trunk burden_slide_vassoc_trunk dir burden_dir disp ".slide.vassoc.filetype" parent cat_burden_summary_data class_level burden comment "List of top associated variants under this burden grouping --- filetype file"

burden_slide_unique_trunk=@burden.slide.unique

!!expand:,:filetype,weblevel:tex,minor:pdf,major! \
weblevel file path burden_slide_unique_filetype_file=$burden_slide_unique_trunk.filetype trunk burden_slide_unique_trunk dir burden_dir disp ".slide.unique.filetype" parent cat_burden_summary_data class_level burden comment "List of top associated variants under this burden grouping --- filetype file"


burden_slide_common_vassoc_meta_trait_trunk=@burden.slide.common.vassoc.meta_trait

!!expand:,:filetype,weblevel:tex,minor:pdf,major! \
weblevel file path burden_slide_common_vassoc_meta_trait_filetype_file=$burden_slide_common_vassoc_meta_trait_trunk.filetype trunk burden_slide_common_vassoc_meta_trait_trunk dir burden_dir disp ".slide.common.vassoc.meta_trait.filetype" parent cat_burden_summary_data class_level burden comment "List of top associated variants under this burden grouping --- filetype file"

burden_slide_vassoc_meta_trait_trunk=@burden.slide.vassoc.meta_trait

!!expand:,:filetype,weblevel:tex,minor:pdf,major! \
weblevel file path burden_slide_vassoc_meta_trait_filetype_file=$burden_slide_vassoc_meta_trait_trunk.filetype trunk burden_slide_vassoc_meta_trait_trunk dir burden_dir disp ".slide.vassoc.meta_trait.filetype" parent cat_burden_summary_data class_level burden comment "List of top associated variants under this burden grouping --- filetype file"

burden_slide_unique_meta_trait_trunk=@burden.slide.unique.meta_trait

!!expand:,:filetype,weblevel:tex,minor:pdf,major! \
weblevel file path burden_slide_unique_meta_trait_filetype_file=$burden_slide_unique_meta_trait_trunk.filetype trunk burden_slide_unique_meta_trait_trunk dir burden_dir disp ".slide.unique.meta_trait.filetype" parent cat_burden_summary_data class_level burden comment "List of top associated variants under this burden grouping --- filetype file"

burden_slide_gassoc_trunk=@burden.slide.gassoc
!!expand:,:filetype,weblevel:tex,minor:pdf,major! \
weblevel file path burden_slide_gassoc_filetype_file=$burden_slide_gassoc_trunk.filetype trunk burden_slide_gassoc_trunk dir burden_dir disp ".slide.gassoc.filetype" parent cat_burden_summary_data class_level burden comment "List of top associated genes under this burden grouping --- filetype file"

#table file path burden_sample_list_file=@burden.sample.list dir burden_dir disp ".sample.list" parent cat_burden_summary_data class_level burden comment "List of samples who have variants for this burden"

#table file path burden_sample_without_list_file=@burden.sample.without.list dir burden_dir disp ".sample.without.list" parent cat_burden_summary_data class_level burden comment "List of samples who do not have variants for this burden"

#major file path burden_pheno_pdf_file=@burden.pheno.pdf dir burden_dir disp ".pheno.pdf" parent cat_burden_summary_data class_level burden comment "Plot of phenotypes for samples with and without variant"

!!expand:pathwayburdentype:custom! \
major table path file burden_pathway_pathwayburdentype_gassoc_file=@burden.pathway.pathwayburdentype.gassoc dir burden_dir disp ".pathwayburdentype.gassoc" parent cat_burden_pathway_association_data class_level burden comment "Pathway level pathwayburdentype associations"

!!expand:pathwayburdentype:custom! \
doubcom major table path file burden_test_pathway_pathwayburdentype_gassoc_file=@burden_test.pathway.pathwayburdentype.gassoc dir burden_test_dir disp ".pathwayburdentype.gassoc" parent cat_burden_test_pathway_association_data class_level burden_test comment "Pathway level pathwayburdentype associations"

meta_table file path annot_annot_variant_subset_meta_file=@annot.annot_variant_subset.meta dir annot_dir disp ".annot_variant_subset.meta" parent cat_annot_subset_info class_level annot comment "Meta file to load in annot_variant_subsets" meta_level annot_variant_subset

meta_table file path burden_burden_variant_subset_meta_file=@burden.burden_variant_subset.meta dir burden_dir disp ".burden_variant_subset.meta" parent cat_burden_subset_info class_level burden comment "Meta file to load in burden_variant_subsets" meta_level burden_variant_subset

meta_table file path burden_burden_test_variant_subset_meta_file=@burden.burden_test_variant_subset.meta dir burden_dir disp ".burden_test_variant_subset.meta" parent cat_burden_subset_info class_level burden comment "Meta file to load in burden_test_variant_subsets" meta_level burden_test_variant_subset


#!!expand:,:name,ext,weblevel:locus_level,locus.level,table:sum,sum,table:pdf,pdf,:rv,rv,table:recessive,recessive,! \
#weblevel file path burden_haplotype_burden_name_file=@burden.hap.burden.ext dir burden_dir disp ".hap.burden.ext" parent cat_burden_haplotype_burden_data class_level burden comment "Tabular output of haplotype specific burden calculations --- name file"

#region or locus files


!!expand:rorl:region:locus! \
path rorl_all_marker_plink_file=@rorl.all.marker dir rorl_dir
!!expand:rorl:region:locus! \
!!expand:ext:bed:bim:fam:tfam:tped! \
file path rorl_all_marker_ext_file=$rorl_all_marker_plink_file.ext dir rorl_dir disp ".ext" parent cat_rorl_ped_all_marker_data class_level rorl comment "Entire project marker file projected to contain only SNPs around this rorl (filtering snps with low CR) --- ext file"
!!expand:rorl:region! \
file path rorl_all_marker_make_bed_log_file=${rorl_all_marker_plink_file}.make_bed.log dir rorl_dir disp ".make_bed.log" parent cat_rorl_ped_all_marker_data class_level rorl comment "Log file for construction of rorl_all_marker_plink_data"
!!expand:rorl:region! \
file path rorl_all_marker_recode_log_file=${rorl_all_marker_plink_file}.recode.log dir rorl_dir disp ".recode.log" parent cat_rorl_ped_all_marker_data class_level rorl comment "Log file for construction of rorl_all_marker_plink_data"


file path region_all_marker_freq_file=${region_all_marker_plink_file}.frq dir region_dir disp ".frq" parent cat_region_ped_all_marker_data class_level region comment "Frequencies for SNPs"
file path region_all_marker_freq_log_file=${region_all_marker_plink_file}.frq.log dir region_dir disp ".frq.log" parent cat_region_ped_all_marker_data class_level region comment "Frequencies for SNPs"
file path region_rare_marker_snp_list=@region.rare.snp.list dir region_dir disp ".rare.snp.list" parent cat_region_ped_common_marker_data class_level region comment "List of rare SNPs"

!!expand:rorl:region:locus! \
path rorl_common_marker_plink_file=@rorl.common.marker dir rorl_dir
!!expand:rorl:region:locus! \
!!expand:ext:tped:tfam! \
file path rorl_common_marker_ext_file=$rorl_common_marker_plink_file.ext dir rorl_dir disp ".ext" parent cat_rorl_ped_common_marker_data class_level rorl comment "Filtering out rare SNPs from all_marker_file --- ext file"
!!expand:rorl:region! \
file path rorl_common_marker_recode_log_file=${rorl_common_marker_plink_file}.recode.log dir rorl_dir disp ".recode.log" parent cat_rorl_ped_common_marker_data class_level rorl comment "Log file for construction of rorl_common_marker_plink_data"

!!expand:rorl:region:locus! \
path rorl_all_seq_plink_file=@rorl.all.seq dir rorl_dir
!!expand:rorl:region:locus! \
!!expand:ext:bed:bim:fam:tfam:tped! \
file path rorl_all_seq_ext_file=$rorl_all_seq_plink_file.ext dir rorl_dir disp ".ext" parent cat_rorl_ped_all_seq_data class_level rorl comment "All SNPs called in sequencing --- ext file"
!!expand:rorl:region! \
file path rorl_all_seq_make_bed_log_file=${rorl_all_seq_plink_file}.make_bed.log dir rorl_dir disp ".make_bed.log" parent cat_rorl_ped_all_seq_data class_level rorl comment "Log file for construction of rorl_all_seq_plink_data"
!!expand:rorl:region! \
file path rorl_all_seq_recode_log_file=${rorl_all_seq_plink_file}.recode.log dir rorl_dir disp ".recode.log" parent cat_rorl_ped_all_seq_data class_level rorl comment "Log file for construction of rorl_all_seq_plink_data"


!!expand:rorl:region:locus! \
path rorl_non_marker_seq_plink_file=@rorl.non.marker.seq dir rorl_dir
!!expand:rorl:region:locus! \
!!expand:ext:bed:bim:fam! \
file path rorl_non_marker_seq_ext_file=$rorl_non_marker_seq_plink_file.ext dir rorl_dir disp ".ext" parent cat_rorl_ped_non_marker_seq_data class_level rorl comment "SNPs called in sequencing but not in marker file --- ext file"
!!expand:rorl:region! \
file path rorl_non_marker_seq_make_bed_log_file=${rorl_non_marker_seq_plink_file}.make_bed.log dir rorl_dir disp ".make_bed.log" parent cat_rorl_ped_non_marker_seq_data class_level rorl comment "Log file for construction of non_markerseq_plink_data"
!!expand:rorl:region:locus! \
file path rorl_duplicate_marker_names_file=@rorl.duplicate.marker.names dir rorl_dir disp ".duplicate.marker.names" parent cat_rorl_ped_non_marker_seq_data class_level rorl comment "List of variants that occur in both marker and non marker plink files"

!!expand:rorl:region:locus! \
path rorl_combined_plink_file=@rorl.combined dir rorl_dir
!!expand:rorl:region:locus! \
!!expand:ext:tped:tfam:ped:map! \
file path rorl_combined_ext_file=$rorl_combined_plink_file.ext dir rorl_dir disp ".ext" parent cat_rorl_ped_combined_data class_level rorl comment "Merged marker and seq data --- if conflicts, taking marker files"
!!expand:rorl:region:locus! \
file path rorl_combined_haploview_ped_file=$rorl_combined_plink_file.haploview.ped dir rorl_dir disp ".haploview.ped" parent cat_rorl_ped_combined_data class_level rorl comment "Switch pheno from -9 to 0 to respect haploview conventions"

!!expand:rorl:region:locus! \
table nohead file path rorl_haploview_info_file=@rorl.haploview.info dir rorl_dir disp ".haploview.info" parent cat_rorl_marker_association_data class_level rorl comment "Haploview info file for this rorl"
!!expand:rorl:region:locus! \
rorl_haploview_ld_trunk=@rorl.haploview dir rorl_dir

!!expand:rorl:region:locus! \
table file path rorl_haploview_ld_file=$rorl_haploview_ld_trunk.LD dir rorl_dir disp ".haploview.LD" parent cat_rorl_marker_association_data class_level rorl comment "Haploview LD values for between each pair of variants"


!!expand:rorl:region! \
file path rorl_combined_merge_log_file=${rorl_combined_plink_file}.merge.log dir rorl_dir disp ".merge.log" parent cat_rorl_ped_combined_data class_level rorl comment "Log file for construction of rorl_combined_plink_data"

!!expand:rorl:region! \
file path rorl_combined_transpose_log_file=${rorl_combined_plink_file}.transpose.log dir rorl_dir disp ".transpose.log" parent cat_rorl_ped_combined_data class_level rorl comment "Log file for construction of rorl_combined_plink_data"


!!expand:rorl:region:locus! \
minor file path rorl_range_info_file=@rorl.range.info dir rorl_dir disp ".range.info" parent cat_rorl_meta_data class_level rorl comment "The range of the rorl --- for use in ensuring that files are outdated if range ever changes"

!!expand:rorl:region! \
table path file rorl_beagle_input_file=@rorl.bgl dir rorl_dir disp ".bgl" parent cat_rorl_beagle_input_data class_level rorl comment "Input file for beagle"

!!expand:rorl:region:locus! \
!!expand:,:compression,ext,tabletype:_gz,.gz,:,,table! \
!!expand:btype:phased:gprobs! \
file tabletype path rorl_beagle_btypecompression_file=@rorl.bgl.btypeext dir rorl_dir disp ".bgl.btypeext" parent cat_rorl_beagle_output_data class_level rorl comment "Output beagle file: btypeext"

!!expand:rorl:region:locus! \
file path rorl_beagle_phased_gz_log_file=@rorl.bgl.phased.gz.log dir rorl_dir disp ".bgl.phased.gz.log" parent cat_rorl_beagle_output_data class_level rorl comment "Log file for beagle run"

!!expand:rorl:region:locus! \
file table nohead path rorl_beagle_r2_file=@rorl.bgl.r2 dir rorl_dir disp ".bgl.r2" parent cat_rorl_beagle_output_data class_level rorl comment "Output beagle file: r2"

!!expand:rorl:region:locus! \
!!expand:,:name,ext,keymod:ref_genotype,ref.gens,nohead:strand,strand,nohead:genotype,gens,nohead! \
table keymod file path rorl_combined_name_file=$rorl_combined_plink_file.ext dir rorl_dir disp ".ext" parent cat_rorl_impute2_input_data class_level rorl comment "Input for IMPUTE2 --- .ext file"

!!expand:rorl:region:locus! \
!!expand:,:name,ext,keymod:,,table nohead:_info,_info,table:_info_by_sample,_info_by_sample,table:_summary,_summary,:_warnings,_warnings,! \
file keymod path rorl_combined_impute2name_file=$rorl_combined_plink_file.impute2ext dir rorl_dir disp ".impute2ext" parent cat_rorl_impute2_output_data class_level rorl comment "Output of IMPUTE2 --- impute2ext file"

!!expand:rorl:region:locus! \
file table nohead path rorl_combined_merged_impute2_file=$rorl_combined_plink_file.merged.impute2 dir rorl_dir disp ".merged.impute2" parent cat_rorl_impute2_output_data class_level rorl comment "Merged output of impute2 with gens file; if a marker SNP was excluded from imputation because it was rare, it is in this file with its gens counts"


!!expand:rorl:locus! \
!!expand:,:name,ext,keymod:ref_sample,ref.sample,:sample,sample,! \
table keymod file path rorl_combined_name_file=$rorl_combined_plink_file.ext dir rorl_dir disp ".ext" parent cat_rorl_impute2_association_data class_level rorl comment "Input for IMPUTE2 --- .ext file"

table file path locus_combined_snptest_out_file=$locus_combined_plink_file.snptest.out dir locus_dir disp ".snptest.out" parent cat_locus_impute2_association_data class_level locus comment "Output of SNPTEST on all variants"

file path locus_combined_snptest_log_file=$locus_combined_plink_file.snptest.log dir locus_dir disp ".snptest.log" parent cat_locus_impute2_association_data class_level locus comment "Log output of SNPTEST on all variants"

minor file path locus_slide_master_ps_file=@locus.slide.master.ps dir locus_dir disp ".ps" parent cat_locus_slide_master_data class_level locus comment "Master join file of all relevant slides --- ps file"
major file path locus_slide_master_pdf_file=@locus.slide.master.pdf dir locus_dir disp ".pdf" parent cat_locus_slide_master_data class_level locus comment "Master join file of all relevant slides --- pdf file"

!!expand:,:ext,majmin:tex,minor:pdf,minor! \
majmin file path locus_title_slide_ext_file=@locus.title.ext dir locus_dir disp "title.ext" trunk @locus.title parent cat_locus_slide_master_data class_level locus comment "Master title slide --- ext file"


!!expand:curpheno:case:control! \
table file path locus_curpheno_position_coverage_file=@locus.curpheno.position.coverage.tsv dir locus_dir disp "curpheno.position.coverage.csv" parent cat_locus_coverage_data class_level locus comment "Coverage stats by position for curphenos"

table file path locus_exon_target_file=@locus.exon.target.list dir locus_dir disp ".exon.target.list" parent cat_locus_coverage_data class_level locus comment "List of all exons in the locus"

table file path locus_gene_target_file=@locus.gene.target.list dir locus_dir disp ".gene.target.list" parent cat_locus_coverage_data class_level locus comment "List of all genes in the locus"

table file path locus_var_counts_dat_file=@locus.var.counts.dat dir locus_dir disp ".var.counts.dat" parent cat_locus_association_data class_level locus comment "List of all variants in the locus with associatin and maf info"

table file path locus_burden_dat_file=@locus.burden.dat dir locus_dir disp ".burden.dat" parent cat_locus_association_data class_level locus comment "List of all burden results for all genes in the locus"

file major path locus_var_coverage_pdf_file=@locus.var.coverage.pdf dir locus_dir disp ".var.coverage.pdf" parent cat_locus_association_data class_level locus comment "Case and control coverage data + variants --- pdf file"

table file path locus_combined_association_scores_file=$locus_combined_plink_file.association.scores dir locus_dir disp ".association.scores" parent cat_locus_marker_association_data class_level locus comment "Association scores for all SNPs in marker plink file --- from pheno_all_marker_snp_pvalues_file if available, otherwise from snptest"

file path locus_top_common_marker_snp_file=@locus.top.marker.snp dir locus_dir disp ".top.marker.snp" parent cat_locus_marker_association_data class_level locus comment "The marker SNP that had the top association score among all marker SNPs"

file path locus_top_common_marker_pos_file=@locus.top.marker.pos dir locus_dir disp ".top.marker.pos" parent cat_locus_marker_association_data class_level locus comment "The marker POS that had the top association score among all marker SNPs"

locus_r2_trunk=@locus.r2 dir locus_dir
table file path locus_r2_ld_file=$locus_r2_trunk.ld dir locus_dir disp ".r2.ld" parent cat_locus_marker_association_data class_level locus comment "R2 values between top marker variant at this locus and all other variants at the locus"
file path locus_r2_ld_log_file=$locus_r2_trunk.log dir locus_dir disp ".r2.log" parent cat_locus_marker_association_data class_level locus comment "Log file for computation of R2 values between top variant at this locus and all other variants at the locus"

table file path locus_haploview_marker_ld_file=$locus_haploview_ld_trunk.marker.LD dir locus_dir disp ".haploview.marker.LD" parent cat_locus_marker_association_data class_level locus comment "Haploview LD values for between each variant and marker"

table file path locus_fancy_plot_dat_file=@locus.fancy.plot.dat dir locus_dir disp ".fancy.plot.dat" parent cat_locus_marker_association_data class_level locus comment "Input for fancy plotting at this locus"

!!expand:,:keytype,exttype,txttype:_marker,.marker, -- markers only:,,! \
file path locus_fancykeytype_plot_pdf_file=@locus.fancyexttype.plot.pdf dir locus_dir disp ".fancyexttype.plot.pdf" parent cat_locus_marker_association_data class_level locus comment "Fancy plot at this locustxttype"

table file path locus_strat_index_snp_file=@locus.strat.index.snp dir locus_dir disp ".strat.index.snp" parent cat_locus_haplotype_burden_data class_level locus comment "Stratified rare variant dosages for every variant"

table file path locus_index_geno_counts_file=@locus.index.geno.counts dir locus_dir disp ".index.geno.counts" parent cat_locus_haplotype_burden_data class_level locus comment "Counts of individuals stratified by index genotype"

table file path locus_strat_self_snp_file=@locus.strat.self.snp dir locus_dir disp ".strat.self.snp" parent cat_locus_haplotype_burden_data class_level locus comment "Count of individuals stratified by each SNP"

table file path locus_est_variance_explained_file=@locus.est.var.explained.txt dir locus_dir disp ".est.var.explained.txt" parent cat_locus_haplotype_burden_data class_level locus comment "Estimate of variance explained by each snp"

table file path locus_est_variance_explained_annot_file=@locus.est.var.explained.annot.txt dir locus_dir disp ".est.var.explained.annot.txt" parent cat_locus_haplotype_burden_data class_level locus comment "Estimate of variance explained by each snp --- annotated with additional information about each snp"

table file path locus_conditional_or_file=@locus.conditional.or.tsv dir locus_dir disp ".conditional.or.tsv" parent cat_locus_haplotype_burden_data class_level locus comment "Estimate of odds ratios after different variants are removed"

file path locus_conditional_or_pdf_file=@locus.conditional.or.pdf dir locus_dir disp ".conditional.or.pdf" parent cat_locus_haplotype_burden_data class_level locus comment "Estimate of odds ratios after different variants are removed --- pdf file"



#gene files

gene_pheno_seq_plink_file=@gene.pheno.seq dir gene_dir
!!expand:,:name,ext,keymod:bed,bed,:bim,bim,table:fam,fam,table! \
file keymod path gene_pheno_seq_name_file=$gene_pheno_seq_plink_file.ext dir gene_dir disp ".ext" parent cat_gene_plot_plink_data class_level gene comment "All Variants in gene from sequencing, in QC/Popgen/Strat+ samples --- ext file"
file path gene_pheno_seq_make_bed_log_file=${gene_pheno_seq_plink_file}.make_bed.log dir gene_dir disp ".make_bed.log" parent cat_gene_plot_plink_data class_level gene comment "Log file from projection of variants to this gene; only includes popgen/strat passed samples"

#table file path gene_vars_file=@gene.vars dir gene_dir disp ".vars" parent cat_gene_plot_data class_level gene comment "List of variants in gene --- for plotting gene"

#table file path gene_group_file=@gene.group dir gene_dir disp ".group" parent cat_gene_plot_data class_level gene comment "Grouping of variants in gene --- for plotting gene"

#major file path gene_vars_pdf_file=@gene.vars.pdf dir gene_dir disp ".vars.pdf" parent cat_gene_plot_data class_level gene comment "Plot of all variants in gene"

file path table onecol gene_variant_list_file=@gene.variant.list dir gene_dir disp ".variant.list" parent cat_gene_meta_data class_level gene comment "Variants in this gene"

file path table gene_all_annot_file=@gene.all_annot.tsv dir gene_dir disp ".all_annot.tsv" parent cat_gene_meta_data class_level gene comment "Annotations in all transcripts for this gene"

meta_table file path table gene_transcript_burdens_meta_file=@gene.transcript_burdens.meta dir gene_dir disp ".transcript_burdens.meta" parent cat_gene_annot_data class_level gene comment "Transcripts for this gene" meta_level transcript_burden

minor file path gene_ucsc_regions_file=@gene.ucsc.regions dir gene_dir disp ".ucsc.regions" parent cat_gene_annot_data class_level gene comment "Region information for UCSC screenshot fetching"

minor file path gene_ucsc_pdf_file=@gene.ucsc.pdf dir gene_dir disp ".ucsc.pdf" parent cat_gene_annot_data class_level gene comment "Region information for UCSC screenshot fetching"

!!expand:curpheno:case:control! \
table file path gene_curpheno_position_coverage_file=@gene.curpheno.position.coverage.tsv dir gene_dir disp "curpheno.position.coverage.csv" parent cat_gene_qc_data class_level gene comment "Coverage stats by position for curphenos"

file path gene_exon_target_file=@gene.exon.target.list dir gene_dir disp ".exon.target.list" parent cat_gene_qc_data class_level gene comment "Exon target file for this gene"

file major path gene_var_coverage_pdf_file=@gene.var.coverage.pdf dir gene_dir disp ".var.coverage.pdf" parent cat_gene_qc_data class_level gene comment "Case and control coverage data + variants --- pdf file"

!!expand:,:ext,weblevel:tex,:pdf,major! \
file weblevel path gene_qc_metrics_ext_file=@gene.qc_metrics.ext dir gene_dir trunk @gene.qc_metrics disp ".qc_metrics.ext" parent cat_gene_qc_data class_level gene comment "QC metric data for gene --- ext file"

path gene_all_ld_plink_file=@gene.all.ld dir gene_dir
!!expand:,:ext:ped:map:info! \
table nohead file path gene_all_ld_ext_file=$gene_all_ld_plink_file.ext dir gene_dir disp ".ext" parent cat_gene_all_ld_data class_level gene comment "Markers from Seq + LD, projected to those close to gene"
file path gene_all_ld_recode_log_file=${gene_all_ld_plink_file}.recode.log dir gene_dir disp ".recode.log" parent cat_gene_all_ld_data class_level gene comment "Log file from creation of gene_all_ld_plink_file"

path gene_all_ld_png_trunk=@gene.all dir gene_dir
#!!expand:,:ext,EXT:png,PNG:pdf,pdf! \
#major file path gene_all_ld_ext_file=$gene_all_ld_png_trunk.LD.EXT dir gene_dir disp ".ext" trunk @gene.all.ld parent cat_gene_all_ld_data class_level gene comment "Haploview plot of LD at all variants in region"


path gene_seq_ld_plink_file=@gene.seq.ld dir gene_dir
!!expand:ext:ped:map:info! \
table nohead file path gene_seq_ld_ext_file=$gene_seq_ld_plink_file.ext dir gene_dir disp ".ext" parent cat_gene_seq_ld_data class_level gene comment "Markers from Seq + LD, projected to those close to gene"
file path gene_seq_ld_recode_log_file=${gene_seq_ld_plink_file}.recode.log dir gene_dir disp ".recode.log" parent cat_gene_seq_ld_data class_level gene comment "Log file from creation of gene_seq_ld_plink_file"
path gene_seq_ld_png_trunk=@gene.seq dir gene_dir
#!!expand:,:ext,EXT:png,PNG:pdf,pdf! \
#major file path gene_seq_ld_ext_file=$gene_seq_ld_png_trunk.LD.EXT dir gene_dir disp ".ext" trunk @gene.seq.ld  parent cat_gene_seq_ld_data class_level gene comment "Haploview plot of LD at all sequence variants"

file major path gene_var_pdf_file=@gene.var.pdf dir gene_dir disp ".var.pdf" parent cat_gene_seq_assoc_data class_level gene comment "Case and control variants --- pdf file"

file major path gene_qq_pdf_file=@gene.qq.pdf dir gene_dir disp ".qq.pdf" parent cat_gene_seq_assoc_data class_level gene comment "QQ plot of variants in gene"

!!expand:,:typeofvar,ext,weblevel:,dat,table:rare_,dat,table:,pdf,major! \
file weblevel path gene_typeofvarvar_counts_ext_file=@gene.typeofvarvar_counts.ext dir gene_dir disp ".typeofvarvar_counts.ext" parent cat_gene_seq_assoc_data class_level gene comment "Associated typeofvarvariant counts --- ext file"

#!!expand:,:ext,weblevel:tex,:pdf,major! \
#file weblevel path gene_associated_ext_file=@gene.associated.ext dir gene_dir trunk @gene.associated disp ".associated.ext" parent cat_gene_seq_assoc_data class_level gene comment "Top associated variants --- ext file"

!!expand:ctype:all:meta! \
!!expand:,:ext,weblevel:tex,:pdf,major! \
file weblevel path gene_ctype_trait_associated_ext_file=@gene.ctype_trait.associated.ext dir gene_dir trunk @gene.ctype_trait.associated disp ".ctype_trait.associated.ext" parent cat_gene_seq_assoc_data class_level gene comment "Top associated variants, with ctype trait information --- ext file"


!!expand:,:ext,weblevel:tex,:pdf,major! \
file weblevel path gene_all_variants_ext_file=@gene.all.variants.ext dir gene_dir trunk @gene.all.variants disp ".all.variants.ext" parent cat_gene_seq_assoc_data class_level gene comment "All variants (whether or not passing QC), but filtered samples --- ext file"

!!expand:,:ext,weblevel:tex,:pdf,major! \
file weblevel path gene_all_data_ext_file=@gene.all.data.ext dir gene_dir trunk @gene.all.data disp ".all.data.ext" parent cat_gene_seq_assoc_data class_level gene comment "All variants and samples (whether or not passing QC) --- ext file"

!!expand:,:ext,weblevel:tex,:pdf,major! \
file weblevel path gene_gassoc_ext_file=@gene.gassoc.ext dir gene_dir trunk @gene.gassoc disp ".gassoc.ext" parent cat_gene_seq_assoc_data class_level gene comment "Counts of variants in each burden --- ext file"

minor file path gene_slide_master_ps_file=@gene.slide.master.ps dir gene_dir disp ".ps" parent cat_gene_slide_master_data class_level gene comment "Master join file of all relevant slides --- ps file"
major file path gene_slide_master_pdf_file=@gene.slide.master.pdf dir gene_dir disp ".pdf" parent cat_gene_slide_master_data class_level gene comment "Master join file of all relevant slides --- pdf file"

minor file path gene_slide_master_sum_ps_file=@gene.slide.master.sum.ps dir gene_dir disp ".sum.ps" parent cat_gene_slide_master_data class_level gene comment "Master join file of all relevant summary slides --- ps file"
major file path gene_slide_master_sum_pdf_file=@gene.slide.master.sum.pdf dir gene_dir disp ".sum.pdf" parent cat_gene_slide_master_data class_level gene comment "Master join file of all relevant summary slides --- pdf file"


!!expand:,:ext,majmin:tex,minor:pdf,minor! \
majmin file path gene_title_slide_ext_file=@gene.title.ext dir gene_dir disp ".title.ext" trunk @gene.title parent cat_gene_slide_master_data class_level gene comment "Master title slide --- ext file"

!!expand:impute_type:hap:traditional! \
table file path gene_impute_type_summary_file=@gene.impute_type.summary dir gene_dir disp ".impute_type.summary" parent cat_gene_imputation_assoc_data class_level gene comment "Summary of imputation results for all variants; impute_type method"

#gene burden and transcript burden files

!!expand:ext:ps:pdf! \
minor file path gene_burden_slide_master_ext_file=@gene_burden.slide.master.ext dir gene_burden_dir disp ".ext" parent cat_gene_burden_data class_level gene_burden comment "Master join file of all relevant slides --- ext file"

file path table gene_burden_transcript_burdens_dat_file=@gene_burden.transcript_burdens.dat dir gene_burden_dir disp ".transcript_burdens.dat" parent cat_gene_burden_data class_level gene_burden comment "Transcripts for this gene burden"

table file path transcript_burden_vassoc_annot_file=@transcript_burden.vassoc.annot dir transcript_burden_dir disp ".vassoc.annot" parent cat_transcript_burden_data class_level transcript_burden comment "Top associated variants --- with annotations specific to this transcript"

!!expand:,:ext,weblevel:tex,:pdf,major! \
file weblevel path gene_burden_vassoc_ext_file=@gene_burden.vassoc.ext dir gene_burden_dir trunk @gene_burden.vassoc disp ".vassoc.ext" parent cat_gene_burden_data class_level gene_burden comment "Top associated variants --- ext file"

file major path transcript_burden_qq_pdf_file=@transcript_burden.qq.pdf dir transcript_burden_dir disp ".qq.pdf" parent cat_transcript_burden_data class_level transcript_burden comment "QQ plot for this transcript & burden mask"

nohead table file path transcript_burden_annot_variant_list_file=@transcript_burden.annot.variant.list dir transcript_burden_dir disp ".annot.variant.list" parent cat_transcript_burden_data class_level transcript_burden comment "List of variant ids this burden based solely on annotations"

nohead table file path transcript_burden_all_variant_list_file=@transcript_burden.all.variant.list dir transcript_burden_dir disp ".all.variant.list" parent cat_transcript_burden_data class_level transcript_burden comment "List of variant ids this burden"

nohead onecol table file path transcript_burden_reg_list_file=@transcript_burden.reg.list dir transcript_burden_dir disp ".reg.list" parent cat_transcript_burden_data class_level transcript_burden comment "List of regions for this burden"

table file path transcript_burden_gassoc_file=@transcript_burden.gassoc dir transcript_burden_dir disp ".gassoc" parent cat_transcript_burden_data class_level transcript_burden comment "Case / control variant counts for this burden"

table file path transcript_burden_sample_list_file=@transcript_burden.sample.list dir transcript_burden_dir disp ".sample.list" parent cat_transcript_burden_data class_level transcript_burden comment "List of samples who have variants for this burden"

table file path transcript_burden_sample_without_list_file=@transcript_burden.sample.without.list dir transcript_burden_dir disp ".sample.without.list" parent cat_transcript_burden_data class_level transcript_burden comment "List of samples who do not have variants for this burden"

major file path transcript_burden_pheno_pdf_file=@transcript_burden.pheno.pdf dir transcript_burden_dir disp ".pheno.pdf" parent cat_transcript_burden_data class_level transcript_burden comment "Plot of phenotypes for samples with and without variant"

major file path transcript_burden_all_pheno_pdf_file=@transcript_burden.all_pheno.pdf dir transcript_burden_dir disp ".all_pheno.pdf" parent cat_transcript_burden_data class_level transcript_burden comment "Plot of all related phenotypes for samples with and without variant"

#variant files

minor file variant_meta_info_file=@variant.meta.info dir variant_dir disp ".meta.info" parent cat_variant_meta_data class_level variant comment "Information about this variant"

table nohead onecol file variant_sample_list_file=@variant.sample.list dir variant_dir disp ".sample.list" parent cat_variant_meta_data class_level variant comment "List of project samples with variant"

table nohead onecol file variant_sample_without_list_file=@variant.sample.without.list dir variant_dir disp ".sample.without.list" parent cat_variant_meta_data class_level variant comment "List of project samples without variant"

file path variant_mds_dat_file=@variant.mds.dat dir variant_dir disp ".mds.dat" parent cat_variant_qc_data class_level variant comment "MDS Plot, highlighting samples with and without variant --- dat file"

!!expand:tval:top:all! \
major file path variant_tval_mds_pdf_file=@variant.tval.mds.pdf dir variant_dir disp ".tval.mds.pdf" parent cat_variant_qc_data class_level variant comment "Plot of tval MDS values, highlighting samples with and without variant --- pdf file"

file path variant_pheno_pdf_file=@variant.pheno.pdf dir variant_dir disp ".pheno.pdf" parent cat_variant_qc_data class_level variant comment "Comparison of trait values for samples with and without variant"

file path variant_all_pheno_pdf_file=@variant.all_pheno.pdf dir variant_dir disp ".all_pheno.pdf" parent cat_variant_qc_data class_level variant comment "Comparison of all trait values for samples with and without variant"

file path variant_sstats_highlight_file=@variant.sstats.highlight dir variant_dir disp ".sstats.highlight" parent cat_variant_qc_data class_level variant comment "Samples with variant to highlight"

!!expand:,:slidetype,slideext:,:slide_,slide.! \
file path variant_slidetypesstats_pdf_file=@variant.slideextsstats.pdf dir variant_dir disp ".slideextsstats.pdf" parent cat_variant_qc_data class_level variant comment "QC stats for samples with variant"

!!expand:,:ext,weblevel:tex,:pdf,major! \
file weblevel path variant_qc_metrics_ext_file=@variant.qc_metrics.ext dir variant_dir trunk @variant.qc_metrics disp ".qc_metrics.ext" parent cat_variant_qc_data class_level variant comment "QC metric data for variant --- ext file"

!!expand:,:ext,weblevel:tex,:pdf,major! \
file weblevel path variant_qc_metrics_ext_file=@variant.qc_metrics.ext dir variant_dir trunk @variant.qc_metrics disp ".qc_metrics.ext" parent cat_variant_qc_data class_level variant comment "QC metric data for variant --- ext file"

major file path variant_genome_pdf_file=@variant.genome.pdf dir variant_dir disp ".genome.pdf" parent cat_variant_qc_data class_level variant comment "Plot of IBD sharing stratified by variant"

!!expand:ext:png:pdf! \
major file path variant_igv_ext_file=@variant.igv.ext dir variant_dir disp ".igv.ext" parent cat_variant_qc_data class_level variant comment "IGV snapshot of variant --- ext file"

minor file path variant_ucsc_regions_file=@variant.ucsc.regions dir variant_dir disp ".ucsc.regions" parent cat_variant_plot_data class_level variant comment "Region information for UCSC screenshot fetching"

minor file path variant_ucsc_pdf_file=@variant.ucsc.pdf dir gene_dir disp ".ucsc.pdf" parent cat_variant_plot_data class_level variant comment "Region information for UCSC screenshot fetching"

variant_r2_trunk=@variant.r2 dir variant_dir
table file path variant_r2_ld_file=$variant_r2_trunk.ld dir variant_dir disp ".r2.ld" parent cat_variant_ld_data class_level variant comment "R2 values between this variant and all others at the locus"
file path variant_r2_ld_log_file=$variant_r2_trunk.log dir variant_dir disp ".r2.log" parent cat_variant_ld_data class_level variant comment "Log file for computation of R2 values between this variant and all others at the locus"

table file path variant_r2_annotated_ld_file=$variant_r2_trunk.annotated.ld dir variant_dir disp ".r2.annotated.ld" parent cat_variant_ld_data class_level variant comment "R2 values between this variant and all others at the locus --- annotated with information about which marker is where"

major file path variant_r2_pdf_file=@variant.r2.pdf dir variant_dir disp ".r2.pdf" parent cat_variant_ld_data class_level variant comment "Plot of R2 values between this variant and all others at the locus"

!!expand:ext:tex:pdf! \
file path variant_r2_table_ext_file=@variant.r2.table.ext dir variant_dir trunk @variant.r2.table  disp ".table.r2.ext" parent cat_variant_ld_data class_level variant comment "List of LD with other variants in this gene"

file path variant_beagle_phased_file=@variant.bgl.phased dir variant_dir disp ".bgl.phased" parent cat_variant_haplotype_analysis_data class_level variant comment "Beagle output formatted for input into variant haplotype analysis"

file path variant_haplotype_analysis_file=@variant.hap.analysis.txt dir variant_dir disp ".txt" parent cat_variant_haplotype_analysis_data class_level variant comment "Output results for haplotype analysis"

!!expand:,:ext,weblevel:tex,:pdf,major! \
weblevel file path variant_haplotype_analysis_info_ext_file=@variant.hap.analysis.info.ext trunk @variant.hap.analysis.info dir variant_dir disp ".info.ext" parent cat_variant_haplotype_analysis_data class_level variant comment "Output results for haplotype analysis --- ext file"

file path variant_best_hap_file=@variant.best.hap dir variant_dir disp ".best.hap" parent cat_variant_haplotype_analysis_data class_level variant comment "Best haplotype as determined from haplotype analysis"

table major file path variant_haplotype_analysis_freq_file=@variant.hap.freq.dat dir variant_dir disp ".freq.dat" parent cat_variant_haplotype_analysis_data class_level variant comment "List of case/control counts and frequencies by haplotype position"

table file path variant_haplotype_analysis_initial_seg_file=@variant.hap.initial.seg.dat dir variant_dir disp ".initial.seg.dat" parent cat_variant_haplotype_analysis_data class_level variant comment "Segmental sharing between individuals with haplotype and remaining individuals"

table file path variant_haplotype_analysis_seg_file=@variant.hap.seg.dat dir variant_dir disp ".seg.dat" parent cat_variant_haplotype_analysis_data class_level variant comment "Segmental sharing between individuals with haplotype and remaining individuals --- converted to format used by PLINK"


major file path variant_haplotype_analysis_pdf_file=@variant.hap.analysis.pdf dir variant_dir disp ".pdf" parent cat_variant_haplotype_analysis_data class_level variant comment "PDF plot of haplotype sharing around variant + case control ratio of haplotype"

major file path variant_haplotype_analysis_longest_pdf_file=@variant.hap.analysis.longest.pdf dir variant_dir disp ".longest.pdf" parent cat_variant_haplotype_analysis_data class_level variant comment "PDF plot of haplotype sharing around variant + case control ratio of haplotype --- showing samples with longest sharing colored by phenotype"

table file path variant_hap_posterior_file=@variant.hap.posterior.tsv dir variant_dir disp ".hap.posterior" parent cat_variant_hap_imputation_data class_level variant comment "Posterior probabilities that each haplotype carries the variant"

!!expand:impute_type:hap:traditional! \
table file path variant_impute_type_count_posterior_file=@variant.impute_type.count.posterior.tsv dir variant_dir disp ".count.posterior" parent cat_variant_impute_type_imputation_data class_level variant comment "Posterior probabilities that each person carries at least 1 or 2 alleles --- determined by impute_type imputation method"

!!expand:impute_type:hap:traditional! \
table file path variant_impute_type_threshold_vassoc_file=@variant.impute_type.threshold.vassoc dir variant_dir disp ".threshold.vassoc" parent cat_variant_impute_type_imputation_data class_level variant comment "Association score for variant --- one value for each threshold as determined by impute_type imputation method"

!!expand:impute_type:hap:traditional! \
table file path variant_impute_type_summary_file=@variant.impute_type.summary dir variant_dir disp ".summary" parent cat_variant_impute_type_imputation_data class_level variant comment "Summary of imputation results; impute_type method"

!!expand:impute_type:hap:traditional! \
major file path variant_impute_type_threshold_vassoc_pdf_file=@variant.impute_type.threshold.vassoc.pdf dir variant_dir disp ".threshold.vassoc.pdf" parent cat_variant_impute_type_imputation_data class_level variant comment "Plot of association score for variant at each threshold as determined by impute_type imputation method"

minor file path variant_slide_master_ps_file=@variant.slide.master.ps dir variant_dir disp ".ps" parent cat_variant_slide_master_data class_level variant comment "Master join file of all relevant slides --- ps file"
major file path variant_slide_master_pdf_file=@variant.slide.master.pdf dir variant_dir disp ".pdf" parent cat_variant_slide_master_data class_level variant comment "Master join file of all relevant slides --- pdf file"

!!expand:,:ext,majmin:tex,minor:pdf,minor! \
majmin file path variant_title_slide_ext_file=@variant.title.ext dir variant_dir disp "title.ext" trunk @variant.title parent cat_variant_slide_master_data class_level variant comment "Title slide for variant --- ext file"

#call_set
#table file path call_set_picard_metrics_file=@call_set.picard.metrics.csv dir call_set_dir disp ".metrics.csv" parent cat_call_set_picard_data class_level call_set comment "Picard metrics for samples on this call_set" skip_re "Solexa Picard|2010"

minor file path call_set_sample_vcf_id_to_sample_id_file=@call_set.sample.vcf_id.to.sample_id dir call_set_dir disp ".sample.vcf_id.to.sample_id" parent cat_call_set_meta_call_data class_level call_set comment "First column: id in VCF file; second column: id in project"

minor file path call_set_sample_list_file=@call_set.sample.list dir call_set_dir disp ".sample.list" parent cat_call_set_meta_call_data class_level call_set comment "List of samples for calling at call_set level"

minor file path call_set_bam_list_file=@call_set.bam.list dir call_set_dir disp ".bam.list" parent cat_call_set_meta_call_data class_level call_set comment "List of bams for calling at call_set level"

minor file path call_set_sample_subset_bam_list_file=@call_set.@call_set_subset.@call_set_sample_subset.bam.list dir call_set_sample_subsets_dir disp ".bam.list" parent cat_call_set_sample_subset_missed_variants_data class_level call_set_sample_subset comment "List of bams for calling at call_set_sample_subset level"

!!expand:,:call_set,mydir:call_set,call_set_dir:call_set_subset,call_set_subsets_dir! \
call_set_plink_file=@call_set dir mydir

!!expand:,:call_set,mydir:call_set,call_set_dir:call_set_subset,call_set_subsets_dir! \
call_set_temp_plink_file=@call_set.tmp dir mydir

minor file path call_set_subset_bim_keep_file=@call_set.@call_set_subset.bim_keep dir call_set_subsets_dir disp ".bim.keep" parent cat_call_set_subset_variant_call_data class_level call_set_subset comment "List of variants to keep when subsetting bim file"

!!expand:,:call_set,mydir:call_set,call_set_dir:call_set_subset,call_set_subsets_dir! \
!!expand:ext:bed:bim:fam! \
table doubcom major file path call_set_ext_file=$call_set_plink_file.ext dir mydir disp ".ext" parent cat_call_set_variant_call_data class_level call_set comment "Initial ext file for this call_set"

table file path call_set_extract_file=$call_set_plink_file.extract dir call_set_dir disp ".extract" parent cat_call_set_variant_call_data class_level call_set comment "Specify this to remove markers at the very start of the VCF generation process"

!!expand:,:call_set,mydir:call_set,call_set_dir:call_set_subset,call_set_subsets_dir! \
!!expand:ext:ref_alt:keep! \
table doubcom major file path call_set_ext_file=$call_set_plink_file.ext dir mydir disp ".ext" parent cat_call_set_variant_call_data class_level call_set comment "Initial ext file for this call_set"

!!expand:,:call_set,mydir:call_set,call_set_dir:call_set_subset,call_set_subsets_dir! \
table doubcom minor file path call_set_recode_vcf_log_file=$call_set_plink_file.vcf.log dir mydir disp ".vcf.log" parent cat_call_set_variant_call_data class_level call_set comment "Log file for conversion from bed/bim/fam file"

!!expand:,:call_set,mydir:call_set,call_set_dir:call_set_subset,call_set_subsets_dir! \
table doubcom major file path call_set_vcf_file=@call_set.vcf dir mydir disp ".vcf" parent cat_call_set_variant_call_data class_level call_set comment "Initial vcf file for this call_set (uncompressed)"

!!expand:,:type,ext:,:_compressed,.gz! \
table doubcom major file path call_set_from_plinktype_vcf_file=@call_set.from_plink.vcfext dir call_set_dir disp ".from_plink.vcfext" parent cat_call_set_variant_call_data class_level call_set comment "Initial vcf file for this call_set; specify rather than vcf_file compressed_vcf_file if want to do processing for plink input on it"

!!expand:,:call_set,mydir:call_set,call_set_dir:call_set_subset,call_set_subsets_dir! \
table doubcom major file path call_set_compressed_vcf_file=@call_set.vcf@zip_vcf dir mydir disp ".compressed.vcf" parent cat_call_set_variant_call_data class_level call_set comment "Vcf file for this call_set --- compressed if desired (specify as initial if compressed)"

!!expand:,:call_set,mydir:call_set,call_set_dir:call_set_subset,call_set_subsets_dir! \
table doubcom major file path call_set_compressed_vcf_index_file=@call_set.vcf@zip_vcf.tbi dir mydir disp "compressed.vcf.tbi" parent cat_call_set_variant_call_data class_level call_set comment "Index for compressed vcf file"

table doubcom major file path call_set_dis_removed_vcf_file=@call_set.dis_removed.vcf@zip_vcf dir call_set_dir disp ".dis_removed.vcf" parent cat_call_set_variant_call_data class_level call_set comment "Annotated vcf file for this call_set; has sites with different alleles than at the project level removed"

minor file path call_set_variant_site_vcf_file=@call_set.variant.site.vcf dir call_set_dir disp ".variant.site.vcf" parent cat_call_set_variant_call_data class_level call_set comment "A list of sites called on this call_set -- in vcf format -- used for tracking the alleles"

minor file path call_set_variant_annot_site_vcf_file=@call_set.variant.annot.vcf dir call_set_dir disp ".variant.annot.vcf" parent cat_call_set_variant_call_data class_level call_set comment "A list of sites called on this call_set -- after discordances are removed -- together with original annotations"

meta_table file path call_set_call_set_subsets_meta_file=@call_set.call_set_subsets.meta dir call_set_dir disp ".call_set_subets.meta" parent cat_call_set_meta_call_data class_level call_set comment "The call set subsets to use" meta_level call_set_subset

minor file path call_set_missed_variants_site_vcf_file=@call_set.missed_variants.site.vcf dir call_set_dir disp ".missed_variants.site.vcf" parent cat_call_set_variant_call_data class_level call_set comment "A list of variants called on other call_sets but not this call_set"


#minor file path call_set_maf_file=@call_set.maf dir call_set_dir disp ".maf" parent cat_call_set_all_call_data class_level call_set comment ".maf file output by firehose"
#table file path call_set_maf_annotated_file=@call_set.maf.annotated dir call_set_dir disp ".maf.annotated" parent cat_call_set_all_call_data class_level call_set comment ".maf.annotated file output by firehose"
#table doubcom file path call_set_vcf_file=@call_set.vcf dir call_set_dir disp ".vcf" parent cat_call_set_all_call_data class_level call_set comment "Variant calls for all samples on this call_set; via multi-sample caller"

#major file path call_set_filtered_eval_file=@call_set.filtered.eval dir call_set_dir disp ".eval" parent cat_call_set_filtered_call_data class_level call_set comment ".filtered.eval file generated by firehose"
#file path call_set_filtered_eval_interesting_sites_file=@call_set.filtered.eval.interesting_sites dir call_set_dir disp ".eval.interesting_sites" parent cat_call_set_filtered_call_data class_level call_set comment ".interesting_sites file generated by firehose"
#table doubcom file path call_set_filtered_vcf_file=@call_set.filtered.vcf dir call_set_dir disp ".filtered.vcf" parent cat_call_set_filtered_call_data class_level call_set comment ".filtered.vcf file generated by firehose"

table doubcom file path call_set_missed_sites_vcf_file=@call_set.missed_sites.vcf@zip_vcf dir call_set_dir disp ".missed_sites.vcf" parent cat_call_set_all_call_data class_level call_set comment "Variant calls for all samples on this call_set at variants called on another call_set but not this one"

table doubcom file path call_set_all_sites_vcf_file=@call_set.all_sites.vcf@zip_vcf dir call_set_dir disp ".all_sites.vcf" parent cat_call_set_all_call_data class_level call_set comment "Variant calls for all samples on this call_set, including at variants called on other call_sets"

#table doubcom file path call_set_ab_annotated_vcf_file=@call_set.ab_annotated.vcf@zip_vcf dir call_set_dir disp ".ab_annotated.vcf" parent cat_call_set_all_call_data class_level call_set comment "SNP calls for all samples on this call_set, annotated with AB by sample"

#table doubcom file path call_set_ab_annotated_site_vcf_file=@call_set.ab_annotated.site.vcf dir call_set_dir disp ".ab_annotated.site.vcf" parent cat_call_set_all_call_data class_level call_set comment "SNP calls for all samples on this call_set, annotated with AB by sample --- projected to only sites/filters"

table doubcom file path call_set_all_sites_site_vcf_file=@call_set.all_sites.site.vcf dir call_set_dir disp ".all_sites.site.vcf" parent cat_call_set_all_call_data class_level call_set comment "SNP calls for all samples on this call_set, annotated with AB by sample --- projected to only sites/filters"


#minor file path call_set_unfiltered_eval_file=@call_set.unfiltered.eval dir call_set_dir disp ".eval" parent cat_call_set_unfiltered_call_data class_level call_set comment ".unfiltered.eval file generated by firehose"
#minor file path call_set_unfiltered_eval_interesting_sites_file=@call_set.unfiltered.eval.interesting_sites dir call_set_dir disp ".eval.interesting_sites" parent cat_call_set_unfiltered_call_data class_level call_set comment ".unfiltered.interesting_sites file generated by firehose"

#minor file call_set_sample_coverage_stats_file_list=@call_set.sample.coverage.stats.list disp ".sample.list" dir call_set_dir parent cat_call_set_sample_coverage_data class_level call_set comment "List of sample coverage stats file for use in generating call_set sample coverage dat file"

#table file path call_set_sample_coverage_dat_file=@call_set.coverage.csv dir call_set_dir disp ".csv" parent cat_call_set_sample_coverage_data class_level call_set comment "Coverage statistics for each sample on this call_set"
#major file path call_set_sample_coverage_pdf_file=@call_set.coverage.pdf dir call_set_dir disp ".pdf" parent cat_call_set_sample_coverage_data class_level call_set comment "Plot of coverage for each sample on this call_set"
#minor file call_set_sample_gene_coverage_stats_file_list=@call_set.sample.gene.coverage.stats.list disp ".sample.list" dir call_set_dir parent cat_call_set_gene_dist_coverage_data class_level call_set comment "List of sample gene coverage stats file for use in generating call_set gene dist coverage dat file"

#table file path call_set_gene_dist_coverage_dat_file=@call_set.gene.coverage.csv dir call_set_dir disp "csv" parent cat_call_set_gene_dist_coverage_data class_level call_set comment "Coverage for each sample on this call_set stratified by gene"
#major file path call_set_gene_dist_coverage_pdf_file=@call_set.gene.coverage.pdf dir call_set_dir disp "pdf" parent cat_call_set_gene_dist_coverage_data class_level call_set comment "Plot of coverage for each sample on this call_set stratified by gene"

#table nohead file path call_set_gene_cum_coverage_dat_file=@call_set.gene.cum.coverage.csv dir call_set_dir disp ".csv" parent cat_call_set_gene_cum_coverage_data class_level call_set comment "Cumulative distribution of gene coverage for samples on this call_set"
#file path call_set_gene_cum_coverage_pdf_file=@call_set.gene.cum.coverage.pdf dir call_set_dir disp ".pdf" parent cat_call_set_gene_cum_coverage_data class_level call_set comment "Plot of cumulative distribution of gene coverage for samples on this call_set"

#project_subset

#minor file project_subset_interval_list_file=@project_subset.interval_list dir project_subsets_dir disp ".interval_list" parent cat_project_subset_samtools_data class_level project_subset comment "Interval list at which to call sites"

#table doubcom file path project_subset_samtools_vcf_file=@project_subset.samtools.vcf dir project_subsets_dir disp ".samtools.vcf" parent cat_project_subset_samtools_data class_level project_subset comment "Output of samtools calls"

#call_set_subset

file path call_set_subset_missed_variants_site_vcf_file=@call_set_subset.missed_variants.site.vcf dir call_set_subsets_dir disp ".missed_variants.site.vcf" parent cat_call_set_subset_missed_variants_data class_level call_set_subset comment "A list of variants called on other call_sets but not this call_set --- subsetted for efficiency"

#minor table doubcom file path call_set_subset_missed_sites_temp_vcf_file=@call_set_subset.missed_sites.temp.vcf dir call_set_subsets_dir disp ".temp.missed_sites.vcf" parent cat_call_set_subset_missed_sites_data class_level call_set_subset comment "Variant calls for all samples on this call_set at sites called on another call_set but not this one --- file before pruning out buggy sites without genotypes (for a short time output by the GATK) --- subsetted for efficiency"

minor table doubcom file path call_set_subset_missed_variants_vcf_file=@call_set_subset.missed_variants.vcf@zip_vcf dir call_set_subsets_dir disp ".missed_variants.vcf" parent cat_call_set_subset_missed_variants_data class_level call_set_subset comment "Variant calls for all samples on this call_set at variants called on another call_set but not this one --- subsetted for efficiency"

minor table doubcom file path call_set_sample_subset_missed_variants_vcf_file=@call_set_subset.@call_set_sample_subset.missed_variants.vcf@zip_vcf dir call_set_sample_subsets_dir disp ".missed_variants.vcf" parent cat_call_set_sample_subset_missed_variants_data class_level call_set_sample_subset comment "Variant calls for all samples on this call_set at variants called on another call_set but not this one --- subsetted for efficiency"

#sample
#To link to			return "$igv_http?sessionURL=$xml_attachment_path&user=$igv_user$locus_text";

igv_http=http://www.broadinstitute.org/igv/dynsession/igv.jnlp
igv_user=lap
igv_url=$igv_http
igv_port=13161


convert_paths major file path sample_bam_file=@sample.bam dir sample_dir disp ".bam" parent cat_sample_read_data class_level sample comment "Bam file for this sample" goto_url $igv_http?sessionURL=*sample_bam_xml_file&user=$igv_user
file path sample_bai_file=@sample.bam.bai dir sample_dir disp ".bai" parent cat_sample_read_data class_level sample comment "Bam index file for this sample"
file path sample_bam_xml_file=@sample.bam.xml dir sample_dir disp ".xml" parent cat_sample_read_data class_level sample comment "Xml file for loading bam in igv"

#No one has this anymore (did Firehose change?)
#minor file path sample_bam_blacklist_file=@sample.bam.blacklist.txt dir sample_dir disp ".blacklist.txt" parent cat_sample_read_data class_level sample comment ".bam.blacklist file generated by firehose"
#file path sample_indel_lods_file=@sample.indel.lods dir sample_dir disp ".indel.lods" parent cat_sample_read_data class_level sample comment "Indel lods file for this sample generated by firehose"
#file path sample_indel_stats_file=@sample.indel.stats dir sample_dir disp ".indel.stats" parent cat_sample_read_data class_level sample comment "Indel stats file for this sample generated by firehose"
#minor file path sample_merged_intervals_stats_file=@sample.merged.intervals dir sample_dir disp ".merged.intervals" parent cat_sample_read_data class_level sample comment ".merged.intervals file generated by firehose"

table file path sample_coverage_file=@sample.coverage.txt.gz dir sample_dir disp ".coverage.txt.gz" parent cat_sample_coverage_data class_level sample comment "Coverage at each base for this sample; generated by DepthOfCoverageWalker"
file path sample_coverage_stats_file=@sample.coverage.stats.csv dir sample_dir disp ".stats.csv" parent cat_sample_coverage_data class_level sample comment "Coverage statistics for this sample across all bases"
!!expand:type:gene:exon:bait! \
table nohead file path sample_type_coverage_stats_file=@sample.type.coverage.stats.csv dir sample_dir disp ".type.stats.csv" parent cat_sample_coverage_data class_level sample comment "Coverage statistics for this sample across all bases; stratified by gene"

major file path sample_gene_coverage_pdf_file=@sample.gene.coverage.pdf dir sample_dir disp ".gene.pdf" parent cat_sample_coverage_data class_level sample comment "Plot of this sample's coverage at each gene" 

###BEGIN Uncomment this section to have files generated by Sample_UnifiedGenotyperToEval
#minor file path sample_bam_list_file=@sample.bam.list dir sample_dir disp ".bam.list" parent cat_sample_meta_call_data class_level sample comment "List of bams for calling SNPs only at this sample"
#minor file path sample_snp_blacklist_file=@sample.snp.blacklist.list dir sample_dir disp ".blacklist.list" parent cat_sample_meta_call_data class_level sample comment ".snp.blacklist.list file generated by firehose"

#minor file path sample_maf_file=@sample.maf dir sample_dir disp ".maf" parent cat_sample_all_call_data class_level sample comment ".maf file generated by firehose"
#table minor file path sample_maf_annotated_file=@sample.maf.annotated dir sample_dir disp ".maf.annotated" parent cat_sample_all_call_data class_level sample comment ".maf.annotated file generated by firehose"
#table doubcom file path sample_vcf_file=@sample.vcf dir sample_dir disp ".vcf" parent cat_sample_all_call_data class_level sample comment "Calls made by firehose using single-sample caller for only this sample"

#major file path sample_filtered_eval_file=@sample.filtered.eval dir sample_dir disp ".eval" parent cat_sample_filtered_call_data class_level sample comment ".filtered.eval file at calls for this sample"
#file path sample_filtered_eval_interesting_sites_file=@sample.filtered.eval.interesting_sites dir sample_dir disp ".eval.interesting_sites" parent cat_sample_filtered_call_data class_level sample comment ".filtered.interesting_sites file at calls for this sample"
#table doubcom major file path sample_filtered_maf_annotated_vcf_file=@sample.filtered.maf_annotated.vcf dir sample_dir disp ".maf_annotated.vcf" parent cat_sample_filtered_call_data class_level sample comment "Annotated vcf file for calls for this sample"
#table doubcom file path sample_filtered_vcf_file=@sample.filtered.vcf dir sample_dir disp ".filtered.vcf" parent cat_sample_filtered_call_data class_level sample comment "Filtered vcf file for calls for this sample"

#minor file path sample_unfiltered_eval_file=@sample.unfiltered.eval dir sample_dir disp ".eval" parent cat_sample_unfiltered_call_data class_level sample "unfiltered.eval file generated by firehose"
#minor file path sample_unfiltered_eval_interesting_sites_file=@sample.unfiltered.eval.interesting_sites dir sample_dir disp ".eval.interesting_sites" parent cat_sample_unfiltered_call_data class_level sample comment "unfiltered.interesting_sites file generated by firehose"
###END Uncomment this section to have files generated by Sample_UnifiedGenotyperToEval

##BEGIN Uncomment to get files for indels
#minor file path sample_indel_blacklist_file=@sample.indel.blacklist.list dir sample_dir disp ".blacklist.txt" parent cat_sample_indel_call_data class_level sample comment "indel.blacklist.list file generated by firehose"

#table nohead file path sample_indels_bed_file=@sample.indels.bed dir sample_dir disp ".indels.bed" parent cat_sample_indel_call_data class_level sample skip_re REDUCE comment "indels.bed file generated by firehose"
#table nohead file path sample_filtered_indels_bed_file=@sample.filtered_indels.bed dir sample_dir disp ".filtered_indels.bed" parent cat_sample_indel_call_data class_level sample skip_re REDUCE comment "Filtered indels.bed file generated by firehose"
#major table nohead file path sample_indels_verbose_bed_file=@sample.indels.verbose.bed dir sample_dir disp ".indels.verbose.bed" parent cat_sample_indel_call_data class_level sample skip_re REDUCE comment "Verbose indels file generated by firehose"
##END Uncomment to get files for indels

#merged calls
#major table doubcom file sample_project_vcf_file=@sample.project.vcf dir sample_dir disp ".vcf" parent cat_sample_multi_sample_snp_call_data class_level sample comment "Calls from project (multi-sample) calls projected to this sample"

#--------
#commands
#--------

null_cmd=a=1

#meta cmds

expand_interval_size=50
expand_helper=awk -v OFS="\t" '@3 {\$@1 -= $expand_interval_size; if (\$@1 < 1) {\$@1 = 1} \$@2 += $expand_interval_size} {print}'

prop expand_coverage_targets=scalar default 0
prop expand_targets=scalar default 1
prop expand_intervals=scalar default 1

local cmd make_project_expanded_interval_list_file=$expand_helper(2,3,\$1 !~ /^@/) < !{input,,project_interval_list_file} > !{output,,project_expanded_interval_list_file} class_level project run_if and,(or,expand_coverage_targets,expand_targets),expand_intervals

local cmd cp_project_expanded_interval_list_file=cp !{input,,project_interval_list_file} !{output,,project_expanded_interval_list_file} class_level project skip_if and,(or,expand_coverage_targets,expand_targets),expand_intervals

local cmd make_project_target_length_file=perl $targeted_bin_dir/get_target_length.pl < !{input,,project_expanded_interval_list_file,if_prop=expand_targets,allow_empty=1} !{input,,project_interval_list_file,unless_prop=expand_targets,allow_empty=1} > !{output,,project_target_length_file} class_level project

local cmd make_project_expanded_exon_target_file=$expand_helper(4,5,) < !{input,,project_exon_target_file} > !{output,,project_expanded_exon_target_file} class_level project run_if expand_targets

local cmd cp_project_expanded_exon_target_file=cp !{input,,project_exon_target_file} !{output,,project_expanded_exon_target_file} class_level project skip_if expand_targets

short cmd make_project_variant_gene_annotation_file=$smart_cut_cmd !{input,--file,project_full_var_annot_file} --in-delim $tab --select-col 1,1,'$vep_id_annot SNPEFF_Gene_name' --require-col-match --exact --exclude-row 1,1 | awk -v OFS="\t" -F"\t" '\$2 == "$annot_missing_field" {\$2 = "$outside_gene_name"} {print}' > !{output,,project_variant_gene_annotation_file} class_level project

local cmd make_project_gene_target_file=perl $targeted_bin_dir/exon_to_gene_target.pl < !{input,,project_expanded_exon_target_file} > !{output,,project_gene_target_file} class_level project

vep_target_chunk_size=1000
#short cmd make_project_merge_subset_pos_transcript_file=n=`$combine_vcfs_for_annotation(project_merge_subset,) | wc -l | awk '{print int(\$1/$vep_target_chunk_size)+1}'` && for i in `seq 1 \$n`; do s=$((\$i * $vep_target_chunk_size)); ($combine_vcfs_for_annotation(project_merge_subset,) | head -n\$s | tail -n$vep_target_chunk_size | $vep_cmd --offline -o STDOUT --dir $ensembl_cache_dir | fgrep -v '\#\#'; done | awk 'NR == 1 || \$1 !~ /\#/' | $smart_cut_cmd --in-delim $tab --exclude-row 0,1 --select-col 0,1 --exact --require-col-match --select-col 0,1,$vep_trans_annot | sed 's/:/\t/' > !{output,,project_merge_subset_pos_transcript_file} class_level project_merge_subset


pos_transcript_helper=awk -F"\t" -v OFS="\t" '!/^\#/ {\$3=\$1":"\$2} {print}' | $vep_cmd --offline -o STDOUT --dir $ensembl_cache_dir | fgrep -v '\#\#' | $smart_cut_cmd --in-delim $tab --exclude-row 0,1 --select-col 0,1 --exact --require-col-match --select-col 0,1,$vep_trans_annot | sed 's/:/\t/'

short cmd make_project_pos_transcript_file=cat !{input,,project_variant_site_vcf_file} | $pos_transcript_helper > !{output,,project_pos_transcript_file} class_level project skip_if num_merge_subsets

short cmd make_project_merge_subset_pos_transcript_file=$combine_vcfs_for_annotation(project_merge_subset,) | $pos_transcript_helper > !{output,,project_merge_subset_pos_transcript_file} class_level project_merge_subset

local cmd cat_project_pos_transcript_file=cat !{input,,project_merge_subset_pos_transcript_file} > !{output,,project_pos_transcript_file} class_level project run_if num_merge_subsets

short cmd make_project_transcript_target_file=cat !{input,,project_pos_transcript_file} | sort -k3,3 -k1,1 -k2,2n | fgrep -v '$vep_missing_field' | awk -F"\t" -v OFS="\t" '{ct=\$3"."\$1} t && ct != t {print t,c,s,e} ct != t || !t {s=\$2} {t=ct; e=\$2; c=\$1} END {print t,c,s,e}' > !{output,,project_transcript_target_file} class_level project

local cmd make_project_disjoint_gene_target_file=cat !{input,,project_gene_target_file} !{input,,project_transcript_target_file} | sort -k2,2 -k3,3n | awk -v OFS="\t" -F"\t" 'NR == 1 {m=1} NR == 1 || \$2 != c || \$3 > e {g="GeneGroup"m++; } {\$1=g} {print} NR == 1 || \$2 != c || \$4 > e {c=\$2; s=\$3; e=\$4}' | uniq > !{output,,project_disjoint_gene_target_file} class_level project

local cmd make_project_closest_gene_file=cat !{input,,project_gene_target_file} | sort -k2,2 -k3,3n  | awk -F"\t" -v OFS="\t" 'BEGIN {f=3000000000} (NR == 1 || (c && \$2 != c)) {if (g && c && l + 1 < f) {print g,c,l+1,f} g=\$1;c=\$2;l=0} g {m=int((l + \$3)/2); if (m > l) {print g,c,l+1,m} if (m + 1 < \$3 - 1) {print \$1,\$2,m+1,\$3-1}} {print} !g || \$4 > l {g=\$1;c=\$2;l=\$4;} END {if (l + 1 < f) {print g,c,l+1,f}}' > !{output,,project_closest_gene_file} class_level project

#perl $targeted_bin_dir/exon_to_gene_target.pl < !{input,,project_expanded_exon_target_file} > !{output,,project_gene_target_file} class_level project

local cmd make_project_genes_gtf_file=awk -v OFS="\t" '{print \$3,"$hg_refflat","CDS",\$4,\$5,"0.000000","+","0","gene_id \""\$1"\"; transcript_id \""\$1"\";"}' < !{input,,project_expanded_exon_target_file} > !{output,,project_genes_gtf_file} class_level project

prop validate_gtf=scalar default 1

interval_split_helper=perl -lne 'BEGIN {open IN, "!{input,,project_variant_subset_var_keep_file}"; while (<IN>) {\@a = split; \$min{\$a[0]} = \$a[1] unless defined \$min{\$a[0]} && \$min{\$a[0]} < \$a[1]; \$max{\$a[0]} = \$a[1] unless defined \$max{\$a[0]} && \$max{\$a[0]} > \$a[1];  }} chomp; \@a = split("\t"); if (\$min{\$a[@1]}) {\$f = \$min{\$a[@1]} <= \$a[@2] && \$max{\$a[@1]} >= \$a[@2]; \$g = \$min{\$a[@1]} <= \$a[@3] && \$max{\$a[@1]} >= \$a[@3]; if (\$f || \$g) {print join("\t",\@a); unless (\$f && \$g) {!{raw,,project,die "Error: a line in the gtf (\$_) file partially overlapped this region",if_prop=validate_gtf,allow_empty=1}}}}'

local cmd make_project_variant_subset_genes_gtf_file=$interval_split_helper(0,3,4) !{input,,project_genes_gtf_file} > !{output,,project_variant_subset_genes_gtf_file} class_level project_variant_subset

short cmd make_project_variant_subset_region_file=$interval_split_helper(1,2,3) !{input,,project_disjoint_gene_target_file} > !{output,,project_variant_subset_region_file} class_level project_variant_subset

#calls cmds
prop sample_vcf_id=scalar
meta_table cmd make_project_sample_vcf_id_to_sample_id_file=!{prop,,sample,sample_vcf_id,if_prop=sample_vcf_id,allow_empty=1}\t!{prop,,sample,if_prop=sample_vcf_id,allow_empty=1} !{output,project_sample_vcf_id_to_sample_id_file} class_level project skip_if no_sample_tracking

local cmd make_empty_project_sample_vcf_id_to_sample_id_file=rm -f !{output,,project_sample_vcf_id_to_sample_id_file} && touch !{output,,project_sample_vcf_id_to_sample_id_file} class_level project run_if no_sample_tracking

prop sample_call_set=scalar
meta_table cmd make_project_sample_to_call_set_file=!{prop,,sample,if_prop=sample_call_set,allow_empty=1}\t!{prop,,sample,sample_call_set,if_prop=sample_call_set,allow_empty=1} !{output,project_sample_to_call_set_file} class_level project skip_if no_sample_tracking

local cmd make_empty_project_sample_to_call_set_file=rm -f !{output,,project_sample_to_call_set_file} && touch !{output,,project_sample_to_call_set_file} class_level project run_if no_sample_tracking


meta_table cmd make_project_sample_bam_list_file=!{prop,,sample}\t!{input,,sample_bam_file,unless_prop=failed} !{output,project_sample_bam_list_file} class_level project skip_if no_sample_tracking
local cmd make_project_bam_list_file=cut -f2 !{input,,project_sample_bam_list_file} > !{output,,project_bam_list_file} class_level project

#remove samples who are excluded from this call_set
local cmd make_call_set_sample_vcf_id_to_sample_id_file=$smart_join_cmd --in-delim $tab --exec "awk '\\$2 != \"!{prop,,call_set}\" {print \\$1\"\n\"\\$1}' !{input,,project_sample_to_call_set_file} | $smart_cut_cmd --in-delim $tab --exec 'cut -f2 !{input,,project_sample_vcf_id_to_sample_id_file} | sort -u' | sort | uniq -u" !{input,--file,project_sample_vcf_id_to_sample_id_file} --col 2,2 --extra 2 | awk -F"\t" -v OFS="\t" '{print \$2,\$1}' > !{output,,call_set_sample_vcf_id_to_sample_id_file} class_level call_set 

zcat_helper=!{raw,,@1,z,if_prop=zip_vcf:eq:.gz,allow_empty=1}cat
bgzip_helper=!{raw,,@1,| $bgzip_cmd,if_prop=zip_vcf:eq:.gz,allow_empty=1}
run_tabix_cmd=$tabix_cmd -f -p vcf *@1
tabix_helper_int=!{raw,,@1,&& $run_tabix_cmd(@2),if_prop=zip_vcf:eq:.gz,allow_empty=1@3}
tabix_helper=$tabix_helper_int(@1,@2,)
tabix_helper_if=$tabix_helper_int(@1,@2,\,@3)
ln_tabix_helper=!{raw,,@1,&& ln *@2.tbi *@3.tbi,if_prop=zip_vcf:eq:.gz,allow_empty=1}

filter_call_set_bim_file=awk -v OFS="\t" '\$1 !~ /\#/ && \$1 > 0 && \$5 ~ /^[ATCG]+$/ && \$6 ~ /^[ATCG]+$/ {k=\$1":"\$4; if (!m[k]) {print @1; m[k]=1}}'

local cmd make_call_set_ref_alt_file=(echo '\#\#fileformat=VCFv4.1' && echo '\#CHROM	POS	ID	REF	ALT	QUAL	FILTER	INFO' && $filter_call_set_bim_file() !{input,,call_set_bim_file} | awk -v OFS="\t" '{print \$1,\$4,\$2,\$6,\$5,".",".","."}') > !{output,,call_set_ref_alt_file} class_level call_set run_if call_set_bim_file 

mv_cmd_helper=mv @1 @2

local cmd make_call_set_keep_file=$filter_call_set_bim_file(\$2) !{input,,call_set_bim_file} > !{output,,call_set_keep_file} class_level call_set run_if call_set_bim_file



local cmd make_call_set_subset_bim_keep_file=sort -k1,1n -k4,4n !{input,,call_set_bim_file} | $split_call_set_file_helper(!{input::call_set_bim_file}) | awk '{print \$2}' > !{output,,call_set_subset_bim_keep_file} class_level call_set_subset

short cmd make_call_set_subset_plink_files=$plink_cmd $plink_in_bed_helper(call_set) !{input,--extract,call_set_subset_bim_keep_file} --make-bed $plink_out_bed_helper(call_set_subset) class_level call_set_subset

process_call_set_plink_input=$sort_vcf_file | $vcf_utils_cmd --add-string-format GT,"Genotype" --valid-ref-alt !{input,--reference-vcf,call_set_ref_alt_file} !{input,--var-keep,call_set_keep_file} !{input,--chr-remap,project_chr_map_file} --remove-repeated-samples

sort_vcf_file=awk -F"\t" -v OFS="\t" '{if (/^\#/) {print 0,NR,\$0} else {print 1,1,\$0}}' | sort -k1,1n -k2,2n -k3,3n -k4,4n | cut -f3-

!|expand:;:shortt;call_setl;exskipif;rusage:;call_set;,num_call_set_subsets;rusage_mod $recode_call_set_vcf_mem:short;call_set_subset;;| \
shortt cmd make_recode_call_setl_compressed_vcf_file=$plink108_cmd !{input,--bed,call_setl_bed_file} !{input,--bim,call_setl_bim_file} !{input,--fam,call_setl_fam_file} !{input,--extract,call_set_extract_file,if_prop=call_set_extract_file,allow_empty=1} --recode-vcf !{raw,--out,call_setl,*call_setl_temp_plink_file} && $plink_mv_log_cmd(!{raw\,\,call_setl\,*call_setl_temp_plink_file},!{output\,\,call_setl_recode_vcf_log_file}) && cat !{raw::call_setl:*call_setl_temp_plink_file.vcf} | $fix_vcf_file(call_setl_fam_file) | $process_call_set_plink_input $bgzip_helper(call_setl) > !{output,,call_setl_compressed_vcf_file} && rm !{raw,,call_setl,*call_setl_temp_plink_file.vcf} class_level call_setl run_if and,call_set_bed_file,call_set_bim_file,call_set_fam_file skip_if or,call_set_vcf_file,call_set_compressed_vcf_fileexskipif rusage

auto_zcat=if [[ `file -L !{input,,@1} | grep gzip` ]]; then zcat !{input,,@1}; else cat !{input,,@1}; fi

!!expand:,:inputtype,othertype,catcmd:,_compressed,cat:_compressed,,zcat! \
short cmd make_frominputtype_plink_call_set_subset_vcf_file=catcmd !{input,,call_set_from_plinkinputtype_vcf_file} | $vcf_utils_cmd !{input,--var-keep,call_set_subset_bim_keep_file} > !{output,,call_set_subset_vcf_file} class_level call_set_subset run_if and,call_set_from_plinkinputtype_vcf_file skip_if or,call_set_compressed_vcf_file,call_set_from_plinkothertype_vcf_file

make_call_set_plink_vcf_helper=!{raw::call_set:| $vcf_utils_cmd --var-keep *call_set_extract_file:if_prop=call_set_extract_file:allow_empty=1} !{input,call_set_extract_file,if_prop=call_set_extract_file,allow_empty=1} | $process_call_set_plink_input


short cmd make_plink_filter_call_set_subset_compressed_vcf_file=cat !{input,,call_set_subset_vcf_file} $make_call_set_plink_vcf_helper $bgzip_helper(call_set_subset) > !{output,,call_set_subset_compressed_vcf_file} class_level call_set_subset run_if or,call_set_from_plink_vcf_file,call_set_from_plink_compressed_vcf_file skip_if call_set_compressed_vcf_file

!!expand:,:inputtype,othertype,catcmd:,_compressed,cat:_compressed,,zcat! \
cmd make_from_plinkinputtype_filter_call_set_compressed_vcf_file=catcmd !{input,,call_set_from_plinkinputtype_vcf_file} $make_call_set_plink_vcf_helper $bgzip_helper(call_set) > !{output,,call_set_compressed_vcf_file} class_level call_set run_if call_set_from_plinkinputtype_vcf_file skip_if or,call_set_compressed_vcf_file,call_set_from_plinkothertype_vcf_file,num_call_set_subsets

local cmd ln_call_set_compressed_vcf_file=rm -f !{output,,call_set_compressed_vcf_file} && ln -s !{input,,call_set_vcf_file} !{output,,call_set_compressed_vcf_file} class_level call_set skip_if or,zip_vcf,call_set_compressed_vcf_file,(or,call_set_from_plink_vcf_file,call_set_from_plink_compressed_vcf_file) run_if call_set_vcf_file

short cmd make_call_set_compressed_vcf_file=rm -f !{output,,call_set_compressed_vcf_file} && cat !{input,,call_set_vcf_file} $bgzip_helper(call_set) > !{output,,call_set_compressed_vcf_file} class_level call_set run_if and,zip_vcf,call_set_vcf_file skip_if or,(or,call_set_from_plink_vcf_file,call_set_from_plink_compressed_vcf_file),call_set_compressed_vcf_file

#short cmd make_merged_call_set_compressed_vcf_file=$gatk_cmd(CombineVariants) !{output,-o,call_set_compressed_vcf_file} !{raw,,call_set_subset,--variant:@call_set_subset *call_set_subset_compressed_vcf_file} !{input,call_set_subset_compressed_vcf_file} !{input,call_set_subset_compressed_vcf_index_file,if_prop=zip_vcf,allow_empty=1} -genotypeMergeOptions REQUIRE_UNIQUE -filteredRecordsMergeType KEEP_IF_ANY_UNFILTERED -priority "!{prop,,call_set,sep=\,}" $bgzip_helper(call_set) class_level call_set run_if or,(and,call_set_bim_file,call_set_fam_file,call_set_bed_file),call_set_from_plink_vcf_file,call_set_from_plink_compressed_vcf_file skip_if or,call_set_compressed_vcf_file,!num_call_set_subsets

#Will this work? If not, switch back to above

short cmd make_merged_call_set_compressed_vcf_file=($zcat_helper(call_set) !{input,,call_set_subset_compressed_vcf_file,sort_prop=call_set_subset_num,limit=1} | grep '^\\#' && $zcat_helper(call_set) !{input,,call_set_subset_compressed_vcf_file,sort_prop=call_set_subset_num} | awk '!/^\\#/') $bgzip_helper(call_set) > !{output,,call_set_compressed_vcf_file} class_level call_set run_if or,(and,call_set_bim_file,call_set_fam_file,call_set_bed_file),call_set_from_plink_vcf_file,call_set_from_plink_compressed_vcf_file skip_if or,call_set_compressed_vcf_file,!num_call_set_subsets

!!expand:,:call_set,skipif:call_set,skip_if call_set_compressed_vcf_index_file:call_set_subset,! \
short cmd make_call_set_compressed_vcf_index_file=$tabix_cmd -f -p vcf !{input,,call_set_compressed_vcf_file} !{output,call_set_compressed_vcf_index_file} class_level call_set run_if zip_vcf skipif

broken_pipe_status=141

#get samples in this vcf file
!!expand:,:ftype,sbtype,col:bam,sample_bam,2:sample,passed_sample,1! \
local cmd make_call_set_ftype_list_file=$smart_join_cmd --ignore-status $broken_pipe_status --exec "$zcat_helper(call_set) !{input,,call_set_compressed_vcf_file} !{input,call_set_compressed_vcf_index_file,if_prop=zip_vcf,allow_empty=1} | $vcf_utils_cmd !{input,--samp-map,call_set_sample_vcf_id_to_sample_id_file} --print-samps | cat - !{input,,project_sbtype_list_file} | cut -f1 | sort | uniq -d" !{input,--file,project_sbtype_list_file} --rest-extra 1 --out-delim $tab | cut -fcol > !{output,,call_set_ftype_list_file} class_level call_set run_if do_merge

variant_site_vcf_helper=awk -v OFS="\t" -F "\t" '/^\#\#fileformat/ {print} @1 !/^\#\#/  {print \$1,\$2,\$3,\$4,\$5,\$6,\$7,\$8}'
variant_site_remove_vcf_helper=$variant_site_vcf_helper(!/^\#/ {\$8 = "."})

prop zip_vcf=scalar default .gz

short cmd make_call_set_variant_site_vcf_file=$zcat_helper(call_set) !{input,,call_set_compressed_vcf_file} !{input,call_set_compressed_vcf_index_file,if_prop=zip_vcf,allow_empty=1} | cut -f1-8 | $variant_site_remove_vcf_helper > !{output,,call_set_variant_site_vcf_file} class_level call_set

project_variant_site_helper=rm -f !{output,,project_variant_site_vcf_file} && $project_merge_vcf_helper(-l OFF -o /dev/stdout,call_set_variant_site_vcf_file,) -sites_only -minimalVCF | $vcf_utils_cmd --add-id

prop call_filtered=scalar default 1

short cmd make_project_variant_site_vcf_file=$project_variant_site_helper > !{output,,project_variant_site_vcf_file} class_level project run_if !call_filtered

short cmd make_project_all_variant_site_vcf_file=$project_variant_site_helper | awk -F"\t" -v OFS="\t" '/^[^\#]/ {\$7="$vcf_pass"} {print}' > !{output,,project_variant_site_vcf_file} class_level project run_if call_filtered

#local cmd cp_project_variant_site_vcf_file=rm -f !{output,,project_variant_site_vcf_file} && $vcf_utils_cmd --add-id !{input,,call_set_variant_site_vcf_file} > !{output,,project_variant_site_vcf_file} class_level project skip_if do_merge

short cmd make_project_variant_site_interval_list_file=egrep -v '^\#' !{input,,project_variant_site_vcf_file} | cut -f1-2 | sed 's/\t/:/' | uniq > !{output,,project_variant_site_interval_list_file} class_level project

!|expand:,:shortt,projectt,outtype,intype,expost:\
short,project,snp,,skip_if num_merge_subsets run_with project_variant_subset:\
short,project_merge_subset,snp,,skip_if !num_merge_subsets bsub_batch 20:\
short,project,indel,indel_,skip_if num_merge_subsets run_with project_variant_subset:\
local,project_merge_subset,indel,indel_,skip_if !num_merge_subsets bsub_batch 20|\
shortt cmd make_projectt_outtype_id_site_vcf_file=$zcat_helper(projectt) !{input,,projectt_intypevcf_file} | cut -f1-8 > !{output,,projectt_outtype_id_site_vcf_file} class_level projectt run_with project_variant_subset expost

short cmd make_project_merge_subset_variant_site_interval_list_file=awk 'NR >= !{prop,,project_merge_subset,merge_start} && NR < !{prop,,project_merge_subset,merge_end}' !{input,,project_variant_site_interval_list_file} > !{output,,project_merge_subset_variant_site_interval_list_file} class_level project_merge_subset

!!expand:,:keyext,fileext:,:_clean,.clean:_indel,.indel:_clean_indel,.clean.indel:_multiallelic,.multiallelic:_clean_multiallelic,.clean.multiallelic! \
meta_table cmd make_project_project_merge_subsetkeyext_vcf_list_file=!{input,project_project_merge_subset_meta_file} !{input,,project_merge_subset_variant_site_interval_list_file} !{input,,project_merge_subsetkeyext_vcf_file} !{output,project_project_merge_subsetkeyext_vcf_list_file} class_level project run_if num_merge_subsets 

!!expand:,:keyext,fileext:,:_clean,.clean:_indel,.indel:_clean_indel,.clean.indel:_multiallelic,.multiallelic:_clean_multiallelic,.clean.multiallelic! \
meta_table cmd make_project_projectkeyext_vcf_list_file=!{input,,project_expanded_interval_list_file} !{input,,projectkeyext_vcf_file} !{output,project_project_merge_subsetkeyext_vcf_list_file} class_level project skip_if num_merge_subsets 

!!expand:,:keyext,fileext:,:_clean,.clean:_indel,.indel:_clean_indel,.clean.indel:_multiallelic,.multiallelic:_clean_multiallelic,.clean.multiallelic! \
short cmd make_project_variant_subset_project_merge_subsetkeyext_vcf_list_file=cat !{input,,project_project_merge_subsetkeyext_vcf_list_file} | perl -lne 'BEGIN {open (IN, "!{input,,project_variant_subset_var_keep_file}") or die; while (<IN>) {chomp; @a = split(); \$m{\$a[0]}{\$a[1]} = 1} close IN} chomp; @a = split; open (IN, \$a[0]) or die; while (<IN>) {chomp; @b = split(":"); if (exists \$m{\$b[0]} && exists \$m{\$b[0]}{\$b[1]}) {print "\$a[1]"; close IN; last}} close IN;' > !{output,,project_variant_subset_project_merge_subsetkeyext_vcf_list_file} class_level project_variant_subset

short cmd make_project_merge_subset_call_set_vcf_list_file=echo !{raw,,call_set,*call_set_all_sites_site_vcf_file *call_set_all_sites_vcf_file @call_set,unless_prop=failed,sep=\,} | sed 's/,/\n/g' !{input,call_set_all_sites_site_vcf_file,unless_prop=failed} !{input,call_set_all_sites_vcf_file,unless_prop=failed} | perl -lne 'BEGIN {open (IN, "!{input,,project_merge_subset_variant_site_interval_list_file}") or die; while (<IN>) {chomp; @a = split(/:/); \$m{\$a[0]}{\$a[1]} = 1} close IN} chomp; @a = split; open (IN, \$a[0]) or die; while (<IN>) {next if /\#/; @b = split("\t"); if (exists \$m{\$b[0]} && exists \$m{\$b[0]}{\$b[1]}) {print "\$a[1]\t\$a[2]"; close IN; last}} close IN' > !{output,,project_merge_subset_call_set_vcf_list_file} class_level project_merge_subset

!!expand:type:snp:indel! \
short cmd make_project_type_site_vcf_file=$vcf_type_selector < !{input,,project_variant_site_vcf_file} > !{output,,project_type_site_vcf_file} class_level project

short cmd make_project_variant_subset_variant_site_vcf_file=cat !{input,,project_variant_site_vcf_file} | $vcf_utils_cmd !{input,--chr-pos-keep,project_variant_subset_var_keep_file} > !{output,,project_variant_subset_variant_site_vcf_file} class_level project_variant_subset

!!expand:,:project,runif:project,skip_if num_var_subsets:project_variant_subset,run_if num_var_subsets! \
short cmd make_project_clean_all_variant_site_vcf_file=zcat !{input,,project_clean_all_vcf_file} | $variant_site_vcf_helper() > !{output,,project_clean_all_variant_site_vcf_file} class_level project runif

#vcf_indel_awk_helper=if (/^\\#/) {print; next;} @alt_alleles=split(",", \$F[4]); @multi_alt=(); @single_alt=(); foreach \$alt (@alt_alleles) {if (length(\$alt) > 1 || length(\$F[3]) > 1) {push @multi_alt, \$alt} else {push @single_alt, \$alt}} 
#vcf_indel_selector=perl -lane '$vcf_indel_awk_helper; if (length(\$F[3]) > 1 || @multi_alt) {\$F[4]=join(",", @multi_alt); print join("\t", @F)}'
#vcf_snp_selector=perl -lane '$vcf_indel_awk_helper; if (length(\$F[3]) == 1 && @single_alt) {\$F[4]=join(",", @single_alt); print join("\t", @F)}'

vcf_indel_selector=$vcf_utils_cmd --remove-snps
vcf_snp_selector=$vcf_utils_cmd --remove-non-snps

prop genotype_snps=scalar default 1
prop genotype_indels=scalar default 1

project_site_vcf_selector=!{input,,project_variant_site_vcf_file,if_prop=genotype_snps,if_prop=genotype_indels,allow_empty=1} !{input,,project_snp_site_vcf_file,if_prop=genotype_snps,unless_prop=genotype_indels,allow_empty=1} !{input,,project_indel_site_vcf_file,unless_prop=genotype_snps,if_prop=genotype_indels,allow_empty=1}

#get variant,alleles combinations unique to the project level file
#then print those followed by the full project level vcf file
#then print sites the second time you see them (i.e. the full vcf lines that have ids in the unique set)
short cmd make_call_set_missed_variants_site_vcf_file=cat !{input,,call_set_variant_site_vcf_file} !{input,,call_set_variant_site_vcf_file} $project_site_vcf_selector | grep -v \\\# | cut -f1-2,4-5 | sort | uniq -u | cat - $project_site_vcf_selector | awk -v OFS="\t" 'NF == 4 {print \$1,\$2,".",\$3,\$4} NF != 4 {print}' | awk '/^\\#/ || m[\$1":"\$2":"\$4":"\$5]++ == 1' > !{output,,call_set_missed_variants_site_vcf_file} class_level call_set skip_if failed

#CURRENT ISSUE: MULIPLE SITES WITH MULTIPLE ALLELES AT PRJECT LEVEL

#get chr,pos allele combinations unique to the original site file
#assuming no bug upstream, these must have different alleles
#print those followed by the call_set VCF file
#print the full VCF lines that are not in the common combinations
short cmd make_call_set_dis_removed_vcf_file=$zcat_helper(call_set) !{input,,call_set_compressed_vcf_file} !{input,call_set_compressed_vcf_index_file,if_prop=zip_vcf,allow_empty=1} | grep -v \\\# | cut -f1-2,4-5 | sort -u | awk -F"\t" -v OFS="\t" '{print \$1,\$2,".",\$3,\$4}' | cat - $project_site_vcf_selector $project_site_vcf_selector | grep -v \\\# | cut -f1-2,4-5 | sort | uniq -u | $smart_cut_cmd --no-delim --stdin-first --exec "$zcat_helper(call_set) !{input,,call_set_compressed_vcf_file}" | awk -v OFS="\t" '{if (/^\\#/) {print} else if (NF != 4 && !m[\$1":"\$2":"\$4":"\$5]) {print} else {m[\$1":"\$2":"\$3":"\$4]++}}' !{raw,,call_set,| $vcf_utils_cmd --remove-non-biallelic,if_prop=ignore_multiallelics,allow_empty=1} $bgzip_helper(call_set) > !{output,,call_set_dis_removed_vcf_file} $tabix_helper(call_set,call_set_dis_removed_vcf_file) class_level call_set skip_if failed run_if do_merge

variant_annot_vcf_helper=awk -v OFS="\t" -F "\t" '/^\#\#/ {print} !/^\#\#/  {print \$1,\$2,\$3,\$4,\$5,\$6,\$7,\$8}'

local cmd make_call_set_variant_annot_site_vcf_file=$zcat_helper(call_set) !{input,,call_set_dis_removed_vcf_file} | $variant_annot_vcf_helper > !{output,,call_set_variant_annot_site_vcf_file} class_level call_set run_if do_merge



call_set_subsets_meta_helper=cs="{1..!{prop,,call_set,num_call_set_subsets}}" && (echo "cs\$cs  class call_set_subset" && echo "cs\$cs parent !{prop,,call_set}" && echo "cs\$cs call_set_subset_num \$cs")
call_set_sample_subsets_meta_helper=css="{1..!{prop,,call_set,num_call_set_sample_subsets}}" && (echo "css\$css  class call_set_sample_subset" && echo "css\$css parent !{prop,,call_set}" && echo "css\$css call_set_sample_subset_num \$css")

local cmd make_call_set_call_set_subsets_meta_file=$call_set_subsets_meta_helper > !{output,,call_set_call_set_subsets_meta_file} class_level call_set run_if and,num_call_set_subsets,!num_call_set_sample_subsets

local cmd make_call_set_call_set_sample_subsets_meta_file=($call_set_subsets_meta_helper && $call_set_sample_subsets_meta_helper) > !{output,,call_set_call_set_subsets_meta_file} class_level call_set run_if and,num_call_set_subsets,num_call_set_sample_subsets

local cmd make_project_chr_map_file=(echo $plink_chrX $chrX && echo $plink_chrY $chrY && echo $plink_chrXY $chrXY &&  echo $plink_chrM $chrM) > !{output,,project_chr_map_file} class_level project

split_helper=perl -ne 'BEGIN {use POSIX "ceil"; \$size = `grep -v \\\# @1 | wc -l`; \$ntot = !{prop,,@{2}_subset,num_@{2}_subsets}; \$size = ceil(\$size / \$ntot); \$i = 0; \$cur_num = !{prop,,@{2}_subset,@{2}_subset_num}; die "Bad number: \$cur_num" unless \$cur_num > 0 && \$cur_num <= \$ntot} print if (/^\\#/ || (\$i >= (\$cur_num - 1) * \$size && \$i < (\$cur_num * \$size))); \$i++'

prop num_call_set_subsets=scalar
prop call_set_subset_num=scalar
prop num_call_set_sample_subsets=scalar
prop call_set_sample_subset_num=scalar
split_call_set_file_helper=$split_helper(@1,call_set)

prop do_merge=scalar default 1
prop recall_all=scalar default 1
a
#Use only missed sites as template for call_set_subset_missed_sites_interval_list_file

local cmd make_call_set_subset_missed_variants_site_vcf_file=$split_call_set_file_helper(!{input\\,\\,call_set_missed_variants_site_vcf_file}) < !{input,,call_set_missed_variants_site_vcf_file} > !{output,,call_set_subset_missed_variants_site_vcf_file} class_level call_set_subset run_if and,do_merge,!failed,!recall_all

#Use all variant sites as template for call_set_subset_missed_sites_interval_list_file
local cmd make_call_set_subset_all_variants_site_vcf_file=$split_helper("$project_site_vcf_selector",call_set) < $project_site_vcf_selector > !{output,,call_set_subset_missed_variants_site_vcf_file} class_level call_set_subset run_if and,do_merge,!failed,recall_all

#cmd make_call_set_subset_missed_sites_temp_vcf_file=$gatk_cmd_no_interval(UnifiedGenotyper) -l INFO !{output,--out,call_set_subset_missed_sites_temp_vcf_file} !{input,-I,call_set_bam_list_file} !{input,sample_bam_file,unless_prop=failed} !{input,-L,call_set_subset_missed_sites_interval_list_file} -all_bases class_level call_set_subset run_if and,do_merge,!failed

#clean_vcf_helper=awk -F"\t" '/^\\#/ || NF != 8' !{input,,@1} | perl $targeted_bin_dir/add_freq_meta_field.pl > !{output,,@2}

#local cmd make_call_set_subset_missed_sites_vcf_file=$clean_vcf_helper(call_set_subset_missed_sites_temp_vcf_file,call_set_subset_missed_sites_vcf_file) class_level call_set_subset run_if and,do_merge,!failed

local cmd make_call_set_sample_subset_bam_list_file=$split_helper(!{input::call_set_bam_list_file},call_set_sample) < !{input::call_set_bam_list_file} > !{output,,call_set_sample_subset_bam_list_file} class_level call_set_sample_subset

!|expand:,:call_set_subsetl,bamlist,runif:call_set_subset,call_set_bam_list_file,!num_call_set_sample_subsets:call_set_sample_subset,call_set_sample_subset_bam_list_file,num_call_set_sample_subsets| \
short cmd make_call_set_subsetl_missed_variants_vcf_file=$gatk_cmd_no_interval(UnifiedGenotyper) !{output,-o,call_set_subsetl_missed_variants_vcf_file} !{input,-I,bamlist,is_list=1} --output_mode EMIT_ALL_SITES --alleles !{raw,,call_set_subset,*call_set_subset_missed_variants_site_vcf_file} !{raw,-L,call_set_subset,*call_set_subset_missed_variants_site_vcf_file} !{input,call_set_subset_missed_variants_site_vcf_file} -gt_mode GENOTYPE_GIVEN_ALLELES -glm BOTH -stand_call_conf 0.0  !{raw,-A,call_set,FisherStrand,if_prop=genotype_indels,allow_empty=1} $tabix_helper(call_set_subsetl,call_set_subsetl_missed_variants_vcf_file) class_level call_set_subsetl run_if and,do_merge,!failed,runif

short cmd make_merge_call_set_subset_missed_variants_vcf_file=$gatk_cmd(CombineVariants) !{output,-o,call_set_subset_missed_variants_vcf_file} !{raw,,call_set_sample_subset,--variant:@call_set_sample_subset *call_set_sample_subset_missed_variants_vcf_file} !{input,call_set_sample_subset_missed_variants_vcf_file} $require_unique_helper -filteredRecordsMergeType KEEP_IF_ANY_UNFILTERED -priority "!{prop,,call_set_sample_subset,sep=\,}" $bgzip_helper(call_set_subset) $tabix_helper(call_set_subset,call_set_subset_missed_variants_vcf_file) class_level call_set_subset run_if and,do_merge,!failed,num_call_set_sample_subsets

called_tag=called
uncalled_tag=uncalled

remove_info_from_missed_sites=$vcf_utils_cmd --remove-info AB --remove-info AF --remove-info AN --remove-info DP

short cmd make_call_set_missed_sites_vcf_file=rm -f !{output,,call_set_missed_sites_vcf_file} && $gatk_cmd(CombineVariants) !{output,-o,call_set_missed_sites_vcf_file} !{raw,,call_set_subset,--variant:@call_set_subset *call_set_subset_missed_variants_vcf_file} !{input,call_set_subset_missed_variants_vcf_file} $require_unique_helper -filteredRecordsMergeType KEEP_IF_ANY_UNFILTERED -priority "!{prop,,call_set_subset,sep=\,}" | $remove_info_from_missed_sites $bgzip_helper(call_set) $tabix_helper(call_set,call_set_missed_sites_vcf_file) class_level call_set run_if and,do_merge,!failed rusage_mod $missed_sites_mem

call_set_all_sites_vcf_file_helper=rm -f !{output,,call_set_all_sites_vcf_file} && $gatk_cmd(CombineVariants) @1 !{raw,,call_set,--variant:$called_tag *@2} !{raw,,call_set,--variant:$uncalled_tag *call_set_missed_sites_vcf_file} !{input,@2} !{input,call_set_missed_sites_vcf_file} -genotypeMergeOptions PRIORITIZE -filteredRecordsMergeType KEEP_IF_ANY_UNFILTERED -priority "$uncalled_tag,$called_tag"

#Set to map sample ids within call set
#Use when different call sets have samples with the same id
prop map_samples_within_call_set=scalar default 0

short cmd ln_call_set_all_sites_vcf_file=rm -f !{output,,call_set_all_sites_vcf_file} && ln -s !{input,,call_set_compressed_vcf_file} !{output,,call_set_all_sites_vcf_file} $tabix_helper(call_set,call_set_all_sites_vcf_file) class_level call_set run_if and,!do_merge,!map_samples_within_call_set

short cmd map_call_set_all_sites_vcf_file=$zcat_helper(call_set) !{input,,call_set_compressed_vcf_file} | if [[ `cat !{input,,call_set_sample_vcf_id_to_sample_id_file} | wc -l` -gt 0 ]]; then $vcf_utils_cmd !{input,--samp-map,call_set_sample_vcf_id_to_sample_id_file}; else cat -; fi $bgzip_helper(call_set) > !{output,,call_set_all_sites_vcf_file} $tabix_helper(call_set,call_set_all_sites_vcf_file) class_level call_set run_if and,!do_merge,map_samples_within_call_set

short cmd replace_call_set_all_sites_vcf_file=$zcat_helper(call_set) !{input,,call_set_missed_sites_vcf_file} | $vcf_utils_cmd !{input,--samp-map,call_set_sample_vcf_id_to_sample_id_file} $bgzip_helper(call_set) > !{output,,call_set_all_sites_vcf_file} $tabix_helper(call_set,call_set_all_sites_vcf_file) class_level call_set run_if and,do_merge,recall_all

short cmd make_call_set_all_sites_vcf_file=$call_set_all_sites_vcf_file_helper(-l OFF -o /dev/stdout,call_set_dis_removed_vcf_file) | $vcf_utils_cmd !{input,--samp-map,call_set_sample_vcf_id_to_sample_id_file} $bgzip_helper(call_set) > !{output,,call_set_all_sites_vcf_file} $tabix_helper(call_set,call_set_all_sites_vcf_file) class_level call_set run_if and,do_merge,!failed,!recall_all

#Second half here removes sites not on missed sites file --- with current version of GATK (Jan 2011), sites that are no-called in everyone are not output as part of all_bases

#cmd make_and_filter_call_set_all_sites_vcf_file=$call_set_all_sites_vcf_file_helper(-l OFF -o /dev/stdout) | $vcf_utils_cmd !{input,--reference-vcf,call_set_missed_sites_vcf_file} --valid-chr-pos > !{output,,call_set_all_sites_vcf_file} class_level call_set run_if and,do_merge,!failed,recall_all


#due to change in annotation, dbSNP membership flag is screwing up between different VCF versions
#That is, some call set subsets have dbsnp as a flag, others as an integer
#This causes the merge at the project level to screw up
#So, the second set of commands will strip the dbsnp header from the VCF files
#Once all filtered.maf_annotated.vcfs are rerun with latest version of GATK, can use first set of commands instead
#BEGIN FIRST
#cmd make_call_set_ab_annotated_vcf_file=rm -f !{output,,call_set_ab_annotated_vcf_file} && $gatk_cmd(CombineVariants) -l INFO !{output,-o,call_set_ab_annotated_vcf_file} !{raw,,call_set_subset,--variant:@call_set_subset *call_set_subset_ab_annotated_vcf_file} !{input,call_set_subset_ab_annotated_vcf_file} -genotypeMergeOptions REQUIRE_UNIQUE -variantMergeOptions INTERSECT -priority "!{prop,,call_set_subset,sep=\,}" class_level call_set skip_if or,one_call_set_subset,failed,ab_from_ad

#local cmd ln_call_set_ab_annotated_vcf_file=rm -f !{output,,call_set_ab_annotated_vcf_file} && ln -s !{input,,call_set_subset_ab_annotated_vcf_file} !{output,,call_set_ab_annotated_vcf_file} class_level call_set run_if and,one_call_set_subset,!failed,!ab_from_ad

#local cmd make_call_set_ab_annotated_vcf_file_from_ad=$vcf_utils_cmd < !{input,,call_set_all_sites_vcf_file} --ab-from-ad > !{output,,call_set_ab_annotated_vcf_file} class_level call_set run_if ab_from_ad
#END FIRST
#BEGIN SECOND

handle_dbsnp_hack=sed '/^\#\#INFO=<ID=DB/d'

#this is what is added to the VCF
prop vcf_utils_add_dosage_field=scalar default DOS

prop add_gq=scalar default 0
prop ensure_pl=scalar default 1
prop require_samples=scalar default 1

thresholded_nalt_field=NALTT

prop sex_for_dosage=scalar

vcf_utils_processing_flags=--add-id --remove-dup-ids --remove-dup-vars --add-num-nonref --add-dosage !{prop,--dosage-annot,project,vcf_utils_add_dosage_field} !{input,--sample-gender-file,pheno_non_missing_sample_pheno_file,if_prop=sex_for_dosage,if_prop=pheno:eq:@sex_for_dosage,max=1,allow_empty=1} !{input,--sample-gender-file,project_sample_genetic_sex_file,unless_prop=sex_for_dosage,unless_prop=no_x_chrom,allow_empty=1} --x-chrom $chrX `echo $chrX_par | sed 's/\(^\|\s\s*\)\(\S\S*\)/\1--par \2/g'` !{raw,,project,--add-gq,if_prop=add_gq,allow_empty=1} !{raw,,project,--add-thresholded-nalt @gq_crit} --fix-pass --round-format GQ !{input,--samp-map,project_sample_vcf_id_to_sample_id_file,unless_prop=map_samples_within_call_set,unless_prop=do_merge,allow_empty=1} !{input,--samp-require,project_passed_sample_list_file,if_prop=require_samples,allow_empty=1} --require-unique !{input,--samp-keep,project_passed_sample_list_file} 

prop add_protein_change=scalar

#do not use any type of sample level AB annotation
prop no_sample_ab=scalar
#any genotype with malformatted format, set to missing
prop append_missing_malformatted_format=scalar
#inform the pipeline that the VCF already has AB annotations -- useful to skip running time of annotating 
#in the future, pipeline should be able to recognize this on the fly
prop ab_present=scalar

#local cmd ln_call_set_ab_annotated_vcf_file=rm -f !{output,,call_set_ab_annotated_vcf_file} && ln -s !{input,,call_set_all_sites_vcf_file} !{output,,call_set_ab_annotated_vcf_file} $tabix_helper(call_set,call_set_ab_annotated_vcf_file) class_level call_set 

short cmd make_call_set_all_sites_site_vcf_file=$zcat_helper(call_set) !{input,,call_set_all_sites_vcf_file,if_prop=do_merge,if_prop=map_samples_within_call_set,or_if_prop=1,allow_empty=1} !{input,,call_set_compressed_vcf_file,unless_prop=do_merge,unless_prop=map_samples_within_call_set,allow_empty=1} | cut -f1-8 | $variant_site_vcf_helper() > !{output,,call_set_all_sites_site_vcf_file} class_level call_set

#END SECOND

#project_subset commands

prop num_project_subsets=scalar
prop project_subset_num=scalar
#local cmd make_project_subset_interval_list_file=grep -v \@ !{input,,project_expanded_interval_list_file} | $split_interval_file_helper(project_expanded_interval_list_file,project) | awk '{print \$1":"\$2"-"\$3}' > !{output,,project_subset_interval_list_file} class_level project_subset

#samtools_mpileup_cmd=$samtools_cmd mpileup -r @1 -C50 -DSug -f $reference_file !{input,-b,project_bam_list_file} | $bcftools_cmd view -vcg - | sed 's/\(^#.*PL,Number\)=[^,]*,/\1=3,/'

#cmd make_project_subset_samtools_vcf_file=rm -f !{output,,project_subset_samtools_vcf_file} && $samtools_mpileup_cmd("`awk 'NR == 1' !{input,,project_subset_interval_list_file}`") >> !{output,,project_subset_samtools_vcf_file} && for f in `tail -n+2 !{input,,project_subset_interval_list_file}`; do ($samtools_mpileup_cmd(\$f) | (grep -v \\# || true) >> !{output,,project_subset_samtools_vcf_file}) || exit 1; done class_level project_subset

#project

#cmd make_project_samtools_vcf_file=$gatk_cmd(CombineVariants) !{output,-o,project_samtools_vcf_file} !{raw,,project_subset,--variant:@project_subset *project_subset_samtools_vcf_file} !{input,project_subset_samtools_vcf_file} -genotypeMergeOptions PRIORITIZE -variantMergeOptions INTERSECT -priority "!{prop,,project_subset,sep=\,}" class_level project

prop validate_unique=scalar default 0
require_unique_helper=!{raw,-genotypeMergeOptions,project,REQUIRE_UNIQUE,if_prop=validate_unique,allow_empty=1}
merge_vcf_helper=$require_unique_helper -filteredRecordsMergeType KEEP_IF_ANY_UNFILTERED
project_merge_vcf_helper=$gatk_cmd(CombineVariants) @1 !{raw,,call_set,--variant:\@call_set *@2,unless_prop=failed@3} !{input,@2,unless_prop=failed@3} -priority "!{prop,,call_set,sep=\,}" $merge_vcf_helper

prop union_filter=scalar default 1

#used to have this
#  | $vcf_utils_cmd !{input,--reference-vcf,project_variant_site_vcf_file} --valid-ref-alt removet !{input,--samp-map,project_sample_vcf_id_to_sample_id_file} \

#prop merge_chunk_size=scalar

queue_scratch_dir=$tmp_dir/queue
queue_lsf_queue=$lsf_short_queue

#local cmd make_scatter_project_merged_vcf_file=mkdir -p $queue_scratch_dir && java -Djava.io.tmpdir=$queue_scratch_dir -jar $queue_jar -S $sg_combine_scala_script !{input,-V,call_set_ab_annotated_vcf_file,unless_prop=failed} !{input,-L,project_expanded_interval_list_file,if_prop=expand_targets,allow_empty=1} !{input,-L,project_interval_list_file,unless_prop=expand_targets,allow_empty=1} !{output,-o,project_merged_vcf_file} --reference $reference_file -bsub -run -jobQueue $queue_lsf_queue !{prop,-c,project,merge_chunk_size} class_level project run_if and,do_merge,merge_chunk_size,!num_merge_subsets


cmd make_project_merged_vcf_file=$project_merge_vcf_helper(!{output:-o:project_merged_vcf_file},call_set_all_sites_vcf_file,) $tabix_helper(project,project_merged_vcf_file) class_level project skip_if num_merge_subsets rusage_mod $merge_vcf_mem

short cmd make_project_merge_subset_merged_vcf_file=$gatk_cmd_no_interval(CombineVariants) !{output,-o,project_merge_subset_merged_vcf_file} !{input,-L,project_merge_subset_variant_site_interval_list_file} `sed 's/\(\S\S*\)\s\s*\(\S\S*\)/--variant:\2 \1/'  !{input,,project_merge_subset_call_set_vcf_list_file}` !{input,call_set_all_sites_vcf_file} `cut -f2 !{input,,project_merge_subset_call_set_vcf_list_file} !{input,call_set_all_sites_site_vcf_file} | tr '\n' , | sed 's/,$//' | sed 's/^/-priority /'` $merge_vcf_helper $tabix_helper(project_merge_subset,project_merge_subset_merged_vcf_file) class_level project_merge_subset run_if num_merge_subsets 

prop no_x_chrom=scalar

!|expand:,:shortt,projectt,expost:,project,skip_if num_merge_subsets:short,project_merge_subset,skip_if !num_merge_subsets| \
shortt cmd make_projectt_for_genetic_sex_plink_files=(!{raw,,projectt,cat *projectt_merged_vcf_file,unless_prop=zip_vcf,allow_empty=1}!{raw,,projectt,zcat *projectt_merged_vcf_file | $vcf_utils_cmd --print-header; $tabix_cmd *projectt_merged_vcf_file $chrX,if_prop=zip_vcf,allow_empty=1}) !{input,projectt_merged_vcf_file} | $vcf_utils_cmd !{input,--samp-map,project_sample_vcf_id_to_sample_id_file,unless_prop=map_samples_within_call_set,unless_prop=do_merge,allow_empty=1} | $pseq_cmd - write-ped $gq_mask --mask filter=$vcf_pass --mask biallelic --mask indel.ex --name !{raw,,projectt,*projectt_for_genetic_sex_plink_file} !{output,projectt_for_genetic_sex_tfam_file} !{output,projectt_for_genetic_sex_tped_file} class_level projectt expost run_if !no_x_chrom

short cmd make_cat_project_for_genetic_sex_plink_files=cp !{input,,project_merge_subset_for_genetic_sex_tfam_file,limit=1} !{output,,project_for_genetic_sex_tfam_file} && cat !{input,,project_merge_subset_for_genetic_sex_tped_file} > !{output,,project_for_genetic_sex_tped_file} class_level project run_if num_merge_subsets skip_if no_x_chrom

short cmd make_project_genetic_sex_sexcheck_file=echo $chrX_par | sed 's/\s\s*/\n/g' | sed 's/-/\t/' | sed 's/^/$plink_chrX\t/' | awk -v OFS="\t" -F"\t" '{print \$0,"R"NR}' | $plink_cmd !{input,--tped,project_for_genetic_sex_tped_file} !{input,--tfam,project_for_genetic_sex_tfam_file} --exclude /dev/stdin --range $plink_analysis_helper(project_genetic_sex_sexcheck_file,check-sex --maf 0.05 --geno 0.1,sexcheck,project_genetic_sex_sexcheck_log_file) class_level project skip_if no_x_chrom

het_for_sex=.6

local cmd make_project_sample_genetic_sex_file=awk -v OFS="\t" 'NR > 1 && \$6 > $het_for_sex {print \$1,1} NR > 1 && \$6 < (1 - $het_for_sex) {print \$1,2}' !{input,,project_genetic_sex_sexcheck_file} > !{output,,project_sample_genetic_sex_file} class_level project skip_if no_x_chrom

#local cmd make_cat_project_merged_vcf_file=rm -f !{output,,project_merged_vcf_file} && ($zcat_helper(project) !{input,,call_set_ab_annotated_vcf_file,limit=1} | grep  '^\\#' && $zcat_helper(project) !{input,,call_set_ab_annotated_vcf_file} | grep -v '^\\#') $bgzip_helper(project) > !{output,,project_merged_vcf_file} $tabix_helper(project,project_merged_vcf_file) class_level project skip_if num_merge_subsets run_if !multiple_call_sets

!|expand:,:shortt,projectt,expost:,project,skip_if num_merge_subsets rusage_mod $initial_vcf_mem:short,project_merge_subset,skip_if !num_merge_subsets rusage_mod $initial_merge_vcf_mem| \
!|expand:,:keyname,vartype,removet,removeb:,snp,--remove-non-snps,--remove-non-biallelic:indel_,indel,--remove-snps,--remove-non-biallelic:multiallelic_,multiallelic,,--remove-biallelic| \
shortt cmd make_projectt_keynamevcf_file=rm -f !{output,,projectt_keynamevcf_file} && $zcat_helper(projectt) !{input,,projectt_merged_vcf_file} \
	!{raw,,project,| $vcf_utils_cmd --append-missing-malformatted-format,if_prop=append_missing_malformatted_format,allow_empty=1} \
	| $vcf_utils_cmd $vcf_utils_processing_flags removet removeb !{raw,,project,--ensure-pl,if_prop=ensure_pl,allow_empty=1} !{raw,,project,--ab-from-ad,unless_prop=no_sample_ab,unless_prop=ab_present,allow_empty=1} !{raw,,project,--het-ad-from-ad,unless_prop=no_sample_ab,allow_empty=1} \
  | $vcf_utils_cmd !{input,--var-excl,projectt_snp_indel_overlap_file} \
  !{raw,,project,| $vcf_utils_cmd --valid-filter,if_prop=do_merge,allow_empty=1} !{input,--chr-pos-keep,projectt_variant_site_interval_list_file,if_prop=do_merge,allow_empty=1} !{input,--reference-vcf,call_set_variant_site_vcf_file,unless_prop=failed,if_prop=genotype_vartypes,if_prop=do_merge,allow_empty=1} !{raw,,projectt,--union-filter,if_prop=union_filter,if_prop=do_merge,allow_empty=1} \
  !{raw,,project,| $vcf_utils_cmd --sum-info  $vcf_mq0_annot --sum-info $vcf_het_ad_annot,if_prop=do_merge,allow_empty=1} !{input,--chr-pos-keep,projectt_variant_site_interval_list_file,if_prop=do_merge,allow_empty=1} !{input,--reference-vcf,call_set_all_sites_site_vcf_file,unless_prop=failed,if_prop=genotype_vartypes,if_prop=do_merge,allow_empty=1} \
  !{raw,,project,| $vcf_utils_cmd --het-ab-from-het-ad,unless_prop=no_sample_ab,allow_empty=1} $bgzip_helper(projectt) \
  > !{output,,projectt_keynamevcf_file} $tabix_helper(projectt,projectt_keynamevcf_file) class_level projectt expost

select_variants_cmd=$gatk_cmd(SelectVariants) -o @2 !{input,--variant,@1} !{input,--sample_file,@3} --ALLOW_NONOVERLAPPING_COMMAND_LINE_SAMPLES --excludeNonVariants -l @4
project_merge_subset_select_variants_cmd=$gatk_cmd_no_interval(SelectVariants) !{input,-L,project_merge_subset_variant_site_interval_list_file} -o @2 !{input,--variant,@1} !{input,--sample_file,@3} --ALLOW_NONOVERLAPPING_COMMAND_LINE_SAMPLES --excludeNonVariants -l @4

#!|expand:,:projectt,expost:project,skip_if num_merge_subsets:project_merge_subset,skip_if !num_merge_subsets| \
#!!expand:type:snp:indel! \
#short cmd make_projectt_subsetted_type_vcf_file=$conditional_exec_cmd \
#  --cond-cmd "perl -e '\\$wc = `$zcat_helper(projectt) !{input,,projectt_initial_type_vcf_file} | $vcf_utils_cmd --print-samps  | sort - !{input,,project_passed_sample_list_file} | uniq -u | wc -l`; if (\\$wc == 0) {exit 1} else {exit 2}'" \
#	--pred-cmd 1,"rm -f !{output,,projectt_subsetted_type_vcf_file} && ln -s !{input,,projectt_initial_type_vcf_file} !{output,,projectt_subsetted_type_vcf_file} $tabix_helper(projectt,projectt_subsetted_type_vcf_file)" \ 
#	--pred-cmd 2,"rm -f !{output,,projectt_subsetted_type_vcf_file} && $select_variants_cmd(projectt_initial_type_vcf_file,/dev/stdout,project_passed_sample_list_file,OFF) $bgzip_helper(project) > !{output,,projectt_subsetted_type_vcf_file} $tabix_helper(projectt,projectt_subsetted_type_vcf_file)" class_level projectt run_if do_merge expost

#force SelectVariants to run if one_call_set_subset to make sure variants outside of interval list are removed


#!!expand:type:snp:indel! \
#short cmd make_project_force_subsetted_type_vcf_file=rm -f !{output,,project_subsetted_type_vcf_file} && $select_variants_cmd(project_initial_type_vcf_file,/dev/stdout,project_passed_sample_list_file,OFF) $bgzip_helper(project) > !{output,,project_subsetted_type_vcf_file} $tabix_helper(project,project_subsetted_type_vcf_file) class_level project skip_if do_merge



#!|expand:,:shortt,projectt,expost:local,project,skip_if num_merge_subsets:short,project_merge_subset,skip_if !num_merge_subsets| \
#shortt cmd make_projectt_vcf_file=$zcat_helper(projectt) !{input,,projectt_subsetted_snp_vcf_file} \
#			    $bgzip_helper(projectt) > !{output,,projectt_vcf_file} $tabix_helper(projectt,projectt_vcf_file) class_level projectt expost

!|expand:;:shortt;catfile;exskipif:\
;vcf;:\
;clean_vcf;skip_if and,!sample_qc_filter,!var_qc_filter,!project_variant_custom_exclude_file,!project_sample_custom_exclude_file:\
short;indel_vcf;:\
short;clean_indel_vcf;skip_if and,!sample_qc_filter,!var_qc_filter,!project_variant_custom_exclude_file,!project_sample_custom_exclude_file:\
;multiallelic_vcf;:\
;clean_multiallelic_vcf;skip_if and,!sample_qc_filter,!var_qc_filter,!project_variant_custom_exclude_file,!project_sample_custom_exclude_file|\
shortt cmd cat_project_catfile_file=rm -f !{output,,project_catfile_file} && ($zcat_helper(project) !{input,,project_merge_subset_catfile_file,limit=1} | grep '^\\#' && $zcat_helper(project) !{input,,project_merge_subset_catfile_file} | awk '!/^\\#/') $bgzip_helper(project) > !{output,,project_catfile_file} $tabix_helper(project,project_catfile_file) class_level project run_if num_merge_subsets exskipif run_with project_sample_subset,project_variant_subset

!|expand:;:shortt;catfile;exskipif:\
short;snp_id_site_vcf;:\
short;indel_id_site_vcf;|\
shortt cmd cat_no_bgzip_project_catfile_file=rm -f !{output,,project_catfile_file} && (cat !{input,,project_merge_subset_catfile_file,limit=1} | grep '^\\#' && cat !{input,,project_merge_subset_catfile_file} | awk '!/^\\#/') > !{output,,project_catfile_file} class_level project run_if num_merge_subsets exskipif run_with project_sample_subset,project_variant_subset


cmd cat_project_clean_all_vcf_file=rm -f !{output,,project_clean_all_vcf_file} && (zcat !{input,,project_merge_subset_clean_all_vcf_file,limit=1} | grep '^\\#' && zcat !{input,,project_merge_subset_clean_all_vcf_file} | awk '!/^\\#/') | $bgzip_cmd > !{output,,project_clean_all_vcf_file} && !{raw,,project,$run_tabix_cmd(project_clean_all_vcf_file)} class_level project run_if num_merge_subsets

#defined scope of project subsets
prop samp_start=scalar
prop samp_end=scalar

prop var_start=scalar
prop var_end=scalar

prop merge_start=scalar
prop merge_end=scalar

prop var_subset_num=scalar

prop expand_subset_num=scalar
#prop expand_subset=scalar

#Generate the subsets
prop num_samp_subsets=scalar
prop num_var_subsets=scalar
prop mean_expand_pheno_subsets=scalar
prop expand_pheno_subsets=scalar
prop num_merge_subsets=scalar

#in case some shouldn't be analyzed

#at project level; indicate is empty for clean file
prop empty_clean_subsets=list
#at pheno level: each element is two columns: variant subset, expand subset number
prop exclude_subset=list


#depend on variant subset meta file just to ensure that they are both built at the same time
#e.g., don't want to defer all variant subset commands
local cmd make_project_project_sample_subset_meta_file=perl -ne 'BEGIN {use POSIX "ceil"; \$n=0} \$n++; END {\$num_per = ceil(\$n / !{prop,,project,num_samp_subsets}); for (\$i = 0; \$i < !{prop,,project,num_samp_subsets}; \$i++) {\$b = \$i * \$num_per + 1; \$e = \$b + \$num_per; print "\$b\t\$e\n" if \$b <= \$n}}' < !{input,,project_plinkseq_ind_info_file} | awk '{n="!{prop,,project}_sample_subset_"NR; print n" class project_sample_subset\n"n" disp Sample subset "NR"\n"n" parent !{prop,,project}\n"n" samp_start "\$1"\n"n" samp_end "\$2}' > !{output,,project_project_sample_subset_meta_file} class_level project run_if num_samp_subsets with project_sample_subset run_with project_merge_subset

short cmd make_project_subset_vars_file=$smart_join_cmd --exec "cat !{input,,project_gene_target_file} !{input,,project_transcript_target_file} | sort -nk2,2 -k3,3 | $add_gene_annot_cmd --in-delim $tab --outside-name $outside_gene_name --keep-outside --chr-col 2 --pos-col 3 --gene-file !{input,,project_region_list_file} --out-delim $tab | cut -f1-2 | sed '1 s/^/0:0-1\t$outside_gene_name\n/' | sort -k2 | uniq -f1 | $smart_cut_cmd --in-delim $tab --select-col 0,'2 1'" --exec "cat !{input,,project_snp_site_vcf_file} !{input,,project_indel_site_vcf_file} | fgrep -v \\# | cut -f1-2 | sort -u | sed 's/$/\tvariant/' | $smart_cut_cmd --in-delim $tab --exec \"$smart_cut_cmd --in-delim $tab !{input,--file,project_expanded_exon_target_file} --select-col 1,3-4 !{input,--file,project_expanded_exon_target_file} --select-col 2,'3 5' | sed 's/$/\ttarget/'\" | sort -nk 1,1 -k 2,2 | $add_gene_annot_cmd --in-delim $tab --outside-name $outside_gene_name --print-multiple --keep-outside --chr-col 1 --pos-col 2 !{input,--gene-file,project_gene_target_file} !{input,--gene-file,project_transcript_target_file} --out-delim $tab" --in-delim $tab --multiple 2 --extra 1 | cut -f2- | sort -k2,2 -k3,3n | uniq > !{output,,project_subset_vars_file} class_level project run_if num_var_subsets run_with project_merge_subset

get_subset_vars=cat !{input,,project_subset_vars_file}

local cmd make_project_project_variant_subset_meta_file=n=`$get_subset_vars | wc -l` && $get_subset_vars | perl -ne 'BEGIN {use POSIX "ceil"; \$n = 1; \$v = 0; @starts = (1); \$num_per = ceil('"\$n"' / !{prop,,project,num_var_subsets}); \$next = \$num_per} @a = split; if (\$n >= \$next && defined \$reg && (\$reg eq "$outside_gene_name" || \$reg ne \$a[0])) {push @starts, \$n if \$v > 0; \$v = 0; \$next = \$n + \$num_per} \$n++; \$v++ if \$a[3] eq "variant"; \$reg = \$a[0]; END {if (\$starts[\$\#starts] != \$n) {push @starts, \$n if \$v > 0; \$v = 0;} for (\$i = 0; \$i < \$\#starts; \$i++) {print "\$starts[\$i]\t\$starts[\$i+1]\n";}}' | awk '{n="!{prop,,project}_variant_subset_"NR; print n" class project_variant_subset\n"n" disp Variant subset "NR"\n"n" parent !{prop,,project}\n"n" var_start "\$1"\n"n" var_end "\$2"\n"n" var_subset_num "NR}' > !{output,,project_project_variant_subset_meta_file} class_level project run_if num_var_subsets with project_variant_subset

annot_variant_subset_name=!{prop,,project}_!{prop,,annot,max=1}_variant_subset

local cmd make_annot_annot_variant_subset_meta_file=egrep "class project_variant_subset$" !{input,,project_project_variant_subset_meta_file} | sed 's/^\(!{prop,,project}_variant_subset_\(\S\S*\)\).*/\1 ${annot_variant_subset_name}_\2 \2/' | sed 's/^\(\S\S*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)/\2 class annot_variant_subset\n!select:!{prop,,project} \2 parent !{prop,,annot}\n\2 disp !{prop,,annot,disp} variant subset \3\n\2 consistent \1\n\2 var_subset_num \3/' > !{output,,annot_annot_variant_subset_meta_file} class_level annot run_if and,num_var_subsets,!annot_genes,!annot_manual_gene_list_file,!annot_manual_gene_variant_list_file with annot_variant_subset

local cmd make_annot_empty_annot_variant_subset_meta_file=rm -f !{output,,annot_annot_variant_subset_meta_file} && touch !{output,,annot_annot_variant_subset_meta_file} class_level annot skip_if and,num_var_subsets,!annot_genes,!annot_manual_gene_list_file,!annot_manual_gene_variant_list_file with annot_variant_subset

meta_table cmd make_dummy_project_project_variant_subset_pheno_expand_subset_file=!{prop,,project_variant_subset}\t!{prop,,project_variant_subset,expand_pheno_subsets,missing=1} !{output,project_project_variant_subset_pheno_expand_subset_file} class_level project with pheno skip_if mean_expand_pheno_subsets

local cmd make_project_project_variant_subset_pheno_expand_subset_file=cat !{input,,project_variant_subset_gene_burden_size_file} | perl -ne 'BEGIN {\$t=0; \$n = 0; @lines = ();} chomp; @F = split("\t"); \$t += \$F[1]; \$n++; push @lines, \$_; END {\$m = \$t / \$n; foreach (@lines) {@F = split("\t"); \$num = \$F[1] / \$m; \$num = 1 if (\$num < 1);  print "\$F[0]\t" . int(!{prop,,project,mean_expand_pheno_subsets} * \$num + .5) . "\n"}}' | $smart_cut_cmd --in-delim $tab --exec "perl -e 'print \"!{raw,,project_variant_subset,@project_variant_subset\t@expand_pheno_subsets,if_prop=expand_pheno_subsets,allow_empty=1}\"' | sed 's/ /\n/g' | awk 'NF > 1'" | awk -F"\t" -v OFS="\t" '!m[\$1] {print; m[\$1]=1}' > !{output,,project_project_variant_subset_pheno_expand_subset_file} class_level project run_if mean_expand_pheno_subsets with pheno

marker_subset_meta_file_helper=egrep "class project_@{1}_subset$" !{input,,project_project_@{1}_subset_meta_file} | sed 's/^\(!{prop,,project}_@{1}_subset_\(\S\S*\)\).*/\1 !{prop,,@{2}}_@{1}_subset_\2 \2/' | sed 's/^\(\S\S*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)/\2 class @{2}_@{1}_subset\n\2 parent \1\n\2 disp !{prop,,@{2},disp} @{1} subset \3\n\2 sort \3\n\2 consistent !{prop,,@{2}}\n!{prop,,@{2}} consistent \2@3/' > !{output,,@{2}_@{2}_@{1}_subset_meta_file}

!!expand:,:stype,sabbrv,extra:sample,samp,:variant,var,\n\2 var_subset_num \3! \
local cmd make_marker_marker_stype_subset_meta_file=$marker_subset_meta_file_helper(stype,marker,extra) class_level marker run_if num_sabbrv_subsets

local cmd make_project_project_merge_subset_meta_file=perl -ne 'BEGIN {use POSIX "ceil"; \$n=0} \$n++; END {\$num_per = ceil(\$n / !{prop,,project,num_merge_subsets}); for (\$i = 0; \$i < !{prop,,project,num_merge_subsets}; \$i++) {\$b = \$i * \$num_per + 1; \$e = \$b + \$num_per; print "\$b\t\$e\n"}}' < !{input,,project_variant_site_interval_list_file} | awk '{n="!{prop,,project}_merge_subset_"NR; print n" class project_merge_subset\n"n" disp Merge subset "NR"\n"n" parent !{prop,,project}\n"n" merge_start "\$1"\n"n" merge_end "\$2"\n"n" sort "NR}' > !{output,,project_project_merge_subset_meta_file} class_level project run_if num_merge_subsets with project_merge_subset

#Command to subset the VCF and clean VCF
local cmd make_project_sample_subset_samp_keep_file=cut -f1 !{input,,project_sample_subset_plinkseq_ind_info_file} > !{output,,project_sample_subset_samp_keep_file} class_level project_sample_subset

local cmd make_project_sample_subset_samp_exclude_file=cut -f1 !{input,,project_plinkseq_ind_info_file} !{input,,project_sample_subset_samp_keep_file} !{input,,project_sample_subset_samp_keep_file} | sort | uniq -u > !{output,,project_sample_subset_samp_exclude_file} class_level project_sample_subset

local cmd make_project_sample_subset_clean_samp_keep_file=$smart_cut_cmd --ignore-status $broken_pipe_status --exec "zcat !{input,,project_sample_subset_clean_vcf_file} | $vcf_utils_cmd --print-samps" > !{output,,project_sample_subset_clean_samp_keep_file} class_level project_sample_subset

short cmd make_project_variant_subset_var_keep_file=$get_subset_vars | awk -v OFS="\t" -F "\t" 'NR >= !{prop,,project_variant_subset,var_start} && NR < !{prop,,project_variant_subset,var_end} {print \$2,\$3}' > !{output,,project_variant_subset_var_keep_file} class_level project_variant_subset

short cmd make_project_variant_subset_interval_list_file=cat !{input,,project_variant_subset_var_keep_file} | awk 'c && \$1 != c {print c":"s"-"e; s=\$2} !c {s=\$2} {c=\$1;e=\$2} END {print c":"s"-"e}' > !{output,,project_variant_subset_interval_list_file} class_level project_variant_subset

#!!expand:;:vtype;runif:;:_indel;:_clean;run_if or,sample_qc_filter,var_qc_filter:_clean_indel;run_if or,sample_qc_filter,var_qc_filter! \
#short cmd make_project_variant_subsetvtype_vcf_file=rm -f !{output,,project_variant_subsetvtype_vcf_file} && $zcat_helper(project) !{input,,projectvtype_vcf_file} | $vcf_utils_cmd !{input,--chr-pos-keep,project_variant_subset_var_keep_file} $bgzip_helper(project) > !{output,,project_variant_subsetvtype_vcf_file} $tabix_helper(project,project_variant_subsetvtype_vcf_file) class_level project_variant_subset runif skip_if and,fast_split,zip_vcf:eq:.gz

one_vcf_header=awk 'BEGIN {infile=0} !/^\\#/ || !infile {print} !/^\\#\\#/ {infile=1}'

query_merge_subsets_helper=cat !{input,,@1,is_list=1} | awk '{print \$NF}' | xargs $zcat_helper(project) | $one_vcf_header

!!expand:;:vtype;runif:;:_indel;bsub_batch 5:_clean;run_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file:_clean_indel;run_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file bsub_batch 5:_multiallelic;bsub_batch 5:_clean_multiallelic;run_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file bsub_batch 5! \
short cmd make_project_variant_subsetvtype_vcf_file=rm -f !{output,,project_variant_subsetvtype_vcf_file} && $query_merge_subsets_helper(project_variant_subset_project_merge_subsetvtype_vcf_list_file) | $vcf_utils_cmd !{input,--chr-pos-keep,project_variant_subset_var_keep_file} $bgzip_helper(project) > !{output,,project_variant_subsetvtype_vcf_file} $tabix_helper(project,project_variant_subsetvtype_vcf_file) class_level project_variant_subset runif 

#short cmd make_project_variant_subset_clean_all_vcf_file=rm -f !{output,,project_variant_subset_clean_all_vcf_file} && zcat !{input,,project_clean_all_vcf_file} | $vcf_utils_cmd !{input,--chr-pos-keep,project_variant_subset_var_keep_file} | $bgzip_cmd > !{output,,project_variant_subset_clean_all_vcf_file} && !{raw,,project_variant_subset,$run_tabix_cmd(project_variant_subset_clean_all_vcf_file)} class_level project_variant_subset skip_if fast_split

#!!expand:;:vtype;runif:;:_indel;:_clean;run_if or,sample_qc_filter,var_qc_filter:_clean_indel;run_if or,sample_qc_filter,var_qc_filter! \
#short cmd make_fast_project_variant_subsetvtype_vcf_file=($zcat_helper(project) !{input,,projectvtype_vcf_file} | $vcf_utils_cmd --print-header; cat !{input,,project_variant_subset_interval_list_file} | while read f; do $tabix_cmd !{input,,projectvtype_vcf_file} \$f; done) $bgzip_helper(project) > !{output,,project_variant_subsetvtype_vcf_file} $tabix_helper(project,project_variant_subsetvtype_vcf_file) class_level project_variant_subset runif skip_if or,!fast_split,zip_vcf:ne:.gz

#short cmd make_fast_project_variant_subset_clean_all_vcf_file=(zcat !{input,,project_clean_all_vcf_file} | $vcf_utils_cmd --print-header; cat !{input,,project_variant_subset_interval_list_file} | while read f; do $tabix_cmd !{input,,project_clean_all_vcf_file} \$f; done) | $bgzip_cmd > !{output,,project_variant_subset_clean_all_vcf_file} && !{raw,,project_variant_subset,$run_tabix_cmd(project_variant_subset_clean_all_vcf_file)} class_level project_variant_subset skip_if !fast_split

prop fast_split=scalar default 1

!!expand:;:vtype;runif:;:_indel;bsub_batch 5:_clean;run_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file:_clean_indel;run_if sample_qc_filter bsub_batch 5:_multiallelic;bsub_batch 5:_clean_multiallelic;run_if sample_qc_filter bsub_batch 5! \
short cmd make_project_sample_subsetvtype_vcf_file=rm -f !{output,,project_sample_subsetvtype_vcf_file} && $query_merge_subsets_helper(project_project_merge_subsetvtype_vcf_list_file) | $vcf_utils_cmd !{input,--samp-keep,project_sample_subset_samp_keep_file} $bgzip_helper(project) > !{output,,project_sample_subsetvtype_vcf_file} $tabix_helper(project,project_sample_subsetvtype_vcf_file) class_level project_sample_subset runif skip_if fast_split

#!!expand:;:vtype;runif:;:_indel;:_clean;run_if or,sample_qc_filter,var_qc_filter:_clean_indel;run_if sample_qc_filter! \
#short cmd make_project_sample_subsetvtype_vcf_file=rm -f !{output,,project_sample_subsetvtype_vcf_file} && $zcat_helper(project) !{input,,projectvtype_vcf_file} | $vcf_utils_cmd !{input,--samp-keep,project_sample_subset_samp_keep_file} $bgzip_helper(project) > !{output,,project_sample_subsetvtype_vcf_file} $tabix_helper(project,project_sample_subsetvtype_vcf_file) class_level project_sample_subset runif skip_if fast_split

!!expand:;:vtype;runif:;:_indel;:_clean;run_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file:_clean_indel;run_if sample_qc_filter:_multiallelic;:_clean_multiallelic;run_if sample_qc_filter! \
short cmd make_fast_project_sample_subsetvtype_vcf_file=$query_merge_subsets_helper(project_project_merge_subsetvtype_vcf_list_file) | cut -f1-9,$((9+!{prop,,project_sample_subset,samp_start}))-$((8+!{prop,,project_sample_subset,samp_end})) $bgzip_helper(project) > !{output,,project_sample_subsetvtype_vcf_file} $tabix_helper(project,project_sample_subsetvtype_vcf_file) class_level project_sample_subset runif skip_if !fast_split

#!!expand:;:vtype;runif:;:_indel;:_clean;run_if or,sample_qc_filter,var_qc_filter:_clean_indel;run_if sample_qc_filter! \
#short cmd make_fast_project_sample_subsetvtype_vcf_file=$zcat_helper(project) !{input,,projectvtype_vcf_file} | cut -f1-9,$((9+!{prop,,project_sample_subset,samp_start}))-$((8+!{prop,,project_sample_subset,samp_end})) $bgzip_helper(project) > !{output,,project_sample_subsetvtype_vcf_file} $tabix_helper(project,project_sample_subsetvtype_vcf_file) class_level project_sample_subset runif skip_if !fast_split


!!expand:;:ctype;itype;skipif:clean;;skip_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file:clean_indel;indel_;skip_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file:clean_multiallelic;multiallelic_;skip_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file! \
!!expand:stype:variant:sample! \
short cmd ln_project_stype_subset_ctype_vcf_file=rm -f !{output,,project_stype_subset_ctype_vcf_file} && ln -s !{input,,project_stype_subset_itypevcf_file} !{output,,project_stype_subset_ctype_vcf_file} $tabix_helper(project,project_stype_subset_ctype_vcf_file) class_level project_stype_subset skipif

#!|expand:,:projectt,expost:project,skip_if num_merge_subsets:project_merge_subset,skip_if !num_merge_subsets| \
#local cmd make_projectt_indel_vcf_file=$zcat_helper(projectt) !{input,,projectt_subsetted_indel_vcf_file} | $vcf_utils_cmd $vcf_utils_processing_flags \
#	 !{input,--reference-vcf,project_indel_site_vcf_file} --valid-id \
#	 $bgzip_helper(projectt) > !{output,,projectt_indel_vcf_file} $tabix_helper(projectt,projectt_indel_vcf_file) class_level projectt expost

#USE THIS COMMAND ONCE YOU UPGRADE THE GATK
#cmd make_project_samtools_clean_vcf_file=$select_variants_cmd(project_samtools_vcf_file,/dev/stdout,project_sample_include_file,OFF) | $vcf_utils_cmd --remove-filtered  > !{output,,project_samtools_clean_vcf_file} class_level project
#REMOVE THIS COMMAND ONCE YOU UPGRADE THE GATK
#cmd make_project_samtools_clean_vcf_file=$vcf_utils_cmd !{input,--samp-keep,project_sample_include_file} --remove-mono  --remove-filtered < !{input,,project_samtools_vcf_file} > !{output,,project_samtools_clean_vcf_file} class_level project

prop remove_filtered_indels=scalar default 1
prop remove_filtered_multiallelic_snps=scalar default 1
prop remove_filtered_multiallelic_indels=scalar default 1

!|expand:;:ctype;itype;extracmd;runif:clean;;--remove-filtered;run_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file rusage_mod $clean_vcf_mem:clean_indel;indel_;!{raw,,project,--remove-filtered,if_prop=remove_filtered_indels,allow_empty=1};run_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file bsub_batch 5:clean_multiallelic;multiallelic_;!{raw,,project,--remove-filtered-snps,if_prop=remove_filtered_multiallelic_snps,allow_empty=1} !{raw,,project,--remove-filtered-non-snps,if_prop=remove_filtered_multiallelic_indels,allow_empty=1};run_if or,sample_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file bsub_batch 5| \
!|expand:,:shortt,projectt,expost,svtype:,project,skip_if num_merge_subsets,select_variants_cmd:short,project_merge_subset,skip_if !num_merge_subsets,project_merge_subset_select_variants_cmd| \
shortt cmd make_projectt_ctype_vcf_file=rm -f !{output,,projectt_ctype_vcf_file} && $svtype(projectt_itypevcf_file,/dev/stdout,project_sample_include_file,OFF) | $vcf_utils_cmd extracmd !{input,--var-excl,project_variant_exclude_file} --append-missing-malformatted-format $bgzip_helper(projectt) > !{output,,projectt_ctype_vcf_file} $tabix_helper(projectt,projectt_ctype_vcf_file) class_level projectt expost runif

!!expand:project:project:project_merge_subset! \
!!expand:;:ctype;itype;skipif:clean;;skip_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file:clean_indel;indel_;skip_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file:clean_multiallelic;multiallelic_;skip_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file! \
short cmd ln_project_ctype_vcf_file=rm -f !{output,,project_ctype_vcf_file} && ln -s !{input,,project_itypevcf_file} !{output,,project_ctype_vcf_file} $tabix_helper(project,project_ctype_vcf_file) class_level project skipif

project_rem_chr_helper=rem_chr=`tail -n1 !{input,,project_variant_site_vcf_file} | cut -f1 | awk '{if (\$1 !~ "chr") {print "sed \"s/^chr//\""} else {print "cat"}}'`

#!|expand:;:shortt;projectl;projecte;runif:;project;;run_if and,!num_var_subsets,!num_merge_subsets:short;project_variant_subset;_project_variant_subset;run_if num_var_subsets| \
#short cmd make_projectl_clean_all_vcf_file=$projectl_rem_chr_helper && $pseq_qc_plus_no_mask_analysis_cmdprojecte(write-vcf) | eval \$rem_chr | $bgzip_cmd > !{output,,projectl_clean_all_vcf_file} && !{raw,,projectl,$run_tabix_cmd(projectl_clean_all_vcf_file)} class_level projectl runif

!!expand:,:projectl,exskipif:project,skip_if num_merge_subsets:project_merge_subset,:project_variant_subset,! \
short cmd make_projectl_clean_all_vcf_file=$project_rem_chr_helper && $gatk_cmd(CombineVariants) -l OFF -o /dev/stdout !{raw,,projectl,--variant:snps *projectl_clean_vcf_file} !{raw,,projectl,--variant:indels *projectl_clean_indel_vcf_file} !{raw,,projectl,--variant:multiallelics *projectl_clean_multiallelic_vcf_file} !{input,projectl_clean_vcf_file} !{input,projectl_clean_indel_vcf_file} !{input,projectl_clean_multiallelic_vcf_file} $require_unique_helper -filteredRecordsMergeType KEEP_IF_ANY_UNFILTERED -priority snps,indels,multiallelics  | eval \$rem_chr | $bgzip_cmd > !{output,,projectl_clean_all_vcf_file} && !{raw,,projectl,$run_tabix_cmd(projectl_clean_all_vcf_file)} class_level projectl exskipif

outside_gene_name=Outside

clean_gene_variant_id_col=4


!!expand:clean_:clean_:! \
clean_gene_variant_helper=$smart_join_cmd --exec "$smart_cut_cmd --in-delim $tab --exec \"$zcat_helper(@1) !{input,,@{1}_clean_vcf_file}\" --exec \"$zcat_helper(@1) !{input,,@{1}_clean_indel_vcf_file}\" --exec \"$zcat_helper(@1) !{input,,@{1}_clean_multiallelic_vcf_file}\" --comment '\\#\\#' --strip-comments --select-col 1-3,1,'\\#CHROM' --select-col 1-3,1,'POS ID' --exact --require-col-match --exclude-row 2-3,1 | sed '1 s/^\\#//' | $smart_cut_cmd --in-delim $tab --select-col 0,1,'ID CHROM POS' --exclude-row 0,1" !{input,--file,project_variant_gene_annotation_file} --fill 2 --fill-value $outside_gene_name --extra 2 | awk -v OFS="\t" -F"\t" 'BEGIN {print "GENE","CHROM","POS","ID"} {print \$4,\$2,\$3,\$1}' > !{output,,@{1}_clean_gene_variant_file} 

!!expand:clean_:clean_:! \
cmd make_project_clean_gene_variant_file=$clean_gene_variant_helper(project) class_level project skip_if num_var_subsets

!!expand:clean_:clean_:! \
short cmd make_project_variant_subset_clean_gene_variant_file=$clean_gene_variant_helper(project_variant_subset) class_level project_variant_subset 

#Current size: maximum number of variants in any gene
local cmd make_project_variant_subset_gene_burden_size_file=tail -n+2 !{input,,project_variant_subset_gene_variant_file} | cut -f1 | sort | uniq -c | sort -nrk1 | awk 'NR == 1 {print \$1}' | sed 's/^/!{prop,,project_variant_subset}\t/' > !{output,,project_variant_subset_gene_burden_size_file} class_level project_variant_subset 

#plinkseq_vcf_file_helper=perl $targeted_bin_dir/vcf_utils.pl --prep-for-plinkseq < !{input,,@1} > !{output,,@2}

#local cmd make_project_plinkseq_vcf_file=$plinkseq_vcf_file_helper(project_vcf_file,project_plinkseq_vcf_file) class_level project

#local cmd make_project_clean_plinkseq_vcf_file=$plinkseq_vcf_file_helper(project_clean_vcf_file,project_clean_plinkseq_vcf_file) class_level project

two_fold_degenerate_name=2-fold-degenerate
four_fold_degenerate_name=4-fold-degenerate
non_degenerate_name=Non-degenerate


project_vcf_select=#-select "degeneracy==1" -selectName "$non_degenerate_name" -select "degeneracy==3 || degeneracy==2" -selectName "$two_fold_degenerate_name" -select "degeneracy==4" -selectName "$four_fold_degenerate_name"
vcf_eval_heap=$gatk_heap
#cmd make_project_vcf_eval_file=$gatk_cmd_dbsnp_no_heap(VariantEval,$vcf_eval_heap) -l OFF !{output,-o,project_vcf_eval_file} !{input,--eval,project_vcf_file} -EV ThetaVariantEvaluator $project_vcf_select  class_level project run_with project_sample_subset,project_variant_subset

#local cmd make_project_theta_eval_file=grep ThetaVariantEvaluator !{input,,project_vcf_eval_file} | grep -v "\\#" > !{output,,project_theta_eval_file} class_level project

num_per_theta_ac_bin=100
num_per_titv_ac_bin=100

#!!expand:qctype:qc_pass! \
#cmd make_project_qctype_theta_ac_dat_file=$smart_cut_cmd --in-delim $tab !{input,--file,project_plinkseq_qc_pass_counts_file} --select-col 1,1,COUNT --exclude-row 1,1 --exact --require-col-match | sort | uniq -c | awk -v OFS="\t" '{print \$2,\$1}' | sort -nk1 | perl -ane 'BEGIN {\$target_length = $perl_get_target_length; \$num_ac = 0; \$sum_recip = 0; \$sum_ac = 0; \$sum_counts = 0; \$last_ac = 0} \$cur_ac = \$F[0]; \$cur_counts = \$F[1]; for (\$i = \$last_ac + 1; \$i <= \$cur_ac; \$i++) { \$num_ac++; \$sum_recip += 1 / \$i; \$sum_ac += \$i } \$sum_counts += \$cur_counts; \$last_ac = \$cur_ac; if (\$sum_counts > $num_per_theta_ac_bin) {print \$sum_ac / \$num_ac; print "\t"; print \$sum_counts; print "\t"; print \$sum_counts / \$sum_recip / \$target_length; print "\n"; \$num_ac = 0; \$sum_recip = 0; \$sum_ac = 0; \$sum_counts = 0;}' > !{output,,project_qctype_theta_ac_dat_file} class_level project

#!!expand:qctype:qc_pass! \
#local cmd make_project_qctype_theta_ac_pdf_file=$draw_line_plot_cmd !{input,,project_qctype_theta_ac_dat_file} !{output,,project_qctype_theta_ac_pdf_file} 'Theta by Allele Count' 'Allele Count' 'Estimate of Theta' 1 3 header=FALSE x.log=TRUE class_level project

#$draw_line_plot_cmd !{input,,variant_impute_type_threshold_vassoc_file} !{output,,variant_impute_type_threshold_vassoc_pdf_file} '!{prop,,pheno,disp} association score for !{prop,,variant,disp} --- impute_disp imputation' 'Posterior Threshold' 'Assoc P-value' THRESHOLD 'P' sep=$tab y2.col=F,F_CASE,F_CONTROL y2.label=Frequency hline=0.05 hline.name='P .05' hline2=$variant_maf_helper hline2.name='Seq MAF' x.log=T y2.log=T plot.width=$threshold_vassoc_plot_width plot.height=$threshold_vassoc_plot_height class_level variant


local cmd make_project_titv_eval_file=grep TiTvVariantEvaluator !{input,,project_vcf_eval_file} | grep -v "\\#" > !{output,,project_titv_eval_file} class_level project

#local cmd make_project_titv_ac_file=$eval_parser_cmd --analysis-name "SimpleMetricsByAC" --table-name metrics < !{input,,project_vcf_eval_file} | $smart_cut_cmd --in-delim , --select-col 0,1,"AC ^n$ ^nTi$ ^nTv$" --select-row 0,1,JexlExpression,none --select-row 0,1,Novelty,all --select-row 0,1 --and-row 0  | cut -d, -f2- | tail -n+2 | sort -t, -nk 1 | sed '1 s;^;AC,n,nTi,nTv\n;' > !{output,,project_titv_ac_file} class_level project

local cmd make_project_titv_ac_binned_file=$bin_values_cmd --in-delim , --sum-col nTi --sum-col nTv --num-col n --header 1 --min-per-bin $num_per_titv_ac_bin < !{input,,project_titv_ac_file} | $add_function_cmd --in-delim , --header 1 --col1 nTi --col2 nTv --type divide --val-header Ti/Tv | $smart_cut_cmd --in-delim , --select-col 0,1,AC --select-col 0,1,Ti/Tv  > !{output,,project_titv_ac_binned_file} class_level project
local cmd make_project_titv_ac_pdf_file=$draw_line_plot_cmd !{input,,project_titv_ac_binned_file} !{output,,project_titv_ac_pdf_file} 'Ti/Tv by Allele Count' 'Allele Count' 'Ti/Tv' 1 2 sep=, x.log=TRUE class_level project

prop snpeff_regs=list

snpsift_exe_helper=java -Xmx$snpeff_heap -jar $snpsift_jar 

snpeff_exe_helper=java -Xmx$snpeff_heap -jar $snpeff_jar eff -v -noStats -c $snpeff_config	-o @1 !{prop,-reg,project,snpeff_regs,if_prop=snpeff_regs,allow_empty=1} $snpeff_genome

combine_vcfs_for_annotation=$smart_cut_cmd --in-delim $tab --exec @2"$zcat_helper(@1) !{input,,@{1}_vcf_file}@2" --exec @2"$zcat_helper(@1) !{input,,@{1}_indel_vcf_file} | awk '@2"\!@2"/\#/'@2" --exec @2"$zcat_helper(@1) !{input,,@{1}_multiallelic_vcf_file} | awk '@2"\!@2"/\#/'@2" --comment '\#\#' 

#snpeff_dbnsfp_cols=Ensembl_transcriptid Uniprot_acc Interpro_domain SIFT_score Polyphen2_HVAR_pred GERP++_NR GERP++_RS 29way_logOdds 1000Gp1_AF 1000Gp1_AFR_AF 1000Gp1_EUR_AF 1000Gp1_AMR_AF 1000Gp1_ASN_AF ESP5400_AA_AF ESP5400_EA_AF


#take only the first occurrence
#right now, only duplicates are SPLICE annotations
#so put those first

!|expand:,:shortt,projectt,projecte,runif:,project,,run_if !num_var_subsets:short,project_variant_subset,_project_variant_subset,| \
shortt cmd make_projectt_snpsift_file=cols=`zcat $snpeff_dbnsfp | head -n1 | cut -f${dbnsfp_cols_start}- | sed 's/\t/\n/g' | egrep -v '$dbnsfp_cols_ignore' | tr '\n' ' '`; \
  $combine_vcfs_for_annotation(projectt,) | cut -f1-8 \
  | $snpsift_exe_helper dbnsfp -v $snpeff_dbnsfp -f `echo \$cols | sed 's/\s\s*/,/g'` - \
  | $vcf_utils_cmd --print-annots | $smart_cut_cmd --in-delim $tab --select-col 0,1,ID --select-col 0,1,"\$cols" \ 
  > !{output,,projectt_snpsift_file} class_level projectt runif

!|expand:,:shortt,projectt,projecte,runif:,project,,run_if !num_var_subsets:short,project_variant_subset,_project_variant_subset,| \
shortt cmd make_projectt_snpeff_file=$combine_vcfs_for_annotation(projectt,) | cut -f1-8 | $snpeff_exe_helper(txt) | tail -n+3 | sed '1 s/\\# //' | awk -v OFS="\t" -F"\t" 'NR == 1 {print 0,\$0} NR > 1 { if (/SPLICE/) {print 1,\$0} else {print NR,\$0} }' | sort -t$tab -k1 | cut -f2- | awk -v OFS="\t" -F"\t" '{k=\$$snpeff_id_col":"\$$snpeff_trans_col} !m[k] {m[k]=1; print}' > !{output,,projectt_snpeff_file} class_level projectt runif

!|expand:,:shortt,projectt,projecte,runif:,project,,run_if !num_var_subsets:short,project_variant_subset,_project_variant_subset,| \
shortt cmd make_projectt_chaos_vcf_file=$combine_vcfs_for_annotation(projectt,) | cut -f1-8 | $chaos_cmd addtx -i /dev/stdin !{output,-o,projectt_chaos_vcf_file} class_level projectt runif

chaos_merge_cols=4, 5

!|expand:,:shortt,projectt,projecte,runif:,project,,run_if !num_var_subsets:short,project_variant_subset,_project_variant_subset,| \
shortt cmd make_projectt_chaos_file=$chaos_cmd extract !{input,--vcf,projectt_chaos_vcf_file} | sed '1 s/.*/ID\tGENE\tTRANS\tCHANGE\tTYPE/' | perl -ne '@a = split("\t", \$_, -1); if (\$a[$chaos_trans_col - 1] =~ /(.+)\.[0-9]+/) {\$a[$chaos_trans_col - 1] = \$1} print join("\t", @a)' | awk -F"\t" -v OFS="\t" '{print NR,\$0}' | sort -t$tab -k$((1+$chaos_id_col)),$((1+$chaos_id_col)) -k$((1+$chaos_trans_col)),$((1+$chaos_trans_col)) | uniq -f1 | perl -lne 'chomp; @a = split("\t"); \$key="\$a[$chaos_id_col]\t\$a[$chaos_trans_col]"; if (@last_line && \$last_key eq \$key) {foreach \$c ($chaos_merge_cols) {\$a[\$c]="\$last_line[\$c],\$a[\$c]"}} elsif (@last_line) {print join("\t", @last_line)} \$last_key = \$key; @last_line = @a; END {if (@last_line) {print join("\t", @last_line)}}' | sort -nk1,1 | cut -f2- > !{output,,projectt_chaos_file} class_level projectt runif

vep_custom_flags=`(echo $vep_custom_tabix && echo $vep_custom_names) | $transpose_cmd | awk -v OFS=, 'NF == 2 {print \$1,\$2,"bed","exact"}' | sed 's/^/-custom /' | tr '\n' ' '`
vep_custom_cols=`echo $vep_custom_names | sed 's/\s*\(\S\S*\)/,\1/g'`

prop do_hgvs=scalar

!|expand:,:shortt,projectt,projecte,runif:,project,,run_if !num_var_subsets:short,project_variant_subset,_project_variant_subset,| \
shortt cmd make_projectt_vep_file=$combine_vcfs_for_annotation(projectt,) | $vep_cmd --offline !{raw,--fasta,project,$ensembl_reference,if_prop=do_hgvs,allow_empty=1} -o STDOUT --dir $ensembl_cache_dir --polyphen b --sift b --ccds --canonical --regulatory --domains flags --plugin Condel,$vep_condel_config_dir,b,2 --plugin LoF,human_ancestor_fa:$loftee_human_ancestor_path $vep_custom_flags !{raw,,project,--hgvs,if_prop=do_hgvs,allow_empty=1} --fields Uploaded_variation,Location,Allele,Gene,Feature,Feature_type,Consequence,cDNA_position,CDS_position,Protein_position,Amino_acids,Codons,Existing_variation,CCDS,CANONICAL,HGNC,ENSP,DOMAINS,MOTIF_NAME,MOTIF_POS,HIGH_INF_POS,MOTIF_SCORE_CHANGE,SIFT,PolyPhen,Condel,LoF,LoF_filter,LoF_flags$vep_custom_cols!{raw::project:,HGVSc,HGVSp:if_prop=do_hgvs:allow_empty=1} | fgrep -v \\\#\\\# !{raw,,project,| tail -n+2,if_prop=do_hgvs,allow_empty=1} > !{output,,projectt_vep_file} class_level projectt runif rusage_mod $vep_mem

!|expand:,:shortt,projectt,projecte,runif:,project,,run_if !num_var_subsets:short,project_variant_subset,_project_variant_subset,| \
shortt cmd make_projectt_parsed_vep_file=eval "cat !{input,,projectt_vep_file} | $replace_missing_helper()" | awk -v OFS="\t" -F"\t" '{k=\$$vep_id_col":"\$$vep_trans_col} !m[k] {m[k]=1; print}' | sed '1 s/^\\\#//' | awk -v OFS="\t" -F"\t" 'NR == 1 {for (i=1;i<=NF;i++) {m[\$i]=i} p[1]="PolyPhen"; p[2]="SIFT"; p[3]="Condel"; for (j=1;j<=3;j++) {\$m[p[j]]=\$m[p[j]]"_PRED\t"\$m[p[j]]"_SCORE"} aa=m["Amino_acids"]; pp=m["Protein_position"]; \$aa="Amino_acids\tProtein_change"} NR > 1 {for (j=1;j<=3;j++) {if (\$m[p[j]] == "$vep_missing_field") {\$m[p[j]]="$vep_missing_field\t$vep_missing_field"} else if (match(\$m[p[j]],/([^\(\)]*)\(([0-9\.][0-9\.]*)\)/,ary)) {\$m[p[j]]=ary[1]"\t"ary[2]} else {\$m[p[j]]=\$m[p[j]]"\t$vep_missing_field"}} if (\$aa == "$vep_missing_field" || \$pp == "$vep_missing_field") {\$aa=\$aa"\t$vep_missing_field"} else {if (match(\$aa,/^(.)\/(.)$/,ary)) {\$aa=\$aa"\tp."ary[1]\$pp""ary[2]} else if (match(\$aa,/^(.)$/,ary)) {\$aa=\$aa"\tp."ary[1]\$pp""ary[1]} else {\$aa=\$aa"\tp."\$pp\$aa}}} {print}' > !{output,,projectt_parsed_vep_file} class_level projectt runif

!|expand:,:shortt,projectt,projecte,runif:,project,,run_if !num_var_subsets:short,project_variant_subset,_project_variant_subset,| \
shortt cmd make_projectt_transcript_gene_map_file=$smart_join_cmd --in-delim $tab --exec "$smart_cut_cmd --in-delim $tab !{input,--file,projectt_parsed_vep_file} --select-col 1,1,'$vep_id_annot $vep_trans_annot' --exclude-row 1,1,$vep_trans_annot,$vep_missing_field --exact --require-col-match --exclude-row 1,1" --exec "$smart_cut_cmd --in-delim $tab !{input,--file,projectt_gene_variant_file} --exclude-row 1,1 --select-col 1,1,'ID GENE'" --multiple 1 --extra 2 | cut -f2- | $smart_cut_cmd --in-delim $tab --select-col 0,'2 1' | sort -u | sed '1 s/^/gene\ttranscript\n/' > !{output,,projectt_transcript_gene_map_file} class_level projectt runif with burden

short cmd make_project_transcript_gene_alias_file=tail -n+2 !{input,,project_transcript_gene_map_file} | sort | uniq -c | awk '{if (\$2 ~ /$outside_gene_name/) {print 2,\$0} else {print 1,\$0}}' | sort -k4,4 -k1,1n -k2,2nr | sed 's/^\s*//' | sed 's/\s\s*/\t/g' | cut -f3- | uniq -f1 | $smart_cut_cmd --in-delim $tab --select-col 0,'2 1' | sed '1 s/^/\#transcript\tgene\n/' > !{output,,project_transcript_gene_alias_file} class_level project with burden


!|expand:,:shortt,projectt,projecte,runif:,project,,run_if !num_var_subsets:short,project_variant_subset,_project_variant_subset,| \
shortt cmd make_projectt_pph2_pos_file=(zcat $pph2_whess_file | head -n1; $combine_vcfs_for_annotation(projectt,) | grep -v \\\# | cut -f1,2 | while read f; do $tabix_cmd $pph2_whess_file `echo \\$f | awk '{print \$1":"\$2"-"\$2+1}'`; done) > !{output,,projectt_pph2_pos_file} class_level projectt runif

whess_chr_col=1
whess_pos_col=2
whess_nt1_col=6
whess_nt2_col=6

!|expand:,:projectt,projecte,runif:project,,run_if !num_var_subsets:project_variant_subset,_project_variant_subset,| \
cmd make_projectt_pph2_file=$smart_join_cmd --header 1 --in-delim $tab --rest-extra 1 --exec "$smart_cut_cmd --in-delim $tab --exec \"$combine_vcfs_for_annotation(projectt,\\\) | grep -v \\\\\\\\\# | cut -f1,2,4,5\" --exec \"$smart_cut_cmd --in-delim $tab !{input,--file,projectt_pph2_pos_file} --exclude-row 1,1 --select-col 1,1,'chr pos nt1 nt2' | sort -u\" | sort | uniq -d | sed '1 s/^/CHR\tPOS\tREF\tALT\n/'" --exec "$combine_vcfs_for_annotation(projectt,\) | grep -v \\\\\#\\\\\# | $smart_cut_cmd --in-delim $tab --select-col 0,'1 2 4 5 3'" --exec "$smart_cut_cmd --in-delim $tab !{input,--file,projectt_pph2_pos_file} --select-col 1,1,'chr pos nt1 nt2 ENSEMBL .'" --multiple 3 --col 1 --col 2 --col 3 --col 4 | sed 's/\t */\t/g' | sed 's/ *\t/\t/g' | awk -F"\t" -v OFS="\t" '{k=\$1":"\$2":"\$3":"\$4":"\$5":"\$6} !m[k] {print; m[k]=1}' > !{output,,projectt_pph2_file} class_level projectt runif

!!expand:custom_var:custom_var:custom_trans! \
short cmd make_subset_project_variant_subset_custom_var_annot_file=$smart_join_cmd --in-delim $tab --header 1 --exec "$combine_vcfs_for_annotation(project_variant_subset,\) | fgrep -v '\\#' | cut -f3 | sort -u | $smart_cut_cmd --in-delim $tab !{input,--file,project_custom_var_annot_file} --exclude-row 1,1 | cut -f$custom_id_col | sort | uniq -d | sed '1 s/^/ID\n/'" !{input,--file,project_custom_var_annot_file} --extra 2 --multiple 2 > !{output,,project_variant_subset_custom_var_annot_file} class_level project_variant_subset run_if project_custom_var_annot_file

!|expand:,:shortt,projectt,projecte,runif:,project,,run_if !num_var_subsets:short,project_variant_subset,_project_variant_subset,| \
shortt cmd make_projectt_custom_trans_annot_file=$smart_join_cmd --in-delim $tab --exec "cut -f$vep_id_col !{input,,projectt_parsed_vep_file} | tail -n+2 | sort -u | $smart_cut_cmd --exec 'cut -f$custom_id_col !{input,,projectt_custom_var_annot_file} | tail -n+2 | sort -u' | sort | uniq -d | sed '1 s/^/ID\n/'" --exec "cut -f$vep_id_col,$vep_trans_col !{input,,projectt_parsed_vep_file}" !{input,--file,projectt_custom_var_annot_file} --header 1 --rest-extra 1 --multiple 2 > !{output,,projectt_custom_trans_annot_file} class_level projectt runif skip_if or,project_custom_trans_annot_file,!project_custom_var_annot

#1: File to fill
#2: File to fill
#3: Ids to use
#4: What to fill
#5: ID col in file to fill
#6: ID col in other file to use
#7: Number of ID cols
#8: Number of header rows
#9: Delim to use to split other file
fill_file_helper_int=$smart_join_cmd --in-delim $tab --header @8 --merge @1 `echo @6 | sed 's/\(\s\s*\)/\n/g' | awk '{print NR}' | sed 's/^\(\S\S*\)/--col 2,\1/g' | tr '\n' ' '` `echo @5 | sed 's/\(\S\S*\)/--col 1,\1/g'` --exec \"cat @3 | $smart_cut_cmd --in-delim $tab --select-col 0,'@6' | perl -lpe 'BEGIN {\\\\$ncol = \\\`@2 | head -n1\\\`; die if \\\\$?; \\\\$ncol = scalar(split(\\\"@9\\\", \\\\$ncol))} chomp; \\\\$l = join(\\\"\\\\t\\\", split(/:/, \\\"@{4}:\\\"x(\\\\$ncol-@7))); s/$/\t\\\\$l/'\"


fill_file_helper=$fill_file_helper_int(!{input:--file:@1},cat !{input::@1},!{input::@2},@3,@4,@5,@6,@7,\t)

#the following annotations are used internally, and are pulled from the VEP file
vep_id_annot=Uploaded_variation
vep_trans_annot=Feature
vep_ccds_annot=CCDS
vep_type_annot=Consequence
vep_loc_annot=Location
vep_protein_change_annot=Protein_change
vep_codon_change_annot=Codons
vep_type_synonymous_annot=synonymous_variant
vep_type_missense_annot=missense_variant
vep_type_nonsense_annot=stop_gained
vep_type_readthrough_annot=stop_lost

synonymous_mask=$vep_type_annot,eq:$vep_type_synonymous_annot
missense_mask=$vep_type_annot,eq:$vep_type_missense_annot
nonsense_mask=$vep_type_annot,'eq:$vep_type_nonsense_annot eq:$vep_type_readthrough_annot'
noncoding_mask=$vep_protein_change_annot,eq:$vep_missing_field
coding_mask=$vep_protein_change_annot,ne:$vep_missing_field

vep_consequence_annot=Consequence
vep_consequence_rank=transcript_ablation splice_donor_variant splice_acceptor_variant stop_gained frameshift_variant stop_lost initiator_codon_variant inframe_insertion inframe_deletion missense_variant transcript_amplification splice_region_variant incomplete_terminal_codon_variant synonymous_variant stop_retained_variant coding_sequence_variant mature_miRNA_variant 5_prime_UTR_variant 3_prime_UTR_variant intron_variant NMD_transcript_variant non_coding_exon_variant nc_transcript_variant upstream_gene_variant downstream_gene_variant TFBS_ablation TFBS_amplification TF_binding_site_variant regulatory_region_variant regulatory_region_ablation regulatory_region_amplification feature_elongation feature_truncation intergenic_variant 

vep_id_col=1
vep_trans_col=5
vep_gene_col=4
vep_ccds_col=14

snpeff_id_col=24
snpeff_trans_col=13

chaos_id_col=1
chaos_trans_col=3

pph2_id_col=5
pph2_trans_col=6

custom_id_col=1
custom_trans_col=2

snpeff_missing_field=
chaos_missing_field=.
pph2_missing_field=
vep_missing_field=-
annot_missing_field=NA

replace_missing_helper=perl -F\\\\t -lne '\@F = split(\"\t\", \\$_, -1); \@F = map {\\$_ eq \"@1\" ? \"$annot_missing_field\" : \\$_} \@F; print join(\"\t\", \@F)' 

adjust_missing_int=sed 's/\(\s\s*\|^\)$vep_missing_field\(\s\s*\|$\)/\1$annot_missing_field\2/g'
adjust_missing=$adjust_missing_int | $adjust_missing_int

snpeff_tag=SNPEFF
chaos_tag=CHAOS
vep_tag=VEP

snpeff_effect=SNPEFF_Effect
chaos_effect=CHAOS_TYPE
vep_effect=Consequence

!%expand:;:cmdtype;extracmd;skipif:\
no_custom;;skip_if or,project_custom_var_annot_file,project_custom_trans_annot_file:\
with_custom;--exec "$fill_file_helper(projectt_custom_trans_annot_file,projectt_parsed_vep_file,-,$custom_id_col $custom_trans_col,$vep_id_col $vep_trans_col,2,1) | sed '1 s/\(\s\s*\)\(\S\S*\)/\1CUSTOM_\2/g'" --col 6,1 --col 6,2;skip_if and,!project_custom_var_annot_file,!project_custom_trans_annot_file%\ 
!|expand:,:shortt,projectt,runif:,project,run_if !num_var_subsets:short,project_variant_subset,| \
shortt cmd make_projectt_cmdtype_complete_full_annot_file=$smart_join_cmd --in-delim $tab --header 1 --rest-extra 1 !{input,--file,projectt_parsed_vep_file} --col 1,$vep_id_col --col 1,$vep_trans_col \
  --exec "$fill_file_helper(projectt_snpeff_file,projectt_parsed_vep_file,$vep_missing_field,$snpeff_id_col $snpeff_trans_col,$vep_id_col $vep_trans_col,2,1) | sed '1 s/\(\s\s*\)\(\S\S*\)/\1SNPEFF_\2/g' | $replace_missing_helper($snpeff_missing_field) | perl -lne 'chomp; @a = split(\"\t\"); if ($. == 1) {\\$effect_col=undef; for (\\$i=0;\\$i<=\\$\\\#a;\\$i++) {if (\\$a[\\$i] eq \"$snpeff_effect\") {\\$effect_col=\\$i; last}} die unless defined \\$effect_col} else {\\$a[\\$effect_col] =~ s/:[^\t]*//} print join(\"\t\", @a)'"  --multiple 2 --col 2,1 --col 2,2 \
  --exec "$fill_file_helper(projectt_chaos_file,projectt_parsed_vep_file,$vep_missing_field,$chaos_id_col $chaos_trans_col,$vep_id_col $vep_trans_col,2,1) | sed '1 s/\(\s\s*\)\(\S\S*\)/\1CHAOS_\2/g' | $replace_missing_helper($chaos_missing_field)"  --col 3,1 --col 3,2 \
  --exec "$smart_join_cmd --header 1 --in-delim $tab --exec 'cut -f$vep_id_col,$vep_trans_col !{input,,projectt_parsed_vep_file}' !{input,--file,projectt_snpsift_file} --multiple 1 | sed '1 s/\(\s\s*\)\(\S\S*\)/\1SNPEFF_\2/g' | $replace_missing_helper($snpeff_missing_field)" --col 4,1 --col 4,2 \
  --exec "$fill_file_helper(projectt_pph2_file,projectt_parsed_vep_file,$vep_missing_field,$pph2_id_col $pph2_trans_col,$vep_id_col $vep_trans_col,2,1) | sed '1 s/\(\s\s*\)\(\S\S*\)/\1PPH2_\2/g' | $replace_missing_helper($pph2_missing_field)" --col 5,1 --col 5,2 \
  extracmd | $adjust_missing !{raw::projectt:| $map_effects_cmd *project_effect_size_map_file $vep_tag,$vep_effect $chaos_tag,$chaos_effect $snpeff_tag,$snpeff_effect:if_prop=project_effect_size_map_file:allow_empty=1} !{input,project_effect_size_map_file,if_prop=project_effect_size_map_file,allow_empty=1} > !{output,,projectt_complete_full_annot_file} class_level projectt runif skipif

!|expand:,:shortt,projectt,runif:,project,run_if !num_var_subsets:short,project_variant_subset,| \
shortt cmd make_projectt_cmdtype_full_annot_file=cat !{input,,projectt_complete_full_annot_file} | $smart_cut_cmd --in-delim $tab --exec "!{raw::projectt:cut -f$vep_trans_col *projectt_vep_file | sort -u:unless_prop=project_reduced_trans_file:allow_empty=1} !{raw::projectt:sort -u *project_reduced_trans_file:if_prop=project_reduced_trans_file:allow_empty=1} !{input:project_reduced_trans_file:if_prop=project_reduced_trans_file:allow_empty=1} " | awk -F"\t" -v OFS="\t" 'NR == 1 {h=0} NF == 1 {m[\$1]=1} NF > 1 && (!h || m[\$2]) {print; h=1}' > !{output,,projectt_full_annot_file} class_level projectt runif

var_transcript_col_select_helper=--select-col 1,1 --select-col 1,1,^$vep_consequence_annot$ --select-col 1,1,.

!|expand:,:shortt,projectt,projecte,runif:,project,,run_if !num_var_subsets:short,project_variant_subset,_project_variant_subset,| \
shortt cmd make_projectt_var_transcript_file=$smart_join_cmd --in-delim $tab --header 1 --rest-extra 1 --multiple 3 --exec "echo $vep_consequence_rank | sed 's/\s\s*/\n/g' | sort -u | $smart_cut_cmd --in-delim $tab --exec \"$smart_cut_cmd --in-delim $tab !{input,--file,projectt_full_annot_file} --select-col 1,1,$vep_consequence_annot --exclude-row 1,1 --select-row 1,1,$vep_ccds_annot,ne:$annot_missing_field --exact --require-col-match | sed 's/,/\n/g' | sort -u\" | sort | uniq -d | sed '1 s/^/ID\n/'" --exec "echo $vep_consequence_rank | sed 's/\s\s*/\n/g' | sed '1 s/^/ID\n/' | awk -v OFS=\"\t\" '{print \\$0,NR}'" --exec "$smart_cut_cmd --in-delim $tab !{input,--file,projectt_full_annot_file} $var_transcript_col_select_helper --select-row 1,1 --select-row 1,1,$vep_ccds_annot,ne:$annot_missing_field --require-col-match | awk -F\"\t\" -v OFS=\"\t\" 'NR == 1 {print 0,\\$0} NR > 1 {split(\\$2,a,\",\"); for(i=1;i<=length(a);i++){print a[i],\\$0}}' | awk -F\"\t\" -v OFS=\"\t\" '{n=0; for(i=3;i<=NF;i++) {if (\\$i == \"$annot_missing_field\") {n++}}} NR == 1 {\\$1=\\$1\"\tFIELDS_MISSING\"} NR > 1 {\\$1=\\$1\"\t\"n} {print}'" | sort -k2,2n -k3,3n | cut -f4- | $smart_cut_cmd --in-delim $tab --select-col 0,1,'$vep_id_annot $vep_trans_annot' --exact --require-col-match | $smart_cut_cmd --in-delim $tab --stdin-first --exec "$smart_cut_cmd --in-delim $tab !{input,--file,projectt_full_annot_file} --select-row 1,1,$vep_ccds_annot,ne:$annot_missing_field --exclude-row 1,1 --select-col 1,1,'$vep_id_annot $vep_trans_annot' --exact --require-col-match" --exec "$smart_cut_cmd --in-delim $tab !{input,--file,projectt_full_annot_file} --select-row 1,1,$vep_ccds_annot,eq:$annot_missing_field --exclude-row 1,1 --select-col 1,1,'$vep_id_annot $vep_trans_annot' --exact --require-col-match"  | awk -F"\t" -v OFS="\t" 'NR == 1 {print 0,NR,\$0} NR > 1 {print 1,NR,\$0}' | sort -k1,1n -k3,3 -k2,2n | cut -f3- | rev | uniq -f1 | rev | $adjust_missing > !{output,,projectt_var_transcript_file} class_level projectt runif

#!!expand:projectt:project:project_variant_subset! \
#projectt_full_var_annot_exec_helper=--exec "cat !{input,,projectt_per_gene_vep_file} | awk -F\"\t\" -v OFS=\"\t\" 'NR == 1 {print 0,\\$0} NR > 1 { if (\\$$vep_gene_col != \"$vep_missing_field\" && \\$$vep_ccds_col != \"$vep_missing_field\") {print 1,\\$0} else if (\\$$vep_gene_col != \"$vep_missing_field\") {print 2,\\$0} else {print 3,\\$0}}' | sort -t$tab -k1,1n -k2,2 | cut -f2- | awk -v OFS=\"\t\" -F\"\t\" '{k=\\$$vep_id_col} !m[k] {m[k]=1; print}' | sed 's/\(\s\s*\)$vep_missing_field/\1$annot_missing_field/g' | cut -f$vep_id_col,$vep_trans_col"

!!expand:projectt:project:project_variant_subset! \
projectt_full_var_annot_helper=$smart_join_cmd --in-delim $tab --header 1 !{input,--file,projectt_var_transcript_file} !{input,--file,projectt_full_annot_file} --extra 2 --col 1 --col 2

#!|expand:,:shortt,projectt,projecte,runif:,project,,run_if !num_var_subsets:short,project_variant_subset,_project_variant_subset,| \
#shortt cmd make_projectt_parsed_per_gene_vep_file=$smart_join_cmd --in-delim $tab --header 1 !{input,--file,projectt_var_transcript_file} --exec "sed '1! s/$vep_missing_field/$annot_missing_field/g' !{input,,projectt_parsed_vep_file}" --extra 2 --col 1,1 --col 1,2 --col 2,$vep_id_col --col 2,$vep_trans_col > !{output,,projectt_parsed_per_gene_vep_file} class_level projectt runif 

!|expand:,:shortt,projectt,runif:,project,run_if !num_var_subsets:short,project_variant_subset,| \
shortt cmd make_projectt_full_var_annot_file=$projectt_full_var_annot_helper > !{output,,projectt_full_var_annot_file} class_level projectt runif

#!|expand:,:projectt:project:project_variant_subset| \
#short cmd make_projectt_annot_pseq_file=$smart_cut_cmd --in-delim $tab !{input,--file,projectt_parsed_vep_file} --select-col 1,1 --select-col 1,1,'$vep_type_annot $vep_protein_change_annot' --exact --require-col-match | awk -F"\t" -v OFS="\t" '{print \$1,"$pseq_type_annot",\$2} {print \$1,"$pseq_protein_change_annot",\$3}' | awk -F"\t" '\$3 != $annot_missing_field' | sed '1 s/^/\\#\\#$pseq_type_annot,1,String,"Type of variant"\n\\#\\#$pseq_protein_change_annot,1,String,"Protein change"\n/' > !{output,,projectt_annot_pseq_file} class_level projectt

!!expand;,;maskkey,maskdescrip;syn,$synonymous_mask;ns,$missense_mask;nonsense,$nonsense_mask;coding,$coding_mask! \
!|expand:,:projectt,runif:project,run_if !num_var_subsets:project_variant_subset,| \
short cmd make_projectt_plinkseq_maskkey_reg_file=$smart_join_cmd --in-delim $tab --extra 2 --exec "$smart_join_cmd --in-delim $tab --header 1 --exec \"sed '1! s/$annot_missing_field$/$vep_missing_field/' !{input,,projectt_var_transcript_file}\" !{input,--file,projectt_parsed_vep_file} --extra 2 --col 1,1 --col 1,2 --col 2,$vep_id_col --col 2,$vep_trans_col | $smart_cut_cmd --in-delim $tab --select-col 0,1 --select-row 0,1,maskdescrip --exclude-row 0,1" --exec "$smart_cut_cmd --in-delim $tab --exec \"$zcat_helper(projectt) !{input,,projectt_vcf_file}\" --exec \"$zcat_helper(projectt) !{input,,projectt_indel_vcf_file}\" --exec \"$zcat_helper(projectt) !{input,,projectt_multiallelic_vcf_file}\" --comment '\\\#\\\#' --strip-comments --select-col 1-3,1,'ID \\\#CHROM POS' --exact --require-col-match --exclude-row 2,1 --exclude-row 1,1 --exclude-row 3,1" | cut -f2- | sed 's/\s\s*/:/' | sed 's/^/chr/' | sed 's/^chrchr/chr/' > !{output,,projectt_plinkseq_maskkey_reg_file} class_level projectt runif

#coverage cmds

#helper constants
coverage_dat_delim=,
threshold=10
threshold_frac_above=frac_above_
threshold_frac_lte=frac_lte_
threshold_frac_equal=frac_equal_
threshold_num_above=num_above_
threshold_num_lte=num_lte_
threshold_num_equal=num_equal_
frac_above_threshold=${threshold_frac_above}${threshold}
table_sum_stats_stddev=stddev
table_sum_stats_min=min
table_sum_stats_num=num
table_sum_stats_tot=tot
table_sum_stats_quantile=quant_

summary_tot=@{1}_tot
summary_mean=@{1}_mean
summary_max=@{1}_max
summary_min=@{1}_min
summary_dev=@{1}_$table_sum_stats_stddev
summary_num=@{1}_num
num_cum_bins=1000

haplotype_burden_bin_dir=$targeted_bin_dir/vineeta
recessive_bin_dir=$targeted_bin_dir/recessive/v2

conditional_exec_cmd=perl $common_bin_dir/conditional_exec.pl
smart_join_cmd=perl $common_bin_dir/smart_join.pl
smart_cut_cmd=perl $common_bin_dir/smart_cut.pl
bin_values_cmd=perl $common_bin_dir/bin_values.pl
add_function_cmd=perl $common_bin_dir/add_function.pl
add_header_cmd=perl $common_bin_dir/add_header.pl
transpose_cmd=perl $common_bin_dir/transpose.pl
table_to_beamer_cmd=perl $common_bin_dir/table_to_beamer.pl
text_to_beamer_cmd=perl $common_bin_dir/text_to_beamer.pl
format_columns_cmd=perl $common_bin_dir/format_columns.pl
vcf_utils_cmd=perl $targeted_bin_dir/vcf_utils.pl
sync_ref_alt_cmd=perl $targeted_bin_dir/sync_ref_alt.pl
tped_to_bed_cmd=perl $targeted_bin_dir/tped_to_bed.pl

table_sum_stats_cmd=perl $common_bin_dir/table_sum_stats.pl
table_sum_stats_threshold_cmd=$table_sum_stats_cmd --out-delim , --threshold $threshold

add_gene_annot_cmd=python $targeted_bin_dir/add_gene_annot.py
make_cum_dat_cmd=python $common_bin_dir/make_cum_dat.py

r_script_cmd=$r_cmd -f @1 --slave --vanilla --args
r_212_script_cmd=$r_212_cmd -f @1 --slave --vanilla --args
r_215_script_cmd=$r_215_cmd -f @1 --slave --vanilla --args


draw_bar_plot_cmd=$r_script_cmd($common_bin_dir/draw_bar_plot.R) @1
#args: input, output, title
draw_coverage_bar_plot_cmd=$draw_bar_plot_cmd("@1 @2 @3 '% bases >= ${threshold}x' $frac_above_threshold 2 sep=$coverage_dat_delim")

draw_gene_plot_cmd=$r_script_cmd($targeted_bin_dir/draw_gene_plot.R) @1
draw_fancy_locus_plot_cmd=$r_script_cmd($targeted_bin_dir/draw_fancy_locus_plot.R)
draw_var_coverage_plot_cmd=$r_script_cmd($targeted_bin_dir/draw_var_coverage_plot.R)
draw_matrix_plot_cmd=$r_script_cmd($common_bin_dir/draw_matrix_plot.R)
draw_box_plot_cmd=$r_script_cmd($common_bin_dir/draw_box_plot.R) @1
draw_hist_plot_cmd=$r_script_cmd($common_bin_dir/draw_hist_plot.R) @1
draw_qq_plot_cmd=$r_script_cmd($common_bin_dir/draw_qq_plot.R)
compute_lambda_cmd=$r_script_cmd($common_bin_dir/compute_lambda.R)
predict_log_reg_cmd=$r_script_cmd($common_bin_dir/predict_log_reg.R) @1
threshold_vassoc_cmd=$r_script_cmd($targeted_bin_dir/threshold_vassoc.R) @1
score_test_cmd=$r_script_cmd($targeted_bin_dir/Score_test.R)
multiallelic_qc_cmd=$r_215_script_cmd($targeted_bin_dir/multiallelic_QC_metrics.R)


write_outlier_table_cmd=$r_script_cmd($common_bin_dir/write_outlier_table.R)

#args: input, output, title
draw_coverage_box_plot_cmd=$draw_box_plot_cmd("@1 @2 @3 '' '% bases >= ${threshold}x' $frac_above_threshold label=2 sep=$coverage_dat_delim")

draw_line_plot_cmd=$r_script_cmd($common_bin_dir/draw_line_plot.R)

prepend_coverage_dat_label=sed 's/^/@1$coverage_dat_delim/'
#prepend_call_set_coverage_dat_label=$prepend_coverage_dat_label(call_set)
#prepend_call_set_disp_coverage_dat_label=$prepend_coverage_dat_label(!{prop\,\,call_set\,disp})

# actual cmds

prop id_cols=list
picard_prepend_helper=$smart_cut_cmd !{input,--file,@1} --select-col 1,1,'!{prop,,seq_batch,id_cols,sep=:}' --exact --vec-delim : --in-delim $tab | sed 's/\t/:/' | sed '1 s/.*/ID/' | paste - !{input,,@1} | $smart_cut_cmd --exclude-col '0,1,!{prop,,seq_batch,id_cols,sep=:}' --exact --vec-delim : --in-delim $tab

local cmd make_seq_batch_picard_sort_file=rm -f !{output,,seq_batch_picard_sort_file} && tail -n+2 !{input,,seq_batch_picard_map_file} | cut -f2 | sort -u | awk -v OFS="\t" 'NR == 1 {print "ID","Order"} {print \$1,NR}' > !{output,,seq_batch_picard_sort_file} class_level seq_batch skip_if seq_batch_picard_sort_file

prop project_picard_file_sample_col=scalar
local cmd make_seq_batch_picard_file=$smart_join_cmd !{input,--file,seq_batch_picard_sort_file} --exec "$smart_join_cmd --exec \"$picard_prepend_helper(seq_batch_picard_map_file)\" --exec \"$picard_prepend_helper(project_picard_file)\" --in-delim $tab --extra 1 --header 1 --multiple 2" --header 1 --multiple 2 --extra 1 --in-delim $tab --col 2,!{prop,,project,project_picard_file_sample_col,missing=2} | perl $common_bin_dir/uncommify.pl --in-delim $tab > !{output,,seq_batch_picard_file} class_level seq_batch

prop picard_cols=list
local cmd make_seq_batch_picard_pdf_file=$draw_box_plot_cmd(!{input\,\,seq_batch_picard_file} !{output\,\,seq_batch_picard_pdf_file} 'Picard Metrics by !{prop\,\,seq_batch\,disp}' '' 'Sample Values' '!{prop\,\,seq_batch\,picard_cols\,sep=\\,}' label=1 order=2 sep=$tab comments=FALSE) class_level seq_batch


prop failed=scalar default 0
local cmd make_sample_bam_xml_file=perl $targeted_bin_dir/write_igv_xml.pl !{input,--bam,sample_bam_file} --hg-build $hg_build > !{output,,sample_bam_xml_file} class_level sample skip_if failed

short cmd make_gatk_sample_coverage_file=$gatk_cmd_no_interval(DepthOfCoverage) !{input,-L,project_expanded_interval_list_file} -l OFF -o /dev/stdout -omitSampleSummary -omitSampleSummary -omitIntervals -omitLocusTable !{input,-I,sample_bam_file} | gzip - > !{output,,sample_coverage_file} class_level sample skip_if or,failed,sample_coverage_file,no_coverage run_if use_gatk_doc

!!expand:projectt_sample_subset:project_sample_subset:pheno_sample_subset! \
short cmd make_projectt_sample_subset_bam_list_file=$smart_join_cmd --in-delim $tab --exec "cut -f1 !{input,,project_sample_bam_list_file} | sort -u | cat - !{input,,project_sample_subset_samp_keep_file} | sort | uniq -d" !{input,--file,project_sample_subset_samp_keep_file} !{input,--file,project_sample_bam_list_file} --rest-extra 1 | cut -f2 > !{output,,projectt_sample_subset_bam_list_file} class_level projectt_sample_subset

prop compute_coverage=scalar

!!expand:project_sample_subset:project_sample_subset:pheno_sample_subset! \
short cmd make_project_sample_subset_coverage_file=$gatk_cmd_no_interval(DepthOfCoverage) !{input,-L,project_expanded_interval_list_file} -l OFF -o /dev/stdout -omitSampleSummary -omitIntervals -omitLocusTable !{input,-I,project_sample_subset_bam_list_file} | gzip -c > !{output,,project_sample_subset_coverage_file} class_level project_sample_subset run_if compute_coverage

sort_scratch_dir=$tmp_dir/sort

prop use_gatk_doc=scalar default 1

short cmd make_sample_coverage_file=mkdir -p $sort_scratch_dir && $samtools_cmd pileup !{input,,sample_bam_file} 2>/dev/null | sed 's/\s\s*/:/' | $smart_cut_cmd --select-col 0,'1 3' | $add_gene_annot_cmd --locus-col 1 --gene-file !{input,,project_expanded_interval_list_file} --gene-file-num-ids 0 --gene-file-comment @ | $smart_cut_cmd --exec "grep -v @ !{input,,project_expanded_interval_list_file} | awk '{for (i=\\$2;i<=\\$3;i++) {print \\$1\":\"i,0}}'" --out-delim $tab | sort -S 2G -T $sort_scratch_dir -k1,1 -k2,2nr | awk '!last || last!=\$1 {print} {last=\$1}' | sed '1 s/^/Locus\tTotal_Depth\n/' | gzip - > !{output,,sample_coverage_file} class_level sample skip_if or,failed,sample_coverage_file,no_coverage,use_gatk_doc

coverage_stats_helper=zcat !{input,,sample_coverage_file} | tail -n+2 | $add_gene_annot_cmd --gene-file-num-ids 2 --print-multiple --gene-id-join-char ' ' --outside-name $outside_gene_name --locus-col 1 !{input,--gene-file,project_expanded_exon_target_file,if_prop=expand_coverage_targets,allow_empty=1} !{input,--gene-file,project_exon_target_file,unless_prop=expand_coverage_targets,allow_empty=1} --print-multiple

short cmd make_sample_coverage_stats_file=$coverage_stats_helper | $table_sum_stats_threshold_cmd !{prop,--label,sample} --col 4 > !{output,,sample_coverage_stats_file} class_level sample skip_if or,failed,sample_coverage_stats_file

prop skip_exon_coverage=scalar

!!expand:;:type;extraprocess;group_col;val_col;extrarunif:\
gene;;1;4;:\
exon;;1 --group-col 2;4;,skip_exon_coverage! \
short cmd make_sample_type_coverage_stats_file=$coverage_stats_helper(project_type_target_file) extraprocess | $table_sum_stats_threshold_cmd !{prop,--label,sample} --col val_col --group-col group_col > !{output,,sample_type_coverage_stats_file} class_level sample skip_if or,failed,sample_type_coverage_stats_fileextrarunif

short cmd make_sample_bait_coverage_stats_file=$coverage_stats_helper(project_bait_target_file) | cut -f3- | $add_gene_annot_cmd --gene-file-num-ids 1 --print-multiple --gene-id-join-char ' ' --outside-name $outside_gene_name --locus-col 1 !{input,--gene-file,project_bait_target_file} --print-multiple | $table_sum_stats_threshold_cmd !{prop,--label,sample} --col 3 --group-col 1 > !{output,,sample_bait_coverage_stats_file} class_level sample skip_if or,failed,sample_bait_coverage_stats_file,skip_exon_coverage,!project_bait_target_file


prop whole_exome=scalar default 1
local cmd make_sample_gene_coverage_pdf_file=$draw_box_plot_cmd(!{input\,\,sample_gene_coverage_stats_file} !{output\,\,sample_gene_coverage_pdf_file} 'Coverage across genes' '' 'Coverage' 4 header=FALSE label=1 sep=$coverage_dat_delim) class_level sample skip_if or,failed,whole_exome


cmd meta_table make_project_sample_coverage_stats_file_list=!{input,,sample_coverage_stats_file,unless_prop=failed} !{output,project_sample_coverage_stats_file_list} class_level project

#local cmd make_call_set_sample_coverage_dat_file=$table_sum_stats_threshold_cmd --label sample --col 2 --only-print-header | $prepend_call_set_coverage_dat_label > !{output,,call_set_sample_coverage_dat_file} && xargs cat < !{input,,call_set_sample_coverage_stats_file_list} !{input,sample_coverage_stats_file,unless_prop=failed} | $prepend_call_set_disp_coverage_dat_label >> !{output,,call_set_sample_coverage_dat_file} class_level call_set skip_if failed

#cmd meta_table make_call_set_sample_gene_coverage_stats_file_list=!{input,,sample_gene_coverage_stats_file,unless_prop=failed} !{output,call_set_sample_gene_coverage_stats_file_list} class_level call_set skip_if failed

#local cmd make_call_set_gene_dist_coverage_dat_file=$table_sum_stats_threshold_cmd --label sample --col 4 --only-print-header --group-col 1 | $prepend_call_set_coverage_dat_label > !{output,,call_set_gene_dist_coverage_dat_file} && xargs cat < !{input,,call_set_sample_gene_coverage_stats_file_list} !{input,sample_gene_coverage_stats_file,unless_prop=failed} | $prepend_call_set_disp_coverage_dat_label >> !{output,,call_set_gene_dist_coverage_dat_file} class_level call_set skip_if failed

frac_above_threshold_mean=$summary_mean(${frac_above_threshold})

#local cmd make_call_set_gene_cum_coverage_dat_file=$table_sum_stats_cmd --out-delim , --summaries --has-header --col $frac_above_threshold --group-col 2 --label "!{prop,,call_set,disp}" --print-header --in-delim $coverage_dat_delim < !{input,,call_set_gene_dist_coverage_dat_file} | $make_cum_dat_cmd --nbins $num_cum_bins --min 0 --max 1 --header 1 --col $frac_above_threshold_mean --in-delim $coverage_dat_delim --out-delim $coverage_dat_delim > !{output,,call_set_gene_cum_coverage_dat_file} class_level call_set skip_if failed

#local cmd make_call_set_sample_coverage_pdf_file=$draw_coverage_bar_plot_cmd(!{input\,\,call_set_sample_coverage_dat_file},!{output\,\,call_set_sample_coverage_pdf_file},'Coverage across passed samples -- !{prop\,\,call_set\,disp}') class_level call_set skip_if failed
#local cmd make_call_set_gene_dist_coverage_pdf_file=$draw_coverage_box_plot_cmd(!{input\,\,call_set_gene_dist_coverage_dat_file},!{output\,\,call_set_gene_dist_coverage_pdf_file},'Coverage across genes -- passed !{prop\,\,call_set\,disp} samples') class_level call_set skip_if or,whole_exome,failed
#local cmd make_call_set_gene_cum_coverage_pdf_file=$draw_line_plot_cmd !{input,,call_set_gene_cum_coverage_dat_file} !{output,,call_set_gene_cum_coverage_pdf_file} 'Distribution of gene coverage -- passed !{prop,,call_set,disp} samples' 'Fraction of bases >= ${threshold}x' 'Fraction of genes above' 1 2 sep=$coverage_dat_delim decreasing=TRUE class_level call_set skip_if failed

local cmd make_project_sample_coverage_dat_file=$table_sum_stats_threshold_cmd --label sample --col 2 --only-print-header > !{output,,project_sample_coverage_dat_file} && xargs cat < !{input,,project_sample_coverage_stats_file_list} !{input,sample_coverage_stats_file,unless_prop=failed} >> !{output,,project_sample_coverage_dat_file} class_level project

meta_table cmd make_project_failed_sample_list_file=!{prop,,sample,if_prop=failed} !{output,project_failed_sample_list_file} class_level project skip_if no_sample_tracking
meta_table cmd make_project_passed_sample_list_file=!{prop,,sample,unless_prop=failed} !{output,project_passed_sample_list_file} class_level project skip_if no_sample_tracking

local cmd make_project_empty_failed_sample_list_file=rm -f !{output,,project_failed_sample_list_file} && touch !{output,,project_failed_sample_list_file} class_level project run_if no_sample_tracking
local cmd make_project_untracked_passed_sample_list_file=$smart_cut_cmd --ignore-status $broken_pipe_status !{raw,--exec,call_set,"zcat *call_set_compressed_vcf_file | $vcf_utils_cmd --samp-map *call_set_sample_vcf_id_to_sample_id_file --print-samps",if_prop=zip_vcf:eq:.gz,allow_empty=1}!{raw,--exec,call_set,"cat *call_set_compressed_vcf_file | $vcf_utils_cmd --samp-map *call_set_sample_vcf_id_to_sample_id_file --print-samps",unless_prop=zip_vcf:eq:.gz,allow_empty=1} !{input,call_set_sample_vcf_id_to_sample_id_file} !{input,call_set_compressed_vcf_file} | sort -u > !{output,,project_passed_sample_list_file} class_level project run_if no_sample_tracking

total_status=Tot
failed_status=Low Cov
passed_status=Cov Met
qc_fail_status=Rem Seq
popgen_fail_status=Rem Pop
popgen_pass_status=Inc Pop
covar_pass_status=Inc Covar
cluster_pass_status=Inc Cluster
qc_pass_status=QC Plus
related_fail_status=Rel

total_status_long=Attempted
failed_status_long=Coverage Not Met
passed_status_long=Coverage Met
qc_fail_status_long=Removed Seq
popgen_fail_status_long=Removed Popgen
popgen_pass_status_long=Included Popgen
covar_pass_status_long=Included Covar
cluster_pass_status_long=Included Cluster
qc_pass_status_long=QC Plus
related_fail_status_long=Related


local cmd make_project_sample_failure_status_file=$smart_cut_cmd --in-delim $tab --exec "sed 's/$/\t1\t0\t0/' !{input,,project_failed_sample_list_file}" --exec "sort !{input,,project_passed_sample_list_file} !{input,,project_sample_seq_exclude_file} | uniq -d | sed 's/$/\t0\t1\t0/' " --exec "sed 's/$/\t0\t0\t1/' !{input,,project_sample_include_file}" | sed '1 s/^/Sample\t$failed_status\t$qc_fail_status\t$qc_pass_status\n/' > !{output,,project_sample_failure_status_file} class_level project

local cmd make_project_sample_cum_coverage_dat_file=$make_cum_dat_cmd --nbins $num_cum_bins --min 0 --max 1 --header 1 --col $frac_above_threshold --in-delim $coverage_dat_delim --out-delim $coverage_dat_delim < !{input,,project_sample_coverage_dat_file} > !{output,,project_sample_cum_coverage_dat_file} class_level project
local cmd make_project_sample_cum_coverage_pdf_file=$draw_line_plot_cmd !{input,,project_sample_cum_coverage_dat_file} !{output,,project_sample_cum_coverage_pdf_file} 'Distribution of sample coverage -- passed samples' 'Fraction of bases >= ${threshold}x' 'Fraction of samples above' 1 2 sep=$coverage_dat_delim decreasing=TRUE class_level project

!!expand:type:gene:exon:bait! \
cmd meta_table make_project_sample_type_coverage_stats_file_list=!{input,,sample_type_coverage_stats_file,unless_prop=failed} !{output,project_sample_type_coverage_stats_file_list} class_level project skip_if no_coverage
cmd meta_table make_project_sample_coverage_file_list=!{prop,,sample}\t!{input,,sample_coverage_file,unless_prop=failed} !{output,project_sample_coverage_file_list} class_level project skip_if no_coverage

!!expand:,:type,group_cols,val_col:gene,1,4:exon,1 --group-col 2,5:bait,1,4! \
local cmd make_project_type_dist_coverage_dat_file=$table_sum_stats_threshold_cmd --only-print-header --label sample --group-col group_cols --col val_col > !{output,,project_type_dist_coverage_dat_file} && xargs cat < !{input,,project_sample_type_coverage_stats_file_list} !{input,sample_type_coverage_stats_file,unless_prop=failed} >> !{output,,project_type_dist_coverage_dat_file} class_level project skip_if no_coverage 
local cmd make_project_type_gene_coverage_pdf_file=$draw_box_plot_cmd(!{input\,\,project_gene_dist_coverage_dat_file} !{output\,\,project_gene_dist_coverage_pdf_file} 'Coverage across genes -- all passed samples' '' '% bases >= ${threshold}x' $frac_above_threshold label=1 sep=$coverage_dat_delim) class_level project skip_if or,whole_exome,no_coverage

!!expand:,:type,group_col:gene,1:exon,1 --group-col 2:bait,1! \
local cmd make_project_type_dist_mean_coverage_dat_file=cat !{input,,project_type_dist_coverage_dat_file} | $table_sum_stats_cmd --out-delim , --summaries --has-header --print-header --col $frac_above_threshold --group-col group_col --in-delim $coverage_dat_delim > !{output,,project_type_dist_mean_coverage_dat_file} class_level project skip_if no_coverage

!!expand:type:gene:exon:bait! \
local cmd make_project_type_cum_coverage_dat_file=cat !{input,,project_type_dist_mean_coverage_dat_file} | $make_cum_dat_cmd --nbins $num_cum_bins --min 0 --header 1 --max 1 --col $frac_above_threshold_mean --in-delim $coverage_dat_delim --out-delim $coverage_dat_delim > !{output,,project_type_cum_coverage_dat_file} class_level project skip_if no_coverage

!!expand:type:gene:exon:bait! \
local cmd make_project_type_cum_coverage_pdf_file=$draw_line_plot_cmd !{input,,project_type_cum_coverage_dat_file} !{output,,project_type_cum_coverage_pdf_file} 'Distribution of type coverage -- all passed samples' 'Average per sample fraction of bases >= ${threshold}x' 'Fraction of type above' 1 2 sep=$coverage_dat_delim decreasing=TRUE class_level project skip_if no_coverage

local cmd make_project_lowest_gene_dist_coverage_dat_file=$smart_join_cmd --exec "$smart_cut_cmd !{input,--file,project_gene_dist_mean_coverage_dat_file} --in-delim , --select-col 1,1 --select-col 1,1,$frac_above_threshold_mean" !{input,--file,project_gene_dist_coverage_dat_file} --arg-delim : --in-delim 1:, --in-delim 2:, --multiple 2 --header 1 --out-delim ,  > !{output,,project_lowest_gene_dist_coverage_dat_file} class_level project skip_if no_coverage
local cmd make_project_lowest_gene_dist_coverage_pdf_file=$draw_box_plot_cmd(!{input\,\,project_lowest_gene_dist_coverage_dat_file} !{output\,\,project_lowest_gene_dist_coverage_pdf_file} 'Coverage across genes -- all passed samples' '' '% bases >= ${threshold}x' $frac_above_threshold label=1 sep=$coverage_dat_delim order=$frac_above_threshold_mean) class_level project skip_if or,whole_exome,no_coverage

#gs -dNOPAUSE -sDEVICE=pdfwrite -sOUTPUTFILE=finalcombinedpdf.pdf -dBATCH 1.pdf 2.pdf 3.pdf


prop no_sample_tracking=scalar

#plinkseq cmds
local cmd make_plinkseq_ind_info_file=cat !{input,,project_passed_sample_list_file} | sed 's/$/\t.\t.\t.\t.\t./' > !{output,,project_plinkseq_ind_info_file} class_level project 

local cmd make_project_sample_subset_plinkseq_ind_info_file=awk -v OFS="\t" -F "\t" 'NR >= !{prop,,project_sample_subset,samp_start} && NR < !{prop,,project_sample_subset,samp_end} {print}' < !{input,,project_plinkseq_ind_info_file} > !{output,,project_sample_subset_plinkseq_ind_info_file} class_level project_sample_subset

prop pheno_qt=scalar default 0
prop pheno_type=scalar
prop pheno_missing=scalar
prop pheno_description=scalar
prop no_strat_phenos=scalar


max_region_length=8500000
min_region_length=0
prop region_buffer=scalar default 5000

local cmd make_project_region_list_file=sort -k2,2 -k3,3n !{input,,project_gene_target_file} !{input,,project_transcript_target_file} | uniq -f1 | perl $targeted_bin_dir/get_regions_from_gene_interval_list.pl $max_region_length $min_region_length !{prop,,project,region_buffer} --require-disjoint > !{output,,project_region_list_file} class_level project

local cmd make_project_all_regions_dat_file=$interesting_region_or_loci_dat_helper("cat !{input,,project_region_list_file} | cut -f1 | sort -u") > !{output,,project_all_regions_dat_file} class_level project run_if all_regions_interesting

local cmd make_project_interesting_regions_dat_file=$smart_cut_cmd --in-delim $tab !{raw,,pheno,--exec "$optional_cat(*pheno_interesting_loci_dat_file)",unless_prop=not_trait} !{input,pheno_interesting_loci_dat_file,optional=1} | cat - !{input,,project_all_regions_dat_file,if_prop=all_regions_interesting,allow_empty=1} | sort -u > !{output,,project_interesting_regions_dat_file} class_level project with pheno

prop chrom=scalar
prop ref_chrom=scalar
prop region_range=scalar
prop region_start=scalar
prop region_end=scalar

local cmd make_project_interesting_regions_meta_file=$interesting_regions_or_loci_helper(region,project,project_interesting_regions_dat_file,project_interesting_regions_meta_file,,) class_level project with pheno

local cmd make_project_seq_iid_fid_map_file=awk '{print \$1,\$1,".","."}' !{input,,project_passed_sample_list_file} | $rename_seq_tfam_file | awk -v OFS="\t" '{print \$2,\$1}' | sed '1 s/^/IID\tFID\n/' > !{output,,project_seq_iid_fid_map_file} class_level project 

sample_list_to_plink_sample_list=$smart_join_cmd --in-delim $tab --exec "awk 'NR > (1 - @2)' !{input,,project_seq_iid_fid_map_file}" @1 --extra 1 --out-delim $tab --header @2 | awk -v OFS="\t" '{t=\$2; \$2=\$1; \$1=t} {print}'

#plinkseq_resources_helper=--resources $plinkseq_resources_dir --seqdb $plinkseq_seqdb --refdb $plinkseq_refdb
plinkseq_resources_helper=!{input,--seqdb,project_plinkseq_seqdb_file}

short cmd make_project_plinkseq_seqdb_file=rm -f !{output,,project_plinkseq_seqdb_file} && $pseq_no_project_cmd seq-load !{output,--seqdb,project_plinkseq_seqdb_file} --file $reference_file --name hg${hg_build} --description Broad --format build=hg${hg_build} repeat-mode=lower class_level project

!!expand:type:project:project_variant_subset! \
short cmd make_type_plinkseq_locdb_file=rm -f !{output,,type_plinkseq_locdb_file} && $pseq_no_project_cmd loc-load !{output,--locdb,type_plinkseq_locdb_file} --group $pseq_genes_loc_group !{input,--file,type_genes_gtf_file} --keep-unmerged $pseq_genes_loc_group class_level type

pseq_generic_locset_name=generic
pseq_custom_locset_name=custom

pseq_generic_loc_group=$pseq_genes_loc_group
pseq_custom_loc_group=$pseq_genes_loc_group

!!expand:pathwayburdentype:custom! \
local cmd make_project_pathway_pathwayburdentype_flat_locset_file=sort -k2 !{input,,project_pathwayburdentype_locset_file} | perl -ne '@a = split; \$a{\$a[1]}{\$a[0]} = 1; END {foreach \$a (sort keys %a) {print \$a . "\t" . join("|", keys %{\$a{\$a}}) . "\n"}}' > !{output,,project_pathway_pathwayburdentype_flat_locset_file} class_level project with pheno

!!expand:,:projectt,projectl:project,project:project_sample_subset,project:project_variant_subset,project_variant_subset! \
local cmd make_projectt_plinkseq_project_file=rm -f !{raw,,projectt,*projectt_plinkseq_vardb_file} !{raw,,projectt,*projectt_plinkseq_inddb_file} && $pseq_cmd !{output,,projectt_plinkseq_project_file} new-project !{raw,--vcf,projectt,*projectt_vcf_file} !{raw,--vcf,projectt,*projectt_indel_vcf_file} !{raw,--vcf,projectt,*projectt_multiallelic_vcf_file} $plinkseq_resources_helper --scratch !{raw,,projectt,$projectt_plinkseq_project_temp_dir} !{raw,--locdb,projectl,*projectl_plinkseq_locdb_file} && touch !{output,,projectt_plinkseq_project_done_file} class_level projectt

pseq_snp_tag=snps
pseq_indel_tag=indels
pseq_multiallelic_tag=multiallelics

!|expand:;:projectt;projectl;projecti;projecte;extracmd;after;shortt:\
project;project;project;;load-vcf;run_with project_sample_subset,project_variant_subset;:\
project_sample_subset;project;project_sample_subset;_project_sample_subset;load-vcf;rusage_mod $load_sample_db_mem;short:\
project_variant_subset;project_variant_subset;project;_project_variant_subset;load-vcf;;short| \
shortt cmd make_projectt_plinkseq_project_dbs=rm -rf !{raw,,projectt,$projectt_plinkseq_project_out_dir/*} && rm -rf !{raw,,projectt,$projectt_plinkseq_project_temp_dir/*} && $pseq_project_cmdprojecte load-vcf !{input,projectt_vcf_file} !{input,projectt_indel_vcf_file} !{input,projectt_multiallelic_vcf_file} !{output,projectt_plinkseq_vardb_file} && $pseq_project_cmdprojecte tag-file --id 1 --name $pseq_snp_tag && $pseq_project_cmdprojecte tag-file --id 2 --name $pseq_indel_tag && $pseq_project_cmdprojecte tag-file --id 3 --name $pseq_multiallelic_tag && $pseq_project_cmdprojecte load-pedigree !{input,--file,projecti_plinkseq_ind_info_file} !{output,projectt_plinkseq_inddb_file} && touch !{output,,projectt_plinkseq_db_done_file} !{output,,projectt_plinkseq_temp_done_file} !{input,projectl_plinkseq_locdb_file} class_level projectt after

#!!expand:,:projectt,projectl:project,project:project_sample_subset,project:project_variant_subset,project_variant_subset! \
#local cmd make_projectt_plinkseq_indel_project_file=$pseq_cmd !{output,,projectt_plinkseq_indel_project_file} new-project !{raw,--vcf,projectt,*projectt_indel_vcf_file} $plinkseq_resources_helper --scratch !{raw,,projectt,$projectt_plinkseq_indel_project_temp_dir} !{raw,--locdb,projectl,*projectl_plinkseq_locdb_file} && touch !{output,,projectt_plinkseq_indel_project_done_file} class_level projectt

#!|expand:;:projectt;projectl;projecti;projecte;after;shortt:project;project;project;;run_with project_sample_subset,project_variant_subset;:project_sample_subset;project;project_sample_subset;_project_sample_subset;;short:project_variant_subset;project_variant_subset;project;_project_variant_subset;;short| \
#shortt cmd make_projectt_plinkseq_indel_project_dbs=rm -rf !{raw,,projectt,$projectt_plinkseq_indel_project_out_dir/*} && rm -rf !{raw,,projectt,$projectt_plinkseq_indel_project_temp_dir/*} && $pseq_indel_project_cmdprojecte load-vcf !{input,projectt_indel_vcf_file} !{output,projectt_plinkseq_indel_vardb_file} && $pseq_indel_project_cmdprojecte load-pedigree !{input,--file,projecti_plinkseq_ind_info_file} !{output,projectt_plinkseq_indel_inddb_file} && touch !{output,,projectt_plinkseq_indel_db_done_file} !{output,,projectt_plinkseq_indel_temp_done_file} !{input,projectl_plinkseq_locdb_file} after class_level projectt 

!!expand:,:projectt,projectl:project,project:project_sample_subset,project:project_variant_subset,project_variant_subset! \
projectt_clean_project_helper=$plinkseq_resources_helper --scratch !{raw,,projectt,$projectt_plinkseq_clean_project_temp_dir} !{raw,--locdb,projectl,*projectl_plinkseq_locdb_file} && touch !{output,,projectt_plinkseq_clean_project_done_file}

!!expand:,:projectt,projectl:project,project:project_sample_subset,project:project_variant_subset,project_variant_subset! \
local cmd make_projectt_plinkseq_clean_project_file=rm -f !{output,,projectt_plinkseq_clean_project_file} && rm -f !{raw,,projectt,*projectt_plinkseq_clean_vardb_file} !{raw,,projectt,*projectt_plinkseq_clean_inddb_file} && $pseq_cmd !{output,,projectt_plinkseq_clean_project_file} new-project !{raw,--vcf,projectt,*projectt_clean_vcf_file} !{raw,--vcf,projectt,*projectt_clean_indel_vcf_file} !{raw,--vcf,projectt,*projectt_clean_multiallelic_vcf_file} $projectt_clean_project_helper class_level projectt 

!!expand:,:projectt,projectl:project,project:project_sample_subset,project:project_variant_subset,project_variant_subset! \
local cmd ln_projectt_plinkseq_clean_project_dbs=rm -rf !{raw,,projectt,$projectt_plinkseq_clean_project_out_dir/*} && rm -rf !{raw,,projectt,$projectt_plinkseq_clean_project_temp_dir/*} && rm -f !{output,,projectt_plinkseq_clean_vardb_file} !{output,,projectt_plinkseq_clean_inddb_file} && ln -s !{input,,projectt_plinkseq_vardb_file} !{output,,projectt_plinkseq_clean_vardb_file} && ln -s !{input,,projectt_plinkseq_inddb_file} !{output,,projectt_plinkseq_clean_inddb_file} && touch !{output,,projectt_plinkseq_clean_db_done_file} !{output,,projectt_plinkseq_clean_temp_done_file} !{input,projectl_plinkseq_locdb_file} class_level projectt skip_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file

!|expand:;:projectt;projectl;projecti;projecte;after;shortt:project;project;project;;run_with project_sample_subset,project_variant_subset;:project_sample_subset;project;project_sample_subset;_project_sample_subset;;short:project_variant_subset;project_variant_subset;project;_project_variant_subset;;short| \
shortt cmd make_projectt_plinkseq_clean_project_dbs=rm -rf !{raw,,projectt,$projectt_plinkseq_clean_project_out_dir/*} && rm -rf !{raw,,projectt,$projectt_plinkseq_clean_project_temp_dir/*} && rm -f !{output,,projectt_plinkseq_clean_vardb_file} !{output,,projectt_plinkseq_clean_inddb_file} && $pseq_clean_project_cmdprojecte load-vcf !{input,projectt_clean_vcf_file} !{input,projectt_clean_indel_vcf_file} !{input,projectt_clean_multiallelic_vcf_file} !{output,projectt_plinkseq_clean_vardb_file} && $pseq_clean_project_cmdprojecte tag-file --id 1 --name $pseq_snp_tag && $pseq_clean_project_cmdprojecte tag-file --id 2 --name $pseq_indel_tag && $pseq_clean_project_cmdprojecte tag-file --id 3 --name $pseq_multiallelic_tag && $pseq_clean_project_cmdprojecte load-pedigree !{input,--file,projecti_plinkseq_ind_info_file} !{output,projectt_plinkseq_clean_inddb_file} && touch !{output,,projectt_plinkseq_clean_db_done_file} !{output,,projectt_plinkseq_clean_temp_done_file} !{input,projectl_plinkseq_locdb_file} after class_level projectt run_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file

#local cmd make_plinkseq_samtools_clean_project_file=$pseq_cmd !{output,,project_plinkseq_samtools_clean_project_file} new-project !{raw,--vcf,project,*project_samtools_clean_vcf_file} $plinkseq_resources_helper --scratch !{raw,,project,$project_plinkseq_samtools_clean_project_temp_dir} !{input,--locdb,project_plinkseq_locdb_file} class_level project

#cmd make_plinkseq_samtools_clean_project_dbs=rm -rf !{raw,,project,$project_plinkseq_samtools_clean_project_out_dir/*} && rm -rf !{raw,,project,$project_plinkseq_samtools_clean_project_temp_dir/*} && $pseq_samtools_clean_project_cmd load-vcf !{input,project_samtools_clean_vcf_file} !{output,project_plinkseq_samtools_clean_vardb_file} && $pseq_samtools_clean_project_cmd load-pedigree !{input,--file,project_plinkseq_ind_info_file} && $pseq_samtools_clean_project_cmd load-pheno !{input,--file,project_plinkseq_phe_file} !{output,project_plinkseq_samtools_clean_inddb_file} && touch !{output,,project_plinkseq_samtools_clean_db_done_file} class_level project

prop gq_crit=scalar default GQ:ge:20
gq_crit_helper=!{prop;;project;gq_crit}
gq_mask=--mask geno=$gq_crit_helper

#should ultimately change no_project_cmd to not depend on any project file, but I think right now pseq does not like this
pseq_no_project_cmd=$pseq_cmd . 

!!expand:,:projectt,projecte:project,:project_sample_subset,_project_sample_subset:project_variant_subset,_project_variant_subset! \
pseq_project_cmdprojecte=$pseq_cmd !{raw,,projectt,*projectt_plinkseq_project_file} !{input,projectt_plinkseq_project_done_file}

#!!expand:,:projectt,projecte:project,:project_sample_subset,_project_sample_subset:project_variant_subset,_project_variant_subset! \
#pseq_indel_project_cmdprojecte=$pseq_cmd !{raw,,projectt,*projectt_plinkseq_indel_project_file} !{input,projectt_plinkseq_indel_project_done_file}

!!expand:,:projectt,projecte:project,:project_sample_subset,_project_sample_subset:project_variant_subset,_project_variant_subset! \
pseq_clean_project_cmdprojecte=$pseq_cmd !{raw,,projectt,*projectt_plinkseq_clean_project_file} !{input,projectt_plinkseq_clean_project_done_file}
#pseq_samtools_clean_project_cmd=$pseq_cmd !{input,,project_plinkseq_samtools_clean_project_file}

!!expand:,:projectt,projecte,projectl:project,,project:project_sample_subset,_project_sample_subset,project:project_variant_subset,_project_variant_subset,project_variant_subset! \
pseq_analysis_cmdprojecte=$pseq_project_cmdprojecte !{input,projectt_plinkseq_db_done_file} !{input,projectl_plinkseq_locdb_file}

vcf_pass=PASS

!!expand:projecte::_project_sample_subset:_project_variant_subset! \
pseq_qc_pass_no_gq_mask_analysis_cmdprojecte=$pseq_analysis_cmdprojecte @1 --mask filter=$vcf_pass
!!expand:projecte::_project_sample_subset:_project_variant_subset! \
pseq_qc_pass_analysis_cmdprojecte=$pseq_qc_pass_no_gq_mask_analysis_cmdprojecte(@1) $gq_mask
!!expand:projecte::_project_sample_subset:_project_variant_subset! \
pseq_raw_analysis_cmdprojecte=$pseq_analysis_cmdprojecte @1 $gq_mask
!!expand:projecte::_project_sample_subset:_project_variant_subset! \
pseq_filtered_analysis_cmdprojecte=$pseq_analysis_cmdprojecte @1 --mask filter.ex=$vcf_pass $gq_mask

list_to_mask=tr '\n' ',' | sed 's/,$//'
filter_samples_mask=--mask indiv.ex=@!{input,,project_sample_exclude_file}
!!expand:projecte::_project_sample_subset:_project_variant_subset! \
pseq_filter_samples_analysis_cmdprojecte=$pseq_qc_pass_analysis_cmdprojecte(@1) $filter_samples_mask
!!expand:projecte::_project_sample_subset:_project_variant_subset! \
pseq_filter_only_samples_no_gq_mask_analysis_cmdprojecte=$pseq_analysis_cmdprojecte @1 $filter_samples_mask 
!!expand:projecte::_project_sample_subset:_project_variant_subset! \
pseq_filter_only_samples_analysis_cmdprojecte=$pseq_filter_only_samples_no_gq_mask_analysis_cmdprojecte(@1) $gq_mask
!!expand:,:projectt,projecte,projectl:project,,project:project_sample_subset,_project_sample_subset,project:project_variant_subset,_project_variant_subset,project_variant_subset! \
pseq_qc_plus_no_mask_analysis_cmdprojecte=$pseq_clean_project_cmdprojecte !{input,projectt_plinkseq_clean_db_done_file} !{input,projectl_plinkseq_locdb_file} @1
!!expand:,:projectt,projecte,projectl:project,,project:project_sample_subset,_project_sample_subset,project:project_variant_subset,_project_variant_subset,project_variant_subset! \
pseq_qc_plus_analysis_cmdprojecte=$pseq_qc_plus_no_mask_analysis_cmdprojecte(@1) $gq_mask 

#pseq_filter_variants_analysis_cmd=$pseq_filter_samples_analysis_cmd(@1) --mask var.ex=`tr '\n' ',' < !{input,,project_variant_exclude_file} | sed 's/,$//'`

sqlite_error=^SQLITE\|^Created.\*database:
catch_sqlite_errors=sed 's/\($sqlite_error\)/\#\1/g'
remove_sqlite_errors=perl -ne 'print unless /$sqlite_error/'

!!expand:;:projectt;projecte;skipif;shortt:project;;skip_if or,num_samp_subsets,num_var_subsets;:project_sample_subset;_project_sample_subset;;short:project_variant_subset;_project_variant_subset;;short! \
!!expand:;:qctype;runif:qc_pass;:qc_plus;run_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file! \
shortt cmd make_projectt_plinkseq_qctype_plink_file=rm -f !{output,,projectt_plinkseq_qctype_tfam_file} !{output,,projectt_plinkseq_qctype_tped_file} && $pseq_qctype_analysis_cmdprojecte(write-ped) !{raw,--name,projectt,*projectt_plinkseq_qctype_plink_file} !{output,projectt_plinkseq_qctype_tped_file} !{output,projectt_plinkseq_qctype_tfam_file} class_level projectt skipif runif

!!expand:;:projectt;projecte;skipif;shortt:project;;skip_if num_var_subsets;:project_variant_subset;_project_variant_subset;;short! \
shortt cmd make_projectt_plinkseq_qc_pass_unthresholded_plink_file=rm -f !{output,,projectt_plinkseq_qc_pass_unthresholded_tfam_file} !{output,,projectt_plinkseq_qc_pass_unthresholded_tped_file} && $pseq_qc_pass_no_gq_mask_analysis_cmdprojecte(write-ped) !{raw,--name,projectt,*projectt_plinkseq_qc_pass_unthresholded_plink_file} !{output,projectt_plinkseq_qc_pass_unthresholded_tped_file} !{output,projectt_plinkseq_qc_pass_unthresholded_tfam_file} class_level projectt skipif 

!!expand:;:projectt;projecte;skipif;shortt:project;;skip_if or,num_samp_subsets,num_var_subsets;:project_sample_subset;_project_sample_subset;;short:project_variant_subset;_project_variant_subset;;short! \
local cmd ln_projectt_plinkseq_qc_plus_plink_file=rm -f !{output,,projectt_plinkseq_qc_plus_tfam_file} !{output,,projectt_plinkseq_qc_plus_tped_file} && ln -s !{input,,projectt_plinkseq_qc_pass_tped_file} !{output,,projectt_plinkseq_qc_plus_tped_file} && ln -s !{input,,projectt_plinkseq_qc_pass_tfam_file} !{output,,projectt_plinkseq_qc_plus_tfam_file} class_level projectt skipif run_if and,!sample_qc_filter,!var_qc_filter,!project_variant_custom_exclude_file,!project_sample_custom_exclude_file

#this cannot use FID IID map because the renamed tfam is used to generate the FID IID map
rename_seq_tfam_file=perl -ne 'BEGIN {@files=qw(!{input,,marker_initial_filtered_fam_file,if_prop=marker_initial_fam_file,unless_prop=no_marker,allow_empty=1} !{raw,,project,/dev/null}); foreach \$file (@files) {open IN, \$file or die "Cannot read \$file\n"; while (<IN>) {@a = split; die "Expected two columns" unless scalar @a >= 2; die "Multiple families for ID \$a[1]" if defined \$id2fam{\$a[1]} && \$id2fam{\$a[1]} ne \$a[0]; \$id2fam{\$a[1]} = \$a[0]; \$id2pat{\$a[1]} = \$a[2]; \$id2mat{\$a[1]} = \$a[3]} close IN}} @a = split; \$a[1] = \$a[0] if \$a[1] eq "."; if (exists \$id2fam{\$a[1]}) {\$a[0] = \$id2fam{\$a[1]}; \$a[2] = \$id2pat{\$a[1]}; \$a[3] = \$id2mat{\$a[1]};} print join("\t", @a); print "\n"'

add_sex=perl -ne 'BEGIN {\$file = "!{input,,pheno_non_missing_sample_pheno_file,if_prop=pheno:eq:sex,max=1}"; open IN, \$file or die "Cannot read \$file\n"; while (<IN>) {@a = split; die "Expected two columns" unless scalar @a == 2; die "Multiple sex values for ID \$a[1]" if defined \$id2sex{\$a[0]} && \$id2sex{\$a[0]} ne \$a[1]; \$id2sex{\$a[0]} = \$a[1];} close IN} @a = split; \$a[4] = \$id2sex{\$a[1]} if defined \$id2sex{\$a[1]}; print join("\t", @a); print "\n"'

!!expand:;:project;skipif:project;skip_if or,num_samp_subsets,num_var_subsets:project_sample_subset;:project_variant_subset;! \
!!expand:qctype:qc_pass:qc_plus! \
local cmd make_project_plinkseq_qctype_renamed_tfam_file=$rename_seq_tfam_file < !{input,,project_plinkseq_qctype_tfam_file} > !{output,,project_plinkseq_qctype_renamed_tfam_file} class_level project skipif

!!expand:;:project;skipif:project;skip_if or,num_var_subsets:project_variant_subset;! \
!!expand:qctype:qc_pass_unthresholded! \
local cmd make_project_plinkseq_qctype_renamed_tfam_file=$rename_seq_tfam_file < !{input,,project_plinkseq_qctype_tfam_file} > !{output,,project_plinkseq_qctype_renamed_tfam_file} class_level project skipif

!!expand:;:project;skipif:project;skip_if or,num_samp_subsets,num_var_subsets:project_sample_subset;:project_variant_subset;! \
!!expand:qctype:qc_pass:qc_plus! \
local cmd make_project_plinkseq_qctype_with_sex_tfam_file=cat !{input,,project_plinkseq_qctype_fam_file} | $add_sex > !{output,,project_plinkseq_qctype_with_sex_fam_file} class_level project skipif run_if pheno;pheno:eq:sex

!!expand:qctype:qc_pass:qc_pass_unthresholded:qc_plus! \
cmd cat_project_plinkseq_qctype_renamed_tfam_file=n=`paste -d@ !{input,,project_variant_subset_plinkseq_qctype_renamed_tfam_file,sort_prop=project_variant_subset} | sed "s/\s\s*//g" | sed "s/@/ /g" | $transpose_cmd | sort | uniq | wc -l` && if [[ \$n != 1 ]]; then perl -e 'die "Tfam files did not math at variant subset level\n"'; fi && cp !{input,,project_variant_subset_plinkseq_qctype_renamed_tfam_file,limit=1} !{output,,project_plinkseq_qctype_renamed_tfam_file} class_level project run_if num_var_subsets

!|expand:;:qctype;skipif:qc_pass;:qc_pass_unthresholded;:qc_plus;skip_if and,!sample_qc_filter,!var_qc_filter,!project_variant_custom_exclude_file,!project_sample_custom_exclude_file| \
cmd cat_project_plinkseq_qctype_tped_file=rm -f !{output,,project_plinkseq_qctype_tped_file} && cat !{input,,project_variant_subset_plinkseq_qctype_tped_file,sort_prop=project_variant_subset} > !{output,,project_plinkseq_qctype_tped_file} class_level project run_if num_var_subsets

!!expand:project:project:project_sample_subset:project_variant_subset! \
!!expand:qctype:qc_pass:qc_pass_unthresholded:qc_plus! \
project_plinkseq_qctype_plink_bfile_helper=rm -f !{output,,project_plinkseq_qctype_bed_file} !{output,,project_plinkseq_qctype_fam_file} !{output,,project_plinkseq_qctype_bim_file} && $plink_cmd !{input,--tped,project_plinkseq_qctype_tped_file} !{input,--tfam,project_plinkseq_qctype_renamed_tfam_file} --make-bed !{raw,--out,project,*project_plinkseq_qctype_plink_file} !{output,project_plinkseq_qctype_bed_file} !{output,project_plinkseq_qctype_fam_file} !{output,project_plinkseq_qctype_bim_file} && $plink_mv_log_cmd(!{raw;;project;*project_plinkseq_qctype_plink_file},!{output;;project_plinkseq_qctype_make_bed_log_file;optional=1})

!|expand:;:project;skipif;shortt;rusagemod:project;skip_if and,num_samp_subsets,!num_var_subsets;;rusage_mod $project_plinkseq_bfile_mem:project_sample_subset;skip_if fast_split;short;rusage_mod $project_sample_subset_plinkseq_bfile_mem:project_variant_subset;skip_if fast_split;short;| \
!!expand:;:qctype;exrunif:qc_pass;:qc_plus;run_if and,(or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file)! \
shortt cmd make_project_plinkseq_qctype_plink_bfile=$project_plinkseq_qctype_plink_bfile_helper class_level project skipif exrunif rusagemod

!|expand:;:project;skipif;shortt;rusagemod:project;skip_if !num_var_subsets;;rusage_mod $project_plinkseq_bfile_mem:project_variant_subset;skip_if fast_split;short;| \
!!expand:;:qctype;exrunif:qc_pass_unthresholded;! \
shortt cmd make_project_plinkseq_qctype_plink_bfile=$project_plinkseq_qctype_plink_bfile_helper class_level project skipif exrunif rusagemod

!|expand:;:projectt;skipif;shortt:project_sample_subset;;short:project_variant_subset;;short| \
!!expand:;:qctype;exrunif:qc_pass;:qc_plus;run_if and,(or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file)! \
shortt cmd make_fast_projectt_plinkseq_qctype_plink_bfile=$tped_to_bed_cmd !{output,--write-bim,projectt_plinkseq_qctype_bim_file} !{input,,projectt_plinkseq_qctype_tped_file} > !{output,,projectt_plinkseq_qctype_bed_file} class_level projectt skip_if !fast_split exrunif

!|expand:;:projectt;skipif;shortt:project_variant_subset;;short| \
!!expand:;:qctype;exrunif:qc_pass_unthresholded;! \
shortt cmd make_fast_projectt_plinkseq_qctype_plink_bfile=$tped_to_bed_cmd !{output,--write-bim,projectt_plinkseq_qctype_bim_file} !{input,,projectt_plinkseq_qctype_tped_file} > !{output,,projectt_plinkseq_qctype_bed_file} class_level projectt skip_if !fast_split exrunif

!|expand:;:projectt;skipif;shortt:project_sample_subset;;short:project_variant_subset;;short| \
!!expand:;:qctype;exrunif:qc_pass;:qc_plus;run_if and,(or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file)! \
local cmd make_fast_projectt_plinkseq_qctype_plink_bim_file=cp !{input,,projectt_plinkseq_qctype_renamed_tfam_file} !{output,,projectt_plinkseq_qctype_fam_file} class_level projectt skip_if !fast_split exrunif

!|expand:;:projectt;skipif;shortt:project_variant_subset;;short| \
!!expand:;:qctype;exrunif:qc_pass_unthresholded;! \
local cmd make_fast_projectt_plinkseq_qctype_plink_bim_file=cp !{input,,projectt_plinkseq_qctype_renamed_tfam_file} !{output,,projectt_plinkseq_qctype_fam_file} class_level projectt skip_if !fast_split exrunif

!|expand:;:projectt;skipif;shortt:project;skip_if and,num_samp_subsets,!num_var_subsets;:project_sample_subset;;short:project_variant_subset;;short| \
local cmd ln_projectt_plinkseq_qc_plus_plink_bfile=rm -f !{output,,projectt_plinkseq_qc_plus_bed_file} !{output,,projectt_plinkseq_qc_plus_fam_file} !{output,,projectt_plinkseq_qc_plus_bim_file} && ln -s !{input,,projectt_plinkseq_qc_pass_bed_file} !{output,,projectt_plinkseq_qc_plus_bed_file} && ln -s !{input,,projectt_plinkseq_qc_pass_fam_file} !{output,,projectt_plinkseq_qc_plus_fam_file} && ln -s !{input,,projectt_plinkseq_qc_pass_bim_file} !{output,,projectt_plinkseq_qc_plus_bim_file} class_level projectt skipif run_if and,!sample_qc_filter,!var_qc_filter,!project_variant_custom_exclude_file,!project_sample_custom_exclude_file

!!expand:qctype:qc_pass:qc_plus! \
meta_table cmd make_project_qctype_plink_list_file=!{input,--bed,project_sample_subset_plinkseq_qctype_bed_file}\t!{input,--bim,project_sample_subset_plinkseq_qctype_bim_file}\t!{input,--fam,project_sample_subset_plinkseq_qctype_fam_file} !{output,project_qctype_plink_list_file} class_level project run_if and,num_samp_subsets,!num_var_subsets

!!expand:qctype:qc_pass:qc_plus! \
meta_table cmd make_project_qctype_all_merge_list_file=!{input,,project_sample_subset_plinkseq_qctype_bed_file}\t!{input,,project_sample_subset_plinkseq_qctype_bim_file}\t!{input,,project_sample_subset_plinkseq_qctype_fam_file} !{output,project_qctype_all_merge_list_file} class_level project run_if and,num_samp_subsets,!num_var_subsets

!!expand:qctype:qc_pass:qc_plus! \
local cmd make_project_qctype_merge_list_file=tail -n+2 !{input,,project_qctype_all_merge_list_file} > !{output,,project_qctype_merge_list_file} class_level project run_if and,num_samp_subsets,!num_var_subsets

!|expand:;:qctype;skipif:qc_pass;:qc_plus;skip_if and,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file| \
cmd make_project_qctype_plink_file=rm -f !{output,,project_plinkseq_qctype_bed_file} !{output,,project_plinkseq_qctype_bim_file} !{output,,project_plinkseq_qctype_fam_file} && $plink_cmd `head -n1 !{input,,project_qctype_plink_list_file}` !{input,--merge-list,project_qctype_merge_list_file} !{input,project_sample_subset_plinkseq_qctype_bed_file} !{input,project_sample_subset_plinkseq_qctype_bim_file} !{input,project_sample_subset_plinkseq_qctype_fam_file} --make-bed $plink_out_bed_helper(project_plinkseq_qctype) && $plink_mv_log_cmd(!{raw\,\,project\,*project_plinkseq_qctype_plink_file},!{output\,\,project_plinkseq_qctype_make_bed_log_file}) class_level project run_if and,num_samp_subsets,!num_var_subsets rusage_mod $project_plink_mem

!!expand:qctype:qc_pass:qc_plus! \
!!expand:,:projectt,projecte:project,:project_sample_subset,_project_sample_subset:project_variant_subset,_project_variant_subset! \
plink_qctype_bed_cmdprojecte=$plink_cmd !{raw,--bfile,projectt,*projectt_plinkseq_qctype_plink_file} !{input,projectt_plinkseq_qctype_bed_file} !{input,projectt_plinkseq_qctype_bim_file} !{input,projectt_plinkseq_qctype_fam_file}

!!expand:qctype:qc_pass_unthresholded! \
!!expand:,:projectt,projecte:project,:project_variant_subset,_project_variant_subset! \
plink_qctype_bed_cmdprojecte=$plink_cmd !{raw,--bfile,projectt,*projectt_plinkseq_qctype_plink_file} !{input,projectt_plinkseq_qctype_bed_file} !{input,projectt_plinkseq_qctype_bim_file} !{input,projectt_plinkseq_qctype_fam_file}

!!expand:,:phenol:pheno:pheno_variant_subset! \
plink_phenol_bed_cmd=$plink_cmd !{raw,--bfile,phenol,*phenol_plink_file} !{input,phenol_bed_file} !{input,phenol_bim_file} !{input,phenol_fam_file}

plink_analysis_helper_template=!{raw,--out,@5,*@1} --@2 !{output,@4} && mv !{raw,,@5,*@{1}.@3} !{output,,@1}

!!expand:,:projectt,projecte:project,:project_sample_subset,_project_sample_subset:project_variant_subset,_project_variant_subset! \
plink_analysis_helperprojecte=$plink_analysis_helper_template(@1,@2,@3,@4,projectt)

#args are:
# 1. The output file
# 2. The analysis
# 3. The extension appended
# 4. The log file

!!expand:qctype:qc_pass:qc_plus! \
!!expand:,:projectt,projecte:project,:project_sample_subset,_project_sample_subset:project_variant_subset,_project_variant_subset! \
plink_analysis_qctype_bed_cmdprojecte=$plink_qctype_bed_cmdprojecte $plink_analysis_helperprojecte(@1,@2,@3,@4)

!!expand:qctype:qc_pass_unthresholded! \
!!expand:,:projectt,projecte:project,:project_variant_subset,_project_variant_subset! \
plink_analysis_qctype_bed_cmdprojecte=$plink_qctype_bed_cmdprojecte $plink_analysis_helperprojecte(@1,@2,@3,@4)

!!expand:,:phenol:pheno:pheno_variant_subset! \
plink_analysis_phenol_bed_cmd=$plink_phenol_bed_cmd $plink_analysis_helper(@1,@2,@3,@4)

#plink_base_analysis_qc_pass_bed_cmd=$plink_qc_pass_bed_cmd !{raw,--out,project,*project_plinkseq_qc_pass_plink_file} --@1 @2 && $plink_mv_log_cmd(!{raw\,\,project\,*project_plinkseq_qc_pass_plink_file},!{output\,\,project_plinkseq_@{1}_log_file})
#plink_analysis_qc_pass_bed_cmd=$plink_base_analysis_qc_pass_bed_cmd("@1",!{output\,project_plinkseq_@{1}_file})

!!expand:qctype:qc_pass:qc_plus! \
!!expand:,:projectt,projecte:project,:project_variant_subset,_project_variant_subset! \
projectt_plinkseq_qctype_frq_file_helper=$plink_analysis_qctype_bed_cmdprojecte(projectt_plinkseq_qctype_frq_file,freq --nonfounders,frq,projectt_plinkseq_qctype_frq_log_file)

!!expand:qctype:qc_pass:qc_plus! \
!!expand:,:projectt,projecte:project,:project_variant_subset,_project_variant_subset! \
projectt_plinkseq_qctype_strata_frq_file_helper=$plink_analysis_qctype_bed_cmdprojecte(projectt_plinkseq_qctype_strata_frq_file,freq --nonfounders !{input;--remove;project_plink_sample_exclude_file} !{input;--within;pheno_plink_phe_file;if_prop=pheno:eq:@maf_strata_trait},frq.strat,projectt_plinkseq_qctype_strata_frq_log_file)

!!expand:qctype:qc_pass:qc_plus! \
!!expand:,:projectt,projecte:project,:project_variant_subset,_project_variant_subset! \
projectt_plinkseq_qctype_counts_file_helper=$smart_join_cmd --exec "awk -v OFS=$tab '{print \\$2,\\$1,\\$4}' !{input,,projectt_plinkseq_qctype_bim_file}" --exec "awk -v OFS=$tab 'NR > 1 {print \\$2,int(\\$5*\\$6+.5)}' !{input,,projectt_plinkseq_qctype_frq_file}" --in-delim $tab | sed '1 s/^/ID\tCHROM\tPOS\tCOUNT\n/' > !{output,,projectt_plinkseq_qctype_counts_file}

!!expand:,:frq,runif:frq,:strata_frq,run_if maf_strata_trait:counts,! \
!!expand:,:projectt,projecte,skipif:project,,skip_if num_var_subsets:project_variant_subset,_project_variant_subset,bsub_batch 20! \
short cmd make_projectt_plinkseq_qc_pass_frq_file=$projectt_plinkseq_qc_pass_frq_file_helper class_level projectt skipif runif

!!expand:,:projectt,projecte,skipif:project,,skip_if num_var_subsets:project_variant_subset,_project_variant_subset,! \
short cmd make_projectt_multiallelic_frq_file=$multiallelic_qc_cmd !{input,,project_sample_include_file} -spl_field:1 -out:!{output,,projectt_multiallelic_frq_file} -condition_on:$thresholded_nalt_field -var_mask:"file=$pseq_multiallelic_tag" -pseq_project:!{input,,projectt_plinkseq_project_file} class_level projectt skipif 

!!expand:,:frq,runif:frq,:strata_frq,run_if maf_strata_trait:counts,! \
short cmd make_project_plinkseq_qc_plus_frq_file=$project_plinkseq_qc_plus_frq_file_helper class_level project run_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file skip_if num_var_subsets runif

!!expand:frq:frq:strata_frq! \
short cmd make_project_variant_subset_plinkseq_qc_plus_frq_file=if [[ `cat !{input,,project_variant_subset_plinkseq_qc_plus_bim_file} | wc -l` -gt 0 ]]; then $project_variant_subset_plinkseq_qc_plus_frq_file_helper; else head -n1 !{input,,project_variant_subset_plinkseq_qc_pass_frq_file} > !{output,,project_variant_subset_plinkseq_qc_plus_frq_file} && echo > !{output,,project_variant_subset_plinkseq_qc_plus_frq_log_file}; fi class_level project_variant_subset run_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file

combined_frq_helper=$smart_join_cmd --col 2 --header 1 --exec "$smart_join_cmd --header 1 --exec \"$smart_cut_cmd !{input,--file,@1} !{input,--file,@2} --select-col 1,1,SNP --select-col 2,1 --exclude-row 1-2,1 | sort | uniq -d | sed '1 s/^/SNP\n/'\" !{input,--file,@2} !{input,--file,@1} --col 3,2 --rest-extra 1 | $smart_cut_cmd --in-delim $tab --exact --require-col-match --select-col 0,1,'CHR SNP A1 A2 aaf n_tot_samp' --empty-okay | sed '1 s/aaf/MAF/' | sed '1 s/n_tot_samp/NCHROBS/'" !{input,--file,@1} --merge | awk -F"\t" -v OFS="\t" '{t=\$1; \$1=\$2; \$2=t} {print}'

!!expand:,:projectt,projecte,skipif:project,,skip_if num_var_subsets:project_variant_subset,_project_variant_subset,bsub_batch 30! \
!!expand:;:qctype;runif:qc_pass;:qc_plus;run_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file! \
short cmd make_projectt_plinkseq_qctype_combined_frq_file=$combined_frq_helper(projectt_plinkseq_qctype_frq_file,projectt_multiallelic_frq_file) > !{output,,projectt_plinkseq_qctype_combined_frq_file} class_level projectt runif skipif

!!expand:,:projectt,projecte,skipif:project,,skip_if num_var_subsets:project_variant_subset,_project_variant_subset,bsub_batch 30! \
!!expand:;:qctype;runif:qc_pass;:qc_plus;run_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file! \
short cmd make_projectt_plinkseq_qctype_combined_strata_frq_file=$smart_join_cmd --merge --header 1 --col 2 --exec "$smart_join_cmd --header 1 --exec \"$smart_cut_cmd !{input,--file,projectt_plinkseq_qctype_strata_frq_file} !{input,--file,project_multiallelic_strata_frq_file} --select-col 1,1,'SNP CLST' --select-col 2,1,'ID Strata' --exclude-row 1-2,1 | sort | uniq -d | sed '1 s/^/SNP CLST\n/'\" --exec \"sed '1 s/MAF/MAF_1/' !{input,,projectt_plinkseq_qctype_strata_frq_file}\" !{input,--file,project_multiallelic_strata_frq_file} --col 1,1 --col 1,2 --col 2,2 --col 2,3 --col 3,1 --col 3,2 --rest-extra 1 | $smart_cut_cmd --in-delim $tab --exact --require-col-match --select-col 0,1,'CHR SNP CLST A1 A2 MAF N' | sed '1 s/\tN$/\tNCHROBS/' | $add_function_cmd --in-delim $tab --header 1 --col1 MAF --col2 NCHROBS --round --type multiply --val-header MAC --add-at NCHROBS" !{input,--file,projectt_plinkseq_qctype_strata_frq_file} | awk -F"\t" -v OFS="\t" '{t=\$1; \$1=\$2; \$2=t} {print}' > !{output,,projectt_plinkseq_qctype_combined_strata_frq_file} class_level projectt runif skipif

short cmd make_project_variant_subset_plinkseq_qc_plus_counts_file=if [[ `cat !{input,,project_variant_subset_plinkseq_qc_plus_bim_file} | wc -l` -gt 0 ]]; then $project_variant_subset_plinkseq_qc_plus_counts_file_helper; else head -n1 !{input,,project_variant_subset_plinkseq_qc_pass_counts_file} > !{output,,project_variant_subset_plinkseq_qc_plus_counts_file}; fi class_level project_variant_subset run_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file

!!expand:frq:frq:strata_frq:counts! \
!!expand:,:projectt,skipif:project,skip_if num_var_subsets:project_variant_subset,! \
local cmd ln_projectt_plinkseq_qc_plus_frq_file=ln -s !{input,,projectt_plinkseq_qc_pass_frq_file} !{output,,projectt_plinkseq_qc_plus_frq_file} class_level projectt skipif run_if and,!sample_qc_filter,!var_qc_filter,!project_variant_custom_exclude_file,!project_sample_custom_exclude_file

!!expand:,:projectt,skipif:project,skip_if num_var_subsets:project_variant_subset,! \
!!expand:frq:frq:strata_frq! \
local cmd ln_projectt_plinkseq_qc_plus_combined_frq_file=ln -s !{input,,projectt_plinkseq_qc_pass_combined_frq_file} !{output,,projectt_plinkseq_qc_plus_combined_frq_file} class_level projectt run_if and,!sample_qc_filter,!var_qc_filter,!projectt_variant_custom_exclude_file,!projectt_sample_custom_exclude_file skipif

short cmd make_project_multiallelic_strata_frq_file=$smart_cut_cmd !{raw;;pheno_variant_qc_strata;--exec "sed '1! s/$/\t@meta_strata_value/' *pheno_variant_qc_strata_multiallelic_stats_file | sed '1 s/$/\t@pheno/' | $smart_cut_cmd --select-col 0,1,'id @pheno n_tot_samp aaf' --exclude-row 0,1";if_prop=pheno:eq:@maf_strata_trait} !{input,pheno_variant_qc_strata_multiallelic_stats_file,if_prop=pheno:eq:@maf_strata_trait} | $replace_nan(NA) | sed '1 s/^/ID\tStrata\tN\tMAF\n/g' > !{output,,project_multiallelic_strata_frq_file} class_level project run_if maf_strata_trait

!!expand:qc_plus:qc_plus:qc_pass! \
!!expand:,:projectt,projecte,skipif:project,,skip_if num_var_subsets:project_variant_subset,_project_variant_subset,bsub_batch 10! \
short cmd make_projectt_plinkseq_qc_plus_strata_frq_summary_file=$table_sum_stats_cmd !{input,,projectt_plinkseq_qc_plus_combined_strata_frq_file} --has-header --print-header --col MAF --group-col SNP --means --summaries > !{output,,projectt_plinkseq_qc_plus_strata_frq_summary_file} class_level projectt skipif run_if maf_strata_trait

!!expand:qctype:qc_pass:qc_plus! \
qctype_count_mask_helper=$smart_cut_cmd !{input,--file,project_plinkseq_qctype_counts_file} --in-delim $tab --exclude-row 1,1 --select-col 1,1,'CHROM POS' --select-row 1,1,COUNT,eq:@1 | sed 's/\s\s*/:/' |sed 's/^/chr/' | sed 's/^chrchr/chr/'

!!expand:qctype:qc_pass:qc_plus! \
short cmd make_project_plinkseq_qctype_sing_reg_list_file=$qctype_count_mask_helper(1) > !{output,,project_plinkseq_qctype_sing_reg_list_file} class_level project

short cmd make_project_plinkseq_qc_pass_doub_reg_list_file=$qc_pass_count_mask_helper(2) > !{output,,project_plinkseq_qc_pass_doub_reg_list_file} class_level project


het_freq_threshold=.01

read_freq_options=

!!expand:,:_frequency,flag:,:_high,--maf $het_freq_threshold! \
!!expand:,:projectt,projecte,runif,shortt:project,,skip_if num_samp_subsets,:project_sample_subset,_project_sample_subset,bsub_batch 10,short! \
shortt cmd make_projectt_plinkseq_frequency_het_file=$plink_analysis_qc_pass_bed_cmdprojecte(projectt_plinkseq_frequency_het_file,het flag --read-freq !{input::project_plinkseq_qc_pass_frq_file} $read_freq_options,het,projectt_plinkseq_frequency_het_log_file) class_level projectt runif rusage_mod $projectt_plinkseq_bfile_mem

!!expand:,:projectt,projecte,skipif,shortt:project,,skip_if num_samp_subsets,:project_sample_subset,_project_sample_subset,,short! \
shortt cmd make_projectt_plinkseq_sexcheck_file=$plink_cmd !{input,--bed,projectt_plinkseq_qc_pass_bed_file} !{input,--bim,projectt_plinkseq_qc_pass_bim_file} !{input,--fam,projectt_plinkseq_qc_pass_with_sex_fam_file} $plink_analysis_helperprojecte(projectt_plinkseq_sexcheck_file,check-sex,sexcheck,projectt_plinkseq_sexcheck_log_file) class_level projectt skipif run_if pheno;pheno:eq:sex rusage_mod $projectt_plinkseq_bfile_mem

!!expand:,:projectt,projecte,skipif,shortt:project,,skip_if num_samp_subsets,:project_sample_subset,_project_sample_subset,,short! \
local cmd make_dummy_projectt_plinkseq_sexcheck_file=awk '{print \$1,\$2,0,0,"PROBLEM","NA"}' !{input,,projectt_plinkseq_qc_pass_fam_file} | sed '1 s/^/FID IID PEDSEX SNPSEX STATUS F\n/' > !{output,,projectt_plinkseq_sexcheck_file} class_level projectt skipif run_if !pheno;pheno:eq:sex 

het_add_function_helper=$add_function_cmd --header 1 --col1 '@1)' --col2 '@{1}_HIGH' --type subtract --val-header '@{1}_LOW'

!!expand:,:projectt,projecte,runif,shortt:project,,skip_if num_samp_subsets,:project_sample_subset,_project_sample_subset,bsub_batch 10,short! \
shortt cmd make_projectt_plinkseq_low_het_file=$smart_join_cmd !{input,--file,projectt_plinkseq_het_file} --exec "sed '1 s/\(\S\S*\)/\1_HIGH/g' !{input,,projectt_plinkseq_high_het_file}" --header 1 --col 1 --col 2 | $add_function_cmd --header 1 --col1 'O(HOM)' --col2 'O(HOM)_HIGH' --type subtract --val-header 'O(HOM)_LOW' | $add_function_cmd --header 1 --col1 'E(HOM)' --col2 'E(HOM)_HIGH' --type subtract --val-header 'E(HOM)_LOW' | $add_function_cmd --header 1 --col1 'N(NM)' --col2 'N(NM)_HIGH' --type subtract --val-header 'N(NM)_LOW' | $smart_cut_cmd --exact --require-col-match --select-col 0,1,'FID IID O.HOM._LOW E.HOM._LOW N.NM._LOW' | sed '1 s/^/_LOW/g' > !{output,,projectt_plinkseq_low_het_file} class_level projectt runif

!!expand:,:projectt,projecte,skipif,shortt:project,,skip_if num_samp_subsets,:project_sample_subset,_project_sample_subset,,short! \
!|expand;,;maskkey,varmask;all,;syn,--mask reg.req=@!{input::project_plinkseq_syn_reg_file};ns,--mask reg.req=@!{input::project_plinkseq_ns_reg_file};nonsense,--mask reg.req=@!{input::project_plinkseq_nonsense_reg_file};noncoding,--mask reg.ex=@!{input::project_plinkseq_coding_reg_file}| \
!|expand:;:tname;runif:raw;:qc_pass;:qc_plus;run_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file| \ 
shortt cmd make_projectt_plinkseq_tname_maskkey_istats_file=rm -f !{output,,projectt_plinkseq_tname_maskkey_istats_file} && $pseq_tname_analysis_cmdprojecte(i-stats) varmask > !{output,,projectt_plinkseq_tname_maskkey_istats_file} class_level projectt runif skipif

!!expand:,:projectt,projecte,skipif,shortt:project,,skip_if num_samp_subsets,:project_sample_subset,_project_sample_subset,,short! \
!!expand;maskkey;all;syn;ns;nonsense;noncoding;sing! \
local cmd ln_projectt_plinkseq_qc_plus_maskkey_istats_file=rm -f !{output,,projectt_plinkseq_qc_plus_maskkey_istats_file} && ln -s !{input,,projectt_plinkseq_qc_pass_maskkey_istats_file} !{output,,projectt_plinkseq_qc_plus_maskkey_istats_file} class_level projectt skipif run_if and,!sample_qc_filter,!var_qc_filter,!project_variant_custom_exclude_file,!project_sample_custom_exclude_file

!!expand:,:projectt,projecte,runif,shortt:project,,skip_if num_samp_subsets,:project_sample_subset,_project_sample_subset,,short! \
shortt cmd make_projectt_plinkseq_qc_pass_doub_istats_file=$pseq_qc_pass_analysis_cmdprojecte(i-stats) --mask reg.req=@!{input,,project_plinkseq_qc_pass_doub_reg_list_file} > !{output,,projectt_plinkseq_qc_pass_doub_istats_file} class_level projectt runif

!!expand:,:projectt,projecte,runif,shortt:project,,skip_if num_samp_subsets,:project_sample_subset,_project_sample_subset,,short! \
shortt cmd make_projectt_plinkseq_qc_pass_indel_istats_file=$pseq_qc_pass_analysis_cmdprojecte(i-stats) --mask file=$pseq_indel_tag > !{output,,projectt_plinkseq_qc_pass_indel_istats_file} class_level projectt runif

!!expand:,:projectt,projecte,runif,shortt:project,,skip_if num_samp_subsets,:project_sample_subset,_project_sample_subset,,short! \
shortt cmd make_projectt_plinkseq_qc_pass_multiallelic_istats_file=$pseq_qc_pass_analysis_cmdprojecte(i-stats) --mask file=$pseq_multiallelic_tag > !{output,,projectt_plinkseq_qc_pass_multiallelic_istats_file} class_level projectt runif

!!expand:,:projectt,projecte,runif,shortt:project,,skip_if num_samp_subsets,:project_sample_subset,_project_sample_subset,,short! \
shortt cmd make_projectt_plinkseq_qc_pass_snp_istats_file=$pseq_qc_pass_analysis_cmdprojecte(i-stats) --mask file=$pseq_snp_tag > !{output,,projectt_plinkseq_qc_pass_snp_istats_file} class_level projectt runif

!|expand:;:tname;runif:qc_pass;:qc_plus;run_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file| \ 
!!expand:,:projectt,projecte,skipif,shortt:project,,skip_if num_samp_subsets,:project_sample_subset,_project_sample_subset,,short! \
shortt cmd make_projectt_plinkseq_tname_sing_istats_file=rm -f !{output,,projectt_plinkseq_tname_sing_istats_file} && $pseq_tname_analysis_cmdprojecte(i-stats) --mask reg.req=@!{input,,project_plinkseq_tname_sing_reg_list_file} > !{output,,projectt_plinkseq_tname_sing_istats_file} class_level projectt runif skipif

#cmd make_plinkseq_qc_pass_istats_file=$pseq_qc_pass_analysis_cmd(i-stats) > !{output,,project_plinkseq_qc_pass_istats_file} class_level project

!!expand:,:projectt,projecte,runif,shortt:project,,skip_if num_samp_subsets,:project_sample_subset,_project_sample_subset,,short! \
shortt cmd make_projectt_plinkseq_filtered_istats_file=$pseq_filtered_analysis_cmdprojecte(i-stats) > !{output,,projectt_plinkseq_filtered_istats_file} class_level projectt runif

prop no_filters=scalar

!!expand:,:projectt,projecte,runif,shortt:project,,skip_if num_samp_subsets,:project_sample_subset,_project_sample_subset,,short! \
!|expand:;:metatype;metaname;addmask:gq;GQ;:dp;DP;:ab;AB;:sing_ab;AB;--mask reg.req=@!{input,,project_plinkseq_qc_pass_sing_reg_list_file}| \
shortt cmd make_projectt_plinkseq_metatype_vmetamatrix_file=$pseq_qc_pass_analysis_cmdprojecte(v-meta-matrix) $show_id addmask --name metaname > !{output,,projectt_plinkseq_metatype_vmetamatrix_file} class_level projectt runif rusage_mod $pseq_mem

mem

!!expand:,:projectt,projecte,runif,shortt:project,,skip_if num_samp_subsets,:project_sample_subset,_project_sample_subset,,short! \
!!expand:,:metatype,metaname:dp,DP! \
shortt cmd make_projectt_plinkseq_metatype_qcfail_vmetamatrix_file=$pseq_filtered_analysis_cmdprojecte(v-meta-matrix) $show_id --name metaname > !{output,,projectt_plinkseq_metatype_qcfail_vmetamatrix_file} class_level projectt runif

!!expand:,:type,filet:snps,$pseq_snp_tag:indels,$pseq_indel_tag:multiallelics,$pseq_multiallelic_tag! \
!!expand:,:projectt,projecte,runif,shortt\
:project,,skip_if num_var_subsets,\
:project_variant_subset,_project_variant_subset,,short! \
shortt cmd make_projectt_plinkseq_type_vmatrix_file=$pseq_filter_only_samples_no_gq_mask_analysis_cmdprojecte(v-matrix) $show_id --mask file=filet $filter_samples_mask  > !{output,,projectt_plinkseq_type_vmatrix_file} class_level projectt runif

!!expand:,:projectt,projecte,runif,shortt\
:project,,skip_if num_samp_subsets,\
:project_sample_subset,_project_sample_subset,,short! \
shortt cmd make_projectt_plinkseq_qcfail_vmatrix_file=$pseq_filtered_analysis_cmdprojecte(v-matrix) $show_id > !{output,,projectt_plinkseq_qcfail_vmatrix_file} class_level projectt runif

summarize_sample_helper=perl $targeted_bin_dir/summarize_vmeta.pl --by-sample --type @1 --id-head ID --val-head @2 @3

!!expand:,:projectt,projecte:project,:project_sample_subset,_project_sample_subset! \
plinkseq_sample_meta_cmd_no_head_no_cacheprojecte=${pseq_@{1}_analysis_cmdprojecte}(v-meta-matrix) $show_id --name @2 | $summarize_sample_helper(@3,@4,@5)
!!expand:,:projectt,projecte:project,:project_sample_subset,_project_sample_subset! \
plinkseq_sample_meta_cmd_no_headprojecte=cat !{input,,projectt_plinkseq_@{1}_vmetamatrix_file} | $summarize_sample_helper(@2,@3,@4)
!!expand:,:projectt,projecte:project,:project_sample_subset,_project_sample_subset! \
plinkseq_sample_meta_cmdprojecte=$plinkseq_sample_meta_cmd_no_headprojecte(@1,@2,@{3}_@1,@4)
!!expand:,:projectt,projecte:project,:project_sample_subset,_project_sample_subset! \
plinkseq_mean_sample_meta_cmd_no_cacheprojecte=$plinkseq_sample_meta_cmd_no_head_no_cacheprojecte(@1,@2,mean,@3,@4)
!!expand:,:projectt,projecte:project,:project_sample_subset,_project_sample_subset! \
plinkseq_mean_sample_meta_cmdprojecte=$plinkseq_sample_meta_cmdprojecte(@1,mean,MEAN,)
!!expand:,:projectt,projecte:project,:project_sample_subset,_project_sample_subset! \
plinkseq_mean_sample_meta_cmd_no_headprojecte=$plinkseq_sample_meta_cmd_no_headprojecte(@1,mean,@2,@3)
!!expand:,:projectt,projecte:project,:project_sample_subset,_project_sample_subset! \
plinkseq_dev_sample_meta_cmd_no_headprojecte=$plinkseq_sample_meta_cmd_no_headprojecte(@1,dev,@2,@3)

!!expand:,:projectt,projecte:project,:project_sample_subset,_project_sample_subset:project_variant_subset,_project_variant_subset! \
plinkseq_variant_meta_nohead_cmdprojecte=$pseq_filter_only_samples_analysis_cmdprojecte(v-meta-matrix) $show_id --name @1 | perl $targeted_bin_dir/summarize_vmeta.pl --val-head @2

!!expand:,:projectt,projecte:project,:project_sample_subset,_project_sample_subset:project_variant_subset,_project_variant_subset! \
plinkseq_variant_meta_cmdprojecte=$plinkseq_variant_meta_nohead_cmdprojecte(@1 @2,@1)

!!expand:,:projectt,projecte:project,:project_sample_subset,_project_sample_subset! \


compute_het_cmd=$smart_cut_cmd !{input,--file,@1} --select-col 1,1,IID --select-col 1,1,O.HOM --select-col 1,1,NM --out-delim $tab | $add_function_cmd --col1 3 --col2 2 --header 1 --type subtract --in-delim $tab | $add_function_cmd --col1 4 --col2 3 --header 1 --type divide --in-delim $tab --val-header HET@2 | cut -f1,5

ab_col=MEAN_ABM50
min_ab_dp=100

!!expand:,:projectt,projecte:project,:project_sample_subset,_project_sample_subset! \
make_plinkseq_extra_istats_helperprojecte=$smart_join_cmd \
    --exec "$plinkseq_mean_sample_meta_cmd_no_headprojecte(gq,MEAN_GQ,) --out-delim $tab" \
    --exec "$plinkseq_dev_sample_meta_cmd_no_headprojecte(gq,DEV_GQ,) --out-delim $tab"  \
    --exec "$plinkseq_mean_sample_meta_cmd_no_headprojecte(dp,MEAN_DP,) --remap NA,0 --out-delim $tab" \
    --exec "$plinkseq_dev_sample_meta_cmd_no_headprojecte(dp,DEV_DP,) --remap NA,0 --out-delim $tab" \
    --exec "$plinkseq_mean_sample_meta_cmd_no_headprojecte(ab,MEAN_AB,) --out-delim $tab" \
    --exec "$plinkseq_mean_sample_meta_cmd_no_headprojecte(sing_ab,MEAN_SING_AB,) --out-delim $tab" \
    --exec "$plinkseq_mean_sample_meta_cmd_no_cacheprojecte(filtered,AB,M_ALT_QF_AB,!{input\\\,--ref-info\\\,projectt_plinkseq_qcfail_vmatrix_file} --ref-col-start 4 --ref-gt 0 !{input\\\,--ref-info\\\,projectt_plinkseq_dp_qcfail_vmetamatrix_file} --ref-col-start 2 --ref-gt $min_ab_dp) --out-delim $tab" \
    --exec "$plinkseq_sample_meta_cmd_no_headprojecte(ab,mean,$ab_col,--dist-from .5 !{input\\,--ref-info\\,projectt_plinkseq_dp_vmetamatrix_file} --ref-col-start 2 --ref-gt $min_ab_dp) --out-delim $tab" \
    --exec "$plinkseq_mean_sample_meta_cmd_no_cacheprojecte(filtered,AB,M_ALT_QF_ABM50,!{input\\\,--ref-info\\\,projectt_plinkseq_qcfail_vmatrix_file} --ref-col-start 4 --ref-gt 0 !{input\\\,--ref-info\\\,projectt_plinkseq_dp_qcfail_vmetamatrix_file} --ref-col-start 2 --ref-gt $min_ab_dp  --dist-from .5) --out-delim $tab" \
    --exec "$compute_het_cmd(projectt_plinkseq_het_file,)" \
    --exec "$compute_het_cmd(projectt_plinkseq_high_het_file,_HIGH)" \
    --exec "$compute_het_cmd(projectt_plinkseq_low_het_file,_LOW)" \
    --exec "cat !{input,,projectt_plinkseq_sexcheck_file} | awk -v OFS=$tab 'NR == 1 {print \"ID\",\"SEX_CHECK\"} NR > 1 && (\\$3 == 0 || \\$4 == 0) {print \\$2,\"NA\"} NR > 1 && \\$3 != 0 && \\$4 != 0 {if (\\$5 == \"PROBLEM\") {print \\$2,0} if (\\$5 != \"PROBLEM\") {print \\$2,1}}'" \
    @1 \
   --header 1 --in-delim $tab --arg-delim : --out-delim $tab --ignore-err $plinkseq_okay_err > !{output,,projectt_plinkseq_extra_istats_file} 
 
prop no_coverage=scalar default 1

!|expand:,:projectt,projecte,extrarunif,shortt:project,,run_if !num_samp_subsets,:project_sample_subset,_project_sample_subset,,short| \
shortt cmd make_plinkseq_extra_istats_fileprojecte=$make_plinkseq_extra_istats_helperprojecte(--exec "$smart_cut_cmd --in-delim $coverage_dat_delim --out-delim $tab --select-col 1\,1 --select-col 1\,1\,$frac_above_threshold !{input\,--file\,project_sample_coverage_dat_file} | sed '1 s/$frac_above_threshold/PCT_BASES_${threshold}x/'" --extra 14) class_level projectt skip_if no_coverage extrarunif

!!expand:,:projectt,projecte,extrarunif,shortt:project,,skip_if num_samp_subsets,:project_sample_subset,_project_sample_subset,,short! \
shortt cmd make_plinkseq_extra_istats_no_cov_fileprojecte=$make_plinkseq_extra_istats_helperprojecte() class_level projectt run_if no_coverage extrarunif

#to combine all of the istats files
!|expand:;:itype;exskipif\
:plinkseq_het_file;\
:plinkseq_low_het_file;\
:plinkseq_high_het_file;\
:plinkseq_sexcheck_file;\
:plinkseq_raw_all_istats_file;\
:plinkseq_qc_pass_all_istats_file;\
:plinkseq_qc_plus_all_istats_file;skip_if and,!sample_qc_filter,!var_qc_filter,!project_variant_custom_exclude_file,!project_sample_custom_exclude_file\
:plinkseq_raw_syn_istats_file;\
:plinkseq_qc_pass_syn_istats_file;\
:plinkseq_qc_plus_syn_istats_file;skip_if and,!sample_qc_filter,!var_qc_filter,!project_variant_custom_exclude_file,!project_sample_custom_exclude_file\
:plinkseq_raw_ns_istats_file;\
:plinkseq_qc_pass_ns_istats_file;\
:plinkseq_qc_plus_ns_istats_file;skip_if and,!sample_qc_filter,!var_qc_filter,!project_variant_custom_exclude_file,!project_sample_custom_exclude_file\
:plinkseq_raw_nonsense_istats_file;\
:plinkseq_qc_pass_nonsense_istats_file;\
:plinkseq_qc_plus_nonsense_istats_file;skip_if and,!sample_qc_filter,!var_qc_filter,!project_variant_custom_exclude_file,!project_sample_custom_exclude_file\
:plinkseq_raw_noncoding_istats_file;\
:plinkseq_qc_pass_noncoding_istats_file;\
:plinkseq_qc_plus_noncoding_istats_file;skip_if and,!sample_qc_filter,!var_qc_filter,!project_variant_custom_exclude_file,!project_sample_custom_exclude_file\
:plinkseq_qc_pass_sing_istats_file;\
:plinkseq_qc_plus_sing_istats_file;skip_if and,!sample_qc_filter,!var_qc_filter,!project_variant_custom_exclude_file,!project_sample_custom_exclude_file\
:plinkseq_qc_pass_doub_istats_file;\
:plinkseq_qc_pass_indel_istats_file;\
:plinkseq_qc_pass_multiallelic_istats_file;\
:plinkseq_qc_pass_snp_istats_file;\
:plinkseq_filtered_istats_file;\
:plinkseq_extra_istats_file;\
:sample_marker_mds_file;skip_if !parallelize_pca\
|\
local cmd make_cat_project_itype=rm -f !{output,,project_itype} && (head -qn+1 !{input,,project_sample_subset_itype,limit=1,sort_prop=project_sample_subset} | head -n1 && tail -qn+2 !{input,,project_sample_subset_itype,sort_prop=project_sample_subset}) > !{output,,project_itype} class_level project run_if num_samp_subsets exskipif

#These are costly to produce and big...so commenting out now
#!!expand:,:itype,ecol\
#:plinkseq_vmatrix_file,3\
#:plinkseq_gq_vmetamatrix_file,1\
#:plinkseq_dp_vmetamatrix_file,1\
#:plinkseq_ab_vmetamatrix_file,1\
#:plinkseq_sing_ab_vmetamatrix_file,1\
#:plinkseq_dp_qcfail_vmetamatrix_file,1\
#:plinkseq_qcfail_vmatrix_file,3\
#!\
#short cmd make_paste_project_itype=$smart_cut_cmd --in-delim $tab !{input,--file,project_sample_subset_itype} --paste --exclude-col .,1-ecol | $smart_cut_cmd --in-delim $tab !{input,--file,project_sample_subset_itype,limit=1} --select-col 1,1 --paste > !{output,,project_itype} class_level project run_if num_samp_subsets


#istats no longer dumps this by default
add_pct_dbsnp_cmd=$add_function_cmd --col1 DBSNP --col2 $nalt --type divide --header 1 --in-delim @1 --val-header PCT_DBSNP

local cmd make_project_sstats_file=$smart_join_cmd --exec "$smart_cut_cmd --in-delim $tab !{input,--file,project_plinkseq_qc_pass_all_istats_file} --exclude-col 1,1,PASS --exclude-col 1,1,SING --exclude-col 1,1,TITV" --exec "$smart_cut_cmd --in-delim $tab !{input,--file,project_plinkseq_qc_pass_snp_istats_file} --select-col 1,1 --select-col 1,1,TITV" --exec "cat !{input,,project_plinkseq_raw_all_istats_file} | $add_function_cmd --header 1 --in-delim $tab --type subtract  --col1 NMIN --col2 PASS --val-header QCFAIL | $add_function_cmd --header 1 --in-delim $tab --type divide  --col1 PASS --col2 NMIN --val-header FRAC_PASS | $smart_cut_cmd --in-delim $tab --select-col 0,1 --select-col 0,1,QCFAIL --select-col 0,1,'^FRAC_PASS$'" --exec "$smart_cut_cmd --in-delim $tab !{input,--file,project_plinkseq_qc_pass_sing_istats_file} --select-col 1,1 --select-col 1,1,NMIN --select-col 1,1,PASS_S --exact | $add_function_cmd --header 1 --in-delim $tab --type subtract  --col1 NMIN --col2 PASS_S --val-header QCFAIL_SING | $smart_cut_cmd --in-delim $tab --select-col 0,1 --select-col 0,1,NMIN --select-col 0,1,QCFAIL_SING --exclude-row 0,1 --exact | sed '1 s/^/ID\tSING\tQCFAIL_SING\n/'" --exec "$smart_cut_cmd --in-delim $tab !{input,--file,project_plinkseq_qc_pass_doub_istats_file} --select-col 1,1 --select-col 1,1,NMIN --exclude-row 1,1 | sed '1 s/^/ID\tDOUB\n/'" --exec "$smart_cut_cmd --in-delim $tab !{input,--file,project_plinkseq_qc_pass_snp_istats_file} --select-col 1,1 --select-col 1,1,NMIN --exclude-row 1,1 | sed '1 s/^/ID\tSNP\n/'" --exec "$smart_cut_cmd --in-delim $tab !{input,--file,project_plinkseq_qc_pass_indel_istats_file} --select-col 1,1 --select-col 1,1,NMIN --exclude-row 1,1 | sed '1 s/^/ID\tINDEL\n/'" --exec "$smart_cut_cmd --in-delim $tab !{input,--file,project_plinkseq_qc_pass_multiallelic_istats_file} --select-col 1,1 --select-col 1,1,NMIN --exclude-row 1,1 | sed '1 s/^/ID\tMULTI\n/'"  !{input,--file,project_plinkseq_extra_istats_file}  !{input,--file,project_extra_sample_info_file,if_prop=project_extra_sample_info_file,allow_empty=1} !{raw,,project,--fill 9,if_prop=project_extra_sample_info_file,allow_empty=1} !{input,--file,marker_sample_full_concordance_file,if_prop=is_fingerprint,allow_empty=1} !{raw,--exec,project,"$smart_join_cmd --in-delim $tab --exec \"sort -u *project_sample_custom_exclude_file | sed 's/$/\t1/'\" --exec \"cut -f1 *project_plinkseq_qc_pass_all_istats_file | sed 's/$/\t0/'\" --merge --in-delim $tab | sed '1 s/^/ID\t$custom_exclude_header\n/'",if_prop=project_sample_custom_exclude_file,allow_empty=1} !{input,project_sample_custom_exclude_file,if_prop=project_sample_custom_exclude_file,allow_empty=1}  --rest-extra 1 --header 1 --comment \\# --in-delim $tab --out-delim , | $add_function_cmd --header 1 --in-delim , --type subtract  --col1 NMIN --col2 NHET --val-header NHOM | $add_function_cmd --header 1 --in-delim , --type divide --col1 NHET --col2 NHOM --val-header HET_HOM > !{output,,project_sstats_file} class_level project

#use for sample or variant QC (stratification)
prop qc_trait=scalar

#use for stratifying maf
prop maf_strata_trait=scalar

#summary to use for marker frequency filters
prop marker_strat_maf_summary=scalar

#more detailed variant QC
#must specify qc_trait if want to be pulled into vstats file
prop qc_strata_trait=scalar

#compute popgen stats for the qc_strata_trait (more detailed metrics)
prop compute_popgen=scalar

#list of phenotypes to stratify on (for p_missing)
#that is, make this is qc_pheno_strata_trait as well
prop pheno_stratas=list

#for a specific pheno_variant_qc_pheno_strata instance, the phenotype to stratify on
#auto populated by pipeline
prop pheno_strata=scalar


local cmd make_project_traits_file=$smart_join_cmd !{raw,--exec,pheno,"$smart_cut_cmd --file *pheno_all_sample_info_file --in-delim $tab --select-col 1\,1\,'ID @pheno'",if_prop=qc_trait} --in-delim $tab --header 1 !{input,pheno_all_sample_info_file,if_prop=qc_trait} | sed '1 s/^\#//' > !{output,,project_traits_file} class_level project with sample_qc_filter

local cmd make_project_sample_outlier_file=$write_outlier_table_cmd !{input,,project_sstats_file} !{output,,project_sample_outlier_file} -ID ID sep=, out.sep=, class_level project

sstats_pdf_helper=$draw_box_plot_cmd(!{input\,\,project_sstats_file} !{output\,\,@1} '@3' '' 'Sample Values' -1\,NVAR sep=\, @2 max.plot.points=$max_sstats_points max.highlighted.points=$max_sstats_highlighted_points)
sample_highlight_columns_int=highlight.id.col=1 highlight.sep=,
sample_highlight_columns=$sample_highlight_columns_int highlight.label.col=2
sample_highlight_info=id.col=1 highlight.list.file=!{input,,project_sample_exclude_detail_file} $sample_highlight_columns
extreme_quantile=.01

short cmd make_project_sstats_initial_pdf_file=$sstats_pdf_helper(project_sstats_initial_pdf_file, ,Sample QC Properties) class_level project
short cmd make_project_sstats_highlighted_pdf_file=$sstats_pdf_helper(project_sstats_highlighted_pdf_file, $sample_highlight_info ,Sample Outliers) class_level project

!!expand:,:projecttype,phenotype:initial,all:highlighted,highlighted:final,filtered! \
local cmd make_project_pheno_sstats_projecttype_ps_file=$smart_cut_cmd $mpjhf(pheno,pheno_phenotype_sstats_pdf_file,if_prop=qc_trait) > !{output,,project_pheno_sstats_projecttype_ps_file} class_level project with pheno

!!expand:type:initial:highlighted:final! \
local cmd make_project_pheno_sstats_type_pdf_file=epstopdf !{input,,project_pheno_sstats_type_ps_file} !{output,--outfile=,project_pheno_sstats_type_pdf_file} class_level project with pheno

short cmd make_project_sstats_final_pdf_file=$sstats_pdf_helper(project_sstats_final_pdf_file, $sample_highlight_info exclude.highlighted=TRUE ,QC+ Sample Properties) class_level project
short cmd make_project_sstats_extreme_pdf_file=$sstats_pdf_helper(project_sstats_extreme_pdf_file, $sample_highlight_info exclude.highlighted=TRUE extreme.highlight.col="$all_extreme_highlight_cols" extreme.quantile=$extreme_quantile ,QC+ Sample Properties) class_level project

get_filtered_cols=`$smart_cut_cmd !{input,--file,project_sample_exclude_detail_file} --in-delim , --select-col 1,1,MEASURE --exclude-row 1,1 | sort -u | tr '\n' '\,' | sed 's/\,\$//' | sed 's/^\(.\)/,\1/'`

prop major_sstats_cols=list
default_major_sstats_cols=$default_major_sstats_cols_no_coverage,PCT_BASES_${threshold}x
default_major_sstats_cols_no_coverage=NMIN,SING,HET,HET_HOM,RATE,MEAN_AB,QCFAIL
additional_major_sstats_cols=!{raw,,marker,\,@disp,uc=1,if_prop=is_fingerprint,sep=,allow_empty=1}
all_major_sstats_cols=!{prop,,project,major_sstats_cols,missing_key=default_major_sstats_cols,sep=\,,unless_prop=no_coverage,allow_empty=1}!{prop,,project,major_sstats_cols,missing_key=default_major_sstats_cols_no_coverage,sep=\,,if_prop=no_coverage,allow_empty=1}$additional_major_sstats_cols

prop extreme_highlight_cols=list
all_extreme_highlight_cols=!{prop,,project,extreme_highlight_cols,missing_key=default_major_sstats_cols_no_coverage,sep=\,}


max_sstats_points=1000
max_sstats_highlighted_points=200


slide_sstats_pdf_helper=$draw_box_plot_cmd(!{input\,\,project_sstats_file} !{output\,\,@1} '@3' '' 'Sample Values' "$all_major_sstats_cols$get_filtered_cols" sep=\,@2 max.plot.points=$max_sstats_points max.highlighted.points=$max_sstats_highlighted_points)

slide_vcounts_num_name=Num
slide_vcounts_cut_vcounts_helper=$smart_cut_cmd !{input,--file,@1} --and-row-all --exact --select-row 1,1,@2 --out-delim $tab --require-col-match  | sed 's/@2/$slide_vcounts_num_name @3/'

slide_vcounts_convert_stats_summary_helper=$smart_cut_cmd --in-delim $tab --select-col 0,1,$summary_mean(@1) --select-col 0,1,$summary_dev(@1) --exclude-row 0,1 --require-col-match | $format_columns_cmd --in-delim $tab --number-format @3 --commify 1 --commify 2 | sed 's/\t/ \\$\\\\\\pm\\$ /' | sed 's/^/$slide_vcounts_num_name @2\t/'

slide_vcounts_sum_istats_helper=$table_sum_stats_cmd --summaries --has-header --col @2 --in-delim $tab --out-delim $tab --print-header < !{input,,@1} | $slide_vcounts_convert_stats_summary_helper(@2,@3,@4)
slide_vcounts_sum_istats_helper_int=$slide_vcounts_sum_istats_helper(@1,@2,@3,%.1f)

dbsnp_per_sample_helper=$add_pct_dbsnp_cmd($tab) < !{input,,@1} | $table_sum_stats_cmd --summaries --has-header --col PCT_DBSNP --in-delim $tab --out-delim $tab --print-header | $slide_vcounts_convert_stats_summary_helper(PCT_DBSNP,% dbSNP,%.1f --percentage 1 --percentage 2) | sed 's/^Num\s*//'

#dbsnp fraction now not in pseq anymore
#			 --exec \"$smart_cut_cmd !{input,--file,project_qc_pass_all_vcounts_file} --select-row 1,1,^db[Ss][Nn][Pp].\*PCT$ --and-row-all --select-row 1,2,ALL --exclude-col 1,2 --out-delim $tab | $format_columns_cmd --in-delim $tab --number-format %.1f --percentage 2 | sed 's/db[Ss][Nn][Pp].\*PCT/% dbSNP/'\" \
#			 --exec \"$dbsnp_per_sample_helper(project_plinkseq_qc_pass_all_istats_file)\" \


local cmd make_project_slide_vcounts_tex_file=$smart_cut_cmd \
--exec \
 "$smart_cut_cmd --in-delim $tab --out-delim $tab \
 --exec \"$slide_vcounts_cut_vcounts_helper(project_qc_pass_all_vcounts_file,NVAR,all)\" \
 --exec \"$slide_vcounts_cut_vcounts_helper(project_qc_pass_ns_vcounts_file,NVAR,missense)\" \
 --exec \"$slide_vcounts_cut_vcounts_helper(project_qc_pass_nonsense_vcounts_file,NVAR,nonsense)\" \
 --exec \"$slide_vcounts_cut_vcounts_helper(project_qc_pass_syn_vcounts_file,NVAR,synonymous)\" \
 --exec \"$slide_vcounts_cut_vcounts_helper(project_qc_pass_noncoding_vcounts_file,NVAR,noncoding)\" \
 --exec \"$slide_vcounts_cut_vcounts_helper(project_qc_pass_all_vcounts_file,SING,singletons)\" \
 " \
--exec \
 "$smart_cut_cmd --in-delim $tab --out-delim $tab \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_qc_pass_all_istats_file,NMIN,all)\" \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_qc_pass_ns_istats_file,NMIN,missense)\" \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_qc_pass_nonsense_istats_file,NMIN,nonsense)\" \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_qc_pass_syn_istats_file,NMIN,synonymous)\" \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_qc_pass_noncoding_istats_file,NMIN,noncoding)\" \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_qc_pass_sing_istats_file,NMIN,singletons)\" \
 | $smart_cut_cmd --in-delim $tab --exclude-col 0,1 " \
--paste --in-delim $tab --out-delim $tab  \
| $format_columns_cmd --in-delim $tab --commify 2 | sed '1 s/^/Variant Class\tQC Pass Sites\tPer Sample\n/' | $table_to_beamer_cmd --in-delim $tab --header-cols 1 --header-rows 1 --title "Variant counts"  > !{output,,project_slide_vcounts_tex_file} class_level project

local cmd make_project_slide_vcounts_pdf_file=$run_latex_cmd(project_slide_vcounts_tex_file,project_slide_vcounts_pdf_file) class_level project


slide_var_pass_counts_helper=$smart_cut_cmd !{input,--file,@1} --and-row-all --exact --select-row 1,1,@2 --out-delim $tab | sed 's/@2/$slide_vcounts_num_name @3/'

#slide_var_pass_raw_counts_helper=$pseq_analysis_cmd v-stats @1 | $slide_var_pass_counts_helper(@2,@3)
#slide_var_pass_qc_pass_counts_helper=$pseq_qc_pass_analysis_cmd(v-stats) @1 | $slide_var_pass_counts_helper(@2,@3)
#slide_var_pass_clean_counts_helper=$pseq_qc_plus_analysis_cmd(v-stats) @1 | $slide_var_pass_counts_helper(@2,@3)

local cmd make_project_slide_var_pass_counts_tex_file=$smart_cut_cmd \
--exec \
 "$smart_cut_cmd --in-delim $tab --out-delim $tab \
 --exec \"$slide_var_pass_counts_helper(project_raw_all_vcounts_file,NVAR,all)\" \
 --exec \"$slide_var_pass_counts_helper(project_raw_ns_vcounts_file,NVAR,missense)\" \
 --exec \"$slide_var_pass_counts_helper(project_raw_nonsense_vcounts_file,NVAR,nonsense)\" \
 --exec \"$slide_var_pass_counts_helper(project_raw_syn_vcounts_file,NVAR,synonymous)\" \
 --exec \"$slide_var_pass_counts_helper(project_raw_noncoding_vcounts_file,NVAR,noncoding)\" \
 --exec \"$slide_var_pass_counts_helper(project_raw_all_vcounts_file,SING,singletons)\" \
 " \
--exec \
 "$smart_cut_cmd --in-delim $tab --out-delim $tab \
 --exec \"$slide_var_pass_counts_helper(project_qc_pass_all_vcounts_file,NVAR,all)\" \
 --exec \"$slide_var_pass_counts_helper(project_qc_pass_ns_vcounts_file,NVAR,missense)\" \
 --exec \"$slide_var_pass_counts_helper(project_qc_pass_nonsense_vcounts_file,NVAR,nonsense)\" \
 --exec \"$slide_var_pass_counts_helper(project_qc_pass_syn_vcounts_file,NVAR,synonymous)\" \
 --exec \"$slide_var_pass_counts_helper(project_qc_pass_noncoding_vcounts_file,NVAR,noncoding)\" \
 --exec \"$slide_var_pass_counts_helper(project_qc_pass_all_vcounts_file,SING,singletons)\" \
  | $smart_cut_cmd --in-delim $tab --exclude-col 0,1 \
 " \
--exec \
 "$smart_cut_cmd --in-delim $tab --out-delim $tab \
 --exec \"$slide_var_pass_counts_helper(project_qc_plus_all_vcounts_file,NVAR,all)\" \
 --exec \"$slide_var_pass_counts_helper(project_qc_plus_ns_vcounts_file,NVAR,missense)\" \
 --exec \"$slide_var_pass_counts_helper(project_qc_plus_nonsense_vcounts_file,NVAR,nonsense)\" \
 --exec \"$slide_var_pass_counts_helper(project_qc_plus_syn_vcounts_file,NVAR,synonymous)\" \
 --exec \"$slide_var_pass_counts_helper(project_qc_plus_noncoding_vcounts_file,NVAR,noncoding)\" \
 --exec \"$slide_var_pass_counts_helper(project_qc_plus_all_vcounts_file,SING,singletons)\" \
  | $smart_cut_cmd --in-delim $tab --exclude-col 0,1 \
 " \
--paste --in-delim $tab --out-delim $tab  \
| $format_columns_cmd --in-delim $tab --commify 2 --commify 3 --commify 4 | sed '1 s/^/Variant Class\tRaw\tQC Pass\tQC+\n/' | $table_to_beamer_cmd --in-delim $tab --header-cols 1 --header-rows 1 --title "Variant counts by filtration level"  > !{output,,project_slide_var_pass_counts_tex_file} class_level project

local cmd make_project_slide_var_pass_counts_pdf_file=$run_latex_cmd(project_slide_var_pass_counts_tex_file,project_slide_var_pass_counts_pdf_file) class_level project


#dbsnp for now is defunct
#			 --exec \"$dbsnp_per_sample_helper(project_plinkseq_raw_all_istats_file)\" " \


#right now not computing SINGLETONS for RAW
#because when we do this at sample subset level, need count information project wide
#and don't have this for raw because no plink project built for raw

local cmd make_project_slide_sample_var_pass_counts_tex_file=$smart_cut_cmd \
--exec \
 "$smart_cut_cmd --in-delim $tab --out-delim $tab \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_raw_all_istats_file,NMIN,all)\" \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_raw_ns_istats_file,NMIN,missense)\" \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_raw_nonsense_istats_file,NMIN,nonsense)\" \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_raw_syn_istats_file,NMIN,synonymous)\" \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_raw_noncoding_istats_file,NMIN,noncoding)\" \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_raw_all_istats_file,SING,singletons) | sed 's/\t..*/\tNA/'\" " \
--exec \
 "$smart_cut_cmd --in-delim $tab --out-delim $tab \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_qc_pass_all_istats_file,NMIN,all)\" \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_qc_pass_ns_istats_file,NMIN,missense)\" \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_qc_pass_nonsense_istats_file,NMIN,nonsense)\" \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_qc_pass_syn_istats_file,NMIN,synonymous)\" \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_qc_pass_noncoding_istats_file,NMIN,noncoding)\" \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_qc_pass_sing_istats_file,NMIN,singletons)\" \
 | $smart_cut_cmd --in-delim $tab --exclude-col 0,1 " \
--exec \
 "$smart_cut_cmd --in-delim $tab --out-delim $tab \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_qc_plus_all_istats_file,NMIN,all)\" \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_qc_plus_ns_istats_file,NMIN,missense)\" \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_qc_plus_nonsense_istats_file,NMIN,nonsense)\" \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_qc_plus_syn_istats_file,NMIN,synonymous)\" \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_qc_plus_noncoding_istats_file,NMIN,noncoding)\" \
 --exec \"$slide_vcounts_sum_istats_helper_int(project_plinkseq_qc_plus_sing_istats_file,NMIN,singletons)\" \
 | $smart_cut_cmd --in-delim $tab --exclude-col 0,1 " \
--paste --in-delim $tab --out-delim $tab  \
| sed '1 s/^/Variant Class\tRaw\tQC Pass\tQC +\n/' | $table_to_beamer_cmd --font-size 8pt --in-delim $tab --header-cols 1 --header-rows 1 --title "Variant counts per sample by filtration level"  > !{output,,project_slide_sample_var_pass_counts_tex_file} class_level project

local cmd make_project_slide_sample_var_pass_counts_pdf_file=$run_latex_cmd(project_slide_sample_var_pass_counts_tex_file,project_slide_sample_var_pass_counts_pdf_file) class_level project


no_jexl_name=none
tex_degenerate_selection='$no_jexl_name:$two_fold_degenerate_name:$four_fold_degenerate_name:$non_degenerate_name'
project_slide_titv_helper=$smart_cut_cmd !{input,--file,project_titv_eval_file} --in-delim , --vec-delim : --select-row 1,1,JexlExpression,$tex_degenerate_selection --select-row 1,1 --select-col 1,1,JexlExpression --select-col 1,1,'^tiTvRatio$' --select-col 1,1,Novelty | $smart_cut_cmd --in-delim , --select-row 0,1,Novelty,@1 --select-row 0,1 --exclude-col 0,1,Novelty --exclude-row 0,1

#local cmd make_project_slide_titv_tex_file=$smart_join_cmd \
#--exec "perl -e 'print \"none,1\n$non_degenerate_name,2\n$two_fold_degenerate_name,3\n$four_fold_degenerate_name,4\n\"'" \
#--exec "$project_slide_titv_helper(all)" \
#--exec "$project_slide_titv_helper(known)" \
#--exec "$project_slide_titv_helper(novel)" \
#--arg-delim : --in-delim , --out-delim , | sort -t, -nk2 | $smart_cut_cmd --in-delim , --exclude-col 0,2 | sed 's/^none/All/' | sed '1 s/^/QC Pass Variants,All Sites,Known Sites,Novel Sites\n/' | $format_columns_cmd --in-delim , --number-format %.3f | $table_to_beamer_cmd --in-delim , --header-rows 1 --header-cols 1 --title "Ti/Tv ratios" > !{output,,project_slide_titv_tex_file} class_level project

local cmd make_project_slide_titv_pdf_file=$run_latex_cmd(project_slide_titv_tex_file,project_slide_titv_pdf_file) class_level project


project_slide_theta_helper=$smart_cut_cmd !{input,--file,project_theta_eval_file} --in-delim , --vec-delim : --select-row 1,1,JexlExpression,$tex_degenerate_selection --select-row 1,1 --select-col 1,1,JexlExpression --select-col 1,1,'^totalHet:^thetaRegionNumSites$' --select-col 1,1,Novelty | $smart_cut_cmd --in-delim , --select-row 0,1,Novelty,all --select-row 0,1 --exclude-col 0,1,Novelty 

perl_get_target_length=`cat !{input,,project_target_length_file} | sed 's/\n//'`
perl_get_num_with_degeneracy=$perl_get_target_length \* `perl $targeted_bin_dir/get_fraction_with_degeneracy.pl @1`


#local cmd make_project_slide_theta_tex_file=$smart_join_cmd \
#--exec "perl -e 'print \"type,order\nnone,1\n$non_degenerate_name,2\n$two_fold_degenerate_name,3\n$four_fold_degenerate_name,4\n\"'" \
#--exec "$project_slide_theta_helper" \
#--exec "perl -e 'print \"type,num_bases\nnone,\" . $perl_get_target_length . \"\n$non_degenerate_name,\" . $perl_get_num_with_degeneracy(1) . \"\n$two_fold_degenerate_name,\" . ($perl_get_num_with_degeneracy(2) + $perl_get_num_with_degeneracy(3)) . \"\n$four_fold_degenerate_name,\" . $perl_get_num_with_degeneracy(4) . \"\n\"'" \
#--arg-delim : --in-delim , --out-delim , --header 1 | sort -t, -nk2 | $smart_cut_cmd --in-delim , --exclude-col 0,2 | sed 's/^none/All/' | $add_function_cmd --in-delim , --col1 totalHet --col2 num_bases --type divide --header 1 --val-header pi | $add_function_cmd --in-delim , --col1 thetaRegionNumSites --col2 num_bases --type divide --header 1 --val-header theta | $smart_cut_cmd --in-delim , --select-col 0,1 --select-col 0,1,^pi$ --select-col 0,1,^theta$ | sed '1 s/type/QC Pass Variants/' | sed '1 s/pi/\$\\pi\$/' | sed '1 s/theta/\$\\theta\$/' | awk -v OFS=, -F, '{print \$1,\$3,\$2}' | $format_columns_cmd --in-delim , --number-format %.2e | $table_to_beamer_cmd --in-delim , --header-rows 1 --header-cols 1 --title "Estimates of population level mutation rate" > !{output,,project_slide_theta_tex_file} class_level project

local cmd make_project_slide_theta_pdf_file=$run_latex_cmd(project_slide_theta_tex_file,project_slide_theta_pdf_file) class_level project


local cmd make_project_slide_ref_theta_tex_file=perl -e 'print "Cargill et. al. Variants\t\\$\\theta (\\times 10^{-4})\\$\t\\$\\pi (\\times 10^{-4})\\$\nAll\t5.43\\$\\pm\\$1.36\t5.00\\$\\pm\\$2.38\n$non_degenerate_name\t3.66\\$\\pm\\$0.92\t2.93\\$\\pm\\$1.39\n$two_fold_degenerate_name\t6.85\\$\\pm\\$1.72\t6.27\\$\\pm\\$2.98\n$four_fold_degenerate_name\t9.73\\$\\pm\\$2.46\t11.18\\$\\pm\\$5.31\n"' | $table_to_beamer_cmd --in-delim $tab --header-rows 1 --header-cols 1 --title "Reference estimate of population level mutation rate" > !{output,,project_slide_ref_theta_tex_file} class_level project

local cmd make_project_slide_ref_theta_pdf_file=$run_latex_cmd(project_slide_ref_theta_tex_file,project_slide_ref_theta_pdf_file) class_level project


slide_failures_helper=`cat !{input,,@1} | wc -l` # !{input,,@1} | awk '\''{print \\$1}'\''`
local cmd make_project_slide_failures_tex_file=perl -e '\$failed = $slide_failures_helper(project_failed_sample_list_file); chomp(\$failed); \$passed = $slide_failures_helper(project_passed_sample_list_file); chomp(\$failed); chomp(\$passed); \$qc_fail = $slide_failures_helper(project_sample_seq_exclude_file); chomp(\$qc_fail); \$qc_pass = \$passed - \$qc_fail; chomp(\$passed); \$tot = \$passed + \$failed; \$pct_passed = \$passed / \$tot; \$pct_failed = \$failed / \$tot; \$pct_qc_fail = \$qc_fail / \$tot; \$pct_qc_pass = \$qc_pass / \$tot; print "$total_status_long\t\$tot\t\n$failed_status_long\t\$failed\t\$pct_failed\n$passed_status_long\t\$passed\t\$pct_passed\n$qc_fail_status_long\t\$qc_fail\t\$pct_qc_fail\n$qc_pass_status_long\t\$qc_pass\t\$pct_qc_pass\n"' | $format_columns_cmd --in-delim $tab --out-delim $tab --percentage 3 --number-format 2,%d --number-format 3,%.1f | sed '1! s/\t\(\S*\)$/ (\1)/' | sed '1 s/\t$//' | sed '1 s/^/Samples...\tNumber\n/' | $table_to_beamer_cmd --in-delim $tab --header-rows 1 --header-cols 1 --title "Project wide sample status" > !{output,,project_slide_failures_tex_file} class_level project

local cmd make_project_slide_failures_pdf_file=$run_latex_cmd(project_slide_failures_tex_file,project_slide_failures_pdf_file) class_level project

qc_failures_dummy_col=VALUE

!+expand:;:classlevel;type;extratitle;input_cmd;input_file;extra_run_if:\
pheno;popgen; -- !{prop,,pheno,disp};--exec \"sed '1 s/$/\,$qc_failures_dummy_col/' !{input,,pheno_popgen_exclude_detail_file} | sed '1! s/$/\,0/'\";pheno_popgen_exclude_detail_file;:\
project;seq;;!{input,--file,project_sample_exclude_detail_file};project_sample_exclude_detail_file;+ \
local cmd make_classlevel_slide_type_qc_failures_tex_file=$smart_cut_cmd --exec "$smart_cut_cmd --in-delim , input_cmd --select-col 1,1-3 | $table_sum_stats_cmd --in-delim , --has-header --group-col MEASURE --col $qc_failures_dummy_col --totals --print-header" --exec "tail -n+2 !{input,,input_file} | cut -d, -f1 | sort -u | wc -l | sed 's/^/Total,/'" --select-col 1,1 --select-col 1,1,$summary_num(${qc_failures_dummy_col}) --in-delim , --exclude-row 1,1 | $add_header_cmd "Metric,Samples Removed" | $table_to_beamer_cmd --in-delim , --header-rows 1 --footer-rows 1 --auto-dim --title "Sample QC statisticsextratitle" > !{output,,classlevel_slide_type_qc_failures_tex_file} class_level classlevel extra_run_if

!|expand:;:classlevel;type;extra_run_if:project;seq;:pheno;popgen;skip_if not_trait| \
local cmd make_classlevel_slide_type_qc_failures_pdf_file=$run_latex_cmd(classlevel_slide_type_qc_failures_tex_file,classlevel_slide_type_qc_failures_pdf_file) class_level classlevel extra_run_if

local cmd make_project_slide_var_qc_failures_tex_file=$smart_cut_cmd --exec "cat !{input,,project_variant_exclude_detail_file} | $table_sum_stats_cmd --in-delim $vstats_delim --has-header --group-col MEASURE --col $qc_failures_dummy_col --totals --print-header" --exec "cat !{input,,project_variant_exclude_file} | wc -l | sed 's/^/Total,/'" --select-col 1,1 --select-col 1,1,$summary_num(${qc_failures_dummy_col}) --in-delim , --exclude-row 1,1 --out-delim $tab | $format_columns_cmd --in-delim $tab --commify 2 | sed '1 s/^/Metric\tVariants Removed\n/' | $table_to_beamer_cmd --in-delim $tab --header-rows 1 --footer-rows 1 --title "Variant QC statistics" > !{output,,project_slide_var_qc_failures_tex_file} class_level project
local cmd make_project_slide_var_qc_failures_pdf_file=$run_latex_cmd(project_slide_var_qc_failures_tex_file,project_slide_var_qc_failures_pdf_file) class_level project

slide_genes_helper_above=$slide_genes_helper(@1,@2,${threshold_num_above}@1,${threshold_frac_above}@1,@3,@4)
slide_genes_helper_lte=$slide_genes_helper(@1,@2,${threshold_num_lte}@1,${threshold_frac_lte}@1,@3,@4)

slide_genes_helper=$table_sum_stats_cmd --has-header --col $frac_above_threshold --in-delim , --print-header --summaries --group-col @5 < !{input,,project_@{6}_dist_coverage_dat_file} | $table_sum_stats_cmd --threshold @1 --label @2 --has-header --col $frac_above_threshold_mean --in-delim , --print-header | $smart_cut_cmd --in-delim , --exclude-row 0,1 --select-col 0,1 --select-col 0,1,@3 --select-col 0,1,@4

!!expand:,:type,Type,group_col:gene,Gene,1:exon,Exon,1 --group-col 2:bait,Bait,1! \
local cmd make_project_slide_types_tex_file=$smart_cut_cmd --in-delim , --exec "$slide_genes_helper_above(.99,latex_gt99%,group_col,type)" --exec "$slide_genes_helper_above(.95,latex_gt95%,group_col,type)" --exec "$slide_genes_helper_above(.8,latex_gt80%,group_col,type)" --exec "$slide_genes_helper_above(.5,latex_gt50%,group_col,type)" --exec "$slide_genes_helper_above(.25,latex_gt25%,group_col,type)" --exec "$slide_genes_helper_lte(.25,latex_lt25%,group_col,type)" --exec "$slide_genes_helper_lte(.10,latex_lt10%,group_col,type)" --exec "$slide_genes_helper_lte(.05,latex_lt5%,group_col,type)" | sed 's/^latex_gt/\\$>\\$/' | sed 's/^latex_lt/\\$<\\$/' | sed 's/^\([^,]*\),/\1 bases \\$>\\$${threshold}x,/' | sed '1 s/^/Types with...,\\# types,\% types\n/' | $format_columns_cmd --in-delim , --commify 2 --number-format 3,%.1f --percentage 3 --out-delim $tab | $table_to_beamer_cmd --in-delim $tab --header-cols 1 --header-rows 1 --title "Type coverage statistics" > !{output,,project_slide_types_tex_file} class_level project

!!expand:type:gene:exon:bait! \
local cmd make_project_slide_types_pdf_file=$run_latex_cmd(project_slide_types_tex_file,project_slide_types_pdf_file) class_level project

short cmd make_project_slide_sstats_initial_pdf_file=$slide_sstats_pdf_helper(project_slide_sstats_initial_pdf_file, ,Sample QC Properties) class_level project
short cmd make_project_slide_sstats_highlighted_pdf_file=$slide_sstats_pdf_helper(project_slide_sstats_highlighted_pdf_file, $sample_highlight_info ,Sample Outliers) class_level project
short cmd make_project_slide_sstats_final_pdf_file=$slide_sstats_pdf_helper(project_slide_sstats_final_pdf_file, $sample_highlight_info exclude.highlighted=TRUE ,QC+ Sample Properties) class_level project
short cmd make_project_slide_sstats_extreme_pdf_file=$slide_sstats_pdf_helper(project_slide_sstats_extreme_pdf_file, $sample_highlight_info exclude.highlighted=TRUE extreme.highlight.col="$all_extreme_highlight_cols" extreme.quantile=$extreme_quantile ,QC+ Sample Properties) class_level project

exclude_outlier_raw=$smart_cut_cmd !{input,--file,@1} --select-row 1,1,MEASURE,@2 --select-row 1,1,@3,@4 --and-row-all --in-delim @5 --exact
exclude_outlier_iqr=$exclude_outlier_raw(@1,@2,IQR_DIST,@3,\,)

#properties for filtering
default_concordance_filter_type=VALUE
prop concordance_filter_type=scalar
default_concordance_filter_threshold=le:.8
prop concordance_filter_threshold=scalar

prop max_duplicate=scalar default .9
prop max_related=scalar default .2
#end properties for filtering

exclude_sample_outlier_iqr=$exclude_outlier_iqr(project_sample_outlier_file,@1,@2,\,)
exclude_sample_outlier=$exclude_outlier_raw(project_sample_outlier_file,@1,@2,@3,\,)

prop filter_trait=scalar
prop filter_trait_op=scalar
prop filter_trait_value=scalar

prop filter_metric=scalar
prop filter_metric_type=scalar
prop filter_metric_op=scalar
prop filter_metric_value=scalar

#only apply this as an extended filter (to marker file and to SV/burden tests that request it)
prop is_extended_filter=scalar
prop is_extended_strict_filter=scalar

prop modifier_filter_metric=scalar
#prop modifier_filter_metric_type=scalar
prop modifier_filter_metric_op=scalar
prop modifier_filter_metric_value=scalar

!!expand:whichlevel:sample:pheno! \
local cmd make_whichlevel_qc_filter_trait_exclude_file=$smart_cut_cmd --in-delim $tab !{input,--file,project_traits_file} --exclude-row 1,1 --select-row 1,1,!{prop,,whichlevel_qc_filter,filter_trait},!{prop,,whichlevel_qc_filter,filter_trait_op,missing=eq}:!{prop,,whichlevel_qc_filter,filter_trait_value} --select-col 1,1 --select-col 1,1,!{prop,,whichlevel_qc_filter,filter_trait} > !{output,,whichlevel_qc_filter_trait_exclude_file} class_level whichlevel_qc_filter run_if and,filter_trait,filter_trait_value

!!expand:,:whichlevel,whichexclude:sample,sample:pheno,popgen! \
local cmd make_whichlevel_qc_filter_metric_exclude_file=$exclude_whichexclude_outlier(!{prop\\,\\,whichlevel_qc_filter\\,filter_metric},!{prop\\,\\,whichlevel_qc_filter\\,filter_metric_type},!{prop\\,\\,whichlevel_qc_filter\\,filter_metric_op\\,missing=ge}:!{prop\\,\\,whichlevel_qc_filter\\,filter_metric_value\\,missing=1.5},\,) > !{output,,whichlevel_qc_filter_metric_exclude_file} class_level whichlevel_qc_filter run_if filter_metric

!!expand:whichlevel:sample:pheno! \
local cmd make_whichlevel_qc_filter_exclude_file=$smart_join_cmd --arg-delim : --in-delim , --out-delim , --exec "$smart_cut_cmd !{input,--file,whichlevel_qc_filter_trait_exclude_file} --in-delim $tab --select-col 1,1 | $smart_cut_cmd !{input,--file,whichlevel_qc_filter_metric_exclude_file} --in-delim ,  --select-col 1,1 | sort | uniq -d" !{input,--file,whichlevel_qc_filter_metric_exclude_file} --extra 2 > !{output,,whichlevel_qc_filter_exclude_file} class_level whichlevel_qc_filter run_if and,filter_trait,filter_trait_value

!!expand:whichlevel:sample:pheno! \
local cmd cp_whichlevel_qc_filter_exclude_file=cp !{input,,whichlevel_qc_filter_metric_exclude_file} !{output,,whichlevel_qc_filter_exclude_file} class_level whichlevel_qc_filter skip_if and,filter_trait,filter_trait_value

#add for pca mode: assume samples are disjoint, only use them to add for PCA
prop add_for_pca=scalar
#is fingerprint mode: assume samples have overlaps; compute concordance
prop is_fingerprint=scalar
local cmd make_marker_sample_exclude_detail_file=$exclude_sample_outlier(!{prop\\,\\,marker\\,disp\\,uc=1},!{prop\\,\\,marker\\,concordance_filter_type\\,missing_key=default_concordance_filter_type},!{prop\\,\\,marker\\,concordance_filter_threshold\\,missing_key=default_concordance_filter_threshold}) > !{output,,marker_sample_exclude_detail_file} class_level marker run_if is_fingerprint

local cmd make_project_sample_exclude_detail_file=\ 
  cat /dev/null !{input,,marker_sample_exclude_detail_file,if_prop=is_fingerprint,allow_empty=1}  \
	| $exclude_sample_outlier($custom_exclude_header,VALUE,eq:1) \
	!{raw,|,sample_qc_filter,cat - *sample_qc_filter_exclude_file,if_prop=sample_qc_filter,allow_empty=1} !{input,sample_qc_filter_exclude_file,if_prop=sample_qc_filter,allow_empty=1} \
	| sort -u | $smart_cut_cmd --file !{input,,project_sample_outlier_file} --select-row 1,1 > !{output,,project_sample_exclude_detail_file} class_level project

detail_to_exclude=cat @1 | cut -d, -f1  | tail -n+2 | sort -u

!!expand:,:type,input_exclude_detail_file,extra_run_if:seq,project_sample_exclude_detail_file,! \
local cmd make_project_sample_type_exclude_file=$detail_to_exclude("!{input,,input_exclude_detail_file}") > !{output,,project_sample_type_exclude_file} class_level project extra_run_if

local cmd make_project_sample_exclude_file=cat !{input,,project_sample_seq_exclude_file} | sort -u > !{output,,project_sample_exclude_file} class_level project

local cmd make_project_sample_include_file=sort !{input,,project_passed_sample_list_file} !{input,,project_sample_exclude_file} !{input,,project_sample_exclude_file} | uniq -u > !{output,,project_sample_include_file} class_level project

local cmd make_project_plink_sample_exclude_file=$sample_list_to_plink_sample_list("!{input,--file,project_sample_exclude_file}",0) > !{output,,project_plink_sample_exclude_file} class_level project

!!expand:,:projectt,projecte,skipif,shortt:project,,skip_if num_var_subsets,:project_variant_subset,_project_variant_subset,,short! \
!|expand;,;maskkey,varmask;all,;syn,--mask reg.req=@!{input::project_plinkseq_syn_reg_file};ns,--mask reg.req=@!{input::project_plinkseq_ns_reg_file};nonsense,--mask reg.req=@!{input::project_plinkseq_nonsense_reg_file};noncoding,--mask reg.ex=@!{input::project_plinkseq_coding_reg_file}| \
!!expand:;:tname;runif:raw;:qc_pass;:qc_plus;run_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file! \ 
shortt cmd make_projectt_tname_maskkey_vcounts_file=rm -f !{output,,projectt_tname_maskkey_vcounts_file} && $pseq_tname_analysis_cmdprojecte(v-stats) varmask > !{output,,projectt_tname_maskkey_vcounts_file}  class_level projectt runif skipif

!|expand:,:projectt,projecte,exrunif:project,,run_if !num_var_subsets:project_variant_subset,_project_variant_subset,| \
!!expand;,;maskkey;all;syn;ns;nonsense;noncoding! \
local cmd ln_projectt_qc_plus_maskkey_vcounts_file=rm -f !{output,,projectt_qc_plus_maskkey_vcounts_file} && ln -s !{input,,projectt_qc_pass_maskkey_vcounts_file} !{output,,projectt_qc_plus_maskkey_vcounts_file} class_level projectt skip_if or,sample_qc_filter,var_qc_filter,project_variant_custom_exclude_file,project_sample_custom_exclude_file exrunif

!!expand;,;maskkey,extrarunif;all,;syn,;ns,;nonsense,;noncoding,! \
!!expand:tname:raw:qc_pass:qc_plus! \ 
local cmd make_joined_tname_maskkey_vcounts_file=rm -f !{output,,project_tname_maskkey_vcounts_file} && $smart_join_cmd --out-delim $tab !{input,project_variant_subset_tname_maskkey_vcounts_file} !{raw::project_variant_subset:--exec "$smart_cut_cmd --file *project_variant_subset_tname_maskkey_vcounts_file --exclude-row 1,1,^FILTER"} | $transpose_cmd --in-delim $tab | $smart_cut_cmd --in-delim $tab --exact --require-col-match --select-col 0,1,'NVAR RATE MAC MAF SING MONO TITV TITV_S DP QUAL PASS PASS_S' | $bin_values_cmd --header 1 --min-per-bin -1 --in-delim $tab --num-col NVAR --sum-col NVAR --sum-col SING --sum-col MONO --sum-col DP --sum-col QUAL --mean-col RATE --mean-col MAC --mean-col MAF --mean-col TITV --mean-col TITV_S --mean-col PASS --mean-col PASS_S | $transpose_cmd --in-delim $tab > !{output,,project_tname_maskkey_vcounts_file} class_level project run_if num_var_subsets skip_if and,!sample_qc_filter,!var_qc_filter,!project_variant_custom_exclude_file,!project_sample_custom_exclude_file

low_freq_maf=0.05
rare_maf=0.005

prop one_annotation_per_variant=scalar default 1

!!expand:,:projectt,projecte,skipif,shortt:project,,skip_if num_var_subsets,:project_variant_subset,_project_variant_subset,,short! \
!!expand:tname:qc_plus! \ 
projectt_tname_annotated_pre_vcounts_helper=$smart_join_cmd --header 1 --col 3,2 --multiple 3 --in-delim $tab --exec "$smart_cut_cmd !{input,--file,projectt_full_var_annot_file} !{input,--file,projectt_plinkseq_tname_combined_frq_file} --select-col 1,1,$vep_id_annot --select-col 2,1,SNP --exclude-row 1-2,1 | sort | uniq -d | sed '1 s/^/ID\n/'"  --exec "$smart_cut_cmd --in-delim $tab !{input,--file,projectt_full_var_annot_file} --select-col 1,1,$vep_id_annot --select-col 1,1,$vep_consequence_annot --select-row 1,1,$vep_consequence_annot,ne:$annot_missing_field --exact --require-col-match" !{input,--file,@1} --exec "$table_sum_stats_cmd --in-delim $tab --has-header --print-header --out-delim $tab !{input,,projectt_plinkseq_tname_combined_strata_frq_file} --group-col SNP --col MAF --threshold 0 | $smart_cut_cmd --in-delim $tab --select-col 0,1 --select-col 0,1,'${threshold_num_above}0 ${threshold_num_equal}0' | awk -F\"\t\" -v OFS=\"\t\" 'NR == 1 {\\$2=\"One\";\\$3=\"Every\";\\$4=\"Some\"} NR > 1 {if (\\$3 == 0) {\\$3 = 1; \\$2 = 0; \\$4 = 0} else if (\\$2 == 1) {\\$2 = 1; \\$3 = 0; \\$4 = 0} else {\\$4 = 1; \\$2 = 0; \\$3 = 0;}} {print}'" --rest-extra 1 

!!expand:,:projectt,projecte,skipif,shortt:project,,skip_if num_var_subsets,:project_variant_subset,_project_variant_subset,,short! \
!!expand:tname:qc_plus! \ 
shortt cmd make_projectt_tname_annotated_all_pre_vcounts_file=$projectt_tname_annotated_pre_vcounts_helper(projectt_plinkseq_tname_combined_frq_file,,) | perl /home/unix/flannick/lap/projects/common/add_function.pl --in-delim '	' --header 1 --col1 MAF --col2 NCHROBS --round --type multiply --val-header MAC --add-at NCHROBS > !{output,,projectt_tname_annotated_all_pre_vcounts_file} class_level projectt skipif bsub_batch 20

!!expand:,:projectt,projecte,skipif,shortt:project,,skip_if num_var_subsets,:project_variant_subset,_project_variant_subset,,short! \
!!expand:tname:qc_plus! \ 
shortt cmd make_projectt_tname_annotated_strata_pre_vcounts_file=$projectt_tname_annotated_pre_vcounts_helper(projectt_plinkseq_tname_combined_strata_frq_file,CLST,--group-col CLST) > !{output,,projectt_tname_annotated_strata_pre_vcounts_file} class_level projectt skipif bsub_batch 20


!!expand:,:projectt,projecte,skipif,shortt:project,,skip_if num_var_subsets,:project_variant_subset,_project_variant_subset,,short! \
!!expand:tname:qc_plus! \ 
projectt_tname_annotated_vcounts_helper=awk -F"\t" -v OFS="\t" 'NR == 1 {for (i=1;i<=NF;i++) {m[\$i]=i}} NR > 1 {if (\$m["MAF"] == 0) {\$m["One"] = 0; \$m["Every"] = 0; \$m["Some"] = 0}  {\$m["One"] *= \$m["MAF"]; \$m["Some"] *= \$m["MAF"]; \$m["Every"] *= \$m["MAF"]}} {print}' | $smart_cut_cmd --in-delim $tab --select-col 0,1,'$vep_consequence_annot MAF One Some Every @2' --select-row 0,1 --select-row 0,1,MAF,gt:0 | awk -F"\t" -v OFS="\t" '{split(\$1,a,",")} NR == 1 {print "$vep_consequence_annot",\$0} NR > 1 {for (i=1;i<=!{raw,,projectt,1,if_prop=one_annotation_per_variant,allow_empty=1}!{raw,,projectt,n,unless_prop=one_annotation_per_variant,allow_empty=1};i++) { print a[i],\$0 }}' | cut -f1,3- | $table_sum_stats_cmd --in-delim $tab --has-header --out-delim $tab --group-col $vep_consequence_annot @3 --totals --threshold $low_freq_maf --threshold $rare_maf --threshold 0 --print-header --col MAF --col One --col Some --col Every | $smart_cut_cmd --in-delim $tab --exact --require-col-match --select-col 0,1,'$vep_consequence_annot MAF_${threshold_num_above}0 MAF_${threshold_num_above}${low_freq_maf} MAF_${threshold_num_lte}${low_freq_maf} MAF_${threshold_num_lte}${rare_maf} MAF_${threshold_num_lte}0 One_${threshold_num_above}0 One_${threshold_num_above}${low_freq_maf} One_${threshold_num_lte}${low_freq_maf} One_${threshold_num_lte}${rare_maf} One_${threshold_num_lte}0 Some_${threshold_num_above}0 Some_${threshold_num_above}${low_freq_maf} Some_${threshold_num_lte}${low_freq_maf} Some_${threshold_num_lte}${rare_maf} Some_${threshold_num_lte}0 Every_${threshold_num_above}0 Every_${threshold_num_above}${low_freq_maf} Every_${threshold_num_lte}${low_freq_maf} Every_${threshold_num_lte}${rare_maf} Every_${threshold_num_lte}0 @2' | awk -F"\t" -v OFS="\t" 'NR > 1 {\$4=\$4-\$5; \$5=\$5-\$6; \$9=\$9-\$10; \$10=\$10-\$11; \$14=\$14-\$15; \$15=\$15-\$16; \$19=\$19-\$20; \$20=\$20-\$21} {print}' | $smart_cut_cmd --in-delim $tab --exclude-col 0,1,'${threshold_num_lte}0$' | sed '1 s/${threshold_num_above}${low_freq_maf}/>${low_freq_maf}/g' | sed '1 s/${threshold_num_lte}${low_freq_maf}/${rare_maf}-${low_freq_maf}/g' | sed '1 s/${threshold_num_lte}${rare_maf}/<$rare_maf/g' | sed '1 s/MAF_/All_/g' | sed '1 s/${threshold_num_above}0/num/g' | $smart_cut_cmd --in-delim $tab --select-col 0,1,'$vep_consequence_annot CLST .' 

!!expand:,:projectt,projecte,skipif,shortt:project,,skip_if num_var_subsets,:project_variant_subset,_project_variant_subset,,short! \
!!expand:tname:qc_plus! \ 
shortt cmd make_projectt_tname_annotated_all_vcounts_file=cat !{input,,projectt_tname_annotated_all_pre_vcounts_file} | $projectt_tname_annotated_vcounts_helper(projectt_plinkseq_tname_combined_frq_file,,) > !{output,,projectt_tname_annotated_all_vcounts_file} class_level projectt skipif bsub_batch 20

!!expand:,:projectt,projecte,skipif,shortt:project,,skip_if num_var_subsets,:project_variant_subset,_project_variant_subset,,short! \
!!expand:tname:qc_plus! \ 
shortt cmd make_projectt_tname_annotated_strata_vcounts_file=cat !{input,,projectt_tname_annotated_strata_pre_vcounts_file} | $projectt_tname_annotated_vcounts_helper(projectt_plinkseq_tname_combined_strata_frq_file,CLST,--group-col CLST) > !{output,,projectt_tname_annotated_strata_vcounts_file} class_level projectt skipif bsub_batch 20

!|expand:;:tstrat;groupcol:all;:strata;!{raw,,project,--group-col CLST,if_prop=maf_strata_trait,allow_empty=1}| \ 
!!expand:tname:qc_plus! \ 
local cmd make_cat_project_tname_annotated_tstrat_vcounts_file=(head -n1 !{input,,project_variant_subset_tname_annotated_tstrat_vcounts_file,limit=1} && tail -qn+2 !{input,,project_variant_subset_tname_annotated_tstrat_vcounts_file}) | $table_sum_stats_cmd --in-delim $tab --has-header --out-delim $tab --group-col $vep_consequence_annot groupcol --totals --print-header `for f in All One Some Every; do for g in num '>${low_freq_maf}' '${rare_maf}-${low_freq_maf}' '<${rare_maf}'; do echo --col \${f}_\${g}; done; done`  | $smart_cut_cmd --in-delim $tab --select-col 0,1,'$vep_consequence_annot !{raw,,project,CLST,if_prop=maf_strata_trait,allow_empty=1} _tot$' | sed '1 s/_tot//g' > !{output,,project_tname_annotated_tstrat_vcounts_file} class_level project run_if num_var_subsets 

!!expand:,:projectt,projecte,skipif,shortt:project,,skip_if num_var_subsets,:project_variant_subset,_project_variant_subset,,short! \
!!expand:tname:qc_plus! \ 
projectt_tname_annotated_sample_vcounts_helper=awk -F"\t" -v OFS="\t" 'NR == 1 {for (i=1;i<=NF;i++) {m[\$i]=i}} NR > 1 {if (\$m["MAF"] == 0) {\$m["One"] = 0; \$m["Some"] = 0; \$m["Every"] = 0}  {\$m["One"] *= \$m["MAC"]; \$m["Some"] *= \$m["MAC"]; \$m["Every"] *= \$m["MAC"]}} NR == 1 {print \$0,">${low_freq_maf}","${rare_maf}-${low_freq_maf}","<${rare_maf}"} NR > 1 {if (\$m["MAF"] > 0 && \$m["MAF"] <= $rare_maf) {r=\$m["MAC"]} else {r=0} if (\$m["MAF"] > $rare_maf && \$m["MAF"] <= $low_freq_maf) {l=\$m["MAC"]} else {l=0} if (\$m["MAF"] > $low_freq_maf) {c=\$m["MAC"]} else {c=0} {print \$0,c,l,r}}' | $smart_cut_cmd --in-delim $tab --select-col 0,1,'$vep_consequence_annot ^N$ MAC One Some Every >${low_freq_maf} ${rare_maf}-${low_freq_maf} <${rare_maf} @2' --select-row 0,1 --select-row 0,1,MAF,gt:0 | awk -F"\t" -v OFS="\t" '{split(\$1,a,","); } NR == 1 {print "$vep_consequence_annot",\$0} NR > 1 {for (i=1;i<=!{raw,,projectt,1,if_prop=one_annotation_per_variant,allow_empty=1}!{raw,,projectt,n,unless_prop=one_annotation_per_variant,allow_empty=1};i++) { print a[i],\$0 }}' | cut -f1,3- | $table_sum_stats_cmd --in-delim $tab --has-header --out-delim $tab --group-col $vep_consequence_annot @3 --totals --summaries --print-header --col MAC --col One --col Some --col Every --col '>${low_freq_maf}' --col '${rare_maf}-${low_freq_maf}' --col '<${rare_maf}' --col N | $smart_cut_cmd --in-delim $tab --exact --require-col-match --select-col 0,1,'$vep_consequence_annot ^N_mean$ MAC_tot One_tot Some_tot Every_tot >${low_freq_maf}_tot ${rare_maf}-${low_freq_maf}_tot <${rare_maf}_tot @2' | awk -F"\t" -v OFS="\t" 'NR > 1 {for (i=3;i<=9;i++) {\$i /= \$2}} {print}' | sed '1 s/\(MAC\|One\|Some\|Every\|>${low_freq_maf}\|${rare_maf}-${low_freq_maf}\|<${rare_maf}\)_tot/\1_mean/g' | sed '1 s/MAC/All/' | $smart_cut_cmd --in-delim $tab --select-col 0,1,'$vep_consequence_annot CLST .' 

!!expand:,:projectt,projecte,skipif,shortt:project,,skip_if num_var_subsets,:project_variant_subset,_project_variant_subset,,short! \
!!expand:tname:qc_plus! \ 
shortt cmd make_projectt_tname_annotated_all_sample_vcounts_file=n=`cat !{input,,project_sample_include_file} | wc -l` && cat !{input,,projectt_tname_annotated_all_pre_vcounts_file} | sed '1 s/$/\tN/' | sed "1! s/$/\t\$n/" | $projectt_tname_annotated_sample_vcounts_helper(projectt_plinkseq_tname_combined_frq_file,,) > !{output,,projectt_tname_annotated_all_sample_vcounts_file} class_level projectt skipif bsub_batch 20

!!expand:,:projectt,projecte,skipif,shortt:project,,skip_if num_var_subsets,:project_variant_subset,_project_variant_subset,,short! \
!!expand:tname:qc_plus! \ 
shortt cmd make_projectt_tname_annotated_strata_sample_vcounts_file=$smart_join_cmd --in-delim $tab --header 1 --exec "$smart_cut_cmd --in-delim $tab !{input,--file,projectt_tname_annotated_strata_pre_vcounts_file} --select-col 1,1,'CLST .'" --exec "sort -u !{input;;pheno_plink_phe_file;if_prop=pheno:eq:@maf_strata_trait} | awk '{print \\$3}' | sort | uniq -c | awk -v OFS=\"\\t\" '{print \\$2,\\$1}' | sed '1 s/^/CLST\tN\n/'" --multiple 1 | $projectt_tname_annotated_sample_vcounts_helper(projectt_plinkseq_tname_combined_strata_frq_file,CLST,--group-col CLST) > !{output,,projectt_tname_annotated_strata_sample_vcounts_file} class_level projectt skipif bsub_batch 20 run_if maf_strata_trait

!|expand:;:tstrat;groupcol:all;:strata;!{raw,,project,--group-col CLST,if_prop=maf_strata_trait,allow_empty=1}| \ 
!!expand:tname:qc_plus! \ 
local cmd make_cat_project_tname_annotated_tstrat_sample_vcounts_file=(head -n1 !{input,,project_variant_subset_tname_annotated_tstrat_sample_vcounts_file,limit=1} && tail -qn+2 !{input,,project_variant_subset_tname_annotated_tstrat_sample_vcounts_file}) | $table_sum_stats_cmd --in-delim $tab --has-header --out-delim $tab --group-col $vep_consequence_annot groupcol --totals --print-header `for f in All One Some Every '>${low_freq_maf}' '${rare_maf}-${low_freq_maf}' '<${rare_maf}'; do echo --col \${f}_mean; done` | $smart_cut_cmd --in-delim $tab --select-col 0,1,'$vep_consequence_annot !{raw,,project,CLST,if_prop=maf_strata_trait,allow_empty=1} _tot$' | sed '1 s/_tot//g' > !{output,,project_tname_annotated_tstrat_sample_vcounts_file} class_level project run_if num_var_subsets 


#!!expand:,:projectt,projecte,runif,shortt:project,,skip_if num_var_subsets,:project_variant_subset,_project_variant_subset,,short! \
#shortt cmd make_projectt_vfreq_file=$pseq_filter_samples_analysis_cmdprojecte(v-freq) $show_id > !{output,,projectt_vfreq_file} class_level projectt runif

!!expand:,:type,fileno,extracmd:snps,$pseq_snp_tag,:indels,$pseq_indel_tag,! \
!!expand:,:projectt,projecte,runif,shortt:project,,skip_if num_var_subsets,:project_variant_subset,_project_variant_subset,,short! \
shortt cmd make_projectt_type_vfreq_file=$pseq_filter_only_samples_analysis_cmdprojecte(v-freq) $show_id --mask file=fileno extracmd > !{output,,projectt_type_vfreq_file} class_level projectt runif

!!expand:,:projectt,projecte,runif,shortt:project,,skip_if num_var_subsets,:project_variant_subset,_project_variant_subset,,short! \
shortt cmd make_projectt_multiallelics_vfreq_file=$smart_join_cmd --ignore-err . --in-delim $tab --exec "$pseq_filter_only_samples_analysis_cmdprojecte(v-freq) $show_id --mask file=$pseq_multiallelic_tag | sed '1 s/^/CHR:POS:/' | sed 's/:/\t/' | sed 's/:/\t/'" --exec "$smart_cut_cmd --in-delim $tab !{input,--file,projectt_multiallelic_frq_file} --exact --require-col-match --select-col 1,1,'id call_rate'" --header 1 --col 1,3 | awk -F"\t" -v OFS="\t" '{t=\$1; \$1=\$2; \$2=\$3; \$3=t} {print}' | sed 's/\t/:/' | sed 's/\t/:/' | sed '1 s/\S\S*:\S\S*://' | awk -v OFS="\t" -F"\t" 'NR == 1 {for (i=1;i<=NF;i++) {if (\$i == "GENO") {g=i} if (\$i == "call_rate") {c=i}}} NR > 1 {\$g=\$c} {print}' | rev | cut -f2- | rev > !{output,,projectt_multiallelics_vfreq_file} class_level projectt runif

!!expand:,:project,runif:project,skip_if num_var_subsets:project_variant_subset,run_if num_var_subsets! \
local cmd make_project_vfreq_file=$smart_join_cmd --merge --header 1 --in-delim $tab !{input,--file,project_snps_vfreq_file} !{input,--file,project_indels_vfreq_file} !{input,--file,project_multiallelics_vfreq_file} > !{output,,project_vfreq_file} class_level project runif

vfreq_cols=QUAL GENO MAF HWE HET NSNP

show_id=--show-id
parse_out_id=cut -d: -f3-
split_parsed_id=sed 's/:/\t/' | sed 's/:/\t/'

prop extra_vstats_cols=list

vcf_variant_type_annot=TYPE

!!expand:projectt:project:project_variant_subset! \
mq0_helper_projectt=$zcat_helper(projectt) @1 | $vcf_utils_cmd --print-annots --annot-type $vcf_variant_type_annot | $smart_cut_cmd --in-delim $tab --select-col 0,1,ID --select-col 0,1,'$vcf_het_ab_annot $vcf_mq0_annot $vcf_variant_type_annot !{prop,,project,extra_vstats_cols,if_prop=extra_vstats_cols,allow_empty=1}' --exact

#!!expand:projecte::_project_variant_subset! \
 #mq0_helperprojecte=$pseq_filter_samples_analysis_cmdprojecte(meta-matrix) @1 | $smart_cut_cmd --in-delim $tab --select-col 0,3 --select-col 0,1,'$vcf_het_ab_annot $vcf_mq0_annot'

!!expand:projecte::_project_variant_subset! \
vstats_helperprojecte=$plinkseq_variant_meta_cmdprojecte(@1,@2) --out-delim $tab | $parse_out_id

!!expand:projecte::_project_variant_subset! \
vstats_dev_helperprojecte=$plinkseq_variant_meta_nohead_cmdprojecte(@1 @2,DEV_@{1}) --type dev --out-delim $tab | $parse_out_id

!!expand:,:projectt,projecte:project,:project_variant_subset,_project_variant_subset! \
projectt_vstats_alt_gq_helperprojecte=$plinkseq_variant_meta_nohead_cmdprojecte(GQ @1,MEAN_ALT_GQ) --out-delim $tab !{input,--ref-info,projectt_plinkseq_@{2}_vmatrix_file} --ref-gt 0 --ref-col-start 4 | $parse_out_id



#!!expand:,:projectt,projecte,runif,shortt:project,,skip_if num_var_subsets,:project_variant_subset,_project_variant_subset,,short! \
#shortt cmd make_projectt_vstats_file=$smart_join_cmd --exec "$smart_cut_cmd !{input,--file,projectt_vfreq_file} --select-col 1,1 --select-col 1,1,'$vfreq_cols MAF' --in-delim $tab | $parse_out_id | $add_function_cmd --col1 HWE --type minus_log --header 1 --val-header LOG_P_HWE --in-delim $tab | $smart_cut_cmd --in-delim $tab --exclude-col 0,1,HWE --exact" --exec "$pseq_filter_samples_analysis_cmdprojecte(meta-matrix) | $smart_cut_cmd --in-delim $tab --select-col 0,3 --select-col 0,1,'$vcf_het_ab_annot $vcf_mq0_annot'" --exec "$plinkseq_variant_meta_cmdprojecte(DP) --out-delim $tab | $parse_out_id" --header 1 --in-delim $tab --out-delim , --ignore-err $plinkseq_okay_err > !{output,,projectt_vstats_file} class_level projectt runif

!!expand:,:projectt,projecte,runif,shortt:project,,skip_if num_var_subsets,:project_variant_subset,_project_variant_subset,,short! \
shortt cmd make_projectt_mean_alt_gq_file=$smart_join_cmd --merge --header 1 --in-delim $tab --exec "$projectt_vstats_alt_gq_helperprojecte(--mask file=$pseq_snp_tag,snps)" --exec "$projectt_vstats_alt_gq_helperprojecte(--mask file=$pseq_indel_tag,indels)" --exec "$projectt_vstats_alt_gq_helperprojecte(--mask file=$pseq_multiallelic_tag,multiallelics)" --ignore-err $plinkseq_okay_err > !{output,,projectt_mean_alt_gq_file} class_level projectt runif

!!expand:,:metaname,metaName:gq,GQ:dp,DP! \
!!expand:,:projectt,projecte,runif,shortt:project,,skip_if num_var_subsets,:project_variant_subset,_project_variant_subset,,short! \
shortt cmd make_projectt_mean_metaname_file=$smart_join_cmd --merge --header 1 --in-delim $tab --exec "$vstats_helperprojecte(metaName,--mask file=$pseq_snp_tag)" --exec "$vstats_helperprojecte(metaName,--mask file=$pseq_indel_tag)" --exec "$vstats_helperprojecte(metaName,--mask file=$pseq_multiallelic_tag)" --ignore-err $plinkseq_okay_err > !{output,,projectt_mean_metaname_file} class_level projectt runif

!!expand:,:projectt,projecte,runif,shortt:project,,skip_if num_var_subsets,:project_variant_subset,_project_variant_subset,,short! \
shortt cmd make_projectt_dev_dp_file=$smart_join_cmd --merge --header 1 --in-delim $tab --exec "$vstats_dev_helperprojecte(DP,--mask file=$pseq_snp_tag)" --exec "$vstats_dev_helperprojecte(DP,--mask file=$pseq_indel_tag)" --exec "$vstats_dev_helperprojecte(DP,--mask file=$pseq_multiallelic_tag)" --ignore-err $plinkseq_okay_err > !{output,,projectt_dev_dp_file} class_level projectt runif

!!expand%;%projectt;projecte;phenol;pheno_variant_qc_stratat;pheno_variant_qc_pheno_stratat;runif;shortt;extraifprop%project;;pheno;pheno_variant_qc_strata;pheno_variant_qc_pheno_strata;skip_if num_var_subsets;;%project_variant_subset;_project_variant_subset;pheno_variant_subset;pheno_variant_qc_strata_variant_subset;pheno_variant_qc_pheno_strata_variant_subset;consistent_prop var_subset_num bsub_batch 5;short;,if_prop=var_subset_num:eq:@var_subset_num! \
shortt cmd make_projectt_vstats_file=$smart_join_cmd --exec "$smart_cut_cmd --in-delim $tab !{input,--file,projectt_vfreq_file} --select-col 1,1 --select-col 1,1,'$vfreq_cols MAF' --select-row 1,1 --select-row 1,1,FILTER,$vcf_pass --in-delim $tab | $parse_out_id | $add_function_cmd --col1 HWE --type minus_log --header 1 --val-header LOG_P_HWE --in-delim $tab | $smart_cut_cmd --in-delim $tab --exclude-col 0,1,HWE --exact" --exec "$smart_join_cmd --in-delim $tab --header 1 --merge --exec \"$mq0_helper_projectt(!{input::projectt_indel_vcf_file})\" --exec \"$mq0_helper_projectt(!{input::projectt_vcf_file})\" --exec \"$mq0_helper_projectt(!{input::projectt_multiallelic_vcf_file})\" --ignore-err $plinkseq_okay_err"  !{input,--file,projectt_mean_gq_file} !{input,--file,projectt_mean_alt_gq_file} !{input,--file,projectt_mean_dp_file} !{input,--file,projectt_dev_dp_file} !{input,--file,project_custom_vstats_annot_file,if_prop=project_custom_vstats_annot_file,allow_empty=1} !{raw,--exec,projectt,"$smart_join_cmd --in-delim $tab --exec \"sort -u *project_variant_custom_exclude_file | $smart_cut_cmd --in-delim $tab --exec 'cut -f1 *projectt_vfreq_file | tail -n+2 | $parse_out_id' | sort | uniq -d | sed 's/$/\t1/'\" --exec \"cut -f1 *projectt_vfreq_file | tail -n+2 | $parse_out_id | sed 's/$/\t0/'\" --merge | sed '1 s/^/ID\t$custom_exclude_header\n/'",if_prop=project_variant_custom_exclude_file,allow_empty=1} !{input,project_variant_custom_exclude_file,if_prop=project_variant_custom_exclude_file,allow_empty=1}  --header 1 --rest-extra 1 --in-delim $tab --out-delim $vstats_delim --ignore-err $plinkseq_okay_err > !{output,,projectt_vstats_file} class_level projectt runif

!!expand%;%projectt;projecte;phenol;pheno_variant_qc_stratat;pheno_variant_qc_pheno_stratat;runif;shortt;extraifprop%project;;pheno;pheno_variant_qc_strata;pheno_variant_qc_pheno_strata;skip_if num_var_subsets;;%project_variant_subset;_project_variant_subset;pheno_variant_subset;pheno_variant_qc_strata_variant_subset;pheno_variant_qc_pheno_strata_variant_subset;consistent_prop var_subset_num bsub_batch 5;short;,if_prop=var_subset_num:eq:@var_subset_num! \
shortt cmd make_projectt_extended_vstats_file=$smart_join_cmd !{input,--file,projectt_vstats_file} !{input,--file,phenol_variant_qc_strata_vstats_summary_file,if_prop=qc_strata_trait,allow_empty=1extraifprop} !{input,--file,phenol_variant_qc_pheno_strata_vstats_summary_file,if_prop=qc_strata_trait,if_prop=pheno_stratas,allow_empty=1extraifprop}  --header 1 --rest-extra 1 --in-delim $tab --in-delim 1:$vstats_delim --out-delim $vstats_delim --ignore-err $plinkseq_okay_err --arg-delim : !{raw,,projectt,--fill 2 --fill-value NA,if_prop=qc_strata_trait,allow_empty=1extraifprop} !{raw,,projectt,--fill 3,if_prop=qc_strata_trait,if_prop=pheno_stratas,allow_empty=1extraifprop} > !{output,,projectt_extended_vstats_file} class_level projectt runif

#cut out from above command before --exec of smart join
#!{input,--file,pheno_variant_qc_stratat_vstats_file,if_prop=qc_strata_trait,allow_empty=1extraifprop} !{input,--file,pheno_variant_qc_pheno_stratat_vstats_file,if_prop=qc_strata_trait,if_prop=pheno_stratas,allow_empty=1extraifprop}

!|expand:;:vtype;extraadd\
:multiallelics_vfreq_file;\
:indels_vfreq_file;\
:snps_vfreq_file;\
:vfreq_file;\
:mean_alt_gq_file;\
:mean_gq_file;\
:mean_dp_file;\
:dev_dp_file;\
:vstats_file;\
:extended_vstats_file;\
:gene_variant_file;\
:clean_gene_variant_file;\
:clean_all_variant_site_vcf_file;\
:snpeff_file;\
:snpsift_file;\
:chaos_file;\
:vep_file;\
:parsed_vep_file;\
:var_transcript_file;\
:custom_trans_annot_file;skip_if !project_custom_var_annot_file\
:pph2_pos_file;\
:pph2_file;\
:complete_full_annot_file;\
:full_annot_file;\
:full_var_annot_file;\
:transcript_gene_map_file;with burden\
:plinkseq_qc_pass_frq_file;\
:plinkseq_qc_plus_frq_file;skip_if and,!sample_qc_filter,!var_qc_filter,!project_variant_custom_exclude_file,!project_sample_custom_exclude_file\
:plinkseq_qc_pass_counts_file;\
:plinkseq_qc_plus_counts_file;skip_if and,!sample_qc_filter,!var_qc_filter,!project_variant_custom_exclude_file,!project_sample_custom_exclude_file\
:plinkseq_qc_pass_strata_frq_file;\
:plinkseq_qc_plus_strata_frq_file;\
:multiallelic_frq_file;\
:plinkseq_qc_pass_combined_frq_file;\
:plinkseq_qc_plus_combined_frq_file;\
:plinkseq_qc_pass_combined_strata_frq_file;\
:plinkseq_qc_plus_combined_strata_frq_file;\
:plinkseq_qc_pass_strata_frq_summary_file;\
:plinkseq_qc_plus_strata_frq_summary_file;\
:plinkseq_syn_reg_file;\
:plinkseq_ns_reg_file;\
:plinkseq_nonsense_reg_file;\
:plinkseq_coding_reg_file;\
:plinkseq_qc_pass_gstats_file;\
:plinkseq_qc_pass_estats_file;\
:plinkseq_qc_pass_ns_gstats_file;\
:plinkseq_qc_pass_ns_estats_file;\
:plinkseq_qc_pass_syn_gstats_file;\
:plinkseq_qc_pass_syn_estats_file;\
:plinkseq_filtered_gstats_file;\
|\
local cmd make_cat_project_vtype=(head -qn+1 !{input,,project_variant_subset_vtype,limit=1,sort_prop=project_variant_subset} | head -n1 && tail -qn+2 !{input,,project_variant_subset_vtype,sort_prop=project_variant_subset}) > !{output,,project_vtype} class_level project run_if num_var_subsets extraadd

!|expand:;:vtype;extraadd\
:clean_all_variant_site_vcf_file;\
|\
local cmd make_cat_project_vtype=(head -qn+1 !{input,,project_variant_subset_vtype,limit=1,sort_prop=project_variant_subset} | head -n2 && tail -qn+3 !{input,,project_variant_subset_vtype,sort_prop=var_subset_num}) > !{output,,project_vtype} class_level project run_if num_var_subsets extraadd



vstats_delim=,
#local cmd make_project_variant_outlier_file=$write_outlier_table_cmd !{input,,project_vstats_file} !{output,,project_variant_outlier_file} -VAR VAR sep=$vstats_delim out.sep=$vstats_delim class_level project

!!expand:,:variant_outlier,project_vstats_file:variant_outlier,project_vstats_file:variant_extended_outlier,project_extended_vstats_file! \
exclude_variant_outlier_raw_int=$smart_cut_cmd --exec @3"sed '1! s/^/@1$vstats_delim/' !{input,,project_vstats_file} | sed '1 s/^/METRIC$vstats_delim/'@3" --select-row 1,1,@1,@2 --and-row-all --in-delim $vstats_delim --exact --select-col 1,'2 1' --select-col 1,1,@1 --exclude-row 1,1

!!expand:,:variant_outlier,project_vstats_file:variant_outlier,project_vstats_file:variant_extended_outlier,project_extended_vstats_file! \
exclude_variant_outlier_raw=$exclude_variant_outlier_raw_int(@1,@2,)

#$exclude_outlier_raw(project_variant_outlier_file,@1,@2,$vstats_delim)

#exclude_variant_outlier_iqr=$exclude_outlier_iqr(project_variant_outlier_file,@1,@2,$vstats_delim)

!|expand:;:make_var_qc_filter;variant_outlier;skipif:make_var_qc_filter;variant_outlier;skip_if or,is_extended_filter,is_extended_strict_filter:make_extended_var_qc_filter;variant_extended_outlier;skip_if and,!is_extended_filter,!is_extended_strict_filter)| \
short cmd make_var_qc_filter_metric_modifier_exclude_file=$exclude_variant_outlier_raw(!{prop;;var_qc_filter;modifier_filter_metric},!{prop;;var_qc_filter;modifier_filter_metric_op}:!{prop;;var_qc_filter;modifier_filter_metric_value}) > !{output,,var_qc_filter_modifier_exclude_file} class_level var_qc_filter run_if modifier_filter_metric skipif

!|expand:;:var_qc_filter_exclude;variant_outlier:var_qc_filter_exclude;variant_outlier:extended_var_qc_filter_exclude;variant_extended_outlier| \
var_qc_filter_exclude_helper_int=$exclude_variant_outlier_raw_int(!{prop;;var_qc_filter;filter_metric},!{prop;;var_qc_filter;filter_metric_op}:!{prop;;var_qc_filter;filter_metric_value},@1)

!|expand:;:var_qc_filter_exclude;variant_outlier:var_qc_filter_exclude;variant_outlier:extended_var_qc_filter_exclude;variant_extended_outlier| \
var_qc_filter_exclude_helper=$var_qc_filter_exclude_helper_int()

!|expand:;:make_var_qc_filter;var_qc_filter_exclude_helper;skipif:make_var_qc_filter;var_qc_filter_exclude_helper;skip_if or,is_extended_filter,is_extended_strict_filter:make_extended_var_qc_filter;extended_var_qc_filter_exclude_helper;skip_if and,!is_extended_filter,!is_extended_strict_filter| \
short cmd make_var_qc_filter_metric_exclude_file=$var_qc_filter_exclude_helper > !{output,,var_qc_filter_exclude_file} class_level var_qc_filter run_if and,filter_metric,!modifier_filter_metric skipif

!|expand:;:make_var_qc_filter;var_qc_filter_exclude_helper;skipif:make_var_qc_filter;var_qc_filter_exclude_helper;skip_if or,is_extended_filter,is_extended_strict_filter:make_extended_var_qc_filter;extended_var_qc_filter_exclude_helper;skip_if and,!is_extended_filter,!is_extended_strict_filter| \
short cmd make_var_qc_filter_metric_with_modifier_exclude_file=$smart_join_cmd --arg-delim : --out-delim , --in-delim , --exec "$var_qc_filter_exclude_helper_int(\)" --exec "$var_qc_filter_exclude_helper_int(\) | cat - !{input,,var_qc_filter_modifier_exclude_file} | cut -d, -f1 | sort | uniq -d" --extra 1 > !{output,,var_qc_filter_exclude_file} class_level var_qc_filter run_if and,filter_metric,modifier_filter_metric skipif

short cmd make_project_variant_exclude_detail_file=\
 $exclude_variant_outlier_raw(MAF,eq:0) \ 
 !{raw;;project;| $exclude_variant_outlier_raw($custom_exclude_header,eq:1);if_prop=project_variant_custom_exclude_file;allow_empty=1} \
 !{raw,|,var_qc_filter,cat - *var_qc_filter_exclude_file,if_prop=var_qc_filter,unless_prop=is_extended_filter,unless_prop=is_extended_strict_filter,allow_empty=1} !{input,var_qc_filter_exclude_file,if_prop=var_qc_filter,unless_prop=is_extended_filter,unless_prop=is_extended_strict_filter,allow_empty=1} \
 | sort -u | $add_header_cmd "LABEL${vstats_delim}MEASURE${vstats_delim}VALUE" > !{output,,project_variant_exclude_detail_file} class_level project

prop custom_var_keep=list
prop custom_var_exclude=list

local cmd make_project_variant_exclude_file=cut -d$vstats_delim -f1 !{input,,project_variant_exclude_detail_file} | tail -n+2 | sort -u !{raw,,project,| $smart_cut_cmd --exec "echo @custom_var_keep @custom_var_keep | sed 's/\s\s*/\n/g'" | sort| uniq -u,if_prop=custom_var_keep,allow_empty=1} !{raw,,project,| $smart_cut_cmd --exec "echo @custom_var_exclude | sed 's/\s\s*/\n/g'" | sort -u,if_prop=custom_var_exclude,allow_empty=1} > !{output,,project_variant_exclude_file} class_level project

short cmd make_project_extended_variant_exclude_detail_file=\
 cat /dev/null !{raw,|,var_qc_filter,cat - *var_qc_filter_exclude_file,if_prop=var_qc_filter,if_prop=is_extended_filter,allow_empty=1} !{input,var_qc_filter_exclude_file,if_prop=var_qc_filter,if_prop=is_extended_filter,allow_empty=1} \
 | sort -u | $add_header_cmd "LABEL${vstats_delim}MEASURE${vstats_delim}VALUE" > !{output,,project_extended_variant_exclude_detail_file} class_level project

local cmd make_project_extended_variant_exclude_file=cut -d$vstats_delim -f1 !{input,,project_extended_variant_exclude_detail_file} | tail -n+2 !{raw,,project,| cat - *project_extended_variant_custom_exclude_file,if_prop=project_extended_variant_custom_exclude_file,allow_empty=1} !{input,project_extended_variant_custom_exclude_file,if_prop=project_extended_variant_custom_exclude_file,allow_empty=1} | sort -u > !{output,,project_extended_variant_exclude_file} class_level project

short cmd make_project_extended_strict_variant_exclude_detail_file=\
tail -n+2 !{input,,project_extended_variant_exclude_detail_file} !{raw,|,var_qc_filter,cat - *var_qc_filter_exclude_file,if_prop=var_qc_filter,if_prop=is_extended_strict_filter,allow_empty=1} !{input,var_qc_filter_exclude_file,if_prop=var_qc_filter,if_prop=is_extended_strict_filter,allow_empty=1} \
 | sort -u | $add_header_cmd "LABEL${vstats_delim}MEASURE${vstats_delim}VALUE" > !{output,,project_extended_strict_variant_exclude_detail_file} class_level project

local cmd make_project_extended_strict_variant_exclude_file=cut -d$vstats_delim -f1 !{input,,project_extended_strict_variant_exclude_detail_file} | tail -n+2 !{raw,,project,| cat - *project_extended_variant_custom_exclude_file,if_prop=project_extended_variant_custom_exclude_file,allow_empty=1} !{input,project_extended_variant_custom_exclude_file,if_prop=project_extended_variant_custom_exclude_file,allow_empty=1} !{raw,,project,| cat - *project_extended_strict_variant_custom_exclude_file,if_prop=project_extended_variant_custom_exclude_file,allow_empty=1} !{input,project_extended_strict_variant_custom_exclude_file,if_prop=project_extended_strict_variant_custom_exclude_file,allow_empty=1} | sort -u > !{output,,project_extended_strict_variant_exclude_file} class_level project

short cmd make_annot_var_qc_filter_exclude_file=$exclude_variant_extended_outlier_raw_int(!{prop;;annot_var_qc_filter;filter_metric},!{prop;;annot_var_qc_filter;filter_metric_op}:!{prop;;annot_var_qc_filter;filter_metric_value},) > !{output,,annot_var_qc_filter_exclude_file} class_level annot_var_qc_filter

short cmd make_annot_variant_exclude_detail_file=\
 cat /dev/null !{raw,|,annot_var_qc_filter,cat - *annot_var_qc_filter_exclude_file,if_prop=annot_var_qc_filter,allow_empty=1} !{input,annot_var_qc_filter_exclude_file,if_prop=annot_var_qc_filter,allow_empty=1} \
 | sort -u | $add_header_cmd "LABEL${vstats_delim}MEASURE${vstats_delim}VALUE" > !{output,,annot_variant_exclude_detail_file} class_level annot

local cmd make_annot_variant_exclude_file=cut -d$vstats_delim -f1 !{input,,annot_variant_exclude_detail_file} | tail -n+2 | sort -u > !{output,,annot_variant_exclude_file} class_level annot

!!expand:,:projectt,runif,shortt:project,skip_if num_merge_subsets,:project_merge_subset,bsub_batch 10,short! \
shortt cmd make_projectt_snp_indel_overlap_file=$zcat_helper(projectt) !{input,,projectt_merged_vcf_file} | fgrep -v '\\#' | cut -f1-2 | sort | uniq -d > !{output,,projectt_snp_indel_overlap_file} class_level projectt runif

local cmd cat_project_snp_indel_overlap_file=cat !{input,,project_merge_subset_snp_indel_overlap_file,sort_prop=project_merge_subset} > !{output,,project_snp_indel_overlap_file} class_level project run_if num_merge_subsets

max_vstats_points=1000
max_vstats_highlighted_points=200

!!expand:,:vstats_pdf_helper,project_vstats_file:vstats_pdf_helper,project_vstats_file:extended_vstats_pdf_helper,project_extended_vstats_file! \
vstats_pdf_helper=$draw_box_plot_cmd() !{input,,project_vstats_file} !{output,,@1} 'Variant QC properties' '' 'Variant Values' -VAR sep=$vstats_delim max.plot.points=$max_vstats_points max.highlighted.points=$max_vstats_highlighted_points @2
!!expand:,:variant_highlight_info,project_variant_exclude_detail_file:variant_highlight_info,project_variant_exclude_detail_file:extended_variant_highlight_info,project_extended_variant_exclude_detail_file! \
variant_highlight_info=id.col=1 highlight.list.file=!{input,,project_variant_exclude_detail_file} highlight.id.col=1 highlight.label.col=2 highlight.sep=$vstats_delim

!!expand:,:vstats_pdf_helper,project_vstats:vstats_pdf_helper,project_vstats:extended_vstats_pdf_helper,project_extended_vstats! \
restart_mem short cmd make_project_vstats_initial_pdf_file=$vstats_pdf_helper(project_vstats_initial_pdf_file,) class_level project rusage_mod $vstats_plot_mem
!!expand:,:vstats_pdf_helper,project_vstats,variant_highlight_info:vstats_pdf_helper,project_vstats,variant_highlight_info:extended_vstats_pdf_helper,project_extended_vstats,extended_variant_highlight_info! \
restart_mem short cmd make_project_vstats_highlighted_pdf_file=$vstats_pdf_helper(project_vstats_highlighted_pdf_file, $variant_highlight_info) class_level project rusage_mod $vstats_plot_mem
!!expand:,:vstats_pdf_helper,project_vstats,variant_highlight_info:vstats_pdf_helper,project_vstats,variant_highlight_info:extended_vstats_pdf_helper,project_extended_vstats,extended_variant_highlight_info! \
restart_mem short cmd make_project_vstats_final_pdf_file=$vstats_pdf_helper(project_vstats_final_pdf_file, $variant_highlight_info exclude.highlighted=TRUE) class_level project rusage_mod $vstats_plot_mem

fix_locstats_file=awk -F"\t" 'NF > 1'
!!expand:,:gtype,mtype:gene,pseq_genes_loc_group:exon,pseq_exons_loc_group! \
cmd make_plinkseq_gtype_locstats_file=$pseq_project_cmd loc-stats --group $mtype | $catch_sqlite_errors | $fix_locstats_file > !{output,,project_plinkseq_gtype_locstats_file} !{input,project_plinkseq_db_done_file} !{input,project_plinkseq_locdb_file} class_level project

prop do_detailed_gstats=scalar 
prop do_pheno_gstats=scalar 

prop bad_regions_for_genes=list
bad_for_genes_regex_mask=--mask reg.ex=!{prop,,project,bad_regions_for_genes,missing=,sep=\,} 


!!expand:,:stattype,groupname:gstats,pseq_genes_loc_group:estats,pseq_exons_loc_group! \
!|expand:;:projectt;projectl;skipif;shortt;pseqcmd;extramask:\
project;project;skip_if num_var_subsets;;pseq_filter_samples_analysis_cmd;:\
project_variant_subset;project_variant_subset;;;pseq_filter_samples_analysis_cmd_project_variant_subset;:\
pheno;project;skip_if or,num_var_subsets,!do_pheno_gstats;;pseq_all_analysis_cmd_pheno;$mono_ex_mask:\
pheno_variant_subset;project_variant_subset;skip_if !do_pheno_gstats;;pseq_all_analysis_cmd_pheno_variant_subset;$mono_ex_mask| \
!|expand:;:vartype;varmask;runif:;;run_if do_detailed_gstats:_syn;--mask reg.req=@!{input,,projectl_plinkseq_syn_reg_file};run_if do_detailed_gstats:_ns;--mask reg.req=@!{input,,projectl_plinkseq_ns_reg_file};run_if do_detailed_gstats| \
shortt cmd make_projectt_plinkseq_qc_passvartype_stattype_file=$pseqcmd(g-stats) --mask loc.group=$groupname varmask extramask $bad_for_genes_regex_mask > !{output,,projectt_plinkseq_qc_passvartype_stattype_file} class_level projectt runif skipif

#!!expand:,:projectt,projecte,runif,shortt:project,,skip_if num_var_subsets,:project_variant_subset,_project_variant_subset,,short! \
#shortt cmd make_projectt_plinkseq_filtered_gstats_file=$pseq_filtered_analysis_cmdprojecte(g-stats) --mask loc.group=$pseq_genes_loc_group $bad_for_genes_regex_mask > !{output,,projectt_plinkseq_filtered_gstats_file} class_level projectt runif

remove_dup_genes=sed '/^\s\*\S\*_dup/d'

fix_gstats=cut -f1-12
project_gstats_helper=$smart_join_cmd --exec "$smart_cut_cmd !{input,--file,project_plinkseq_qc_pass_gstats_file} --comment \\# --exclude-col 1,1,QC_FAIL --exclude-col 1,1,QC_PCT --in-delim $tab | $fix_gstats" --exec "$smart_cut_cmd !{input,--file,project_plinkseq_filtered_gstats_file} --comment \\# --select-col 1,1 --select-col 1,1,QC_FAIL --select-col 1,1,QC_PCT --in-delim $tab" @1 --exec "$smart_cut_cmd --out-delim $tab --exec \"$catch_sqlite_errors !{input,,project_plinkseq_gene_locstats_file}\" --comment \\# --select-col 1,1 --select-col 1,1,'GC GC_ALL N N_ALL' --exact --require-col-match" --extra 3 --comment \\# --in-delim $tab --arg-delim : --header 1 --out-delim ,

local cmd make_project_gstats_no_coverage_file=$project_gstats_helper() > !{output,,project_gstats_file} class_level project run_if no_coverage

local cmd make_project_gstats_file=$project_gstats_helper(--exec "$table_sum_stats_cmd --summaries --has-header --col $frac_above_threshold --group-col 1 --label '!{prop\,\,project}' --in-delim $coverage_dat_delim --out-delim $tab --print-header < !{input\,\,project_gene_dist_coverage_dat_file} | sed '1 s/$frac_above_threshold_mean/PCT_BASES_${threshold}x/' | cut -f1\,3") --extra 4 | $add_function_cmd --in-delim , --header 1 --col1 BP --col2 PCT_BASES_${threshold}x --type multiply --val-header BP_EFF | $add_function_cmd --in-delim , --header 1 --col1 NVAR --col2 BP_EFF --type divide --val-header VAR_PER_BP > !{output,,project_gstats_file} class_level project skip_if no_coverage

gstats_cols_no_cov=DENS\,NVAR\,SING\,RATE\,GC
gstats_cols=$gstats_cols_no_cov\,PCT_BASES_${threshold}x\,VAR_PER_BP
gstats_cols_helper=!{raw,,project,$gstats_cols,unless_prop=no_coverage,allow_empty=1} !{raw,,project,$gstats_cols_no_cov,if_prop=no_coverage,allow_empty=1}

local cmd make_project_gene_outlier_file_no_coverage=$write_outlier_table_cmd !{input,,project_gstats_file} !{output,,project_gene_outlier_file} $gstats_cols_helper  NAME sep=, out.sep=, class_level project run_if no_coverage

local cmd make_project_gene_outlier_file=$write_outlier_table_cmd !{input,,project_gstats_file} !{output,,project_gene_outlier_file} $gstats_cols_helper NAME sep=, out.sep=, class_level project skip_if no_coverage

exclude_gene_outlier_iqr=$exclude_outlier_iqr(project_gene_outlier_file,@1,@2,\,)
local cmd make_project_gene_exclude_detail_file=$exclude_gene_outlier_iqr(VRATE,ge:2) | $exclude_gene_outlier_iqr(NSING,ge:2) | $exclude_gene_outlier_iqr(QC_PCT,le:-2) | $exclude_gene_outlier_iqr(GC,le:-2) | $smart_cut_cmd --file !{input,,project_gene_outlier_file} --in-delim , --select-row 1,1 > !{output,,project_gene_exclude_detail_file} class_level project

max_gstats_points=1000
max_gstats_highlighted_points=200
gstats_pdf_helper=$draw_box_plot_cmd(!{input\,\,project_gstats_file} !{output\,\,@1} 'Gene QC properties' '' 'Gene Values' $gstats_cols_helper sep=\, max.plot.points=$max_gstats_points max.highlighted.points=$max_gstats_highlighted_points @2) class_level project
gene_highlight_info=id.col=1 highlight.list.file=!{input,,project_gene_exclude_detail_file} highlight.id.col=1 highlight.label.col=2 highlight.sep=,

local cmd make_project_gstats_pdf_file=$gstats_pdf_helper(project_gstats_pdf_file, ) class_level project

local cmd make_project_gstats_highlighted_pdf_file=$gstats_pdf_helper(project_gstats_highlighted_pdf_file, $gene_highlight_info) class_level project

local cmd make_project_gene_gc_pdf_file=$draw_matrix_plot_cmd !{input,,project_gstats_file} !{output,,project_gene_gc_pdf_file} 'GC metrics' GC,PCT_BASES_${threshold}x,VAR_PER_BP sep=, exclude.outliers=10 do.ipairs=TRUE class_level project skip_if no_coverage

#Args
plink_bed_hidden_in_or_out=!{@1,@{2}_bed_file} !{@1,@{2}_bim_file} !{@1,@{2}_fam_file}
plink_in_or_out_bed_helper=!{raw,--@1,project,*@{2}_plink_file} $plink_bed_hidden_in_or_out(@3,@2)
plink_out_bed_helper=$plink_in_or_out_bed_helper(out,@1,output)
plink_in_bed_helper=$plink_in_or_out_bed_helper(bfile,@1,input)

marker_sync_ref_alt_helper=$sync_ref_alt_cmd !{input,--ref-vcf,project_snp_id_site_vcf_file} !{input,--ref-vcf,project_indel_id_site_vcf_file} !{input,--sync-bim,@1} --remove-discordant --remove-multiple-in-ref --remove-multiple-in-sync

short cmd make_marker_initial_filtered_plink_file=$plink_cmd !{input,--bed,marker_initial_bed_file} !{input,--bim,marker_initial_bim_file} !{input,--fam,marker_initial_fam_file} !{input,--keep,marker_sample_keep_file,if_prop=marker_sample_keep_file,allow_empty=1} !{input,--exclude,marker_snp_exclude_file,if_prop=marker_snp_exclude_file,allow_empty=1} --make-bed $plink_out_bed_helper(marker_initial_filtered) && $plink_mv_log_cmd(!{raw\,\,marker\,*marker_initial_filtered_plink_file},!{output\,\,marker_initial_filtered_make_bed_log_file}) class_level marker run_if or,marker_sample_keep_file,marker_snp_exclude_file

local cmd ln_marker_initial_filtered_plink_file=ln -s !{input,,marker_initial_bed_file} !{output,,marker_initial_filtered_bed_file} && ln -s !{input,,marker_initial_bim_file} !{output,,marker_initial_filtered_bim_file} && ln -s !{input,,marker_initial_fam_file} !{output,,marker_initial_filtered_fam_file} class_level marker skip_if or,marker_sample_keep_file,marker_snp_exclude_file class_level marker

short cmd make_marker_strand_discordant_file=$marker_sync_ref_alt_helper(marker_initial_filtered_bim_file) --write-excluded > !{output,,marker_strand_discordant_file} class_level marker

short cmd make_marker_project_non_overlap_file=cat !{input,,project_snp_id_site_vcf_file} !{input,,project_snp_id_site_vcf_file} !{input,,project_indel_id_site_vcf_file} !{input,,project_indel_id_site_vcf_file} | fgrep -v '\#' | awk -F"\t" '{print \$3,\$1,\$2}' | $smart_cut_cmd !{input,--file,marker_initial_filtered_bim_file} --select-col 1,'2 1 4' | sort -k2,2 -k3,3 | uniq -u -f1 | awk '{print \$1}' > !{output,,marker_project_non_overlap_file} class_level marker

short cmd make_marker_initial_corrected_bim_file=$marker_sync_ref_alt_helper(marker_initial_filtered_bim_file) --write-corrected-file > !{output,,marker_initial_corrected_bim_file} class_level marker

marker_initial_corrected_inputs=!{input,--bed,marker_initial_filtered_bed_file} !{input,--bim,marker_initial_corrected_bim_file} !{input,--fam,marker_initial_filtered_fam_file}
marker_initial_snp_corrected_inputs=!{input,--bed,marker_initial_filtered_bed_file} !{input,--bim,marker_initial_snp_corrected_bim_file} !{input,--fam,marker_initial_filtered_fam_file}

cmd make_marker_sample_strand_filtered_overlap_plink_files=cat !{input,,marker_project_non_overlap_file} !{input,,marker_strand_discordant_file} | sort -u | $plink_cmd $marker_initial_corrected_inputs !{input,--keep,marker_project_sample_include_file} --exclude /dev/stdin --make-bed $plink_out_bed_helper(marker_sample_strand_filtered_overlap) && $plink_mv_log_cmd(!{raw\,\,marker\,*marker_sample_strand_filtered_overlap_plink_file},!{output\,\,marker_sample_strand_filtered_overlap_make_bed_log_file}) class_level marker

!!expand:,:stype,skipif,shortt:,skip_if num_var_subsets,:_variant_subset,,short! \
shortt cmd make_markerstype_initial_diff_file=$plink_cmd $plink_in_bed_helper(marker_sample_strand_filtered_overlap) --bmerge !{input,,projectstype_plinkseq_qc_pass_bed_file} !{input,,projectstype_plinkseq_qc_pass_bim_file} !{input,,projectstype_plinkseq_qc_pass_fam_file} !{input,--keep,marker_project_sample_include_file} !{input,--exclude,marker_strand_discordant_file} --merge-mode 6 !{raw,--out,markerstype,*markerstype_initial_filtered_plink_file} !{output,markerstype_initial_diff_file} && $plink_mv_log_cmd(!{raw\,\,markerstype\,*markerstype_initial_filtered_plink_file},!{output\,\,markerstype_initial_diff_log_file}) class_level markerstype skipif run_if !add_for_pca

local cmd make_empty_marker_initial_diff_file=echo "SNP FID IID NEW OLD"  > !{output,,marker_initial_diff_file} class_level marker run_if add_for_pca

plink_geno_no_call=0/0

!!expand:,:vtype,skipif,shortt:,skip_if num_var_subsets,:_variant_subset,,short! \
shortt cmd make_markervtype_initial_snp_pct_discordant_file=f=`cat !{input,,marker_initial_filtered_fam_file} | awk '{print \$2}' | sort -u | cat - !{input,,project_passed_sample_list_file} | sort | uniq -d | wc -l` && perl -lape '\$r = reverse \$F[4]; s/$/ \$r/' !{input,,markervtype_initial_diff_file} | tail -n+2 | awk -v OFS="\t" '{missing=1; dis=0; swap=0} \$4 != "$plink_geno_no_call" && \$5 != "$plink_geno_no_call" {missing=0} \$4 != \$5 && !missing {dis=1} \$4 == \$6 && dis {swap=1} {print \$1,missing,dis,swap}' | $add_header_cmd SNP${tab}MISSING${tab}DIS${tab}SWAP | $table_sum_stats_cmd --in-delim $tab --out-delim $tab --has-header --group-col SNP --col MISSING --col DIS --col SWAP --totals --print-header | $smart_cut_cmd --in-delim $tab --select-col 0,1 --select-col 0,1,'$summary_tot(MISSING) $summary_tot(DIS) $summary_tot(SWAP)' | tail -n+2 | sed "s/\$/\t\$f/" | awk -v OFS="\t" '{t=\$5-\$2;} t > 0 {print \$1,\$3/t,(\$3 - \$4)/t} t == 0 {print \$1,0,0}' | $add_header_cmd SNP${tab}PCT_DIS${tab}PCT_DIS_SWAP  > !{output,,markervtype_initial_snp_pct_discordant_file} class_level markervtype skipif run_if !add_for_pca

local cmd make_empty_marker_initial_snp_pct_discordant_file=echo | $add_header_cmd SNP${tab}PCT_DIS${tab}PCT_DIS_SWAP  > !{output,,marker_initial_snp_pct_discordant_file} class_level marker run_if add_for_pca

cmd make_cat_marker_initial_snp_pct_discordant_file=(head -qn+1 !{input,,marker_variant_subset_initial_snp_pct_discordant_file,limit=1,sort_prop=marker_variant_subset} | head -n1 && tail -qn+2 !{input,,marker_variant_subset_initial_snp_pct_discordant_file,sort_prop=marker_variant_subset}) > !{output,,marker_initial_snp_pct_discordant_file} class_level marker run_if num_var_subsets skip_if add_for_pca

marker_snp_discordant_threshold=.1

!!expand:,:keytype,ineq:discordant,>:flipped,<=! \
local cmd make_marker_snp_keytype_file=awk 'NR > 1 && \$2 > $marker_snp_discordant_threshold && \$3 ineq $marker_snp_discordant_threshold {print \$1}' !{input,,marker_initial_snp_pct_discordant_file} > !{output,,marker_snp_keytype_file} class_level marker

local cmd make_marker_initial_snp_corrected_bim_file=$marker_sync_ref_alt_helper(marker_initial_corrected_bim_file) --write-corrected-file !{input,--flip-snp-list,marker_snp_flipped_file} > !{output,,marker_initial_snp_corrected_bim_file} class_level marker

local cmd make_marker_project_sample_include_file=cat !{input,,project_sample_marker_keep_file} !{input,marker_initial_fam_file,if_prop=add_for_pca,allow_empty=1} !{raw,,marker,| cat - *marker_initial_fam_file | sort -u,if_prop=add_for_pca,allow_empty=1} > !{output,,marker_project_sample_include_file} class_level marker

short cmd make_marker_filtered_plink_files=cat !{input,,marker_snp_discordant_file} !{input,,marker_strand_discordant_file} | $plink_cmd $marker_initial_snp_corrected_inputs --exclude /dev/stdin --make-bed $plink_out_bed_helper(marker_filtered) && $plink_mv_log_cmd(!{raw\,\,marker\,*marker_filtered_plink_file},!{output\,\,marker_filtered_make_bed_log_file}) class_level marker


marker_ld_helper=$plink_cmd $plink_in_bed_helper(@1) --r2 --ld-window-r2 .7 --ld-window-kb 1000 --ld-window 99999 !{raw,--out,@4,*@{1}_plink_file} !{output,@2} && $plink_mv_log_cmd(!{raw\,\,@4\,*@{1}_plink_file},!{output\,\,@3})

short cmd make_marker_filtered_frq_file=$plink_cmd $plink_in_bed_helper(marker_filtered) --freq !{output,--out,marker_filtered_frq_file} !{output,marker_filtered_frq_log_file} && mv !{output,,marker_filtered_frq_file}.frq !{output,,marker_filtered_frq_file} class_level marker

#short cmd make_marker_filtered_for_merge_ld_file=$marker_ld_helper(marker_filtered_for_merge,marker_filtered_for_merge_ld_file,marker_filtered_for_merge_ld_log_file,marker) class_level marker

prop max_freq_flip_maf=scalar default .35
prop remove_ambiguous=scalar

!!expand:,:ftype,cmdtype:initial_bim,write-corrected-file:exclude,write-excluded! \
short cmd make_marker_filtered_for_merge_ftype_file=$sync_ref_alt_cmd !{input,--sync-bim,marker_filtered_bim_file} --remove-discordant --cmdtype !{input,--ref-bim,marker_filtered_bim_file,all_instances=1,if_prop=project:eq:@project} !{input,--sync-freq,marker_filtered_frq_file} !{prop,--max-freq-flip-maf,marker,max_freq_flip_maf,if_prop=max_freq_flip_maf,allow_empty=1} !{raw,,marker,--remove-ambiguous,if_prop=remove_ambiguous,allow_empty=1} > !{output,,marker_filtered_for_merge_ftype_file} class_level marker


short cmd make_marker_filtered_for_merge_plink_files=$plink_cmd !{input,--bed,marker_filtered_bed_file} !{input,--bim,marker_filtered_for_merge_initial_bim_file} !{input,--fam,marker_filtered_fam_file} !{input,--exclude,marker_filtered_for_merge_exclude_file} --make-bed $plink_out_bed_helper(marker_filtered_for_merge) && $plink_mv_log_cmd(!{raw\,\,marker\,*marker_filtered_for_merge_plink_file},!{output\,\,marker_filtered_for_merge_make_bed_log_file}) class_level marker

#short cmd make_marker_filtered_for_merge_exclude_file=$sync_ref_alt_cmd !{input,--sync-bim,marker_filtered_bim_file} --write-excluded --remove-ambiguous | $smart_cut_cmd --exec "cat !{input,,marker_filtered_bim_file} | $smart_cut_cmd --select-col 0,2 |  > !{output,,marker_filtered_for_merge_exclude_file} class_level marker


short cmd make_marker_sample_filtered_snp_include_file=$add_gene_annot_cmd --outside-name $outside_gene_name !{input,--gene-file,project_expanded_exon_target_file} --gene-file-num-ids 2 --out-delim $tab --chr-col 1 --pos-col 4 < !{input,,marker_initial_snp_corrected_bim_file} | cut -f3 | sort - !{input,,marker_snp_discordant_file} !{input,,marker_strand_discordant_file} !{input,,marker_snp_discordant_file} !{input,,marker_strand_discordant_file} | uniq -u  > !{output,,marker_sample_filtered_snp_include_file} class_level marker

clean_geno=.1
clean_mind=0.1
clean_hwe=0.001
clean_filters=--hwe $clean_hwe --mind $clean_mind --geno $clean_geno

cmd make_marker_sample_filtered_vcf_file=$plink108_cmd $marker_initial_snp_corrected_inputs $clean_filters !{input,--keep,marker_project_sample_include_file} !{input,--extract,marker_sample_filtered_snp_include_file} --recode-vcf !{raw,--out,marker,*marker_sample_filtered_plink_file} !{output,marker_sample_filtered_vcf_file} && $plink_mv_log_cmd(!{raw\,\,marker\,*marker_sample_filtered_plink_file},!{output\,\,marker_sample_filtered_recode_vcf_log_file}) class_level marker

fix_vcf_file=perl -lane 'BEGIN {open IN, "!{input,,@1}" or die; while (<IN>) {\@cols = split; \$vcfid2id{"\$cols[0]_\$cols[1]"} = \$cols[1];}} \@cols = split; if (/^\\#CHROM/) {for (\$i=9;\$i<scalar(\@cols);\$i++) {\$new_id = \$vcfid2id{\$cols[\$i]}; die "No sample \$cols[\$i]" unless \$new_id; \$cols[\$i] = \$new_id}} print join("\t", \@cols)'

short cmd make_marker_sample_filtered_fixed_vcf_file=$fix_vcf_file(marker_initial_filtered_fam_file) < !{input,,marker_sample_filtered_vcf_file} | awk -F"\t" '/^\#/ || (\$4 ~ /[ACTG]/ && \$5 ~ /[ACTG]/)' | $vcf_utils_cmd !{input,--reference-vcf,project_snp_id_site_vcf_file} !{input,--reference-vcf,project_indel_id_site_vcf_file} !{input,--chr-pos-keep,marker_sample_filtered_vcf_file} --remove-non-biallelic --valid-ref-alt > !{output,,marker_sample_filtered_fixed_vcf_file} class_level marker

!!expand:stype::_sample_subset! \
markerstype_eval_helper=$gatk_cmd_no_interval(GenotypeConcordance) -moltenize -l OFF @1 !{output,-o,@2} !{input,--eval,projectstype_vcf_file} !{input,--comp,@3} 

!!expand:,:stype,runif,shortt:,skip_if num_samp_subsets,:_sample_subset,,short! \
shortt cmd make_markerstype_positive_control_eval_file=$markerstype_eval_helper(,markerstype_positive_control_eval_file,marker_sample_filtered_fixed_vcf_file) class_level markerstype runif run_if !add_for_pca

cmd make_cat_marker_positive_control_eval_file=(head -qn+1 !{input,,marker_sample_subset_positive_control_eval_file,limit=1,sort_prop=marker_sample_subset} | head -n1 && tail -qn+2 !{input,,marker_sample_subset_positive_control_eval_file,sort_prop=marker_sample_subset}) | grep -v "\\#" > !{output,,marker_positive_control_eval_file} class_level marker run_if num_samp_subsets run_if !add_for_pca

#eval_parser_cmd=perl $targeted_bin_dir/eval_table_to_delim_file.pl --out-delim ,

#local cmd make_marker_positive_control_genotype_concordance_file=$eval_parser_cmd --analysis-name "GenotypeConcordance" --table-name "detailedStats" < !{input,,marker_positive_control_eval_file} > !{output,,marker_positive_control_genotype_concordance_file} class_level marker

local cmd make_marker_positive_control_genotype_concordance_file=grep -v "\\#" !{input,,marker_positive_control_eval_file} > !{output,,marker_positive_control_genotype_concordance_file} class_level marker

row_col=6

subset_genotype_concordance_file=$smart_cut_cmd !{input,--file,marker_positive_control_genotype_concordance_file} | awk 'NR == 1 {print \"Sample\",\"variable\",\"value\"} NR > 1 {print \\$1,\"n_true_\"\\$3\"_called_\"\\$2,\\$4}'
process_genotype_concordance_file=$smart_cut_cmd --out-delim $tab --exec "$subset_genotype_concordance_file" --select-col 1,1,'Sample variable value' --select-row 1,1 --select-row 1,1,variable,n_true_HET_called_HET --select-row 1,1,variable,n_true_HOM_VAR_called_HOM_VAR --select-row 1,1,variable,n_true_HOM_REF_called_HOM_REF --select-row 1,1,variable,n_true_HET_called_HOM_REF --select-row 1,1,variable,n_true_HET_called_HOM_VAR --select-row 1,1,variable,n_true_HOM_VAR_called_REF --select-row 1,1,variable,n_true_HOM_VAR_called_HET --select-row 1,1,variable,n_true_HOM_REF_called_HOM_VAR --select-row 1,1,variable,n_true_HOM_REF_called_HET --exclude-row 1,1,Sample,^all$

short cmd make_marker_positive_control_genotype_concordance_sum_tex_file=$process_genotype_concordance_file | $table_sum_stats_cmd --has-header --summaries --col value --group-col variable --print-header --out-delim , | $smart_cut_cmd --in-delim , --select-col 0,1,'variable value_mean' | tail -n+2 | sed 's;n_true_HET_called_HET;Het/Het;' | sed 's;n_true_HET_called_HOM_REF;Het/Ref;' | sed 's;n_true_HET_called_HOM_VAR;Het/Hom;' | sed 's;n_true_HOM_REF_called_HET;Ref/Het;' | sed 's;n_true_HOM_REF_called_HOM_REF;Ref/Ref;' | sed 's;n_true_HOM_REF_called_HOM_VAR;Ref/Hom;' | sed 's;n_true_HOM_VAR_called_HET;Hom/Het;' | sed 's;n_true_HOM_VAR_called_HOM_VAR;Hom/Hom;' | $format_columns_cmd --in-delim , --number-format 2,"%.1f" | $add_header_cmd "!{prop,,marker,disp}/Seq,Avg Per Sample" | $table_to_beamer_cmd --row-emph 2 --row-emph 5 --row-emph 9 --in-delim , --header-rows 1 --header-cols 1 --title "!{prop,,marker,disp}" > !{output,,marker_positive_control_genotype_concordance_sum_tex_file} class_level marker

local cmd make_marker_positive_control_genotype_concordance_sum_pdf_file=$run_latex_cmd(marker_positive_control_genotype_concordance_sum_tex_file,marker_positive_control_genotype_concordance_sum_pdf_file) class_level marker

short cmd make_marker_sample_concordance_file=$process_genotype_concordance_file | sed 's/\(n_true_HET_called_HET\|n_true_HOM_VAR_called_HOM_VAR\|n_true_HOM_REF_called_HOM_REF\)\(\s\s*\)\(\S\S*\)$/\1\2\3\2\3\20/' | sed 's/\(n_true_HET_called_HOM_REF\|n_true_HET_called_HOM_VAR\|n_true_HOM_VAR_called_REF\|n_true_HOM_VAR_called_HET\|n_true_HOM_REF_called_HOM_VAR\|n_true_HOM_REF_called_HET\)\(\s\s*\)\(\S\S*\)$/\1\2\3\20\2\3/' | sed '1 s/$/ concordant discordant/' | $table_sum_stats_cmd --out-delim , --totals --col concordant --col discordant --has-header --group-col Sample --print-header | $smart_cut_cmd --in-delim , --select-col 0,1,'Sample concordant_tot discordant_tot' | $add_function_cmd --in-delim , --header 1 --type add --col1 concordant_tot --col2 discordant_tot --val-header "total" | $add_function_cmd --in-delim , --header 1 --type divide --col1 concordant_tot --col2 total --val-header "!{prop,,marker,disp,uc=1}" | $smart_cut_cmd --no-vec-delim --select-col 0,1,Sample --select-col 0,1,"!{prop,,marker,disp,uc=1}" --in-delim , --out-delim $tab > !{output,,marker_sample_concordance_file} class_level marker

local cmd make_marker_sample_full_concordance_file=$smart_cut_cmd --in-delim $tab --exec "tail -n+2 !{input,,marker_sample_concordance_file}" --exec "tail -n+2 !{input,,marker_sample_concordance_file}" | cut -f1 | sort - !{input,,project_passed_sample_list_file} | uniq -u | sed 's/$/\tNA/' | cat !{input,,marker_sample_concordance_file} - > !{output,,marker_sample_full_concordance_file} class_level marker
#files for merging the marker files

prop no_marker=scalar

meta_table cmd make_project_all_marker_plink_list_file=!{input,--bed,marker_filtered_for_merge_bed_file,unless_prop=no_marker,allow_empty=1}\t!{input,--bim,marker_filtered_for_merge_bim_file,unless_prop=no_marker,allow_empty=1}\t!{input,--fam,marker_filtered_for_merge_fam_file,unless_prop=no_marker,allow_empty=1} !{output,project_all_marker_plink_list_file} class_level project run_if marker

meta_table cmd make_project_all_marker_all_merge_list_file=!{input,,marker_filtered_for_merge_bed_file,unless_prop=no_marker,allow_empty=1}\t!{input,,marker_filtered_for_merge_bim_file,unless_prop=no_marker,allow_empty=1}\t!{input,,marker_filtered_for_merge_fam_file,unless_prop=no_marker,allow_empty=1} !{output,project_all_marker_all_merge_list_file,unless_prop=no_marker,allow_empty=1} class_level project run_if marker

local cmd make_project_all_marker_merge_list_file=tail -n+2 !{input,,project_all_marker_all_merge_list_file} > !{output,,project_all_marker_merge_list_file} class_level project run_if marker

cmd make_project_all_marker_plink_file=rm -f !{output,,project_all_marker_bed_file} !{output,,project_all_marker_bim_file} !{output,,project_all_marker_fam_file} && $plink_cmd `head -n1 !{input,,project_all_marker_plink_list_file}` !{input,--merge-list,project_all_marker_merge_list_file} !{input,marker_filtered_for_merge_bed_file} !{input,marker_filtered_for_merge_bim_file} !{input,marker_filtered_for_merge_fam_file} --make-bed $plink_out_bed_helper(project_all_marker) && $plink_mv_log_cmd(!{raw\,\,project\,*project_all_marker_plink_file},!{output\,\,project_all_marker_make_bed_log_file}) class_level project run_if marker rusage_mod $all_marker_mem

#short cmd make_project_all_marker_ld_file=$marker_ld_helper(project_all_marker,project_all_marker_ld_file,project_all_marker_ld_log_file,project) class_level project rusage_mod $all_marker_mem

local cmd make_project_sample_marker_keep_file=$sample_list_to_plink_sample_list(!{input\,--file\,project_passed_sample_list_file},0) > !{output,,project_sample_marker_keep_file} class_level project

prop use_marker_for_sample_ibd=scalar

!|expand:;:name;command;extrarunif:sample;keep;run_if and,marker,use_marker_for_sample_ibd,!project_sample_marker_bed_file,!project_sample_marker_bim_file,!project_sample_marker_fam_file:extra;remove;run_if marker| \
cmd make_project_name_marker_plink_file=rm -f !{output,,project_name_marker_bed_file} !{output,,project_name_marker_bim_file} !{output,,project_name_marker_fam_file} && $plink_cmd $plink_in_bed_helper(project_all_marker) --make-bed $plink_out_bed_helper(project_name_marker) !{input,--command,project_sample_marker_keep_file} && $plink_mv_log_cmd(!{raw\,\,project\,*project_name_marker_plink_file},!{output\,\,project_name_marker_make_bed_log_file}) class_level project extrarunif rusage_mod $all_marker_mem

prop exclude_indels_from_marker=scalar

cmd make_filtered_project_sample_marker_plink_file=rm -f !{output,,project_sample_marker_bed_file} !{output,,project_sample_marker_bim_file} !{output,,project_sample_marker_fam_file} && !{raw,,project,fgrep -v \\# *project_indel_id_site_vcf_file | cut -f3 |,if_prop=exclude_indels_from_marker,allow_empty=1} cat !{raw,,project,/dev/null,unless_prop=exclude_indels_from_marker,allow_empty=1} | $plink_cmd $plink_in_bed_helper(project_plinkseq_qc_plus) --make-bed $plink_out_bed_helper(project_sample_marker) --exclude /dev/stdin && $plink_mv_log_cmd(!{raw;;project;*project_sample_marker_plink_file},!{output;;project_sample_marker_make_bed_log_file}) class_level project rusage_mod $all_marker_mem skip_if or,use_marker_for_sample_ibd,project_sample_marker_bed_file run_if or,var_qc_filter;is_extended_filter,var_qc_filter;is_extended_strict_filter

local cmd ln_project_sample_marker_bed_file=rm -f !{output,,project_sample_marker_bed_file} && ln -s !{input,,project_plinkseq_qc_plus_bed_file} !{output,,project_sample_marker_bed_file} class_level project skip_if or,use_marker_for_sample_ibd,project_sample_marker_bed_file,var_qc_filter;is_extended_filter,var_qc_filter;is_extended_strict_filter

local cmd ln_project_sample_marker_bim_file=rm -f !{output,,project_sample_marker_bim_file} && ln -s !{input,,project_plinkseq_qc_plus_bim_file} !{output,,project_sample_marker_bim_file} class_level project skip_if or,use_marker_for_sample_ibd,project_sample_marker_bim_file,var_qc_filter;is_extended_filter,var_qc_filter;is_extended_strict_filter

local cmd ln_project_sample_marker_fam_file=rm -f !{output,,project_sample_marker_fam_file} && ln -s !{input,,project_plinkseq_qc_plus_fam_file} !{output,,project_sample_marker_fam_file} class_level project skip_if or,use_marker_for_sample_ibd,project_sample_marker_fam_file,var_qc_filter;is_extended_filter,var_qc_filter;is_extended_strict_filter

local cmd make_project_sample_marker_seq_snp_file=cat !{input,,project_sample_marker_bim_file} !{input,,project_plinkseq_qc_plus_bim_file} | awk '{print \$1,\$4,\$2}' | sort -ns -k1,1 -k2,2 | awk '{print \$3,\$1,\$2}' | uniq -d -f1 | awk '{print \$1}' > !{output,,project_sample_marker_seq_snp_file} class_level project

prop has_non_seq=scalar

cmd make_project_sample_non_seq_plink_files=$plink_cmd $plink_in_bed_helper(project_sample_marker) !{input,--exclude,project_sample_marker_seq_snp_file} --make-bed $plink_out_bed_helper(project_sample_non_seq) && $plink_mv_log_cmd(!{raw\,\,project\,*project_sample_non_seq_plink_file},!{output\,\,project_sample_non_seq_make_bed_log_file}) class_level project run_if and,marker,has_non_seq

cmd make_project_sample_combined_plink_files=rm -f !{output,,project_sample_combined_bed_file} !{output,,project_sample_combined_bim_file} !{output,,project_sample_combined_fam_file} && $plink_cmd $plink_in_bed_helper(project_sample_non_seq) !{input,--bmerge,project_plinkseq_qc_plus_bed_file}  !{input,,project_plinkseq_qc_plus_bim_file} !{input,,project_plinkseq_qc_plus_fam_file} --merge-mode 5 --make-bed $plink_out_bed_helper(project_sample_combined) && $plink_mv_log_cmd(!{raw\,\,project\,*project_sample_combined_plink_file},!{output\,\,project_sample_combined_merge_log_file}) class_level project run_if marker

local cmd ln_project_sample_combined_bed_file=rm -f !{output,,project_sample_combined_bed_file} && ln -s !{input,,project_plinkseq_qc_plus_bed_file} !{output,,project_sample_combined_bed_file} class_level project skip_if marker

local cmd ln_project_sample_combined_bim_file=rm -f !{output,,project_sample_combined_bim_file} && ln -s !{input,,project_plinkseq_qc_plus_bim_file} !{output,,project_sample_combined_bim_file} class_level project skip_if marker

local cmd ln_project_sample_combined_fam_file=rm -f !{output,,project_sample_combined_fam_file} && ln -s !{input,,project_plinkseq_qc_plus_fam_file} !{output,,project_sample_combined_fam_file} class_level project skip_if marker


prop marker_autosomes_only=scalar default 1

local cmd make_project_region_exclude_file=$smart_cut_cmd --file /dev/null !{input,--file,project_marker_custom_region_exclude_file,if_prop=project_marker_custom_region_exclude_file,allow_empty=1} !{raw,,project,--exec "echo X 1 1000000000 X && echo Y 1 1000000000 Y",if_prop=marker_autosomes_only,allow_empty=1} > !{output,,project_marker_region_exclude_file} class_level project

prop marker_maf=scalar default .05
prop marker_geno=scalar default .1
prop marker_hwe=scalar default .001

!!expand:projectl:project:pheno! \
projectl_marker_basic_filters=!{prop:--maf:projectl:marker_maf} !{prop:--geno:projectl:marker_geno} !{prop:--hwe:projectl:marker_hwe} --range !{input,--exclude,project_marker_region_exclude_file}

!!expand:projectl:project:pheno! \
projectl_prune_filters=!{input,--extract,projectl_@{1}_marker_ld_prune_in_range_file} --range !{input,--exclude,project_marker_region_exclude_file}

!!expand:project:project:pheno! \
project_marker_filters=$project_marker_basic_filters !{input,--extract,project_@{1}_marker_ld_prune_in_range_file}

prop ld_r2_value=scalar default .2

!!expand:project:project:pheno! \
project_ld_prune_indep_filter=--indep-pairwise 50 5 !{prop,,project,ld_r2_value}

short cmd make_project_sample_marker_input_frq_file=$smart_join_cmd !{input,--file,project_plinkseq_qc_plus_combined_frq_file} --exec "$smart_cut_cmd --out-delim $tab --in-delim , !{input,--file,project_plinkseq_qc_plus_strata_frq_summary_file} --select-col 1,1,SNP --select-col 1,1,MAF_!{prop,,project,marker_strat_maf_summary}" --header 1 --col 1,2 | $smart_cut_cmd --in-delim $tab --select-col 0,1,'CHR SNP A1 A2 MAF_!{prop,,project,marker_strat_maf_summary} NCHROBS' --exact --require-col-match > !{output,,project_sample_marker_input_frq_file} class_level project run_if and,maf_strata_trait,marker_strat_maf_summary

!|expand:;:projectl;type;extrakeep;runif:project;all;;:project;sample;!{input,--read-freq,project_sample_marker_input_frq_file,if_prop=maf_strata_trait,if_prop=marker_strat_maf_summary,allow_empty=1};:pheno;sample;!{input@--keep@pheno_sample_plink_basic_all_include_file} ;skip_if not_trait run_if or,recompute_pca,recompute_genome run_with pheno_variant_subset| \
cmd make_projectl_type_marker_ld_prune_files=$plink_cmd $projectl_marker_basic_filters $plink_in_bed_helper(project_type_marker) $projectl_ld_prune_indep_filter extrakeep !{input,--extract,project_type_marker_ld_prune_restrict_file,if_prop=project_type_marker_ld_prune_restrict_file,allow_empty=1} !{raw,--out,projectl,*projectl_type_marker_plink_file} !{output,projectl_type_marker_ld_prune_in_file} !{output,projectl_type_marker_ld_prune_out_file} && $plink_mv_log_cmd(!{raw\,\,projectl\,*projectl_type_marker_plink_file},!{output\,\,projectl_type_marker_ld_prune_log_file}) class_level projectl rusage_mod $project_plink_mem runif

!!expand:;:projectl;type;runif:project;all;:project;sample;:pheno;sample;run_if or,recompute_genome,recompute_pca! \
local cmd make_projectl_type_marker_ld_prune_in_range_file=$smart_join_cmd !{input,--file,projectl_type_marker_ld_prune_in_file} !{input,--file,project_type_marker_bim_file} --col 2,2 --extra 2 | awk '{print \$2,\$4,\$4,\$1}' > !{output,,projectl_type_marker_ld_prune_in_range_file} class_level projectl runif

short cmd make_project_sample_marker_pruned_plink_files=$plink_cmd $project_marker_filters(sample) $plink_in_bed_helper(project_sample_marker) !{input,--read-freq,project_sample_marker_input_frq_file,if_prop=maf_strata_trait,if_prop=marker_strat_maf_summary,allow_empty=1} --make-bed $plink_out_bed_helper(project_sample_marker_pruned) && $plink_mv_log_cmd(!{raw\,\,project\,*project_sample_marker_pruned_plink_file},!{output\,\,project_sample_marker_pruned_make_bed_log_file}) class_level project rusage_mod $project_plink_mem

#short cmd make_project_extra_marker_pruned_plink_files=cat !{input,,marker_initial_filtered_fam_file,if_prop=add_for_pca,allow_empty=1} | $plink_cmd $project_prune_filters(sample) --keep /dev/stdin $plink_in_bed_helper(project_extra_marker) --make-bed $plink_out_bed_helper(project_extra_marker_pruned) && $plink_mv_log_cmd(!{raw\,\,project\,*project_extra_marker_pruned_plink_file},!{output\,\,project_extra_marker_pruned_make_bed_log_file}) class_level project

make_for_pca_helper=$plink_cmd $plink_in_bed_helper(@{1}) !{input,--bmerge,project_extra_marker_pruned_bed_file} !{input,,project_extra_marker_pruned_bim_file} !{input,,project_extra_marker_pruned_fam_file} --merge-mode 4 @3 --make-bed $plink_out_bed_helper(@{2}_sample_for_pca) && $plink_mv_log_cmd(!{raw\,\,@{2}\,*@{2}_sample_for_pca_plink_file},!{output\,\,@{2}_sample_for_pca_make_bed_log_file})

ln_for_pca_helper=ln -s !{input,,@{1}_bed_file} !{output,,@{2}_sample_for_pca_bed_file} && ln -s !{input,,@{1}_bim_file} !{output,,@{2}_sample_for_pca_bim_file} && ln -s !{input,,@{1}_fam_file} !{output,,@{2}_sample_for_pca_fam_file}

short cmd make_project_sample_for_pca_plink_files=$make_for_pca_helper(project_sample_marker_pruned,project,) class_level project run_if marker;add_for_pca

local cmd ln_project_sample_for_pca_plink_files=$ln_for_pca_helper(project_sample_marker_pruned,project) class_level project skip_if marker;add_for_pca

marker_pruned_initial_vcf_helper=$plink108_cmd !{input,--bed,@{2}_bed_file} !{input,--bim,@{2}_bim_file} !{input,--fam,@{2}_fam_file} --recode-vcf !{raw,--out,@{1},*@{2}_plink_file} && $plink_mv_log_cmd(!{raw\,\,@{1}\,*@{2}_plink_file},!{output\,\,@{2}_recode_vcf_log_file}) && $fix_vcf_file(@{2}_fam_file) < !{raw,,@{1},*@{2}_plink_file.vcf} | $bgzip_cmd > !{output,,@{1}_sample_marker_pruned_initial_vcf_file} && !{raw,,@{1},$run_tabix_cmd(@{1}_sample_marker_pruned_initial_vcf_file)} && rm -f !{raw,,@{1},*@{2}_plink_file.vcf}

short cmd make_project_sample_marker_pruned_initial_vcf_file=$marker_pruned_initial_vcf_helper(project,project_sample_marker_pruned) class_level project rusage_mod $project_plink_mem

marker_pruned_vcf_helper=$gatk_cmd_no_interval(SelectVariants) !{input,--variant,@{1}_sample_marker_pruned_initial_vcf_file} !{output,-o,@{1}_sample_marker_pruned_vcf_file} && !{raw,,@{1},$run_tabix_cmd(@{1}_sample_marker_pruned_vcf_file)}

#need to do this since marker may not be sorted same way as VCF
short cmd make_project_sample_marker_pruned_vcf_file=$marker_pruned_vcf_helper(project) class_level project run_if use_marker_for_sample_ibd

short cmd ln_project_sample_marker_pruned_vcf_file=ln -s !{input,,project_sample_marker_pruned_initial_vcf_file} !{output,,project_sample_marker_pruned_vcf_file} && !{raw,,project,$run_tabix_cmd(project_sample_marker_pruned_vcf_file)} class_level project skip_if use_marker_for_sample_ibd

plink_marker_helper_int=@1 $plink_in_bed_helper(project_sample_marker_pruned)
plink_marker_helper=$plink_marker_helper_int($plink_cmd)
short cmd make_project_sample_marker_frq_file=$plink_marker_helper $plink_analysis_helper(project_sample_marker_frq_file,freq,frq,project_sample_marker_frq_log_file) class_level project


local cmd make_project_sample_subset_sample_marker_genome_list1_file=cat !{input,,project_sample_marker_fam_file} !{input,,project_sample_subset_plinkseq_qc_plus_fam_file} | awk '{print \$1,\$2}' | sort | uniq -d > !{output,,project_sample_subset_sample_marker_genome_list1_file} class_level project_sample_subset run_if parallelize_genome

local cmd make_project_sample_subset_sample_marker_genome_list2_file=cat !{input,,project_sample_subset_sample_marker_genome_list1_file,all_instances=1,if_prop=project_sample_subset:cmp_ge:@project_sample_subset} > !{output,,project_sample_subset_sample_marker_genome_list2_file} class_level project_sample_subset run_if parallelize_genome

prop do_all_genome=scalar

!@expand:;:shortt;projectl;type;runif;exflags;num_samples:;project;sample;run_if or,!num_samp_subsets,!parallelize_genome;;1:short;project_sample_subset;sample;run_if and,num_samp_subsets,parallelize_genome;!{input,--read-freq,project_sample_marker_frq_file} --genome-lists !{input,,project_sample_subset_sample_marker_genome_list1_file} !{input,,project_sample_subset_sample_marker_genome_list2_file};`cat !{input,,project_sample_subset_sample_marker_genome_list1_file} !{input,,project_sample_subset_sample_marker_genome_list2_file} | wc -l`@ \
shortt cmd make_projectl_type_marker_genome_file=if [[ num_samples -gt 0 ]]; then $plink_marker_helper --genome --Z-genome exflags !{raw,--out,projectl,*projectl_type_marker_plink_file} !{output,projectl_type_marker_genome_file} && $plink_mv_log_cmd(!{raw\,\,projectl\,*projectl_type_marker_plink_file},!{output\,\,projectl_type_marker_genome_log_file}); else echo "FID1 IID1 FID2 IID2 RT EZ Z0 1 Z2 PI_HAT PHE DST PPC RATIO" | gzip -c > !{output,,projectl_type_marker_genome_file} && echo > !{output,,projectl_type_marker_genome_log_file} ; fi class_level projectl runif

short cmd make_cat_project_sample_marker_genome_file=zcat !{input,,project_sample_subset_sample_marker_genome_file,sort_prop=project_sample_subset} | awk 'NR==1 {a=\$1; print} NR > 1 && \$1 != a {print}' | gzip -c > !{output,,project_sample_marker_genome_file} class_level project run_if and,num_samp_subsets,parallelize_genome

!!expand:,:project,duplicate:project,duplicate:pheno,related! \
local cmd make_project_custom_duplicate_exclude_rank_file=ln -s !{input,,project_duplicate_exclude_custom_rank_file,if_prop=project_duplicate_exclude_custom_rank_file,allow_empty=1} !{output,,project_duplicate_exclude_rank_file} class_level project run_if and,project_duplicate_exclude_custom_rank_file,!prune_by_call_rate 

local cmd make_project_call_rate_duplicate_exclude_rank_file=$smart_cut_cmd --in-delim , --out-delim $tab !{input,--file,project_sstats_file} --select-col 1,1,'ID RATE' --exclude-row 1,1 > !{output,,project_duplicate_exclude_rank_file} class_level project run_if and,!project_duplicate_exclude_custom_rank_file,prune_by_call_rate 

local cmd make_project_duplicate_exclude_rank_file=$smart_join_cmd --out-delim $tab !{input,--file,project_passed_sample_list_file} --rest-extra 1 --exec "$fill_file_helper(project_duplicate_exclude_custom_rank_file,project_passed_sample_list_file,NA,1,1,1,0)" --exec "$smart_cut_cmd --in-delim , --out-delim $tab !{input,--file,project_sstats_file} --select-col 1,1,'ID RATE' --exclude-row 1,1" > !{output,,project_duplicate_exclude_rank_file} class_level project run_if and,project_duplicate_exclude_custom_rank_file,prune_by_call_rate 

short cmd make_project_duplicate_exclude_file=zcat !{input::project_sample_marker_genome_file} | perl $targeted_bin_dir/prune_most_ibd.pl !{input,--rank-file,project_duplicate_exclude_rank_file,if_prop=project_duplicate_exclude_custom_rank_file,if_prop=prune_by_call_rate,or_if_prop=1,allow_empty=1} !{prop,,project,max_duplicate} > !{output,,project_duplicate_exclude_file} class_level project 


marker_merge_helper=$smart_join_cmd --exec \"@1\" --exec \"sed 's/\$/@2/' !{input,,project_passed_sample_list_file} @3\" --merge @4

local cmd make_project_epacts_ready_file=touch !{output,,project_epacts_ready_file} class_level project

kinship_helper=!{input,@{1}_epacts_ready_file} $epacts_cmd make-kin -restart !{input,--vcf,@{1}_sample_marker_pruned_vcf_file} --min-maf 0 --min-callrate 0 -unit 1000000000 -run 1 !{raw,--out,@{1},*@{1}_epacts_trunk} && mv !{raw,,@{1},*@{1}_epacts_trunk} !{output,,@{1}_kinship_file}

cmd make_project_kinship_file=$kinship_helper(project) class_level project rusage_mod $kin_mem 

prop parallelize_pca=scalar default 1
prop parallelize_genome=scalar default 1

prop max_num_samples_pcs=scalar default 2000
pca_compute_pop=10
pca_ignore_pop=1

local cmd make_project_sample_marker_smart_pca_map_file=cat !{input,,project_sample_marker_fam_file} | awk '{print \$1,\$2,NR,NR}' > !{output,,project_sample_marker_smart_pca_map_file} class_level project

smart_pca_remap_helper_int=perl -lne 'BEGIN {open IN, @5"!{input,,project_sample_marker_smart_pca_map_file}@5" or die @5"Cannot read !{input,,project_sample_marker_smart_pca_map_file}@5"; while (<IN>) {chomp; \@cols = split; @5\$m{@5\$cols[@1]}{@5\$cols[@1+@3]} = [@5\$cols[@2], @5\$cols[@2+@3]];}} chomp; \@cols = split; if (exists @5\$m{@5\$cols[0]}{@5\$cols[0+@3]}) {@5\$value = @5\$m{@5\$cols[0]}{@5\$cols[0+@3]}; @5\$cols[0] = @5\$value->[0]; @5\$cols[0+@3] = @5\$value->[0+@3];} print join(@5"@4@5", \@cols)'

smart_pca_remap_helper=$smart_pca_remap_helper_int(@1,@2,1, ,)

!!expand:projectl:project:pheno! \
projectl_smart_pca_fam_file_helper=ns=`cat !{input,,@1} | wc -l` && cat /dev/null !{input,,marker_initial_filtered_fam_file,if_prop=add_for_pca,allow_empty=1} !{input,,projectl_sample_for_pca_fam_file,unless_prop=parallelize_pca,allow_empty=1} | awk '{print \$2}' | cat - !{input,,@1} | awk -v n=\$ns 'NR == 1 {f=!{prop,,projectl,max_num_samples_pcs}/n} NF == 1 {m[\$1]=1} NF == 6 {if (rand() < f || m[\$2] ) {\$6=$pca_compute_pop} else {\$6 = $pca_ignore_pop}} NF == 6 {print}' 

project_sample_subset_smart_pca_fam_file_helper=cat !{input,,project_sample_subset_clean_samp_keep_file} | $smart_pca_remap_helper_int(1,3,0, ,) | cat - !{input,,@1} | awk 'NF == 1 {m[\$1]=1} NF == 6 && !m[\$2] && \$6 != $pca_compute_pop {\$6=-9} NF == 6 {print}'

local cmd make_project_sample_marker_smart_pca_fam_file=$project_smart_pca_fam_file_helper(project_sample_for_pca_fam_file) | $smart_pca_remap_helper(0,2) > !{output,,project_sample_marker_smart_pca_fam_file} class_level project

local cmd make_project_sample_subset_sample_marker_smart_pca_fam_file=$project_sample_subset_smart_pca_fam_file_helper(project_sample_marker_smart_pca_fam_file) > !{output,,project_sample_subset_sample_marker_smart_pca_fam_file} class_level project_sample_subset

!!expand:,:type:sample! \
local cmd make_project_type_marker_smart_pca_poplist_file=echo $pca_compute_pop > !{output,,project_type_marker_smart_pca_poplist_file} class_level project

!|expand:;:shortt;projects;type;exrunif;rusagemod:;project;sample;skip_if and,num_samp_subsets,parallelize_pca;rusage_mod $smart_pca_mem:short;project_sample_subset;sample;skip_if !parallelize_pca;| \
short cmd make_projects_type_marker_smart_pca_out_files=$smart_pca_cmd !{input,-i,project_type_for_pca_bed_file} !{input,-a,project_type_for_pca_bim_file} !{input,-b,projects_type_marker_smart_pca_fam_file} !{input,-w,project_sample_marker_smart_pca_poplist_file,if_prop=parallelize_pca,allow_empty=1} !{prop,-k,project,num_mds_calc} !{raw,-o,projects,*projects_type_marker_smart_pca_trunk} !{output,projects_type_marker_smart_pca_evec_file} !{output,-e,projects_type_marker_smart_pca_eval_file} !{raw,-p,projects,*projects_type_marker_smart_pca_trunk} !{output,-g,projects_type_marker_smart_pca_weights_file} !{output,-l,projects_type_marker_smart_pca_log_file} -m 0 -t $smart_pca_num_outlier_evec -s $smart_pca_outlier_sigma_thresh class_level projects exrunif

local cmd make_cat_project_sample_marker_smart_pca_eval_file=cp !{input,,project_sample_subset_sample_marker_smart_pca_eval_file,limit=1,sort_prop=project_sample_subset} !{output,,project_sample_marker_smart_pca_eval_file,sort_prop=project_sample_subset} class_level project run_if and,num_samp_subsets,parallelize_pca

evec_to_mds_helper_int=tail -n+2 !{input,,@1} | $smart_cut_cmd --exec @3"echo FID:IID `$get_mds_cols_int(!{prop\,\,@2\,num_mds_calc}, ,\)` 0@3" | sed 's/^\(\S\S*\):\(\S\S*\)\(\s\s*\)/\1\3\2\30\3/' | sed 's/\s\s*/\t/g' | rev | cut -f2- | rev
evec_to_mds_helper=$evec_to_mds_helper_int(@1,@2,,\)

parse_mds_helper=$smart_join_cmd --in-delim $tab --exec "cat !{input,,@{1}_sample_marker_smart_pca_fam_file} | $smart_pca_remap_helper_int(2,0,1, ,\) | awk '{print \\$2}' | cat - !{input,,@2} | sort | uniq -d | sed '1 s/^/IID\n/'" --exec "$evec_to_mds_helper_int(@{1}_sample_marker_smart_pca_evec_file,@1,\) | $smart_pca_remap_helper_int(2,0,1,\\t,\)" --extra 2 --col 2,2 --header 1 | sed 's/^\(\S\S*\)\(\s\s*\)\(\S\S*\)/\3\2\1/'

short cmd parse_project_sample_subset_sample_marker_mds_file=$parse_mds_helper(project_sample_subset,project_sample_subset_clean_samp_keep_file) > !{output,,project_sample_subset_sample_marker_mds_file} class_level project_sample_subset run_if parallelize_pca bsub_batch 10

short cmd parse_project_sample_marker_mds_file=$parse_mds_helper(project,project_passed_sample_list_file) > !{output,,project_sample_marker_mds_file} class_level project run_if or,!parallelize_pca,!num_samp_subsets

#local cmd make_project_strat_mds_file=$smart_join_cmd --exec "sed '/^\\#/d' !{input,,project_plinkseq_strat_phe_file} | $smart_cut_cmd !{input,--file,project_sample_marker_mds_file} --select-col 1,1,IID --exclude-row 1,1 --select-col 0,1 | sort | uniq -d | sed '1 s/^/ID\n/'" --exec "sed 's/^\\#//' !{input,,project_plinkseq_strat_phe_file} | grep -v \\\# | awk -v OFS=\"\t\" 'NR > 1 {if (\\$2==$ibs_cluster_missing) {\\$2=\"Missing\"} else {\\$2=\"Cluster \"\\$2}} {print}'" --exec "$smart_cut_cmd !{input,--file,project_sample_marker_mds_file} --exclude-col 1,1,FID --exclude-col 1,1,SOL" --in-delim 2,$tab --out-delim $tab --header 1 --extra 2 --extra 3 > !{output,,project_strat_mds_file} class_level project

#!!expand:;:type;colsarg:top;--select-col 1,1,'C1 C2':all;--exclude-col 1,1-3! \
#local cmd make_project_type_strat_mds_pdf_file=$draw_matrix_plot_cmd !{input,,project_strat_mds_file} !{output,,project_type_strat_mds_pdf_file} 'Sample MDS Values: by IBS cluster' `$smart_cut_cmd !{input,--file,project_sample_marker_mds_file} --select-row 1,1 colsarg --out-delim ,` color.col=$ibs_cluster_pheno sep=$tab cex=$mds_cex class_level project

min_neighbor=1
prop max_neighbor=scalar default 5

#pheno cmds

display_col_name=Display
order_col_name=Order

#keys for on-the-fly dichotomization of a quantitative trait

#for plots (everyone assigned a phenotype
qt_missing_disp=Missing
qt_bottom_disp=Below !{prop,,pheno,med_quantile,missing_key=default_med_quantile}q
qt_top_disp=Above !{prop,,pheno,med_quantile,missing_key=default_med_quantile}q

qt_missing_order=2
qt_bottom_order=1
qt_top_order=0

prop med_quantile=scalar
default_med_quantile=.5

#for associations (extremes)
prop low_quantile=scalar
default_low_quantile=.2
prop high_quantile=scalar
default_high_quantile=.8

qt_low_disp=Below !{prop,,pheno,low_quantile,missing_key=default_low_quantile}q
qt_high_disp=Above !{prop,,pheno,high_quantile,missing_key=default_high_quantile}q

#specify the phenotype to use in association analysis for the meta analysis
prop meta_trait=scalar
prop meta_trait_inv=list
#specify which phenotype to use to stratify samples
prop meta_strata=scalar
#specify the specific value of the meta_strata trait that samples must have
prop meta_strata_value=scalar

local cmd make_pheno_is_trait_file=touch !{output,,pheno_is_trait_file} class_level pheno skip_if not_trait

local cmd make_pheno_ucsc_tracks_file=(echo '[visual_options]' && echo && echo '[custom_tracks]' && echo && echo '[tracks]' && echo 'wgRna=hide' && echo 'wgEncodeReg=show' && echo 'cpgIslandExt=hide' && echo 'ensGene=hide' && echo 'mrna=show' && echo 'intronEst=hide' && echo 'mgcGenes=hide' && echo 'cons44way=show' && echo 'snp130=hide' && echo 'snpArray=hide' && echo 'refGene=hide' && echo 'wgEncodeRegMarkPromoter=full' && echo 'knownGene=full' && echo 'rmsk=hide' && echo 'phyloP46wayPlacental=show') > !{output,,pheno_ucsc_tracks_file} class_level pheno skip_if not_trait

local cmd make_pheno_ucsc_browser_file=(echo '[browser]' && echo 'ucsc_base_url = http://genome.ucsc.edu/cgi-bin/hgTracks?db=hg$hg_build' && echo 'username =' && echo 'query_interval = 0' && echo 'password =' && echo 'user-agent = Mechanize client to get screenshots from the UCSC browser. Home' && echo 'page: https://bitbucket.org/dalloliogm/ucsc-fetch' && echo "email = `whoami`@broadinstitute.org" && echo 'httpproxy =' && echo 'httproxy_port =' && echo 'httproxy_password =') > !{output,,pheno_ucsc_browser_file} class_level pheno skip_if not_trait

#!|expand:;:dott;tag;ext:.1;1;:.{1..!{prop,,pheno,expand_pheno_subsets}};{1..!{prop,,pheno,expand_pheno_subsets}};_mult:;1;_burden| \
#!|expand:;:dott;tag;ext:;1;_burden| \
#pheno_subset_meta_file_helperext=egrep "class @{3}_@{1}_subset$" !{input,,@{3}_@{3}_@{1}_subset_meta_file} | sed 's/^\(!{prop,,@{3}}_@{1}_subset_\(\S\S*\)\).*/\1 !{prop,,@{2}}_@{1}_subset_\2 \2/' | sed 's/^\(\S\S*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)/\2dott class @{2}_@{1}_subset\n\2dott parent !{prop,,@{2}}\n\2dott disp !{prop,,@{2},disp} @{1} subset \3dott\n\2dott consistent \1\n\2dott expand_subset tag/' > !{output,,@{2}_@{2}_@{1}_subset_meta_file}

#!|expand:;:tag;excomp:;eq:_mult;gt| \
#local cmd make_pheno_pheno_variant_subsettag_meta_file=$pheno_subset_meta_file_helpertag(variant,pheno,project) class_level pheno run_if and,num_var_subsets,expand_pheno_subsets:excomp:1 skip_if not_trait

local cmd make_pheno_pheno_variant_qc_strata_meta_file=cut -f2 !{input,,pheno_non_missing_sample_pheno_file} | sort -u !{raw::pheno:| $smart_cut_cmd --exclude-row 0,1,:if_prop=ignore_pheno_value_for_strata:allow_empty=1}!{prop::pheno:ignore_pheno_value_for_strata:sep= --exclude-row 0,1,:if_prop=ignore_pheno_value_for_strata:allow_empty=1} !{raw::pheno:| $smart_cut_cmd --select-row 0,1,:if_prop=only_pheno_value_for_strata:allow_empty=1}!{prop::pheno:only_pheno_value_for_strata:sep= --select-row 0,1,:if_prop=only_pheno_value_for_strata:allow_empty=1} | sed 's/\(..*\)/!{prop,,pheno}_strata_\1\t\1/' | sed 's/\([^\t][^\t]*\)\t\([^\t][^\t]*\)/\1 class pheno_variant_qc_strata\n!select:!{prop,,project} \1 parent !{prop,,pheno}\n\1 disp QC \2\n\1 meta_strata_value \2/' > !{output,,pheno_pheno_variant_qc_strata_meta_file} class_level pheno with project,pheno_variant_qc_strata run_if and,(or,qc_strata_trait,maf_strata_trait:eq:@pheno),!pheno_qt

local cmd make_empty_pheno_pheno_variant_qc_strata_meta_file=echo > !{output,,pheno_pheno_variant_qc_strata_meta_file} class_level pheno with project run_if or,(and,!qc_strata_trait,!maf_strata_trait:eq:@pheno),pheno_qt

qc_strata_subset_meta_file_helper=egrep "class project_@{1}_subset$" !{input,,project_project_@{1}_subset_meta_file} | sed 's/^\(!{prop,,project}_@{1}_subset_\(\S\S*\)\).*/\1 !{prop,,@{2}}_@{1}_subset_\2 \2/' | sed 's/^\(\S\S*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)/\2 class @{2}_@{1}_subset\n!select:!{prop,,project}:!{prop,,pheno} \2 parent !{prop,,@{2}}\n\2 disp !{prop,,@{2},disp} @{1} subset \3\n\2 sort \3\n\2 consistent \1@3/' > !{output,,@{2}_@{2}_@{1}_subset_meta_file}

local cmd make_pheno_variant_qc_strata_pheno_variant_qc_strata_variant_subset_meta_file=$qc_strata_subset_meta_file_helper(variant,pheno_variant_qc_strata,\n\2 var_subset_num \3) class_level pheno_variant_qc_strata run_if num_var_subsets

!!expand:pheno_variant_qc_strata:pheno_variant_qc_strata:pheno_variant_qc_pheno_strata! \
local cmd make_pheno_variant_qc_strata_sample_include_file=$smart_join_cmd --exec "$smart_cut_cmd --in-delim $tab !{input,--file,pheno_non_missing_sample_pheno_file} --select-row 1,2,eq:!{prop,,pheno_variant_qc_strata,meta_strata_value} --select-col 1,1 | sort -u | cat - !{input,,project_sample_include_file} | sort | uniq -d" !{input,--file,project_plinkseq_qc_pass_renamed_tfam_file} --col 2,2 --extra 2 | awk '{print \$2,\$1}' > !{output,,pheno_variant_qc_strata_sample_include_file} class_level pheno_variant_qc_strata

!|expand:,:pheno_variant_qc_stratat,projectt,projecte,skipif:pheno_variant_qc_strata,project,,skip_if num_var_subsets:pheno_variant_qc_strata_variant_subset,project_variant_subset,_project_variant_subset,skip_if !num_var_subsets bsub_batch 20| \
!!expand:,:typef,typea,typeo,_typeu,runif:lmiss,missing,lmiss,,:lmiss,missing,lmiss,_unthresholded,:hwe,hardy,hwe,,:frq,freq --nonfounders,frq,,run_if compute_popgen:het,het,het,,run_if compute_popgen! \
short cmd make_pheno_variant_qc_stratat_typeu_typef_file=$plink_qc_pass_typeu_bed_cmdprojecte $plink_analysis_helper_template(pheno_variant_qc_stratat_typeu_typef_file,typea --allow-no-sex !{input;--keep;pheno_variant_qc_strata_sample_include_file},typeo,pheno_variant_qc_stratat_typeu_typef_log_file,pheno_variant_qc_stratat) class_level pheno_variant_qc_stratat skipif runif


!!expand;@;_unthresholded@maskk;_unthresholded@;@-condition_on:$thresholded_nalt_field! \
!|expand:,:pheno_variant_qc_stratat,projectt:pheno_variant_qc_strata,project:pheno_variant_qc_strata_variant_subset,project_variant_subset| \
pheno_variant_qc_stratat_multiallelic_unthresholded_qc_helper1=$multiallelic_qc_cmd !{input,,@{1}_sample_include_file} -spl_field:2 -out:!{output,,@{2}_multiallelic_unthresholded_stats_file} maskk -var_mask:"file=$pseq_multiallelic_tag reg.ex=$chrX; reg=$chrX" -pseq_project:!{input,,projectt_plinkseq_project_file} !{input,-pheno_file:,pheno_non_missing_sample_pheno_file,if_prop=pheno:eq:sex,allow_empty=1,all_instances=1,if_prop=project:eq:\@project,max=1,instance_level=pheno,sep=} !{raw,,pheno,-pheno_field:2 -pheno_id_field:1 -pheno_sel:eq$plink_female,if_prop=pheno:eq:sex,allow_empty=1,all_instances=1,if_prop=project:eq:\@project,max=1} -chrX_code:$chrX 

!!expand:_unthresholded:_unthresholded:! \
!|expand:,:pheno_variant_qc_stratat,projectt:pheno_variant_qc_strata,project:pheno_variant_qc_strata_variant_subset,project_variant_subset| \
pheno_variant_qc_stratat_multiallelic_unthresholded_qc_helper=$pheno_variant_qc_stratat_multiallelic_unthresholded_qc_helper1(pheno_variant_qc_strata,pheno_variant_qc_stratat)

!!expand:_unthresholded:_unthresholded:! \
!|expand:,:pheno_variant_qc_pheno_stratat,pheno_variant_qc_stratat,projectt:pheno_variant_qc_pheno_strata,pheno_variant_qc_strata,project:pheno_variant_qc_pheno_strata_variant_subset,pheno_variant_qc_strata_variant_subset,project_variant_subset| \
pheno_variant_qc_pheno_stratat_multiallelic_unthresholded_qc_helper=$pheno_variant_qc_stratat_multiallelic_unthresholded_qc_helper1(pheno_variant_qc_pheno_strata,pheno_variant_qc_pheno_stratat) -m_group_file:!{input,,pheno_variant_qc_pheno_strata_sample_phe_file} -m_group_field:3 -m_id_field:2 -m_group_missing:$plink_missing

!!expand:_unthresholded:_unthresholded:! \
!|expand:,:pheno_variant_qc_stratat,projectt,projecte,skipif:pheno_variant_qc_strata,project,,skip_if num_var_subsets:pheno_variant_qc_strata_variant_subset,project_variant_subset,_project_variant_subset,skip_if !num_var_subsets bsub_batch 30| \
short cmd make_pheno_variant_qc_stratat_multiallelic_unthresholded_stats_file=$pheno_variant_qc_stratat_multiallelic_unthresholded_qc_helper class_level pheno_variant_qc_stratat skipif

local cmd make_pheno_variant_qc_pheno_strata_pheno_variant_qc_pheno_strata_variant_subset_meta_file=$qc_strata_subset_meta_file_helper(variant,pheno_variant_qc_pheno_strata,\n\2 var_subset_num \3) class_level pheno_variant_qc_pheno_strata run_if num_var_subsets

local cmd make_pheno_variant_qc_pheno_strata_sample_phe_file=$smart_join_cmd --exec "cat !{input,,pheno_variant_qc_pheno_strata_sample_include_file} !{input,,pheno_non_missing_sample_pheno_file,all_instances=1,if_prop=project:eq:@project,if_prop=pheno:eq:@pheno_strata,instance_level=pheno} | awk '{print \\$1}' | sort | uniq -d" !{input,--file,pheno_variant_qc_pheno_strata_sample_include_file} !{input,--file,pheno_non_missing_sample_pheno_file,all_instances=1,if_prop=project:eq:@project,if_prop=pheno:eq:@pheno_strata,instance_level=pheno} --rest-extra 1 --col 2,2 | awk '{print \$2,\$1,\$3}' > !{output,,pheno_variant_qc_pheno_strata_sample_phe_file} class_level pheno_variant_qc_pheno_strata

!!expand:,:pheno_variant_qc_pheno_stratat,projectt,projecte,skipif:pheno_variant_qc_pheno_strata,project,,skip_if num_var_subsets:pheno_variant_qc_pheno_strata_variant_subset,project_variant_subset,_project_variant_subset,run_if num_var_subsets bsub_batch 20! \
!!expand:,:typef,typea,typeo,_typeu:p_missing,test-missing,missing,:p_missing,test-missing,missing,_unthresholded! \
short cmd make_pheno_variant_qc_pheno_stratat_typeu_typef_file=$plink_qc_pass_typeu_bed_cmdprojecte $plink_analysis_helper_template(pheno_variant_qc_pheno_stratat_typeu_typef_file,typea --allow-no-sex !{input;--keep;pheno_variant_qc_pheno_strata_sample_include_file} !{input;--pheno;pheno_variant_qc_pheno_strata_sample_phe_file},typeo,pheno_variant_qc_pheno_stratat_typeu_typef_log_file,pheno_variant_qc_pheno_stratat) class_level pheno_variant_qc_pheno_stratat skipif

!!expand:,:_unthresholded:_unthresholded:! \
!!expand:,:pheno_variant_qc_pheno_stratat,projectt,projecte,skipif:pheno_variant_qc_pheno_strata,project,,skip_if num_var_subsets:pheno_variant_qc_pheno_strata_variant_subset,project_variant_subset,_project_variant_subset,run_if num_var_subsets bsub_batch 30! \
short cmd make_pheno_variant_qc_pheno_stratat_multiallelic_unthresholded_stats_file=$pheno_variant_qc_pheno_stratat_multiallelic_unthresholded_qc_helper class_level pheno_variant_qc_pheno_stratat skipif

!!expand:,:typef:lmiss:unthresholded_lmiss:hwe:multiallelic_stats:multiallelic_unthresholded_stats:vstats! \
short cmd cat_pheno_variant_qc_strata_typef_file=(head -qn+1 !{input,,pheno_variant_qc_strata_variant_subset_typef_file,limit=1,sort_prop=pheno_variant_qc_strata_variant_subset} | head -n1 && tail -qn+2 !{input,,pheno_variant_qc_strata_variant_subset_typef_file,sort_prop=pheno_variant_qc_strata_variant_subset}) > !{output,,pheno_variant_qc_strata_typef_file} class_level pheno_variant_qc_strata run_if num_var_subsets

!!expand:,:typef:p_missing:unthresholded_p_missing:multiallelic_stats:multiallelic_unthresholded_stats:vstats! \
short cmd cat_pheno_variant_qc_pheno_strata_typef_file=(head -qn+1 !{input,,pheno_variant_qc_pheno_strata_variant_subset_typef_file,limit=1,sort_prop=pheno_variant_qc_pheno_strata_variant_subset} | head -n1 && tail -qn+2 !{input,,pheno_variant_qc_pheno_strata_variant_subset_typef_file,sort_prop=pheno_variant_qc_pheno_strata_variant_subset}) > !{output,,pheno_variant_qc_pheno_strata_typef_file} class_level pheno_variant_qc_pheno_strata run_if num_var_subsets

!!expand:,:pheno_variant_qc_stratat:pheno_variant_qc_strata:pheno_variant_qc_strata_variant_subset! \
pheno_variant_qc_stratat_multiallelic_vstats_helper=$smart_cut_cmd --out-delim $tab !{input,--file,pheno_variant_qc_stratat_multiallelic@{1}_stats_file} --select-col 1,1,'SNP pval call_rate' --exact | $add_function_cmd --col1 pval --type minus_log --header 1 --val-header LOG_P_HWE@2 --in-delim $tab | $smart_cut_cmd --in-delim $tab --exclude-col 0,1,pval --exact | $add_function_cmd --val1 1 --col1 call_rate --type subtract --header 1 --val-header F_MISS@2 --in-delim $tab | $smart_cut_cmd --in-delim $tab --exclude-col 0,1,call_rate --exact

!!expand:,:pheno_variant_qc_stratat,projectt,projecte,skipif:pheno_variant_qc_strata,project,,skip_if num_var_subsets:pheno_variant_qc_strata_variant_subset,project_variant_subset,_project_variant_subset,run_if num_var_subsets bsub_batch 20! \
short cmd make_pheno_variant_qc_stratat_vstats_file=$smart_join_cmd --in-delim $tab --header 1 --merge --exec "$smart_join_cmd --in-delim $tab --header 1 --exec \"$smart_cut_cmd --out-delim $tab !{input,--file,pheno_variant_qc_stratat_multiallelic_stats_file} --select-col 1,1,'id pval call_rate' --exact --require-col-match | $add_function_cmd --col1 pval --type minus_log --header 1 --val-header LOG_P_HWE --in-delim $tab | $smart_cut_cmd --in-delim $tab --exclude-col 0,1,pval --exact | $add_function_cmd --val1 1 --col2 call_rate --type subtract --header 1 --val-header F_MISS --in-delim $tab | $smart_cut_cmd --in-delim $tab --exclude-col 0,1,call_rate --exact\" --exec \"$smart_cut_cmd --out-delim $tab !{input,--file,pheno_variant_qc_stratat_multiallelic_unthresholded_stats_file} --select-col 1,1,'id call_rate' --exact --require-col-match | $add_function_cmd --val1 1 --col2 call_rate --type subtract --header 1 --val-header F_MISS_UNTHRESH --in-delim $tab | $smart_cut_cmd --in-delim $tab --exclude-col 0,1,call_rate --exact\" | $smart_cut_cmd --in-delim $tab --select-col 0,1 --select-col 0,1,'LOG_P_HWE F_MISS F_MISS_UNTHRESH' --exact --require-col-match | sed '1 s/^\S\S*/SNP/' | sed '1 s/\t\(\S\S*\)/\t\1_!{prop,,pheno_variant_qc_strata,meta_strata_value}/g'" --exec "$smart_join_cmd --in-delim $tab --header 1 --exec \"$smart_cut_cmd --out-delim $tab !{input,--file,pheno_variant_qc_stratat_lmiss_file} --select-col 1,1,'SNP F_MISS' --exact\" --exec \"$smart_cut_cmd --out-delim $tab !{input,--file,pheno_variant_qc_stratat_hwe_file} --select-col 1,1,'SNP P' --select-row 1,1 --select-row 1,1,TEST,ALL --exact | $add_function_cmd --col1 P --type minus_log --header 1 --val-header LOG_P_HWE --in-delim $tab | $smart_cut_cmd --in-delim $tab --exclude-col 0,1,P --exact\" --exec \"$smart_cut_cmd --out-delim $tab !{input,--file,pheno_variant_qc_stratat_unthresholded_lmiss_file} --select-col 1,1,'SNP F_MISS' --exact | sed 's/F_MISS/F_MISS_UNTHRESH/'\" | $smart_cut_cmd --in-delim $tab --select-col 0,1 --select-col 0,1,'LOG_P_HWE F_MISS F_MISS_UNTHRESH' --exact --require-col-match | sed '1 s/\t\(\S\S*\)/\t\1_!{prop,,pheno_variant_qc_strata,meta_strata_value}/g'" --exec "cut -f1 !{input,,projectt_vfreq_file} | $parse_out_id | sed 's/$/\tNA\tNA\tNA/'" | $replace_nan(NA) > !{output,,pheno_variant_qc_stratat_vstats_file} class_level pheno_variant_qc_stratat skipif


!|expand%;%phenol;projectl;pheno_variant_qc_stratat;skipif;extraifprop%pheno;project;pheno_variant_qc_strata;skip_if num_var_subsets;%pheno_variant_subset;project_variant_subset;pheno_variant_qc_strata_variant_subset;skip_if !num_var_subsets bsub_batch 5 consistent_prop var_subset_num;,if_prop=var_subset_num:eq:@var_subset_num| \
short cmd make_phenol_variant_qc_strata_vstats_summary_file=(head -n1 !{input,,pheno_variant_qc_stratat_vstats_fileextraifprop,limit=1} && tail -qn+2 !{input,,pheno_variant_qc_stratat_vstats_file,unless_prop=meta_strata_value:eq:@ignore_pheno_value_for_strata_summaryextraifprop}) | $smart_cut_cmd --in-delim $tab --select-col 0,1,'SNP F_MISS_UNTHRESH F_MISS LOG_P_HWE' --require-col-match | sed '1 s/.*/SNP\tF_MISS_UNTHRESH\tF_MISS\tLOG_P_HWE/' | $table_sum_stats_cmd --in-delim $tab --out-delim $tab --has-header --print-header --col F_MISS --col F_MISS_UNTHRESH --col LOG_P_HWE --group-col SNP --summaries --na-output NA | $smart_cut_cmd --tab-delim --select-col 0,1,'SNP F_MISS_max F_MISS_UNTHRESH_max LOG_P_HWE_max' | sed '1 s/\t\(\S\S*\)/\t\1_!{prop,,pheno}/g' > !{output,,phenol_variant_qc_strata_vstats_summary_file} class_level phenol skipif run_if qc_strata_trait with projectl

!!expand:,:pheno_variant_qc_pheno_stratat,projectt,projecte,skipif:pheno_variant_qc_pheno_strata,project,,skip_if num_var_subsets:pheno_variant_qc_pheno_strata_variant_subset,project_variant_subset,_project_variant_subset,run_if num_var_subsets bsub_batch 20! \
short cmd make_pheno_variant_qc_pheno_stratat_vstats_file=$smart_join_cmd --in-delim $tab --header 1 --merge --exec "$smart_join_cmd --in-delim $tab --header 1 --exec \"$smart_cut_cmd --out-delim $tab !{input,--file,pheno_variant_qc_pheno_stratat_multiallelic_stats_file} --select-col 1,1,'id pval' --exact\" --exec \"$smart_cut_cmd --out-delim $tab !{input,--file,pheno_variant_qc_pheno_stratat_multiallelic_unthresholded_stats_file} --select-col 1,1,'id pval' --exact\" | sed '1 s/.*/SNP\tP_MISSING\tP_MISSING_UNTHRESH/' | sed '1 s/\t\(\S\S*\)/\t\1_!{prop,,pheno_variant_qc_pheno_strata,meta_strata_value}_!{prop,,pheno_variant_qc_pheno_strata,pheno_strata}/g'" --exec "$smart_join_cmd --in-delim $tab --header 1 --exec \"$smart_cut_cmd --out-delim $tab !{input,--file,pheno_variant_qc_pheno_stratat_p_missing_file} --select-col 1,1,'SNP P' --exact\" --exec \"$smart_cut_cmd --out-delim $tab !{input,--file,pheno_variant_qc_pheno_stratat_unthresholded_p_missing_file} --select-col 1,1,'SNP P' --exact\"" --exec "cut -f1 !{input,,projectt_vfreq_file} | $parse_out_id | sed 's/$/\tNA\tNA/'" | $replace_nan(NA) > !{output,,pheno_variant_qc_pheno_stratat_vstats_file} class_level pheno_variant_qc_pheno_stratat skipif

!|expand%;%phenol;pheno_variant_qc_pheno_stratat;runif;extraifprop%pheno;pheno_variant_qc_pheno_strata;run_if !num_var_subsets;%pheno_variant_subset;pheno_variant_qc_pheno_strata_variant_subset;run_if num_var_subsets bsub_batch 5 consistent_prop var_subset_num;,if_prop=var_subset_num:eq:@var_subset_num| \
short cmd make_phenol_variant_qc_pheno_strata_vstats_summary_file=(head -n1 !{input,,pheno_variant_qc_pheno_stratat_vstats_fileextraifprop,limit=1} && tail -qn+2 !{input,,pheno_variant_qc_pheno_stratat_vstats_fileextraifprop}) | $smart_cut_cmd --in-delim $tab --select-col 0,1,'SNP P_MISSING_UNTHRESH P_MISSING' --require-col-match | sed '1 s/.*/SNP\tP_MISSING_UNTHRESH\tP_MISSING/' | $table_sum_stats_cmd --in-delim $tab --out-delim $tab --has-header --print-header --col P_MISSING --col P_MISSING_UNTHRESH --group-col SNP --summaries --na-output NA | $smart_cut_cmd --tab-delim --select-col 0,1,'SNP P_MISSING_min P_MISSING_UNTHRESH_min' | sed '1 s/\t\(\S\S*\)/\t\1_!{prop,,pheno}/g' > !{output,,phenol_variant_qc_pheno_strata_vstats_summary_file} class_level phenol runif skip_if or,!qc_strata_trait,!pheno_stratas

prop ignore_pheno_value_for_strata=list
prop only_pheno_value_for_strata=list
prop ignore_pheno_value_for_strata_summary=list

local cmd make_pheno_pheno_variant_qc_pheno_strata_meta_file=for t in `$smart_cut_cmd --exec "echo !{prop,,pheno,pheno_stratas} | sed 's/\s\s*/\n/g' | sort -u" --exec "echo !{prop,,pheno,all_instances=1,if_prop=project:eq:@project,unless_prop=pheno_qt} | sed 's/\s\s*/\n/g'" | sort | uniq -d`; do cut -f2 !{input,,pheno_non_missing_sample_pheno_file} | sort -u !{raw::pheno:| $smart_cut_cmd --exclude-row 0,1,:if_prop=ignore_pheno_value_for_strata:allow_empty=1}!{prop::pheno:ignore_pheno_value_for_strata:sep= --exclude-row 0,1,:if_prop=ignore_pheno_value_for_strata:allow_empty=1} !{raw::pheno:| $smart_cut_cmd --select-row 0,1,:if_prop=only_pheno_value_for_strata:allow_empty=1}!{prop::pheno:only_pheno_value_for_strata:sep= --select-row 0,1,:if_prop=only_pheno_value_for_strata:allow_empty=1} | sed 's/\(..*\)/!{prop,,pheno}_'\$t'_strata_\1\t\1/' | sed 's/\([^\t][^\t]*\)\t\([^\t][^\t]*\)/\1 class pheno_variant_qc_pheno_strata\n!select:!{prop,,project} \1 parent !{prop,,pheno}\n\1 disp QC \2\n\1 meta_strata_value \2\n\1 pheno_strata '\$t'/'; done > !{output,,pheno_pheno_variant_qc_pheno_strata_meta_file} class_level pheno with project,pheno_variant_qc_pheno_strata run_if and,qc_strata_trait,!pheno_qt,pheno_stratas


local cmd make_empty_pheno_pheno_variant_qc_pheno_strata_meta_file=echo > !{output,,pheno_pheno_variant_qc_pheno_strata_meta_file} class_level pheno with project,pheno_variant_qc_pheno_strata run_if or,!qc_strata_trait,pheno_qt,!pheno_stratas

#local cmd make_pheno_pheno_variant_subset_meta_file=cat !{input,,project_project_variant_subset_pheno_expand_subset_file} | awk '{n = \$2} \$2 > 1 {n = "{1.."\$2"}"} {print \$1,n,\$2}' | sed 's/^\(\S\S\*_subset_\(\S\S*\)\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)/\1 !{prop,,pheno}_variant_subset_\2.\3 \2 \3 \4/' | sed 's/\(\S\S*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)/\1 expand_pheno_subsets \5\n\2 class pheno_variant_subset\n!select:!{prop,,project} \2 parent !{prop,,pheno}\n\2 disp !{prop,,pheno,disp} variant subset \3.\4\n\2 consistent \1\n\2 var_subset_num \3\n\2 expand_subset_num \4/' > !{output,,pheno_pheno_variant_subset_meta_file} class_level pheno skip_if not_trait with pheno_variant_subset run_if num_var_subsets

local cmd make_pheno_pheno_variant_subset_meta_file=cat !{input,,project_project_variant_subset_pheno_expand_subset_file} | awk '{n = \$2} \$2 > 1 {n = "{1.."\$2"}"} {print \$1,n,\$2}' | sed 's/^\(\S\S\*_subset_\(\S\S*\)\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)/\1 !{prop,,pheno}_variant_subset_\2.\3 \2 \3 \4/' | perl -lane 'BEGIN {@ex = qw(!{prop,,pheno,empty_clean_subsets,missing=}); map {\$ex{\$_}=1} @ex} print unless \$ex{\$F[2]}' | sed 's/\(\S\S*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)/\1 expand_pheno_subsets \5\n\2 class pheno_variant_subset\n!select:!{prop,,project} \2 parent !{prop,,pheno}\n\2 disp !{prop,,pheno,disp} variant subset \3.\4\n\2 consistent \1\n\2 var_subset_num \3\n\2 expand_subset_num \4/' > !{output,,pheno_pheno_variant_subset_meta_file} class_level pheno skip_if and,not_trait,!qc_strata_trait with pheno_variant_subset run_if and,num_var_subsets,project_variant_subset

local cmd make_empty_pheno_pheno_variant_subset_meta_file=echo > !{output,,pheno_pheno_variant_subset_meta_file} class_level pheno with pheno_variant_subset run_if or,(and,not_trait,!qc_strata_trait),!num_var_subsets,!project_variant_subset

local cmd make_pheno_pheno_sample_subset_meta_file=egrep "class project_sample_subset$" !{input,,project_project_sample_subset_meta_file} | sed 's/^\(!{prop,,project}_sample_subset_\(\S\S*\)\).*/\1 !{prop,,pheno}_sample_subset_\2 \2/' | sed 's/^\(\S\S*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)/\2 class pheno_sample_subset\n!select:!{prop,,project} \2 parent !{prop,,pheno}\n!select:!{prop,,project} \2 disp !{prop,,pheno,disp} sample subset \3\n\2 consistent \1/' > !{output,,pheno_pheno_sample_subset_meta_file} class_level pheno run_if or,num_samp_subsets,parallelize_genome,parallelize_pca skip_if not_trait

local cmd make_empty_pheno_pheno_sample_subset_meta_file=echo > !{output,,pheno_pheno_sample_subset_meta_file} class_level pheno skip_if not_trait with pheno_sample_subset run_if and,!num_samp_subsets,!parallelize_genome,!parallelize_pca

pheno_test_variant_subset_name=!{prop,,pheno}_test_variant_subset

local cmd make_pheno_pheno_test_variant_subset_meta_file=if [[ "!{prop;;pheno_test;sep=,;if_prop=num_var_subsets;unless_prop=test_software:eq:metal;unless_prop=test_software:eq:metasoft;allow_empty=1,sort=pheno_test}" ]]; then egrep "class pheno_variant_subset$" !{input,,pheno_pheno_variant_subset_meta_file} | sed 's/^\(!{prop,,pheno}_variant_subset_\([^\.][^\.]*\)\.\(\S\S*\)\).*/\1 ${pheno_test_variant_subset_name}_\2.\3 \2 \3/' | sed 's/^\(\S\S*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)/\2 class pheno_test_variant_subset\n!expand_all !select:!{prop;;project}:!{prop;;pheno} \2 parent {!{prop;;pheno_test;sep=,;if_prop=num_var_subsets;unless_prop=test_software:eq:metal;unless_prop=test_software:eq:metasoft;allow_empty=1}}\n\2 disp !{prop,,pheno,disp} test variant subset \3.\4\n\2 consistent \1\n\1 consistent \2\n\2 var_subset_num \3\n\2 expand_subset_num \4/' | sed 's/{\([^,\.}][^,\.}]*\)}/\1/g' > !{output,,pheno_pheno_test_variant_subset_meta_file} && awk '\$2 == "consistent"' !{input,,pheno_pheno_variant_subset_meta_file} | sed 's/^\(!{prop,,pheno}_variant_subset_\(\S\S*\)\)/${pheno_test_variant_subset_name}_\2/' >> !{output,,pheno_pheno_test_variant_subset_meta_file}; else echo > !{output,,pheno_pheno_test_variant_subset_meta_file}; fi class_level pheno run_if and,num_var_subsets,pheno_test skip_if not_trait with pheno_test_variant_subset

local cmd make_empty_pheno_pheno_test_variant_subset_meta_file=rm -f !{output,,pheno_pheno_test_variant_subset_meta_file} && touch !{output,,pheno_pheno_test_variant_subset_meta_file} class_level pheno run_if and,num_var_subsets,!pheno_test skip_if not_trait with pheno_test_variant_subset

burden_variant_subset_name=!{prop,,pheno}_!{prop,,burden}_variant_subset
burden_test_variant_subset_name=!{prop,,pheno}_!{prop,,burden}_test_variant_subset

filter_pheno_subsets_to_use=sed 's/^\(!{prop,,pheno}_variant_subset_\([^\.][^\.]*\)\.\(\S\S*\)\)\(.*\)/\1 \4 \2 \3/' !{raw::burden:| perl -pe 'END {\$ex \= "@exclude_subset"; \$ex \=~ s/([0-9]+)([^0-9]+)([0-9]+)(\s|$)/\1 \3\n/; print \$ex;}' | awk 'NF \=\= 2 {print "X","X","X",\$0} NF > 2 {print \$0}' | sort -s -k4,4 -k5,5 | uniq -f3 -u:if_prop=exclude_subset:allow_empty=1} | awk '{print \$1,\$2,\$3}'

local cmd make_burden_burden_variant_subset_meta_file=egrep "class pheno_variant_subset$" !{input,,pheno_pheno_variant_subset_meta_file} | $filter_pheno_subsets_to_use | sed 's/^\(!{prop,,pheno}_variant_subset_\([^\.][^\.]*\)\.\(\S\S*\)\).*/\1 ${burden_variant_subset_name}_\2.\3 \2 \3/' | sed 's/^\(\S\S*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)/\2 class burden_variant_subset\n!select:!{prop,,project}:!{prop,,pheno} \2 parent !{prop,,burden}\n\2 disp !{prop,,burden,disp} variant subset \3.\4\n\2 consistent \1\n\2 var_subset_num \3\n\2 expand_subset_num \4/' > !{output,,burden_burden_variant_subset_meta_file} && awk '\$2 == "consistent"' !{input,,pheno_pheno_variant_subset_meta_file} | $filter_pheno_subsets_to_use | sed 's/^\(!{prop,,pheno}_variant_subset_\([^\.][^\.]*\).\(\S\S*\)\)\s\s\*consistent\s\s*\(.*\)/${burden_variant_subset_name}_\2.\3 consistent \4\n${burden_variant_subset_name}_\2.\3 consistent ${annot_variant_subset_name}_\2/' !{input,annot_annot_variant_subset_meta_file,max=1} >> !{output,,burden_burden_variant_subset_meta_file} class_level burden run_if and,!only_for_interesting,num_var_subsets,(or,burden_maf,burden_mac_lb,burden_mac_ub,burden_test),!annot_genes,!annot_manual_gene_list_file,!annot_manual_gene_variant_list_file skip_if not_trait with burden_variant_subset

local cmd make_empty_burden_burden_variant_subset_meta_file=rm -f !{output,,burden_burden_variant_subset_meta_file} && touch !{output,,burden_burden_variant_subset_meta_file} class_level burden run_if or,only_for_interesting,!num_var_subsets,(and,!burden_maf,!burden_mac_lb,!burden_mac_ub,!burden_test),annot_genes,annot_manual_gene_list_file,annot_manual_gene_variant_list_file skip_if not_trait with burden_variant_subset

local cmd make_burden_burden_test_variant_subset_meta_file=egrep "class pheno_variant_subset$" !{input,,pheno_pheno_variant_subset_meta_file} | $filter_pheno_subsets_to_use | sed 's/^\(!{prop,,pheno}_variant_subset_\([^\.][^\.]*\)\.\(\S\S*\)\).*/\1 ${burden_variant_subset_name}_\2.\3 ${burden_test_variant_subset_name}_\2.\3 \2 \3/' | sed 's/^\(\S\S*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)/\3 class burden_test_variant_subset\n!select:!{prop,,project}:!{prop,,pheno}:!{prop,,burden} \3 parent !{prop,,burden_test,if_prop=test_software:ne:metal,sep=\,}\n\3 disp !{prop,,burden,disp} test variant subset \4.\5\n\3 consistent \1\n\3 consistent \2\n\3 var_subset_num \4\n\3 expand_subset_num \5/' | sed 's/\(parent\s\s*\)\(.*,.*\)/\1{\2}/' > !{output,,burden_burden_test_variant_subset_meta_file} && awk '\$2 == "consistent"' !{input,,pheno_pheno_variant_subset_meta_file} | $filter_pheno_subsets_to_use | sed 's/^\(!{prop,,pheno}_variant_subset_\([^\.][^\.]*\).\(\S\S*\)\)\s\s\*consistent\s\s*\(.*\)/${burden_test_variant_subset_name}_\2.\3 consistent \4\n${burden_test_variant_subset_name}_\2.\3 consistent ${annot_variant_subset_name}_\2/' !{input,annot_annot_variant_subset_meta_file,max=1} >> !{output,,burden_burden_test_variant_subset_meta_file} class_level burden run_if and,num_var_subsets,!only_for_interesting,(or,burden_maf,burden_mac_lb,burden_mac_ub,burden_test),burden_test,!annot_genes,!annot_manual_gene_list_file,!annot_manual_gene_variant_list_file skip_if not_trait with burden_test_variant_subset

local cmd make_empty_burden_burden_test_variant_subset_meta_file=rm -f !{output,,burden_burden_test_variant_subset_meta_file} && touch !{output,,burden_burden_test_variant_subset_meta_file} class_level burden run_if or,only_for_interesting,!num_var_subsets,(and,!burden_maf,!burden_mac_lb,!burden_mac_ub,!burden_test),!burden_test,annot_genes,annot_manual_gene_list_file,annot_manual_gene_variant_list_file skip_if not_trait with burden_test_variant_subset

local cmd make_pheno_variant_subset_region_file=sort -k1,1 -k2,2 -k3,3n !{input,,project_variant_subset_region_file} | awk 'NR == 1 {n=1} NR > 1 && r != \$1 {n++} n % !{prop,,project_variant_subset,expand_pheno_subsets} + 1 == !{prop,,pheno_variant_subset,expand_subset_num} {print} {r=\$1}' > !{output,,pheno_variant_subset_region_file} class_level pheno_variant_subset

#first, annotate var list with all regions at project_variant_subset
#then, annotate further with regions at pheno var subset
#keep a variant if outside project_variant_subset_region and if NR mod expand_subsets equals pheno_variant_subset index
#keep all variants inside pheno var subset regions

short cmd make_pheno_variant_subset_var_chr_pos_keep_file=$pseq_qc_plus_analysis_cmd_project_variant_subset(v-view) $show_id | cut -f1 | awk -F: -v OFS="\t" '{print \$1":"\$2,\$3}' | $add_gene_annot_cmd --in-delim $tab --outside-name $outside_gene_name --keep-outside --locus-col 1 --gene-file !{input,,project_variant_subset_region_file} --out-delim $tab | awk -v OFS="\t" -F"\t" '{print \$2,\$3,\$1,NR}' | $add_gene_annot_cmd --in-delim $tab --locus-col 1 --gene-file !{input,,pheno_variant_subset_region_file} --out-delim $tab --keep-outside | awk -v OFS="\t" -F"\t" '{if (\$4 == "$outside_gene_name") {if (\$5 % !{prop,,project_variant_subset,expand_pheno_subsets} + 1 == !{prop,,pheno_variant_subset,expand_subset_num}) {print}} else if (\$1 != "$outside_gene_name") {print}}' | cut -f2-3 > !{output,,pheno_variant_subset_var_chr_pos_keep_file} class_level pheno_variant_subset run_if expand_pheno_subsets:ne:1

local cmd make_copy_pheno_variant_subset_var_chr_pos_keep_file=$smart_cut_cmd --in-delim $tab !{input,--file,project_variant_subset_clean_gene_variant_file} --select-col 1,1,'CHROM POS ID' --exact --require-col-match | tail -n+2 | awk -v OFS="\t" '{print "chr"\$1":"\$2,\$3}' | sed 's/^chrchr/chr/' > !{output,,pheno_variant_subset_var_chr_pos_keep_file} class_level pheno_variant_subset run_if expand_pheno_subsets:eq:1 skip_if not_trait

!!expand:,:keeptype,cols:var,2:chr_pos,1! \
local cmd make_pheno_variant_subset_keeptype_keep_file=cat !{input,,pheno_variant_subset_var_chr_pos_keep_file} | cut -fcols > !{output,,pheno_variant_subset_keeptype_keep_file} class_level pheno_variant_subset

local cmd make_pheno_disp_order_file=$smart_cut_cmd --in-delim $tab !{input,--file,pheno_sequenced_all_sample_info_file} --select-col 1,1,$display_col_name --select-col 1,1,$order_col_name --exclude-row 1,1 | sort -t$tab -uk1 > !{output,,pheno_disp_order_file} class_level pheno

meta_table cmd make_pheno_sample_info_header_file=\#ID\t!{prop,,pheno}\t$display_col_name\t$order_col_name !{output,pheno_sample_info_header_file}  class_level pheno skip_if pheno_qt

meta_table cmd make_pheno_qt_sample_info_header_file=\#ID\t!{prop,,pheno}\t$display_col_name\t$order_col_name\t$pheno_half\t$pheno_extreme !{output,pheno_sample_info_header_file}  class_level pheno run_if pheno_qt

prop value=scalar

missing_sample_fields_helper=\t!{prop,,pheno,pheno_missing}\t!{prop,,pheno_value,disp,missing_prop=pheno_value,if_prop=pheno_value:eq:@pheno_missing}\t!{prop,,pheno_value,sort,if_prop=pheno_value:eq:@pheno_missing,missing=1}

missing_qt_sample_fields_helper=\t!{prop,,pheno,pheno_missing}\t$qt_missing_disp\t$qt_missing_order\t!{prop,,pheno,pheno_missing,missing=-9}\t!{prop,,pheno,pheno_missing,missing=-9}

!|expand:;:qttype;sedhelper;exrunif:;$missing_sample_fields_helper;skip_if pheno_qt:_qt;$missing_qt_sample_fields_helper;skip_if !pheno_qt| \
!!expand:,:ftype,gtype:,passed:failed_,failed! \
local cmd make_phenoqttype_ftypemissing_sample_info_file=cat !{input,,pheno_ftypenon_missing_sample_pheno_file} !{input,,pheno_ftypenon_missing_sample_pheno_file} | cut -f1 | cat - !{input,,project_gtype_sample_list_file} | sort | uniq -u | sed 's/$/sedhelper/' > !{output,,pheno_ftypemissing_sample_info_file} class_level pheno run_if and,!meta_strata,!meta_strata_value,!meta_trait exrunif


!|expand:;:qttype;sedhelper:;$missing_sample_fields_helper:_qt;$missing_qt_sample_fields_helper| \
meta_phenoqttype_missing_sample_helper=cat $meta_trait_file_helper(,@1) $meta_trait_file_helper(,@2) | cut -f1 | sort -u | cat - !{input,,pheno_sample_exclude_file} | sort | uniq -d | cat - $meta_trait_file_helper(,@1) | cut -f1 | sort -u | sed 's/$/sedhelper/' > !{output,,@1}

!|expand:;:qttype;exskipif:;skip_if pheno_qt:_qt;skip_if !pheno_qt| \
local cmd make_phenoqttype_meta_missing_sample_info_file=$meta_phenoqttype_missing_sample_helper(pheno_missing_sample_info_file,pheno_non_missing_sample_info_file) class_level pheno run_if or,meta_strata,meta_strata_value,meta_trait exskipif

!|expand:;:qttype;exskipif:;skip_if pheno_qt:_qt;skip_if !pheno_qt| \
local cmd make_phenoqttype_meta_failed_missing_sample_info_file=$meta_pheno_missing_sample_helper(pheno_failed_missing_sample_info_file,pheno_failed_non_missing_sample_info_file) class_level pheno run_if or,meta_strata,meta_strata_value,meta_trait exskipif


non_missing_sample_pheno_helper=!{prop,,sample,@{1}_prop=failed,if_prop=pheno:defined:deref:1}\t!{prop,,sample,pheno,deref=1,@{1}_prop=failed,if_prop=pheno:defined:deref:1}

!!expand:,:ktype,stype:keep,select-row:exclude,exclude-row! \
local cmd make_pheno_sample_ktype_file=$smart_cut_cmd --in-delim $tab !{input,--file,pheno_sequenced_all_sample_info_file,if_prop=pheno:eq:@meta_strata,if_prop=project:eq:@project,all_instances=1} --select-col 1,1,'\\#ID' --exclude-row 1,1 --stype 1,1,!{prop,,pheno,meta_strata},eq:!{prop,,pheno,meta_strata_value} --and-row-all --exact --require-col-match > !{output,,pheno_sample_ktype_file} class_level pheno run_if or,meta_strata,meta_strata_value,meta_trait

!!expand:,:ktype,stype:keep,select-row:exclude,exclude-row! \
local cmd make_pheno_non_meta_sample_keep_file=cut -f1 !{input,,pheno_non_missing_sample_pheno_file} > !{output,,pheno_sample_keep_file} class_level pheno skip_if or,meta_strata,meta_strata_value,meta_trait

!!expand:,:ktype,ftype:,passed:failed_,failed! \
local cmd cp_pheno_ktypenon_missing_sample_pheno_file=$smart_join_cmd --out-delim $tab --exec "$smart_cut_cmd !{input,--file,pheno_sample_pheno_file} --exclude-row 1,2,eq:!{prop,,pheno,pheno_missing} --select-col 1,1 | sort -u | $smart_cut_cmd --exec 'sort -u !{input,,project_ftype_sample_list_file}' | sort | uniq -d" !{input,--file,pheno_sample_pheno_file}  --rest-extra 1 > !{output,,pheno_ktypenon_missing_sample_pheno_file} class_level pheno run_if pheno_sample_pheno_file with project

meta_table cmd make_pheno_non_missing_sample_pheno_file=$non_missing_sample_pheno_helper(unless) !{output,pheno_non_missing_sample_pheno_file} class_level pheno skip_if or,meta_strata,meta_strata_value,meta_trait,pheno_sample_pheno_file,no_sample_tracking

#meta_table cmd make_pheno_non_missing_sample_pheno_file=$non_missing_sample_pheno_helper(unless) !{output,pheno_non_missing_sample_pheno_file} class_level pheno skip_if or,meta_strata,pheno_sample_pheno_file,no_sample_tracking

meta_trait_file_helper=!{input,@1,@2,if_prop=pheno:eq:\@meta_trait,if_prop=project:eq:\@project,all_instances=1}

meta_pheno_sample_helper_int=$smart_join_cmd --exec "cut -f1 $meta_trait_file_helper(,@1) | cat - !{input,,pheno_sample_keep_file} | sort | uniq -d @3" --exec "cat !{input,,pheno_sample_keep_file} @3" $meta_trait_file_helper(--file,@1) --rest-extra 1 --in-delim $tab @2 > !{output,,@1}

meta_pheno_sample_helper=$meta_pheno_sample_helper_int(@1,,)
meta_pheno_sample_helper_header=$meta_pheno_sample_helper_int(@1,--header 1,| sed '1 s/^/ID\n/')

local cmd make_pheno_meta_non_missing_sample_pheno_file=$meta_pheno_sample_helper(pheno_non_missing_sample_pheno_file) class_level pheno run_if or,meta_strata,meta_strata_value,meta_trait with project
local cmd make_pheno_meta_failed_non_missing_sample_pheno_file=$meta_pheno_sample_helper(pheno_failed_non_missing_sample_pheno_file) class_level pheno run_if or,meta_strata,meta_strata_value,meta_trait

failed_tag=Failed
passed_tag=Passed

local cmd make_pheno_quantile_file=$smart_cut_cmd --in-delim $tab --exec "sed 's/^/$passed_tag\t/' !{input,,pheno_non_missing_sample_pheno_file}" --exec "sed 's/^/$failed_tag\t/' !{input,,pheno_failed_non_missing_sample_pheno_file}" --exec "cat !{input,,pheno_non_missing_sample_pheno_file} !{input,,pheno_failed_non_missing_sample_pheno_file} | sed 's/^/$all_tag\t/'" | $table_sum_stats_cmd --out-delim $tab --group-col 1 --col 3 !{prop,--quantile,pheno,low_quantile,missing_key=default_low_quantile} !{prop,--quantile,pheno,med_quantile,missing_key=default_med_quantile} !{prop,--quantile,pheno,high_quantile,missing_key=default_high_quantile}  --print-header > !{output,,pheno_quantile_file} class_level pheno run_if pheno_qt

non_missing_sample_info_helper=$smart_join_cmd --in-delim $tab !{input,--file,@1} --multiple 1 --extra 2 --exec "perl -le 'print \"!{prop,,pheno_value,value,missing_prop=pheno_value,sort_prop=\@pheno_value,sep=\t}\n!{prop,,pheno_value,disp,sort_prop=\@pheno_value,missing_prop=pheno_value,sep=\t}\n!{prop,,pheno_value,sort,sort_prop=\@pheno_value,missing=1,sep=\t}\"' | $transpose_cmd --in-delim $tab" --col 1,2 | awk -F"\t" -v OFS="\t" '{s=\$1; \$1=\$2; \$2=s} {print}'

local cmd make_pheno_non_missing_sample_info_file=$non_missing_sample_info_helper(pheno_non_missing_sample_pheno_file) > !{output,,pheno_non_missing_sample_info_file} class_level pheno skip_if pheno_qt run_if and,!meta_strata,!meta_strata_value,!meta_trait with project
local cmd make_pheno_failed_non_missing_sample_info_file=$non_missing_sample_info_helper(pheno_failed_non_missing_sample_pheno_file) > !{output,,pheno_failed_non_missing_sample_info_file} class_level pheno skip_if pheno_qt run_if and,!meta_strata,!meta_strata_value,!meta_trait

local cmd make_pheno_meta_non_missing_sample_info_file=$meta_pheno_sample_helper(pheno_non_missing_sample_info_file) class_level pheno run_if or,meta_strata,meta_strata_value,meta_trait
local cmd make_pheno_meta_failed_non_missing_sample_info_file=$meta_pheno_sample_helper(pheno_failed_non_missing_sample_info_file) class_level pheno run_if or,meta_strata,meta_strata_value,meta_trait

fetch_quantile_helper=$smart_cut_cmd --in-delim $tab !{input,--file,pheno_quantile_file} --select-row 1,1,$all_tag --select-col 1,1,${table_sum_stats_quantile}!{prop,,pheno,low_quantile,missing_key=default_@{1}_quantile}

all_tag=All
pheno_half=!{prop,,pheno}_half
pheno_half_for_raw=@{pheno}_half
pheno_extreme=!{prop::pheno}_ext
pheno_extreme_for_raw=@{pheno}_ext

case_pheno_helper_int=!{prop@1,@1,pheno@1,case_pheno@1,missing_key@1=default_case_pheno}
control_pheno_helper_int=!{prop@1,@1,pheno@1,control_pheno@1,missing_key@1=default_control_pheno}
case_pheno_helper=$case_pheno_helper_int()
control_pheno_helper=$control_pheno_helper_int()

#low is control, top is case

qt_non_missing_sample_info_helper=low=`$fetch_quantile_helper(low)` && med=`$fetch_quantile_helper(med)` && high=`$fetch_quantile_helper(high)` && cat !{input,,pheno_@{1}_sample_pheno_file} | awk -F"\t" -v OFS="\t" '{\$4=$qt_missing_order;\$3="Missing";\$5=$default_missing_pheno} \$2 <= '\$med' {\$4=$qt_bottom_order;\$3="$qt_bottom_disp";\$5=$control_pheno_helper} \$2 > '\$med' {\$4=$qt_top_order;\$3="$qt_top_disp";\$5=$case_pheno_helper} {\$6=$default_missing_pheno} \$2 <= '\$low' {\$6=$control_pheno_helper} \$2 > '\$high' {\$6=$case_pheno_helper} {print}'

local cmd make_pheno_qt_non_missing_sample_info_file=$qt_non_missing_sample_info_helper(non_missing) > !{output,,pheno_non_missing_sample_info_file} class_level pheno run_if pheno_qt  with project
local cmd make_pheno_qt_failed_non_missing_sample_info_file=$qt_non_missing_sample_info_helper(failed_non_missing) > !{output,,pheno_failed_non_missing_sample_info_file} class_level pheno run_if pheno_qt

local cmd make_pheno_all_sample_info_file=cat !{input,,pheno_sample_info_header_file} !{input,,pheno_non_missing_sample_info_file} !{input,,pheno_missing_sample_info_file} > !{output,,pheno_all_sample_info_file} class_level pheno


open_pheno_all_sample_info_file=open IN, "!{input,,pheno_all_sample_info_file}" or die "Cannot read !{input,,pheno_all_sample_info_file}"; <IN>

local cmd make_pheno_indicator_list_file=sed 's/\\#\\#//' !{input,,pheno_plinkseq_indicator_phe_file_header1} | cut -d, -f1 | $fix_plink_covar_names() > !{output,,pheno_indicator_list_file} class_level pheno skip_if pheno_qt

indicator_missing_pheno=-9

local cmd make_pheno_plinkseq_indicator_phe_file_header1=cut -f1,2 !{input,,pheno_all_sample_info_file} | tail -n+2 | perl -ne 'chomp; @a = split("\t"); \$pheno = \$a[1]; \$value = "!{prop,,pheno}_\$pheno"; if (\$pheno ne "!{prop,,pheno,pheno_missing}" && !\$map{\$pheno}) {\$map{\$pheno} = 1; print "\\#\\#\$value,Integer,$indicator_missing_pheno,Indicator variable for !{prop,,pheno} value \$pheno\n"}' > !{output,,pheno_plinkseq_indicator_phe_file_header1} class_level pheno skip_if pheno_qt

local cmd make_pheno_plinkseq_indicator_phe_file_body=perl -e '$open_pheno_all_sample_info_file; @map = (); while (<IN>) {chomp; @a = split("\t"); \$pheno = \$a[1]; \$value = "!{prop,,pheno}_\$pheno"; if (\$pheno ne "!{prop,,pheno,pheno_missing}" && !exists \$map{\$pheno}) {push @map, \$value; \$map{\$pheno} = \$\#map;}} close IN; print "\#ID\t" . join("\t", @map) . "\n"; $open_pheno_all_sample_info_file; while (<IN>) {chomp; @a = split("\t"); \$pheno = \$a[1]; \$id = \$a[0]; @phenos = split("", 0 x scalar @map); if (\$pheno eq "!{prop,,pheno,pheno_missing}") {@phenos = map {$indicator_missing_pheno} @phenos} else {\$phenos[\$map{\$pheno}] = 1} print "\$id\t" . join("\t", @phenos) . "\n"}'  > !{output,,pheno_plinkseq_indicator_phe_file_body} class_level pheno skip_if pheno_qt

pheno_plinkseq_phe_file_header1_helper=\#\#!{prop,,pheno},!{prop,,pheno,pheno_type},!{prop,,pheno,pheno_missing},!{prop,,pheno,pheno_description}
meta_table cmd make_pheno_plinkseq_phe_file_header1=$pheno_plinkseq_phe_file_header1_helper !{output,pheno_plinkseq_phe_file_header1} class_level pheno skip_if pheno_qt

meta_table cmd make_pheno_qt_plinkseq_phe_file_header1=$pheno_plinkseq_phe_file_header1_helper\n\#\#$pheno_half,Integer,$default_missing_pheno,!{prop,,pheno,pheno_description} thresholded at median\n\#\#$pheno_extreme,Integer,$default_missing_pheno,!{prop,,pheno,pheno_description} thresholded below !{prop,,pheno,low_quantile,missing_key=default_low_quantile} or above !{prop,,pheno,high_quantile,missing_key=default_high_quantile} !{output,pheno_plinkseq_phe_file_header1} class_level pheno run_if pheno_qt

local cmd make_pheno_plinkseq_phe_file_body=cut -f1,2,5- !{input,,pheno_all_sample_info_file} > !{output,,pheno_plinkseq_phe_file_body} class_level pheno

local cmd make_pheno_plinkseq_phe_file=cat !{input,,pheno_plinkseq_phe_file_header1} !{input,,pheno_plinkseq_phe_file_body} > !{output,,pheno_plinkseq_phe_file} class_level pheno

local cmd make_pheno_plinkseq_strata_phe_file_header1=cat /dev/null !{input,,pheno_plinkseq_phe_file_header1,if_prop=pheno:eq:@strata_traits,if_prop=project:eq:@project,all_instances=1,allow_empty=1} !{input,,pheno_plinkseq_phe_file_header1,if_prop=pheno:eq:@covar_traits,unless_prop=pheno:eq:@strata_traits,if_prop=project:eq:@project,all_instances=1,allow_empty=1} !{input,,pheno_plinkseq_phe_file_header1,if_prop=pheno:eq:@extra_traits,unless_prop=pheno:eq:@strata_traits,unless_prop=pheno:eq:@covar_traits,if_prop=project:eq:@project,all_instances=1,allow_empty=1} !{input,,pheno_plinkseq_indicator_phe_file_header1,if_prop=pheno:eq:@strata_traits,unless_prop=pheno_qt,if_prop=project:eq:@project,all_instances=1,allow_empty=1} !{input,,pheno_plinkseq_indicator_phe_file_header1,if_prop=pheno:eq:@covar_traits,unless_prop=pheno:eq:@strata_traits,unless_prop=pheno_qt,if_prop=project:eq:@project,all_instances=1,allow_empty=1} !{input,,pheno_plinkseq_indicator_phe_file_header1,if_prop=pheno:eq:@extra_traits,unless_prop=pheno:eq:@covar_traits,unless_prop=pheno:eq:@strata_traits,unless_prop=pheno_qt,if_prop=project:eq:@project,all_instances=1,allow_empty=1} > !{output,,pheno_plinkseq_strata_phe_file_header1} class_level pheno run_if or,strata_traits,covar_traits,extra_traits

local cmd make_pheno_plinkseq_strata_phe_file_body=$smart_join_cmd !{raw,--exec,pheno,"cut -f1 *pheno_plinkseq_phe_file_body",if_prop=pheno:eq:@strata_traits,if_prop=project:eq:@project,all_instances=1,allow_empty=1} !{raw,--exec,pheno,"cut -f1 *pheno_plinkseq_phe_file_body",if_prop=pheno:eq:@covar_traits,unless_prop=pheno:eq:@strata_traits,if_prop=project:eq:@project,all_instances=1,allow_empty=1} !{raw,--exec,pheno,"cut -f1 *pheno_plinkseq_phe_file_body",if_prop=pheno:eq:@extra_traits,unless_prop=pheno:eq:@strata_traits,unless_prop=pheno:eq:@covar_traits,if_prop=project:eq:@project,all_instances=1,allow_empty=1} !{raw,--exec,pheno,"cut -f1 *pheno_plinkseq_indicator_phe_file_body",if_prop=pheno:eq:@strata_traits,unless_prop=pheno_qt,if_prop=project:eq:@project,all_instances=1,allow_empty=1} !{raw,--exec,pheno,"cut -f1 *pheno_plinkseq_indicator_phe_file_body",if_prop=pheno:eq:@covar_traits,unless_prop=pheno:eq:@strata_traits,unless_prop=pheno_qt,if_prop=project:eq:@project,all_instances=1,allow_empty=1} !{raw,--exec,pheno,"cut -f1 *pheno_plinkseq_indicator_phe_file_body",if_prop=pheno:eq:@extra_traits,unless_prop=pheno:eq:@covar_traits,unless_prop=pheno:eq:@strata_traits,unless_prop=pheno_qt,if_prop=project:eq:@project,all_instances=1,allow_empty=1} !{input,--file,pheno_plinkseq_phe_file_body,if_prop=pheno:eq:@strata_traits,if_prop=project:eq:@project,all_instances=1,allow_empty=1} !{input,--file,pheno_plinkseq_phe_file_body,if_prop=pheno:eq:@covar_traits,unless_prop=pheno:eq:@strata_traits,if_prop=project:eq:@project,all_instances=1,allow_empty=1} !{input,--file,pheno_plinkseq_phe_file_body,if_prop=pheno:eq:@extra_traits,unless_prop=pheno:eq:@strata_traits,unless_prop=pheno:eq:@covar_traits,if_prop=project:eq:@project,all_instances=1,allow_empty=1} !{input,--file,pheno_plinkseq_indicator_phe_file_body,if_prop=pheno:eq:@strata_traits,unless_prop=pheno_qt,if_prop=project:eq:@project,all_instances=1,allow_empty=1} !{input,--file,pheno_plinkseq_indicator_phe_file_body,if_prop=pheno:eq:@covar_traits,unless_prop=pheno:eq:@strata_traits,unless_prop=pheno_qt,if_prop=project:eq:@project,all_instances=1,allow_empty=1} !{input,--file,pheno_plinkseq_indicator_phe_file_body,if_prop=pheno:eq:@extra_traits,unless_prop=pheno:eq:@covar_traits,unless_prop=pheno:eq:@strata_traits,unless_prop=pheno_qt,if_prop=project:eq:@project,all_instances=1,allow_empty=1} --header 1 --in-delim $tab --out-delim $tab > !{output,,pheno_plinkseq_strata_phe_file_body} class_level pheno run_if or,strata_traits,covar_traits,extra_traits

local cmd make_pheno_plinkseq_strata_phe_file=cat !{input,,pheno_plinkseq_strata_phe_file_header1} !{input,,pheno_plinkseq_strata_phe_file_body} > !{output,,pheno_plinkseq_strata_phe_file} class_level pheno run_if or,strata_traits,covar_traits

local cmd make_pheno_sequenced_all_sample_info_file=cat !{input,,pheno_all_sample_info_file} !{input,,pheno_failed_non_missing_sample_info_file} !{input,,pheno_failed_missing_sample_info_file} > !{output,,pheno_sequenced_all_sample_info_file} class_level pheno


!+expand:;:qttype;extraprocess;extrarunif:\
reg;| sed '1! s/$case_pheno_helper$/1temp/' | sed '1! s/$control_pheno_helper$/0/' | sed '1! s/temp$//';skip_if pheno_qt:\
qt;;run_if pheno_qt+ \
local cmd make_pheno_qttype_sequenced_all_sample_box_info_file=$smart_cut_cmd --in-delim $tab !{input,--file,pheno_sequenced_all_sample_info_file} --select-col 1,1,'\\#ID !{prop,,pheno}' --exact --require-col-match | awk -F"\t" -v OFS="\t" '\$2 == "!{prop,,pheno,pheno_missing}" {\$2 = "NA"} {print}' | sed '1 s/!{prop,,pheno}/!{prop,,pheno,disp}/' extraprocess > !{output,,pheno_sequenced_all_sample_box_info_file} class_level pheno extrarunif

prop related_traits=list

related_trait_join_helper=--exec $smart_cut_cmd --in-delim $tab --select-col 1,1,'ID @pheno $display_col_name $order_col_name'

local cmd make_pheno_sequenced_all_trait_all_sample_box_info_file=$smart_join_cmd !{input,--file,pheno_sequenced_all_sample_box_info_file} !{input,--file,pheno_sequenced_all_sample_box_info_file,all_instances=1,if_prop=pheno:eq:@related_traits,if_prop=project:eq:@project,allow_empty=1,if_prop=pheno:ne:@pheno} --header 1 --in-delim $tab > !{output,,pheno_sequenced_all_trait_all_sample_box_info_file} class_level pheno run_if related_traits

plink_missing=-9

local cmd make_pheno_plink_phe_file=$sample_list_to_plink_sample_list(--exec "$smart_join_cmd !{input;--file;pheno_sample_basic_all_include_file} --exec \\"cut -f1\,2 !{input;;pheno_non_missing_sample_info_file}\\" --extra 2",0) | awk -v OFS="\t" -F "\t" '\$3 == !{prop,,pheno,pheno_missing} {\$3 = $plink_missing} {print}' > !{output,,pheno_plink_phe_file} class_level pheno with project

local cmd make_pheno_plink_alternate_phe_file=$sample_list_to_plink_sample_list(--exec "$smart_join_cmd --exec \\"sed '1 s/^/ID\n/' !{input;;pheno_sample_basic_all_include_file}\\" --exec \\"cat !{input;;pheno_sample_info_header_file} !{input;;pheno_non_missing_sample_info_file} | cut -f1\,2\,5-\\" --extra 2 --header 1",1) | awk -v OFS="\t" -F "\t" '\$3 == !{prop,,pheno,pheno_missing} {for (i=3;i<=NF;i++) {\$i = $plink_missing}} {print}' !{input,pheno_is_trait_file} > !{output,,pheno_plink_alternate_phe_file} class_level pheno

fix_plink_covar_names=sed '@1 s/-/_/g'

!|expand:,:filetype,extrafile:covar,:covar_cluster,!{input@--file@pheno_plinkseq_cluster_phe_file}| \
local cmd make_pheno_plink_filetype_file=$sample_list_to_plink_sample_list(--exec "$smart_join_cmd --in-delim $tab --header 1 --exec \\"sed '1 s/^/ID\n/' !{input;;pheno_sample_basic_all_include_file}\\" !{input\,--file\,pheno_plinkseq_strata_phe_file\,if_prop=strata_traits\,if_prop=covar_traits\,allow_empty=1\,or_if_prop=1} !{input\,--file\,pheno_plinkseq_covar_phe_file} extrafile --rest-extra 1 --comment \\\#\\\# | sed '1 s/\\\#//'",1) | $fix_plink_covar_names(1) !{input,pheno_is_trait_file} > !{output,,pheno_plink_filetype_file} class_level pheno

get_variable_covars=cat !{input,,@1} | cut -f@2- | awk 'NR == 1 {for (i=1;i<=NF;i++) {m[i]=\$i; v[i]=$plink_missing; c[i]=0; n=NF}} NR > 2 {for(i=1;i<=NF;i++) {if (v[i]==$plink_missing) {v[i]=\$i} else if (\$i != $plink_missing && v[i] != \$i) { c[i]=1 } }} END {for(i=1;i<=n;i++) { if (c[i]) {print m[i]} }}'

local cmd make_pheno_variable_covars_file=$get_variable_covars(pheno_plink_covar_file,3) > !{output,,pheno_variable_covars_file} class_level pheno

epacts_ped_helper=$smart_join_cmd --in-delim $tab --exec "sed '1 s/^/FID\tIID\n/' !{input,,pheno_sample_plink_@{1}_include_file}" --exec "awk -v OFS=\"\t\" 'NR == 1 {print \"FID\",\"IID\",\"PID\",\"MID\",\"SEX\",\"DUMMY\"} {print \\$1,\\$2,\\$3,\\$4,\\$5,\\$6}' !{input,,pheno_fam_file}" !{input,--file,pheno_plink_alternate_phe_file} @2 --rest-extra 1 --col 1 --col 2 --header 1 | sed '1 s/^/\#/'

!!expand:type:all:unrelated! \
local cmd make_pheno_epacts_type_ped_file=$epacts_ped_helper(basic_type,) > !{output,,pheno_epacts_type_ped_file} class_level pheno skip_if not_trait

!!expand:type:all:unrelated! \
local cmd make_pheno_epacts_popgen_type_ped_file=$epacts_ped_helper(popgen_type,) > !{output,,pheno_epacts_popgen_type_ped_file} class_level pheno skip_if not_trait

!!expand:type:all:unrelated! \
local cmd make_pheno_epacts_covar_type_ped_file=$epacts_ped_helper(covar_type,!{input:--file:pheno_plink_covar_file}) > !{output,,pheno_epacts_covar_type_ped_file} class_level pheno skip_if not_trait

local cmd make_pheno_plink_match_file=$sample_list_to_plink_sample_list(--exec "grep -v \\\#\\\# !{input\,\,pheno_plinkseq_strata_phe_file} | sed '1 s/^\\#//' | $smart_cut_cmd --in-delim $tab --vec-delim : --select-col 0\,1 --select-col 0\,1\,'!{prop\,\,pheno\,strata_traits\,sep=:}'",1) > !{output,,pheno_plink_match_file} class_level pheno run_if strata_traits

ibs_cluster_pheno=ibs_cluster
ibs_cluster_missing=$plink_missing
ibs_cluster_height=0
local cmd make_pheno_plinkseq_cluster_phe_file=$smart_join_cmd !{input,--file,project_sample_include_file} --exec "$smart_join_cmd --exec \"awk 'NF > 1 {f=NF-$ibs_cluster_height; print \\\\$2,\\\\$f}' < !{input,,pheno_sample_marker_cluster2_file}\" --exec \"sed 's/$/ $ibs_cluster_missing/' !{input,,project_sample_include_file}\" --merge" --extra 2 --out-delim $tab | sed '1 s/^/\#\#$ibs_cluster_pheno,Integer,$ibs_cluster_missing,"IBS cluster"\n\#ID\t$ibs_cluster_pheno\n/' > !{output,,pheno_plinkseq_cluster_phe_file} class_level pheno

subset_mds_file=sed 's/^\s*//' !{input,,pheno_mds_file} | sed 's/\s\s*/\t/g' | cut -f2,4-

local cmd make_pheno_plinkseq_covar_phe_file=$smart_join_cmd --out-delim $tab --exec "$subset_mds_file | tail -n+2" --exec "cat !{input,,project_sample_include_file} | perl -ne 'chomp; print; print \" \"; print join(\" \", map {$ibs_cluster_missing} (1..!{prop,,pheno,num_mds_calc})); print \"\n\"'" --merge | $smart_cut_cmd --exec "$subset_mds_file" --out-delim $tab --select-row 1,1 | sed '1 s/^\S\S*/\#ID/' | perl -lpe 'print join("\n", map {"\#\#C\$_,Float,$ibs_cluster_missing,\"MDS value \$_\""} (1..!{prop,,pheno,num_mds_calc})) unless \$i++' > !{output,,pheno_plinkseq_covar_phe_file} class_level pheno

convert_pheno_plink_phe=cut -f2- !{input,,pheno_plink_phe_file} !{raw,,pheno,| sed 's/$case_pheno_helper_int(\)$/1temp/' | sed 's/$control_pheno_helper_int(\)$/0/' | sed 's/temp$//' | sed '1 s/^/ID\t@pheno\n/',unless_prop=pheno_qt,allow_empty=1}

#local cmd make_pheno_score_seq_phe_covar_file=c=$get_covar_traits(:)`$get_mds_cols(!{prop\\,\\,pheno\\,num_mds_covar},:)` && $smart_join_cmd --in-delim $tab --header 1 --rest-extra 1 --exec "sed '1 s/^/ID\n/' !{input,,pheno_sample_covar_include_file}" --exec "$convert_pheno_plink_phe" --exec "cut -f2- !{input,,pheno_plink_covar_file}" | $smart_cut_cmd --in-delim $tab --select-col 0,1 --select-col 0,1,!{prop,,pheno}:\$c --vec-delim : --require-col-match --exact | tail -n+2 > !{output,,pheno_score_seq_phe_covar_file} class_level pheno run_if or,strata_traits,strat_covar skip_if not_trait

#local cmd make_pheno_score_seq_phe_file=$smart_join_cmd --in-delim $tab --header 1 --rest-extra 1 --exec "sed '1 s/^/ID\n/' !{input,,pheno_sample_popgen_include_file}" --exec "$convert_pheno_plink_phe" | tail -n+2 > !{output,,pheno_score_seq_phe_file} class_level pheno skip_if not_trait

#!!expand:phetype:phe:phe_covar! \
#local cmd make_pheno_score_seq_reverse_phetype_file=awk -F"\t" -v OFS="\t" '{\$2 = 1 - \$2} {print}' !{input,,pheno_score_seq_phetype_file} > !{output,,pheno_score_seq_reverse_phetype_file} class_level pheno skip_if pheno_qt

#!!expand:filetype:covar:cluster! \
#local cmd make_pheno_filetype_exclude_file=sort !{input,,pheno_sample_popgen_all_include_file} !{input,,pheno_sample_filetype_all_include_file} !{input,,pheno_sample_filetype_all_include_file} | uniq -u > !{output,,pheno_filetype_exclude_file} class_level pheno

#ISSUE right now is that PSEQ seems to prepend chr in front of every variant
#To get around this, we assume that the variants either all have chr or none do

!!expand:,:shortt,phenol,projectl,extrarunif:,pheno,project,:short,pheno_variant_subset,project_variant_subset,run_if num_var_subsets! \
local cmd make_phenol_plinkseq_project_file=$pseq_cmd !{output,,phenol_plinkseq_project_file} new-project !{raw,--vardb,projectl,*projectl_plinkseq_vardb_file} $plinkseq_resources_helper --scratch !{raw,,phenol,$phenol_plinkseq_project_temp_dir} !{raw,--locdb,projectl,*projectl_plinkseq_locdb_file} && touch !{output,,phenol_plinkseq_project_done_file} class_level phenol

#DID THIS BREAK?
#removed loading of this file
#!{input,,pheno_plinkseq_strata_phe_file,if_prop=strata_traits,if_prop=covar_traits,if_prop=extra_traits,or_if_prop=1,allow_empty=1}

!!expand:,:shortt,phenol,projectl,extrarunif:,pheno,project,:short,pheno_variant_subset,project_variant_subset,run_if num_var_subsets! \
shortt cmd make_phenol_plinkseq_project_dbs=rm -rf !{raw,,phenol,$phenol_plinkseq_project_out_dir/*} && rm -rf !{raw,,phenol,$phenol_plinkseq_project_temp_dir/*} && $pseq_phenol_project_cmd load-pedigree !{input,--file,project_plinkseq_ind_info_file} !{output,phenol_plinkseq_inddb_file} && touch !{output,,phenol_plinkseq_db_done_file} !{output,,phenol_plinkseq_temp_done_file} && $pseq_phenol_project_cmd load-pheno --file !{input,,pheno_plinkseq_phe_file} !{input,projectl_plinkseq_db_done_file} class_level phenol run_with pheno_variant_subset

!!expand:,:phenol,projectl,extrarunif:pheno,project,:pheno_variant_subset,project_variant_subset,run_if num_var_subsets! \
local cmd make_phenol_plinkseq_clean_project_file=$pseq_cmd !{output,,phenol_plinkseq_clean_project_file} new-project !{raw,--vardb,projectl,*projectl_plinkseq_clean_vardb_file} $plinkseq_resources_helper --scratch !{raw,,phenol,$phenol_plinkseq_clean_project_temp_dir} !{raw,--locdb,projectl,*projectl_plinkseq_locdb_file} && touch !{output,,phenol_plinkseq_clean_project_done_file} class_level phenol extrarunif

#DID THIS BREAK?
#removed loading of this file
#!{input,,pheno_plinkseq_strata_phe_file,if_prop=strata_traits,if_prop=covar_traits,if_prop=extra_traits,or_if_prop=1,allow_empty=1}

!!expand:,:shortt,phenol,projectl,extrarunif:,pheno,project,:short,pheno_variant_subset,project_variant_subset,run_if num_var_subsets! \
shortt cmd make_phenol_plinkseq_clean_project_dbs=rm -rf !{raw,,phenol,$phenol_plinkseq_clean_project_out_dir/*} && rm -rf !{raw,,phenol,$phenol_plinkseq_clean_project_temp_dir/*} && $pseq_phenol_clean_project_cmd load-pedigree !{input,--file,project_plinkseq_ind_info_file} !{output,phenol_plinkseq_clean_inddb_file} && touch !{output,,phenol_plinkseq_clean_db_done_file} !{output,,phenol_plinkseq_clean_temp_done_file} && $pseq_phenol_clean_project_cmd load-pheno --file !{input,,pheno_plinkseq_phe_file} !{input,projectl_plinkseq_clean_db_done_file} class_level phenol extrarunif

!!expand:,:phenol,projectl,extrarunif:pheno,project,:pheno_variant_subset,project_variant_subset,run_if num_var_subsets! \
local cmd make_phenol_plinkseq_strat_project_file=$pseq_cmd !{output,,phenol_plinkseq_strat_project_file} new-project !{raw,--vardb,projectl,*projectl_plinkseq_clean_vardb_file} $plinkseq_resources_helper --scratch !{raw,,phenol,$phenol_plinkseq_strat_project_temp_dir} !{raw,--locdb,projectl,*projectl_plinkseq_locdb_file} && touch !{output,,phenol_plinkseq_strat_project_done_file} class_level phenol extrarunif

!|expand:,:shortt,phenol,projectl,extrarunif:,pheno,project,:short,pheno_variant_subset,project_variant_subset,skip_if !num_var_subsets bsub_batch 50 | \
shortt cmd make_phenol_plinkseq_strat_project_dbs=rm -rf !{raw,,phenol,$phenol_plinkseq_strat_project_out_dir/*} && rm -rf !{raw,,phenol,$phenol_plinkseq_strat_project_temp_dir/*} && $pseq_phenol_strat_project_cmd load-pedigree !{input,--file,project_plinkseq_ind_info_file} !{output,phenol_plinkseq_strat_inddb_file} && touch !{output,,phenol_plinkseq_strat_db_done_file} !{output,,phenol_plinkseq_strat_temp_done_file} \
  && $pseq_phenol_strat_project_cmd load-pheno --file !{input,,pheno_plinkseq_phe_file} !{input,,pheno_plinkseq_strata_phe_file,if_prop=strata_traits,if_prop=covar_traits,if_prop=extra_traits,or_if_prop=1,allow_empty=1} !{input,,pheno_plinkseq_covar_phe_file} !{input,,pheno_plinkseq_cluster_phe_file} \
  !{input,pheno_is_trait_file} !{input,phenol_plinkseq_clean_db_done_file} class_level phenol

marker_nn_helper=$smart_cut_cmd !{input,--file,@2} --exact --select-col 1,1,IID --select-col 1,1,Z --select-row 1,1 --select-row 1,1,NN,@1 --out-delim $tab | sed '1 s/^.*/IID\tZ_IBS_NN@1/'

min_related_outlier=.05

custom_exclude_header=CUST_EX

!|expand:;:type;toexclude;skipif:\
all;!{input\,\,project_sample_exclude_file} !{input\,\,pheno_missing_sample_info_file};skip_if not_trait:\
unrelated;!{input\,\,project_sample_exclude_file} !{input\,\,pheno_missing_sample_info_file} !{input\,\,pheno_popgen_exclude_file} !{input\,\,pheno_basic_related_exclude_file};skip_if not_trait| \
cmd make_pheno_sample_marker_type_nearest_file=$sample_list_to_plink_sample_list(--exec "cat toexclude | cut -f1  | sort -u",0) | $plink_marker_helper !{input,--read-genome,pheno_genome_file} --remove /dev/stdin --neighbour $min_neighbor !{prop,,pheno,max_neighbor} !{raw,--out,pheno,*pheno_sample_marker_type_nearest_trunk} !{output,pheno_sample_marker_type_nearest_file} && $plink_mv_log_cmd(!{raw\,\,pheno\,*pheno_sample_marker_type_nearest_trunk},!{output\,\,pheno_sample_marker_type_nearest_log_file}) class_level pheno skipif

add_indicator_helper=$smart_join_cmd --exec \"cat !{input,,@1} !{input,,@2} | sort | uniq -d | sed 's/$/\t1/'\" --exec \"sed 's/$/\t0/' !{input,,@1}\" --merge | sed '1 s/^/ID\t@3\n/'

!@expand:;:phenol;shortt;extrainclude;runif:pheno;;;run_if or,!num_samp_subsets,!parallelize_genome:pheno_sample_subset;short;| cat - !{input,,project_sample_subset_clean_samp_keep_file} | sort | uniq -d;run_if and,num_samp_subsets,parallelize_genome@ \
!+expand@;@typekey;typefile;toinclude\
@all;pheno_sample_marker_all_nearest_file;!{input::project_sample_include_file}\
@unrelated;pheno_sample_marker_unrelated_nearest_file;!{input::pheno_sample_popgen_unrelated_include_file}\
+ \
shortt cmd make_phenol_typekey_popgen_istats_file=$smart_join_cmd \ 
  --exec "$marker_nn_helper(1,typefile) | cat - !{input,,pheno_sample_basic_all_include_file} | cut -f1 | sort | uniq -d extrainclude | sed '1 s/^/ID\n/'" \
	--exec "$marker_nn_helper(1,typefile)" \
	--exec "$marker_nn_helper(2,typefile)" \
	--exec "$marker_nn_helper(3,typefile)" \
	--exec "$marker_nn_helper(4,typefile)" \
	--exec "$marker_nn_helper(5,typefile)" \
  --exec "$smart_cut_cmd !{input,--file,typefile} --exact --select-col 1,1,IID --select-col 1,1,PROP_DIFF --select-row 1,1 --select-row 1,1,NN,!{prop,,pheno,max_neighbor}" \
	--exec "$fill_file_helper(pheno_project_mds_file,pheno_sample_basic_all_include_file,NA,1,1,1,1) | cut -f1,4-" \
  --exec "$smart_cut_cmd --out-delim $tab --exec \"cat toinclude !{input,,pheno_sample_basic_typekey_include_file} | sort | uniq -d | $filter_sample_genome_file(-,phenol_genome_file)\" --exclude-row 1,1 --select-col 1,1,IID1 --select-col 1,1,IID2 --select-row 1,1,PI_HAT,ge:$min_related_outlier | sed 's/\t/\n/' | sort | uniq -c | $smart_cut_cmd --select-col 0,'1 2' --out-delim $tab | $smart_cut_cmd --stdin-first --in-delim $tab --exec \"sed 's/^/0\t/' !{input,,project_sample_include_file}\" | sort -s -k2,2 | uniq -f1 | $smart_cut_cmd --in-delim $tab --select-col 0,'2 1' | sed '1 s/^/ID\tNUM_CLOSE\n/'" \
  --exec "$smart_cut_cmd --exec \"cat toinclude !{input,,pheno_sample_basic_typekey_include_file} | sort | uniq -d | $filter_sample_genome_file(-,phenol_genome_file)\" --exec \"cat toinclude !{input,,pheno_sample_basic_typekey_include_file} | sort | uniq -d | $filter_sample_genome_file(-,phenol_genome_file)\" --select-col 1,1,IID1 --select-col 1,1,PI_HAT --exclude-row 2,1 --select-col 2,1,IID2 --select-col 2,1,PI_HAT | $table_sum_stats_cmd --out-delim $tab --group-col IID1 --col PI_HAT --summaries --has-header --print-header | $smart_cut_cmd --select-col 0,1 --select-col 0,1,PI_HAT_max --require-col-match | tail -n+2 | sed '1 s/^/ID\tMAX_PI_HAT\n/'" \
	--exec "$smart_cut_cmd --in-delim , --out-delim $tab !{input,--file,project_sstats_file} --select-col 1,1,'ID SEX_CHECK'" \
  --exec "$add_indicator_helper(pheno_sample_basic_typekey_include_file,pheno_mds_exclude_file,MDS_EXCLUDE)" \
  --exec "$add_indicator_helper(pheno_sample_basic_typekey_include_file,pheno_additional_popgen_exclude_file\,if_prop=pheno_additional_popgen_exclude_file\,allow_empty=1,$custom_exclude_header)" \
  --out-delim , --header 1 --rest-extra 1 | sed '1 s/^[^,]*,/ID,/' > !{output,,phenol_typekey_popgen_istats_file} class_level phenol skip_if not_trait runif

local cmd make_pheno_popgen_outlier_file=$write_outlier_table_cmd !{input,,pheno_all_popgen_istats_file} !{output,,pheno_popgen_outlier_file} -ID ID sep=, out.sep=, class_level pheno skip_if not_trait

popgen_highlight_columns=$sample_highlight_columns
popgen_highlight_info=id.col=1 highlight.list.file=!{input,,pheno_popgen_exclude_detail_file} $popgen_highlight_columns
popgen_highlight_info=id.col=1 highlight.list.file=!{input,,pheno_popgen_exclude_detail_file} $popgen_highlight_columns

popgen_pdf_helper=$smart_join_cmd --exec "$get_non_missing_with_header" !{input,--file,pheno_@{3}_popgen_istats_file} --arg-delim : --in-delim 1:$tab --in-delim 2:$coverage_dat_delim --header 1 --out-delim $coverage_dat_delim --extra 1 | $draw_box_plot_cmd(/dev/stdin !{output\,\,@1} '!{prop\,\,pheno\,disp} QC+ Sample Popgen Information@4' '' 'Sample Values' -1\,$display_col_name\,$order_col_name label=$display_col_name order=$order_col_name sep=\, @2)

!!expand:,:type,options,which_marker_istats,extra_title\
:all,,all,\
:highlighted,$popgen_highlight_info,all,\
:final,$popgen_highlight_info exclude.highlighted=TRUE,all, -- after popgen filters; IBD not recomputed\
:unrelated,,unrelated, -- unrelated samples; IBD recomputed\
! local cmd make_pheno_popgen_type_pdf_file=$popgen_pdf_helper(pheno_popgen_type_pdf_file, options,which_marker_istats,extra_title) class_level pheno skip_if not_trait

exclude_popgen_outlier=$exclude_outlier_raw(pheno_popgen_outlier_file,@1,@2,@3,\,)

local cmd make_pheno_popgen_exclude_detail_file=\ 
	$exclude_popgen_outlier($custom_exclude_header,VALUE,eq:1) \
	!{raw,|,pheno_qc_filter,cat - *pheno_qc_filter_exclude_file,if_prop=pheno_qc_filter,allow_empty=1} !{input,pheno_qc_filter_exclude_file,if_prop=pheno_qc_filter,allow_empty=1} \
	| cut -d, -f1-2 | sort -u | $smart_cut_cmd --file !{input,,pheno_popgen_outlier_file} --select-row 1,1 --select-col 1,1-2 --in-delim , > !{output,,pheno_popgen_exclude_detail_file} class_level pheno skip_if not_trait

prop prune_all_related=scalar
prop prune_by_call_rate=scalar default 1

local cmd make_pheno_related_exclude_rank_file=$smart_join_cmd --out-delim $tab !{input,--file,project_passed_sample_list_file} --rest-extra 1 !{input,--file,pheno_related_exclude_custom_rank_file,if_prop=pheno_related_exclude_custom_rank_file,allow_empty=1} !{raw,,pheno,--fill 2 --fill-value NA,if_prop=pheno_related_exclude_custom_rank_file,allow_empty=1} --exec "$smart_join_cmd --exec \"sed 's/$/\t1/' !{input,,pheno_sample_popgen_all_include_file}\" --exec \"sed 's/$/\t0/' !{input,,project_passed_sample_list_file}\" --merge" !{raw;;pheno;--exec "$smart_cut_cmd --in-delim , --out-delim $tab --file *project_sstats_file --select-col 1,1,'ID RATE' --exclude-row 1,1";if_prop=prune_by_call_rate;allow_empty=1} !{input;project_sstats_file;if_prop=prune_by_call_rate;allow_empty=1} > !{output,,pheno_related_exclude_rank_file} class_level pheno skip_if and,pheno_related_exclude_custom_rank_file,!prune_by_call_rate 

short cmd make_pheno_basic_related_exclude_file=\ 
        $filter_sample_genome_file(!{input::pheno_sample_basic_all_include_file} !{raw::pheno:| cat - *pheno_custom_related_exclude_file *pheno_custom_related_exclude_file | sort | uniq -u:if_prop=pheno_custom_related_exclude_file:allow_empty=1},pheno_genome_file) | perl $targeted_bin_dir/prune_most_ibd.pl !{input,--rank-file,pheno_related_exclude_rank_file} !{prop,,pheno,max_related} !{raw::pheno:| cat - *pheno_custom_related_exclude_file | sort -u:if_prop=pheno_custom_related_exclude_file:allow_empty=1} !{input:pheno_custom_related_exclude_file:if_prop=pheno_custom_related_exclude_file:allow_empty=1} > !{output,,pheno_basic_related_exclude_file} class_level pheno skip_if not_trait run_if !prune_all_related

#!@expand:,:type,extrainc,extraex:\
#popgen,pheno_sample_non_missing_unrelated_include_file,pheno_non_missing_related_exclude_file:\
#covar,pheno_sample_popgen_unrelated_include_file,pheno_popgen_related_exclude_file:\
#cluster,pheno_sample_popgen_unrelated_include_file,pheno_popgen_related_exclude_file@\
#short cmd make_pheno_type_related_exclude_file=\ 
#        $filter_sample_genome_file(!{input::pheno_sample_type_all_include_file} !{input::extrainc} | sort | uniq -d !{raw::pheno:| cat - *pheno_custom_related_exclude_file *pheno_custom_related_exclude_file | sort -u:if_prop=pheno_custom_related_exclude_file:allow_empty=1},pheno_genome_file) | perl $targeted_bin_dir/prune_most_ibd.pl !{input,--rank-file,pheno_related_exclude_rank_file,if_prop=pheno_related_exclude_rank_file,allow_empty=1} !{prop,,pheno,max_related} | $smart_cut_cmd !{input,--file,extraex} | sort -u !{raw::pheno:| cat - *pheno_custom_related_exclude_file | sort -u:if_prop=pheno_custom_related_exclude_file:allow_empty=1} !{input:pheno_custom_related_exclude_file:if_prop=pheno_custom_related_exclude_file:allow_empty=1} > !{output,,pheno_type_related_exclude_file} class_level pheno skip_if not_trait run_if !prune_all_related

#!!expand:,:type:non_missing:popgen:covar:cluster! \
#local cmd make_all_pheno_type_related_exclude_file=\ 
#        $filter_sample_genome_file(!{input::pheno_sample_type_all_include_file},pheno_genome_file) | perl $targeted_bin_dir/prune_most_ibd.pl !{input,--rank-file,pheno_related_exclude_rank_file,if_prop=pheno_related_exclude_rank_file,allow_empty=1} !{prop,,pheno,max_related} > !{output,,pheno_type_related_exclude_file} class_level pheno skip_if not_trait run_if !prune_all_related

filter_sample_genome_file=cat @1 | cut -d, -f1 | perl $targeted_bin_dir/filter_genome_file.pl !{input,,@2}

min_notable_pi_hat=.1

!!expand:,:_type:_all:_unrelated! \
short cmd make_pheno_type_related_dat_file=$filter_sample_genome_file(!{input::pheno_sample_basic_type_include_file},pheno_genome_file) | $smart_cut_cmd --select-col 0,1,IID1 --select-row 0,1 --select-col 0,1,PI_HAT --select-row 0,1,PI_HAT,gt:$min_notable_pi_hat > !{output,,pheno_type_related_dat_file} class_level pheno skip_if not_trait bsub_batch 5

!!expand:,:_type:_all:_unrelated! \
local cmd make_pheno_type_related_pdf_file=$draw_hist_plot_cmd("!{input,,pheno_type_related_dat_file} !{output,,pheno_type_related_pdf_file} PI_HAT 'Relatedness among QC+ !{prop,,pheno,disp} samples: PI_HAT > $min_notable_pi_hat' 'PI_HAT' x.min=$min_notable_pi_hat") class_level pheno skip_if not_trait

local cmd make_pheno_mds_exclude_file=eval `echo "!{prop,,pheno,mds_exclude_filters,missing_key=default_mds_exclude_filters,sep=;}" | sed 's/;/\n/g' | sed 's/\(\S\S*\)/ --select-row 1,1,\1/g' | sed 's;^;$smart_cut_cmd --tab-delim  --and-row-all --exclude-row 1,1 --exact !{input,--file,pheno_project_mds_file};' | sed '1! s/^/\| /' | tr '\n' ' '` | cut -f1 | $smart_cut_cmd --exec "tail -qn+2 !{input,,pheno_project_mds_file} !{input,,pheno_project_mds_file} | cut -f1 | cat - !{input,,pheno_sample_non_missing_all_include_file} | sort | uniq -u" | sort -u  > !{output,,pheno_mds_exclude_file} class_level pheno skip_if not_trait

local cmd make_pheno_basic_exclude_file=cat !{input,,pheno_mds_exclude_file} !{input,,project_duplicate_exclude_file} | sort -u > !{output,,pheno_basic_exclude_file} class_level pheno skip_if not_trait with project

local cmd make_empty_pheno_basic_exclude_file=echo > !{output,,pheno_basic_exclude_file} class_level pheno run_if not_trait with project

local cmd make_pheno_popgen_exclude_file=$detail_to_exclude("!{input,,pheno_popgen_exclude_detail_file}") > !{output,,pheno_popgen_exclude_file} class_level pheno skip_if not_trait

local cmd make_pheno_sample_non_missing_all_include_file=cut -f1 !{input,,pheno_non_missing_sample_info_file} | sort - !{input,,project_sample_include_file} | uniq -d > !{output,,pheno_sample_non_missing_all_include_file} class_level pheno with project

local cmd make_pheno_sample_basic_all_include_file=sort !{input,,pheno_sample_non_missing_all_include_file} !{input,,pheno_basic_exclude_file} !{input,,pheno_basic_exclude_file} | uniq -u > !{output,,pheno_sample_basic_all_include_file} class_level pheno with project

local cmd make_pheno_sample_popgen_all_include_file=sort !{input,,pheno_sample_basic_all_include_file} !{input,,pheno_popgen_exclude_file} !{input,,pheno_popgen_exclude_file} | uniq -u > !{output,,pheno_sample_popgen_all_include_file} class_level pheno

!!expand:filetype:covar:cluster!\
filetype_phe_file_helper_no_remove=grep -v \\\#\\\# !{input,,pheno_plinkseq_filetype_phe_file} | sed '1 s/^\\#//' 

!!expand:filetype:covar:cluster!\
filetype_phe_file_helper=$filetype_phe_file_helper_no_remove | perl -lane '(print && next) unless \\$i++; \\$skip = 0; foreach \\$f (@F) {\\$skip = 1 if \\$f == $ibs_cluster_missing} print unless \\$skip'

local cmd make_pheno_sample_cluster_all_include_file=$smart_join_cmd --out-delim $tab --col 1,2 --exec "$cluster_phe_file_helper | tail -n+2" --multiple 1 --extra 1 --in-delim 1,$tab --exec "$smart_cut_cmd --in-delim $tab !{input,--file,pheno_cluster_stats_file} --exclude-row 1,1 --select-row 1,1,PHENO_DEV,gt:0 --select-row 1,1,SIZE,gt:1 --and-row-all --select-col 1,1" | cut -f2 | sort - !{input,,pheno_sample_popgen_all_include_file} | uniq -d > !{output,,pheno_sample_cluster_all_include_file} class_level pheno

local cmd make_pheno_sample_covar_all_include_file=$smart_cut_cmd --exec "$covar_phe_file_helper" --in-delim $tab --select-col 1,1 --exclude-row 1,1 | sort - !{input,,pheno_sample_popgen_all_include_file} | uniq -d > !{output,,pheno_sample_covar_all_include_file} class_level pheno

!!expand:,:filetype,intersectwith:non_missing,pheno_sample_non_missing_all_include_file:basic,pheno_sample_basic_all_include_file:popgen,pheno_sample_non_missing_unrelated_include_file:covar,pheno_sample_popgen_unrelated_include_file:cluster,pheno_sample_popgen_unrelated_include_file! \
local cmd make_pheno_sample_filetype_unrelated_include_file=sort !{input,,pheno_sample_filetype_all_include_file} !{input,,pheno_basic_related_exclude_file} !{input,,pheno_basic_related_exclude_file} | uniq -u | sort - !{input,,intersectwith} | uniq -d > !{output,,pheno_sample_filetype_unrelated_include_file} class_level pheno

!!expand:alltype:all:unrelated! \
!!expand:filetype:non_missing:basic:popgen:covar:cluster! \
local cmd make_pheno_sample_plink_filetype_alltype_include_file=$sample_list_to_plink_sample_list("!{input,--file,pheno_sample_filetype_alltype_include_file}",0) > !{output,,pheno_sample_plink_filetype_alltype_include_file} class_level pheno

qc_plus_col=3
local cmd make_pheno_sample_failure_status_file=perl -lne 'BEGIN {open IN, "!{input,,pheno_popgen_exclude_file}"; while (<IN>) {chomp; \$ibd_failed{\$_} = 1} close IN; open IN, "!{input,,pheno_basic_related_exclude_file}"; while (<IN>) {chomp; \$related_failed{\$_} = 1} close IN; open IN, "!{input,,pheno_sample_covar_unrelated_include_file}"; while (<IN>) {chomp; \$covar_passed{\$_} = 1} close IN; open IN, "!{input,,pheno_sample_cluster_unrelated_include_file}"; while (<IN>) {chomp; \$cluster_passed{\$_} = 1} close IN; } chomp; @F = split("\t"); if (\$first) {if (\$ibd_failed{\$F[0]}) {push @F, 1; \$F[$qc_plus_col] = 0} else {push @F, 0} if (\$related_failed{\$F[0]}) {push @F, 1; \$F[$qc_plus_col] = 0} else {push @F, 0;} if (\$covar_passed{\$F[0]}) {push @F, 1;} else {push @F, 0;} if (\$cluster_passed{\$F[0]}) {push @F, 1} else {push @F, 0;} } else {\$first = 1; push @F, "$popgen_fail_status\t$related_fail_status\t$covar_pass_status\t$cluster_pass_status"} print join("\t", @F)' < !{input,,project_sample_failure_status_file} > !{output,,pheno_sample_failure_status_file} class_level pheno skip_if not_trait

local cmd make_pheno_sample_failure_status_file=perl -lne 'BEGIN {open IN, "!{input,,pheno_popgen_exclude_file}"; while (<IN>) {chomp; \$ibd_failed{\$_} = 1} close IN; open IN, "!{input,,pheno_basic_related_exclude_file}"; while (<IN>) {chomp; \$related_failed{\$_} = 1} close IN; open IN, "!{input,,pheno_sample_covar_unrelated_include_file}"; while (<IN>) {chomp; \$covar_passed{\$_} = 1} close IN; open IN, "!{input,,pheno_sample_cluster_unrelated_include_file}"; while (<IN>) {chomp; \$cluster_passed{\$_} = 1} close IN; } chomp; @F = split("\t"); if (\$first) {if (\$ibd_failed{\$F[0]}) {push @F, 1; \$F[$qc_plus_col] = 0} else {push @F, 0} if (\$related_failed{\$F[0]}) {push @F, 1; \$F[$qc_plus_col] = 0} else {push @F, 0;} if (\$covar_passed{\$F[0]}) {push @F, 1;} else {push @F, 0;} if (\$cluster_passed{\$F[0]}) {push @F, 1} else {push @F, 0;} } else {\$first = 1; push @F, "$popgen_fail_status\t$related_fail_status\t$covar_pass_status\t$cluster_pass_status"} print join("\t", @F)' < !{input,,project_sample_failure_status_file} > !{output,,pheno_sample_failure_status_file} class_level pheno skip_if not_trait

prop rank_prop=scalar

rank_prop_header=rank

get_non_missing_with_header=$add_header_cmd !{input,,pheno_sample_info_header_file} --from-file < !{input,,pheno_non_missing_sample_info_file} | sed 's/\\\#//1' | cut -f1,3,4

pheno_qc_dat_helper=$smart_join_cmd --exec "$get_non_missing_with_header" !{input,--file,@1} --arg-delim : --in-delim 1:$tab --in-delim 2:$coverage_dat_delim --header 1 --out-delim $coverage_dat_delim --extra 2 class_level pheno
pheno_qc_pdf_helper=$draw_box_plot_cmd(!{input\,\,@1} !{output\,\,@2} @3 $frac_above_threshold label=2 sep=$coverage_dat_delim @4) class_level pheno

!|expand:;:qttype;pheno_select;extrarunif:;!{prop,,pheno},!{prop,,pheno,curpheno_pheno,missing_key=default_curpheno_pheno};skip_if or,not_trait,pheno_qt,no_coverage:_qt;$pheno_half,$default_curpheno_pheno;run_if pheno_qt skip_if or,not_trait,no_coverage| \
!!expand:curpheno:case:control! \
local cmd make_phenoqttype_curpheno_sample_coverage_file_list=$smart_join_cmd --exec "$smart_cut_cmd !{input,--file,pheno_all_sample_info_file} --in-delim $tab --select-col 1,1 --select-row 1,1,pheno_select --exclude-row 1,1" !{input,--file,project_sample_coverage_file_list} --extra 2 --out-delim $tab | cut -f2 > !{output,,pheno_curpheno_sample_coverage_file_list} class_level pheno extrarunif

prop cross_classification=scalar
downstream_cross_helper=sed '1 s/\t\(\S\S*\)\t\($display_col_name\)/\t\2\t\1/g' | $smart_cut_cmd --in-delim $tab --exclude-col 0,1,$display_col_name | $smart_cut_cmd --in-delim $tab --select-col 0,1 --select-col 0,1,!{prop,,pheno,if_prop=pheno:eq:@cross_classification,if_prop=project:eq:@project,all_instances=1,sep=:} --vec-delim : 

local cmd make_pheno_cross_classification_phe_file=$smart_join_cmd --exec "$smart_cut_cmd !{input,--file,pheno_sequenced_all_sample_info_file} --in-delim $tab --select-col 1,1" !{raw,--exec,pheno,"$smart_cut_cmd --file *pheno_sequenced_all_sample_info_file --in-delim $tab --select-col 1\,1 --select-col 1\,2 --select-col 1\,1\,$display_col_name",if_prop=pheno:eq:@cross_classification,if_prop=project:eq:@project,all_instances=1,allow_empty=1} !{input,pheno_sequenced_all_sample_info_file,if_prop=pheno:eq:@cross_classification,if_prop=project:eq:@project,all_instances=1,allow_empty=1} --in-delim $tab --out-delim $tab | $downstream_cross_helper > !{output,,pheno_cross_classification_phe_file} class_level pheno run_if cross_classification

local cmd make_pheno_sample_coverage_dat_file=$pheno_qc_dat_helper(project_sample_coverage_dat_file) > !{output,,pheno_sample_coverage_dat_file} class_level pheno skip_if no_coverage
local cmd make_pheno_sample_coverage_pdf_file=$pheno_qc_pdf_helper(pheno_sample_coverage_dat_file,pheno_sample_coverage_pdf_file,'Coverage by !{prop\\,\\,pheno\\,disp}' '' '% bases >= ${threshold}x',order=$order_col_name) class_level pheno skip_if no_coverage

!|expand:;:shortt;phenol;projectl;extrakeep;extrarunif;rusageadd:;pheno;project;;;rusage_mod $project_plink_mem:short;pheno_variant_subset;project_variant_subset;!{input,--extract,pheno_variant_subset_var_keep_file};run_if num_var_subsets bsub_batch 3;| \
shortt cmd make_phenol_plink_files=$plink_cmd $plink_in_bed_helper(projectl_plinkseq_qc_plus) --make-bed !{input,--pheno,pheno_plink_phe_file} !{input,--keep,pheno_sample_plink_basic_all_include_file} extrakeep $plink_out_bed_helper(phenol) && $plink_mv_log_cmd(!{raw\,\,phenol\,*phenol_plink_file},!{output\,\,phenol_make_bed_log_file}) class_level phenol skip_if not_trait extrarunif rusageadd run_with pheno_sample_subset

short cmd ln_pheno_variant_subset_clean_all_vcf_file=ln -s !{input,,project_variant_subset_clean_all_vcf_file} !{output,,pheno_variant_subset_clean_all_vcf_file} && !{raw,,pheno_variant_subset,$run_tabix_cmd(pheno_variant_subset_clean_all_vcf_file)} class_level pheno_variant_subset run_if expand_pheno_subsets:eq:1 bsub_batch 10

short cmd make_pheno_variant_subset_clean_all_vcf_file=zcat !{input,,project_variant_subset_clean_all_vcf_file} | $vcf_utils_cmd !{input,--var-keep,pheno_variant_subset_var_keep_file} | $bgzip_cmd > !{output,,pheno_variant_subset_clean_all_vcf_file} && !{raw,,pheno_variant_subset,$run_tabix_cmd(pheno_variant_subset_clean_all_vcf_file)} class_level pheno_variant_subset run_if expand_pheno_subsets:ne:1 bsub_batch 2

cmd make_pheno_sample_combined_plink_files=$plink_cmd $plink_in_bed_helper(project_sample_combined) --make-bed !{input,--keep,pheno_sample_plink_basic_all_include_file} !{input,--pheno,pheno_plink_phe_file} $plink_out_bed_helper(pheno_sample_combined) && $plink_mv_log_cmd(!{raw\,\,pheno\,*pheno_sample_combined_plink_file},!{output\,\,pheno_sample_combined_make_bed_log_file}) class_level pheno skip_if not_trait

cmd make_pheno_sample_pruned_marker_plink_files=$plink_marker_helper !{input,--pheno,pheno_plink_phe_file} !{input,--keep,pheno_sample_plink_basic_all_include_file} --make-bed $plink_out_bed_helper(pheno_sample_pruned_marker) && $plink_mv_log_cmd(!{raw\,\,pheno\,*pheno_sample_pruned_marker_plink_file},!{output\,\,pheno_sample_pruned_marker_make_bed_log_file}) class_level pheno skip_if not_trait run_if and,!recompute_pca,!recompute_genome

cmd make_new_pheno_sample_pruned_marker_plink_files=$plink_cmd !{input,--pheno,pheno_plink_phe_file} !{input,--keep,pheno_sample_plink_basic_all_include_file} $pheno_marker_filters(sample) $plink_in_bed_helper(project_sample_marker) --make-bed $plink_out_bed_helper(pheno_sample_pruned_marker) && $plink_mv_log_cmd(!{raw\,\,pheno\,*pheno_sample_pruned_marker_plink_file},!{output\,\,pheno_sample_pruned_marker_make_bed_log_file}) class_level pheno skip_if not_trait run_if or,recompute_pca,recompute_genome rusage_mod $project_plink_mem

local cmd make_pheno_additional_popgen_plink_exclude_file=$sample_list_to_plink_sample_list("!{input,--file,pheno_additional_popgen_exclude_file}",0) > !{output,,pheno_additional_popgen_plink_exclude_file} class_level pheno run_if pheno_additional_popgen_exclude_file

short cmd make_pheno_sample_for_pca_plink_files=$make_for_pca_helper(pheno_sample_pruned_marker,pheno,!{input;--keep;pheno_sample_plink_popgen_all_include_file}) class_level pheno run_if and,marker;add_for_pca,!pheno_additional_popgen_exclude_file

short cmd make_pheno_sample_for_pca_with_filter_plink_files=$make_for_pca_helper(pheno_sample_pruned_marker,pheno,!{input;--remove;pheno_additional_popgen_plink_exclude_file} !{input;--keep;pheno_sample_plink_popgen_all_include_file}) class_level pheno run_if and,marker;add_for_pca,pheno_additional_popgen_exclude_file

short cmd filter_pheno_sample_for_pca_plink_files=$plink_cmd $plink_in_bed_helper(pheno_sample_pruned_marker) !{input;--keep;pheno_sample_plink_popgen_all_include_file} --make-bed $plink_out_bed_helper(pheno_sample_for_pca) && $plink_mv_log_cmd(!{raw\,\,pheno\,*pheno_sample_for_pca_plink_file},!{output\,\,pheno_sample_for_pca_make_bed_log_file}) class_level pheno run_if and,!marker;add_for_pca

local cmd make_pheno_top_hits_snp_ids_file=$smart_cut_cmd !{input,--file,project_sample_combined_bim_file} --exec "$smart_cut_cmd !{input,--file,pheno_all_marker_top_hits_file} --select-col 1,1,'CHROM POS' | sed 's/$/ 1/' | tail -n+2" --select-col 1,'1 4 2' | sort -ns -k1,1 -k2,2 | awk '{print \$3,\$1,\$2}' | uniq -d -f1 | awk '{print \$1}' > !{output,,pheno_top_hits_snp_ids_file} class_level pheno run_if and,!not_trait,pheno_all_marker_top_hits_file

top_hit_r2_threshold=.2
cmd make_pheno_top_hits_ld_file=$plink_cmd $plink_in_bed_helper(pheno_sample_combined) !{input,--ld-snp-list,pheno_top_hits_snp_ids_file} --ld-window-kb 10000 --ld-window 99999 --ld-window-r2 $top_hit_r2_threshold !{raw,--out,pheno,*pheno_top_hits_ld_trunk} !{output,pheno_top_hits_ld_file} && $plink_mv_log_cmd(!{raw\,\,pheno\,*pheno_top_hits_ld_trunk},!{output\,\,pheno_top_hits_ld_log_file}) class_level pheno run_if and,!not_trait,pheno_all_marker_top_hits_file

local cmd make_pheno_top_hits_ld_chr_pos_list=$smart_join_cmd --exec "$smart_cut_cmd !{input,--file,pheno_top_hits_ld_file} !{input,--file,pheno_top_hits_ld_file} --select-col 1,1,SNP_A --select-col 2,1,SNP_B --exclude-row 1,1 --exclude-row 2,1 | sort -u" --exec "awk '{print \\$2,\\$1,\\$4}' !{input,,project_sample_combined_bim_file}" --out-delim $tab --extra 2 | cut -f2- > !{output,,pheno_top_hits_ld_chr_pos_list} class_level pheno run_if and,!not_trait,pheno_all_marker_top_hits_file

local cmd make_pheno_top_hits_ld_seq_var_list=$smart_cut_cmd !{input,--file,project_clean_gene_variant_file} --exec "sed 's/$/\t1/' !{input,,pheno_top_hits_ld_chr_pos_list}" --in-delim $tab --select-col 1,1,'CHROM POS ID' | sort -sn -k1,1 -k2,2 | $smart_cut_cmd --in-delim $tab --select-col 0,'3 1 2' | uniq -d -f1 | cut -f1 > !{output,,pheno_top_hits_ld_seq_var_list} class_level pheno run_if and,!not_trait,pheno_all_marker_top_hits_file

!|expand:,:shortt,phenol,extrarunif:,pheno,run_if !num_var_subsets:short,pheno_variant_subset,run_if num_var_subsets bsub_batch 20| \
shortt cmd make_phenol_test_missing_file=$plink_analysis_phenol_bed_cmd(phenol_test_missing_file,test-missing --allow-no-sex,missing,phenol_test_missing_log_file) class_level phenol skip_if or,not_trait,pheno_qt extrarunif

!|expand:,:shortt,phenol,extrarunif:,pheno,run_if !num_var_subsets:short,pheno_variant_subset,run_if num_var_subsets| \
shortt cmd make_phenol_hwe_file=$plink_analysis_phenol_bed_cmd(phenol_hwe_file,hardy --allow-no-sex,hwe,phenol_hwe_log_file) class_level phenol skip_if not_trait extrarunif

!!expand:male:male:female! \
!|expand:,:shortt,phenol,extrarunif:,pheno,run_if !num_var_subsets:short,pheno_variant_subset,run_if num_var_subsets bsub_batch 20| \
shortt cmd make_phenol_male_hwe_file=$plink_analysis_phenol_bed_cmd(phenol_male_hwe_file,hardy --allow-no-sex !{input;--filter;pheno_plink_phe_file;instance_level=pheno;if_prop=project:eq:@project;all_instances=1;if_prop=pheno:eq:sex} $plink_male,hwe,phenol_male_hwe_log_file) class_level phenol skip_if not_trait extrarunif

!|expand:,:shortt,phenol,extrarunif:,pheno,run_if !num_var_subsets:short,pheno_variant_subset,run_if num_var_subsets| \
shortt cmd make_phenol_lmiss_file=$plink_analysis_phenol_bed_cmd(phenol_lmiss_file,missing --allow-no-sex,lmiss,phenol_lmiss_log_file) class_level phenol skip_if not_trait extrarunif

!|expand:,:shortt,phenol,extrarunif:,pheno,run_if !num_var_subsets:short,pheno_variant_subset,run_if num_var_subsets| \
shortt cmd make_phenol_frq_file=$plink_analysis_phenol_bed_cmd(phenol_frq_file,freq --nonfounders --allow-no-sex,frq,phenol_frq_log_file) class_level phenol skip_if not_trait extrarunif

!|expand:,:shortt,phenol,projectt,extrarunif:,pheno,project,run_if !num_var_subsets:short,pheno_variant_subset,project_variant_subset,run_if num_var_subsets bsub_batch 20| \
shortt cmd make_phenol_sex_frq_file=$plink_analysis_phenol_bed_cmd(phenol_sex_frq_file,freq --nonfounders --allow-no-sex !{input;--within;pheno_plink_phe_file;instance_level=pheno;if_prop=project:eq:@project;all_instances=1;if_prop=pheno:eq:sex},frq.strat,phenol_sex_frq_log_file) class_level phenol skip_if not_trait extrarunif

!|expand:,:phenol,projectt:pheno,project:pheno_variant_subset,project_variant_subset| \
phenol_multiallelic_qc_helper=$multiallelic_qc_cmd !{input,,pheno_sample_basic_all_include_file} -spl_field:1 -out:!{output,,@1} -condition_on:$thresholded_nalt_field -var_mask:"file=$pseq_multiallelic_tag reg.ex=$chrX; reg=$chrX" -pseq_project:!{input,,projectt_plinkseq_clean_project_file} !{input,-pheno_file:,pheno_non_missing_sample_pheno_file,if_prop=pheno:eq:sex,allow_empty=1,all_instances=1,if_prop=project:eq:\@project,max=1,instance_level=pheno,sep=} !{raw,,pheno,-pheno_field:2 -pheno_id_field:1 -pheno_sel:eq$plink_female,if_prop=pheno:eq:sex,allow_empty=1,all_instances=1,if_prop=project:eq:\@project,max=1} -chrX_code:$chrX

!|expand:,:shortt,phenol,projectt,extrarunif:,pheno,project,run_if !num_var_subsets:short,pheno_variant_subset,project_variant_subset,run_if num_var_subsets| \
shortt cmd make_phenol_multiallelic_frq_file=$phenol_multiallelic_qc_helper(phenol_multiallelic_frq_file) class_level phenol skip_if not_trait extrarunif

!|expand:,:shortt,phenol,projectt,extrarunif:,pheno,project,run_if !num_var_subsets:short,pheno_variant_subset,project_variant_subset,run_if num_var_subsets| \
shortt cmd make_phenol_multiallelic_group_frq_file=$phenol_multiallelic_qc_helper(phenol_multiallelic_group_frq_file) -m_group_file:!{input,,pheno_plink_phe_file,unless_prop=pheno_qt,allow_empty=1} !{raw,,pheno,-m_group_field:3 -m_id_field:2 -m_group_missing:$plink_missing,unless_prop=pheno_qt,allow_empty=1} -m_group_affected=$case_pheno_helper class_level phenol skip_if not_trait extrarunif

!|expand:,:shortt,phenol,projectt,extrarunif:,pheno,project,run_if !num_var_subsets:short,pheno_variant_subset,project_variant_subset,run_if num_var_subsets| \
shortt cmd make_phenol_combined_combined_frq_file=$combined_frq_helper(phenol_frq_file,phenol_multiallelic_frq_file) > !{output,,phenol_combined_frq_file} class_level phenol skip_if not_trait extrarunif

local cmd make_pheno_high_test_missing_file=$smart_join_cmd --in-delim $tab --exec "$smart_cut_cmd !{input,--file,pheno_test_missing_file} --select-col 1,1,SNP --exact --select-row 1,1 --select-row 1,1,P,lt:!{prop,,pheno,min_clean_p_missing}" --exec "$smart_cut_cmd !{input,--file,project_clean_gene_variant_file} --in-delim $tab --select-col 1,1,'ID CHROM POS'" --header 1 --extra 2 | $smart_cut_cmd --in-delim $tab --exclude-row 0,1 > !{output,,pheno_high_test_missing_file} class_level pheno skip_if or,not_trait,pheno_qt

get_covar_traits=`($smart_cut_cmd --file /dev/null !{input,--file,pheno_indicator_list_file,if_prop=pheno:eq:\@covar_traits,unless_prop=pheno_qt,if_prop=project:eq:\@project,instance_level=pheno,all_instances=1,allow_empty=1} --exclude-row .,1 | sort - !{input,,@{2}_variable_covars_file} | uniq -d && perl -e 'print qq(!{prop,,pheno,if_prop=pheno:eq:\@covar_traits,if_prop=project:eq:\@project,if_prop=pheno_qt,all_instances=1,allow_empty=1,sep=\n}!{raw,,@2,\n,if_prop=manual_covar_traits,allow_empty=1}!{prop,,@2,manual_covar_traits,if_prop=manual_covar_traits,allow_empty=1,sep=\n})') | awk 'NF > 0' | perl -pe 's/\n/@1/' | sed 's/@1$//'`

add_cluster=--strata !{raw,,project,$ibs_cluster_pheno}
add_strata=$add_cluster!{raw,,@1,\,,if_prop=strata_traits,allow_empty=1}!{prop,,@1,strata_traits,if_prop=strata_traits,sep=\,,allow_empty=1}

add_covar=--covar $get_covar_traits( ,@1)!{raw::@1: :if_prop=strat_covar:if_prop=covar_traits:allow_empty=1}!{raw::@1: :if_prop=strat_covar:if_prop=manual_covar_traits:unless_prop=covar_traits:allow_empty=1}`!{raw::@1:$get_mds_cols(\@num_mds_covar, ):if_prop=strat_covar:allow_empty=1}`

qt_plinkseq_phenotype_selector_raw=!{prop,@1,pheno,unless_prop=pheno_qt,allow_empty=1}!{raw,@1,pheno,$pheno_extreme_for_raw,if_prop=pheno_qt,allow_empty=1}
qt_plinkseq_phenotype_selector=$qt_plinkseq_phenotype_selector_raw(--phenotype)

#!|expand:;:keyext;extracmd;extrarunif:\
#strata_;$add_cluster;run_if or,run_cluster,strata_traits:\
#;;|\
#cmd make_pheno_keyextvdist_file=$pseq_qc_plus_analysis_cmd_pheno_cluster(v-dist) $qt_plinkseq_phenotype_selector !{input,pheno_is_trait_file} extracmd > !{output,,pheno_keyextvdist_file} class_level pheno extrarunif run_with pheno_variant_subset,burden_variant_subset

!|expand:,:shortt,phenol,extrarunif:,pheno,run_if !num_var_subsets:short,pheno_variant_subset,run_if num_var_subsets| \
shortt cmd make_phenol_counts_file=$pseq_qc_plus_all_assoc_cmd_phenol(counts) $qt_plinkseq_phenotype_selector > !{output,,phenol_counts_file} class_level phenol skip_if not_trait extrarunif

local cmd make_pheno_sstats_file=$pheno_qc_dat_helper(project_sstats_file) > !{output,,pheno_sstats_file} class_level pheno with project

with_genome_delim=,

short cmd make_pheno_with_genome_file=$smart_join_cmd --exec "$smart_cut_cmd --exec 'zcat !{input,,project_sample_marker_genome_file}' --select-col 1,1,IID1 --select-col 1,1,IID2 --exclude-row 1,1 --out-delim $tab | sed 's/\t/\n/g' | sort -u | $smart_cut_cmd !{input,--file,pheno_non_missing_sample_info_file} --in-delim $tab --select-col 1,1 | sort | uniq -d | cat - !{input,,project_sample_include_file} | sort | uniq -d | sed '1 s/^/ID\n/'" --exec "$get_non_missing_with_header" --in-delim $tab --out-delim $with_genome_delim $tab --header 1 --extra 2 | tail -n+2 > !{output,,pheno_with_genome_file} class_level pheno skip_if recompute_genome run_with pheno_variant_subset

prop recompute_genome=scalar default 0

#Assumes order cols are always numeric
restart_mem short cmd make_filter_pheno_genome_file=$filter_sample_genome_file(!{input::pheno_with_genome_file},project_sample_marker_genome_file) | gzip -c > !{output,,pheno_genome_file} class_level pheno skip_if or,recompute_genome,(and,num_samp_subsets,parallelize_genome)

#restart_mem short cmd make_pheno_annotated_genome_file=$smart_join_cmd --exec "while read a; do while read b; do echo \\$a$with_genome_delim\\$b; done < !{input,,pheno_with_genome_file}; done < !{input,,pheno_with_genome_file} | sed '1 s/^/ID1$with_genome_delim${display_col_name}1$with_genome_delim${order_col_name}1${with_genome_delim}ID2$with_genome_delim${display_col_name}2$with_genome_delim${order_col_name}2\n/' | perl -ne 'chomp; @cols = split(/$with_genome_delim/); @out = (); push @out, \\$cols[0]; push @out, \\$cols[3]; @scols = sort(@cols[2,5]); \\$lineno++; if (\\$lineno == 1 || join(\":\", @scols) == join(\":\", @cols[2,5])) {@slice1 = (1,4); @slice2 = (2,5)} else {@slice1 = (4,1); @slice2 = (5,2)} push @out, join(\"/\", @cols[@slice1]); push @out, join(\"\", @cols[@slice2]); print join(\"$with_genome_delim\", @out); print \"\n\"' | sed 's/,/\t/g' | sed 's/^\(\S*\)\(\s*\)\(\S*\)/\1:\3\2\1\2\3/'" --exec "zcat !{input,,pheno_genome_file} | $smart_cut_cmd --exclude-col 0,1,'FID1 FID2' --out-delim $tab | sed 's/^\(\S*\)\(\s*\)\(\S*\)/\1:\3/'" --extra 1 --in-delim $tab --header 1 --out-delim $tab | cut -f2- | sed '1 s/${display_col_name}1\/${display_col_name}2/${display_col_name}/' | sed '1 s/${order_col_name}1${order_col_name}2/${order_col_name}/' | gzip -c > !{output,,pheno_annotated_genome_file} class_level pheno rusage_mod $pheno_genome_mem run_with pheno_variant_subset 


#Different than for project
#Compute between people at this level and everyone else
!|expand:;:shortt;phenol;runif;exflags:;pheno;run_if or,!num_samp_subsets,!parallelize_genome;:short;pheno_sample_subset;run_if and,num_samp_subsets,parallelize_genome;!{input,--read-freq,pheno_frq_file} --genome-lists !{input,,project_sample_subset_sample_marker_genome_list1_file} !{input,,pheno_sample_pruned_marker_fam_file}| \
shortt cmd make_phenol_genome_file=$plink_cmd $plink_in_bed_helper(pheno_sample_pruned_marker) --genome --Z-genome exflags !{raw,--out,phenol,*phenol_genome_trunk} !{output,phenol_genome_file} && $plink_mv_log_cmd(!{raw\,\,phenol\,*phenol_genome_trunk},!{output\,\,phenol_genome_log_file}) class_level phenol runif skip_if !recompute_genome

short cmd make_subset_pheno_sample_subset_genome_file=awk '{print \$2}' !{input::project_sample_subset_sample_marker_genome_list1_file} | cat - !{input,,pheno_sample_basic_all_include_file} | sort | uniq -d | $filter_sample_genome_file(-,project_sample_marker_genome_file) '' EITHER !{input,,pheno_sample_non_missing_all_include_file} | gzip -c > !{output,,pheno_sample_subset_genome_file} class_level pheno_sample_subset skip_if or,recompute_genome,!parallelize_genome

short cmd make_pheno_sample_subset_genome_for_cat_file=$smart_join_cmd --exec "zcat !{input,,pheno_sample_subset_genome_file} | awk 'NR > 1 {print \\$1,\\$2}' | sort -u | cat !{input,,project_sample_subset_sample_marker_genome_list1_file} - | sort | uniq -d | $add_header_cmd 'IID1 FID1' " --exec "zcat !{input,,pheno_sample_subset_genome_file}" --header 1 --col 1 --col 2 --extra 2 --multiple 2 | awk '{s=\$1; \$1=\$2; \$2=s} {print}' | gzip -c > !{output,,pheno_sample_subset_genome_for_cat_file} class_level pheno_sample_subset run_if parallelize_genome bsub_batch 5

short cmd make_cat_pheno_genome_file=zcat !{input,,pheno_sample_subset_genome_for_cat_file,sort_prop=pheno_sample_subset} | awk 'NR==1 {a=\$1; print} NR > 1 && \$1 != a {print}' | gzip -c > !{output,,pheno_genome_file} class_level pheno run_if and,num_samp_subsets,parallelize_genome skip_if not_trait

local cmd make_pheno_project_mds_file=$smart_join_cmd --exec "$smart_cut_cmd !{input,--file,project_sample_marker_mds_file} --select-col 1,1,IID --exclude-row 1,1 | $smart_cut_cmd !{input,--file,pheno_non_missing_sample_info_file} --in-delim $tab --select-col 1,1 | sort | uniq -d | cat - !{input,,project_sample_include_file} | sort | uniq -d  | sed '1 s/^/ID\n/'" --exec "$get_non_missing_with_header" --exec "$smart_cut_cmd !{input,--file,project_sample_marker_mds_file} --exclude-col 1,1,FID --exclude-col 1,1,SOL --out-delim $tab"  --in-delim $tab --header 1 --out-delim $tab --extra 2 --extra 3 > !{output,,pheno_project_mds_file} class_level pheno with project

smart_pca_num_outlier_iter=5
smart_pca_num_outlier_evec=10
smart_pca_outlier_sigma_thresh=6
smart_pca_qtmode=!{raw,,pheno,0,unless_prop=pheno_qt,allow_empty=1}!{raw,,pheno,1,if_prop=pheno_qt,allow_empty=1}

prop recompute_pca=scalar default 0
prop remove_pca_outliers=scalar default 1 #when running PCA with eigenstrat, remove outliers

#meta_table cmd make_pheno_smart_pca_par_file=!{raw,genotypename:,pheno,*pheno_sample_pruned_marker_bed_file}\n!{raw,snpname:,pheno,*pheno_sample_popgen_pruned_marker_bim_file}\n!{raw,indivname:,pheno,*pheno_sample_popgen_pruned_marker_fam_file}\n!{raw,evecoutname:,pheno,*pheno_smart_pca_evec_file}\n!{raw,evaloutname:,pheno,*pheno_smart_pca_eval_file}\naltnormstyle: NO\nnumoutevec: !{prop,,pheno,num_mds_calc}\nnumoutlieriter: !{raw,,pheno,$smart_pca_num_outlier_iter,if_prop=remove_pca_outliers,allow_empty=1}!{raw,,pheno,0,unless_prop=remove_pca_outliers,allow_empty=1}\nnumoutlierevec: $smart_pca_num_outlier_evec\noutliersignmathresh: $smart_pca_outlier_sigma_thresh\nqtmode: $smart_pca_qtmode !{output,pheno_smart_pca_par_file} class_level pheno run_if and,use_eigenstrat,!pheno_custom_mds_file

#cmd make_pheno_smart_pca_out_files=$smart_pca_cmd !{input,-p,pheno_smart_pca_par_file} > !{output,,pheno_smart_pca_log_file} !{input,pheno_sample_popgen_pruned_marker_bed_file} !{input,pheno_sample_popgen_pruned_marker_bim_file} !{input,pheno_sample_popgen_pruned_marker_fam_file} !{output,pheno_smart_pca_evec_file} !{output,pheno_smart_pca_eval_file} class_level pheno run_if and,use_eigenstrat,!pheno_custom_mds_file

short cmd make_pheno_sample_marker_pruned_initial_vcf_file=$marker_pruned_initial_vcf_helper(pheno,pheno_sample_pruned_marker) class_level pheno rusage_mod $project_plink_mem run_if or,recompute_genome,recompute_pca skip_if not_trait

#need to do this since marker may not be sorted same way as VCF

short cmd make_pheno_sample_marker_pruned_vcf_file=$marker_pruned_vcf_helper(pheno) class_level pheno run_if and,use_marker_for_sample_ibd,!not_trait skip_if and,!recompute_genome,!recompute_pca

short cmd ln_pheno_sample_marker_pruned_vcf_file=ln -s !{input,,pheno_sample_marker_pruned_initial_vcf_file} !{output,,pheno_sample_marker_pruned_vcf_file} && !{raw,,pheno,$run_tabix_cmd(pheno_sample_marker_pruned_vcf_file)} class_level pheno skip_if or,use_marker_for_sample_ibd,not_trait run_if and,(or,recompute_genome,recompute_pca)

short cmd ln_from_project_pheno_sample_marker_pruned_vcf_file=ln -s !{input,,project_sample_marker_pruned_vcf_file} !{output,,pheno_sample_marker_pruned_vcf_file} && !{raw,,pheno,$run_tabix_cmd(pheno_sample_marker_pruned_vcf_file)} class_level pheno skip_if or,use_marker_for_sample_ibd,recompute_genome,recompute_pca,not_trait

local cmd make_pheno_epacts_ready_file=touch !{output,,pheno_epacts_ready_file} class_level pheno

cmd make_pheno_kinship_file=$kinship_helper(pheno) class_level pheno rusage_mod $kin_mem run_if recompute_genome skip_if not_trait run_with pheno_sample_subset

local cmd ln_pheno_kinship_file=ln -s !{input,,project_kinship_file} !{output,,pheno_kinship_file} class_level pheno rusage_mod $kin_mem skip_if or,recompute_genome,not_trait

local cmd make_pheno_smart_pca_fam_file=$pheno_smart_pca_fam_file_helper(pheno_sample_for_pca_fam_file) | cat !{input,,pheno_basic_related_exclude_file} - | awk 'NF == 1 {m[\$1]=1} NF == 6 {if (m[\$2] ) {\$6=$pca_ignore_pop} } NF == 6 {print}' | $smart_pca_remap_helper(0,2) > !{output,,pheno_smart_pca_fam_file} class_level pheno run_if recompute_pca 

local cmd make_pheno_sample_subset_smart_pca_fam_file=$project_sample_subset_smart_pca_fam_file_helper(pheno_smart_pca_fam_file) > !{output,,pheno_sample_subset_smart_pca_fam_file} class_level pheno_sample_subset run_if and,recompute_pca,parallelize_pca

!|expand:;:shortt;phenos;exrunif:;pheno;skip_if and,num_samp_subsets,parallelize_pca:short;pheno_sample_subset;skip_if !parallelize_pca| \
shortt cmd make_phenos_smart_pca_out_files=$smart_pca_cmd !{input,-i,pheno_sample_for_pca_bed_file} !{input,-a,pheno_sample_for_pca_bim_file} !{input,-b,phenos_smart_pca_fam_file} !{input,-w,project_sample_marker_smart_pca_poplist_file} !{prop,-k,pheno,num_mds_calc} !{raw,-o,phenos,*phenos_smart_pca_trunk} !{output,phenos_smart_pca_evec_file} !{output,-e,phenos_smart_pca_eval_file} !{raw,-p,phenos,*phenos_smart_pca_trunk} !{output,-g,phenos_smart_pca_weights_file} !{output,-l,phenos_smart_pca_log_file} -m !{raw,,pheno,$smart_pca_num_outlier_iter,if_prop=remove_pca_outliers,allow_empty=1}!{raw,,pheno,0,unless_prop=remove_pca_outliers,allow_empty=1} -t $smart_pca_num_outlier_evec -s $smart_pca_outlier_sigma_thresh -q $smart_pca_qtmode class_level phenos run_if and,!pheno_custom_mds_file,recompute_pca exrunif

parse_pheno_mds_helper=$smart_join_cmd --in-delim $tab --exec "cat !{input,,@{1}_smart_pca_fam_file} | awk '{print \\$2}' | $smart_cut_cmd --exec '$smart_cut_cmd !{input,--file,@{1}_smart_pca_evec_file} --select-col 1,1 --exclude-row 1,1' --in-delim : --select-col 1,2 | sort | uniq -d | $smart_pca_remap_helper_int(2,0,0, ,\) | cat - !{input,,@2} | sort | uniq -d | sed '1 s/^/IID\n/'" --exec "$evec_to_mds_helper_int(@{1}_smart_pca_evec_file,@1,\) | $smart_pca_remap_helper_int(2,0,1,\\t,\)" --extra 2 --col 2,2 --header 1 | sed 's/^\(\S\S*\)\(\s\s*\)\(\S\S*\)/\3\2\1/'

short cmd parse_pheno_sample_subset_mds_file=$parse_pheno_mds_helper(pheno_sample_subset,project_sample_subset_samp_keep_file) > !{output,,pheno_sample_subset_mds_file} class_level pheno_sample_subset run_if and,parallelize_pca,!pheno_custom_mds_file,recompute_pca

local cmd parse_pheno_mds_file=$parse_pheno_mds_helper(pheno,project_passed_sample_list_file) > !{output,,pheno_mds_file} class_level pheno run_if and,!pheno_custom_mds_file,recompute_pca,(or,!parallelize_pca,!num_samp_subsets)

local cmd cp_pheno_mds_file=$smart_join_cmd --exec "tail -n+2 !{input,,project_sample_marker_mds_file} | cat - !{input,,pheno_sample_plink_basic_all_include_file} | awk '{print \\$1,\\$2}' | sort | uniq -d | sed '1 s/^/FID IID\n/'" !{input,--file,project_sample_marker_mds_file} --col 1 --col 2 --header 1 --extra 2 > !{output,,pheno_mds_file} class_level pheno run_if and,!pheno_custom_mds_file,!recompute_pca

local cmd convert_pheno_custom_mds_file=$smart_join_cmd --exec "$smart_cut_cmd !{input,--file,pheno_custom_mds_file} --select-col 1,'1 2' --exclude-row 1,1 | cat - !{input,,pheno_sample_plink_basic_all_include_file} | sed 's/\s\s*/\t/g' | sort | uniq -d | sed '1 s/^/FID\tIID\n/'  " !{input,--file,pheno_custom_mds_file} --header 1 --extra 2 --col 1 --col 2 > !{output,,pheno_mds_file} run_if pheno_custom_mds_file class_level pheno

local cmd make_pheno_annotated_mds_file=$smart_join_cmd --exec "$smart_cut_cmd !{input,--file,pheno_sample_plink_basic_all_include_file} --select-col 1,2 !{input,--file,pheno_mds_file} --select-col 2,2 | sort | uniq -d | sed '1 s/^/ID\n/'" --exec "$get_non_missing_with_header" --exec "$smart_cut_cmd !{input,--file,pheno_mds_file} --exclude-col 1,1,FID --exclude-col 1,1,SOL --out-delim $tab"  --in-delim $tab --header 1 --out-delim $tab --extra 2 --extra 3 > !{output,,pheno_annotated_mds_file} class_level pheno

prop mds_exclude_filters=list
default_mds_exclude_filters=C1,lt:0 C1,gt:0

prop max_strata_cluster_size=scalar
default_max_strata_cluster_size=100
prop no_strata_cc=scalar

prop cluster_ppc_value=scalar

default_cluster_ppc_value=.01

cmd make_pheno_sample_marker_cluster_files=$sample_list_to_plink_sample_list("!{input,--file,pheno_sample_basic_all_include_file}",0) | $plink_cmd $plink_in_bed_helper(pheno_sample_pruned_marker) !{input,--pheno,pheno_plink_phe_file} --keep /dev/stdin !{input,--read-genome,pheno_genome_file} --cluster !{prop,--ppc,pheno,cluster_ppc_value,missing_key=default_cluster_ppc_value} !{raw,,pheno,--cc,unless_prop=no_strata_cc,unless_prop=pheno_qt,allow_empty=1} !{input,--match,pheno_plink_match_file,if_prop=strata_traits,allow_empty=1} !{prop,--mc,pheno,max_strata_cluster_size,missing_key=default_max_strata_cluster_size} !{raw,--out,pheno,*pheno_sample_marker_plink_file} !{output,pheno_sample_marker_cluster0_file} !{output,pheno_sample_marker_cluster1_file} !{output,pheno_sample_marker_cluster2_file} !{output,pheno_sample_marker_cluster3_file}  && $plink_mv_log_cmd(!{raw\,\,pheno\,*pheno_sample_marker_plink_file},!{output\,\,pheno_sample_marker_cluster_log_file}) class_level pheno run_with pheno_variant_subset run_if run_cluster

get_samples_to_cluster=$sample_list_to_plink_sample_list(--exec "$smart_join_cmd --exec \\"cut -f1 !{input\,\,pheno_plinkseq_strata_phe_file} | tail -n+2 | cat - !{input::pheno_sample_basic_all_include_file} | sort | uniq -d | sed '1 s/^/IID\n/'\\" !{input:--file:pheno_plinkseq_strata_phe_file} --header 1 --comment \\\#\\\# --extra 2",1)
get_all_samples_to_cluster=$sample_list_to_plink_sample_list(!{input:--file:pheno_sample_basic_all_include_file},1)
local cmd make_pheno_dummy_strata_sample_marker_cluster_files=$get_samples_to_cluster | $smart_cut_cmd --select-col 0,1,'FID IID !{prop,,pheno,strata_traits}' --exclude-row 0,1 | perl -lane 'print "\$F[0]\t\$F[1]\t" . join("", @F[2..\$\#F])' | awk -v OFS="\t" 'BEGIN {i=1} !m[\$3] {m[\$3] = i++} {print \$1,\$2,m[\$3]}' > !{output,,pheno_sample_marker_cluster2_file} class_level pheno run_if and,!run_cluster,strata_traits
local cmd make_pheno_dummy_sample_marker_cluster_files=$get_all_samples_to_cluster | $smart_cut_cmd --select-col 0,1,'FID IID' --exclude-row 0,1 | awk -v OFS="\t" '{print \$1,\$2,1}' > !{output,,pheno_sample_marker_cluster2_file} class_level pheno run_if and,!run_cluster,!strata_traits

#vdist_parse_helper=egrep '^-|@1' !{input,,pheno_cluster_vdist_file} | tail -n+3 | sed 's/^-.\*=\s*\(\S\S*\).*/\1/' | sed 's/.\*chi-sq\s*\S*\s*=\s*\(\S\S*\)/\1\n/' | sed 's/.*\sp\s\s*=\s*\(\S\S*\).*/\1/' | tr '\n' '\t' | sed 's/\(\S\S*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)\s\s*/\1\t\2\t\3\n/g' | sed '1 s/^/ID\tCHI_SQ_@2\tP_@2\n/' | $add_function_cmd --in-delim $tab --header 1 --col1 P_@2 --type minus_log --val-header LOG_P_@2 | cut -f1,2,4


local cmd make_pheno_cluster_avg_stats_file=$smart_join_cmd --in-delim $tab --exec "$cluster_phe_file_helper | tail -n+2 | cut -f1 | cat - !{input,,pheno_all_popgen_istats_file} | cut -d, -f1 | sort | uniq -d | sed '1 s/^/ID\n/'" --exec "$cluster_phe_file_helper" --exec "$smart_cut_cmd !{input,--file,pheno_all_popgen_istats_file} --select-col 1,1 --select-col 1,1,'C1 C2' --in-delim , --out-delim $tab" --extra 2 --extra 3 --header 1  | $table_sum_stats_cmd --in-delim $tab --out-delim $tab --group-col $ibs_cluster_pheno --col C1 --col C2 --summaries --has-header --print-header | $smart_cut_cmd --in-delim $tab --select-col 0,1 --select-col 0,1,$table_sum_stats_stddev | sed '1 s/$table_sum_stats_stddev/DEV/g' > !{output,,pheno_cluster_avg_stats_file} class_level pheno 

local cmd make_pheno_cluster_stats_file=$smart_join_cmd --in-delim $tab !{input,--file,pheno_cluster_avg_stats_file} --exec "$smart_join_cmd --comment \\\# --extra 2 --out-delim $tab !{input,--file,pheno_plinkseq_cluster_phe_file} --exec \"$smart_cut_cmd !{input,--file,pheno_all_sample_info_file} --select-col 1,1 --select-col 1,1,!{prop,,pheno}\" | cut -f2- | awk 'NR == 1 || \\$1 != $ibs_cluster_missing' | $table_sum_stats_cmd --in-delim $tab --out-delim $tab --group-col 1 --col 2 --summaries --print-header | $smart_cut_cmd --in-delim $tab --exclude-row 0,1 --select-col 0,1  --select-col 0,1,$table_sum_stats_stddev | sed '1 s/^/ID\tPHENO_DEV\n/'" --exec "$cluster_phe_file_helper | tail -n+2 | cut -f2 | sort | uniq -c | sed 's/^\s*//' | sed 's/\s\s*/\t/g' | sed '1 s/^/SIZE\tID\n/'" --extra 2 --extra 3 --col 3,2 --header 1 > !{output,,pheno_cluster_stats_file} class_level pheno 

local cmd make_pheno_cluster_stats_pdf_file=$draw_box_plot_cmd(!{input\,\,pheno_cluster_stats_file} !{output\,\,pheno_cluster_stats_pdf_file} 'Sample cluster properties: !{prop\,\,pheno\,disp}' '' 'Cluster Values' -1) class_level pheno 


local cmd make_pheno_trait_hist_pdf_file=$smart_join_cmd --in-delim $tab --exec "sed '1 s/^/ID\n/' !{input,,pheno_sample_non_missing_all_include_file}" !{input,--file,pheno_sequenced_all_sample_info_file} --rest-extra 1 --header 1 --out-delim , | $draw_hist_plot_cmd("/dev/stdin !{output,,pheno_trait_hist_pdf_file} !{prop,,pheno} '!{prop,,pheno,disp} QC+ sample values' '!{prop,,pheno,disp}' sep=, do.gaussian=T") class_level pheno run_if pheno_qt

pheno_sstats_pdf_helper=$draw_box_plot_cmd(!{input::pheno_sstats_file} !{output::@1} '@2 sample QC properties: by !{prop::pheno:disp}' '' 'Sample Values' @3 sep=\, @4 max.plot.points=$max_sstats_points max.highlighted.points=$max_sstats_highlighted_points)
pheno_all_sstats_pdf_helper=$pheno_sstats_pdf_helper(@1,@2,-1\\,$display_col_name\\,$order_col_name\\,NVAR,@3)
pheno_slide_sstats_pdf_helper=$pheno_sstats_pdf_helper(@1,@2,"$all_major_sstats_cols",@3)

pheno_highlight_helper=$sample_highlight_columns_int id.col=1


!!expand:,:slideornone,slideorall:slide_,slide:,all! \
!|expand@;@shortt;type;tname;extra;which;runifvalue\
    @short;slideornoneall;All;;slideorall;\ 
    @short;slideornonehighlighted;All;highlight.list.file=!{input::project_sample_exclude_detail_file} $pheno_highlight_helper highlight.label.col=2;slideorall;\
    @local;slideornonefiltered;QC+;highlight.list.file=!{input::project_sample_exclude_detail_file} $pheno_highlight_helper highlight.label.col=2 exclude.highlighted=TRUE;slideorall;\
    @short;slideornoneextreme;QC+;highlight.list.file=!{input::project_sample_exclude_detail_file} $pheno_highlight_helper highlight.label.col=2 exclude.highlighted=TRUE extreme.highlight.col="$all_extreme_highlight_cols" extreme.quantile=$extreme_quantile ;slideorall;\
    @short;slideornonepopgen;QC/Popgen+;highlight.list.file=!{input::pheno_sample_popgen_all_include_file} $pheno_highlight_helper highlight.header=FALSE include.highlighted=TRUE;slideorall;skip_if not_trait\
| \
shortt cmd make_pheno_type_sstats_pdf_file=$pheno_which_sstats_pdf_helper(pheno_type_sstats_pdf_file,tname,label=$display_col_name order=$order_col_name extra) class_level pheno runifvalue with project

mds_color=color.brewer=Paired

mds_cex=.3


!|expand@;@type;colsarg@top;C1,C2| \
local cmd make_pheno_type_project_mds_pdf_file=$draw_matrix_plot_cmd !{input,,pheno_project_mds_file} !{output,,pheno_type_project_mds_pdf_file} 'Individual Project MDS Values' colsarg sep=$tab cex=$mds_cex class_level pheno with project

!|expand@;@type;colsarg@top;C1,C2@all;`$get_mds_cols(!{prop::pheno:num_mds_plot},\\,,)`| \
local cmd make_pheno_type_mds_pdf_file=$draw_matrix_plot_cmd !{input,,pheno_annotated_mds_file} !{output,,pheno_type_mds_pdf_file} 'Individual MDS Values: !{prop,,pheno,disp}' colsarg color.col=$display_col_name sep=$tab cex=$mds_cex $mds_color class_level pheno 


local cmd make_pheno_cluster_assign_mds_pdf_file=$smart_join_cmd --exec "$smart_cut_cmd --in-delim $tab !{input,--file,pheno_sample_popgen_all_include_file} !{input,--file,pheno_annotated_mds_file} --select-col 2,1 --exclude-row 2,1 | sort | uniq -d | sort - !{input,,pheno_sample_cluster_all_include_file} | uniq -d | sed '1 s/^/ID\n/'" !{input,--file,pheno_annotated_mds_file} --exec "$cluster_phe_file_helper_no_remove" --header 1 --extra 2 --extra 3 --in-delim $tab | $draw_matrix_plot_cmd /dev/stdin !{output,,pheno_cluster_assign_mds_pdf_file} 'Cluster assignments for QC/Popgen+ samples: !{prop,,pheno,disp}' C1,C2 color.col=$display_col_name connect.col=$ibs_cluster_pheno sep=$tab cex=$mds_cex $mds_color class_level pheno 

short cmd make_pheno_genome_pdf_file=zcat !{input,,pheno_annotated_genome_file} | $draw_box_plot_cmd(/dev/stdin !{output::pheno_genome_pdf_file} 'IBD sharing by !{prop::pheno:disp} ---: QC/Popgen+ samples' '' 'PI_HAT' PI_HAT sep=$tab title.newline=: label=$display_col_name order=$order_col_name max.plot.points=1000) class_level pheno skip_if not_trait rusage_mod $genome_pdf_mem

nperm_gassoc=!{raw::burden_test:-1:unless_prop=analytic:allow_empty=1}!{raw::burden_test:0:if_prop=analytic:allow_empty=1}
nperm_pathway=$nperm_gassoc

!!expand:,:assocl,burdenl:assoc,burden:assoc_variant_subset,burden_variant_subset! \
assocl_regex_mask=--mask !{raw,,burdenl,reg.ex\=@,if_prop=min_test_p_missing,if_prop=min_test_p_hwe,if_prop=max_assoc_null,if_prop=custom_burden_test_exclude_filters,or_if_prop=1,allow_empty=1}!{input,,burdenl_regex_file,if_prop=min_test_p_missing,if_prop=min_test_p_hwe,if_prop=max_assoc_null,if_prop=custom_burden_test_exclude_filters,or_if_prop=1,allow_empty=1}

vassoc=v-assoc
assoc_raw=assoc 
!!expand:,:assocl:assoc:assoc_variant_subset! \
assocl=$assoc_raw --tests !{prop::burden_test:test_name} !{prop::burden_test:test_options:if_prop=test_options:allow_empty=1} !{raw,,burden_test,--fix-null,if_prop=fix_null,unless_prop=analytic,allow_empty=1} $assocl_regex_mask

#!{raw,--mask,burden_test,null.prop\=0-@max_assoc_null,unless_prop=analytic,allow_empty=1}

!!expand:alltype:all:unrelated! \
!!expand:filetype:non_missing:basic:popgen:covar:cluster! \
pheno_filetype_alltype_include_mask=--mask indiv=@!{input,,pheno_sample_filetype_alltype_include_file}

!!expand:pheno:pheno:pheno_variant_subset! \
pseq_pheno_project_cmd=$pseq_cmd !{raw,,pheno,*pheno_plinkseq_project_file} !{input,pheno_plinkseq_project_done_file}

!|expand:;:pheno;projectt;includemask:pheno;project;:pheno_variant_subset;project_variant_subset;--mask reg.req=@!{input,,pheno_variant_subset_chr_pos_keep_file}| \
pseq_pheno_analysis_cmd=$pseq_pheno_project_cmd !{input,pheno_plinkseq_db_done_file} !{input,projectt_plinkseq_locdb_file}

!!expand:alltype:all:unrelated! \
!!expand:phenol:pheno:pheno_variant_subset! \
pseq_alltype_analysis_cmd_phenol=$pseq_phenol_analysis_cmd @1 $pheno_basic_alltype_include_mask

!!expand:alltype:all:unrelated! \
!!expand:phenol:pheno:pheno_variant_subset! \
pseq_filter_only_samples_alltype_analysis_cmd_phenol=$pseq_phenol_analysis_cmd @1 $pheno_popgen_alltype_include_mask

!!expand:phenol:pheno:pheno_variant_subset! \
pseq_phenol_clean_project_cmd=$pseq_cmd !{raw,,phenol,*phenol_plinkseq_clean_project_file} !{input,phenol_plinkseq_clean_project_done_file} 

!!expand:,:qc_plus,clean_:qc_plus,clean_:qc_pass,! \
!!expand:alltype:all:unrelated! \
!|expand:;:phenol;projectl;includemask:pheno;project;:pheno_variant_subset;project_variant_subset;--mask reg.req=@!{input,,pheno_variant_subset_chr_pos_keep_file}| \
pseq_qc_plus_alltype_analysis_cmd_phenol=$pseq_phenol_clean_project_cmd !{input,phenol_plinkseq_clean_db_done_file} !{input,projectl_plinkseq_locdb_file} @1 $pheno_popgen_alltype_include_mask includemask $gq_mask

!!expand:phenol:pheno:pheno_variant_subset! \
pseq_phenol_strat_project_cmd=$pseq_cmd !{raw,,phenol,*phenol_plinkseq_strat_project_file} !{input,phenol_plinkseq_strat_project_done_file}
!!expand:,:phenol,projectl:pheno,project:pheno_variant_subset,project_variant_subset! \
pseq_phenol_strat_depends=!{input,phenol_plinkseq_strat_db_done_file} !{input,projectl_plinkseq_locdb_file}

!!expand:alltype:all:unrelated! \
!|expand:;:phenol;projectl;includemask:pheno;project;:pheno_variant_subset;project_variant_subset;--mask reg.req=@!{input,,pheno_variant_subset_chr_pos_keep_file}| \
pseq_qc_plus_alltype_analysis_cmd_phenol_covar=$pseq_phenol_strat_project_cmd $pseq_phenol_strat_depends @1 $pheno_covar_alltype_include_mask includemask $gq_mask

!!expand:alltype:all:unrelated! \
!|expand:;:phenol;projectl;includemask:pheno;project;:pheno_variant_subset;project_variant_subset;--mask reg.req=@!{input,,pheno_variant_subset_chr_pos_keep_file}| \
pseq_qc_plus_alltype_analysis_cmd_phenol_cluster=$pseq_phenol_strat_project_cmd $pseq_phenol_strat_depends @1 $pheno_cluster_alltype_include_mask includemask $gq_mask

!!expand:qc_plus:qc_plus:qc_pass! \
!!expand:alltype:all:unrelated! \
!!expand:phenol:pheno:pheno_variant_subset! \
pseq_qc_plus_alltype_assoc_cmd_phenol=$pseq_qc_plus_alltype_analysis_cmd_phenol(@1) 

!!expand:alltype:all:unrelated! \
!!expand:phenol:pheno:pheno_variant_subset! \
pseq_qc_plus_alltype_assoc_cmd_phenol_cluster=$pseq_qc_plus_alltype_analysis_cmd_phenol_cluster(@1)

!!expand:alltype:all:unrelated! \
!!expand:phenol:pheno:pheno_variant_subset! \
pseq_qc_plus_alltype_assoc_cmd_phenol_covar=$pseq_qc_plus_alltype_analysis_cmd_phenol_covar(@1)

assoc_fix_bug_int=awk -F @1"\t@1" 'NF > 1'
assoc_fix_bug=$assoc_fix_bug_int()

pheno_vassoc_helper_int=$qt_plinkseq_phenotype_selector --perm @1 | $assoc_fix_bug_int(@2)
pheno_vassoc_helper=$pheno_vassoc_helper_int(@1,)
prop not_trait=scalar

!|expand:,:phenol,projectl:pheno,project:pheno_variant_subset,project_variant_subset| \
phenol_vassoc_counts_merge_helper=$pseq_qc_plus_unrelated_analysis_cmd_phenol(v-matrix) $show_id @1 | cut -f1 | sed 's/$/\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA/'

neff_helper=$add_function_cmd --in-delim $tab --header 1 --val1 1 --col2 OBSA  --type divide --val-header OBSA_INV | $add_function_cmd --in-delim $tab --header 1 --val1 1 --col2 OBSU --type divide --val-header OBSU_INV | $add_function_cmd --in-delim $tab --header 1 --col1 OBSA_INV --col2 OBSU_INV --type add --val-header OBS_INV | $add_function_cmd --in-delim $tab --header 1 --val1 4 --col2 OBS_INV --type divide --val-header NEFF --add-at OBSA | $format_columns_cmd --in-delim $tab --header 1 --number-format NEFF,%d | $smart_cut_cmd --tab-delim --exclude-col 0,1,'OBSA_INV OBSU_INV OBS_INV' --exact


!|expand:,:shortt,phenol,projectl,exrunif:,pheno,project,skip_if num_var_subsets:short,pheno_variant_subset,project_variant_subset,skip_if !num_var_subsets| \
shortt cmd make_phenol_vassoc_counts_file=rm -f !{output,,phenol_vassoc_counts_file} && $smart_join_cmd --in-delim $tab --exec "$smart_join_cmd --in-delim $tab --header 1 --extra 2 --col 1,1 --col 1,3 --col 1,4 --col 2,1 --col 2,2 --col 2,3 --ignore-err $plinkseq_okay_err --exec \"$pseq_qc_plus_all_analysis_cmd_phenol($vassoc) $show_id $pheno_vassoc_helper_int(0,\\\) | $smart_cut_cmd --tab-delim --select-col 0,1,'VAR REF ALT SAMPLES FILTER MAF HWE REFA HETA HOMA REFU HETU HOMU P OR' --exact --require-col-match | sed '1 s/^/ID\t/' | sed '1! s/^\([^:][^:]*\):\([^:\.][^:\.]*\)/\1:\2\t\1:\2/'\" --exec \"$smart_cut_cmd --in-delim $tab !{input,--file,phenol_counts_file} --require-col-match --select-col 1,1,'VAR REF/ALT CNTA CNTU TOTA TOTU' | sed 's;/;\t;' | sed '1 s/TOT/OBS/g' | sed '1 s/CNT/MIN/g'\" | $smart_cut_cmd --tab-delim --exact --require-col-match --select-col 0,1,'VAR REF ALT SAMPLES FILTER MAF HWE MINA MINU OBSA OBSU REFA HETA HOMA REFU HETU HOMU P OR' | awk -F\"\t\" -v OFS=\"\t\" 'NR > 1 {\\$10=\\$10/2; \\$11=\\$11/2;} {print}'" --exec "$phenol_vassoc_counts_merge_helper(--mask file=$pseq_snp_tag)" --exec "$phenol_vassoc_counts_merge_helper(--mask file=$pseq_indel_tag)" --exec "$phenol_vassoc_counts_merge_helper(--mask file=$pseq_multiallelic_tag)" --merge --header 1  --ignore-err $plinkseq_okay_err | $neff_helper > !{output,,phenol_vassoc_counts_file} !{input,pheno_is_trait_file} class_level phenol exrunif run_if !not_trait

#strat_cluster
#strata_traits
#strat_covar
#num_mds_covar
#covar_traits
#run_raw
#test_tag
#test_software
#test_name

#min_clean_p_missing
#min_clean_geno
#min_clean_hwe

#fix_null

#make_two_sided
#analytic
#max_assoc_null
#min_test_p_missing
#min_test_hwe

!%expand:;:type;samples:;`cat @5 | wc -l`:_meta;NA% \
record_phenotype_test_info=(echo Test$tab!{raw,,pheno_test,\@test_tag,uc=1} && \
	 echo Software$tab!{raw,,pheno_test,\@test_software} && \
	 echo Test name${tab}@1 !{prop;;pheno_test;test_options;if_prop=test_options;allow_empty=1} && \
	 echo Samples${tab}samples && \
	 echo Covariates${tab}@2 && \
	 echo Clustering${tab}@3 && \
	 echo GT cutoff${tab}@4 && \
	 echo HWE cutoff$tab!{raw,,pheno_test,\@min_clean_hwe} && \
	 echo CR cutoff$tab!{raw,,pheno_test,\@min_clean_geno} && \
	 echo P missing cutoff$tab!{raw,,pheno_test,\@min_clean_p_missing,unless_prop=pheno_qt,allow_empty=1}!{raw,,pheno_test,NA,if_prop=pheno_qt,allow_empty=1} && \
	 echo PI_HAT cutoff$tab!{raw,,pheno_test,\@max_related,unless_prop=include_related,allow_empty=1}!{raw,,pheno_test,1,if_prop=include_related,allow_empty=1} \
	 )> !{output,,pheno_test_info_file}

local cmd make_pheno_pheno_test_info_tex_file=$smart_cut_cmd --in-delim $tab !{input,--file,pheno_test_info_file} --select-col 1,1 --select-col .,2 --paste | $table_to_beamer_cmd --header-rows 1 --header-cols 1 --in-delim $tab --title "Single variant tests" --auto-dim --font-size 8pt > !{output,,pheno_pheno_test_info_tex_file} class_level pheno run_if pheno_test
local cmd make_pheno_pheno_test_info_pdf_file=$run_latex_cmd(pheno_pheno_test_info_tex_file,pheno_pheno_test_info_pdf_file) class_level pheno

#score test commands

#this excludes individuals

!!expand:pheno_test:pheno_test:burden_test! \
local cmd make_pheno_test_pseq_sample_include_aux_file=sort -u !{input,,pheno_test_sample_include_file} | sed 's/\(\S*\S*\)/\1\n\1/' | cat - !{input,,pheno_sample_popgen_unrelated_include_file,unless_prop=include_related,allow_empty=1} !{input,,pheno_sample_popgen_all_include_file,if_prop=include_related,allow_empty=1} | sort | uniq -u  > !{output,,pheno_test_sample_include_aux_file} class_level pheno_test run_if and,pheno_test_sample_include_file,(or,test_software:eq:R,test_software:eq:pseq)

!!expand:pheno_test:pheno_test:burden_test! \
local cmd make_pheno_test_alternate_pheno_file=ln -s !{input,,pheno_non_missing_sample_pheno_file,if_prop=pheno:eq:@alternate_pheno,if_prop=project:eq:@project,all_instances=1,instance_level=pheno} !{output,,pheno_test_alternate_pheno_file} class_level pheno_test run_if alternate_pheno

!!expand:pheno_test:pheno_test:burden_test! \
local cmd make_pheno_test_extra_covars_file=$smart_join_cmd --exec "cat !{input,,pheno_non_missing_sample_pheno_file,if_prop=pheno:eq:@extra_covar_traits,if_prop=project:eq:@project,all_instances=1,allow_empty=1,instance_level=pheno} | cut -f1 | sort | uniq -c | sort -nrk1 | awk 'NR == 1 {n=\\$1} \\$1 == n {print \\$2}' | sed '1 s/^/\\#ID\n/'" !{input,--file,pheno_plinkseq_phe_file_body,if_prop=pheno:eq:@extra_covar_traits,if_prop=project:eq:@project,all_instances=1,allow_empty=1,instance_level=pheno} !{input,--file,pheno_plinkseq_indicator_phe_file_body,if_prop=pheno:eq:@extra_covar_traits,unless_prop=pheno_qt,if_prop=project:eq:@project,all_instances=1,allow_empty=1,instance_level=pheno} --header 1 --rest-extra 1 --in-delim $tab --out-delim $tab > !{output,,pheno_test_extra_covars_file} class_level pheno_test run_if extra_covar_traits

!!expand:pheno_test:pheno_test:burden_test! \
local cmd make_pheno_test_variable_covars_file=$get_variable_covars(pheno_test_extra_covars_file,2) > !{output,,pheno_test_variable_covars_file} class_level pheno_test run_if extra_covar_traits

!!expand:pheno_test:pheno_test:burden_test! \
local cmd ln_pheno_test_variable_covars_file=ln -s !{input,,pheno_variable_covars_file} !{output,,pheno_test_variable_covars_file} class_level pheno_test skip_if extra_covar_traits

!!expand:pheno_test:pheno_test:burden_test! \
pheno_test_covars_aux_helper=$smart_join_cmd --header 1 --exec "tail -qn+2 !{input,,@1} | awk '{print \\$2}' | cat !{input,,pheno_test_extra_covars_file} - | tail -n+2 | awk '{print \\$1}' | sort | uniq -d | sed '1 s/^/ID\n/'" !{input,--file,@1} !{input,--file,pheno_test_extra_covars_file} --col 2,2 --rest-extra 1 | awk '{t=\$1;\$1=\$2;\$2=t} NR == 1 {\$2="IID"} {print}' > !{output,,pheno_test_covars_aux_file}

!!expand:pheno_test:pheno_test:burden_test! \
pheno_test_alternate_pheno_covars_aux_helper=$smart_join_cmd --header 1 --exec "tail -qn+2 !{input,,@1} !{input,,@2} | awk '{print \\$2}' | sort -u | cat !{input,,pheno_test_extra_covars_file,if_prop=extra_covar_traits,allow_empty=1} - | awk '{print \\$1}' | sort | !{raw,,pheno_test,uniq -d |,if_prop=extra_covar_traits,allow_empty=1} $smart_cut_cmd --exec 'cut -f1 !{input,,pheno_test_alternate_pheno_file} | cut -f1 | sort -u' | sort | uniq -d | sed '1 s/^/ID\n/'" --exec "cat !{input,,@1} | sed 's/\s\s*/\t/g' @5 | cut -f1-@3" --exec "sed '1 s/^/ID\t!{prop,,pheno_test,alternate_pheno}\n/' !{input,,pheno_test_alternate_pheno_file}" --exec "sed 's/\s\s*/\t/g' !{input,,@2} | cut -f2,@4-" !{input,--file,pheno_test_extra_covars_file,if_prop=extra_covar_traits,allow_empty=1} --col 2,2 --rest-extra 1 | awk '{t=\$1;\$1=\$2;\$2=t} NR == 1 {\$2="IID"} {print}' > !{output,,pheno_test_covars_aux_file}

!!expand:pheno_test:pheno_test:burden_test! \
local cmd make_pheno_test_R_covars_aux_file=$pheno_test_covars_aux_helper(pheno_plink_covar_file) class_level pheno_test skip_if or,!extra_covar_traits,alternate_pheno run_if or,test_software:eq:R,test_software:eq:plink

!!expand:pheno_test:pheno_test:burden_test! \
local cmd make_pheno_test_R_alternate_phe_covars_aux_file=$pheno_test_alternate_pheno_covars_aux_helper(pheno_plink_phe_file,pheno_plink_covar_file,2,3,| sed '1 s/^/FID\tIID\n/') class_level pheno_test skip_if !alternate_pheno run_if or,test_software:eq:R,test_software:eq:plink

pheno_score_test_helper=$score_test_cmd /dev/stdin -out:!{output,,@1} -pheno:!{input,,pheno_plink_alternate_phe_file,unless_prop=alternate_pheno,allow_empty=1}!{input,,pheno_test_covars_aux_file,if_prop=alternate_pheno,allow_empty=1} -plink:FALSE -model:model1 !{input,pheno_is_trait_file} 

!!expand:pheno_test:pheno_test:burden_test! \
pheno_test_indiv_ex_helper=!{raw,,pheno_test,--mask indiv.ex\=@,if_prop=pheno_test_sample_include_file,allow_empty=1}!{input,,pheno_test_sample_include_aux_file,if_prop=pheno_test_sample_include_file,if_prop=alternate_pheno,or_if_prop=1,allow_empty=1}

!|expand:;:alltype;allrunif:all;include_related:unrelated;!include_related| \
!|expand:,:shortt,pheno_testl,phenol,exrunif:,pheno_test,pheno,num_var_subsets:short,pheno_test_variant_subset,pheno_variant_subset,!num_var_subsets| \
restart_mem shortt cmd make_pheno_testl_r_score_raw_alltype_vassoc_file=$pseq_qc_plus_alltype_analysis_cmd_phenol(v-matrix) $pheno_test_indiv_ex_helper $show_id | $pheno_score_test_helper(pheno_testl_vassoc_file) -phesel:!{prop,,pheno,unless_prop=alternate_pheno,allow_empty=1}!{prop,,pheno_test,alternate_pheno,if_prop=alternate_pheno,allow_empty=1} -convert.pheno:TRUE !{prop;;pheno_test;test_options;if_prop=test_options;allow_empty=1} class_level pheno_testl run_if and,run_raw,test_software:eq:R,test_name:eq:score,allrunif skip_if or,pheno_qt,exrunif rusage_mod $score_test_mem

!|expand:;:alltype;allrunif:all;include_related:unrelated;!include_related| \
local cmd make_pheno_test_r_score_raw_alltype_info_file=$record_pheno_test_info(!{prop;;pheno_test;test_name;sep=\,},no,no,$gq_crit_helper,!{input;;pheno_sample_popgen_alltype_include_file} !{input;;pheno_test_sample_include_aux_file;if_prop=pheno_test_sample_include_file;if_prop=alternate_pheno;or_if_prop=1;allow_empty=1} !{input;;pheno_test_sample_include_aux_file;if_prop=pheno_test_sample_include_file;if_prop=alternate_pheno;or_if_prop=1;allow_empty=1} | sort | uniq -u) class_level pheno_test run_if and,run_raw,test_software:eq:R,test_name:eq:score,allrunif skip_if pheno_qt 

get_plink_covars=$get_covar_traits(\,,@1)!{raw::@1:,:if_prop=covar_traits:if_prop=strat_covar:allow_empty=1}!{raw::@1:,:if_prop=manual_covar_traits:unless_prop=covar_traits:if_prop=strat_covar:allow_empty=1}`!{raw::@1:$get_mds_cols(\@num_mds_covar,\\,):if_prop=strat_covar:allow_empty=1}`
get_disp_covars=$get_covar_traits(\,,@1)!{raw::@1:,:if_prop=covar_traits:if_prop=manual_covar_traits:or_if_prop=1:allow_empty=1}!{raw::@1:\@num_mds_covar:if_prop=strat_covar:allow_empty=1}!{raw::@1:no:unless_prop=strat_covar:allow_empty=1} PCs
get_disp_covars_pheno_test=$get_disp_covars(pheno_test)
get_disp_covars_burden_test=$get_disp_covars(burden_test)

!|expand:;:alltype;allrunif:all;include_related:unrelated;!include_related| \
!|expand:,:shortt,pheno_testl,phenol,exrunif:,pheno_test,pheno,!num_var_subsets:short,pheno_test_variant_subset,pheno_variant_subset,num_var_subsets| \
restart_mem shortt cmd make_pheno_testl_r_score_strata_alltype_vassoc_file=c=$get_plink_covars(pheno_test) && $pseq_qc_plus_alltype_analysis_cmd_phenol_covar(v-matrix) $pheno_test_indiv_ex_helper $show_id | $pheno_score_test_helper(pheno_testl_vassoc_file) -phesel:!{prop,,pheno,unless_prop=alternate_pheno,allow_empty=1}!{prop,,pheno_test,alternate_pheno,if_prop=alternate_pheno,allow_empty=1} -convert.pheno:TRUE -cov:!{input,,pheno_plink_covar_file,unless_prop=extra_covar_traits,allow_empty=1}!{input,,pheno_test_covars_aux_file,if_prop=extra_covar_traits,allow_empty=1} -covsel:\$c !{prop;;pheno_test;test_options;if_prop=test_options;allow_empty=1} class_level pheno_testl run_if and,!run_raw,(or,strat_covar,covar_traits),test_software:eq:R,test_name:eq:score,exrunif,allrunif skip_if pheno_qt rusage_mod $score_test_mem

!|expand:;:alltype;allrunif:all;include_related:unrelated;!include_related| \
local cmd make_pheno_test_r_score_strata_alltype_info_file=$record_pheno_test_info(!{prop;;pheno_test;test_name;sep=\,},$get_disp_covars_pheno_test,no,$gq_crit_helper,!{input;pheno_test_covars_aux_file;if_prop=extra_covar_traits;allow_empty=1} !{raw;;pheno_test;*pheno_test_covars_aux_file | awk '{print \$2}' | cat -;if_prop=extra_covar_traits;allow_empty=1} !{input;;pheno_sample_covar_alltype_include_file} !{raw;;pheno_test;| sort | uniq -d | cat -;if_prop=extra_covar_traits;allow_empty=1} !{input;;pheno_test_sample_include_aux_file;if_prop=pheno_test_sample_include_file;if_prop=alternate_pheno;or_if_prop=1;allow_empty=1} !{input;;pheno_test_sample_include_aux_file;if_prop=pheno_test_sample_include_file;if_prop=alternate_pheno;or_if_prop=1;allow_empty=1} | sort | uniq -u) class_level pheno_test run_if and,!run_raw,(or,strat_covar,covar_traits),test_software:eq:R,test_name:eq:score,allrunif skip_if pheno_qt

!|expand:;:alltype;allrunif:all;include_related:unrelated;!include_related| \
!|expand:,:shortt,pheno_testl,whichvcf,phenol,projectl,exskipif:,pheno_test,project_clean_all_vcf_file,pheno,project,skip_if num_var_subsets:short,pheno_test_variant_subset,pheno_variant_subset_clean_all_vcf_file,pheno_variant_subset,project_variant_subset,skip_if !num_var_subsets| \
shortt cmd make_pheno_testl_r_score_alltype_small_vassoc_file=$smart_join_cmd --in-delim $tab --header 1 --exec "$pseq_qc_plus_alltype_analysis_cmd_phenol_covar(v-freq) $show_id | $smart_cut_cmd --in-delim $tab --select-col 0,1,'VAR MAF REF ALT' --exact --require-col-match" --ignore-err $plinkseq_okay_err !{input,--file,pheno_testl_vassoc_file} --exec "$smart_cut_cmd --in-delim $tab !{input,--file,phenol_vassoc_counts_file} --select-col 1,1,'VAR NEFF'" --rest-extra 1 | sed '1 s/^/CHR:POS:/' | $parse_out_id | $smart_cut_cmd --tab-delim --exact --require-col-match --select-col 0,1 --select-col 0,1,'$n_col_disp NEFF MAF REF ALT beta SEbeta PrChi' | $add_function_cmd --in-delim $tab --header 1 --col1 beta --type exp --val-header $or_col_disp --add-at beta | sed '1 s/\tPrChi/\t$p_col_disp/' | sed '1 s/\tNEFF/\t$neff_col_disp/' | sed '1 s/\tMAF/\t$maf_col_disp/' | sed '1 s/\tREF/\t$ref_col_disp/' | sed '1 s/\tALT/\t$alt_col_disp/' | sed '1 s/\tSEbeta/\t$se_col_disp/' | sed '1 s/\tbeta/\t$beta_col_disp/' | sed '1 s/^\S\S*/$id_col_disp/' | $replace_nan(NA) > !{output,,pheno_testl_small_vassoc_file} class_level pheno_testl run_if and,test_software:eq:R,test_name:eq:score,allrunif exskipif

#epacts commands

!!expand:pheno_testl:pheno_test:pheno_test_variant_subset:burden_test:burden_test_variant_subset! \
local cmd make_pheno_testl_epacts_ready_file=touch !{output,,pheno_testl_epacts_ready_file} class_level pheno_testl

!|expand:pheno_test:pheno_test:burden_test| \
!|expand:;:covartype:covar:popgen| \
!|expand:;:alltype:all:unrelated| \
pheno_test_epacts_or_plink_covartype_alltype_keep_helper=$smart_join_cmd --in-delim $tab --exec "sort -u !{input,,pheno_test_sample_include_file,if_prop=pheno_test_sample_include_file,allow_empty=1} !{raw,,pheno_test,/dev/null,unless_prop=pheno_test_sample_include_file,allow_empty=1} | sed 's/^\(\S\S*\)/\1\t\1/' | cat - !{input,,pheno_sample_covartype_alltype_include_file} | cut -f2 | sort !{raw,,pheno_test,| uniq -d,if_prop=pheno_test_sample_include_file,allow_empty=1} !{raw,,pheno_test,| cat - *pheno_test_alternate_pheno_file | cut -f1 | sort | uniq -d,if_prop=alternate_pheno,allow_empty=1} !{input,pheno_test_alternate_pheno_file,if_prop=alternate_pheno,allow_empty=1} @4" !{input,--file,pheno_@{1}_covartype_alltype_@{2}_file} --rest-extra 1 @3 --col 2,2 | awk -F"\t" -v OFS="\t" '{t=\$1;\$1=\$2;\$2=t} {print}' > !{output,,pheno_test_sample_include_aux_file}

!|expand:pheno_test:pheno_test:burden_test| \
!|expand:;:covartype;skipif:covar;or,run_raw,(and,!strat_covar,!covar_traits):popgen;!run_raw| \
!|expand:;:alltype;runif:all;include_related:unrelated;!include_related| \
local cmd make_pheno_test_epacts_covartype_alltype_sample_include_aux_file=$pheno_test_epacts_or_plink_covartype_alltype_keep_helper(epacts,ped,--header 1,| sed '1 s/^/IID\n/') class_level pheno_test skip_if skipif run_if and,(or,pheno_test_sample_include_file,alternate_pheno),test_software:eq:epacts,runif

!|expand:;:alltype;allrunif:all;include_related:unrelated;!include_related| \
!!expand:pheno_test:pheno_test:burden_test! \
local cmd make_pheno_test_epacts_covars_alltype_aux_file=$pheno_test_covars_aux_helper(pheno_epacts_covar_alltype_ped_file) class_level pheno_test run_if and,!pheno_test_sample_include_file,!alternate_pheno,extra_covar_traits,test_software:eq:epacts,allrunif

!|expand:;:alltype;allrunif:all;include_related:unrelated;!include_related| \
!!expand:pheno_test:pheno_test:burden_test! \
local cmd make_pheno_test_epacts_alternate_pheno_covars_alltype_aux_file=$pheno_test_alternate_pheno_covars_aux_helper(pheno_epacts_popgen_alltype_ped_file,pheno_epacts_covar_alltype_ped_file,6,8,) class_level pheno_test run_if and,!pheno_test_sample_include_file,alternate_pheno,test_software:eq:epacts,allrunif

!!expand:pheno_test:pheno_test:burden_test! \
local cmd make_pheno_test_epacts_covars_with_include_aux_file=$pheno_test_covars_aux_helper(pheno_test_sample_include_aux_file) class_level pheno_test run_if and,pheno_test_sample_include_file,!alternate_pheno,extra_covar_traits,test_software:eq:epacts

!|expand:;:alltype;allrunif:all;include_related:unrelated;!include_related| \
!!expand:pheno_test:pheno_test:burden_test! \
local cmd make_pheno_test_epacts_alternate_pheno_covars_with_include_alltype_aux_file=$pheno_test_alternate_pheno_covars_aux_helper(pheno_epacts_alltype_ped_file,pheno_test_sample_include_aux_file,6,8,) class_level pheno_test run_if and,pheno_test_sample_include_file,alternate_pheno,test_software:eq:epacts,allrunif


epacts_single_unit=10000000

epacts_get_chr_flag=`cut -f1 !{input,,project_variant_subset_var_keep_file} | sort -u | tr '\n' ' ' | awk 'NF == 1 {print "--chr",\$1}'`

prop epacts_unit=scalar

!!expand:,:pheno_testl,whichvcf,getflag:pheno_test,project_clean_all_vcf_file,'':pheno_test_variant_subset,pheno_variant_subset_clean_all_vcf_file,$epacts_get_chr_flag! \
pheno_testl_epacts_single_helper1=!{input,pheno_testl_epacts_ready_file} chr_flag=getflag && $epacts_cmd single -restart --missing $plink_missing !{input,--vcf,@6} !{input,--ped,pheno_epacts_@{3}_ped_file,unless_prop=pheno_test_sample_include_file,unless_prop=extra_covar_traits,unless_prop=alternate_pheno,allow_empty=1} !{input,--ped,pheno_test_sample_include_aux_file,if_prop=pheno_test_sample_include_file,unless_prop=extra_covar_traits,unless_prop=alternate_pheno,allow_empty=1} !{input,--ped,pheno_test_covars_aux_file,if_prop=extra_covar_traits,if_prop=alternate_pheno,or_if_prop=1,allow_empty=1} !{input,--kinf,pheno_kinship_file,if_prop=test_name:eq:q.emmax,allow_empty=1} !{prop,-unit,pheno_test,epacts_unit,missing_key=epacts_single_unit} \$chr_flag --min-maf 0 --min-callrate 0 --min-mac 1 --pheno @5 --test @{2} !{prop;;pheno_test;test_options;if_prop=test_options;allow_empty=1} -run 1 !{prop,-field,pheno_test,epacts_gt_field} @4 !{raw,--out,pheno_testl,*@{1}} 


!!expand:,:pheno_testl,whichvcf:pheno_test,project_clean_all_vcf_file:pheno_test_variant_subset,pheno_variant_subset_clean_all_vcf_file! \
pheno_testl_epacts_single_helper=rm -f !{raw,,pheno_testl,*@{1}.epacts.gz} && !{raw,,pheno_testl,rm -f *@{1}.reml && ln -s *pheno_test_in_aux1_file *@{1}.reml && rm -f *@{1}.eigR && ln -s *pheno_test_in_aux2_file *@{1}.eigR &&,if_prop=test_name:eq:q.emmax,allow_empty=1} !{input;pheno_test_in_aux1_file;if_prop=test_name:eq:q.emmax;allow_empty=1} !{input;pheno_test_in_aux2_file;if_prop=test_name:eq:q.emmax;allow_empty=1} $pheno_testl_epacts_single_helper1(@1,@2,@3,@4,@5,whichvcf) !{raw,--remlf,pheno_test,*@{1}.reml,if_prop=test_name:eq:q.emmax,allow_empty=1} >&/dev/null && zcat !{raw,,pheno_testl,*@{1}.epacts.gz} 

pheno_test_epacts_eigen_helper=rm -f !{raw,,pheno_test,*pheno_test_vassoc_epacts_trunk.eigR} && rm -f !{raw,,pheno_test,*pheno_test_vassoc_epacts_trunk.reml} && $pheno_test_epacts_single_helper1(pheno_test_vassoc_epacts_trunk,!{prop::pheno_test:test_name},@1,@2 --chr -1,!{prop::pheno_test:pheno:unless_prop=alternate_pheno:allow_empty=1}!{prop::pheno_test:alternate_pheno:if_prop=alternate_pheno:allow_empty=1},pheno_sample_marker_pruned_vcf_file) && mv !{raw,,pheno_test,*pheno_test_vassoc_epacts_trunk.reml} !{output,,pheno_test_in_aux1_file} && mv !{raw,,pheno_test,*pheno_test_vassoc_epacts_trunk.eigR} !{output,,pheno_test_in_aux2_file}

get_epacts_covars="--cov $get_covar_traits( --cov ,@1)!{raw,,@1, --cov ,if_prop=covar_traits,if_prop=strat_covar,allow_empty=1}!{raw,,@1, --cov ,if_prop=manual_covar_traits,unless_prop=covar_traits,if_prop=strat_covar,allow_empty=1}`!{raw::@1:$get_mds_cols_int(\@num_mds_covar, --cov ,\):if_prop=strat_covar:allow_empty=1`}`"

get_spaced_covars="$get_covar_traits( ,@1)!{raw::@1: :if_prop=covar_traits:if_prop=strat_covar:allow_empty=1}!{raw::@1: :if_prop=manual_covar_traits:unless_prop=covar_traits:if_prop=strat_covar:allow_empty=1}`!{raw::@1:$get_mds_cols_int(\@num_mds_covar, ,\):if_prop=strat_covar:allow_empty=1`}`"

!|expand:;:alltype;runif:all;include_related:unrelated;!include_related| \
cmd make_pheno_test_alltype_epacts_raw_in_aux_files=$pheno_test_epacts_eigen_helper(popgen_alltype,) class_level pheno_test run_if and,run_raw,test_software:eq:epacts,runif skip_if test_name:ne:q.emmax rusage_mod $epacts_eigen_mem run_with pheno_test_variant_subset

!|expand:;:alltype;runif:all;include_related:unrelated;!include_related| \
!|expand:,:shortt,pheno_testl,exskipif:,pheno_test,num_var_subsets:short,pheno_test_variant_subset,!num_var_subsets| \
shortt cmd make_pheno_testl_alltype_epacts_raw_vassoc_file=$pheno_testl_epacts_single_helper(pheno_testl_vassoc_epacts_trunk,!{prop::pheno_test:test_name},popgen_alltype,,!{prop::pheno_test:pheno:unless_prop=alternate_pheno:allow_empty=1}!{prop::pheno_test:alternate_pheno:if_prop=alternate_pheno:allow_empty=1}) > !{output,,pheno_testl_vassoc_file} class_level pheno_testl run_if and,run_raw,test_software:eq:epacts,runif skip_if exskipif rusage_mod $epacts_vassoc_mem

!|expand:;:alltype;runif:all;include_related:unrelated;!include_related| \
local cmd make_pheno_test_alltype_epacts_raw_info_file=$record_pheno_test_info(!{prop;;pheno_test;test_name;sep=\,},no,no,!{raw::pheno_test:@epacts_gt_field},!{input;;pheno_sample_popgen_alltype_include_file;unless_prop=pheno_test_sample_include_file;unless_prop=alternate_pheno;allow_empty=1} !{raw;;pheno_test;*pheno_test_sample_include_aux_file | tail -n+2;if_prop=pheno_test_sample_include_file;if_prop=alternate_pheno;or_if_prop=1;allow_empty=1} !{input;pheno_test_sample_include_aux_file;if_prop=pheno_test_sample_include_file;if_prop=alternate_pheno;or_if_prop=1;allow_empty=1}) class_level pheno_test run_if and,run_raw,test_software:eq:epacts,runif

!|expand:;:alltype;runif:all;include_related:unrelated;!include_related| \
cmd make_pheno_test_alltype_epacts_strata_in_aux_files=c=$get_epacts_covars(pheno_test) && $pheno_test_epacts_eigen_helper(covar_alltype,\$c) class_level pheno_test run_if and,!run_raw,(or,strat_covar,covar_traits),test_software:eq:epacts,runif skip_if test_name:ne:q.emmax rusage_mod $epacts_eigen_mem run_with pheno_test_variant_subset

!|expand:;:alltype;runif:all;include_related:unrelated;!include_related| \
!|expand:,:shortt,pheno_testl,exskipif:,pheno_test,num_var_subsets:short,pheno_test_variant_subset,!num_var_subsets| \
shortt cmd make_pheno_testl_alltype_epacts_strata_vassoc_file=c=$get_epacts_covars(pheno_test) && $pheno_testl_epacts_single_helper(pheno_testl_vassoc_epacts_trunk,!{prop::pheno_test:test_name},covar_alltype,\$c,!{prop::pheno_test:pheno:unless_prop=alternate_pheno:allow_empty=1}!{prop::pheno_test:alternate_pheno:if_prop=alternate_pheno:allow_empty=1}) > !{output,,pheno_testl_vassoc_file} class_level pheno_testl run_if and,!run_raw,(or,strat_covar,covar_traits),test_software:eq:epacts,runif skip_if exskipif rusage_mod $epacts_vassoc_mem

!|expand:;:alltype;runif:all;include_related:unrelated;!include_related| \
local cmd make_pheno_test_alltype_epacts_strata_info_file=$record_pheno_test_info(!{prop;;pheno_test;test_name;sep=\,},$get_disp_covars_pheno_test,no,!{raw::pheno_test:@epacts_gt_field},!{input;;pheno_sample_covar_alltype_include_file;unless_prop=pheno_test_sample_include_file;unless_prop=extra_covar_traits;unless_prop=alternate_pheno;allow_empty=1} !{raw;;pheno_test;*pheno_test_sample_include_aux_file | tail -n+2;if_prop=pheno_test_sample_include_file;unless_prop=extra_covar_traits;unless_prop=alternate_pheno;allow_empty=1} !{input;pheno_test_sample_include_aux_file;if_prop=pheno_test_sample_include_file;unless_prop=extra_covar_traits;unless_prop=alternate_pheno;allow_empty=1} !{raw;;pheno_test;*pheno_test_covars_aux_file | tail -n+2;if_prop=extra_covar_traits;if_prop=alternate_pheno;or_if_prop=1;allow_empty=1} !{input;pheno_test_covars_aux_file;if_prop=extra_covar_traits;if_prop=alternate_pheno;or_if_prop=1;allow_empty=1}) class_level pheno_test run_if and,!run_raw,(or,strat_covar,covar_traits),test_software:eq:epacts,runif rusage_mod $epacts_vassoc_mem

#add new columns based on the test

#!|expand:,:shortt,pheno_testl,whichvcf,phenol,projectl,exskipif:,pheno_test,project_clean_all_vcf_file,pheno,project,skip_if num_var_subsets:short,pheno_test_variant_subset,pheno_variant_subset_clean_all_vcf_file,pheno_variant_subset,project_variant_subset,skip_if !num_var_subsets| \
#shortt cmd make_pheno_testl_epacts_small_vassoc_file=$smart_join_cmd --in-delim $tab --header 1 --exec "$smart_join_cmd --in-delim $tab !{input,--file,projectl_vfreq_file} --exec \"$smart_cut_cmd --in-delim $tab !{input,--file,phenol_vassoc_counts_file} --select-col 1,1,'VAR NEFF'\" --header 1 --extra 1 | $smart_cut_cmd --in-delim $tab --select-col 0,1,'VAR CHR POS REF ALT NEFF' --exact --require-col-match | $parse_out_id | tail -n+2 | perl -ne 'BEGIN {open IN, qw(!{input,,project_chr_map_file}) or die; while (<IN>) {@a = split; \\$m{\\$a[0]}=\\$a[1]}} @a = split(\"\\t\"); if (\\$m{\\$a[1]}) {\\$a[1]=\\$m{\\$a[1]}} print join(\"\\t\", @a)' | awk -F\"\t\" -v OFS=\"\t\" '{print \\$2\":\"\\$3\"_\"\\$4\"/\"\\$5,\\$1,\\$4,\\$5,\\$6}' | sed '1 s/^/EPACTS_ID\tID\tREF\tALT\tNEFF\n/'" !{input,--file,pheno_testl_vassoc_file} --rest-extra 2 --header 1 --col 2,4 \
#			 | $add_function_cmd --in-delim $tab --header 1 --col1 $beta_col_disp --type exp --val-header $or_col_disp \
#			 | $smart_cut_cmd --tab-delim --exact --require-col-match --select-col 0,2 --select-col 0,1,'NS NEFF MAF REF ALT $or_col_disp BETA SEBETA PVALUE' | sed '1 s/\tPVALUE/\t$p_col_disp/' | sed '1 s/\tNS/\t$n_col_disp/' | sed '1 s/\tNEFF/\t$neff_col_disp/' | sed '1 s/\tMAF/\t$maf_col_disp/' | sed '1 s/\tREF/\t$ref_col_disp/' | sed '1 s/\tALT/\t$alt_col_disp/' | sed '1 s/\tSEBETA/\t$se_col_disp/' | sed '1 s/\tBETA/\t$beta_col_disp/' | sed '1 s/^\S\S*/$id_col_disp/' | $replace_nan(NA) > !{output,,pheno_testl_small_vassoc_file} class_level pheno_testl run_if test_software:eq:epacts exskipif

#old: --exec "$smart_cut_cmd --in-delim $tab !{input:--file:pheno_testl_vassoc_file} --select-col 1,4 --select-col 1,1,. | sed '1 s/^/:_:_/' | cut -d_ -f3- "

!|expand:,:shortt,pheno_testl,whichvcf,phenol,projectl,exskipif:,pheno_test,project_clean_all_vcf_file,pheno,project,skip_if num_var_subsets:short,pheno_test_variant_subset,pheno_variant_subset_clean_all_vcf_file,pheno_variant_subset,project_variant_subset,skip_if !num_var_subsets| \
shortt cmd make_pheno_testl_epacts_small_vassoc_file=$smart_join_cmd --in-delim $tab --header 1 --exec "$smart_join_cmd --in-delim $tab !{input,--file,projectl_vfreq_file} --exec \"$smart_cut_cmd --in-delim $tab !{input,--file,phenol_vassoc_counts_file} --select-col 1,1,'VAR NEFF'\" --header 1 --extra 1 | $smart_cut_cmd --in-delim $tab --select-col 0,1,'VAR REF ALT NEFF' --exact --require-col-match | $parse_out_id | tail -n+2 | sed '1 s/^/ID\tREF\tALT\tNEFF\n/'" --exec "$fill_file_helper_int(--exec \\"$smart_cut_cmd --in-delim $tab !{input:--file:pheno_testl_vassoc_file} --arg-delim : --select-col 1:4 --select-col 1:1:. | sed '1 s/^/:_:_/' | cut -d_ -f3-\\",cat !{input::pheno_testl_vassoc_file},!{input::phenol_vassoc_counts_file} | $parse_out_id,NA,1,1,1,1,\t)" --rest-extra 2 --header 1 \
			 | $add_function_cmd --in-delim $tab --header 1 --col1 $beta_col_disp --type exp --val-header $or_col_disp \
			 | $smart_cut_cmd --tab-delim --exact --require-col-match --select-col 0,1 --select-col 0,1,'NS NEFF MAF REF ALT $or_col_disp BETA SEBETA PVALUE' | sed '1 s/\tPVALUE/\t$p_col_disp/' | sed '1 s/\tNS/\t$n_col_disp/' | sed '1 s/\tNEFF/\t$neff_col_disp/' | sed '1 s/\tMAF/\t$maf_col_disp/' | sed '1 s/\tREF/\t$ref_col_disp/' | sed '1 s/\tALT/\t$alt_col_disp/' | sed '1 s/\tSEBETA/\t$se_col_disp/' | sed '1 s/\tBETA/\t$beta_col_disp/' | sed '1 s/^\S\S*/$id_col_disp/' | $replace_nan(NA) > !{output,,pheno_testl_small_vassoc_file} class_level pheno_testl run_if test_software:eq:epacts exskipif bsub_batch 50

#plink commands

!|expand:;:covartype;skipif:covar;or,run_raw,(and,!strat_covar,!covar_traits):popgen;!run_raw| \
!|expand:;:alltype;runif:all;include_related:unrelated;!include_related| \
local cmd make_pheno_test_plink_covartype_alltype_sample_include_aux_file=$pheno_test_epacts_or_plink_covartype_alltype_keep_helper(sample_plink,include,,) class_level pheno_test skip_if skipif run_if and,(or,pheno_test_sample_include_file,alternate_pheno),test_software:eq:plink,runif


!|expand:,:phenol,pheno_testl:pheno,pheno_test:pheno_variant_subset,pheno_test_variant_subset| \
plink_pheno_testl_helper_no_flag=$plink_cmd $plink_in_bed_helper(phenol) !{input,--pheno,pheno_test_covars_aux_file,if_prop=alternate_pheno,allow_empty=1} !{input,--keep,pheno_sample_plink_@{3}_include_file,unless_prop=pheno_test_sample_include_file,unless_prop=alternate_pheno,allow_empty=1} !{input,--keep,pheno_test_sample_include_aux_file,if_prop=pheno_test_sample_include_file,if_prop=alternate_pheno,or_if_prop=1,allow_empty=1} --allow-no-sex !{raw,--out,pheno_testl,*{@{1}}} !{output,@{2}} 

!|expand:,:pheno_testl:pheno_test:pheno_test_variant_subset| \
plink_pheno_testl_helper=$plink_pheno_testl_helper_no_flag(@1,@2,@3) --!{prop::pheno_test:test_name} !{prop;;pheno_test;test_options;if_prop=test_options;allow_empty=1}

!|expand:;:alltype;allrunif:all;include_related:unrelated;!include_related| \
!|expand:,:shortt,pheno_testl,exskipif:,pheno_test,num_var_subsets:short,pheno_test_variant_subset,!num_var_subsets| \
shortt cmd make_pheno_testl_plink_raw_alltype_vassoc_file=$plink_pheno_testl_helper(pheno_testl_vassoc_plink_trunk,pheno_testl_vassoc_file,popgen_alltype) && mv !{raw,,pheno_testl,*pheno_testl_vassoc_plink_trunk}.assoc.!{prop::pheno_test:test_name} !{output,,pheno_testl_vassoc_file} class_level pheno_testl run_if and,run_raw,test_software:eq:plink,allrunif skip_if exskipif

!|expand:;:alltype;allrunif:all;include_related:unrelated;!include_related| \
local cmd make_pheno_test_plink_raw_alltype_info_file=$record_pheno_test_info(!{prop;;pheno_test;test_name;sep=\,},no,no,$gq_crit_helper,!{input;;pheno_sample_plink_popgen_alltype_include_file;unless_prop=pheno_test_sample_include_file;unless_prop=alternate_pheno,allow_empty=1} !{input;;pheno_test_sample_include_aux_file;if_prop=pheno_test_sample_include_file;if_prop=alternate_pheno,or_if_prop=1,allow_empty=1}) class_level pheno_test run_if and,run_raw,test_software:eq:plink,allrunif

plink_vif=100

!|expand:;:alltype;allrunif:all;include_related:unrelated;!include_related| \
!|expand:,:shortt,pheno_testl,exskipif:,pheno_test,num_var_subsets:short,pheno_test_variant_subset,!num_var_subsets| \
shortt cmd make_pheno_testl_plink_strata_alltype_vassoc_file=$plink_pheno_testl_helper(pheno_testl_vassoc_plink_trunk,pheno_testl_vassoc_file,covar_alltype) !{input,--covar,pheno_plink_covar_file,unless_prop=extra_covar_traits,allow_empty=1} !{input,--covar,pheno_test_covars_aux_file,if_prop=extra_covar_traits,allow_empty=1} --covar-name $get_plink_covars(pheno_test) --vif $plink_vif && mv !{raw,,pheno_testl,*pheno_testl_vassoc_plink_trunk}.assoc.!{prop::pheno_test:test_name} !{output,,pheno_testl_vassoc_file} class_level pheno_testl run_if and,!run_raw,(or,strat_covar,covar_traits),test_software:eq:plink,allrunif skip_if exskipif

!|expand:;:alltype;allrunif:all;include_related:unrelated;!include_related| \
local cmd make_pheno_test_plink_strata_alltype_info_file=$record_pheno_test_info(!{prop;;pheno_test;test_name;sep=\,},$get_disp_covars_pheno_test,no,$gq_crit_helper,!{input;pheno_test_covars_aux_file;if_prop=extra_covar_traits;allow_empty=1} !{raw;;pheno_test;*pheno_test_covars_aux_file | sed 's/ /\t/g' | cut -f1-2 | cat -;if_prop=extra_covar_traits;allow_empty=1} !{input;;pheno_sample_plink_covar_alltype_include_file;unless_prop=pheno_test_sample_include_file;unless_prop=alternate_pheno;allow_empty=1} !{input;;pheno_test_sample_include_aux_file;if_prop=pheno_test_sample_include_file;if_prop=alternate_pheno;or_if_prop=1;allow_empty=1} | sed 's/\s\s*/\t/g' !{raw;;pheno_test;| sort | uniq -d | cat -;if_prop=extra_covar_traits;allow_empty=1}) class_level pheno_test run_if and,!run_raw,(or,strat_covar,covar_traits),test_software:eq:plink,allrunif

#while converting, need to
#1. Make sure OR is relative to non-reference allele (in PLINK it is minor)
#2. Replace the var ID with chr:pos:id (which is what PSEQ outputs for glm)
#This is used to convert any plink glm (assoc) file
#And also to convert the dominant model when merging

!|expand:,:phenol,projectl:pheno,project:pheno_variant_subset,project_variant_subset| \
parse_ref_min_phenol=$smart_cut_cmd --in-delim $tab !{input,--file,projectl_vfreq_file} --select-col 1,1,'VAR REFMIN REF ALT' --require-col-match --exact | sed 's/^\(\S*:\S*:\(\S*\)\)/\2\t\1/' | sed '1 s/.*/VAR\tFULL_ID\tREFMIN\tREF\tALT/'

!|expand:,:shortt,pheno_testl,phenol,projectl,exskipif:,pheno_test,pheno,project,skip_if num_var_subsets:short,pheno_test_variant_subset,pheno_variant_subset,project_variant_subset,skip_if !num_var_subsets| \
shortt cmd make_pheno_testl_plink_small_vassoc_file=$smart_join_cmd --in-delim $tab --header 1 --col 3,2 --rest-extra 3 --exec "$parse_ref_min_phenol" --exec "$smart_cut_cmd --out-delim $tab !{input,--file,phenol_vassoc_counts_file} --select-col 1,1 --select-col 1,1,'MAF NEFF' | $parse_out_id" --exec "$smart_cut_cmd !{input,--file,pheno_testl_vassoc_file} --out-delim $tab --select-row 1,1,TEST,ADD --select-row 1,1"  !{raw;;pheno_test;| $add_function_cmd --in-delim $tab --col1 OR --type ln --header 1 --val-header BETA;if_prop=test_name:eq:logistic;allow_empty=1} !{raw;;pheno_test;| $add_function_cmd --in-delim $tab --header 1 --col1 BETA --type exp --val-header OR;if_prop=test_name:eq:linear;allow_empty=1} | $add_function_cmd --in-delim $tab --col1 BETA --col2 STAT --type divide --header 1 --val-header SE | $smart_cut_cmd --in-delim $tab --select-col 0,1,'REFMIN FULL_ID MAF REF ALT NMISS BETA OR SE STAT P NEFF' --exact --require-col-match | awk -F"\t" -v OFS="\t" 'NR > 1 && \$1 == 1 {if (\$8 == "NA") { } else if (\$8 == "inf") { \$8 = 0 } else if (\$8 != 0) {\$8 = 1/\$8} else {\$8 = $glm_max_or} \$10=-\$10; \$7=-\$7} {print}' | sed '1 s/NMISS/N/' | sed '1 s/MAF/F/' | cut -f2- | sed '1 s/^\S\S*/CHR:POS:VAR/' | $parse_out_id | $smart_cut_cmd --tab-delim --exact --require-col-match --select-col 0,1 --exact --select-col 0,1,'N NEFF F REF ALT OR BETA SE P' | sed '1 s/\tN/\t$n_col_disp/' | sed '1 s/\tNEFF/\t$neff_col_disp/' | sed '1 s/\tF/\t$maf_col_disp/' | sed '1 s/\tREF/\t$ref_col_disp/' | sed '1 s/\tALT/\t$alt_col_disp/' | sed '1 s/\tOR/\t$or_col_disp/' | sed '1 s/\tBETA/\t$beta_col_disp/' | sed '1 s/\tSE/\t$se_col_disp/' | sed '1 s/\tP/\t$p_col_disp/' | sed '1 s/^\S\S*/$id_col_disp/' | $replace_nan(NA) > !{output,,pheno_testl_small_vassoc_file} class_level pheno_testl run_if test_software:eq:plink exskipif

#pseq commands

get_disp_cluster=!{prop::@1:strata_traits:if_prop=strata_traits:sep=,:allow_empty=1}!{raw::@1:, :if_prop=strata_traits:if_prop=strat_cluster:allow_empty=1}!{raw::@1:with clustering:if_prop=strat_cluster:allow_empty=1}
get_disp_cluster_burden_test=$get_disp_cluster(burden_test)
get_disp_cluster_pheno_test=$get_disp_cluster(pheno_test)

!|expand:;:alltype;allrunif:all;include_related:unrelated;!include_related| \
!|expand:,:shortt,pheno_testl,phenol,exskipif:,pheno_test,pheno,num_var_subsets:short,pheno_test_variant_subset,pheno_variant_subset,!num_var_subsets| \
shortt cmd make_pheno_testl_pseq_raw_alltype_vassoc_file=$pseq_qc_plus_alltype_analysis_cmd_phenol($vassoc) $pheno_test_indiv_ex_helper $show_id $pheno_vassoc_helper(-1) !{raw,,pheno_test,--fix-null,if_prop=fix_null,allow_empty=1} !{prop;;pheno_test;test_options;if_prop=test_options;allow_empty=1} > !{output,,pheno_testl_vassoc_file} class_level pheno_testl run_if and,run_raw,test_software:eq:pseq,test_name:eq:v-assoc,allrunif skip_if exskipif

!|expand:;:alltype;allrunif:all;include_related:unrelated;!include_related| \
local cmd make_pheno_test_pseq_raw_alltype_info_file=$record_pheno_test_info(!{prop;;pheno_test;test_name;sep=\,},no,no,$gq_crit_helper,!{input;;pheno_sample_popgen_alltype_include_file} !{input;;pheno_test_sample_include_aux_file;if_prop=pheno_test_sample_include_file;allow_empty=1} !{input;;pheno_test_sample_include_aux_file;if_prop=pheno_test_sample_include_file;allow_empty=1} | sort | uniq -u) class_level pheno_test run_if and,run_raw,test_software:eq:pseq,test_name:eq:v-assoc,allrunif

!|expand:;:alltype;allrunif:all;include_related:unrelated;!include_related| \
!|expand:,:shortt,pheno_testl,phenol,exskipif:,pheno_test,pheno,num_var_subsets:short,pheno_test_variant_subset,pheno_variant_subset,!num_var_subsets| \
shortt cmd make_pheno_testl_pseq_strata_alltype_vassoc_file=$pseq_qc_plus_alltype_analysis_cmd_phenol_cluster($vassoc) $pheno_test_indiv_ex_helper $show_id $pheno_vassoc_helper(-1) $add_strata(pheno_testl) !{raw,,pheno_test,--fix-null,if_prop=fix_null,allow_empty=1} !{prop;;pheno_test;test_options;if_prop=test_options;allow_empty=1} > !{output,,pheno_testl_vassoc_file} class_level pheno_testl run_if and,!run_raw,(or,strat_cluster,strata_traits),test_software:eq:pseq,test_name:eq:v-assoc,allrunif skip_if exskipif
!|expand:;:alltype;allrunif:all;include_related:unrelated;!include_related| \
local cmd make_pheno_test_pseq_strata_alltype_info_file=$record_pheno_test_info(!{prop;;pheno_test;test_name;sep=\,},no,$get_disp_cluster_pheno_test,$gq_crit_helper,!{input;;pheno_sample_cluster_alltype_include_file} !{input;;pheno_test_sample_include_aux_file;if_prop=pheno_test_sample_include_file;allow_empty=1} !{input;;pheno_test_sample_include_aux_file;if_prop=pheno_test_sample_include_file;allow_empty=1} | sort | uniq -u) class_level pheno_test run_if and,!run_raw,(or,strat_cluster,strata_traits),test_software:eq:pseq,test_name:eq:v-assoc

!|expand:,:shortt,pheno_testl,whichvcf,phenol,projectl,exskipif:,pheno_test,project_clean_all_vcf_file,pheno,project,skip_if num_var_subsets:short,pheno_test_variant_subset,pheno_variant_subset_clean_all_vcf_file,pheno_variant_subset,project_variant_subset,skip_if !num_var_subsets| \
shortt cmd make_pheno_testl_pseq_small_vassoc_file=$smart_join_cmd --in-delim $tab !{input,--file,pheno_testl_vassoc_file} --exec "$smart_cut_cmd --in-delim $tab !{input,--file,phenol_vassoc_counts_file} --select-col 1,1,'VAR NEFF'" --rest-extra 1 --header 1 | sed '1 s/^/CHR:POS:/' | $parse_out_id | $add_function_cmd --in-delim $tab --col1 OBSA --col2 OBSU --header 1 --type add --val-header OBS | $add_function_cmd --in-delim $tab --col1 OR --header 1 --type exp --val-header BETA  | sed '1 s/$/\tSEBETA/' | sed '1! s/$/\tNA/' | $smart_cut_cmd --tab-delim --exact --require-col-match --select-col 0,1 --select-col 0,1,'OBS NEFF MAF REF ALT OR BETA SEBETA P I ORDOM PDOM IDOM ORREC PREC IREC' --require-col-match --exact | sed '1 s/\tP/\t$p_col_disp/' | sed '1 s/\tOBS/\t$n_col_disp/' | sed '1 s/\tNEFF/\t$neff_col_disp/' | sed '1 s/\tMAF/\t$maf_col_disp/' | sed '1 s/\tREF/\t$ref_col_disp/' | sed '1 s/\tALT/\t$alt_col_disp/' | sed '1 s/\tSEBETA/\t$se_col_disp/' | sed '1 s/\tBETA/\t$beta_col_disp/' | sed '1 s/\tOR/\t$or_col_disp/' | sed '1 s/^\S\S*/$id_col_disp/' | $replace_nan(NA) > !{output,,pheno_testl_small_vassoc_file} class_level pheno_testl run_if and,test_software:eq:pseq,test_name:eq:v-assoc exskipif

#MANTRA

#local cmd make_pheno_test_mantra_info_file=$record_pheno_meta_test_info(!{prop;;pheno_test;test_name;sep=\,;all_instances=1;if_prop=pheno_test:eq:@meta_test;if_prop=pheno:eq:@pheno;if_prop=project:eq:@project},NA,NA,NA) class_level pheno_test run_if and,test_software:eq:mantra,meta_trait_inv

local cmd make_pheno_test_mantra_info_file=$record_pheno_meta_test_info(!{prop;;pheno_test;test_name;sep=\,;all_instances=1;if_prop=pheno_test:eq:@meta_test;if_prop=pheno:eq:@meta_trait_inv;if_prop=project:eq:@project},NA,NA,NA) class_level pheno_test run_if and,test_software:eq:mantra,meta_trait_inv

local cmd make_pheno_test_mantra_in_aux1_file=perl -le 'print "!{prop,,pheno,meta_trait_inv,sep=\n}"' | sort > !{output,,pheno_test_in_aux1_file} class_level pheno_test run_if and,test_software:eq:mantra,meta_trait_inv

!|expand%;%shortt;pheno_testi;pheno_testl;exifprop;excons;phenol;projectl;exskipif%\
;pheno_test;pheno_test;;;project;project;skip_if num_var_subsets%\
short;pheno_test_variant_subset;pheno_test_variant_subset;if_prop=var_subset_num:eq:@var_subset_num,if_prop=expand_subset_num:eq:@expand_subset_num,;consistent_prop var_subset_num;pheno_variant_subset;project_variant_subset;skip_if or,!num_var_subsets,meta_test_no_subsets bsub_batch 25%\
short;pheno_test;pheno_test_variant_subset;;;pheno_variant_subset;project_variant_subset;skip_if or,!num_var_subsets,!meta_test_no_subsets bsub_batch 25| \
shortt cmd make_pheno_testl_pheno_testi_mantra_in_aux2_file=$smart_join_cmd --in-delim $tab --header 1 --rest-extra 1 --exec "$smart_cut_cmd --in-delim $tab !{input,--file,phenol_clean_gene_variant_file} --select-col 1,1,ID" --exec "$smart_cut_cmd  --in-delim $tab !{input,--file,projectl_vfreq_file} --exact --require-col-match --select-col 1,1,'VAR CHR POS REF ALT' | awk -F\"\\t\" -v OFS=\"\\t\" 'NR > 1 && (length(\\$4) > 1 || length(\\$5) > 1) {\\$4=\"R\"; \\$5=\"X\"} {print}' | $parse_out_id | sed 's/^\(\S\S*\)/\1\t\1\t1\tNA\t\1/'" !{raw,--exec,pheno_testi,"$smart_cut_cmd --in-delim $tab --file *pheno_testi_clean_small_vassoc_file --select-col 1\,1 --select-col 1\,1\,'$neff_col_disp $maf_col_disp $beta_col_disp $se_col_disp $n_col_disp' --require-col-match --exact | awk -F\"\\t\" -v OFS\=\"\\t\" 'NR > 1 && \\$2 \=\= \"NA\" {\\$2\=\\$NF} {print}' | $add_function_cmd --in-delim $tab --header 1 --col1 $n_col_disp --col2 $maf_col_disp --val2 2 --type multiply --val-header MAC | awk -v OFS\=\"\\t\" -F\"\\t\" '{\\$NF\=int(\\$NF+.5)} {print}' | $smart_cut_cmd --in-delim $tab --exclude-col 0\,1\,$n_col_disp --exact | sed 's/^\(\S\S*\)/\1\t@pheno\t\1\t2\t@pheno/'",all_instances=1,exifpropif_prop=project:eq:@project,if_prop=pheno:eq:@meta_trait_inv,if_prop=pheno_test:eq:@meta_test} !{input,pheno_testi_clean_small_vassoc_file,all_instances=1,exifpropif_prop=project:eq:@project,if_prop=pheno:eq:@meta_trait_inv,if_prop=pheno_test:eq:@meta_test,instance_level=pheno_testi} | tail -n+2 !{raw,|,pheno_testi,sed 's/\t@pheno/\n/',all_instances=1,exifpropif_prop=project:eq:@project,if_prop=pheno:eq:@meta_trait_inv,if_prop=pheno_test:eq:@meta_test} | cut -f2- | sort -k1,1 -k2,2n -k3,3 | cut -f2,4- | awk -F"\t" -v OFS="\t" '\$1 == 2 {good=1; for (i=1;i<=NF;i++) {if (\$i !~ /[0-9\-\.e]+/) {good=0}} if (\$6 < !{prop,,pheno_test,min_mantra_mac}) {good=0} if (!good || \$3 == 0) {for (i=2;i<=NF;i++) {\$i=0} {print 0,\$0}} else {print 1,\$0}} \$1 == 1 {\$1=\$2; print}' | cut -f1,3- > !{output,,pheno_testl_in_aux2_file} class_level pheno_testl run_if and,test_software:eq:mantra,meta_trait_inv exskipif excons

local cmd make_pheno_test_mantra_in_aux4_file=awk '{print \$2}' !{input,,pheno_sample_pruned_marker_bim_file} | cat - !{input,,pheno_test_in_aux2_file} | awk -F"\t" -v OFS="\t" 'NF == 5 {v=\$1; print \$1,NR,\$0} NF == 6 {print v,NR,\$0} NF == 1 {print \$1,0}' | sort -k1,1 -k2,2n | awk -F"\t" -v OFS="\t" 'NF == 2 {v=\$1} NF > 2 && v && v == \$1 {print}' | sort -k2,2n | cut -f3- > !{output,,pheno_test_in_aux4_file} class_level pheno_test run_if and,test_software:eq:mantra,meta_trait_inv 

#!|expand%;%shortt;pheno_testi;pheno_testl;exifprop;excons;phenol;projectl;exskipif%\
#;pheno_test;pheno_test;;;project;project;skip_if num_var_subsets%\
#short;pheno_test_variant_subset;pheno_test_variant_subset;if_prop=var_subset_num:eq:@var_subset_num,if_prop=expand_subset_num:eq:@expand_subset_num,;consistent_prop var_subset_num;pheno_variant_subset;project_variant_subset;skip_if or,!num_var_subsets,meta_test_no_subsets%\
#short;pheno_test;pheno_test_variant_subset;;;pheno_variant_subset;project_variant_subset;skip_if or,!num_var_subsets,!meta_test_no_subsets| \
#shortt cmd make_pheno_testl_pheno_testi_mantra_in_aux2_file=$smart_join_cmd --in-delim $tab --header 1 --rest-extra 1 --exec "$smart_cut_cmd --in-delim $tab !{input,--file,phenol_clean_gene_variant_file} --select-col 1,1,ID" --exec "$smart_cut_cmd --in-delim $tab !{input,--file,projectl_vfreq_file} --exact --require-col-match --select-col 1,1,'VAR CHR POS REF ALT' | $parse_out_id | sed 's/^\(\S\S*\)/\1\t\1\t1\tNA\t\1/'" !{raw,--exec,pheno_testi,"$smart_cut_cmd --in-delim $tab --file *pheno_testi_small_vassoc_file --select-col 1\,1 --select-col 1\,1\,'$neff_col_disp $maf_col_disp $beta_col_disp $se_col_disp $n_col_disp' --require-col-match --exact | $add_function_cmd --in-delim $tab --header 1 --col1 $n_col_disp --col2 $maf_col_disp --type multiply --val-header MAC | sed 's/^\(\S\S*\)/\1\t@pheno\t\1\t2\t@pheno/'",all_instances=1,exifpropif_prop=project:eq:@project,if_prop=pheno:eq:@meta_trait_inv,if_prop=pheno_test:eq:@meta_test} !{input,pheno_testi_small_vassoc_file,all_instances=1,exifpropif_prop=project:eq:@project,if_prop=pheno:eq:@meta_trait_inv,if_prop=pheno_test:eq:@meta_test,instance_level=pheno_testi}  > !{output,,pheno_testl_in_aux2_file} class_level pheno_testl run_if and,test_software:eq:mantra,meta_trait_inv exskipif excons


short cmd make_pheno_test_mantra_in_aux3_file=(echo !{input,,pheno_test_in_aux1_file} && echo !{input,,pheno_test_in_aux4_file} && echo !{output,,pheno_test_in_aux3_file}) | $dmatcal_cmd class_level pheno_test run_if and,test_software:eq:mantra,meta_trait_inv

!|expand:,:shortt,pheno_testl,phenol,exskipif:,pheno_test,pheno,num_var_subsets:short,pheno_test_variant_subset,pheno_variant_subset,!num_var_subsets| \
shortt cmd make_pheno_testl_mantra_vassoc_file=(echo !{input,,pheno_test_in_aux1_file} && echo !{input,,pheno_testl_in_aux2_file} && echo !{input,,pheno_test_in_aux3_file} && echo !{output,,pheno_testl_vassoc_file} && echo !{output,,pheno_testl_out_aux1_file} && echo 1) | $mantra_cmd class_level pheno_testl run_if and,test_software:eq:mantra,meta_trait_inv skip_if exskipif

!|expand:,:shortt,pheno_testl,phenol,exskipif:,pheno_test,project,num_var_subsets:short,pheno_test_variant_subset,pheno_variant_subset,!num_var_subsets| \
shortt cmd make_pheno_testl_mantra_small_vassoc_file=ap=`head -n1 !{input,,pheno_testl_vassoc_file} | sed 's/^\S\S*\s\s*//' | sed 's/\S\S*/NA/g'` && $smart_join_cmd --out-delim $tab !{input,--file,pheno_testl_vassoc_file} --exec "$smart_cut_cmd --in-delim $tab !{input,--file,phenol_clean_gene_variant_file} --select-col 1,1,ID --exclude-row 1,1 | sed 's/$/ \$ap/'" --merge | sed 's/\s\s*/\t/g' | sed '1 s/^/$id_col_disp\tCHROM\tPOS\tEFFECT\tOTHER\tSTUDIES\tEAC\tMAC\tEAF\t${bf_col_disp}\t${bf_col_disp}_FE\t${bf_col_disp}_HET\t$n_col_disp\t$dir_col_disp\n/' | $replace_nan(NA) > !{output,,pheno_testl_small_vassoc_file} class_level pheno_testl run_if and,test_software:eq:mantra,meta_trait_inv skip_if exskipif


#METASOFT

local cmd make_pheno_test_metasoft_info_file=$record_pheno_meta_test_info(!{prop;;pheno_test;test_name;sep=\,;all_instances=1;if_prop=pheno_test:eq:@meta_test;if_prop=pheno:eq:@meta_trait_inv;if_prop=project:eq:@project},NA,NA,NA) class_level pheno_test run_if and,test_software:eq:metasoft,meta_trait_inv

short cmd make_pheno_test_metasoft_in_aux1_file=$smart_join_cmd --in-delim $tab !{raw,--exec,pheno_test,"$smart_cut_cmd --in-delim $tab --file *pheno_test_clean_small_vassoc_file --select-col 1\,1 --select-col 1\,1\,'$beta_col_disp $se_col_disp' --require-col-match --exact --exclude-row 1\,1",all_instances=1,if_prop=project:eq:@project,if_prop=pheno:eq:@meta_trait_inv,if_prop=pheno_test:eq:@meta_test} !{input,pheno_test_clean_small_vassoc_file,all_instances=1,if_prop=project:eq:@project,if_prop=pheno:eq:@meta_trait_inv,if_prop=pheno_test:eq:@meta_test} > !{output,,pheno_test_in_aux1_file} class_level pheno_test run_if and,test_software:eq:metasoft,meta_trait_inv

short cmd make_pheno_test_metasoft_vassoc_file=$metasoft_cmd !{input,-input,pheno_test_in_aux1_file} -pvalue_table $metasoft_pvalue_table !{output,-log,pheno_test_out_aux1_file} !{output,-output,pheno_test_vassoc_file} class_level pheno_test run_if and,test_software:eq:metasoft,meta_trait_inv

short cmd make_pheno_test_metasoft_small_vassoc_file=cut -f1-16 !{input,,pheno_test_vassoc_file} | $smart_cut_cmd --in-delim $tab --select-col 0,1 --select-col 0,1,'BETA_RE PVALUE_RE2' | sed '1 s/.*/$id_col_disp\t$beta_col_disp\t$p_col_disp/' | $add_function_cmd --in-delim $tab --col1 $beta_col_disp --header 1 --type exp --val-header $or_col_disp --add-at $beta_col_disp | $replace_nan(NA) > !{output,,pheno_test_small_vassoc_file} class_level pheno_test run_if and,test_software:eq:metasoft,meta_trait_inv skip_if exskipif

#METAL

local cmd make_pheno_test_metal_info_file=$record_pheno_meta_test_info(!{prop;;pheno_test;test_name;sep=\,;all_instances=1;all_instances=1;if_prop=project:eq:@project;if_prop=pheno:eq:@meta_trait_inv;if_prop=pheno_test:eq:@meta_test;limit=1}: !{prop;;pheno_test;meta_trait_inv;sep=\,},NA,NA,NA) class_level pheno_test run_if and,test_software:eq:metal,meta_trait_inv

local cmd make_pheno_test_metal_in_aux1_file=(echo SCHEME !{prop,,pheno_test,metal_scheme} !{raw,,pheno_test,&& echo GENOMICCONTROL ON,if_prop=gc_correct,allow_empty=1} && echo MARKER $id_col_disp && echo PVALUE $p_col_disp && echo WEIGHT $neff_col_disp && echo FREQ $maf_col_disp && echo ALLELE ALT REF && echo AVERAGEFREQ ON && echo MINMAXFREQ ON && echo STDERR $se_col_disp && echo EFFECT $beta_col_disp && echo CUSTOMVARIABLE TotalSampleSize && echo LABEL TotalSampleSize as $n_col_disp && echo CUSTOMVARIABLE TotalEffectiveSampleSize && echo LABEL TotalEffectiveSampleSize as $neff_col_disp && !{raw,,pheno_test,echo PROCESS *pheno_test_clean_small_vassoc_file,sep=&&,all_instances=1,if_prop=project:eq:@project,if_prop=pheno:eq:@meta_trait_inv,if_prop=pheno_test:eq:@meta_test} !{input,pheno_test_clean_small_vassoc_file,all_instances=1,if_prop=project:eq:@project,if_prop=pheno:eq:@meta_trait_inv,if_prop=pheno_test:eq:@meta_test} && echo OUTFILE !{raw,,pheno_test,*pheno_test_vassoc_file} .tbl && echo ANALYZE HETEROGENEITY) > !{output,,pheno_test_in_aux1_file} class_level pheno_test run_if and,test_software:eq:metal,meta_trait_inv 

#local cmd make_pheno_test_metal_in_aux1_file=(echo SCHEME !{prop,,pheno_test,metal_scheme} && echo MARKER $id_col_disp && echo PVALUE $p_col_disp && echo FREQ $maf_col_disp && echo ALLELE ALT REF && echo AVERAGEFREQ ON && echo MINMAXFREQ ON && echo STDERR $se_col_disp && echo EFFECT $beta_col_disp && echo CUSTOMVARIABLE TotalSampleSize && echo LABEL TotalSampleSize as $n_col_disp && !{raw,,pheno_test,echo PROCESS *pheno_test_small_vassoc_file,sep=&&,all_instances=1,if_prop=project:eq:@project,if_prop=pheno:eq:@meta_trait_inv,if_prop=pheno_test:eq:@meta_test} !{input,pheno_test_small_vassoc_file,all_instances=1,if_prop=project:eq:@project,if_prop=pheno:eq:@meta_trait_inv,if_prop=pheno_test:eq:@meta_test} && echo OUTFILE !{raw,,pheno_test,*pheno_test_vassoc_file} .tbl && echo ANALYZE) > !{output,,pheno_test_in_aux1_file} class_level pheno_test run_if and,test_software:eq:metal,meta_trait_inv 

short cmd make_pheno_test_metal_vassoc_file=cat !{input,,pheno_test_in_aux1_file} | $metal_cmd !{output,pheno_test_vassoc_file} !{input,pheno_test_clean_small_vassoc_file,all_instances=1,if_prop=project:eq:@project,if_prop=pheno:eq:@meta_trait_inv,if_prop=pheno_test:eq:@meta_test} > !{output,,pheno_test_out_aux1_file} && mv !{output,,pheno_test_vassoc_file}1.tbl !{output,,pheno_test_vassoc_file} class_level pheno_test run_if and,test_software:eq:metal,meta_trait_inv

short cmd make_pheno_test_metal_small_vassoc_file=$smart_join_cmd --in-delim $tab --header 1 --rest-extra 2  --exec "$parse_ref_min_pheno" --exec "$fill_file_helper(pheno_test_vassoc_file,project_clean_gene_variant_file,NA,1,$clean_gene_variant_id_col,1,1) | perl -lne 'chomp; @a = split(\"\t\"); \\$a[1] =~ tr/[a-z]/[A-Z]/; \\$a[2] =~ tr/[a-z]/[A-Z]/; print join(\"\t\", @a)'" | $smart_cut_cmd --in-delim $tab --select-col 0,1,'VAR Freq1 ALT REF ALLELE1 ALLELE2 TotalSampleSize TotalEffectiveSampleSize Effect Zscore StdErr P-value Direction' --exact | $replace_nan(NA) | awk -F"\t" -v OFS="\t" 'NR > 1 && toupper(\$3) != toupper(\$5) && \$7 != "NA" {\$9 = -\$9; gsub("-","*",\$13); gsub("+","-",\$13); gsub("*","+",\$13)} {print}' | sed '1 s/\tP-value/\t$p_col_disp/' | sed '1 s/\tFreq1/\t$maf_col_disp/' | sed '1 s/\tTotalSampleSize/\t$n_col_disp/' | sed '1 s/\tTotalEffectiveSampleSize/\t$neff_col_disp/' | sed '1 s/\tREF/\t$ref_col_disp/' | sed '1 s/\tALT/\t$alt_col_disp/' | sed '1 s/\tStdErr/\t$se_col_disp/' | sed '1 s/\t!{raw,,pheno_test,Effect,if_prop=metal_scheme:ne:SAMPLESIZE,allow_empty=1}!{raw,,pheno_test,Zscore,if_prop=metal_scheme:eq:SAMPLESIZE,allow_empty=1}/\t$beta_col_disp/' | sed '1 s/VAR/$id_col_disp/' | sed '1 s/Direction/$dir_col_disp/' !{raw;;pheno_test;| $add_function_cmd --in-delim $tab --header 1 --col1 $beta_col_disp --type exp --val-header $or_col_disp;if_prop=metal_scheme:eq:STDERR;allow_empty=1} | $smart_cut_cmd --in-delim $tab --select-col 0,1,'$id_col_disp $ref_col_disp $alt_col_disp $n_col_disp $neff_col_disp $maf_col_disp !{raw,,pheno_test,$or_col_disp $se_col_disp,if_prop=metal_scheme:eq:STDERR,allow_empty=1} $beta_col_disp $p_col_disp $dir_col_disp' --require-col-match --exact > !{output,,pheno_test_small_vassoc_file} class_level pheno_test run_if and,test_software:eq:metal,meta_trait_inv

#END TESTS

prop apply_gc_correction=scalar default 0

short cmd make_pheno_test_clean_include_file=cat !{input,,pheno_vassoc_pre_annot_file} | $apply_vassoc_clean_filters(pheno_test) $extended_qc_filter_helper(pheno_test) > !{output,,pheno_test_clean_include_file} class_level pheno_test skip_if or,not_trait,(and,(or,pheno_qt,min_clean_p_missing:le:0),min_clean_geno:le:0,min_clean_hwe:le:0,!custom_clean_annot_exclude_filters,!extended_clean_annot_exclude_filters,!apply_extended_strict_qc,!apply_extended_qc)

#short cmd make_pheno_test_clean_include_file=$smart_join_cmd --in-delim 1,$tab !{input,--file,pheno_vassoc_pre_annot_file} !{input,--file,pheno_lmiss_file} --header 1 --col 2,2 | $apply_vassoc_clean_filters(pheno_test) $extended_qc_filter_helper(pheno_test) > !{output,,pheno_test_clean_include_file} class_level pheno_test skip_if or,not_trait,(and,(or,pheno_qt,min_clean_p_missing:le:0),min_clean_geno:le:0,min_clean_hwe:le:0,!custom_clean_annot_exclude_filters,!extended_clean_annot_exclude_filters,!apply_extended_strict_qc,!apply_extended_qc)

short cmd make_dummy_pheno_test_clean_include_file=cut -f1 !{input,,pheno_test_small_vassoc_file} | tail -n+2 > !{output,,pheno_test_clean_include_file} class_level pheno_test run_if and,(or,pheno_qt,min_clean_p_missing:le:0),min_clean_geno:le:0,min_clean_hwe:le:0,!custom_clean_annot_exclude_filters,!extended_clean_annot_exclude_filters,!apply_extended_strict_qc,!apply_extended_qc

short cmd make_pheno_test_lambda_file=$smart_join_cmd --exec "awk '{print \\$2}' !{input,,pheno_sample_pruned_marker_bim_file} | cat - !{input,,pheno_test_clean_include_file} | sort | uniq -d | sed '1 s/^/ID\n/'" !{input,--file,pheno_test_small_vassoc_file} --rest-extra 1 --header 1 | $smart_cut_cmd --in-delim $tab --exclude-row 0,1 --select-col 0,1,$p_col_disp | $compute_lambda_cmd | awk '{print \$NF}' > !{output,,pheno_test_lambda_file} class_level pheno_test run_if apply_gc_correction

local cmd make_dummy_pheno_test_lambda_file=echo 1 > !{output,,pheno_test_lambda_file} class_level pheno_test skip_if apply_gc_correction

!|expand@;@shortt;pheno_testl;phenol;projectl;exskipif@;pheno_test;pheno;project;run_if or,!num_var_subsets,test_software:eq:metasoft,test_software:eq:metal@short;pheno_test_variant_subset;pheno_variant_subset;project_variant_subset;run_if and,num_var_subsets,test_software:ne:metasoft,test_software:ne:metal bsub_batch 20| \
short cmd make_pheno_testl_clean_small_vassoc_file=gc=`cat !{input,,pheno_test_lambda_file} | perl -ne 'print \$_ > 1 ? \$_ : 1'` && gc_sqrt=`perl -e "print sqrt(\$gc)"` && $smart_join_cmd --in-delim $tab --exec "tail -n+2 !{input,,pheno_testl_small_vassoc_file} | cut -f1 | cat - !{input,,pheno_test_clean_include_file} | sort | uniq -d | sed '1 s/^/ID\n/'" !{input,--file,pheno_testl_small_vassoc_file} --header 1 --rest-extra 1 | $add_function_cmd --in-delim $tab --header 1  --col1 $p_col_disp --val2 \$gc --type gc_correct --val-header P_ADJ --add-at $p_col_disp | $add_function_cmd --in-delim $tab --header 1  --col1 $se_col_disp --val2 \$gc_sqrt --type multiply --val-header SE_ADJ --add-at $se_col_disp | $smart_cut_cmd --in-delim $tab --exclude-col 0,1,'$p_col_disp $se_col_disp' --exact --empty-okay | sed '1 s/P_ADJ/$p_col_disp/' | sed '1 s/SE_ADJ/$se_col_disp/' > !{output,,pheno_testl_clean_small_vassoc_file} class_level pheno_testl skip_if or,not_trait,(and,(or,pheno_qt,min_clean_p_missing:le:0),min_clean_geno:le:0,min_clean_hwe:le:0,!custom_clean_annot_exclude_filters,!apply_gc_correction,!apply_extended_strict_qc,!apply_extended_qc) exskipif 

!|expand@;@shortt;pheno_testl;phenol;projectl;exskipif@;pheno_test;pheno;project;skip_if and,num_var_subsets,test_software:ne:metasoft,test_software:ne:metal@short;pheno_test_variant_subset;pheno_variant_subset;project_variant_subset;skip_if or,!num_var_subsets,test_software:eq:metasoft,test_software:eq:metal| \
local cmd ln_pheno_testl_clean_small_vassoc_file=ln -s !{input,,pheno_testl_small_vassoc_file} !{output,,pheno_testl_clean_small_vassoc_file} class_level pheno_testl run_if and,(or,pheno_qt,min_clean_p_missing:le:0),min_clean_geno:le:0,min_clean_hwe:le:0,!custom_clean_annot_exclude_filters,!extended_clean_annot_exclude_filters,!apply_gc_correction,!apply_extended_strict_qc,!apply_extended_qc exskipif

prop include_dp=scalar default 1

dp_helper=!{raw,,pheno,DP,if_prop=include_dp,allow_empty=1}

prop vassoc_extra_vstats_annot=list default "MQ0"
vassoc_vstats_annot=!{raw,,pheno,HET_AB,unless_prop=no_sample_ab,allow_empty=1} $dp_helper !{prop,,pheno,vassoc_extra_vstats_annot,if_prop=vassoc_extra_vstats_annot,allow_empty=1}

#convert_pph_synonymous_to_na=awk -v OFS="\t" -F "\t" 'NR == 1 {for (i=1;i<=NF;i++) {map[\$i]=i}} NR != 1 && \$map["$pph2_class_annot"] == $pph2_class_synonymous && \$map["$vcf_type_annot"] != "$vcf_type_synonymous_annot" {\$map["$pph2_class_annot"] = "NA"} {print}'

#RIGHT NOW MAY NEED TO ADD THIS TO THE EXECS; SHOULD BE ABLE TO REMOVE ONCE --remove-dup-snps is run
undupify=#| sed 's/^\(\S\S*\)\.[0-9]*\(\s\)/\1\2/' | awk '!a[\\$1] {print} {a[\\$1] = 1}'

glm_max_se=5000
glm_max_or=25000

!!expand:clean_:clean_::! \
local cmd make_pheno_variant_subset_clean_gene_variant_file=rm -f !{output,,pheno_variant_subset_clean_gene_variant_file} && $smart_join_cmd --exec "sed '1 s/^/ID\n/' !{input,,pheno_variant_subset_var_keep_file}" !{input,--file,project_variant_subset_clean_gene_variant_file} --header 1 --in-delim $tab --col 2,4 --extra 2 | awk -F"\t" -v OFS="\t" '{print \$2,\$3,\$4,\$1}' > !{output,,pheno_variant_subset_clean_gene_variant_file} class_level pheno_variant_subset

#helpers for vassoc annot
!|expand:,:phenol,projectl:pheno,project:pheno_variant_subset,pheno_variant_subset| \
get_phenol_clean_gene_variants=$smart_cut_cmd --in-delim $tab !{input,--file,projectl_clean_gene_variant_file} --select-col 1,1,ID --select-col 1,1,'GENE CHROM POS' $undupify --require-col-match --exact

!|expand:,:phenol,projectl:pheno,project:pheno_variant_subset,pheno_variant_subset| \
get_phenol_closest_gene=$smart_cut_cmd --in-delim $tab !{input,--file,projectl_clean_gene_variant_file} --select-col 1,1,ID --select-col 1,1,'ID CHROM POS' $undupify --require-col-match --exact | $add_gene_annot_cmd --keep-outside --header 1 --in-delim $tab --chr-col 2 --pos-col 3 --gene-file !{input,,project_closest_gene_file} --out-delim $tab | $smart_cut_cmd --in-delim $tab --select-col 0,'2 1' | sed '1 s/.*/ID\tCLOSEST_GENE/'

prop extra_vassoc_meta_annot=list

vassoc_meta_fields=$vcf_type_annot $vcf_protein_change_annot !{prop,,pheno,vassoc_meta_annot} !{prop,,pheno,extra_vassoc_meta_annot,if_prop=extra_vassoc_meta_annot,allow_empty=1}

ucfirst_helper=perl -F\\\\t -lane 'if (\\$. > 1) {for (\\$r=1; \\$r<=\\$\\#F; \\$r++) {next if \\$F[\\$r] eq \"$annot_missing_field\"; \\$F[\\$r] =~ tr/[A-Z]/[a-z]/; \\$F[\\$r] = ucfirst(\\$F[\\$r]); \\$F[\\$r] =~ tr/_/ /;}} print join(\"\\t\", @F)'



!|expand:,:phenol,projectl,projectt:pheno,project,project:pheno_variant_subset,project_variant_subset,pheno_variant_subset| \
get_phenol_variant_meta_info=$fill_file_helper(projectl_full_var_annot_file,project_clean_gene_variant_file,$vep_missing_field,1,$clean_gene_variant_id_col,1,1) | $smart_cut_cmd --in-delim $tab --select-col 0,1 --select-col 0,1,'$vassoc_meta_fields' --exact --require-col-match 

!|expand:,:phenol,projectl:pheno,project:pheno_variant_subset,project_variant_subset| \
get_phenol_variant_vstats_meta_info=$smart_cut_cmd --in-delim $vstats_delim --out-delim $tab !{input,--file,projectl_vstats_file} --select-col 1,1,'VAR $vassoc_vstats_annot GENO' --exact --require-col-match $undupify

#!|expand:,:phenol,projectl,phenog:pheno,project,project:pheno_variant_subset,project_variant_subset,pheno_variant_subset| \
#phenol_vstats_meta_cut=$smart_cut_cmd --in-delim $vstats_delim --out-delim $tab !{input;--file;projectl_vstats_file} --select-col 1,1,'VAR $vassoc_vstats_annot GENO' --exact --require-col-match $undupify
#!|expand:,:phenol,projectl,phenog:pheno,project,project:pheno_variant_subset,project_variant_subset,pheno_variant_subset| \
#get_phenol_variant_vstats_meta_info=$fill_file_helper_int(--exec \\"$phenol_vstats_meta_cut\\",$phenol_vstats_meta_cut,!{input::phenog_clean_gene_variant_file},NA,1,4,1,1,\,)

!|expand:,:phenol,projectl:pheno,project:pheno_variant_subset,project_variant_subset| \
get_phenol_var_distance_meta_info=$pseq_qc_plus_all_analysis_cmd_phenol(write-vcf) | cut -f1-3 | grep -v \\\# | awk -v OFS=\"\t\" 'END {print prevv,prevd} {curc = \\$1; curd = \"\"} length(prevp) && curc == prevc {curd = \\$2 - prevp} length(prevd) && length(curd) && curd < prevd {print prevv,curd } length(prevd) && length(curd) && curd >= prevd {print prevv,prevd } length(prevd) && length(curd) == 0 {print prevv,prevd} length(curd) && length(prevd) == 0 {print prevv,curd} prevv && length(curd) == 0 && length(prevd) == 0 {print prevv} { prevd = curd; } {prevp = \\$2; prevc = \\$1; prevv = \\$3;}' | awk 'NF == 1 {print \\$1\"\tNA\"} NF == 2 {print}' | sed '1 s/^/ID\tSNP_DIST\n/'

!|expand:,:phenol,projectl:pheno,project:pheno_variant_subset,project_variant_subset| \
get_phenol_missing_meta_info=$smart_join_cmd --in-delim $tab --exec \"$smart_cut_cmd --in-delim $tab !{input,--file,phenol_multiallelic_frq_file} --select-col 1,1,'id call_rate' --exact | awk -v OFS=\\\"\t\\\" 'NR > 1 {\\\\$2 = 1 - \\\\$2; print}' | sed '1 s/.*/SNP\tF_MISS/'\" --exec \"$smart_cut_cmd !{input,--file,phenol_lmiss_file} --select-col 1,1,'SNP F_MISS' --exact --out-delim $tab\" --header 1 --merge $undupify

!|expand:,:phenol,projectl:pheno,project:pheno_variant_subset,project_variant_subset| \
get_phenol_p_missing_meta_info=$smart_join_cmd --in-delim $tab --exec \"$smart_cut_cmd --in-delim $tab !{input,--file,phenol_multiallelic_group_frq_file} --select-col 1,1,'id pval' --exact | sed 's/\t/\tNA\tNA\t/'\" --exec \"$smart_cut_cmd !{input,--file,phenol_test_missing_file} --select-col 1,1,'SNP F_MISS_A F_MISS_U P' --exact --out-delim $tab\" --merge --header 1 | sed '1 s/.*/SNP\tF_MISSA\tF_MISSU\tP_MISSING/' $undupify


#get_phenol_p_missing_meta_info=$smart_cut_cmd !{input,--file,phenol_test_missing_file} --select-col 1,1,'SNP F_MISS_A F_MISS_U P' --exact --out-delim $tab | sed '1 s/.*/SNP\tF_MISSA\tF_MISSU\tP_MISSING/' $undupify

!|expand:,:phenol,projectl:pheno,project:pheno_variant_subset,project_variant_subset| \
get_phenol_hwe_meta_info=$smart_join_cmd --exec \"awk '\\\\$3 == \\\"AFF\\\" {print \\\\$2,\\\\$NF}' !{input,,phenol_hwe_file}\" --exec \"awk '\\\\$3 == \\\"UNAFF\\\" {print \\\\$2,\\\\$NF}' !{input,,phenol_hwe_file}\" --out-delim $tab --header 1 | sed '1 s/^/SNP\tHWEA\tHWEU\n/' $undupify

add_mafa_mafu=$add_function_cmd --in-delim $tab --header 1 --col1 OBSA --val2 2 --type multiply --val-header OBSA2 | $add_function_cmd --in-delim $tab --header 1 --col1 OBSU --val2 2 --type multiply --val-header OBSU2 | $add_function_cmd --in-delim $tab --header 1 --col1 MINA --col2 OBSA2 --type divide --val-header MAFA --add-after MAF | $add_function_cmd --in-delim $tab --header 1 --col1 MINU --col2 OBSU2 --type divide --val-header MAFU --add-after MAFA | $smart_cut_cmd --in-delim $tab --exclude-col 0,1,'OBSA2 OBSU2' | $format_columns_cmd --in-delim $tab --header 1 --number-format MAFA,%.4g --number-format MAFU,%.4g

!|expand:,:phenol,projectl:pheno,project:pheno_variant_subset,project_variant_subset| \
get_phenol_vassoc_count_info=$smart_join_cmd --in-delim $tab --exec \"$smart_join_cmd --in-delim $tab --header 1 --rest-extra 3 --fill 1 --fill 2 --exec \\\"zcat !{input,,projectl_multiallelic_vcf_file} | fgrep -v \\\\\\\# | cut -f3,4,5 | sed '1 s/.*/VAR\tREF\tALT\tSAMPLES\tFILTER/' | sed '1! s/$/\tNA\tNA/'\\\" --exec \\\"$smart_cut_cmd --in-delim $tab !{input,--file,phenol_multiallelic_frq_file} --select-col 1,1,'id aaf pval' --exact | sed '1 s/.*/VAR\tMAF\tHWE/'\\\" --exec \\\"$smart_cut_cmd --in-delim $tab !{input,--file,phenol_multiallelic_group_frq_file} --select-col 1,1,'id mina minu obsa obsu' --exact | sed '1 s/.*/VAR\tMINA\tMINU\tOBSA\tOBSU\tREFA\tHETA\tHOMA\tREFU\tHETU\tHOMU\tP\tOR/' | sed '1! s/$/\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA/' | $neff_helper\\\"\" --exec \"$smart_cut_cmd --in-delim $tab !{input,--file,phenol_vassoc_counts_file} --select-col 1,1,'VAR REF ALT SAMPLES FILTER MAF HWE MINA MINU NEFF OBSA OBSU REFA HETA HOMA REFU HETU HOMU P OR'  --exact | $parse_out_id\" --header 1 --merge | $add_mafa_mafu $undupify | $add_fisher(P) | $add_fisher(OR)

#KEEP THIS AS EXAMPLE FOR HOW TO MERGE ADD WITH DOM
#min_add_mac=5
#first take common ADD, then DOM, then any SNPs not present in DOM
!|expand:,:phenol,projectl:pheno,project:pheno_variant_subset,project_variant_subset| \
#get_phenol_glm_info=$smart_join_cmd --in-delim $tab --header 1 --merge --exec \"cat !{input,,@1} | $smart_cut_cmd --in-delim $tab --select-col 0,1,'VAR N F BETA SE STAT P' --exact | awk -F\\\"\t\\\" -v OFS=\\\"\t\\\" 'NR > 1 && \\\\$3 > .5 {\\\\$3 = 1 - \\\\$3} {print}' | $add_function_cmd --in-delim $tab --col1 N --col2 F --val2 2 --type multiply --header 1 --val-header MAC | $smart_cut_cmd --in-delim $tab --select-col 0,1,'VAR N BETA SE STAT P' --exact --select-row 0,1 --select-row 0,1,MAC,ge:$min_add_mac | $parse_out_id $undupify | sed '1! s/$/\tADD/' | sed '1 s/$/\tTEST/'\" --exec \"$smart_join_cmd --in-delim $tab --exec \\\"$parse_ref_min_phenol\\\" --exec \\\"$smart_cut_cmd --out-delim $tab !{input,--file,@2} --select-col 1,1,'SNP NMISS BETA STAT P TEST' --select-row 1,1 --select-row 1,1,TEST,DOM --exact | $add_function_cmd --in-delim $tab --header 1 --col1 BETA --col2 STAT --type divide --val-header SE --add-at STAT\\\" --extra 1 --header 1 | $smart_cut_cmd --in-delim $tab --select-col 0,1,'REFMIN VAR NMISS BETA SE STAT P TEST' | awk -F\\\"\t\\\" -v OFS=\\\"\t\\\" 'NR > 1 && \\\\$1 == 1 {\\\\$4 = -\\\\$4; \\\\$6 = -\\\\$6} {print}' | cut -f2-\"  --exec \"cat !{input,,@1} | $smart_cut_cmd --in-delim $tab --select-col 0,1,'VAR N BETA SE STAT P' --exact | $parse_out_id $undupify | sed '1! s/$/\tADD/' | sed '1 s/$/\tTEST/'\" 

#KEEP THESE AS AN EXAMPLE AS TO HOW TO MERGE FISHER WITH GLM
#convert_beta_to_or=| $add_function_cmd --in-delim $tab --header 1 --col1 beta --type exp --val-header OR | $smart_cut_cmd --in-delim $tab --exclude-col 0:1:beta --exact --arg-delim :
#!!expand:,:ftype,fname,varname,pname,sename,orname,naname,addfunctioncmd:\
#glm,phenol_raw_glm_file,VAR,P,SE,OR,NA,:\
#score,phenol_raw_score_file,ID,PrChi,SEbeta,beta,NaN,$convert_beta_to_or! \
#!|expand:,:phenol,projectl:pheno,project:pheno_variant_subset,project_variant_subset| \
#merge_phenol_raw_ftype_vassoc_p=$smart_join_cmd --exec \"$smart_cut_cmd !{input,--file,fname} --in-delim $tab --select-col 1,1,'varname pname sename orname' --select-row 1,1 --select-row 1,1,pname,ne:naname --select-row 1,1,sename,le:$glm_max_se --and-row-all --exact --require-col-match addfunctioncmd | $smart_cut_cmd --in-delim $tab --select-col 0,1,'varname pname OR' | sed 1's/.*/VAR P OR/' | $add_p_type_col($used_logistic_p)\" --exec \"$smart_cut_cmd !{input,--file,phenol_strata_vassoc_file} --in-delim $tab --select-col 1,1,'VAR P OR' --exact --require-col-match | $add_p_type_col($used_pseq_p)\" --merge --header 1 | $parse_out_id | $add_raw(P) | $add_raw(OR) | $add_raw($p_type_col)

#!!expand:,:ftype,fname,fexname,varname,pname,sename,orname,naname,addfunctioncmd:\
#glm,phenol_glm_file,phenol_ex_glm_file,VAR,P,SE,OR,NA,:\
#score,phenol_score_file,phenol_ex_score_file,ID,PrChi,SEbeta,beta,NaN,$convert_beta_to_or! \
#!|expand:,:phenol,projectl:pheno,project:pheno_variant_subset,project_variant_subset| \
#merge_phenol_strata_ftype_vassoc_p=$smart_join_cmd --exec \"$smart_cut_cmd --in-delim $tab --exec \\\"$smart_join_cmd --in-delim $tab --exec \\\\\\\"$pseq_qc_plus_analysis_cmd_phenol_covar($vassoc) $show_id --perm 1 $qt_plinkseq_phenotype_selector | $smart_cut_cmd --in-delim $tab --require-col-match --select-col 0,1,'VAR MINA MINU OBSA OBSU'\\\\\\\" !{input,--file,fname,unless_prop=pheno_qt,allow_empty=1} !{input,--file,fexname,if_prop=pheno_qt,allow_empty=1} --in-delim $tab --header 1 --rest-extra 1\\\" --select-col 1,1,'VAR MINA MINU OBSA OBSU pname sename orname' --select-row 1,1 --select-row 1,1,sename,le:$glm_max_se --select-row 1,1,pname,ne:NaN --and-row-all --exact --require-col-match addfunctioncmd | $smart_cut_cmd --in-delim $tab --exclude-col 0,1,sename --exact | sed 's/\(\s\s*\)pname/\1P/' | sed 's/\(\s\s*\)orname/\1OR/' | $add_p_type_col($used_logistic_p)\" --exec \"$smart_cut_cmd !{input,--file,phenol_strata_vassoc_file} --in-delim $tab --select-col 1,1,'VAR MINA MINU OBSA OBSU P OR' --exact --require-col-match | $add_p_type_col($used_pseq_p)\" --merge --header 1 | $parse_out_id | $adjust_strata_vassoc_p

add_tag=sed '1 s/\(\s\s*\|^\)\(@1\)\(\s\s*\|$\)/\1\2_@2\3/g'
add_glm=$add_tag(@1,GLM)
add_raw=$add_tag(@1,RAW)
add_fisher=$add_tag(@1,FISH)
add_adj=$add_tag(@1,ADJ)

or_col_disp_int=!{raw::@1:${or_col_disp}@2:unless_prop=pheno_qt:allow_empty=1@3}!{raw::@1:${beta_col_disp}@2:if_prop=pheno_qt:allow_empty=1@4}
or_col_disp_pheno=$or_col_disp_int(pheno,,,)
or_col_disp_pheno_test=$or_col_disp_int(pheno_test,_\@test_tag,if_prop=use_for_display:if_prop=use_for_or:limit=1,if_prop=use_for_display:limit=1)

!!expand:,:keytype,colname:non_qt,or_col_disp:qt,beta_col_disp! \
!!expand:pheno_testl:pheno_test:pheno_test_variant_subset! \
get_pheno_testl_keytype_small_vassoc_for_annot=!{raw,,pheno_testl,--exec "$smart_cut_cmd --in-delim $tab --file *pheno_testl_small_vassoc_file --select-col 1\,1 --exact --select-col 1\,1\,'$dir_col_disp $colname $bf_col_disp $p_col_disp' | sed '1 s/\(\s\s*\)\(\S\S*\)/\1\2_\@test_tag/g' ",sort_prop=pheno_test,@1} !{input,pheno_testl_small_vassoc_file,@1}

!|expand:,:keyname,file1,file2,runif\
:non_qt,--exec "$get_phenol_hwe_meta_info",--exec "$get_phenol_p_missing_meta_info",run_if !pheno_qt\
:qt,,,run_if pheno_qt| \
!|expand@;@shortt;phenol;pheno_testl;exskipif@;pheno;pheno_test;num_var_subsets@short;pheno_variant_subset;pheno_test_variant_subset;!num_var_subsets| \
shortt cmd make_phenol_keyname_vassoc_pre_annot_file=$smart_join_cmd \
 --exec "$get_phenol_clean_gene_variants" \
 --exec "$get_phenol_closest_gene" \
 --exec "$get_phenol_variant_meta_info" \
 --exec "$get_phenol_variant_vstats_meta_info" --fill 4 \
 --exec "$get_phenol_var_distance_meta_info" \
 --exec "$get_phenol_missing_meta_info" \
 file1 \
 file2 \
 --exec "$get_phenol_vassoc_count_info" \
 --rest-extra 1 --header 1 --in-delim $tab --ignore-err $plinkseq_okay_err \
 > !{output,,phenol_vassoc_pre_annot_file} !{input,pheno_is_trait_file} class_level phenol runif skip_if or,not_trait,exskipif runif with pheno_testl

!|expand:,:keyname,runif\
:non_qt,run_if !pheno_qt\
:qt,run_if pheno_qt| \
!|expand@%@shortt%phenol%pheno_testl%file1%exskipif@%pheno%pheno_test%$get_pheno_test_keyname_small_vassoc_for_annot(unless_prop=num_var_subsets\,if_prop=test_software:eq:metasoft\,if_prop=test_software:eq:metal\,or_if_prop=1\,allow_empty=1)%pheno_test;num_var_subsets@short%pheno_variant_subset%pheno_test_variant_subset%%!pheno_test;num_var_subsets bsub_batch 10| \
shortt cmd make_phenol_keyname_vassoc_annot_file=$smart_join_cmd \
 !{input,--file,phenol_vassoc_pre_annot_file} \
 $get_pheno_testl_keyname_small_vassoc_for_annot(if_prop=num_var_subsets\,unless_prop=test_software:eq:metal\,unless_prop=test_software:eq:metasoft\,allow_empty=1) \
 file1 \
 --rest-extra 1 --header 1 --in-delim $tab \
 | sed '1 s/^\S\S*/$id_col_disp/' \
 | $add_function_cmd --in-delim $tab --header 1 --col1 MINA --col2 MINU --type add --val-header MAC --add-at MINA \
 > !{output,,phenol_vassoc_annot_file} !{input,pheno_is_trait_file} class_level phenol runif skip_if or,not_trait,exskipif runif with pheno_testl


!|expand:,:keyname,skipif\
:non_qt,skip_if pheno_qt\
:qt,skip_if !pheno_qt| \
short cmd make_cat_pheno_keyname_vassoc_annot_file=$smart_join_cmd --in-delim $tab --header 1 --rest-extra 1 --exec "(head -qn+1 !{input,,pheno_variant_subset_vassoc_annot_file,limit=1,sort_prop=pheno_variant_subset} | head -n1 && tail -qn+2 !{input,,pheno_variant_subset_vassoc_annot_file,sort_prop=pheno_variant_subset}) $fix_overlap_bug(1)"  $get_pheno_test_keyname_small_vassoc_for_annot(unless_prop=num_var_subsets\,if_prop=test_software:eq:metal\,if_prop=test_software:eq:metasoft\,or_if_prop=1\,allow_empty=1) > !{output,,pheno_vassoc_annot_file} class_level pheno run_if and,!not_trait,num_var_subsets,pheno_test;num_var_subsets skipif with pheno_test 


###JASON
#LIST TO CAT
#pheno_test_missing_file
#pheno_hwe_file
#pheno_raw_vassoc_file
#pheno_strata_vassoc_file
#pheno_raw_glm_file
#pheno_plink_glm_file
#pneno_plink_ex_glm_file
#pheno_dom_glm_file
#pheno_glm_file
#pheno_ex_glm_file
#pheno_vassoc_annot_file

short cmd make_pheno_small_vassoc_annot_file=$smart_cut_cmd --in-delim $tab !{input,--file,pheno_vassoc_annot_file} --exact --require-col-match --select-col 1,1,'ID GENE CLOSEST_GENE CHROM POS $vassoc_meta_fields MAF MAC MAFA MAFU OBSA OBSU MINA MINU $or_col_disp_pheno_test !{raw::pheno_test:${p_col_disp}_@test_tag:limit=1}' > !{output,,pheno_small_vassoc_annot_file} class_level pheno skip_if not_trait with pheno_test

local cmd ln_vassoc_clean_annot_file=rm -f !{output,,pheno_vassoc_clean_annot_file} && ln -s !{input,,pheno_vassoc_annot_file} !{output,,pheno_vassoc_clean_annot_file} class_level pheno run_if and,(or,pheno_qt,min_clean_p_missing:le:0),min_clean_geno:le:0,min_clean_hwe:le:0,!custom_clean_annot_exclude_filters,!extended_clean_annot_exclude_filters with pheno_test

prop custom_clean_annot_exclude_filters=list
prop extended_clean_annot_exclude_filters=list

apply_custom_clean_annot_filters=!{raw::@1:| eval `perl -e 'print qq(\@{@2})' | sed 's/\s\s*/\n/g' | sed 's/\($select_and_delim\|^\)/ --exclude-row @3,1,/g' | sed 's/$select_filter_delim/,/g' | sed 's;^;$smart_cut_cmd @4 @5 --tab-delim --and-row-all ;g' | tr '\n' '|' | sed 's/|$//'` @6:if_prop=@2:allow_empty=1}

apply_vassoc_clean_filters=$smart_cut_cmd --select-row 0,1 !{raw;;@1;--select-row 0,1,P_MISSING,ge:\@min_clean_p_missing;unless_prop=pheno_qt;allow_empty=1} --select-row 0,1,F_MISS,lt:`perl -e 'print 1-!{prop,,@1,min_clean_geno}'` --select-row 0,1,HWE,ge:!{prop,,@1,min_clean_hwe} --and-row-all --in-delim $tab $apply_custom_clean_annot_filters(@1,custom_clean_annot_exclude_filters,0,,,) | cut -f1 | tail -n+2 $apply_custom_clean_annot_filters(@1,extended_clean_annot_exclude_filters,1,--file *project_extended_vstats_file,--in-delim \,, | cut -f1 | sort | uniq -d) !{input;project_extended_vstats_file;if_prop=extended_clean_annot_exclude_filters;allow_empty=1}

short cmd make_pheno_vassoc_clean_include_file=cat !{input,,pheno_vassoc_pre_annot_file} | $apply_vassoc_clean_filters(pheno) $extended_qc_filter_helper(pheno) > !{output,,pheno_vassoc_clean_include_file} class_level pheno skip_if or,not_trait,(and,(or,pheno_qt,min_clean_p_missing:le:0),min_clean_geno:le:0,min_clean_hwe:le:0,!custom_clean_annot_exclude_filters,!extended_clean_annot_exclude_filters) with pheno_test

#short cmd make_pheno_vassoc_clean_include_file=$smart_join_cmd --in-delim 1,$tab !{input,--file,pheno_vassoc_pre_annot_file} !{input,--file,pheno_lmiss_file} --header 1 --col 2,2 | $apply_vassoc_clean_filters(pheno) $extended_qc_filter_helper(pheno) > !{output,,pheno_vassoc_clean_include_file} class_level pheno skip_if or,not_trait,(and,(or,pheno_qt,min_clean_p_missing:le:0),min_clean_geno:le:0,min_clean_hwe:le:0,!custom_clean_annot_exclude_filters,!extended_clean_annot_exclude_filters)

short cmd make_pheno_vassoc_clean_annot_file=$smart_join_cmd --in-delim $tab --exec "sed '1 s/^/ID\n/' !{input,,pheno_vassoc_clean_include_file}" !{input,--file,pheno_vassoc_annot_file} --header 1 --rest-extra 1 > !{output,,pheno_vassoc_clean_annot_file} class_level pheno skip_if or,not_trait,(and,(or,pheno_qt,min_clean_p_missing:le:0),min_clean_geno:le:0,min_clean_hwe:le:0,!custom_clean_annot_exclude_filters) with pheno_test

pheno_all_trait_vassoc_helper=$smart_join_cmd --file *pheno_small_vassoc_annot_file --exec \"cat *pheno_vassoc_counts_file | $parse_out_id | $smart_cut_cmd --tab-delim --exclude-col 0,1,'`head -n1 *pheno_small_vassoc_annot_file | cut -f2-`'\" --in-delim $tab --header 1 --extra 2 | $smart_cut_cmd --in-delim $tab --select-col 0,1,'CHROM POS @1 `head -n1 *pheno_small_vassoc_annot_file | rev | cut -f1-2 | rev`' | sed '1 s/\(\S\S*\)/\1_\@disp/g' 

!|expand%;%ctype;extracols;selector;runif%all;;pheno:eq:@related_traits;run_if related_traits%meta;MAF MAC MINA MINU REFA HETA HOMA REFU HETU HOMU;pheno:eq:@meta_trait_inv;run_if meta_trait_inv| \
short cmd make_pheno_ctype_trait_vassoc_annot_file=$smart_join_cmd --in-delim $tab --header 1 --exec "cat !{input,,pheno_small_vassoc_annot_file} | $add_tag($or_col_disp_pheno_test,!{prop\,\,pheno\,disp}) | $add_tag(!{raw::pheno_test:${p_col_disp}_@test_tag:limit=1},!{prop\,\,pheno\,disp}) | $smart_cut_cmd --in-delim $tab --select-col 0,1,'^CHROM$ ^POS$ .'" !{raw;--exec;pheno;"$pheno_all_trait_vassoc_helper(extracols)";all_instances=1;if_prop=selector;if_prop=project:eq:@project} !{input,pheno_small_vassoc_annot_file,all_instances=1,if_prop=selector,if_prop=project:eq:@project} !{input,pheno_vassoc_counts_file,all_instances=1,if_prop=selector,if_prop=project:eq:@project} --col 1 --col 2 --rest-extra 1 | cut -f3- > !{output,,pheno_ctype_trait_vassoc_annot_file} class_level pheno runif rusage_mod $trait_vassoc_annot_mem

fix_overlap_bug=#| awk -F"\t" '!m[\$@1] {m[\$@1]=1; print}'

!|expand:;:vtype;exskipif;exrunif\
:plinkseq_qc_pass_gstats_file;skip_if !do_pheno_gstats;\
:plinkseq_qc_pass_estats_file;skip_if !do_pheno_gstats;\
:plinkseq_qc_pass_ns_gstats_file;skip_if !do_pheno_gstats;\
:plinkseq_qc_pass_ns_estats_file;skip_if !do_pheno_gstats;\
:plinkseq_qc_pass_syn_gstats_file;skip_if !do_pheno_gstats;\
:plinkseq_qc_pass_syn_estats_file;skip_if !do_pheno_gstats;\
:counts_file;;\
:test_missing_file;;\
:hwe_file;;\
:male_hwe_file;;\
:female_hwe_file;;\
:lmiss_file;;\
:frq_file;;\
:sex_frq_file;;\
:multiallelic_frq_file;;\
:multiallelic_group_frq_file;;\
:combined_frq_file;;\
:vassoc_counts_file;;\
:vassoc_pre_annot_file;;\
|\
local cmd make_cat_pheno_vtype=(head -qn+1 !{input,,pheno_variant_subset_vtype,limit=1} | head -n1 && tail -qn+2 !{input,,pheno_variant_subset_vtype}) $fix_overlap_bug(1) !{input,pheno_is_trait_file} > !{output,,pheno_vtype} class_level pheno run_if and,!not_trait,num_var_subsetsexrunif exskipif

!|expand:;:vtype;exskipif\
:variant_qc_strata_vstats_summary_file;\
:variant_qc_pheno_strata_vstats_summary_file;\
|\
local cmd make_cat_pheno_vtype=(head -qn+1 !{input,,pheno_variant_subset_vtype,limit=1} | head -n1 && tail -qn+2 !{input,,pheno_variant_subset_vtype}) $fix_overlap_bug(1) > !{output,,pheno_vtype} class_level pheno run_if num_var_subsets exskipif

!|expand:;:itype;exskipif;exrunif\
:mds_file;;,!pheno_custom_mds_file,recompute_pca,parallelize_pca\
:all_popgen_istats_file;;,parallelize_genome\
:unrelated_popgen_istats_file;;,parallelize_genome\
|\
local cmd make_cat_pheno_itype=(head -qn+1 !{input,,pheno_sample_subset_itype} | tail -n1 && tail -qn+2 !{input,,pheno_sample_subset_itype}) !{input,pheno_is_trait_file} > !{output,,pheno_itype} class_level pheno run_if and,!not_trait,num_samp_subsetsexrunif exskipif


!|expand@;@vtype;exskipif;exrunif\
@vassoc_file;skip_if or,test_software:eq:metal,test_software:eq:metasoft,test_software:eq:mantra;\
@small_vassoc_file;;\
@clean_small_vassoc_file;;\
|\
local cmd make_cat_pheno_test_vtype=(head -qn+1 !{input,,pheno_test_variant_subset_vtype,limit=1} | head -n1 && tail -qn+2 !{input,,pheno_test_variant_subset_vtype}) $fix_overlap_bug(1) !{input,pheno_is_trait_file} > !{output,,pheno_test_vtype} !{input,pheno_is_trait_file} class_level pheno_test run_if and,!not_trait,num_var_subsets,!test_software:eq:metasoft,!test_software:eq:metalexrunif exskipif

!|expand@;@vtype;exskipif;exrunif\
@in_aux2_file;skip_if test_software:ne:mantra;\
@vassoc_file;skip_if test_software:ne:mantra;\
|\
local cmd make_cat_no_head_pheno_test_vtype=cat !{input,,pheno_test_variant_subset_vtype} > !{output,,pheno_test_vtype} !{input,pheno_is_trait_file} class_level pheno_test run_if and,!not_trait,num_var_subsetsexrunif exskipif


sort_name_col_int=awk -F$tab -v OFS=$tab 'NR == 1 {print 1,0,\$0; for (i=1;i<=NF;i++) {m[\$i]=i}} NR > 1 {print @3,\$m["@1"],\$0}' | sort -t$tab -k1,1n -k2,2g@2 | cut -f3-
sort_name_col_with_header=$sort_name_col_int(@1,@2,2)
sort_name_col_no_header=$sort_name_col_int(@1,@2,1)

pheno_process_slide_variants_helper=$smart_cut_cmd --in-delim $tab --select-row 0,1 --select-row 0,1,MAFU,@4 --select-row 0,1,MAFA,@4 | $smart_cut_cmd --in-delim $tab --exact --select-col 0,1,'@1' --require-col-match | $smart_cut_cmd --in-delim $tab --exclude-row 0,1,'@3','^(NA|na|NAN|NaN|nan)$' | $sort_name_col_with_header(@3,@2)


vassoc_max_chars_per_col=20
truncate_cols=perl -lne 'chomp; \@F = split("\t"); foreach (\@F) {if (length > @1) {\$_ = substr(\$_, 0, @1) . "..."}} print join("\t", \@F)'


internal_input_headers=CLOSEST_GENE ID MINA MINU MAFA MAFU $or_col_disp_pheno_test $dp_helper GENO HWE P_MISSING
internal_output_headers1=Gene Variant Counts Counts MAF MAF $or_col_disp_pheno $dp_helper CR HWE P_Miss
internal_output_headers2=Gene Variant Case Ctrl Case Ctrl $or_col_disp_pheno $dp_helper CR HWE P_Miss

#first argument: space separated list of old headers
#second argument: space separated list of new headers
#third argument: row to apply
swap_header=eval `(echo @1 && echo @2) | $transpose_cmd | sed 's;\(\S\S*\)\s\s*\(..*\);sed '\''@3 s/\\\(^\\\|\\\t\\\)\1/\\\1\2/g'\'';' | tr '\n' '|' | sed 's/|$//'` | sed '@3 s/_/ /g'

swap_first_and_duplicate=eval `perl -e 'print "@1\n@2\n"' | $transpose_cmd | sed 's/_/ /g' | sed 's;\(\S\S*\)\s\s*\(..*\);sed '\''s/^\1/\2\t\2/'\'';' | tr '\n' '|' | sed 's/|$//'`

fix_vassoc_annot_disp_headers=sed '1 s/\(.*\)/\1\n\1/' | $swap_header($internal_input_headers !{prop::pheno:vassoc_meta_disp},$internal_output_headers1 !{prop::pheno:vassoc_meta_headers},1) | $swap_header($internal_input_headers !{prop::pheno:vassoc_meta_disp},$internal_output_headers2 !{prop::pheno:vassoc_meta_headers},2)

replace_var_id=sed 's/var_\(\S\S*\)_\(\S\S*\)/\1:\2/'

process_associated_variants_helper=$format_columns_cmd --in-delim $tab --header 1 --number-format MAFA,%.2g --number-format MAFU,%.2g --percentage MAFU --percentage MAFA --number-format ^${or_col_disp_pheno}_,%.1f --number-format ^P_,%.2g --regex-headers @3 | $fix_vassoc_annot_disp_headers | $truncate_cols(@5) | $table_to_beamer_cmd --allow-breaks --multi-row . --force-multi-row-break @6 --multi-col 1-2 --font-size 8pt --auto-dim --bottom-margin 0in --left-margin 0in --right-margin 0in --title "@1" --in-delim $tab --header-rows 2

head_cmd=awk 'NR <= @1'
head_frac_cmd_raw=perl -ne 'BEGIN {\$size = @3`cat !{input,,@1} | wc -l@3`}; print if \$i++ < @2 \* \$size' 
head_frac_cmd_inside=$head_frac_cmd_raw(@1,@2,\)
head_frac_cmd_outside=$head_frac_cmd_raw(@1,@2,)

pheno_select_slide_variants_helper=$smart_cut_cmd !{input,--file,@3} --in-delim $tab --select-row 1,1 --select-row 1,1,$vcf_type_annot,@1 --select-row 1,1,GENE,@2 --and-row-all --select-row 1,1,MAC,ge:@4

pheno_slide_variants_helper=$pheno_select_slide_variants_helper(@1,@3,@8,@10) | $pheno_process_slide_variants_helper(@4,@5,@6,@7,@9)

old_annots=[^\\\t]\*SPLICE_SITE[^\\\t]* [^\\\t]\*$vcf_type_missense_annot $vcf_type_synonymous_annot $vcf_type_nonsense_annot INTRONIC tolerated benign probably.damaging possibly.damaging neutral deleterious unknown FRAMESHIFT_CODING 3PRIME_UTR 5PRIME_UTR STOP_LOST COMPLEX_IN.DEL PARTIAL_CODON CODING_UNKNOWN WITHIN_MATURE_miRNA NMD_TRANSCRIPT WITHIN_NON_CODING_GENE UPSTREAM DOWNSTREAM REGULATORY_REGION TRANSCRIPTION_FACTOR_BINDING_MOTIF INTERGENIC intron.variant splice.acceptor.variant splice.region.variant splice.donor.variant downstream.gene.variant upstream.gene.variant frameshift.variant initiator.codon.variant
new_annots=Splice Mis Syn Stop Intron Tol Ben Prob Pos Neu Del NA Frame 3\\\'_UTR 5\\\'_UTR RdThru Indel ParCod Coding miRNA NMD NonCod Upstream Downstream Reg TFMotif Inter Intron Splice Splice Splice Downstream Upstream Frame Init

translate_variant_type=$swap_header($old_annots !{prop::pheno:old_disp_annots:if_prop=old_disp_annots:allow_empty=1},$new_annots !{prop::pheno:new_disp_annots:if_prop=new_disp_annots:allow_empty=1},1!)

pheno_slide_associated_variants_helper=$pheno_slide_variants_helper(@1,@2,@3,CLOSEST_GENE ID !{prop::burden:vassoc_meta_disp} MINA MINU MAFA MAFU $or_col_disp_pheno_test !{raw::pheno_test:${p_col_disp}_\@test_tag:if_prop=use_for_display},,!{raw::pheno_test:${p_col_disp}_\@test_tag:if_prop=use_for_display:limit=1},@4,@5,,!{prop::burden:min_pheno_mac})

local cmd make_interesting_genes_dat_file=\
  $smart_cut_cmd !{input,--file,burden_interesting_genes_dat_file,if_prop=burden_test,unless_prop=only_for_interesting,allow_empty=1} !{input,--file,burden_interesting_variant_genes_dat_file,unless_prop=only_for_interesting,allow_empty=1} | sort -u \
  | $smart_cut_cmd --exec "perl -e 'print \"!{prop,,pheno,extra_interesting_genes,sep=\n,if_prop=extra_interesting_genes,allow_empty=1}\"'" \
	| sed '/^\s*$/d' \
  | sort -u | awk '\$_ != "$outside_gene_name"' > !{output,,pheno_interesting_genes_dat_file} class_level pheno skip_if not_trait

prop external_id=scalar
prop gene_start=scalar
prop gene_end=scalar

variant_internal_id=!{prop,,pheno}_@1
gene_internal_id=!{prop,,pheno}_@1

annotate_genes_with_region=$add_gene_annot_cmd --no-outside --chr-col 2 --pos-col 3 --gene-file !{input,,project_region_list_file} --out-delim $tab

get_locus_for_gene=$smart_join_cmd !{input,--file,project_gene_target_file} !{input,--file,pheno_interesting_genes_dat_file} --extra 1 --out-delim $tab | cut -f1-3 | $annotate_genes_with_region | cut -f1,2
fix_gene_internal_id=@1 =~ s/\//-/g;

local cmd make_pheno_gene_sort_values_file=m=`cat !{input,,burden_gene_sort_values_file,if_prop=burden_test,unless_prop=only_for_interesting} | cut -f2 | awk 'BEGIN {m=""} {if (m=="" || \$1 > m) {m=\$1}} END {print m}'` && cat !{input,,burden_gene_sort_values_file,if_prop=burden_test,unless_prop=only_for_interesting} | $smart_cut_cmd --out-delim $tab --exec "sed 's/$/\t'\$m'/' !{input,,pheno_interesting_genes_dat_file}" | $table_sum_stats_cmd --in-delim $tab --out-delim $tab --group-col 1 --col 2 --summaries --print-header | $smart_cut_cmd --in-delim $tab --select-col 0,1 --select-col 0,1,$table_sum_stats_min | tail -n+2 > !{output,,pheno_gene_sort_values_file} class_level pheno skip_if not_trait

local cmd make_pheno_variant_subset_gene_to_variant_subset_map=$smart_cut_cmd --in-delim $tab !{input,--file,pheno_variant_subset_clean_gene_variant_file} --select-col 1,1,'GENE' --exclude-row 1,1 | sort -u | sed 's/$/\t!{prop,,pheno_variant_subset}\t!{prop,,project_variant_subset}/' > !{output,,pheno_variant_subset_gene_to_variant_subset_map} class_level pheno_variant_subset skip_if not_trait

local cmd make_pheno_gene_to_variant_subset_map=cat !{input,,pheno_variant_subset_gene_to_variant_subset_map} > !{output,,pheno_gene_to_variant_subset_map} class_level pheno run_if num_var_subsets

local cmd make_pheno_interesting_genes_meta_file=$smart_join_cmd --exec "$smart_join_cmd --in-delim $tab !{input,--file,pheno_interesting_loci_dat_file} --exec \"$get_locus_for_gene\"  --multiple 2 --extra 1 | awk -v OFS=\"\t\" '{print \\$3,\\$1,\\$2}'" !{input,--file,project_gene_target_file} !{input,--file,pheno_interesting_genes_dat_file} !{input,--file,pheno_gene_sort_values_file} !{input,--file,pheno_gene_to_variant_subset_map,if_prop=num_var_subsets,allow_empty=1} --rest-extra 3 --out-delim $tab | perl -ne 'chomp; @a = split("\t"); \$a[3] =~ s/^chr//; \$external_id = \$a[0]; $fix_gene_internal_id(\$a[0]); print "$gene_internal_id(\$a[0]) class gene\n!select:!{prop,,project} $gene_internal_id(\$a[0]) disp \$external_id\n$gene_internal_id(\$a[0]) external_id \$external_id\n!select:!{prop,,project} $gene_internal_id(\$a[0]) parent !{prop,,pheno}_locus_\$a[2]\n!select:!{prop,,project} $gene_internal_id(\$a[0]) chrom \$a[3]\n!select:!{prop,,project} $gene_internal_id(\$a[0]) gene_start \$a[4]\n!select:!{prop,,project} $gene_internal_id(\$a[0]) gene_end \$a[5]\n!select:!{prop,,project} $gene_internal_id(\$a[0]) sort \$a[6]\n"; if (scalar(@a) > 7) {print "!select:!{prop,,project} $gene_internal_id(\$a[0]) consistent \$a[7]\n!select:!{prop,,project} $gene_internal_id(\$a[0]) consistent \$a[8]\n"}' > !{output,,pheno_interesting_genes_meta_file} && $smart_join_cmd --exec "$smart_cut_cmd !{input,--file,project_gene_interesting_transcript_file,if_prop=project_gene_interesting_transcript_file,allow_empty=1} --select-col 1,1 | sort -u | cat - !{input,,pheno_interesting_genes_dat_file} | sort | uniq -d" !{input,--file,project_gene_interesting_transcript_file,if_prop=project_gene_interesting_transcript_file,allow_empty=1} --extra 2 --multiple 2 | sed 's/\(\S\S*\)\s\s*\(\S\S*\)/$gene_internal_id(\1) use_transcripts \2/' >> !{output,,pheno_interesting_genes_meta_file} class_level pheno skip_if not_trait with gene

interesting_region_or_loci_dat_helper=$smart_join_cmd --in-delim $tab --exec "@1" --exec "cat !{input,,project_gene_variant_file} | awk '!map[\\$1] && NR > 1 {map[\\$1] = 1; print}' | $annotate_genes_with_region | awk '!map[\\$2] {map[\\$2] = 1; print}' | awk -v OFS=\"\t\" '{print \\$1,\\$4,\\$2}' | sort -nk1,2 | cut -f1,3 | perl -lane 'chomp; if (\\$last && \\$F[0] ne \\$last) {print \\$string; \\$string = \"\"} \\$string = \"\\$F[0]\" unless \\$string; \\$last = \\$F[0]; \\$string .= \"\t\\$F[1]\"; END {print \\$string}' | awk 'NF > 2 {print \\$1\"\t\"\\$2\"-\"\\$NF} NF <= 2 {print}'" --extra 2

local cmd make_pheno_interesting_loci_dat_file=$interesting_region_or_loci_dat_helper("$get_locus_for_gene | cut -f1 | cat - !{input,,project_region_list_file,if_prop=all_loci_interesting,allow_empty=1} | cut -f1 | sort -u") > !{output,,pheno_interesting_loci_dat_file} class_level pheno skip_if not_trait

local cmd make_pheno_loci_sort_values_file=$smart_join_cmd --in-delim $tab --extra 1 --col 1,2 --exec "cat !{input,,project_gene_variant_file} | awk '!map[\\$1] && NR > 1 {map[\\$1] = 1; print}' | $annotate_genes_with_region | cut -f1-2 | awk '!map[\\$2] {map[\\$2] = 1; print}'" !{input,--file,pheno_gene_sort_values_file} | cut -f2- | $table_sum_stats_cmd --in-delim $tab --out-delim $tab --group-col 1 --col 2 --summaries --print-header | $smart_cut_cmd --in-delim $tab --select-col 0,1 --select-col 0,1,$table_sum_stats_min | tail -n+2 > !{output,,pheno_loci_sort_values_file} class_level pheno skip_if not_trait

prop locus_range=scalar
prop locus_start=scalar
prop locus_end=scalar

get_range=@1:@2-@3

interesting_regions_or_loci_helper=$smart_join_cmd !{input,--file,@3} !{input,--file,project_region_list_file} @6 --extra 2 --in-delim $tab | sort -k1 | perl -lane '\$name = "!{prop,,@2}_@{1}_\$F[1]"; \$chr = \$F[2]; \$ref_chr = \$chr; \$chr =~ s/^chr//; \$start = \$F[3]; \$end = \$F[4]; print "\$name class @1"; print "!select:!{prop,,project} \$name parent !{prop,,@2}"; print "\$name @{1}_range $get_range(\$chr,\$start,\$end)"; print "\$name disp \$F[1]"; print "\$name chrom \$chr"; print "\$name ref_chrom \$ref_chr"; print "\$name @{1}_start \$start"; print "\$name @{1}_end \$end"; @5' > !{output,,@4} 

#all loci should have same sort value; o.w. replace sort 1 with sort \$F[5]
local cmd make_pheno_interesting_loci_meta_file=$interesting_regions_or_loci_helper(locus,pheno,pheno_interesting_loci_dat_file,pheno_interesting_loci_meta_file,print "\$name consistent !{prop\,\,project}_region_\$F[1]\n\$name sort 1",!{input\,--file\,pheno_loci_sort_values_file} --extra 3) class_level pheno skip_if not_trait

prop consequence=scalar
prop proteinchange=scalar
prop pos=scalar
prop ncase=scalar
prop ncontrol=scalar
prop nind=scalar
prop var_annot=scalar


annot_file_for_interesting_variants=pheno_vassoc_annot_file

local cmd make_pheno_interesting_variants_dat_file=$smart_cut_cmd --in-delim $tab !{input,--file,burden_interesting_gene_variants_dat_file,unless_prop=only_for_interesting} !{input,--file,burden_all_interesting_gene_variants_dat_file,if_prop=burden_test,unless_prop=only_for_interesting} | sort -u \
  | $smart_cut_cmd --exec "perl -e 'print \"!{prop,,pheno,extra_interesting_variants,sep=\n,if_prop=extra_interesting_variants,allow_empty=1}\"'" \
  | sort -u \
  | $smart_cut_cmd --in-delim $tab !{input,--file,pheno_vassoc_annot_file} --select-col 1,1,ID --exact --require-col-match \
  | sort | uniq -d > !{output,,pheno_interesting_variants_dat_file} class_level pheno skip_if not_trait

local cmd make_pheno_interesting_variants_reg_file=$smart_join_cmd --in-delim $tab --exec "cat !{input,,pheno_interesting_variants_dat_file} | $add_header_cmd ID" --exec "$smart_cut_cmd --in-delim $tab !{input,--file,project_clean_gene_variant_file} --exclude-row 1,1 --select-col 1,1,'ID CHROM POS' --exact --require-col-match" --header 1 --extra 2 --rest-extra 1 | cut -f2- | sed 's/^chr//' | awk '{print "chr"\$1":"\$2}' > !{output,,pheno_interesting_variants_reg_file} class_level pheno skip_if not_trait

short cmd make_pheno_interesting_variants_pre_meta_file=$smart_join_cmd \ 
  --exec "cat !{input,,pheno_interesting_variants_dat_file} | $add_header_cmd ID"  \
  --exec "$add_header_cmd ID < !{input,,pheno_interesting_variants_dat_file}"  \
  --exec "$smart_cut_cmd !{input,--file,pheno_vassoc_annot_file} --in-delim $tab --select-col 1,1,'ID $vcf_type_annot $vcf_protein_change_annot $col_for_var_annot MINA MINU MAC' --exact --require-col-match" \
	--exec "$smart_cut_cmd !{input,--file,project_clean_gene_variant_file} --in-delim $tab --select-col 1,1,'ID GENE POS'" \
	--in-delim $tab --header 1 --rest-extra 1 --ignore-err $plinkseq_okay_err  \
  | $smart_cut_cmd --in-delim $tab --select-col 0,1,'ID GENE POS $vcf_type_annot $vcf_protein_change_annot $col_for_var_annot MINA MINU MAC' --exact --require-col-match --exclude-row 0,1,GENE,$outside_gene_name --exclude-row 0,1 \
  > !{output,,pheno_interesting_variants_pre_meta_file} !{input,pheno_interesting_genes_meta_file} class_level pheno skip_if not_trait

local cmd make_pheno_interesting_variants_meta_file=cat !{input,,pheno_interesting_variants_pre_meta_file} | perl -ne 'chomp; @a = split("\t"); \$external_id = \$a[0]; \$id = "$variant_internal_id(\$a[0])"; \$gene = \$a[1]; $fix_gene_internal_id(\$gene); \$pos = \$a[2]; \$type = \$a[3]; \$proteinchange = \$a[4]; \$var_annot = \$a[5]; \$ncase = \$a[6]; \$ncontrol = \$a[7]; \$nind = int(\$a[8]); print "\$id class variant\n!select:!{prop,,project}:!{prop,,pheno} \$id parent $gene_internal_id(\$gene)\n\$id external_id \$external_id\n\$id disp \$external_id\n\$id consequence \$type\n\$id proteinchange \$proteinchange\n\$id var_annot \$var_annot\n\$id pos \$pos\n\$id ncase \$ncase\n\$id ncontrol \$ncontrol\n\$id nind \$nind\n" if (\$ncase + \$ncontrol) > 0' > !{output,,pheno_interesting_variants_meta_file} class_level pheno skip_if not_trait

wc_helper_int=wc -l !{input,,@1} @2 | fgrep -v /dev/null | sed 's/^\s*//' | sed 's/\s\s*/\t/' @3
wc_helper_mult=$wc_helper_int(@1,/dev/null,| sed '\\$d')
wc_helper_sing=$wc_helper_int(@1,,)

local cmd make_pheno_interesting_counts_tex_file=let n=`perl -e 'print "!{prop,,burden,unless_prop=only_for_interesting,sep=\n}\n"' | wc -l`+3 && $smart_cut_cmd --in-delim $tab --exec "perl -e 'print \"!{prop,,burden,disp,unless_prop=only_for_interesting,sep=\n}\n\"'" --exec "$wc_helper_mult(burden_interesting_genes_dat_file\\,unless_prop=only_for_interesting\\,if_prop=burden_test)" --exec "$wc_helper_mult(burden_interesting_variant_genes_dat_file\\,unless_prop=only_for_interesting)" --exec "$wc_helper_mult(burden_interesting_gene_variants_dat_file\\,unless_prop=only_for_interesting)" --exec "$wc_helper_mult(burden_all_interesting_gene_variants_dat_file\\,unless_prop=only_for_interesting)" --select-col .,1 --paste | $smart_cut_cmd --stdin-first --in-delim $tab --exec "$smart_cut_cmd --in-delim $tab --exec \"echo Total\" --exec \"$wc_helper_sing(pheno_interesting_genes_dat_file)\" --exec \"$wc_helper_sing(pheno_interesting_genes_dat_file)\" --exec \"$wc_helper_sing(pheno_interesting_variants_dat_file)\" --exec \"$wc_helper_sing(pheno_interesting_variants_dat_file)\" --paste --select-col .,1" | sed '1 s/^/Class\tGenes\tGenes\tVariants\tVariants\nClass\tBurden\tVariants\tP-value\tAll\n/' | $table_to_beamer_cmd --in-delim $tab --header-rows 2 --header-cols 1 --font-size 8pt --footer-rows 1 --multi-row 1,1-2 --multi-col 1,2-3 --multi-col 1,4-5 --multi-col \$n,2-3 --multi-col \$n,4-5 --title "Interesting Gene/Variant Counts" > !{output,,pheno_interesting_counts_tex_file} class_level pheno skip_if not_trait

local cmd make_pheno_interesting_counts_pdf_file=$run_latex_cmd(pheno_interesting_counts_tex_file,pheno_interesting_counts_pdf_file) class_level pheno

#merge a file with excluded id samples having -9 with the sequenced pheno file followed by the marker 

local cmd make_pheno_marker_pheno_file=$smart_join_cmd --exec "$smart_cut_cmd !{input,--file,project_all_marker_assoc_sample_keep_file,unless_prop=pheno_all_marker_assoc_sample_keep_file,allow_empty=1} !{input,--file,project_all_marker_assoc_sample_keep_file,unless_prop=pheno_all_marker_assoc_sample_keep_file,allow_empty=1} !{input,--file,pheno_all_marker_assoc_sample_keep_file,if_prop=pheno_all_marker_assoc_sample_keep_file,allow_empty=1} !{input,--file,pheno_all_marker_assoc_sample_keep_file,if_prop=pheno_all_marker_assoc_sample_keep_file,allow_empty=1} --exec \"tail -n+2 !{input,,project_all_marker_pheno_file,unless_prop=pheno_marker_initial_pheno_file,allow_empty=1} !{input,--file,pheno_marker_initial_pheno_file,if_prop=pheno_marker_initial_pheno_file,allow_empty=1}\" --select-col 1,2 --select-col 2,2 --select-col 3,2 | sort | uniq -u | sed 's/$/ $plink_missing/'" --exec "$smart_join_cmd --in-delim $tab --exec \"$smart_cut_cmd !{input,--file,project_all_marker_pheno_file,unless_prop=pheno_marker_initial_pheno_file,allow_empty=1} !{input,--file,pheno_marker_initial_pheno_file,if_prop=pheno_marker_initial_pheno_file,allow_empty=1} --select-col 1,2 --exclude-row 1,1 --require-col-match --exact | $smart_cut_cmd --in-delim $tab !{input,--file,pheno_sequenced_all_sample_info_file} --select-col 1,1,ID | sort | uniq -d | sed '1 s/^/ID\n/'\" !{input,--file,pheno_sequenced_all_sample_info_file} --extra 2 --header 1 | $smart_cut_cmd --in-delim $tab --select-col 0,1,'ID !{prop,,pheno}'" --exec "$smart_cut_cmd !{input,--file,project_all_marker_pheno_file,unless_prop=pheno_marker_initial_pheno_file,allow_empty=1} !{input,--file,pheno_marker_initial_pheno_file,if_prop=pheno_marker_initial_pheno_file,allow_empty=1} --select-col 1,2 --exclude-row 1,1 --select-col 1,1,!{prop,,pheno} --require-col-match --exact" --merge > !{output,,pheno_marker_pheno_file} class_level pheno skip_if not_trait


!!expand:impute_type:hap:traditional! \
meta_table cmd make_pheno_imputation_impute_type_gene_list_file=!{input,,gene_impute_type_summary_file} !{output,pheno_imputation_impute_type_gene_list_file} class_level pheno skip_if not_trait

meta_table cmd make_pheno_snptest_locus_list_file=!{input,,locus_combined_snptest_out_file} !{output,pheno_snptest_locus_list_file} class_level pheno skip_if not_trait

#!!expand:impute_type:hap:traditional! \
#local cmd make_pheno_imputation_impute_type_summary_file=$smart_join_cmd --in-delim $tab --exec "$smart_cut_cmd !{input,--file,pheno_vassoc_annot_file} --in-delim $tab --select-col 1,1,'ID GENE $vcf_protein_change_annot MINA MINU OBSA OBSU P OR' --exact | $add_function_cmd --header 1 --in-delim $tab --col1 MINA --col2 OBSA --type divide --val-header MAFA --add-at 6 | $add_function_cmd --header 1 --in-delim $tab --col1 MINU --col2 OBSU --type divide --val-header MAFU --add-at 7 | $smart_cut_cmd --in-delim $tab --exclude-col 0,1,'OBSA OBSU'" --exec "(cat !{input,,pheno_imputation_impute_type_gene_list_file} | xargs head -q -n1 | awk 'NR == 1'  && cat !{input,,pheno_imputation_impute_type_gene_list_file} | xargs tail -q -n+2)" --extra 1 --header 1 | $add_function_cmd --in-delim $tab --header 1 --type subtract --col1 OR --val2 1 --val-header CONSISTENT | $add_function_cmd --in-delim $tab --header 1 --type subtract --col1 F_CA_MIN --col2 F_CT_MIN --val-header CONSISTENT2 | awk -v OFS="\t" -F"\t" 'NR > 1 { if (\$NF == "NA" || \$(NF - 1) == "NA") {\$(NF - 1) = "NA"} else if (\$NF * \$(NF - 1) > 0) {\$(NF - 1) ="TRUE"} else {\$(NF - 1)="FALSE"}} {print}' | rev | cut -f2- | rev | $smart_cut_cmd --in-delim $tab --exclude-col 0,1,CHROM --exact > !{output,,pheno_imputation_impute_type_summary_file} !{input,gene_impute_type_summary_file} class_level pheno skip_if or,not_trait,pheno_qt

impute2_info_col=8
impute2_varid_col=2

local cmd make_pheno_snptest_summary_file=(head -q -n1 !{input,,pheno_snptest_locus_list_file} | xargs head -q -n1  && cat !{input,,pheno_snptest_locus_list_file} | xargs tail -q -n+2 | sort -nrk$impute2_info_col | awk 'map[\$2] != 1 {print} {map[\$2] = 1}') !{input,locus_combined_snptest_out_file} > !{output,,pheno_snptest_summary_file} class_level pheno skip_if not_trait

prop do_hap_burden=scalar
#meta_table cmd make_pheno_haplotype_burden_input_list_file=!{prop,,locus,disp} !{input,,locus_index_geno_counts_file} !{input,,locus_strat_index_snp_file} !{input,,locus_top_common_marker_pos_file} !{input,,locus_all_seq_tped_file} !{input,,locus_all_seq_tfam_file} !{input,,locus_all_marker_tped_file} !{input,,locus_all_marker_tfam_file} !{output,pheno_haplotype_burden_input_list_file} class_level pheno run_if do_hap_burden

pheno_slide_failures_tex_helper_int=$smart_join_cmd !{input,--file,project_sample_failure_status_file,if_prop=not_trait,allow_empty=1} !{input,--file,pheno_sample_failure_status_file,unless_prop=not_trait,allow_empty=1} --exec \\\"cat !{input,,pheno_sample_info_header_file} !{input,,pheno_non_missing_sample_info_file} !{input,,pheno_failed_non_missing_sample_info_file}\\\" @2 --extra 1 --header 1 --in-delim $tab --out-delim $tab | $table_sum_stats_cmd --has-header --in-delim $tab --out-delim $tab --summaries --totals --col '@1' @3 --print-header | $smart_cut_cmd --no-vec-delim --in-delim $tab --select-col 0,1 @4 --select-col 0,1,'$summary_tot(@1)' --select-col 0,1,'$summary_mean(@1)' --exclude-row 0,1 --require-col-match | $format_columns_cmd --in-delim $tab --number-format @5,@6 --percentage @5 | sed 's/\t\(\S\S*\)$/\t\(\1\)/'

pheno_slide_failures_tex_helper=$pheno_slide_failures_tex_helper_int(@1,,--group-col $display_col_name,,3,%.1f)

pheno_slide_cross_failures_tex_helper=$pheno_slide_failures_tex_helper_int(@1,!{input\,--file\,pheno_cross_classification_phe_file} --extra 3,--group-col $display_col_name --group-col @2,--select-col 0\,1\,@2,4,%d) | sed 's/\t/:/'

!!expand:;:extrakey;extracolumncmd1;extracolumncmd2;addcols:\
trait;--exec \"$pheno_slide_failures_tex_helper(${popgen_fail_status})\" --exec \"$pheno_slide_failures_tex_helper(${related_fail_status})\";--exec \"$pheno_slide_failures_tex_helper(${covar_pass_status})\" --exec \"$pheno_slide_failures_tex_helper(${cluster_pass_status})\";--col2 8 --col2 10:\
not_trait;;;! \
failures_helper_extrakey=$smart_join_cmd --in-delim $tab --out-delim $tab --multiple 2 --extra 1 \
 !{input,--file,pheno_disp_order_file} \
 --exec "$smart_join_cmd --in-delim $tab --header 1 \
  --exec \"$pheno_slide_failures_tex_helper(${failed_status})\" \
  --exec \"$pheno_slide_failures_tex_helper(${qc_fail_status})\" \
  extracolumncmd1 \
  --exec \"$pheno_slide_failures_tex_helper(${qc_pass_status})\" \
  extracolumncmd2 "\
 | sort -t$tab -nk2 | $smart_cut_cmd --in-delim $tab --exclude-col 0,2 | $add_function_cmd --in-delim $tab --type add --col1 2 --col2 4 --col2 6 addcols --add-at 2 | cut -f3 --complement

!!expand:,:extrakey,extrahelper,extracolumns1,extracolumns2,passstatustype,colemphcol,extrarunif:\
,trait,\t$popgen_fail_status\t$related_fail_status,\t$covar_pass_status\t$cluster_pass_status,popgen,6,skip_if not_trait:\
_not_trait,not_trait,,,qc,5,run_if not_trait! \
local cmd make_pheno_slide_failures_tex_fileextrakey=$failures_helper_extrahelper | sed 's/\t(/ (/g' | sed '1 s/^/Group\t$total_status\t$qc_fail_statusextracolumns1\t$passstatustype_pass_statusextracolumns2\n/' | $table_to_beamer_cmd --allow-breaks --in-delim $tab --header-rows 1 --font-size 8pt --auto-dim --col-emph colemphcol --title "!{prop,,pheno,disp} Sample Status" > !{output,,pheno_slide_failures_tex_file} class_level pheno extrarunif

local cmd make_pheno_slide_failures_pdf_file=$run_latex_cmd(pheno_slide_failures_tex_file,pheno_slide_failures_pdf_file) class_level pheno

!!expand:;:extrakey;extrahelper;extracut;extracolumns;passstatustype;extrarunif:\
;trait;,8,10;\t$popgen_fail_status_long\t$related_fail_status_long;popgen;skip_if not_trait:\
_not_trait;not_trait;;;qc;run_if not_trait! \
local cmd make_pheno_slide_failures_dat_fileextrakey=$failures_helper_extrahelper | cut -f1,4,6extracut | sed '1 s/^/Group\t$qc_fail_status_longextracolumns\t$passstatustype_pass_status_long\n/' | sed '1 s/ /_/g' > !{output,,pheno_slide_failures_dat_file} class_level pheno extrarunif

!!expand:;:extrakey;extrahelper;extracolumns;extrarunif:;trait;\,4\,5;skip_if not_trait:_not_trait;not_trait;;run_if not_trait! \
local cmd make_pheno_slide_failures_bar_pdf_fileextrakey=$draw_bar_plot_cmd(!{input\,\,pheno_slide_failures_dat_file} !{output\,\,pheno_slide_failures_bar_pdf_file} 'Sample Status' 'Num Samples' 2\,3extracolumns 1 sep=$tab subtitle='!{prop\,\,pheno\,disp}') class_level pheno extrarunif

pheno_slide_cross_failures_font_size=8pt

!!expand:;:extrakey;extracut1;extracut2;extracolumns;extraheaders1;extraheaders2;passstatustype;colemphcol;extrarunif\
:;--exec \"$pheno_slide_cross_failures_tex_helper(${popgen_fail_status},\$f)\" --exec \"$pheno_slide_cross_failures_tex_helper(${related_fail_status},\$f)\";--exec \"$pheno_slide_cross_failures_tex_helper(${covar_pass_status},\$f)\" --exec \"$pheno_slide_cross_failures_tex_helper(${cluster_pass_status},\$f)\" ;--col2 9 --col2 11;\t$popgen_fail_status\t$related_fail_status;\t$covar_pass_status\t$cluster_pass_status;popgen;7;skip_if not_trait\
:_not_trait;;;;;;qc;6;run_if not_trait! \
local cmd make_pheno_slide_cross_failures_tex_fileextrakey=$table_to_beamer_cmd --allow-breaks --font-size $pheno_slide_cross_failures_font_size --no-footer --custom-dim 9in,5in --no-body > !{output,,pheno_slide_cross_failures_tex_file} && \
for f in `head -n1 !{input,,pheno_cross_classification_phe_file} | cut -f1 --complement | $smart_cut_cmd --in-delim $tab --exclude-col 0,1,!{prop,,pheno}`; do \
$smart_join_cmd --in-delim $tab --out-delim $tab --extra 1 --multiple 2 \
 !{input,--file,pheno_disp_order_file} \
 --exec "$smart_join_cmd --in-delim $tab --header 1 \
  --exec \"$pheno_slide_cross_failures_tex_helper(${failed_status},\$f)\" \
  --exec \"$pheno_slide_cross_failures_tex_helper(${qc_fail_status},\$f)\" \
  extracut1 \
  --exec \"$pheno_slide_cross_failures_tex_helper(${qc_pass_status},\$f)\" \
  extracut2 \
  | sed 's/:/\t/'"\
 | sort -t$tab -nk2 | $smart_cut_cmd --in-delim $tab --exclude-col 0,2 | $add_function_cmd --in-delim $tab --type add --col1 3 --col2 5 --col2 7 extracolumns --add-at 3 | cut -f4 --complement | sed 's/\t(/ (/g' ; done | sed '1 s/^/Group\tGroup\tTot\t$qc_fail_statusextraheaders1\t$passstatustype_pass_statusextraheaders2\n/' | $table_to_beamer_cmd  --allow-breaks --font-size $pheno_slide_cross_failures_font_size --multi-col 1,1-2 --multi-row 1 --col-emph colemphcol --no-header --no-footer --in-delim $tab --header-rows 1 --header-cols 2 --title "!{prop,,pheno,disp} Sample Status" >> !{output,,pheno_slide_cross_failures_tex_file} && \
$table_to_beamer_cmd --allow-breaks --font-size $pheno_slide_cross_failures_font_size --no-header --no-body >> !{output,,pheno_slide_cross_failures_tex_file} class_level pheno extrarunif

local cmd make_pheno_slide_cross_failures_pdf_file=$run_latex_cmd(pheno_slide_cross_failures_tex_file,pheno_slide_cross_failures_pdf_file) class_level pheno

!!expand:filetype:gassoc:flat_gassoc! \
local cmd make_pheno_filetype_file=(head -q -n1 !{input,,burden_filetype_file,if_prop=burden_test,limit=1} && tail -q -n+2 !{input,,burden_filetype_file,if_prop=burden_test}) > !{output,,pheno_filetype_file} class_level pheno skip_if not_trait

#short cmd make_burden_sample_list_file=$burden_sample_list_helper(gt,burden_sample_list_file) class_level burden run_if or,annot_genes,annot_manual_gene_list_file

#short cmd make_burden_sample_without_list_file=$burden_sample_list_helper(le,burden_sample_without_list_file) class_level burden run_if or,annot_genes,annot_manual_gene_list_file

#local cmd make_burden_pheno_pdf_file=$pheno_pdf_helper(burden,!{prop\\,\\,burden\\,disp} variants) class_level burden run_if or,annot_genes,annot_manual_gene_list_file

!!expand:pathwayburdentype:custom! \
local cmd make_pheno_pathway_pathwayburdentype_gassoc_file=(head -q -n1 !{input,,burden_pathway_pathwayburdentype_gassoc_file,if_prop=burden_test,limit=1} && tail -q -n+2 !{input,,burden_pathway_pathwayburdentype_gassoc_file,if_prop=burden_test}) > !{output,,pheno_pathway_pathwayburdentype_gassoc_file} class_level pheno skip_if or,not_trait run_if burden_test

#burden cmds

burden_include_warning=could not evaluate filter expression

meta_table cmd make_annot_manual_gene_list_file=!{prop,,annot,annot_genes,sep=\n} !{output,annot_manual_gene_list_file} class_level annot run_if annot_genes skip_if annot_manual_gene_list_file

local cmd make_annot_manual_gene_variant_list_file=$smart_join_cmd --in-delim $tab !{input,--file,annot_manual_gene_list_file} --exec "$smart_cut_cmd !{input,--file,project_gene_variant_file,if_prop=use_raw_variants,allow_empty=1} !{input,--file,project_clean_gene_variant_file,unless_prop=use_raw_variants,allow_empty=1} --exclude-row 1,1 --select-col 1,1,'CHROM POS ID' --require-col-match --exact --in-delim $tab | $add_gene_annot_cmd --in-delim $tab --print-multiple --chr-col 1 --pos-col 2 --gene-file !{input,,project_gene_target_file} --out-delim $tab | cut -f1,4" --multiple 2 --extra 2 | cut -f2 > !{output,,annot_manual_gene_variant_list_file} class_level annot run_if or,annot_genes,annot_manual_gene_list_file

get_annot_genes_helper=!{raw,,annot,| cat - *annot_manual_gene_variant_list_file | sort | uniq -d,if_prop=annot_genes,if_prop=annot_manual_gene_list_file,or_if_prop=1,allow_empty=1} !{input,annot_manual_gene_variant_list_file,if_prop=annot_genes,if_prop=annot_manual_gene_list_file,or_if_prop=1,allow_empty=1}

manual_annot_helper=!{raw,,annot,| $smart_cut_cmd --in-delim $tab - --exec 'sort -u *annot_manual_variant_list_file' | sort | uniq -d,if_prop=annot_manual_variant_list_file,allow_empty=1,max=1} !{input,annot_manual_variant_list_file,if_prop=annot_manual_variant_list_file,allow_empty=1,max=1} $get_annot_genes_helper 

annot_variant_list_helper=eval `perl -e 'print qq(!{prop,,annot,annot_mask,sep=\n,if_prop=annot_mask,allow_empty=1})' | sed 's/\($select_and_delim\|^\)/ --select-row 1,1,/g' | sed 's/$select_filter_delim/,/g' | sed 's;^;$smart_cut_cmd !{input,--file,@1} --tab-delim --and-row-all --select-col 1,1 @2;g' | tr '\n' '|' | sed 's/|$//'` | sort -u $manual_annot_helper 

no_annot_variant_list_helper=$smart_cut_cmd !{input,--file,@1} --tab-delim --select-col 1,1 @2 | sort -u $manual_annot_helper

!|expand:;:annotype;exskipif:annot;!annot_mask:no_annot;annot_mask| \
!|expand:;:shortt;projectl;annotl;exrunif:;project;annot;run_if !annot_variant_subset:short;project_variant_subset;annot_variant_subset;run_if annot_variant_subset bsub_batch 10| \
shortt cmd make_annotl_annotype_variant_list_file=$annotype_variant_list_helper(projectl_full_var_annot_file,--exclude-row 1\,1,) > !{output,,annotl_annot_variant_list_file} class_level annotl exrunif run_with annot_variant_subset skip_if or,union_annots,exskipif

short cmd make_burden_only_interesting_variant_list_file=$smart_join_cmd --in-delim $tab --rest-extra 1 --multiple 2 --col 2,4 --exec "$smart_join_cmd --in-delim $tab !{input,--file,pheno_interesting_genes_dat_file} !{input,--file,project_transcript_gene_alias_file} --col 2,2 --extra 2 --multiple 2 | cut -f2 | cat - !{input,,pheno_interesting_genes_dat_file} | sort -u | $smart_cut_cmd --in-delim $tab --exec 'cut -f4 !{input,,annot_locdb_detail_reg_file,max=1} | sort -u' | sort | uniq -d" !{input,--file,annot_locdb_detail_reg_file,max=1} | cut -f5 > !{output,,burden_only_interesting_variant_list_file} class_level burden skip_if or,not_trait,!only_for_interesting

!!expand:,:qc_plus,clean_:qc_plus,clean_:qc_pass,! \
!!expand:;:burdenp;burdenl;projectl;varkeepfile;varkeepprocess;frqfile:burden;burden;project;project_gene_variant_file; | $smart_cut_cmd --tab-delim --select-col 0,1,ID --exclude-row 0,1;pheno_combined_frq_file:annot;annot;project;project_gene_variant_file; | $smart_cut_cmd --tab-delim --select-col 0,1,ID --exclude-row 0,1;project_plinkseq_qc_plus_frq_file:burden;burden_variant_subset;project_variant_subset;pheno_variant_subset_var_keep_file;;pheno_variant_subset_combined_frq_file:annot;annot_variant_subset;project_variant_subset;project_variant_subset_vstats_file; | $smart_cut_cmd --in-delim , --select-col 0,1,VAR --exclude-row 0,1;project_variant_subset_plinkseq_qc_plus_combined_frq_file! \
burdenl_qc_plus_non_annot_helper=pseq_cmd="$pseq_qc_plus_@1(v-matrix)"; mask="@2"; !{raw;;burdenl;eval \$pseq_cmd $show_id \$mask | cut -f1 | tail -n+2 | $parse_out_id;if_prop=burdenp_mac_ub;if_prop=burdenp_mac_lb;or_if_prop=1;allow_empty=1} \
 !{raw;;projectl;cat *varkeepfile varkeepprocess;unless_prop=burdenp_mac_ub;unless_prop=burdenp_mac_lb;allow_empty=1} !{input;varkeepfile;unless_prop=burdenp_mac_ub;unless_prop=burden_macp_lb;allow_empty=1} \
 !{raw;;burdenl;| $smart_cut_cmd --file *frqfile --select-row 1,1,MAF,le:\@burdenp_maf --select-col 1,1,SNP | sort | uniq -d;if_prop=burdenp_maf;unless_prop=burdenp_strat_maf_summary;allow_empty=1} !{input;frqfile;if_prop=burdenp_maf;unless_prop=burdenp_strat_maf_summary;allow_empty=1;instance_level=burdenl} \
 !{raw;;burdenl;| $smart_cut_cmd --in-delim , --file *projectl_plinkseq_qc_plus_strata_frq_summary_file --select-row 1,1,MAF_\@burdenp_strat_maf_summary,le:\@burdenp_maf --select-col 1,1 | sort | uniq -d;if_prop=burdenp_strat_maf_summary;allow_empty=1} !{input;projectl_plinkseq_qc_plus_strata_frq_summary_file;if_prop=burdenp_strat_maf_summary;allow_empty=1;instance_level=burdenl}  | $smart_cut_cmd --in-delim $tab !{input,--file,projectl_clean_gene_variant_file} --exclude-row 1,1 --select-col 1,1,ID | sort | uniq -d

extended_qc_filter_helper=!{raw,,@1,| cat - *project_extended_variant_exclude_file *project_extended_variant_exclude_file | sort | uniq -u,if_prop=apply_extended_qc,allow_empty=1} !{raw,,@1,| cat - *project_extended_strict_variant_exclude_file *project_extended_strict_variant_exclude_file | sort | uniq -u,if_prop=apply_extended_strict_qc,allow_empty=1} !{input,project_extended_strict_variant_exclude_file,if_prop=apply_extended_strict_qc,allow_empty=1} !{input,project_extended_variant_exclude_file,if_prop=apply_extended_qc,allow_empty=1}

!|expand:;:qc_plus;clean_;exrunif:qc_plus;clean_;!use_raw_variants:qc_pass;;use_raw_variants| \
!|expand:,:burdenl,assocpheno:annot,analysis_cmd| \
cmd make_burdenl_qc_plus_non_annot_variant_list_file=$burdenl_qc_plus_non_annot_helper(assocpheno,$raw_burdenl_mask_helper) $extended_qc_filter_helper(annot) | cat - !{input,,annot_variant_exclude_file} !{input,,annot_variant_exclude_file} | sort | uniq -u > !{output,,burdenl_non_annot_variant_list_file} class_level burdenl skip_if or,(and,!burdenl_maf,!burdenl_mac_lb,!burdenl_mac_ub,!apply_extended_qc,!apply_extended_strict_qc),only_for_interesting run_if and,!burdenl_variant_subset,!union_burdenls,exrunif run_with burdenl_variant_subset

!|expand:;:qc_plus;clean_;exrunif:qc_plus;clean_;!use_raw_variants:qc_pass;;use_raw_variants| \
!|expand:,:burdenl,assocpheno:burden,all_assoc_cmd_pheno| \
cmd make_burdenl_qc_plus_non_annot_variant_list_file=$burdenl_qc_plus_non_annot_helper(assocpheno,$raw_burdenl_mask_helper) !{raw,,burden,| cat - *burden_only_interesting_variant_list_file | sort | uniq -d,if_prop=only_for_interesting,allow_empty=1=1} !{input,burden_only_interesting_variant_list_file,if_prop=only_for_interesting,allow_empty=1} > !{output,,burdenl_non_annot_variant_list_file} class_level burdenl skip_if or,(and,!burdenl_maf,!burdenl_mac_lb,!burdenl_mac_ub),!only_for_interesting,union_burdens run_if exrunif run_with burdenl_variant_subset

!|expand:,:burdenl,assocpheno:burden,all_assoc_cmd_pheno| \
cmd make_burdenl_only_interesting_non_annot_variant_list_file=ln -s !{input,,burden_only_interesting_variant_list_file} !{output,,burdenl_non_annot_variant_list_file} class_level burdenl run_if and,!burdenl_maf,!burdenl_mac_lb,!burdenl_mac_ub,only_for_interesting,!union_burdens run_with burdenl_variant_subset

!|expand:;:qc_plus;clean_;exrunif:qc_plus;clean_;!use_raw_variants:qc_pass;;use_raw_variants| \
!|expand@;@ktype;mask;skipif@maf;$raw_burden_mask_helper;skip_if and,!burden_maf,!burden_mac_lb,!burden_mac_ub@expand;;skip_if or,burden_maf,burden_mac_lb,burden_mac_ub,expand_pheno_subsets:eq:1| \
short cmd make_burden_variant_subset_qc_plus_ktype_non_annot_variant_list_file=$burden_variant_subset_qc_plus_non_annot_helper(all_assoc_cmd_pheno_variant_subset,mask) > !{output,,burden_variant_subset_non_annot_variant_list_file} class_level burden_variant_subset skipif run_if and,!union_burdens,exrunif run_with burden_variant_subset bsub_batch 50

!|expand:;:qc_plus;clean_;exrunif:qc_plus;clean_;!use_raw_variants:qc_pass;;use_raw_variants| \
short cmd make_annot_variant_subset_qc_plus_non_annot_variant_list_file=$annot_variant_subset_qc_plus_non_annot_helper(analysis_cmd_project_variant_subset,$raw_annot_mask_helper) $extended_qc_filter_helper(annot) | cat - !{input,,annot_variant_exclude_file} !{input,,annot_variant_exclude_file} | sort | uniq -u > !{output,,annot_variant_subset_non_annot_variant_list_file} class_level annot_variant_subset skip_if and,!annot_maf,!annot_mac_lb,!annot_mac_ub,!apply_extended_qc,!apply_extended_strict_qc run_if and,!union_annots,exrunif run_with annot_variant_subset bsub_batch 50

!|expand@;@shortt;phenol;burdenl;annotl;exskipif;exrunif@;pheno;burden;annot;;!burden_variant_subset@short;pheno_variant_subset;burden_variant_subset;annot_variant_subset;,expand_pheno_subsets:eq:1;burden_variant_subset bsub_batch 50| \
short cmd make_burdenl_all_variant_list_file=cat !{input,,burdenl_non_annot_variant_list_file} !{raw,,annotl,| cat - *annotl_annot_variant_list_file | sort | uniq -d,if_prop=annot_mask,allow_empty=1,max=1} !{input,annotl_annot_variant_list_file,if_prop=annot_mask,allow_empty=1,max=1} > !{output,,burdenl_all_variant_list_file} class_level burdenl run_if and,!union_burdens,exrunif skip_if and,!only_for_interesting,!burden_mac_lb,!burden_mac_ub,!burden_mafexskipif run_with burden_variant_subset

!|expand@;@shortt;phenol;annotl;exskipif;exrunif@;pheno;annot;;!annot_variant_subset@short;pheno_variant_subset;annot_variant_subset;;annot_variant_subset bsub_batch 50| \
short cmd make_annotl_all_variant_list_file=cat !{input,,annotl_non_annot_variant_list_file} | cat - !{input,,annotl_annot_variant_list_file} | sort | uniq -d > !{output,,annotl_all_variant_list_file} class_level annotl run_if and,!union_annots,exrunif skip_if and,!annot_mac_lb,!annot_mac_ub,!annot_maf,!apply_extended_qc,!apply_extended_strict_qcexskipif run_with annot_variant_subset

!|expand@;@shortt;phenol;burdenl;annotl;exrunif;exskipif@;pheno;burden;annot;!burden_variant_subset;@short;pheno_variant_subset;burden_variant_subset;annot_variant_subset;burden_variant_subset;,expand_pheno_subsets:ne:1| \
local cmd ln_burdenl_all_variant_list_file=ln -s !{input,,annotl_all_variant_list_file,max=1} !{output,,burdenl_all_variant_list_file} class_level burdenl run_if and,exrunif skip_if or,only_for_interesting,burden_mac_lb,burden_mac_ub,burden_mafexskipif run_with burden_variant_subset

!|expand:;:annotl;exrunif:annot;!annot_variant_subset:annot_variant_subset;annot_variant_subset| \
local cmd ln_annotl_all_variant_list_file=ln -s !{input,,annotl_annot_variant_list_file} !{output,,annotl_all_variant_list_file} class_level annotl run_if and,exrunif skip_if or,annot_mac_lb,annot_mac_ub,annot_maf,apply_extended_qc,apply_extended_strict_qc run_with annot_variant_subset

bad_regions_regex_helper=$smart_cut_cmd --exec "echo !{prop,,burden_test,bad_regions_for_genes,missing=,sep=\,,if_prop=test_software:eq:pseq,allow_empty=1} | sed 's/,/\n/g'" | awk 'NF > 0' !{raw;;burden_test;| $smart_cut_cmd --exec "awk '{print \"chr\"\\$1\":\"\\$2}' *burden_chr_pos_exclude_file";if_prop=burden_chr_pos_exclude_file;allow_empty=1} !{input,burden_chr_pos_exclude_file,if_prop=burden_chr_pos_exclude_file,allow_empty=1} | sed 's/chrchr/chr/' | sort -u

!|expand:;:projectl;phenol;clean_gene_variant_file;burdenl;exskipif;excons:\
project;pheno;project_clean_gene_variant_file;burden;burden_variant_subset;:\
project_variant_subset;pheno_variant_subset;pheno_variant_subset_clean_gene_variant_file;burden_variant_subset;!burden_variant_subset;consistent_prop var_subset_num bsub_batch 20| \
!|expand%;%hwetype;hwefiles;hweskipif%\
my_hwe_pheno;!{input,--file,phenol_hwe_file};phenos_for_p_hwe%\
other_hwe_phenos;!{input,--file,phenol_hwe_file,all_instances=1,if_prop=project:eq:@project,if_prop=pheno:eq:@phenos_for_p_hwe,instance_level=phenol};!phenos_for_p_hwe| \
short cmd make_burdenl_hwetype_idex_file=$smart_cut_cmd --out-delim $tab !{input,--file,phenol_test_missing_file,unless_prop=pheno_qt,allow_empty=1} !{raw;;pheno;--select-col 1,1,'SNP P' --and-row-all --select-row 1,1 --select-row 1,1,P,le:;unless_prop=pheno_qt;allow_empty=1}!{prop,,burden,min_test_p_missing,missing=0,unless_prop=pheno_qt,allow_empty=1} !{raw,--file,burden,/dev/null,if_prop=pheno_qt,allow_empty=1} --exec "$smart_cut_cmd --in-delim $tab hwefiles --exclude-row .,1 | $smart_cut_cmd !{input,--file,phenol_hwe_file} --select-row 1,1" --select-row 2,1,TEST,eq:ALL --select-col 2,1,'SNP P' --select-row 2,1,P,le:!{prop,,burden,min_test_p_hwe,missing=0} --exclude-row 2,1 !{input,--file,phenol_lmiss_file} --select-col 3,1,'SNP F_MISS' --exclude-row 3,1 --select-row 3,1,F_MISS,ge:!{prop,,burden,max_assoc_null,missing=1} !{raw::burden:| eval `perl -e 'print qq(@custom_burden_test_exclude_filters)' | sed 's/\s\s*/\n/g' | sed 's/\($select_and_delim\|^\)/ --exclude-row 1,1 --select-row 1,1,/g' | sed 's/$select_filter_delim/,/g' | sed 's;^;$smart_cut_cmd --file *projectl_extended_vstats_file --in-delim $vstats_delim --and-row-all --select-col 1,1 --select-col 1,2 ;g' | tr '\n' '|' | sed 's/|$//'` | awk -F"\t" -v OFS\="\t" 'NF \=\= 1 {sub(/$vstats_delim/,"\t",\$0)} {print \$0}':if_prop=custom_burden_test_exclude_filters:allow_empty=1} !{input,projectl_extended_vstats_file,if_prop=custom_burden_test_exclude_filters,allow_empty=1,instance_level=burden} > !{output,,burdenl_idex_file} class_level burdenl skip_if or,exskipif,hweskipif run_if or,min_test_p_missing,min_test_p_hwe,max_assoc_null,custom_burden_test_exclude_filters,burden_chr_pos_exclude_file run_with burden_variant_subset excons

!|expand:;:projectl;phenol;clngnvfile;gnvfile;burdenl;exskipif;excons:\
project;pheno;project_clean_gene_variant_file;project_gene_variant_file;burden;burden_variant_subset;:\
project_variant_subset;pheno_variant_subset;pheno_variant_subset_clean_gene_variant_file;pheno_variant_subset_gene_variant_file;burden_variant_subset;!burden_variant_subset;consistent_prop var_subset_num bsub_batch 20| \
short cmd make_burdenl_regex_file=$smart_join_cmd --in-delim $tab --exec "$smart_cut_cmd --in-delim $tab !{input,--file,gnvfile,if_prop=use_raw_variants,allow_empty=1} !{input,--file,clngnvfile,unless_prop=use_raw_variants,allow_empty=1} --select-col 1,1,ID | tail -n+2 | cat - !{input,,burdenl_idex_file}  | cut -f1 | sort | uniq -d" --exec "$smart_cut_cmd --in-delim $tab !{input,--file,gnvfile,if_prop=use_raw_variants,allow_empty=1} !{input,--file,clngnvfile,unless_prop=use_raw_variants,allow_empty=1} --select-col 1,1,'ID CHROM POS' --exclude-row 1,1" !{input,--file,burdenl_idex_file} --rest-extra 1 --multiple 3 | tail -n+2 | cut -f2-3 | sort -u | sed 's/^/chr/' | awk '{print \$1":"\$2}' | $bad_regions_regex_helper > !{output,,burdenl_regex_file} class_level burdenl skip_if exskipif run_if or,min_test_p_missing,min_test_p_hwe,max_assoc_null,custom_burden_test_exclude_filters,burden_chr_pos_exclude_file run_with burden_variant_subset excons

local cmd make_burden_clean_variant_list_file=cut -f1 !{input,,pheno_vassoc_clean_annot_file} | cat - !{input,,burden_all_variant_list_file} | sort | uniq -d > !{output,,burden_clean_variant_list_file} class_level burden

#First get the annot transcripts
#Then get all variants, annotated by gene (NA transcripts)
#Then intersect with non annot


!|expand:;:annotype:annot:no_annot| \
!|expand:;:projectl:project:project_variant_subset| \
projectl_annotype_locdb_detail_reg_helper=$smart_join_cmd --in-delim $tab --extra 1 --multiple 2 --exec "$smart_cut_cmd --in-delim $tab !{input,--file,projectl_gene_variant_file,if_prop=use_raw_variants,allow_empty=1} !{input,--file,projectl_clean_gene_variant_file,unless_prop=use_raw_variants,allow_empty=1}  --select-col 1,1,'ID CHROM POS' --exclude-row 1,1" --exec "$smart_cut_cmd --in-delim $tab --exec \"$annotype_variant_list_helper(projectl_full_annot_file,--select-row 1\,1\,$vep_ccds_annot\,ne:$annot_missing_field --select-col 1\,2,\\\) | $smart_cut_cmd --in-delim $tab --exec \\\"cut -f1 !{input,,project_transcript_target_file} | sed 's/\(.*\)\..*$/\1/'\\\" | awk -F$tab -v OFS=$tab 'NF == 1 {m[\\\\$1]=1} NF > 1 && m[\\\\$2] {print}' | cat !{input,,@1} - | awk -F$tab -v OFS=$tab 'NF == 1 {m[\\\\$1]=1} NF > 1 && m[\\\\$1] {print}'\" --exec \"$smart_join_cmd --rest-extra 1 --exec \\\"$smart_cut_cmd --in-delim $tab !{input,--file,projectl_gene_variant_file,if_prop=use_raw_variants,allow_empty=1} !{input,--file,projectl_clean_gene_variant_file,unless_prop=use_raw_variants,allow_empty=1} !{input,--file,@1} --exclude-row 1,1 --select-col 1,1,ID | sort | uniq -d\\\"  --exec \\\"$smart_cut_cmd --in-delim $tab !{input,--file,projectl_gene_variant_file,if_prop=use_raw_variants,allow_empty=1} !{input,--file,projectl_clean_gene_variant_file,unless_prop=use_raw_variants,allow_empty=1} --exclude-row 1,1 --select-col 1,1,'ID CHROM POS GENE' --exact --require-col-match\\\"\" --select-col 1,'1 2' --select-col 2,'1 4' | $smart_cut_cmd --in-delim $tab --exec \"$smart_cut_cmd --in-delim $tab !{input,--file,projectl_gene_variant_file,if_prop=use_raw_variants,allow_empty=1} !{input,--file,projectl_clean_gene_variant_file,unless_prop=use_raw_variants,allow_empty=1} --select-col 1,1,ID --exclude-row 1,1 @2 | sort | uniq -d\" | awk -F$tab -v OFS=$tab 'NF == 1 {m[\\$1]=1} NF > 1 && m[\\$1] {print}'" | awk -F"\t" -v OFS="\t" 'NR == 1 {print "\\\#CHR","POS1","POS2","ID","VAR"} \$4 != "$outside_gene_name" {print \$2,\$3,\$3,\$4,\$1}' | sed '1! s/^/chr/' | sed '1! s/chrchr/chr/'

!|expand:;:annotl;projectl;exrunif:annot;project;run_if !annot_variant_subset:annot_variant_subset;project_variant_subset;run_if annot_variant_subset bsub_batch 20| \
short cmd make_annotl_no_maf_locdb_detail_reg_file=$projectl_annot_locdb_detail_reg_helper(annotl_all_variant_list_file,| $smart_cut_cmd --in-delim $tab !{input:--file:projectl_gene_variant_file:if_prop=use_raw_variants:allow_empty=1} !{input:--file:projectl_clean_gene_variant_file:unless_prop=use_raw_variants:allow_empty=1} --select-col 1\,1\,ID --exclude-row 1\,1) > !{output,,annotl_locdb_detail_reg_file} class_level annotl exrunif run_with annot_variant_subset skip_if or,annot_mac_lb,annot_mac_ub,annot_maf,union_annots

!|expand:;:annotl;projectl;exrunif:annot;project;!annot_variant_subset:annot_variant_subset;project_variant_subset;annot_variant_subset bsub_batch 20| \
short cmd make_annotl_locdb_detail_reg_file=$projectl_annot_locdb_detail_reg_helper(annotl_all_variant_list_file,!{input:--file:annotl_non_annot_variant_list_file}) > !{output,,annotl_locdb_detail_reg_file} class_level annotl run_if and,!union_annots,exrunif run_with annot_variant_subset skip_if and,!annot_mac_lb,!annot_mac_ub,!annot_maf

!|expand@;@burdenl;projectl;exrunif;ifskip@burden;project;run_if !burden_variant_subset;@burden_variant_subset;project_variant_subset;run_if and,burden_variant_subset bsub_batch 20;,expand_pheno_subsets:eq:1| \
short cmd make_burdenl_no_annot_locdb_detail_reg_file=$projectl_no_annot_locdb_detail_reg_helper(burdenl_all_variant_list_file,!{input:--file:burdenl_non_annot_variant_list_file}) > !{output,,burdenl_locdb_detail_reg_file} class_level burdenl exrunif skip_if or,(and,!only_for_interesting,!burden_mac_lb,!burden_mac_ub,!burden_mafifskip),annot_mask,union_burdens run_with burden_variant_subset

!|expand@;@burdenl;annotl;projectl;exrunif;ifskip@burden;annot;project;run_if !burden_variant_subset;@burden_variant_subset;annot_variant_subset;project_variant_subset;run_if and,burden_variant_subset bsub_batch 20;,expand_pheno_subsets:eq:1| \
short cmd make_burdenl_annot_locdb_detail_reg_file=$smart_join_cmd --in-delim $tab --exec "tail -n+2 !{input,,annotl_locdb_detail_reg_file,max=1} | cut -f5 | sort -u | sort - !{input,,burdenl_all_variant_list_file} | uniq -d | sed '1 s/^/VAR\n/'" !{input,--file,annotl_locdb_detail_reg_file,max=1} --header 1 --multiple 2 --rest-extra 1 --col 2,5 | awk -F"\t" -v OFS="\t" '{print \$2,\$3,\$4,\$5,\$1}' > !{output,,burdenl_locdb_detail_reg_file} class_level burdenl exrunif skip_if or,(and,!only_for_interesting,!burden_mac_lb,!burden_mac_ub,!burden_mafifskip),!annot_mask,union_burdens run_with burden_variant_subset

!|expand@;@burdenl;annotl;exrunif;exskipif@burden;annot;run_if !burden_variant_subset;@burden_variant_subset;annot_variant_subset;run_if burden_variant_subset;,expand_pheno_subsets:ne:1| \
local cmd ln_burdenl_locdb_detail_reg_file=ln -s !{input,,annotl_locdb_detail_reg_file,max=1} !{output,,burdenl_locdb_detail_reg_file} class_level burdenl exrunif skip_if or,only_for_interesting,burden_mac_lb,burden_mac_ub,burden_mafexskipif run_with burden_variant_subset

#if you don't have annot_mask, and you don't have any freq masks, nothing will run

!|expand:;:burdenl;shortt:burden;short:burden_variant_subset;local| \
shortt cmd make_burdenl_locdb_reg_file=cut -f1-4 !{input,,burdenl_locdb_detail_reg_file} > !{output,,burdenl_locdb_reg_file} class_level burdenl

!|expand:;:burdenl;shortt:burden;short:burden_variant_subset;local| \
shortt cmd make_burdenl_reg_file=cut -f1-2 !{input,,burdenl_locdb_detail_reg_file} | tail -n+2 | sed 's/\s\s*/:/' > !{output,,burdenl_reg_file} class_level burdenl

#NEED TO FIX
#1) BROKEN SYNTAC (so many quotes)
#2) Need To DOUBLE PRINT THE EXCLUSIONS

!!expand:,:burdenl,projectl:burden,project:burden_variant_subset,project_variant_subset! \
burdenl_epacts_group_filter=$smart_cut_cmd --in-delim $tab --exec \"$smart_join_cmd --in-delim $tab --exec 'cat !{input,,burden_chr_pos_exclude_file,if_prop=burden_chr_pos_exclude_file,allow_empty=1} !{input,,burdenl_regex_file,if_prop=min_test_p_missing,if_prop=min_test_p_hwe,if_prop=max_assoc_null,if_prop=custom_burden_test_exclude_filters,or_if_prop=1,allow_empty=1} /dev/null | sed \\\"s/:/\t/\\\" | awk \\\"NF == 2\\\" | sed \\\"s/\s\s*/\t/g\\\" | sed \\\"s/^chr//\\\" | sort -u | $smart_cut_cmd --tab-delim !{input,--file,projectl_gene_variant_file,if_prop=use_raw_variants,allow_empty=1} !{input,--file,projectl_clean_gene_variant_file,unless_prop=use_raw_variants,allow_empty=1} --exclude-row 1,1 --select-col 1,1,CHROM --select-col 1,1,POS | sed \\\"s/^chr//\\\" | sort | uniq -d' --exec \\\"$smart_cut_cmd --tab-delim !{input,--file,projectl_gene_variant_file,if_prop=use_raw_variants,allow_empty=1} !{input,--file,projectl_clean_gene_variant_file,unless_prop=use_raw_variants,allow_empty=1} --exclude-row 1,1 --select-col 1,1,CHROM --select-col 1,1,POS --select-col 1,1,ID | sed 's/^chr//'\\\" --col 1 --col 2 --extra 2 --multiple 2 | cut -f3 | sed 's/\(\S\S*\)/\1\n\1/'\" | sort | uniq -u

group_flatten=awk -F"\t" -v OFS="\t" 'NR > 1 && g != \$2 {print g,v;v=""} {g=\$2;v=v" "\$1} END {print g,v}' | sed 's/\t /\t/'

prop burden_max_variants_per_epacts_group=scalar

!!expand:burdent:burden:annot! \
burdent_epacts_group_max_variants_filterer=awk -F"\t" '{split(\$2, a, " "); if (length(a) <= !{prop,,burdent,burden_max_variants_per_epacts_group}) {print}}'

!@expand%;%classl;parentp;burdenl;projectl;extraselect;exrunif;exskipif\
%annot;annot;annot;project;;!annot_variant_subset;\
%annot_variant_subset;annot;annot_variant_subset;project_variant_subset;;annot_variant_subset;bsub_batch 20\
%burden;burden;burden;project;| $burden_epacts_group_filter;!burden_variant_subset;skip_if and,!burden_mac_lb,!burden_mac_ub,!burden_maf,!min_test_p_missing,!min_test_p_hwe,!max_assoc_null,!custom_burden_test_exclude_filters,!burden_chr_pos_exclude_file\
%burden_variant_subset;burden;burden_variant_subset;project_variant_subset;| cat - !{input,,pheno_variant_subset_var_keep_file} | sort | uniq -d | $burden_variant_subset_epacts_group_filter;burden_variant_subset;skip_if and,!burden_mac_lb,!burden_mac_ub,!burden_maf,!min_test_p_missing,!min_test_p_hwe,!max_assoc_null,!custom_burden_test_exclude_filters,!burden_chr_pos_exclude_file,expand_pheno_subsets:eq:1\
@ \
short cmd make_classl_epacts_group_file=$smart_join_cmd --in-delim $tab --exec "tail -n+2 !{input,,burdenl_locdb_detail_reg_file} | cut -f5 | sort -u extraselect" --exec "$smart_join_cmd --in-delim $tab --merge --col 3 --exec \"cat !{input,,projectl_clean_all_variant_site_vcf_file,unless_prop=use_raw_variants,allow_empty=1,instance_level=classl} !{input,,projectl_variant_site_vcf_file,if_prop=use_raw_variants,allow_empty=1,instance_level=classl} | fgrep -v '\\#' | cut -f1-5\" --exec \"cat !{input,,projectl_vfreq_file} | $parse_out_id | $smart_cut_cmd --in-delim $tab --exclude-row 0,1 --select-col 0,1,'CHR POS VAR REF ALT' --exact --require-col-match\" | awk -F$tab -v OFS=$tab '{t=\\$1; \\$1=\\$2; \\$2=\\$3; \\$3=t} {print}'" --exec "tail -n+2 !{input,,burdenl_locdb_detail_reg_file} | cut -f4,5" --rest-extra 1 --multiple 3 --col 2,3 --col 3,2 | cut -f2- | sort -k 5,5 -k 1,1n -k 2,2n | awk -F"\t" -v OFS="\t" '{print \$1":"\$2"_"\$3"/"\$4,\$5}' | $group_flatten | sed 's/\t /\t/' | $parentp_epacts_group_max_variants_filterer > !{output,,classl_epacts_group_file} class_level classl run_with burden_variant_subset,burden_test_variant_subset exskipif run_if and,!union_parentps,exrunif

!|expand%;%burdenl;annotl;exrunif;exskipif%burden;annot;run_if !burden_variant_subset;%burden_variant_subset;annot_variant_subset;run_if burden_variant_subset;,expand_pheno_subsets:ne:1| \
local cmd ln_burdenl_epacts_group_file=ln -s !{input,,annotl_epacts_group_file,max=1} !{output,,burdenl_epacts_group_file} class_level burdenl exrunif skip_if or,burden_max_variants_per_epacts_group,burden_mac_lb,burden_mac_ub,burden_maf,min_test_p_missing,min_test_p_hwe,max_assoc_null,custom_burden_test_exclude_filters,burden_chr_pos_exclude_fileexskipif

!|expand%;%burdenl;annotl;exrunif;exskipif%burden;annot;run_if !burden_variant_subset;%burden_variant_subset;annot_variant_subset;run_if burden_variant_subset;,expand_pheno_subsets:ne:1| \
local cmd cap_burdenl_epacts_group_file=cat !{input,,annotl_epacts_group_file,max=1} | $burden_epacts_group_max_variants_filterer > !{output,,burdenl_epacts_group_file} class_level burdenl exrunif skip_if or,!burden_max_variants_per_epacts_group,burden_mac_lb,burden_mac_ub,burden_maf,min_test_p_missing,min_test_p_hwe,max_assoc_null,custom_burden_test_exclude_filters,burden_chr_pos_exclude_fileexskipif

!@expand%;%classl;parentp;burdenl;projectl;extraselect;exrunif;exskipif\
%annot;annot;annot;project;;!annot_variant_subset;\
%annot_variant_subset;annot;annot_variant_subset;project_variant_subset;;annot_variant_subset;bsub_batch 20\
%burden;burden;burden;project;| $burden_epacts_group_filter;!burden_variant_subset;skip_if and,!burden_mac_lb,!burden_mac_ub,!burden_maf,!min_test_p_missing,!min_test_p_hwe,!max_assoc_null,!custom_burden_test_exclude_filters,!burden_chr_pos_exclude_file\
%burden_variant_subset;burden;burden_variant_subset;project_variant_subset;| cat - !{input,,pheno_variant_subset_var_keep_file} | sort | uniq -d | $burden_variant_subset_epacts_group_filter;burden_variant_subset;skip_if and,!burden_mac_lb,!burden_mac_ub,!burden_maf,!min_test_p_missing,!min_test_p_hwe,!max_assoc_null,!custom_burden_test_exclude_filters,!burden_chr_pos_exclude_file,expand_pheno_subsets:eq:1\
@ \
short cmd make_classl_setid_file=$smart_join_cmd --in-delim $tab --exec "tail -n+2 !{input,,burdenl_locdb_detail_reg_file} | cut -f5 | sort -u extraselect" --exec "tail -n+2 !{input,,burdenl_locdb_detail_reg_file} | cut -f4,5" --rest-extra 1 --multiple 2 --col 2,2 | awk -v OFS="\t" -F"\t" '{print \$2,\$1}' > !{output,,classl_setid_file} class_level classl run_with burden_variant_subset,burden_test_variant_subset exskipif run_if and,!union_parentps,exrunif

!|expand%;%burdenl;annotl;exrunif;exskipif%burden;annot;run_if !burden_variant_subset;%burden_variant_subset;annot_variant_subset;run_if burden_variant_subset;,expand_pheno_subsets:ne:1| \
local cmd ln_burdenl_setid_file=ln -s !{input,,annotl_setid_file,max=1} !{output,,burdenl_setid_file} class_level burdenl exrunif skip_if or,burden_mac_lb,burden_mac_ub,burden_maf,min_test_p_missing,min_test_p_hwe,max_assoc_null,custom_burden_test_exclude_filters,burden_chr_pos_exclude_file,expand_pheno_subsets:ne:1

!!expand%;%shortt;annotl;exskipif;exif;ifprop;consistentprop%short;annot;or,annot_variant_subset,;;;%local;annot_variant_subset;;;,if_prop=var_subset_num:eq:@var_subset_num;consistent_prop var_subset_num! \
!!expand%;%atype;sortkey;runif\
%all_variant_list_file;1;run_if or,annot_mac_lb,annot_mac_ub,annot_maf,apply_extended_qc,apply_extended_strict_qcexif\
%annot_variant_list_file;1;\
%non_annot_variant_list_file;1;\
%setid_file;2;\
!\
shortt cmd make_union_annotl_atype=sort -ksortkey !{input,,annotl_atype,all_instances=1,if_prop=project:eq:@project,if_prop=annot:eq:@union_annotsifprop} | uniq > !{output,,annotl_atype} class_level annotl skip_if exskipif!union_annots runif consistentprop run_with annot_variant_subset

!!expand%;%shortt;burdenl;exskipif;exif;ifprop;consistentprop%short;burden;or,burden_variant_subset,;;;%local;burden_variant_subset;;,expand_pheno_subsets:ne:1;,if_prop=var_subset_num:eq:@var_subset_num;consistent_prop var_subset_num! \
!!expand%;%atype;sortkey;runif\
%all_variant_list_file;1;run_if or,only_for_interesting,burden_mac_lb,burden_mac_ub,burden_mafexif\
%non_annot_variant_list_file;1;\
%setid_file;2;run_if or,burden_mac_lb,burden_mac_ub,burden_maf,min_test_p_missing,min_test_p_hwe,max_assoc_null,custom_burden_test_exclude_filters,burden_chr_pos_exclude_fileexif\
!\
shortt cmd make_union_burdenl_atype=sort -ksortkey !{input,,burdenl_atype,all_instances=1,if_prop=project:eq:@project,if_prop=burden:eq:@union_burdensifprop} | uniq > !{output,,burdenl_atype} class_level burdenl skip_if exskipif!union_burdens runif consistentprop


!!expand%;%shortt;burdenl;burdenp;exskipif;runif;ifprop;consistentprop\
%short;burden;burden;or,burden_variant_subset,;run_if or,burden_mac_lb,burden_mac_ub,burden_maf,min_test_p_missing,min_test_p_hwe,max_assoc_null,custom_burden_test_exclude_filters,burden_chr_pos_exclude_file;;\
%local;burden_variant_subset;burden;;run_if or,burden_mac_lb,burden_mac_ub,burden_maf,min_test_p_missing,min_test_p_hwe,max_assoc_null,custom_burden_test_exclude_filters,burden_chr_pos_exclude_file,expand_pheno_subsets:ne:1;,if_prop=var_subset_num:eq:@var_subset_num;consistent_prop var_subset_num\
%short;annot;annot;or,annot_variant_subset,;;;\
%local;annot_variant_subset;annot;;;,if_prop=var_subset_num:eq:@var_subset_num;consistent_prop var_subset_num! \
!!expand%;%atype;sortkey\
%locdb_detail_reg_file;5\
!\
shortt cmd make_union_header_burdenl_atype=(head -qn1 !{input,,burdenl_atype,all_instances=1,limit=1,if_prop=project:eq:@project,if_prop=burdenp:eq:@union_burdenpsifprop} && tail -qn+2 !{input,,burdenl_atype,all_instances=1,if_prop=project:eq:@project,if_prop=burdenp:eq:@union_burdenpsifprop} | sort -ksortkey) | uniq > !{output,,burdenl_atype} class_level burdenl skip_if exskipif!union_burdenps runif consistentprop

!!expand%;%shortt;burdenl;burdenp;exskipif;runif;ifprop;consistentprop\
%short;burden;burden;or,burden_variant_subset,;run_if or,only_for_interesting,burden_mac_lb,burden_mac_ub,burden_maf;;\
%local;burden_variant_subset;burden;;run_if or,only_for_interesting,burden_mac_lb,burden_mac_ub,burden_maf,expand_pheno_subsets:ne:1;,if_prop=var_subset_num:eq:@var_subset_num;consistent_prop var_subset_num\
%short;annot;annot;or,annot_variant_subset,;;;\
%local;annot_variant_subset;annot;;;,if_prop=var_subset_num:eq:@var_subset_num;consistent_prop var_subset_num\
! \
shortt cmd make_union_burdenl_epacts_group_file=cat !{input,,burdenl_epacts_group_file,all_instances=1,if_prop=project:eq:@project,if_prop=burdenp:eq:@union_burdenpsifprop} | awk -v OFS="\t" '{for (i=2;i<=NF;i++) {print \$i,\$1}}' | sort -k2,2 -k1,1 | uniq | $group_flatten | sed 's/\t /\t/' > !{output,,burdenl_epacts_group_file} class_level burdenl runif skip_if exskipif!union_burdenps consistentprop

#!|expand:;:burdenl;exrunif:burden;:burden_variant_subset;run_if burden_variant_subset| \
#short cmd make_burdenl_locdb_file=rm -f !{output,,burdenl_locdb_file} && $pseq_no_project_cmd loc-load !{output,--locdb,burdenl_locdb_file} --group $pseq_genes_loc_group !{input,--file,burdenl_locdb_reg_file} && $pseq_no_project_cmd loc-load-alias !{output,--locdb,burdenl_locdb_file} !{input,--file,project_transcript_gene_alias_file} class_level burdenl exrunif

!|expand:;:burdenl;exrunif:burden;:burden_variant_subset;run_if burden_variant_subset| \
short cmd make_burdenl_locdb_file=rm -f !{output,,burdenl_locdb_file} && $pseq_no_project_cmd loc-load !{output,--locdb,burdenl_locdb_file} --group $pseq_genes_loc_group !{input,--file,burdenl_locdb_reg_file} class_level burdenl exrunif

!!expand:pathwayburdentype:custom! \
local cmd make_burden_pathway_pathwayburdentype_locdb_file=rm -f !{output,,burden_pathway_pathwayburdentype_locdb_file} && cp !{input,,burden_locdb_file} !{output,,burden_pathway_pathwayburdentype_locdb_file} && $pseq_no_project_cmd locset-load !{output,--locdb,burden_pathway_pathwayburdentype_locdb_file} --group $pseq_pathwayburdentype_loc_group --name $pseq_pathwayburdentype_locset_name !{input,--file,project_pathwayburdentype_locset_file} class_level burden run_if project_pathwayburdentype_locset_file skip_if only_for_interesting

!!expand:,:burdenl:burden:annot! \
!!expand:pathwayburdentype:custom! \
short cmd make_burdenl_pathway_pathwayburdentype_epacts_group_file=$smart_join_cmd --in-delim $tab --rest-extra 1 --multiple 2 --exec "$smart_cut_cmd --exec 'cut -f1 !{input,,project_pathwayburdentype_locset_file} | sort -u' --exec 'cut -f1 !{input,,burdenl_epacts_group_file} | sort -u' | sort | uniq -d" !{input,--file,project_pathwayburdentype_locset_file} !{input,--file,burdenl_epacts_group_file} | cut -f2- | sort -k1,1 -k2,2 | uniq -u | awk -F"\t" -v OFS="\t" 'NR > 1 && g != \$1 {print g,v;v=""} {g=\$1;v=v" "\$2} END {print g,v}' | sed 's/\t /\t/' > !{output,,burdenl_pathway_pathwayburdentype_epacts_group_file} class_level burdenl run_if project_pathwayburdentype_locset_file skip_if only_for_interesting

!!expand:burdenl:burden:annot! \
raw_burdenl_mask_helper=--mask !{raw,,burdenl,mac\=,if_prop=burdenl_mac_lb,if_prop=burdenl_mac_ub,or_if_prop=1,allow_empty=1}!{prop,,burdenl,burdenl_mac_lb,if_prop=burdenl_mac_lb,allow_empty=1}!{raw,,burdenl,0,unless_prop=burdenl_mac_lb,if_prop=burdenl_mac_ub,allow_empty=1}!{raw,,burdenl,-,if_prop=burdenl_mac_lb,if_prop=burdenl_mac_ub,or_if_prop=1,allow_empty=1}!{prop,,burdenl,burdenl_mac_ub,if_prop=burdenl_mac_ub,allow_empty=1}

#raw_burdenl_mask_helper=--mask !{raw,maf=,burdenl,0-,if_prop=burdenl_maf,unless_prop=burdenl_strat_maf_summary,allow_empty=1}!{prop,,burdenl,burdenl_maf,if_prop=burdenl_maf,unless_prop=burdenl_strat_maf_summary,allow_empty=1} !{raw,,burdenl,mac\=,if_prop=burdenl_mac_lb,if_prop=burdenl_mac_ub,or_if_prop=1,allow_empty=1}!{prop,,burdenl,burdenl_mac_lb,if_prop=burdenl_mac_lb,allow_empty=1}!{raw,,burdenl,0,unless_prop=burdenl_mac_lb,if_prop=burdenl_mac_ub,allow_empty=1}!{raw,,burdenl,-,if_prop=burdenl_mac_lb,if_prop=burdenl_mac_ub,or_if_prop=1,allow_empty=1}!{prop,,burdenl,burdenl_mac_ub,if_prop=burdenl_mac_ub,allow_empty=1}

!!expand:burdenl:burden:burden_variant_subset! \
burdenl_mask_helper=!{input,--locdb,burdenl_locdb_file}
#burdenl_mask_helper=reg.req=@!{input,,burdenl_reg_list_file}

!!expand:pathwayburdentype:custom! \
burden_pathway_pathwayburdentype_mask_helper=!{input,--locdb,burden_pathway_pathwayburdentype_locdb_file}

!{raw,,burden,-,if_prop=burden_mac_lb,if_prop=burden_mac_ub,allow_empty=1}!{prop,,burden,burden_mac_ub,if_prop=burden_mac_ub,allow_empty=1}

!!expand:burdenl:burden:burden_variant_subset! \
burdenl_gassoc_helper=--perm @1 --mask loc.group=$pseq_genes_loc_group $burdenl_mask_helper $burden_test_indiv_ex_helper @2 | $remove_dup_genes | sed 's/^\s*//'

#cmd make_burden_level1_gassoc_file=$pseq_qc_plus_assoc_cmd_pheno($assoc) !{prop,--phenotype,pheno} $burden_gassoc_helper($nperm1_gene,) > !{output,,burden_level1_gassoc_file} class_level burden skip_if not_trait

burden_sample_list_var_delim=,

burden_sample_list_helper_int=$smart_join_cmd --in-delim $tab --header 1 --extra 2 --ignore-err $plinkseq_okay_err --exec "(echo VAR && cat !{input,,@1})" --exec "if [[ `cat !{input,,@1} | wc -l` -gt 0 ]]; then $pseq_qc_plus_all_analysis_cmd_pheno_variant_subset(v-matrix) $show_id --mask reg.req=@!{input,,@2} | $smart_cut_cmd --exclude-col 0,2-3 --in-delim $tab | $parse_out_id; else echo VAR; fi" | perl -lne 'chomp; \@F = split("\t"); \$id = shift \@F; if (!\$first) {\$first = 1; \$nf = scalar \@F; for (my \$i = 0; \$i < \$nf; \$i++) {\$t[\$i]=0;\$v[\$i]=""}; print join("\t", \@F)} else {die "Not square" unless \$nf == scalar \@F; \$s = 0; \$n = 0; map {if (\$_ =~ /^[0-9]+$/) {\$s += \$_; \$n+= 2}} \@F; \$f = \$n > 0 ? \$s / \$n : 0; if (\$f > .5) {map {\$F[\$_] = 2 - \$F[\$_] if \$F[\$_] =~ /^[0-9]+$/} 0..\$nf} map {if (\$F[\$_] =~ /^[0-9]+$/){\$t[\$_]+=\$F[\$_]; if (\$F[\$_] > 0) {\$v[\$_].="$burden_sample_list_var_delim" if \$v[\$_]; \$v[\$_].="\$id"} }} 0..\$nf} END {print join("\t", \@t);print join("\t", \@v)}' | $transpose_cmd --in-delim $tab | $smart_cut_cmd --select-col 0,@5 --select-row 0,2,@3:0 --in-delim $tab  > !{output,,@4}

gene_burden_or_variant_sstats_helper=$smart_join_cmd --out-delim $tab --header 1 --exec "cut -d@3 -f1 !{input,,@2} | $smart_cut_cmd --in-delim $tab !{input,--file,@{1}_sample_without_list_file} !{input,--file,@{1}_sample_list_file} --select-col 1,1 --select-col 2,1 | sort | uniq -d | sed '1 s/^/ID\n/'" --exec "$smart_cut_cmd --in-delim $tab --exec \"cut -f1 !{input,,@{1}_sample_list_file} | sed 's/$/\t1\tHas Variant/'\" --exec \"cut -f1 !{input,,@{1}_sample_without_list_file} | sed 's/$/\t0\tNo Variant/'\" | sed '1 s/^/ID\tVariant\tDisp\n/'" !{input,--file,@2} --rest-extra 1 --arg-delim : --in-delim 3:@3 --in-delim 2:$tab
burden_sstats_helper=$gene_burden_or_variant_sstats_helper(burden,@1,@2)

record_burden_test_info_int=(echo Test$tab!{prop,,burden_test,test_tag,missing_prop=test_name,sep=/,uc=1} && \
	 echo Software$tab!{raw,,burden_test,\@test_software} && \
	 echo Test name${tab}@1 && \
	 echo Samples${tab}@10 && \
	 echo Covariates${tab}@2 && \
	 echo Clustering${tab}@3 && \
	 echo GT cutoff${tab}@4 && \
	 echo Permutations${tab}@5 && \
	 echo Make two-sided${tab}@6 && \
	 echo Max missing${tab}@7 && \
	 echo P missing cutoff${tab}@8 && \
	 echo HWE cutoff${tab}@9 && \
	 echo PI_HAT cutoff$tab!{raw,,burden_test,\@max_related,unless_prop=include_related,allow_empty=1}!{raw,,burden_test,1,if_prop=include_related,allow_empty=1} \
	 )> !{output,,burden_test_info_file}

record_burden_test_info=$record_burden_test_info_int(!{prop;;burden_test;test_name} !{prop;;burden_test;test_options;if_prop=test_options;allow_empty=1},@1,@2,@3,@4,@5,@6,@7,@8,`cat @9 | wc -l`)

local cmd make_burden_burden_test_info_tex_file=$smart_cut_cmd --in-delim $tab !{input,--file,burden_test_info_file} --select-col 1,1 --select-col .,2 --paste | $table_to_beamer_cmd --header-rows 1 --header-cols 1 --in-delim $tab --title "Burden tests" --auto-dim --font-size 8pt > !{output,,burden_burden_test_info_tex_file} class_level burden run_if burden_test
local cmd make_burden_burden_test_info_pdf_file=$run_latex_cmd(burden_burden_test_info_tex_file,burden_burden_test_info_pdf_file) class_level burden run_if burden_test

!|expand:;:alltype;allskipif:all;!include_related:unrelated;include_related| \
!|expand:;:atype;cmdtype;extracmd;extrarunif:;;;run_if run_raw:;_cluster;$add_strata(burden_test);run_if and,!run_raw,!analytic,(or,strat_cluster,strata_traits):analytic_;_covar;$add_covar(burden_test);run_if and,!run_raw,analytic,(or,strat_covar,covar_traits)| \
!!expand:pathwayburdentype:custom! \
cmd make_atypecmdtypeburden_test_pathway_pathwayburdentypecmdtype_alltype_gassoc_file=$pseq_qc_plus_alltype_assoc_cmd_phenocmdtype($assoc) extracmd $qt_plinkseq_phenotype_selector $burden_test_indiv_ex_helper --perm $nperm_pathway --mask locset.group=$pseq_pathwayburdentype_loc_group,$pseq_pathwayburdentype_locset_name $burden_pathway_pathwayburdentype_mask_helper | $assoc_fix_bug > !{output,,burden_test_pathway_pathwayburdentype_gassoc_file} class_level burden_test extrarunif skip_if or,not_trait,only_for_interesting,!project_pathwayburdentype_locset_file,test_software:ne:pseq,allskipif rusage_mod $pseq_pathway_mem

!|expand:;:alltype;relskipif:all;!include_related:unrelated;include_related| \
!!expand:pathwayburdentype:custom! \
cmd make_burden_test_alltype_epacts_strata_pathway_pathwayburdentype_gassoc_file=c=$get_epacts_covars(burden_test) $meta_skat_covars && $burden_test_epacts_group_helper(burden_test_pathway_pathwayburdentype_gassoc,!{prop::burden_test:test_name},covar_alltype,\$c,!{prop::pheno},!{input::burden_pathway_pathwayburdentype_epacts_group_file}) class_level burden_test run_if or,strat_covar,covar_traits skip_if or,only_for_interesting,run_raw,test_software:ne:epacts,relskipif run_with burden_test_variant_subset

!|expand:;:alltype;relskipif:all;!include_related:unrelated;include_related| \
!!expand:pathwayburdentype:custom! \
cmd make_burden_test_alltype_epacts_raw_pathway_pathwayburdentype_gassoc_file=$burden_test_epacts_group_helper(burden_test_pathway_pathwayburdentype_gassoc,!{prop::burden_test:test_name},popgen_alltype,,!{prop::pheno},!{input::burden_pathway_pathwayburdentype_epacts_group_file}) class_level burden_test run_if run_raw skip_if or,only_for_interesting,test_software:ne:epacts,relskipif run_with burden_test_variant_subset

translate_gene_variant_reg_req=cut -f2,3 | sed 's/\t/:/' | tr '\n' , | sed 's/,$//'

add_burden_gassoc_key=sed 's/^\(\S\S*\)\(\s\s*\)\(\S\S*\)/\1:\3\2\1\2\3/'

default_missing_pheno=-9
default_case_pheno=2
default_control_pheno=1

default_missing_pheno_order=2
default_case_pheno_order=0
default_control_pheno_order=1

prop case_pheno=scalar default 2
prop control_pheno=scalar default 1

fix_two_hit_helper=!{raw,,burden_test,| sed 's/\(TWO-HIT\t\)\(\S\S*\)\(.*\)\(P\=\)\([^;][^;]*\)/\1\5\3\4\5/',if_prop=test_name:eq:two-hit,allow_empty=1}

!|expand:;:alltype;allskipif:all;!include_related:unrelated;include_related| \
!|expand:;:shortt;phenol;burdenl;burden_testl;assocl;exskipif:;pheno;burden;burden_test;assoc;,burden_test_variant_subset:short;pheno_variant_subset;burden_variant_subset;burden_test_variant_subset;assoc_variant_subset;| \
!|expand:;:atype;cmdtype;extracmd;extrarunif:;;;run_if run_raw:;_cluster;$add_strata(burden_testl);run_if and,!run_raw,!analytic,(or,strat_cluster,strata_traits):analytic_;_covar;$add_covar(burden_test);run_if and,!run_raw,analytic,(or,strat_covar,covar_traits)| \
shortt cmd make_atypeburden_testl_case_side_pseqcmdtype_alltype_gassoc_file=$pseq_qc_plus_alltype_assoc_cmd_phenolcmdtype($assocl) extracmd $qt_plinkseq_phenotype_selector $burdenl_gassoc_helper($nperm_gassoc,) $fix_two_hit_helper | $assoc_fix_bug > !{output,,burden_testl_case_side_gassoc_file} !{input,pheno_is_trait_file} class_level burden_testl extrarunif skip_if or,test_software:ne:pseqexskipif,allskipif rusage_mod $pseq_gene_mem run_with burden_test_variant_subset

epacts_group_unit=5

group_dev_null=>&

!!expand:,:burden_testl,burdenl,whichvcf:burden_test,burden,project_clean_all_vcf_file:burden_test_variant_subset,burden_variant_subset,pheno_variant_subset_clean_all_vcf_file! \
burden_testl_epacts_group_helper=!{input,burden_testl_epacts_ready_file} rm -f !{raw,,burden_testl,*@{1}_epacts_trunk.epacts} && rm -f !{output,,@{1}_file} && !{raw,,burden_testl,rm -f *@{1}_epacts_trunk.reml && ln -s *burden_test_in_aux1_file *@{1}_epacts_trunk.reml && rm -f *@{1}_epacts_trunk.eigR && ln -s *burden_test_in_aux2_file *@{1}_epacts_trunk.eigR &&,if_prop=test_name:eq:emmaxCMC,if_prop=test_name:eq:emmaxVT,if_prop=test_name:eq:mmskat,or_if_prop=1,allow_empty=1} !{input;burden_test_in_aux1_file;if_prop=test_name:eq:emmaxCMC;if_prop=test_name:eq:emmaxVT;if_prop=test_name:eq:mmskat;or_if_prop=1;allow_empty=1} !{input;burden_test_in_aux2_file;if_prop=test_name:eq:emmaxCMC;if_prop=test_name:eq:emmaxVT;if_prop=test_name:eq:mmskat;or_if_prop=1;allow_empty=1} $epacts_cmd group -restart --missing $plink_missing !{prop,-unit,burden_test,epacts_unit,missing_key=epacts_group_unit} !{input,--vcf,whichvcf} !{input,--ped,pheno_epacts_@{3}_ped_file,unless_prop=burden_test_sample_include_file,unless_prop=extra_covar_traits,unless_prop=test_name:eq:metaSKAT,allow_empty=1} !{input,--ped,burden_test_sample_include_aux_file,if_prop=burden_test_sample_include_file,unless_prop=extra_covar_traits,unless_prop=alternate_pheno,unless_prop=test_name:eq:metaSKAT,allow_empty=1} !{input,--ped,burden_test_covars_aux_file,if_prop=extra_covar_traits,unless_prop=test_name:eq:metaSKAT,allow_empty=1} !{input,--ped,burden_test_covars_aux_file,unless_prop=test_name:eq:metaSKAT,if_prop=alternate_pheno,allow_empty=1} !{input,--ped,burden_test_in_aux1_file,if_prop=test_name:eq:metaSKAT,allow_empty=1} !{input,--kinf,pheno_kinship_file,if_prop=test_name:eq:emmaxCMC,if_prop=test_name:eq:emmaxVT,if_prop=test_name:eq:mmskat,or_if_prop=1,allow_empty=1} !{raw,--remlf,burden_test,*@{1}_epacts_trunk.reml,if_prop=test_name:eq:emmaxCMC,if_prop=test_name:eq:emmaxVT,if_prop=test_name:eq:mmskat,or_if_prop=1,allow_empty=1} --min-maf 0 --min-callrate 0 --max-maf 1 --pheno @5 --groupf @6 --test @{2} !{prop;;burden_test;test_options;if_prop=test_options;allow_empty=1} !{raw;--strat;burden_test;$meta_skat_strat_col;if_prop=test_name:eq:metaSKAT;allow_empty=1} -run 1 !{prop,-field,burden_test,epacts_gt_field} @4 !{raw,--out,burden_testl,*@{1}_epacts_trunk} ${group_dev_null}/dev/null && awk -F"\t" '\$1 != ""' !{raw,,burden_testl,*@{1}_epacts_trunk.epacts} > !{output,,@{1}_file}

burden_test_epacts_eigen_helper=rm -f !{raw,,burden_test,*burden_test_case_side_gassoc_epacts_trunk.eigR} && rm -f !{raw,,burden_test,*burden_test_case_side_gassoc_epacts_trunk.reml} && !{input,burden_test_epacts_ready_file} $epacts_cmd single -restart --missing $plink_missing !{input,--vcf,pheno_sample_marker_pruned_vcf_file} !{input,--ped,pheno_epacts_@{1}_ped_file,unless_prop=burden_test_sample_include_file,unless_prop=extra_covar_traits,allow_empty=1} !{input,--ped,burden_test_sample_include_aux_file,if_prop=burden_test_sample_include_file,unless_prop=extra_covar_traits,unless_prop=alternate_pheno,allow_empty=1} !{input,--ped,burden_test_covars_aux_file,if_prop=extra_covar_traits,if_prop=alternate_pheno,or_if_prop=1,allow_empty=1} !{input,--kinf,pheno_kinship_file,if_prop=test_name:eq:emmaxCMC,if_prop=test_name:eq:emmaxVT,if_prop=test_name:eq:mmskat,or_if_prop=1,allow_empty=1} !{prop,-unit,burden_test,epacts_unit,missing_key=epacts_single_unit} --min-maf 0 --min-callrate 0 --min-mac 0 !{prop:--pheno:burden_test:pheno:unless_prop=alternate_pheno:allow_empty=1}!{prop:--pheno:burden_test:alternate_pheno:if_prop=alternate_pheno:allow_empty=1} --test q.emmax !{prop;;burden_test;test_options;if_prop=test_options;allow_empty=1} -run 1 !{prop,-field,burden_test,epacts_gt_field} @2 --chr -1 !{raw,--out,burden_test,*burden_test_case_side_gassoc_epacts_trunk} && mv !{raw,,burden_test,*burden_test_case_side_gassoc_epacts_trunk.reml} !{output,,burden_test_in_aux1_file} && mv !{raw,,burden_test,*burden_test_case_side_gassoc_epacts_trunk.eigR} !{output,,burden_test_in_aux2_file}

!|expand:;:alltype;runif:all;include_related:unrelated;!include_related| \
cmd make_burden_test_alltype_epacts_strata_in_aux_files=c=$get_epacts_covars(burden_test) && $burden_test_epacts_eigen_helper(covar_alltype,\$c) class_level burden_test run_if and,!run_raw,(or,strat_covar,covar_traits),test_software:eq:epacts,runif skip_if and,test_name:ne:emmaxCMC,test_name:ne:emmaxVT,test_name:ne:mmskat rusage_mod $epacts_eigen_mem run_with burden_test_variant_subset

meta_skat_covars_helper=!{raw;;burden_test;&& c\=`head -n1 *burden_test_in_aux1_file | cut -f8- | $smart_cut_cmd --exclude-col 0,1,$meta_skat_strat_col | sed 's/\(\S\S*\)/@1\1/g'`;if_prop=test_name:eq:metaSKAT;allow_empty=1} !{input,burden_test_in_aux1_file,if_prop=test_name:eq:metaSKAT,allow_empty=1}

meta_skat_covars=$meta_skat_covars_helper(--cov )

!|expand:;:alltype;relskipif:all;!include_related:unrelated;include_related| \
!|expand:;:shortt;phenol;burdenl;burden_testl;exskipif:;pheno;burden;burden_test;,burden_test_variant_subset:short;pheno_variant_subset;burden_variant_subset;burden_test_variant_subset;| \
shortt cmd make_burden_testl_case_side_alltype_epacts_strata_gassoc_file=c=$get_epacts_covars(burden_test) $meta_skat_covars && $burden_testl_epacts_group_helper(burden_testl_case_side_gassoc,!{prop::burden_test:test_name},covar_alltype,\$c,!{prop::burden_test:pheno:unless_prop=alternate_pheno:allow_empty=1}!{prop::burden_test:alternate_pheno:if_prop=alternate_pheno:allow_empty=1},!{input::burdenl_epacts_group_file}) class_level burden_testl run_if or,strat_covar,covar_traits skip_if or,run_raw,test_software:ne:epactsexskipif,relskipif run_with burden_test_variant_subset rusage_mod $epacts_gassoc_mem

!|expand:;:alltype;relskipif:all;!include_related:unrelated;include_related| \
local cmd make_burden_test_alltype_epacts_strata_info_file=c="$get_disp_covars_burden_test" $meta_skat_covars_helper(\,); c=`echo \$c | sed 's/^,//'`; $record_burden_test_info(\$c,no,!{raw::burden_test:@epacts_gt_field},no,no,!{prop::burden_test:max_assoc_null:missing=none},!{prop::burden_test:min_test_p_missing:missing=none},!{prop::burden_test:min_test_p_hwe:missing=none},!{input;;pheno_sample_covar_alltype_include_file;unless_prop=burden_test_sample_include_file;unless_prop=extra_covar_traits;unless_prop=alternate_pheno;allow_empty=1} !{raw;;burden_test;*burden_test_sample_include_aux_file | tail -n+2;if_prop=burden_test_sample_include_file;unless_prop=extra_covar_traits;unless_prop=alternate_pheno;allow_empty=1} !{input;burden_test_sample_include_aux_file;if_prop=burden_test_sample_include_file;unless_prop=extra_covar_traits;unless_prop=alternate_pheno;allow_empty=1} !{raw;;burden_test;*burden_test_covars_aux_file | tail -n+2;if_prop=extra_covar_traits;if_prop=alternate_pheno;or_if_prop=1;allow_empty=1} !{input;burden_test_covars_aux_file;if_prop=extra_covar_traits;if_prop=alternate_pheno;or_if_prop=1;allow_empty=1} ) class_level burden_test run_if or,strat_covar,covar_traits skip_if or,run_raw,test_software:ne:epacts,relskipif

!|expand:;:alltype;runif:all;include_related:unrelated;!include_related| \
cmd make_burden_test_alltype_epacts_raw_in_aux_files=$burden_test_epacts_eigen_helper(popgen_alltype,) class_level burden_test run_if and,run_raw,test_software:eq:epacts,runif skip_if and,test_name:ne:emmaxCMC,test_name:ne:emmaxVT,test_name:ne:mmskat rusage_mod $epacts_eigen_mem run_with burden_test_variant_subset

!|expand:;:alltype;relskipif:all;!include_related:unrelated;include_related| \
!|expand:;:shortt;phenol;burdenl;burden_testl;exskipif:;pheno;burden;burden_test;,burden_test_variant_subset:short;pheno_variant_subset;burden_variant_subset;burden_test_variant_subset;| \
shortt cmd make_burden_testl_case_side_alltype_epacts_raw_gassoc_file=$burden_testl_epacts_group_helper(burden_testl_case_side_gassoc,!{prop::burden_test:test_name},popgen_alltype,,!{prop::burden_test:pheno:unless_prop=alternate_pheno:allow_empty=1}!{prop::burden_test:alternate_pheno:if_prop=alternate_pheno:allow_empty=1},!{input::burdenl_epacts_group_file}) class_level burden_testl run_if run_raw skip_if or,test_software:ne:epactsexskipif,relskipif run_with burden_test_variant_subset rusage_mod $epacts_gassoc_mem

!|expand:;:alltype;relskipif:all;!include_related:unrelated;include_related| \
local cmd make_burden_test_alltype_epacts_raw_info_file=$record_burden_test_info(no,no,!{raw::burden_test:@epacts_gt_field},no,no,!{prop::burden_test:max_assoc_null:missing=none},!{prop::burden_test:min_test_p_missing:missing=none},!{prop::burden_test:min_test_p_hwe:missing=none},!{input;;pheno_sample_popgen_alltype_include_file;unless_prop=burden_test_sample_include_file;unless_prop=alternate_pheno;allow_empty=1} !{raw;;burden_test;*burden_test_sample_include_aux_file | tail -n+2;if_prop=burden_test_sample_include_file;if_prop=alternate_pheno;or_if_prop=1;allow_empty=1} !{input;burden_test_sample_include_aux_file;if_prop=burden_test_sample_include_file;if_prop=alternate_pheno;or_if_prop=1;allow_empty=1}) class_level burden_test run_if run_raw skip_if or,test_software:ne:epacts,relskipif

meta_skat_aux1_helper=$smart_cut_cmd --in-delim $tab !{input,--file,pheno_epacts_@{1}_ped_file,unless_prop=burden_test_sample_include_file,unless_prop=extra_covar_traits,allow_empty=1} !{input,--file,burden_test_sample_include_aux_file,if_prop=burden_test_sample_include_file,unless_prop=extra_covar_traits,unless_prop=alternate_pheno,allow_empty=1} !{input,--file,burden_test_covars_aux_file,if_prop=extra_covar_traits,if_prop=alternate_pheno,or_if_prop=1,allow_empty=1} --select-col 1,1-7 --require-col-match --exact

meta_skat_strat_col=STRAT

meta_skat_append_strat=sed '1 s/$/\t$meta_skat_strat_col/' | sed '1! s/$/\t!{prop,,pheno}/'

!|expand:;:alltype;runif:all;include_related:unrelated;!include_related| \
short cmd make_burden_test_alltype_epacts_meta_skat_strata_in_aux1_files=$meta_skat_aux1_helper(covar_alltype) --select-col 1,1,$get_spaced_covars(burden_test) | $meta_skat_append_strat > !{output,,burden_test_in_aux1_file} class_level burden_test run_if and,!run_raw,(or,strat_covar,covar_traits),test_software:eq:epacts,runif skip_if or,test_name:ne:metaSKAT,meta_trait_inv run_with burden_test_variant_subset

!|expand:;:alltype;runif:all;include_related:unrelated;!include_related| \
short cmd make_burden_test_alltype_epacts_meta_skat_raw_in_aux1_files=$meta_skat_aux1_helper(popgen_alltype) | $meta_skat_append_strat > !{output,,burden_test_in_aux1_file} class_level burden_test run_if and,run_raw,test_software:eq:epacts,runif skip_if or,test_name:ne:metaSKAT,meta_trait_inv run_with burden_test_variant_subset

get_meta_skat_meta_covars=$smart_cut_cmd --in-delim $tab !{input,--file,burden_test_in_aux1_file,all_instances=1,if_prop=project:eq:@project,if_prop=pheno:eq:@meta_trait_inv,if_prop=burden:eq:@burden,if_prop=burden_test:eq:@meta_test} --exclude-col .,1-7 --exclude-col .,1,$meta_skat_strat_col --select-row .,1 | perl -lane 'foreach (@F) {print unless \$m{\$_}; \$m{\$_}=1}' | tr '\n' ' '

short cmd make_burden_test_epacts_meta_skat_meta_in_aux1_files=c=`$get_meta_skat_meta_covars` && $smart_cut_cmd --in-delim $tab !{input,--file,burden_test_in_aux1_file,all_instances=1,if_prop=project:eq:@project,if_prop=pheno:eq:@meta_trait_inv,if_prop=burden:eq:@burden,if_prop=burden_test:eq:@meta_test} --select-col .,1-7 --select-col .,1,$meta_skat_strat_col --select-col .,1,"\$c" --fill-value NA --exclude-row 2-.,1 | awk -v OFS="\t" -F"\t" 'NR == 1 {\$7="!{prop,,pheno}"} {print}' > !{output,,burden_test_in_aux1_file} class_level burden_test run_if and,!run_raw,(or,strat_covar,covar_traits),test_software:eq:epacts skip_if or,test_name:ne:metaSKAT,!meta_trait_inv run_with burden_test_variant_subset


#!|expand:,:shortt,phenol,burdenl,exskipif:,pheno,burden,num_var_subsets:short,pheno_variant_subset,burden_variant_subset,!num_var_subsets| \
#!|expand:;:keytype;cmdtype;phefiletype;extrarunif:raw_;;phe;run_if run_raw:strata_;_covar;phe_covar;run_if or,strat_covar,covar_traits| \
#shortt cmd make_burdenl_keytypecase_side_score_gassoc_file=$score_seq_cmd !{input,-pfile,pheno_score_seq_phefiletype_file} !{input,-mfile,burdenl_score_seq_map_file} !{output,-ofile,burdenl_keytypecase_side_score_gassoc_file} !{input,-gfile,phenol_keytypevmatrix_file} -vtlog /dev/null -msglog /dev/null -MAF 1 -MAC 0 !{input,pheno_is_trait_file} class_level burdenl extrarunif skip_if or,no_burden_test,exskipif


!|expand:;:alltype;allskipif:all;!include_related:unrelated;include_related| \
!|expand:;:shortt;phenol;burdenl;burden_testl;assocl;exskipif:;pheno;burden;burden_test;assoc;burden_test_variant_subset:short;pheno_variant_subset;burden_variant_subset;burden_test_variant_subset;assoc_variant_subset;!burden_test_variant_subset| \
!|expand:;:atype;cmdtype;extracmd;extrarunif:;;;run_if run_raw:;_cluster;$add_strata(burden_testl);run_if and,!run_raw,!analytic,(or,strat_cluster,strata_traits):analytic_;_covar;$add_covar(burden_test);run_if and,!run_raw,analytic,(or,strat_covar,covar_traits)| \
shortt cmd make_atypeburden_testl_control_sidecmdtype_alltype_gassoc_file=$pseq_qc_plus_alltype_assoc_cmd_phenolcmdtype($assocl) extracmd $qt_plinkseq_phenotype_selector_raw(--make-phenotype)=$control_pheno_helper:$case_pheno_helper $burdenl_gassoc_helper($nperm_gassoc,) | $assoc_fix_bug | $smart_cut_cmd --in-delim $tab --select-col 0,1 --select-col 0,1,'TEST P I DESC' --require-col-match --exact | sed '1 s/\(\s*\)\(P\|I\|DESC\)\(\s*\)/\1\22\3/g' $fix_two_hit_helper > !{output,,burden_testl_control_side_gassoc_file} !{input,pheno_is_trait_file} class_level burden_testl extrarunif skip_if or,test_software:ne:pseq,!make_two_sided,exskipif,allskipif rusage_mod $pseq_gene_mem run_with burden_test_variant_subset

!|expand:;:alltype;allskipif:all;!include_related:unrelated;include_related| \
!|expand@;@atype;cmdtype;covars;clustering;whichinclude;extrarunif@\
;;no;no;popgen;run_if and,run_raw,!analytic@\
;_cluster;no;$get_disp_cluster_burden_test;cluster;run_if and,!run_raw,!analytic,(or,strat_cluster,strata_traits)@\
analytic_;;no;no;popgen;run_if and,run_raw,analytic@\
analytic_;_covar;$get_disp_covars_burden_test;no;covar;run_if and,!run_raw,analytic,(or,strat_covar,covar_traits)| \
local cmd make_atypeburden_test_pseqcmdtype_alltype_info_file=$record_burden_test_info(covars,clustering,$gq_crit_helper,!{raw::burden_test:no:if_prop=analytic:allow_empty=1}!{raw::burden_test:adaptive:unless_prop=analytic:allow_empty=1}!{raw::burden_test:\\, fix null:if_prop=fix_null:allow_empty=1},!{raw::burden_test:yes:if_prop=make_two_sided:allow_empty=1}!{raw::burden_test:no:unless_prop=make_two_sided:allow_empty=1},!{prop::burden_test:max_assoc_null:missing=none},!{prop::burden_test:min_test_p_missing:missing=none},!{prop::burden_test:min_test_p_hwe:missing=none},!{input;;pheno_sample_whichinclude_alltype_include_file} !{input;;burden_test_sample_include_aux_file;if_prop=burden_test_sample_include_file;if_prop=alternate_pheno;or_if_prop=1;allow_empty=1} !{input;;burden_test_sample_include_aux_file;if_prop=burden_test_sample_include_file;if_prop=alternate_pheno;or_if_prop=1;allow_empty=1} | sort | uniq -u) class_level burden_test extrarunif skip_if or,test_software:ne:pseq,allskipif

local cmd make_burden_test_metal_info_file=$record_burden_test_info_int(!{prop;;burden_test;test_tag;missing_prop=test_name;sep=\,;all_instances=1;all_instances=1;if_prop=project:eq:@project;if_prop=pheno:eq:@meta_trait_inv;if_prop=burden_test:eq:@meta_test;limit=1}: !{prop;;burden_test;meta_trait_inv;sep=\,},NA,NA,NA,NA,NA,NA,NA,NA,NA) class_level burden_test run_if test_software:eq:metal

local cmd make_burden_test_metal_in_aux1_file=(echo SCHEME !{prop,,burden_test,metal_scheme} && echo MARKER $id_col_disp && echo SEPARATOR TAB && echo PVALUE $p_col_disp && echo WEIGHT $n_col_disp && echo ALLELE ALT REF && echo STDERR $se_col_disp && echo EFFECT $beta_col_disp && echo CUSTOMVARIABLE TotalSampleSize && echo LABEL TotalSampleSize as $n_col_disp && !{raw,,burden_test,echo PROCESS *burden_test_small_gassoc_file,sep=&&,all_instances=1,if_prop=project:eq:@project,if_prop=pheno:eq:@meta_trait_inv,if_prop=burden:eq:@burden,if_prop=burden_test:eq:@meta_test} !{input,burden_test_small_gassoc_file,all_instances=1,if_prop=project:eq:@project,if_prop=pheno:eq:@meta_trait_inv,if_prop=burden:eq:@burden,if_prop=burden_test:eq:@meta_test} && echo OUTFILE !{raw,,burden_test,*burden_test_case_side_gassoc_file} .tbl && echo ANALYZE) > !{output,,burden_test_in_aux1_file} class_level burden_test run_if and,test_software:eq:metal,meta_trait_inv 

short cmd make_burden_test_metal_case_side_gassoc_file=cat !{input,,burden_test_in_aux1_file} !{input,burden_test_small_gassoc_file,all_instances=1,if_prop=project:eq:@project,if_prop=pheno:eq:@meta_trait_inv,if_prop=burden_test:eq:@meta_test} | $metal_cmd !{output,burden_test_case_side_gassoc_file} > !{output,,burden_test_out_aux1_file} && mv !{output,,burden_test_case_side_gassoc_file}1.tbl !{output,,burden_test_case_side_gassoc_file} class_level burden_test run_if and,test_software:eq:metal,meta_trait_inv

format_dist_test=calpha
format_count_test=burden

#!|expand:;:shortt;phenol;burdenl;burden_testl;exskipif:;pheno;burden;burden_test;burden_variant_subset:short;pheno_variant_subset;burden_variant_subset;burden_test_variant_subset;!burden_variant_subset| \
#shortt cmd make_burdenl_gassoc_counts_data_file=$pseq_qc_plus_unrelated_assoc_cmd_phenol($assoc_raw --tests $format_dist_test $format_count_test) $bad_for_genes_regex_mask $qt_plinkseq_phenotype_selector $burdenl_gassoc_helper(0,) | $assoc_fix_bug > !{output,,burdenl_gassoc_counts_data_file} !{input,pheno_is_trait_file} class_level burdenl skip_if or,exskipif run_if burden_test rusage_mod $pseq_gene_mem run_with burden_variant_subset

!|expand:;:shortt;phenol;burdenl;burden_testl;assocl;exskipif:;pheno;burden;burden_test;assoc;burden_variant_subset:short;pheno_variant_subset;burden_variant_subset;burden_test_variant_subset;assoc_variant_subset;!burden_variant_subset| \
shortt cmd make_burdenl_gassoc_counts_data_file=cat !{input,,phenol_counts_file} | $add_gene_annot_cmd --locus-col 1 --header 1 !{input,--gene-file,burdenl_locdb_reg_file} --gene-file-id-col 4 --gene-file-chr-col 1 --gene-file-start-col 2 --gene-file-end-col 3 --print-multiple --gene-file-header 1 --in-delim $tab | $smart_cut_cmd --in-delim $tab --select-col 0,1,'GENE CNTA CNTU' --exclude-row 0,1 | sort -k1,1 | awk -F"\t" -v OFS="\t" 'function print_dist(g,n,mina,minu,m) {d=""; for (v in m) {if (d) {d = d";"} d = d""v"("m[v]")"} print g,n,mina+minu,mina,minu,d} BEGIN {print "LOCUS","NVAR","MAC","MINA","MINU","DIST"; n=0; split("", m, ""); mina=0; minu=0; g=""} g && \$1 != g {print_dist(g,n,mina,minu,m); n=0; split("", m, ""); mina=0; minu=0; g=""} {g = \$1; n++; k = \$2"/"\$3; m[k]++; mina += \$2; minu += \$3} END {if (g != "") {print_dist(g,n,mina,minu,m)}}' > !{output,,burdenl_gassoc_counts_data_file} !{input,pheno_is_trait_file} class_level burdenl skip_if or,exskipif run_if burden_test rusage_mod $pseq_gene_mem run_with burden_variant_subset

gassoc_mina_minu=MINA/MINU
gassoc_count=MAC
gassoc_dist=DIST

small_gassoc_helper1=$smart_join_cmd --in-delim $tab --header 1 --exec "$smart_cut_cmd --tab-delim !{input,--file,project_transcript_gene_alias_file} --exec 'cut -f2 !{input,,project_variant_gene_annotation_file} | sort -u' --exclude-row 1,1 --select-col 1,1,'transcript gene' | awk -v OFS=\"\t\" -F\"\t\" 'NF == 2 {print} NF == 1 {print \\$1,\\$1}' | sed '1 s/^/TRANSCRIPT\tGENE\n/'" --extra 1

small_gassoc_helper2=awk -v OFS="\t" -F "\t" '{s=\$1;\$1=\$2;\$2=s} \$1 == \$2 {\$2="$consensus_transcript"} {print}'

#short cmd make_burden_gassoc_counts_file=$small_gassoc_helper1 --exec "$smart_cut_cmd --in-delim $tab !{input:--file:burden_gassoc_counts_data_file} --select-col 1,1,'LOCUS POS NVAR DESC' --require-col-match --select-row 1,1 --exact  --select-row 1,1,TEST,!{raw::burden:$format_count_test:uc=1} --exact | perl -lne 'chomp; @a = split(\"\t\"); \\$er = \"$gassoc_count\"; if (\\$. > 1) {@cc = split(\"/\", \\$a[\\$\#a]); \\$er = \\$cc[0]+\\$cc[1];} print join(\"\t\", @a[0..2]) . \"\t\\$er\t\\$a[3]\"' | sed '1 s;\S\S*$;$gassoc_mina_minu;'" --exec "$smart_cut_cmd --in-delim $tab !{input:--file:burden_gassoc_counts_data_file} --select-col 1,1,'LOCUS DESC' --require-col-match --select-row 1,1 --exact --select-row 1,1,TEST,!{raw::burden:$format_dist_test:uc=1} --exact | sed '1 s;\S\S*$;$gassoc_dist;'" | $small_gassoc_helper2 > !{output,,burden_gassoc_counts_file} class_level burden run_if burden_test

short cmd make_burden_gassoc_counts_file=$small_gassoc_helper1 --exec "$smart_cut_cmd --in-delim $tab !{input:--file:burden_gassoc_counts_data_file} --select-col 1,1,'LOCUS NVAR MAC MINA MINU DIST' --require-col-match --exact --exclude-row 1,1,LOCUS,$outside_gene_name | awk -F\"\t\" -v OFS=\"\t\" '{print \\$1,\\$2,\\$3,\\$4\"/\"\\$5,\\$6}' | tail -n+2 | sed '1 s;.*;LOCUS\tNVAR\t$gassoc_count\t$gassoc_mina_minu\t$gassoc_dist;'" | $small_gassoc_helper2 > !{output,,burden_gassoc_counts_file} class_level burden run_if burden_test

!|expand:;:shortt;phenol;burdenl;burden_testl;exskipif:short;pheno;burden;burden_test;burden_test_variant_subset:local;pheno_variant_subset;burden_variant_subset;burden_test_variant_subset;!burden_test_variant_subset| \
shortt cmd make_burden_testl_gassoc_file=rm -f !{output,,burden_testl_gassoc_file} && $smart_join_cmd --in-delim $tab --header 1 --ignore-err "$burden_include_warning" --exec "$smart_cut_cmd --tab-delim !{input,--file,burden_testl_case_side_gassoc_file} !{input,--file,burden_testl_control_side_gassoc_file} --exclude-row 1-2,1 --select-col 1-2,1,'LOCUS TEST' | sort | uniq -d | $add_header_cmd LOCUS${tab}TEST" --exec "$smart_cut_cmd --tab-delim !{input,--file,burden_testl_case_side_gassoc_file} --select-col 1,1,'^LOCUS$ ^TEST$ .' --require-col-match" --exec "$smart_cut_cmd --tab-delim !{input,--file,burden_testl_control_side_gassoc_file} --select-col 1,1,'^LOCUS$ ^TEST$ .'" --rest-extra 1 --col 1 --col 2 | awk -v OFS="\t" -F "\t" 'NR == 1 {for (i=1;i<=NF;i++) {map[\$i]=i}} NR != 1 {if (\$map["P2"] < \$map["P"]) {\$map["P"] = \$map["P2"]; \$map["I"] = \$map["I2"]; \$map["DESC"] = \$map["DESC2"]} \$map["P"] = 2 * \$map["P"] - \$map["P"] ** 2} {print}' | $smart_cut_cmd --in-delim $tab --exclude-col 0,1,'P2 I2 DESC2' --exact --require-col-match > !{output,,burden_testl_gassoc_file} !{input,pheno_is_trait_file} class_level burden_testl skip_if or,test_software:ne:pseq,!make_two_sided,exskipif run_with burden_test_variant_subset

!|expand:;:shortt;phenol;burdenl;burden_testl;exskipif:short;pheno;burden;burden_test;burden_test_variant_subset:local;pheno_variant_subset;burden_variant_subset;burden_test_variant_subset;!burden_test_variant_subset| \
local cmd ln_burden_testl_gassoc_file=ln -s !{input,,burden_testl_case_side_gassoc_file} !{output,,burden_testl_gassoc_file} !{input,pheno_is_trait_file} class_level burden_testl run_if or,test_software:ne:pseq,!make_two_sided skip_if exskipif run_with burden_test_variant_subset

consensus_transcript=NA

desc_header=DESC

short cmd make_burden_test_pseq_small_gassoc_file=$small_gassoc_helper1 --exec "$smart_cut_cmd --in-delim $tab !{input:--file:burden_test_gassoc_file} --select-col 1,1,'LOCUS TEST P DESC' --require-col-match --exact --exclude-row 1,1,LOCUS,$outside_gene_name" --multiple 2 | $small_gassoc_helper2 | $swap_name | awk -F"\t" -v OFS="\t" 'NR = 1 {print \$0,NS} NR > 1 {print \$0,"NA"}' | $small_gassoc_helper3 > !{output,,burden_test_small_gassoc_file} class_level burden_test run_if test_software:eq:pseq

swap_name=eval `(echo !{prop,,burden_test,test_name,uc=1} && echo !{prop,,burden_test,test_tag,missing_prop=test_name,uc=1}) | $transpose_cmd --out-delim $tab | sed "s;\(\S\S*\)\t\(\S\S*\).*;sed '1! s/\1/\2/';" | tr '\n' '|' | sed 's/|$//'`

small_gassoc_helper3=sed '1 s/\tNS/\t$n_col_disp/' | sed '1 s/\tPVALUE/\t$p_col_disp/' | sed '1 s/\tSEBETA/\t$se_col_disp/' | sed '1 s/\tBETA/\t$beta_col_disp/' | awk -F"\t" -v OFS="\t" 'NR == 1 {print \$0,"ID","$ref_col_disp","$alt_col_disp"} NR > 1 {print \$0,\$1" "\$2,"R","A"}'

short cmd make_burden_test_epacts_small_gassoc_file=$small_gassoc_helper1 --exec "$fill_file_helper_int(--exec 'cut -d_ -f2- !{input::burden_test_gassoc_file}',cut -d_ -f2- !{input::burden_test_gassoc_file},!{input::burden_epacts_group_file},NA,1,1,1,1,\t) | $smart_cut_cmd --in-delim $tab --select-col 0\,1\,'ID PVALUE NS ^(QSTAT|SCORE_TEST|STATRHO|BETA|SEBETA|OPT_FRAC_WITH_RARE|CONVERGED|muQ|RHO_EST)$' --require-col-match --exclude-row 0,1,ID,$outside_gene_name | awk -F\"\t\" -v OFS=\"\t\" 'NR == 1 {\\$1=\\$1\"\tTEST\"} NR > 1 && \\$1 != \"\" {\\$1=\\$1\"\t!{prop::burden_test:test_tag:missing_prop=test_name:uc=1}\"} \\$1 != \"\" {print}' | sed '1 s/PVALUE/$p_col_disp/' | awk -F\"\t\" -v OFS=\"\t\" 'NR == 1 {t=\\$NF; d=(t != \"BETA\" && t != \"SEBETA\")} NR == 1 && d {\\$NF=\"$desc_header\"} NR > 1 && d {\\$NF=t\"=\"\\$NF} {print}'" | $small_gassoc_helper2 | $small_gassoc_helper3 > !{output,,burden_test_small_gassoc_file} class_level burden_test run_if test_software:eq:epacts

short cmd make_burden_test_metal_small_gassoc_file=$smart_cut_cmd !{input,--file,burden_test_gassoc_file} --in-delim $tab --select-col 1,1,'MarkerName Allele1 Allele2 TotalSampleSize TotalEffectiveSampleSize Effect Zscore StdErr P-value Direction' --exact | awk -F"\t" -v OFS="\t" '{print \$1,\$0}' | sed '1 s/^MarkerName/GENE\tTRANSCRIPT/' | sed '1! s/ /\t/' | $replace_nan(NA) | awk -F"\t" -v OFS="\t" 'NR == 1 {\$1=\$1"\tTEST"} NR > 1 && \$1 != "" {\$1=\$1"\t!{prop::burden_test:test_tag:missing_prop=test_name:uc=1}"} \$1 != "" {print}' | sed '1 s/\tP-value/\t$p_col_disp/' | sed '1 s/\tTotalSampleSize/\t$n_col_disp/' | sed '1 s/\tAllele2/\t$ref_col_disp/' | sed '1 s/\tAllele1/\t$alt_col_disp/' | sed '1 s/\tStdErr/\t$se_col_disp/' | sed '1 s/\t!{raw,,burden_test,Effect,if_prop=metal_scheme:ne:SAMPLESIZE,allow_empty=1}!{raw,,burden_test,Zscore,if_prop=metal_scheme:eq:SAMPLESIZE,allow_empty=1}/\t$beta_col_disp/' | sed '1 s/MarkerName/$id_col_disp/' | sed '1 s/Direction/$dir_col_disp/' | $smart_cut_cmd --in-delim $tab --select-col 0,1,'GENE TRANSCRIPT TEST $n_col_disp $beta_col_disp !{raw,,burden_test,$se_col_disp,if_prop=metal_scheme:eq:STDERR,allow_empty=1} $p_col_disp $dir_col_disp $id_col_disp $ref_col_disp $alt_col_disp' --require-col-match --exact > !{output,,burden_test_small_gassoc_file} class_level burden_test run_if and,test_software:eq:metal,meta_trait_inv

short cmd make_burden_gassoc_file=cols=`perl -le 'foreach ("$id_col_disp","$alt_col_disp","$ref_col_disp") {\$m{"\$_"}=1} foreach (qw(!{input,,burden_test_small_gassoc_file})) {open IN, \$_ or die "Cannot open \$_"; \$header = <IN>; chomp(\$header); close IN; foreach \$v (split("\t", \$header)) {print \$v unless \$m{\$v}; \$m{\$v}=1}}'` && $smart_join_cmd --in-delim $tab --exec "head -n1 !{input,,burden_gassoc_counts_file} | cut -f1-2 && tail -qn+2 !{input,,burden_test_small_gassoc_file} | cut -f1-2 | sort -u | cat - !{input,,burden_gassoc_counts_file} | cut -f1-2 | sort | uniq -d | sed '1 s/LOCUS/TRANSCRIPT/'" !{input,--file,burden_gassoc_counts_file} --exec "$smart_cut_cmd !{raw;;burden_test;--exec \"$smart_cut_cmd --file *burden_test_small_gassoc_file --in-delim $tab --select-col 1-.,1,'\$cols' --fill-value NA\"} !{input,burden_test_small_gassoc_file} --in-delim $tab --exclude-row 2-.,1 --select-col 1-.,1,'\$cols' --require-col-match" --rest-extra 1 --header 1 --multiple 3 --col 1 --col 2 | $prepend_var_group > !{output,,burden_gassoc_file} class_level burden run_if burden_test

#!!expand:pathwayburdentype:custom! \
#local cmd make_burden_pathway_pathwayburdentype_gassoc_file=(head -qn+1 !{input,,burden_test_pathway_pathwayburdentype_gassoc_file,if_prop=test_software:eq:pseq,if_prop=test_software:eq:epacts,or_if_prop=1,limit=1} | head -n1 && tail -qn+2 !{input,,burden_test_pathway_pathwayburdentype_gassoc_file,if_prop=test_software:eq:pseq,if_prop=test_software:eq:epacts,or_if_prop=1}) | $prepend_var_group > !{output,,burden_pathway_pathwayburdentype_gassoc_file} class_level burden run_if burden_test skip_if !project_pathwayburdentype_locset_file

get_burden_flat_join_execs=`for f in !{prop,,burden_test,test_tag,missing_prop=test_name,uc=1}; do echo "--exec \"$smart_cut_cmd !{input,--file,@1} --tab-delim --select-row 1,1 --select-row 1,1,TEST,eq:\$f --select-col 1,'2 3' --select-col 1,1,'$beta_col_disp $desc_header P' --exact | sed '1 s/\S\S*\(\s\s*\)\S\S*\(\s\s*\)\S\S*$/\${f}_$beta_col_disp\t\${f}_DESC\1\$f/'\""; done | tr '\n' ' '`

summarize_gassoc_pvals=perl -pe 'chomp; if (++\$num == 1) {\$_ .= "\tP_MIN\tP_MEAN\tP_MEDIAN\n"; @pcols = (); @cols = split; for (my \$i = 0; \$i <= \$\#cols; \$i++) {foreach \$test (qw(!{prop,,burden_test,test_tag,if_prop=use_for_interesting,missing_prop=test_name,uc=1})) {push @pcols, \$i if \$cols[\$i] eq \$test}}} else {@a = split; \$min = 1; \$mean = 0; \$n = 0; @p_values = (); foreach \$col (@pcols) {my \$pval = \$a[\$col]; next if \$pval !~ /^[0-9\.e\-]+$/; \$min = \$pval if \$pval < \$min; \$n++; \$mean += \$pval; push @p_values, \$pval } if (\$n == 0) {\$mean = \$min = \$median = "NA"} else {\$mean /= \$n; \$median = "NA"; @p_values = sort {\$a <=> \$b} @p_values; \$ind = int((scalar @p_values) / 2); if ((scalar @p_values) % 2 == 0) {\$median = (\$p_values[\$ind] + \$p_values[\$ind - 1]) / 2} else {\$median = \$p_values[\$ind]}} \$_ .= "\t\$min\t\$mean\t\$median\n"}'

local cmd make_burden_flat_gassoc_file=f=$get_burden_flat_join_execs(burden_gassoc_file) && eval "$smart_join_cmd --in-delim $tab --header 1 --col 1 --col 2 !{input,--file,burden_gassoc_counts_file} \$f --fill-all" | $summarize_gassoc_pvals | $prepend_var_group > !{output,,burden_flat_gassoc_file} class_level burden run_if burden_test

gassoc_var_group_col=VAR_GROUP
prepend_var_group=sed '1 s/^/$gassoc_var_group_col\t/' | sed '1! s/^/!{prop,,burden,disp}\t/'

burden_interesting_variant_helper=$get_burden_all_vassoc_list(@6) | $smart_cut_cmd --in-delim $tab --require-col-match --exact --select-row 0,1 --select-row 0,1,MAF,le:!{prop,,burden,max_interesting_variant_maf} --select-row 0,1,MAC,ge:!{prop::burden:@5} !{raw,,burden,--select-row 0\,1\,P_MISSING\,ge:,unless_prop=pheno_qt,allow_empty=1}!{prop,,burden,@1,unless_prop=pheno_qt,allow_empty=1} --and-row-all | $smart_cut_cmd --in-delim $tab --require-col-match --exact !{raw;;pheno_test;--select-row 0,1,${p_col_disp}_\@test_tag,le:@2;if_prop=use_for_interesting} --select-col 0,1,'@3' --exclude-row 0,1 | sort | uniq -c | $smart_cut_cmd --out-delim $tab --select-row 0,1,ge:@4 --exclude-col 0,1 | sort -u 

short cmd make_burden_interesting_variant_genes_dat_file=for c in !{prop,,burden,max_interesting_variant_p_value},1 !{prop,,burden,interesting_variant_gene_combinations,if_prop=interesting_variant_gene_combinations,allow_empty=1}; do t=`echo \$c | cut -d, -f1` && n=`echo \$c | cut -d, -f2` && $burden_interesting_variant_helper(min_interesting_variant_p_missing_value,\$t,GENE,\$n,min_pheno_interesting_mac,); done | sort -u  > !{output,,burden_interesting_variant_genes_dat_file} class_level burden skip_if only_for_interesting


short cmd make_burden_interesting_genes_dat_file=$smart_join_cmd --in-delim $tab --exec "$smart_cut_cmd --in-delim $tab !{input,--file,burden_gassoc_file} --select-col 1,1,GENE  --exclude-row 1,1  | sort -u | $smart_cut_cmd --in-delim $tab !{input,--file,project_gene_target_file} --select-col 1,1 | sort | uniq -d | sed '1 s/^/GENE\n/'" --exec "$smart_cut_cmd --in-delim $tab !{input,--file,burden_gassoc_file} | cut -f2-" --header 1 --multiple 2 --extra 2 | $smart_cut_cmd --in-delim $tab --select-row 0,1 --select-row 0,1,TEST,'!{prop,,burden_test,test_tag,missing_prop=test_name,uc=1,if_prop=use_for_interesting}' | $smart_cut_cmd --in-delim $tab --select-row 0,1,P,lt:!{prop,,burden,max_interesting_gene_p_value,missing_key=default_max_interesting_gene_p_value} --select-col 0,1,P --select-col 0,1,GENE --out-delim $tab --require-col-match --exclude-row 0,1 --exact | sort -gk1 | cut -f2 | sort -u | $smart_cut_cmd --in-delim $tab --exec "cut -f1 !{input,,project_gene_target_file} | sort -u" | sort | uniq -d > !{output,,burden_interesting_genes_dat_file} class_level burden run_if burden_test skip_if only_for_interesting

local cmd make_empty_burden_interesting_genes_dat_file=echo > !{output,,burden_interesting_genes_dat_file} class_level burden skip_if burden_test run_if only_for_interesting

short cmd make_burden_interesting_gene_burdens_meta_file=if [[ `cat !{input,,pheno_interesting_genes_dat_file} | wc -l` -gt 0 ]]; then id="!{prop,,pheno}_gene_!{prop,,burden}" && echo "\$id class gene_burden" > !{output,,burden_interesting_gene_burdens_meta_file} && echo "\$id disp !{prop,,burden,disp}" >> !{output,,burden_interesting_gene_burdens_meta_file} && echo "\$id sort !{prop,,burden,sort}" >> !{output,,burden_interesting_gene_burdens_meta_file} >> !{output,,burden_interesting_gene_burdens_meta_file} && echo "\$id consistent !{prop,,burden}" >> !{output,,burden_interesting_gene_burdens_meta_file} && echo "\$id consistent !{prop,,annot}" >> !{output,,burden_interesting_gene_burdens_meta_file} !{raw,,burden,&& echo "\$id no_var_qq @no_var_qq" >> *burden_interesting_gene_burdens_meta_file,if_prop=no_var_qq,allow_empty=1}  !{raw,,burden,&& echo "\$id no_var_filter @no_var_filter" >> *burden_interesting_gene_burdens_meta_file,if_prop=no_var_filter,allow_empty=1} && $smart_join_cmd --exec "$smart_cut_cmd --in-delim $tab !{input,--file,burden_all_variant_list_file} !{input,--file,project_clean_gene_variant_file} --select-col 2,1,ID --exclude-row 2,1 | sort | uniq -d | sed '1 s/^/ID\n/'" --exec "$smart_cut_cmd !{input,--file,project_clean_gene_variant_file} --exact --require-col-match --in-delim $tab --select-col 1,1,'ID GENE'" --header 1 --rest-extra 1 --in-delim $tab | $smart_cut_cmd --in-delim $tab --exclude-row 0,1 --select-col 0,1,'GENE' | sort -u | cat - !{input,,pheno_interesting_genes_dat_file} | sort | uniq -d | perl -ne 'chomp; @a = split("\t"); $fix_gene_internal_id(\$a[0]); print "!select:!{prop,,project}:!{prop,,pheno} '"\$id"' parent $gene_internal_id(\$a[0])\n"' >> !{output,,burden_interesting_gene_burdens_meta_file}; else echo > !{output,,burden_interesting_gene_burdens_meta_file}; fi class_level burden skip_if or,not_trait,no_gene_burden

short cmd make_empty_burden_interesting_gene_burdens_meta_file=echo > !{output,,burden_interesting_gene_burdens_meta_file} class_level burden skip_if not_trait run_if no_gene_burden

short cmd make_burden_interesting_gene_variants_dat_file=v=!{prop,,burden,max_interesting_gene_variant_p_value} && $smart_join_cmd --exec "$burden_interesting_variant_helper(min_interesting_gene_variant_p_missing_value,\$v,GENE,1,min_pheno_gene_interesting_mac,\) | sort - !{input,,pheno_interesting_genes_dat_file} | uniq -d" --exec "$burden_interesting_variant_helper(min_interesting_gene_variant_p_missing_value,\$v,GENE ID,1,min_pheno_gene_interesting_mac,\)" --in-delim $tab --extra 2 --multiple 2 | cut -f2 > !{output,,burden_interesting_gene_variants_dat_file} class_level burden skip_if only_for_interesting

short cmd make_burden_all_interesting_gene_variants_dat_file=$smart_join_cmd --exec "$get_burden_all_vassoc_list(\) | $smart_cut_cmd --in-delim $tab --select-col 0,1,GENE --exclude-row 0,1 --exact --require-col-match | sort -u | $smart_cut_cmd --in-delim $tab !{input,--file,burden_interesting_genes_dat_file} | sort | uniq -d" --exec "$get_burden_all_vassoc_list(\) | $smart_cut_cmd --in-delim $tab --select-col 0,1,'GENE ID' --exclude-row 0,1 --exact --require-col-match" --in-delim $tab --multiple 2 --extra 2 | cut -f2 | sort -u > !{output,,burden_all_interesting_gene_variants_dat_file} class_level burden run_if and,all_variants_interesting,burden_test skip_if only_for_interesting

local cmd make_empty_burden_all_interesting_gene_variants_dat_file=rm -f !{output,,burden_all_interesting_gene_variants_dat_file} && touch !{output,,burden_all_interesting_gene_variants_dat_file} class_level burden skip_if or,(and,all_variants_interesting,burden_test),only_for_interesting

awk_normalize_sort=awk -v n=\$@1 -v OFS=\"\t\" '{print \\$1,\\$2\*n}'

subset_flat_gassoc_file=$smart_join_cmd --in-delim $tab --header 1 --exec @1"$smart_cut_cmd --in-delim $tab !{input,--file,burden_flat_gassoc_file} --select-col 1,2 --exclude-row 1,1 | sort -u | $smart_cut_cmd !{input,--file,project_gene_target_file}  --select-col 1,1 --exclude-row 1,1 | sort | uniq -d | sed '1 s/^/GENE\n/'@1" --exec @1"cut -f2- !{input,,burden_flat_gassoc_file}@1" --extra 2 --multiple 2

short cmd make_burden_gene_sort_values_file=a=`$subset_flat_gassoc_file() | wc -l` && b=`$get_burden_vassoc_file(vassoc,!{prop::burden:min_pheno_mac},gt:0,,) | tail -n+2 | wc -l` && $smart_cut_cmd --in-delim $tab --exec "$subset_flat_gassoc_file(\) | $smart_cut_cmd --in-delim $tab --exact --require-col-match --select-col 0,1,'GENE P_MIN' | tail -n+2 | $awk_normalize_sort(a)" --exec "$get_burden_vassoc_file(vassoc,!{prop::burden:min_pheno_mac},gt:0,,\) | $smart_cut_cmd --select-col 0,1,'GENE !{raw::pheno_test:${p_col_disp}_@test_tag:if_prop=use_for_interesting}' --exclude-row 0,1 !{raw;;pheno_test;--select-row 0,1,${p_col_disp}_@test_tag,ne:NA;if_prop=use_for_interesting} --in-delim $tab --exact --require-col-match | $awk_normalize_sort(b)" | awk '\$1 != "$outside_gene_name"' > !{output,,burden_gene_sort_values_file} class_level burden run_if burden_test skip_if only_for_interesting


#awk '{print "chr"\$1":"\$2}' !{input,,burdenl_chr_pos_var_list_file} | sed 's/^chrchr/chr/' > !{output,,burdenl_reg_list_file} class_level burdenl exrunif

#!|expand:;:burdenl;exrunif:burden;run_if or,annot_genes,annot_manual_gene_list_file,!num_var_subsets:burden_variant_subset;run_if and,!annot_genes,!annot_manual_gene_list_file,num_var_subsets| \
#local cmd make_burdenl_score_seq_map_file=cat !{input,,burdenl_chr_pos_var_list_file} | $add_gene_annot_cmd --in-delim $tab --print-multiple --chr-col 1 --pos-col 2 --gene-file !{input,,project_gene_target_file} --out-delim $tab | cut -f1,4 > !{output,,burdenl_score_seq_map_file} class_level burdenl exrunif

!!expand:;:btype;exskipif\
:gassoc_counts_data_file;\
:locdb_detail_reg_file;\
!\
local cmd make_cat_burden_btype=(head -qn+1 !{input,,burden_variant_subset_btype,limit=1,unless_prop=annot_manual_variant_list_file,allow_empty=1} !{input,,burden_variant_subset_btype,if_prop=annot_manual_variant_list_file,allow_empty=1} | awk 'NR == 1' && tail -qn+2 !{input,,burden_variant_subset_btype}) !{input,pheno_is_trait_file} > !{output,,burden_btype} class_level burden run_if burden_variant_subset exskipif run_with burden_variant_subset

fix_overlap_bug2=| awk -F"\t" '{split(\$4, a, "_")} !m[a[2]] {m[a[2]]=1; print}'

!|expand%;%btype;exskipif\
%case_side_gassoc_file;\
%control_side_gassoc_file;\
%gassoc_file;\
|\
local cmd make_cat_burden_test_btype=(head -qn+1 !{input,,burden_test_variant_subset_btype,limit=1} | head -n1 && tail -qn+2 !{input,,burden_test_variant_subset_btype}) !{input,pheno_is_trait_file} > !{output,,burden_test_btype} class_level burden_test run_if burden_test_variant_subset exskipif run_with burden_test_variant_subset

!!expand:;:atype\
:all_variant_list_file\
:annot_variant_list_file\
:non_annot_variant_list_file\
:epacts_group_file\
:setid_file\
!\
local cmd make_cat_no_head_annot_atype=cat !{input,,annot_variant_subset_atype} > !{output,,annot_atype} class_level annot run_if annot_variant_subset run_with annot_variant_subset

!!expand:;:atype\
:locdb_detail_reg_file\
!\
local cmd make_cat_annot_atype=(head -qn+1 !{input,,annot_variant_subset_atype,limit=1,unless_prop=annot_manual_variant_list_file,allow_empty=1} !{input,,annot_variant_subset_atype,if_prop=annot_manual_variant_list_file,allow_empty=1} | awk 'NR == 1' && tail -qn+2 !{input,,annot_variant_subset_atype}) > !{output,,annot_atype} class_level annot run_if annot_variant_subset run_with annot_variant_subset

!!expand:;:btype;exskipif;extracmd\
:non_annot_variant_list_file;skip_if only_for_interesting;\
:all_variant_list_file;skip_if only_for_interesting;\
:epacts_group_file;;\
:setid_file;;\
:regex_file;;| sort -u\
!\
local cmd make_cat_no_head_burden_btype=cat !{input,,burden_variant_subset_btype} !{input,pheno_is_trait_file} extracmd > !{output,,burden_btype} class_level burden run_if burden_variant_subset exskipif run_with burden_variant_subset

max_gassoc_points=5000

missing_key=default_major_burden_tests

prop burden_qq_min_mac=scalar default 10


burden_gassoc_qq_pdf_helper=$draw_qq_plot_cmd !{input,,@1} !{output,,@2}  @3 value.col=`perl -e 'print join(",", qw(!{prop,,burden_test,test_tag,if_prop=use_for_display,missing_prop=test_name,uc=1}))'` confidence.intervals=TRUE do.unif=TRUE nrow=1 ncol=1 sep=$tab plot.type=b max.plot.points=$max_gassoc_points shade.col=NVAR filter.col=MAC filter.value=">$((!{prop,,burden,burden_qq_min_mac}-1))"

local cmd make_burden_gassoc_qq_pdf_file=$burden_gassoc_qq_pdf_helper(burden_flat_gassoc_file,burden_gassoc_qq_pdf_file,'QC Plus Gene Associations for !{prop\,\,burden\,disp} variants: !{prop\,\,pheno\,disp}') class_level burden skip_if or,not_trait,no_gene_qq run_if burden_test

max_vassoc_points=10000
vassoc_qq_common_maf_threshold=.05
vassoc_qq_discrete_mac_threshold=15
exome_qq_perm=15
small_qq_perm=75

prop calibrate_qq=scalar

burden_vassoc_qq_pdf_helper=$draw_qq_plot_cmd @1 !{output,,@2} @3 value.col=`perl -e 'print join(",", qw(!{raw::pheno_test:${p_col_disp}_\@test_tag:if_prop=use_for_display}))'` do.unif=TRUE sep=$tab max.plot.points=$max_vassoc_points confidence.intervals=TRUE plot.type= shade.col=MAF !{raw,,@4,count.col\=MAC freq.col\=CASEF tot.col\=OBS_HAP p.type\=OR,if_prop=calibrate_qq,allow_empty=1} !{raw,n.perm=,pheno,$exome_qq_perm,if_prop=whole_exome,allow_empty=1} !{raw,n.perm=,pheno,$small_qq_perm,unless_prop=whole_exome,if_prop=calibrate_qq,allow_empty=1} main.cex=.85 @5

get_burden_vassoc_list_helper=$smart_join_cmd --header 1 --in-delim $tab --exec 'cut -f1 !{input,,@1} | tail -n+2 | sort - !{input,,@2} | uniq -d | $add_header_cmd ID' !{input,--file,@1} --rest-extra 1

get_burden_all_vassoc_list=$get_burden_vassoc_list_helper(pheno_vassoc_annot_file,burden_all_variant_list_file)
get_burden_vassoc_list=$get_burden_vassoc_list_helper(pheno_vassoc_clean_annot_file,burden_clean_variant_list_file)

get_burden_non_top_vassoc_list=$smart_join_cmd --header 1 --in-delim $tab !{input,--file,pheno_vassoc_clean_annot_file} --exec "sort !{input,,burden_clean_variant_list_file} !{input,,pheno_top_hits_ld_seq_var_list} !{input,,pheno_top_hits_ld_seq_var_list} | uniq -u" --extra 1

get_vassoc_file_helper=| $add_function_cmd --in-delim $tab --header 1 --col1 OBSA --col2 OBSU --val-header OBST --type add | $add_function_cmd --in-delim $tab --header 1 --col1 OBSA --col2 OBST --val-header CASEF --type divide | $add_function_cmd --in-delim $tab --header 1 --col1 OBST --val2 2 --val-header OBS_HAP --type multiply | $add_function_cmd --in-delim $tab --header 1 --col1 MAF --val2 .5 --val-header MAF_DIFF --type subtract | $add_function_cmd --in-delim $tab --header 1 --col1 MAF_DIFF --val-header MAF_DIFF_ABS --type abs | $add_function_cmd --in-delim $tab --header 1 --val1 1 --col2 MAF_DIFF_ABS --val-header MAF_NORM --type subtract | $smart_cut_cmd --in-delim $tab --exact --and-row-all --select-row 0,1 --select-row 0,1,MAC,'ge:@1' --select-row 0,1,MAF,'@2' @3

get_burden_vassoc_file=${get_burden_@{1}_list}(@5) $get_vassoc_file_helper(@2,@3,@4,burden)
get_gene_vassoc_file=$smart_cut_cmd --in-delim $tab !{input,--file,pheno_vassoc_clean_annot_file} --select-row 1,1,GENE,!{prop,,gene,external_id} --select-row 1,1 $get_vassoc_file_helper(@1,@2,@3,gene)

!|expand;%;keytype%freqtype%minmac%mafselect%extraselect%disptitle\
;common%common%!{prop::burden:min_pheno_mac}%ge:$vassoc_qq_common_maf_threshold%%MAF > $vassoc_qq_common_maf_threshold\
;rare%rare%!{prop::burden:min_pheno_mac}%le:$vassoc_qq_common_maf_threshold%%MAC > !{prop::burden:min_pheno_mac}\, MAF < $vassoc_qq_common_maf_threshold\
;uncommon%uncommon%$vassoc_qq_discrete_mac_threshold%le:$vassoc_qq_common_maf_threshold%%MAC > $vassoc_qq_discrete_mac_threshold\, MAF < $vassoc_qq_common_maf_threshold| \
restart_mem short cmd make_burden_keytype_vassoc_qq_pdf_file=$get_burden_vassoc_file(vassoc,minmac,mafselect,extraselect,) | $burden_vassoc_qq_pdf_helper(/dev/stdin,burden_freqtype_vassoc_qq_pdf_file,'!{prop\,\,burden\,disp} variant associations for !{prop\,\,pheno\,disp}: disptitle',burden,) class_level burden skip_if no_var_qq

num_slide_unique=25
num_slide_associated=25

mac_qualifier=, MAC >= !{prop::burden:min_pheno_mac}

!~expand%@%keytype@numprop@mafprop@extraselect@titletext@extrarunif%\
common_vassoc@$num_slide_associated@ge:.05@@--- MAF > .05@or,max_associated_maf,burden_maf,burden_mac_ub%\
vassoc@$num_slide_associated@le:!{prop\\\,\\\,burden\\\,max_associated_maf\\\,missing=.05}@@!{raw,,burden,--- MAF < ,unless_prop=burden_maf,allow_empty=1}!{prop,,burden,max_associated_maf,missing=.05,unless_prop=burden_maf,allow_empty=1}$mac_qualifier@%\
unique@$num_slide_unique@.@| $smart_cut_cmd --in-delim $tab --select-row 0,1 --select-row 0,1,MAFA,0 --select-row 0,1,MAFU,0 --exact | awk -F"\t" -v OFS="\t" 'NR == 1 {for(i=1;i<=NF;i++) {m[\$i]=i}} {if (\$m["MAFA"] > \$m["MAFU"]) {v=\$m["MAFA"]} else {v=\$m["MAFU"]}} NR == 1 {print 2,\$0} NR > 1 {print v,\$0}' | sort -grk1 | cut -f2-@unique to cases or controls$mac_qualifier@~ \
short cmd make_burden_slide_keytype_tex_file=$pheno_slide_associated_variants_helper(.,.,.,mafprop,pheno_vassoc_clean_annot_file) | cat !{input,,burden_all_variant_list_file} - | awk 'NF == 1 { is_selected[\$1] = 1; h = 1; } NF > 1 && (h || is_selected[\$2]) {print; h=0}' extraselect | $head_cmd(numprop) | $translate_variant_type | $replace_var_id | $process_associated_variants_helper("Most associated !{prop,,burden,disp} variants titletext: !{prop,,pheno,disp}",7,,5,$vassoc_max_chars_per_col,2) > !{output,,burden_slide_keytype_tex_file} class_level burden skip_if extrarunifno_var_filter

!!expand:keytype:common_vassoc:vassoc:unique:common_vassoc_meta_trait:vassoc_meta_trait:unique_meta_trait! \
local cmd make_burden_slide_keytype_pdf_file=$run_latex_cmd(burden_slide_keytype_tex_file,burden_slide_keytype_pdf_file) class_level burden


!~expand%@%keytype@numprop@mafprop@extraselect@titletext@extrarunif%\
common_vassoc@$num_slide_associated@ge:.05@@--- MAF > .05@or,max_associated_maf,burden_maf,burden_mac_ub,%\
vassoc@$num_slide_associated@le:!{prop\\,\\,burden\\,max_associated_maf\\,missing=.05}@@!{raw,,burden,--- MAF < ,unless_prop=burden_maf,allow_empty=1}!{prop,,burden,max_associated_maf,missing=.05,unless_prop=burden_maf,allow_empty=1}$mac_qualifier@%\
unique@$num_slide_unique@.@| $smart_cut_cmd --in-delim $tab --select-row 0,1 --select-row 0,1,MAFA,0 --select-row 0,1,MAFU,0 --exact | awk -F"\t" -v OFS="\t" 'NR == 1 {for(i=1;i<=NF;i++) {m[\$i]=i}} {if (\$m["MAFA"] > \$m["MAFU"]) {v=\$m["MAFA"]} else {v=\$m["MAFU"]}} NR == 1 {print 2,\$0} NR > 1 {print v,\$0}' | sort -grk1 | cut -f2-@unique to cases or controls$mac_qualifier@~ \
short cmd make_burden_slide_keytype_meta_trait_tex_file=$pheno_slide_variants_helper(.,.,.,.*,,!{raw::pheno_test:${p_col_disp}_@test_tag:if_prop=use_for_display:limit=1}_!{prop::pheno:disp},mafprop,pheno_meta_trait_vassoc_annot_file,,!{prop::burden:min_pheno_mac}) | cat !{input,,burden_all_variant_list_file} - | awk 'NF == 1 { is_selected[\$1] = 1; h = 1; } NF > 1 && (h || is_selected[\$1]) {print; h=0}' extraselect | $head_cmd(numprop) | $translate_variant_type | $replace_var_id | $transpose_cmd --in-delim $tab | $smart_cut_cmd --in-delim $tab --vec-delim @ --select-row 0,1,CLOSEST_GENE --select-row 0,1,ID --select-row 0,1,'^(!{prop,,pheno,vassoc_meta_disp,sep=|})$' --select-row 0,1,'eq:${or_col_disp_pheno_test}_!{prop::pheno:disp}' --select-row 0,1,'eq:!{raw::pheno_test:${p_col_disp}_@{test_tag}:limit=1}_!{prop::pheno:disp}' !{raw;;pheno;--select-row 0,1,"^(`head -n1 *pheno_small_vassoc_annot_file | rev | cut -f1-2 | rev | sed 's/^/MAF\t/' | sed 's/\(\S\S*\)/\1_@disp/g' | sed 's/)/\\\\)/g' | sed 's/(/\\\\(/g' | sed 's/\t/\|/g'`)$";all_instances=1;if_prop=pheno:eq:@meta_trait_inv;if_prop=project:eq:@project} | sed 's/^\([^\t][^\t]*\)/\1\t\1/' | sed 's/^[^\t][^\t]*\(\s\s*\)\([^\t][^\t]*\)_\(!{prop,,pheno,disp}\)\t/\3\1\2\t/' !{raw;;pheno;| sed 's/^[^\t][^\t]*\(\s\s*\)\([^\t][^\t]*\)_\(@disp\)\t/\3\1\2\t/';all_instances=1;if_prop=pheno:eq:@meta_trait_inv;if_prop=project:eq:@project} |  $transpose_cmd --in-delim $tab | $smart_cut_cmd --in-delim $tab | $swap_header(!{prop::pheno:vassoc_meta_disp} ID CLOSEST_GENE,!{prop::pheno:vassoc_meta_headers} Variant Gene,1\,2) | $translate_variant_type | $replace_var_id | $replace_nan(-) | $format_columns_cmd --in-delim $tab --number-format %.2g | $table_to_beamer_cmd --allow-breaks --font-size 8pt --auto-dim --bottom-margin 0in --left-margin 0in --right-margin -in --title "Most associated !{prop,,burden,disp} variants titletext: !{prop,,pheno,disp}" --in-delim $tab --header-rows 2 --multi-row .,2 --multi-col 1-2 > !{output,,burden_slide_keytype_meta_trait_tex_file} class_level burden run_if meta_trait_inv skip_if extrarunifno_var_filter

max_dist_per_gene=7
num_slide_associated_gene=25

associated_genes_tex_select_helper=--select-col @1,1,'P_MIN GENE TRANSCRIPT' --exact --select-col @1,1,'!{prop,,burden_test,test_tag,missing_prop=test_name,if_prop=use_for_display,uc=1} $gassoc_mina_minu $gassoc_dist'

associated_genes_top_helper=$smart_cut_cmd --in-delim $tab !{input,--file,burden_flat_gassoc_file} --exclude-row 1,1 --select-col 1,1,@1 !{input,--file,burden_flat_gassoc_file} $associated_genes_tex_select_helper(2) --exclude-row 2,1 --paste | sort -gk1 | cut -f2- | awk '\$1 ~ /^[0-9\.\-e]+$/' | awk -F$tab '{k=\$2":"\$NF} !m[k] {print; m[k]=1}' | $head_cmd($num_slide_associated_gene)

format_gene_dists=perl -ne 'chomp; @a = split("\t"); \$dist_ind = \$\#a; %dists = (); @dists = split(";", \$a[\$dist_ind]); \$count_a = 0; \$count_u = 0; foreach \$dist (@dists) {next unless \$dist =~ /^([0-9]+)\/([0-9]+)(\(([0-9]+)\))?/; \$c=\$4; \$c = 1 unless defined \$c; \$obs_a = \$1 * \$c; \$obs_u = \$2 * \$c; \$count_a += \$obs_a; \$count_u += \$obs_u; \$tot = \$obs_a + \$obs_u; next unless \$tot > 0; \$frac_a = \$a[1] / (\$a[1] + \$a[2]); \$exp_a = \$tot * \$frac_a; \$exp_u = \$tot * (1 - \$frac_a); if (\$exp_a == 0 || \$exp_u == 0) {\$stat = 0} else {\$stat = ((\$obs_a - \$exp_a)\*\*2 / (\$exp_a) + (\$obs_u - \$exp_u)\*\*2 / (\$exp_u));} \$dists{\$dist} = \$stat} @new_dist = (); \$num = 0; foreach \$dist (sort {\$dists{\$b} <=> \$dists{\$a}} keys %dists) {last if ++\$num > $max_dist_per_gene; push @new_dist, \$dist} \$a[\$dist_ind] = join(";", @new_dist); \$a[\$dist_ind] .= "..." if \$num > $max_dist_per_gene; print join("\t", @a); print "\n"'

obs_mean_helper=f=`$table_sum_stats_cmd --in-delim $tab --out-delim $tab --col OBSA --col OBSU --has-header --print-header --summaries < !{input,,pheno_vassoc_annot_file} | $smart_cut_cmd --in-delim $tab --select-col 0,1,'$summary_mean(OBSA) $summary_mean(OBSU)' | tail -n+2`
short cmd make_burden_slide_gassoc_tex_file=$obs_mean_helper && $associated_genes_top_helper(P_MIN) | sort -gk1 | awk -v OFS="\t" '{tmp=\$2; \$2=\$1; \$1=tmp} {print}' | sed 's/^\(\S\S*\)/\1\t'"\$f"'/' | sort -t$tab -gk4 | cut -f4 --complement | $format_gene_dists | $smart_cut_cmd --in-delim $tab --exclude-col 0,'2 3' | $smart_cut_cmd --in-delim $tab --exec "$smart_cut_cmd --in-delim $tab !{input,--file,burden_flat_gassoc_file} --select-row 1,1 $associated_genes_tex_select_helper(1) | cut -f2-" | $format_columns_cmd --in-delim $tab --number-format %.3g | $table_to_beamer_cmd --allow-breaks --auto-dim --font-size 8pt --title "Most associated transcripts (1 per gene) --- !{prop,,burden,disp} variants: !{prop,,pheno,disp}" --in-delim $tab --header-rows 1 > !{output,,burden_slide_gassoc_tex_file} class_level burden run_if burden_test

#obs_mean_helper=$table_sum_stats_cmd --in-delim $tab --out-delim $tab --col @1 --has-header --print-header --summaries --group-col GENE < !{input,,pheno_vassoc_annot_file}
#local cmd make_burden_slide_gassoc_tex_file=$smart_join_cmd --in-delim $tab --header 1 --exec "$smart_cut_cmd --in-delim $tab --exec \"$obs_mean_helper(OBSA)\" --exec \"$obs_mean_helper(OBSU)\" --paste --select-col 1,1,'GENE $summary_mean(OBSA)' --select-col 2,1,$summary_mean(OBSU)" --exec "$smart_cut_cmd --in-delim $tab --exec \"$associated_genes_top_helper(P_MEAN)\" --exec \"$associated_genes_top_helper(P_MIN)\" --exec \"$associated_genes_top_helper(P_MEDIAN)\" | sort -u -gk1 | $smart_cut_cmd --in-delim $tab --exec \"$smart_cut_cmd --in-delim $tab !{input,--file,burden_flat_gassoc_file} --select-row 1,1 $associated_genes_tex_select_helper(1)\"" --extra 1 --col 2,2 | sort -t$tab -gk4 | cut -f4 --complement | $format_gene_dists | $smart_cut_cmd --in-delim $tab --exclude-col 0,1,'$summary_mean(OBSA) $summary_mean(OBSU)' | $format_columns_cmd --in-delim $tab --number-format %.3g | $table_to_beamer_cmd --allow-breaks --auto-dim --font-size 8pt --title "Most associated genes --- !{prop,,burden,disp} variants: !{prop,,pheno,disp}" --in-delim $tab --header-rows 1 > !{output,,burden_slide_gassoc_tex_file} class_level burden

local cmd make_burden_slide_gassoc_pdf_file=$run_latex_cmd(burden_slide_gassoc_tex_file,burden_slide_gassoc_pdf_file) class_level burden run_if burden_test

#cmd make_burden_haplotype_burden_files=$r_script_cmd($haplotype_burden_bin_dir/calc_haplotype_specific_burden.R) !{input,,pheno_haplotype_burden_input_list_file} !{input,locus_index_geno_counts_file} !{input,locus_strat_index_snp_file} !{input,locus_top_common_marker_pos_file} !{input,locus_all_seq_tped_file} !{input,locus_all_seq_tfam_file} !{input,locus_all_marker_tped_file} !{input,locus_all_marker_tfam_file} !{input,,pheno_marker_pheno_file} !{input,,burden_locdb_reg_file} !{output,,burden_haplotype_burden_locus_level_file} !{output,,burden_haplotype_burden_sum_file} !{output,,burden_haplotype_burden_pdf_file} !{output,,burden_haplotype_burden_rv_file} !{output,,burden_haplotype_burden_recessive_file} class_level burden run_if do_hap_burden skip_if pheno_qt


#region cmds

!!expand:rorl:region:locus! \
meta_table cmd make_rorl_range_info_file=!{prop,,rorl,rorl_range} !{output,rorl_range_info_file} class_level rorl

hap_geno=.05
hap_maf=.05

kb_range=--chr !{prop,,@1,chrom} --from-kb `perl -e 'print ((!{prop,,@1,@{1}_start} - @2) / 1000)'` --to-kb `perl -e 'print ((!{prop,,@1,@{1}_end} + @2) / 1000)'` 
cmd make_region_all_marker_plink_files=$plink_cmd $plink_in_bed_helper(project_all_marker) !{raw,--out,region,*region_all_marker_plink_file} !{output,region_all_marker_bed_file} !{output,region_all_marker_bim_file} !{output,region_all_marker_fam_file} --make-bed --geno $hap_geno $kb_range(region,1) && $plink_mv_log_cmd(!{raw\,\,region\,*region_all_marker_plink_file},!{output\,\,region_all_marker_make_bed_log_file}) !{input,region_range_info_file} class_level region

cmd make_region_all_marker_transposed_plink_files=$plink_cmd $plink_in_bed_helper(region_all_marker) !{raw,--out,region,*region_all_marker_plink_file} !{output,region_all_marker_tped_file} !{output,region_all_marker_tfam_file} --transpose --recode && $plink_mv_log_cmd(!{raw\,\,region\,*region_all_marker_plink_file},!{output\,\,region_all_marker_recode_log_file}) class_level region

#depends on tfam file in order to prevent running at same time and thus overwriting the log file
cmd make_region_all_marker_freq_file=$plink_cmd $plink_in_bed_helper(region_all_marker) --freq !{raw,--out,region,*region_all_marker_plink_file} !{output,region_all_marker_freq_file} && $plink_mv_log_cmd(!{raw\,\,region\,*region_all_marker_plink_file},!{output\,\,region_all_marker_freq_log_file}) !{input,region_all_marker_tfam_file} class_level region

local cmd make_region_rare_marker_snp_list=$smart_cut_cmd !{input,--file,region_all_marker_freq_file} --select-row 1,1,MAF,lt:$hap_maf --select-col 1,1,SNP > !{output,,region_rare_marker_snp_list} class_level region

cmd make_region_common_marker_transposed_plink_files=$plink_cmd $plink_in_bed_helper(region_all_marker) !{raw,--out,region,*region_common_marker_plink_file} !{output,region_common_marker_tped_file} !{output,region_common_marker_tfam_file} !{input,--exclude,region_rare_marker_snp_list} --transpose --recode && $plink_mv_log_cmd(!{raw\,\,region\,*region_common_marker_plink_file},!{output\,\,region_common_marker_recode_log_file}) class_level region

pseq_region_variant_cmd=$pseq_qc_plus_analysis_cmd(@1) --mask reg.req=!{prop,,region,ref_chrom}:!{prop,,region,region_start}..!{prop,,region,region_end} !{input,region_range_info_file} 

local cmd make_region_all_seq_plink_files=$plink_cmd $plink_in_bed_helper(project_plinkseq_qc_plus) $kb_range(region,1) --make-bed !{raw,--out,region,*region_all_seq_plink_file} !{output,region_all_seq_bim_file} !{output,region_all_seq_bed_file} !{output,region_all_seq_fam_file} && $plink_mv_log_cmd(!{raw\,\,region\,*region_all_seq_plink_file},!{output\,\,region_all_seq_make_bed_log_file}) class_level region

local cmd make_region_all_seq_transposed_plink_files=$plink_cmd $plink_in_bed_helper(region_all_seq) --recode --transpose !{raw,--out,region,*region_all_seq_plink_file} !{output,region_all_seq_tfam_file} !{output,region_all_seq_tped_file} && $plink_mv_log_cmd(!{raw\,\,region\,*region_all_seq_plink_file},!{output\,\,region_all_seq_recode_log_file}) class_level region

get_duplicated_variants=cat !{input,,region_all_seq_bim_file} !{input,,region_all_marker_bim_file} | awk '{print \$2,\$4}' | sort -sk2 | uniq -df1

#local cmd make_region_duplicate_marker_names_file=$get_duplicated_variants -D | perl -ne '@a = split; push @{\$h{\$a[1]}}, \$a[0]; END {foreach (keys %h) {print join("\t", @{\$h{\$_}}); print "\n"}}' > !{output,,region_duplicate_marker_names_file} class_level region

local cmd make_region_non_marker_seq_plink_file=$get_duplicated_variants | awk '{print \$1}' | $plink_cmd $plink_in_bed_helper(region_all_seq) --exclude /dev/stdin --make-bed !{raw,--out,region,*region_non_marker_seq_plink_file} !{output,region_non_marker_seq_bed_file} !{output,region_non_marker_seq_bim_file} !{output,region_non_marker_seq_fam_file} && $plink_mv_log_cmd(!{raw\,\,region\,*region_non_marker_seq_plink_file},!{output\,\,region_non_marker_seq_make_bed_log_file}) class_level region

local cmd make_region_combined_plink_files=$plink_cmd $plink_in_bed_helper(region_all_marker) !{input,--bmerge,region_non_marker_seq_bed_file} !{input,,region_non_marker_seq_bim_file} !{input,,region_non_marker_seq_fam_file} --transpose --recode !{raw,--out,region,*region_combined_plink_file} !{output,region_combined_tfam_file} !{output,region_combined_tped_file} && $plink_mv_log_cmd(!{raw\,\,region\,*region_combined_plink_file},!{output\,\,region_combined_merge_log_file}) class_level region

local cmd make_region_combined_plink_ped_files=$plink_cmd !{raw,--tfile,region,*region_combined_plink_file} !{input,region_combined_tfam_file} !{input,region_combined_tped_file} --recode !{raw,--out,region,*region_combined_plink_file} !{output,region_combined_ped_file} !{output,region_combined_map_file} && $plink_mv_log_cmd(!{raw\,\,region\,*region_combined_plink_file},!{output\,\,region_combined_transpose_log_file}) class_level region

local cmd make_region_combined_haploview_ped_file=awk '{\$6 = 0} {print}' !{input,,region_combined_ped_file} > !{output,,region_combined_haploview_ped_file} class_level region

combined_impute_helper=sort -nk4 !{input,,@{1}_@{2}_tped_file} | perl $targeted_bin_dir/plink_to_impute.pl --tped /dev/stdin !{input,--tfam,@{1}_@{2}_tfam_file} !{input,--sample-list,project_sample_marker_keep_file}

!|expand:;:cmdname;extra_cmd;whichplink:ref_;!{output,--out-strand,region_combined_strand_file};combined:;--exclude;all_marker| \
cmd make_region_combined_cmdnameimpute_files=$combined_impute_helper(region,whichplink) !{output,--out-genotype,region_combined_cmdnamegenotype_file} extra_cmd class_level region

Ne=11418
#set to zero b/c region start already includes a buffer
impute_window=0
cmd make_region_all_variant_impute2_file=$impute2_cmd -m $genetic_map_file("!{prop,,region,chrom}") !{input,-g_ref,region_combined_ref_genotype_file} !{input,-strand_g_ref,region_combined_strand_file} !{input,-g,region_combined_genotype_file} !{input,-strand_g,region_combined_strand_file} -int `perl -e 'print !{prop,,region,region_start} - $impute_window'` `perl -e 'print !{prop,,region,region_end} + $impute_window'` -Ne $Ne -allow_large_regions !{input,-exclude_snps_g,region_rare_marker_snp_list} !{input,-exclude_snps_g_ref,region_rare_marker_snp_list} -impute_excluded !{output,-o,region_combined_impute2_file} !{output,region_combined_impute2_info_file} !{output,region_combined_impute2_info_by_sample_file} !{output,region_combined_impute2_summary_file} !{input,region_range_info_file} !{output,region_combined_impute2_warnings_file} > /dev/null class_level region


cmd make_region_combined_merged_impute2_file=$smart_join_cmd !{input,--file,region_combined_impute2_file} !{input,--file,region_combined_genotype_file} --merge --col 3 | awk '{\$3=\$3" "\$1} {\$1=""} {print}' | sed 's/^\s*//' > !{output,,region_combined_merged_impute2_file} class_level region

beagle_window=0
cmd make_region_beagle_input_file=perl $targeted_bin_dir/make_hap_analysis_beagle_file.pl !{prop,--chr,region,chrom} !{prop,--start,region,region_start} !{prop,--end,region,region_end} --window $beagle_window !{input,--tfam,region_common_marker_tfam_file} !{input,--tped,region_common_marker_tped_file} > !{output,,region_beagle_input_file} !{input,region_range_info_file} class_level region

cmd make_region_beagle_output_files=java -Xmx$beagle_mem -jar $beagle_jar !{input,unphased=,region_beagle_input_file} !{output,out=,region_beagle_phased_gz_file} !{output,region_beagle_phased_gz_log_file} !{output,region_beagle_gprobs_gz_file} !{output,region_beagle_r2_file} nsamples=$nsamples omitprefix=$omitprefix missing=$beagle_missing class_level region

!!expand:btype:phased:gprobs! \
local cmd make_region_btype_file=gunzip -c !{input,,region_beagle_btype_gz_file} > !{output,,region_beagle_btype_file} class_level region

local cmd make_region_haploview_info_file=$smart_cut_cmd !{input,--file,region_combined_map_file} --select-col 1,'2 4' > !{output,,region_haploview_info_file} class_level region

cmd make_region_haploview_ld_file=rm -f !{output,,region_haploview_ld_file} && java -Xmx$haploview_mem -jar $haploview_jar -nogui !{input,-pedfile,region_combined_haploview_ped_file} !{input,-info,region_haploview_info_file} -dprime !{raw,-out,region,*region_haploview_ld_trunk} !{output,region_haploview_ld_file} -skipcheck && ls !{output,,region_haploview_ld_file} class_level region

#locus cmds

#to generate symbolic links

!!expand:filenamesuffix:\
all_marker_bed_file:\
all_marker_bim_file:\
all_marker_fam_file:\
all_marker_tfam_file:\
all_marker_tped_file:\
common_marker_tped_file:\
common_marker_tfam_file:\
all_seq_bed_file:\
all_seq_bim_file:\
all_seq_fam_file:\
all_seq_tfam_file:\
all_seq_tped_file:\
non_marker_seq_bed_file:\
non_marker_seq_bim_file:\
non_marker_seq_fam_file:\
duplicate_marker_names_file:\
combined_tped_file:\
combined_tfam_file:\
combined_ped_file:\
combined_map_file:\
combined_haploview_ped_file:\
haploview_info_file:\
haploview_ld_file:\
beagle_gprobs_gz_file:\
beagle_gprobs_file:\
beagle_phased_gz_file:\
beagle_phased_file:\
beagle_phased_gz_log_file:\
beagle_phased_file:\
beagle_r2_file:\
combined_ref_genotype_file:\
combined_strand_file:\
combined_genotype_file:\
combined_impute2_info_file:\
combined_impute2_info_by_sample_file:\
combined_impute2_summary_file:\
combined_impute2_warnings_file:\
combined_impute2_file:\
combined_merged_impute2_file!\
local cmd ln_locus_filenamesuffix=rm -f !{output,,locus_filenamesuffix} && ln -s !{input,,region_filenamesuffix,if_prop=region_range:eq:@locus_range} !{output,,locus_filenamesuffix}  !{input,locus_range_info_file} class_level locus

!|expand:;:cmdname;extra_cmd;whichplink:ref_;;combined:;--exclude;all_marker| \
cmd make_locus_combined_cmdnameimpute_sample_file=$combined_impute_helper(locus,whichplink) !{input,--pheno-file,pheno_marker_pheno_file,if_prop=project_all_marker_pheno_file,if_prop=pheno_marker_initial_pheno_file,or_if_prop=1,allow_empty=1} !{prop,--pheno-name,pheno} !{input,--extra-covars,project_all_marker_assoc_covars_file,if_prop=project_all_marker_assoc_covars_file,allow_empty=1} !{output,--out-sample,locus_combined_cmdnamesample_file} extra_cmd class_level locus

impute_method=score
prop use_covars=list
cmd make_locus_combined_snptest_out_file=$snptest_cmd -data !{input,,locus_combined_merged_impute2_file} !{input,,locus_combined_sample_file} !{output,-o,locus_combined_snptest_out_file} !{raw,-cov_names,locus,,if_prop=use_covars,allow_empty=1} !{prop,,locus,use_covars,if_prop=use_covars,allow_empty=1} !{raw,-cov_all,locus,,unless_prop=use_covars,allow_empty=1} -frequentist 1 -method $impute_method !{prop,-pheno,pheno} > !{output,,locus_combined_snptest_log_file} class_level locus

snptest_pvalue_col=!{prop,,pheno}_frequentist_add.\*score_pvalue

locus_chrom_selector=--select-row @1,1,@2,!{prop,,locus,chrom} --exact !{input,locus_range_info_file}
locus_pos_selector=--select-row @1,1,@2,ge:!{prop,,locus,locus_start} --select-row @1,1,@2,le:!{prop,,locus,locus_end} --and-row-all !{input,locus_range_info_file}
locus_range_selector=--select-row @1,1,@2,ge:`tail -n+2 !{input,,locus_gene_target_file} | sort -nk2 | head -n1 | awk '{print \$2 - $locus_range_buffer}'` --select-row @1,1,@2,le:`tail -n+2 !{input,,locus_gene_target_file} | sort -nrk2 | head -n1 | awk '{print \$2 + $locus_range_buffer}'` --and-row-all

!|expand:;:extraname;extraexec;skiporrunif:\
with_pvalues;--exec \"$smart_cut_cmd !{input,--file,pheno_all_marker_snp_pvalues_file} $locus_chrom_selector(1,CHROM) $locus_pos_selector(1,POS)  --exact --require-col-match --exclude-row 1,1 --select-col 1,1,'POS P'\";run_if:\
without_pvalues;;skip_if| \
cmd make_locus_combined_association_scores_file_extraname=$smart_join_cmd --in-delim $tab \
  --exec "$smart_cut_cmd --out-delim $tab !{input,--file,locus_all_marker_bim_file} --select-col 1,4 !{input,--file,locus_combined_snptest_out_file} --exclude-row 2,1 --select-col 2,1,pos --exact --require-col-match | sort | uniq -d" \
  --exec "$smart_cut_cmd --out-delim $tab !{input,--file,locus_combined_snptest_out_file} --exclude-row 1,1 --select-col 1,1,'pos rsid all_maf' --exact --require-col-match" \
  --exec "$smart_cut_cmd --out-delim $tab extraexec --exec \"$smart_cut_cmd !{input,--file,locus_combined_snptest_out_file} --select-col 1,1,'pos $snptest_pvalue_col' $locus_pos_selector(1,pos) --exact --require-col-match --exclude-row 1,1\" !{input,locus_range_info_file} | awk 'seen[\\$1] != 1 {print} {seen[\\$1] = 1}'" --extra 2 --extra 3 | sed '1 s/^/POS\tSNP\tMAF\tP\n/' | $smart_cut_cmd --in-delim $tab $locus_range_selector(0,POS) --select-row 0,1 > !{output,,locus_combined_association_scores_file} class_level locus skiporrunif pheno_all_marker_snp_pvalues_file

!!expand:curpheno:case:control! \
cmd make_locus_curpheno_position_coverage_file=(for f in `cat !{input,,pheno_curpheno_sample_coverage_file_list,is_list=1}`; do zcat \$f | tail -n+2; done) | sed 's/^chr//' | sed 's/^\(\S*\):\(\S\S*\)/\1\t\2/' | awk -v OFS="\t" '\$1 == !{prop,,locus,chrom} && \$2 >= !{prop,,locus,locus_start} && \$2 <= !{prop,,locus,locus_end} {print \$1,\$2,\$3}' | sort | $table_sum_stats_cmd --in-delim $tab --group-col 1 --group-col 2 --col 3 --summaries --threshold $threshold --out-delim $tab --print-header --groups-sorted  > !{output,,locus_curpheno_position_coverage_file} !{input,locus_range_info_file} class_level locus skip_if no_coverage

local cmd make_locus_exon_target_file=awk -v OFS="\t" -v chrom="!{prop,,locus,ref_chrom}" -v start=!{prop,,locus,locus_start} -v end=!{prop,,locus,locus_end} -F"\t" 'BEGIN {print "EXON","START","END"} \$3 == chrom && ((\$4 >= start && \$4 <= end) || (\$5 >= start && \$5 <= end)) {print \$2,\$4,\$5}' !{input,,project_expanded_exon_target_file} !{input,locus_range_info_file} > !{output,,locus_exon_target_file} class_level locus

local cmd make_locus_gene_target_file=awk -v OFS="\t" -v chrom="!{prop,,locus,ref_chrom}" -v start=!{prop,,locus,locus_start} -v end=!{prop,,locus,locus_end} -F"\t" 'BEGIN {print "GENE","START","STOP"} \$2 == chrom && ((\$3 >= start && \$3 <= end) || (\$3 >= start && \$3 <= end)) {print \$1,\$3,\$4}' !{input,,project_gene_target_file} !{input,locus_range_info_file} > !{output,,locus_gene_target_file} class_level locus

short cmd make_locus_var_counts_dat_file=$var_counts_dat_helper($locus_var_counts_selector) > !{output,,locus_var_counts_dat_file} class_level locus

local cmd make_locus_burden_dat_file=$smart_join_cmd --exec "$smart_cut_cmd --in-delim $tab !{input,--file,locus_gene_target_file} --exec \"$smart_cut_cmd --in-delim $tab !{input,--file,pheno_gassoc_file} --exclude-row 1,1 --select-col 1,1,GENE | sort -u\" --exclude-row 1,1 --select-col 1,1,GENE --exact --require-col-match | sort | uniq -d | sed '1 s/^/GENE\n/'" !{input,--file,locus_gene_target_file} !{input,--file,pheno_gassoc_file} --in-delim $tab --header 1 --col 3,2 --extra 2 --extra 3 --multiple 3 | awk '{print} END {if (NR == 0) {print "GENE\tSTART\tSTOP\tTEST\tVAR_GROUP\tP"}}' | $smart_cut_cmd --in-delim $tab --select-col 0,1,'GENE START STOP TEST VAR_GROUP P' --select-row 0,1,TEST,'!{prop,,burden_test,test_tag,missing_prop=test_name,uc=1}' --select-row 0,1 --exact --require-col-match > !{output,,locus_burden_dat_file} class_level locus

local cmd make_locus_var_coverage_pdf_file=$var_coverage_helper(locus,var_coverage,,) !{input,gene.position.file=,locus_gene_target_file} !{input,burden.file=,locus_burden_dat_file} num.shading=2 frac.spacing=.05 width=`perl -le '\$ngenes = \`cat !{input,,locus_gene_target_file} | cut -f1 | sort -u | wc -l\`; if (\$ngenes <= 2) {print 8} else {print 4 + 2 * \$ngenes}'`  class_level locus skip_if no_coverage

locus_range_buffer=250000

top_common_marker_maf=.05

!!expand:,:snporpos,colnum1,colnum2:snp,2,3:pos,1,2! \
!^expand:;:extraname;extraexec;skiporrunif:\
with_tophits;--exec "$smart_join_cmd --exec \"$smart_cut_cmd !{input,--file,pheno_all_marker_top_hits_file} $locus_chrom_selector(1,CHROM) --exclude-row 1,1 --and-row-all $locus_pos_selector(1,POS) --select-col 1,1,POS | $smart_cut_cmd !{input,--file,locus_combined_tped_file} --select-col 1,4 | sort | uniq -d\" --exec \"$smart_cut_cmd --out-delim $tab !{input,--file,locus_combined_tped_file} --select-col 1,'4 2'\" --extra 2 --in-delim $tab | cut -fcolnum1";run_if:\
without_tophits;;skip_if^ \
local cmd make_locus_top_common_marker_snporpos_file_extraname=$smart_cut_cmd extraexec --exec "$smart_cut_cmd !{input,--file,locus_combined_association_scores_file} --exclude-row 1,1 --select-row 1,1,MAF,ge:$top_common_marker_maf $locus_range_selector(1,POS) --select-col 1,1,'P POS SNP' --exact --require-col-match --out-delim $tab | sort -gk1 | cut -fcolnum2" | awk 'NR == 1' > !{output,,locus_top_common_marker_snporpos_file} class_level locus skiporrunif pheno_all_marker_top_hits_file


ld_window_params=--ld-window-r2 0 --ld-window 1000000000 --ld-window-kb 300000

local cmd make_locus_r2_ld_file=$plink_cmd !{raw,--tfile,locus,*locus_combined_plink_file} !{input,locus_combined_tped_file} !{input,locus_combined_tfam_file} --ld-snp `cat !{input,,locus_top_common_marker_snp_file}` --r2 $ld_window_params !{raw,--out,locus,*locus_r2_trunk} !{output,locus_r2_ld_file} !{output,locus_r2_ld_log_file} class_level locus

cmd make_locus_haploview_marker_ld_file=$smart_join_cmd !{input,--file,locus_top_common_marker_snp_file} --exec "$smart_cut_cmd !{input,--file,locus_haploview_ld_file} --exec \"awk -F $tab -v OFS=$tab '{temp=\\\\$1; \\\\$1=\\\\$2; \\\\$2=temp} {print}' < !{input,,locus_haploview_ld_file}\" --exclude-row 2,1 | $smart_cut_cmd --exclude-row 0,1 --vec-delim : --select-col 0,1,L1:L2:D.:r.. --exact --require-col-match" --extra 2 --multiple 2 | cut -f2- | cat - !{input,,locus_haploview_info_file} | awk -v OFS=$tab 'NF==2 {\$2="NA\tNA"} !map[\$1] {print} {map[\$1]=1}' | sed '1 s/^/SNP\tDprime\tr2\n/' > !{output,,locus_haploview_marker_ld_file} class_level locus

get_associated_marker_variants=$smart_cut_cmd !{input,--file,locus_combined_association_scores_file} --out-delim $tab --select-col 1,1,'POS P' --exact --require-col-match | $smart_cut_cmd --in-delim $tab --select-row 0,2,ge:0 --exclude-row 0,1

get_associated_seq_variants=cat !{input,,locus_var_counts_dat_file} | $smart_cut_cmd --in-delim $tab --select-col 0,1,'POS P' --exact --require-col-match --exclude-row 0,1

seq_type=Sequence
marker_type=Marker

locus_fancy_plot_dat_helper=$smart_join_cmd --in-delim $tab --header 1 --exec \"$smart_cut_cmd !{input,--file,locus_@{1}_bim_file} --select-col 1,4 --exec \\\"${@2} | cut -f1\\\" !{input,--file,locus_r2_ld_file} --select-col 3,1,'BP_B' | sort | uniq -c | awk '\\\\$1 == 3 {print \\\\$2}' | sed '1 s/^/POS\n/'\" --exec \"${@2} | sed 's/$/\t@3/' | sed '1 s/^/POS\tPVAL\tTYPE\n/'\" --exec \"$smart_cut_cmd !{input,--file,locus_r2_ld_file} --out-delim $tab --exact --require-col-match --select-col 1,1,'BP_B R2 SNP_B' | sed '1 s/SNP_B/SNP/' | sed '1 s/R2/RSQR/'\" --extra 2 --extra 3

local cmd make_locus_fancy_plot_dat_file=$smart_cut_cmd --in-delim $tab --exec "$locus_fancy_plot_dat_helper(all_marker,get_associated_marker_variants,$marker_type)" --exec "$locus_fancy_plot_dat_helper(non_marker_seq,get_associated_seq_variants,$seq_type) | tail -n+2" | sed 's/\(.*\)\(\s\s*\)\(\S\S*\)$/\3\2\1/' | $smart_cut_cmd --in-delim $tab --select-row 0,1 $locus_range_selector(0,POS) > !{output,,locus_fancy_plot_dat_file} class_level locus

!!expand:,:keytype,extra_cmd,snpperkb:_marker,,.2:,markers.type=$seq_type,2! \
local cmd make_locus_fancykeytype_plot_pdf_file=$draw_fancy_locus_plot_cmd !{input,in.file=,locus_fancy_plot_dat_file} !{output,out.file=,locus_fancykeytype_plot_pdf_file} snp=`cat !{input,,locus_top_common_marker_snp_file}` title=!{prop,,locus,disp} !{prop,chrom=,locus,chrom} range=8 recomb=$genetic_map_file(!{prop\,\,locus\,chrom}) !{input,gene.list=,locus_gene_target_file} gene.strand.list=$genetic_strand_file(!{prop\,\,locus\,chrom}) extra_cmd imputed.type=$marker_type snp.per.10kb=snpperkb !{input,locus_range_info_file} class_level locus

cmd make_locus_haplotype_burden_files=perl $haplotype_burden_bin_dir/make_index_stratify_file_from_peds.pl !{input,,locus_all_seq_tfam_file} !{input,,locus_all_seq_tped_file} !{input,,locus_all_marker_tfam_file} !{input,,locus_all_marker_tped_file} !{input,,locus_top_common_marker_pos_file} !{input,,pheno_marker_pheno_file} !{output,,locus_strat_index_snp_file} !{output,,locus_index_geno_counts_file} !{prop,,pheno,prevalence} class_level locus run_if and,prevalence,do_hap_burden

prop prevalence=scalar
cmd make_locus_strat_self_snp_file=perl $haplotype_burden_bin_dir/make_self_stratify_file_from_peds.pl !{input,,locus_all_seq_tfam_file} !{input,,locus_all_seq_tped_file} !{input,,locus_all_marker_tfam_file} !{input,,locus_all_marker_tped_file} !{input,,pheno_marker_pheno_file} !{output,,locus_strat_self_snp_file} !{prop,,pheno,prevalence} class_level locus run_if and,prevalence,do_hap_burden

local cmd make_locus_est_variance_explained_file=$r_script_cmd($haplotype_burden_bin_dir/est_var_explained_from_counts.R) !{input,,locus_strat_self_snp_file} !{input,,locus_top_common_marker_pos_file} !{output,,locus_est_variance_explained_file} !{prop,,pheno,prevalence} class_level locus run_if and,prevalence,do_hap_burden

#complicated command because output of haploview must be massaged three ways
#1. Need to get all ids in L1
#2. Need to add in lines for duplicated marker ids
#3. Need to add NAs for SNPs that were missing (failed haploview checks)
local cmd make_locus_est_variance_explained_annot_file=$smart_join_cmd --in-delim $tab --exec "cat !{input,,locus_est_variance_explained_file} | cut -f2- | $format_columns_cmd --in-delim $tab --number-format 1,%d --number-format %.4g" --exec "cut -f2- !{input,,locus_strat_index_snp_file}" --exec "$smart_join_cmd --exec \"sed '1 s/^/SNP\tPOS\n/' !{input,,locus_haploview_info_file}\" !{input,--file,locus_haploview_marker_ld_file} | cut -f2-" --exec "cut -f2 !{input,,locus_strat_index_snp_file}" --extra 1 --extra 3 --header 1 | awk -F"\t" -v OFS="\t" '{tmp = \$2; \$2 = \$1; \$1 = tmp} {print}' > !{output,,locus_est_variance_explained_annot_file} class_level locus

max_conditional_or_maf=.02
local cmd make_locus_conditional_or_file=python $haplotype_burden_bin_dir/calculate_conditional_or.py --index-pos `cat !{input,,locus_top_common_marker_pos_file}` --max-maf $max_conditional_or_maf !{input,--marker-tped,locus_all_marker_tped_file} !{input,--marker-tfam,locus_all_marker_tfam_file} !{input,--seq-tped,locus_all_seq_tped_file} !{input,--seq-tfam,locus_all_seq_tfam_file} !{input,--pheno-file,pheno_non_missing_sample_info_file} > !{output,,locus_conditional_or_file} class_level locus run_if do_hap_burden

or_header=OR
local cmd make_locus_conditional_or_pdf_file=awk 'NR == 1 {for(i = 1; i <= NF; i++) {fields[\$i] = i}} {cur=\$fields["$or_header"]; still_print=1;} NR == 2 {initial=cur} {if (still_print && NR <= 2 || (NR > 2 && (cur - prev) * (initial - 1) < 0)) {print; prev=cur} else {still_print=0}}' !{input,,locus_conditional_or_file} | $r_script_cmd($haplotype_burden_bin_dir/draw_conditional_or.R) /dev/stdin !{output,,locus_conditional_or_pdf_file} OR OR_LB OR_UB !{prop,,locus,disp} class_level locus run_if do_hap_burden


#gene cmds
prop gene_start=scalar
prop gene_end=scalar

local cmd make_gene_pheno_seq_plink_files=$plink_cmd $plink_in_bed_helper(pheno) $kb_range(gene, 1) --make-bed $plink_out_bed_helper(gene_pheno_seq) && $plink_mv_log_cmd(!{raw\,\,gene\,*gene_pheno_seq_plink_file},!{output\,\,gene_pheno_seq_make_bed_log_file}) class_level gene

ld_window=50000
local cmd make_gene_all_ld_plink_files=$plink_cmd !{input,--tped,locus_combined_tped_file} !{input,--tfam,locus_combined_tfam_file} !{input,--pheno,pheno_plink_alternate_phe_file,if_prop=pheno_qt,allow_empty=1} !{raw,--pheno-name,pheno,$pheno_half_for_raw,if_prop=pheno_qt,allow_empty=1} !{raw,--out,gene,*gene_all_ld_plink_file} !{output,gene_all_ld_ped_file} !{output,gene_all_ld_map_file} --recode $kb_range(gene,$ld_window) --output-missing-phenotype 0 && $plink_mv_log_cmd(!{raw\,\,gene\,*gene_all_ld_plink_file},!{output\,\,gene_all_ld_recode_log_file}) class_level gene

max_num_ld_plot=150
get_all_ld_haploview_snp_exclude_file=perl -lane '++\$num; print abs(\$F[3] - (!{prop,,gene,gene_start} + !{prop,,gene,gene_end}) / 2) . "\t\$num\t"' !{input,,gene_all_ld_map_file} | sort -nk1 | awk 'NR > $max_num_ld_plot {print \$2}' | tr '\n' ',' | sed 's/,$//' | sed 's/^/-excludeMarkers /'

local cmd make_gene_all_ld_info_file=perl -pe 'BEGIN {open IN, "!{input,,gene_seq_ld_info_file}" or die; while (<IN>) {chomp; @a = split; \$map{\$a[1]} = \$a[0]} } chomp; @a = split; if (\$map{\$a[3]}) {\$a[1] = "\*\*\$map{\$a[3]}\*\*"; \$_ = join(" ", @a)} \$_ .= "\n" ' < !{input,,gene_all_ld_map_file} | awk '{print \$2,\$4}' > !{output,,gene_all_ld_info_file} class_level gene

local cmd make_gene_seq_ld_plink_files=$plink_cmd $plink_in_bed_helper(gene_pheno_seq) !{input,--pheno,pheno_plink_alternate_phe_file,if_prop=pheno_qt,allow_empty=1} !{raw,--pheno-name,pheno,$pheno_half_for_raw,if_prop=pheno_qt,allow_empty=1} !{raw,--out,gene,*gene_seq_ld_plink_file} !{output,gene_seq_ld_ped_file} !{output,gene_seq_ld_map_file} --recode --output-missing-phenotype 0 && $plink_mv_log_cmd(!{raw\,\,gene\,*gene_seq_ld_plink_file},!{output\,\,gene_seq_ld_recode_log_file}) class_level gene

local cmd make_gene_seq_ld_info_file=$smart_join_cmd --in-delim $tab --rest-extra 1 --exec "$smart_cut_cmd --in-delim $tab !{input,--file,gene_seq_ld_map_file} !{input,--file,gene_var_counts_dat_file} --select-col 1,4 --select-col 2,2 | sort -u | $smart_cut_cmd --in-delim $tab !{input,--file,gene_seq_ld_map_file} --select-col 1,4 | sort | uniq -d" --exec "$smart_cut_cmd --out-delim $tab !{input,--file,gene_seq_ld_map_file} --select-col 1,4" --exec "$smart_join_cmd --exec \"$smart_cut_cmd --in-delim $tab !{input,--file,gene_var_counts_dat_file} --select-col 1,1,'POS ID MINA MINU' --exclude-row 1,1 --exact\" --exec \"$smart_cut_cmd --out-delim $tab !{input,--file,gene_seq_ld_map_file} --select-col 1,'4 2' | sed 's/$/\tNA\tNA/'\" --merge" | sed 's/^\(.*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)$/\1-Ca:\2-Ct:\3/' | $smart_cut_cmd --in-delim $tab --select-col 0,'2 1'  > !{output,,gene_seq_ld_info_file} class_level gene

!!expand:,:keytype,excludecmd:all,`$get_all_ld_haploview_snp_exclude_file`:seq,! \
haploview_keytype_cmd=java -Xmx$haploview_mem -jar $haploview_jar -nogui !{input,-pedfile,gene_keytype_ld_ped_file} !{input,-info,gene_keytype_ld_info_file} -@1 !{raw,-out,gene,*gene_keytype_ld_png_trunk} !{output,gene_keytype_ld_png_file} -skipcheck excludecmd

haploview_mem=1g
#!!expand:,:keytype,excludecmd:all,`$get_all_ld_haploview_snp_exclude_file`:seq,! \
#short cmd make_gene_keytype_ld_png_file=rm -f !{output,,gene_keytype_ld_png_file} && $open_vnc_display && (($haploview_keytype_cmd(png) && ls !{output,,gene_keytype_ld_png_file}) || ($haploview_keytype_cmd(compressedpng) && ls !{output,,gene_keytype_ld_png_file})); $close_vnc_display class_level gene

#!!expand:keytype:all:seq! \
#local cmd make_gene_keytype_ld_pdf_file=convert !{input,,gene_keytype_ld_png_file} !{output,,gene_keytype_ld_pdf_file} class_level gene

gene_impute_summary_helper=(head -q -n1 /dev/null !{input,,variant_@{1}_summary_file,allow_empty=1} | awk 'NR == 1' && tail -q -n+2 /dev/null !{input,,variant_@{1}_summary_file,allow_empty=1})

local cmd make_gene_hap_summary_file=$gene_impute_summary_helper(hap) > !{output,,gene_hap_summary_file} class_level gene

local cmd make_gene_traditional_summary_file=$smart_join_cmd --in-delim $tab --header 1 --exec "$gene_impute_summary_helper(traditional) | tail -n+2 | $smart_cut_cmd !{input,--file,locus_combined_snptest_out_file} --exclude-row 1,1 --out-delim $tab | cut -f3 | sort | uniq -d | sed '1 s/^/ID\n/'" --exec "$gene_impute_summary_helper(traditional)" --exec "$smart_cut_cmd --out-delim $tab !{input,--file,locus_combined_snptest_out_file}  --select-col 1,1,'rsid pos cases_maf controls_maf $snptest_pvalue_col info' --exact --require-col-match | sed '1 s/^.*$/SNP\tPOS\tF_CASE_SCORE\tF_CONTROL_SCORE\tP_SCORE\tINFO/'" --extra 2 --extra 3 --col 2,3 --col 3,2 | cut -f2- > !{output,,gene_traditional_summary_file} class_level gene

#cmd make_gene_vars_file=$smart_join_cmd --exec "$smart_cut_cmd --in-delim $tab !{input,--file,project_clean_gene_variant_file} --select-col 1,1,'ID GENE CHROM POS' --exact" --exec "cat !{input,,project_full_var_annot_file} | $smart_cut_cmd --select-col 0,1,'ID $vcf_type_annot' --exact" !{input,--file,project_pph2_file} --extra 1 --extra 3 --comment \\# --header 1 --out-delim $tab | $smart_cut_cmd --in-delim $tab --select-row 0,1,GENE,!{prop,,gene,external_id} --select-col 0,1,'ID CHROM POS $vcf_type_annot $pph2_class_annot' --exact --require-col-match | awk -v OFS="\t" -F"\t" '\$5 == 2 {\$5="possibly damaging"} \$5 == 1 {\$5="benign"} \$5 == 0 && \$4 == "$vcf_type_synonymous_annot" {\$5="NA"} \$5 == 0 && \$4 != "$vcf_type_synonymous_annot" {\$5="unknown"} \$5 == 3 || \$4=="$vcf_type_nonsense_annot" {\$5="probably damaging"} {print}' | sed '1 s/^/snp\tchrom\tposition\tvariant_type\tpolyphen\n/' > !{output,,gene_vars_file} class_level gene

#short cmd make_gene_group_file=$smart_cut_cmd --in-delim $tab !{input,--file,project_clean_gene_variant_file} --select-row 1,1,GENE,!{prop,,gene,external_id} --select-col 1,1,'ID GENE' --exact | sed '1 s/^/snp\tgroup\n/' > !{output,,gene_group_file} class_level gene

#local cmd make_gene_sample_rank_file=$smart_join_cmd --in-delim $tab --exec "$smart_cut_cmd !{input,--file,gene_pheno_seq_fam_file} --select-col 1,1-2 --out-delim $tab | sed '1 s/^/FID\tIID\n/'" !{input,--file,pheno_sample_rank_file} --col 1,2 --extra 2 --header 1 | $smart_cut_cmd --in-delim $tab --select-col 0,'2 1 3' > !{output,,gene_sample_rank_file} class_level gene

#local cmd make_gene_vars_pdf_file=$draw_gene_plot_cmd("!{input,bed.file=,gene_pheno_seq_bed_file} !{input,bim.file=,gene_pheno_seq_bim_file} !{input,fam.file=,gene_pheno_seq_fam_file} !{input,covar.file=,gene_sample_rank_file} pheno.name=$rank_prop_header !{input,vars.file=,gene_vars_file} !{input,group.file=,gene_group_file} !{raw,title=,pheno,'@disp'} !{output,out.file=,gene_vars_pdf_file}") class_level gene

ucsc_gene_buffer=100

local cmd make_gene_ucsc_regions_file=(echo !{prop,,gene,disp}, human, hg$hg_build, chr!{prop,,gene,chrom}, !{prop,,gene,gene_start}, !{prop,,gene,gene_end}, \"!{prop,,gene,disp}\", $ucsc_gene_buffer, $ucsc_gene_buffer) > !{output,,gene_ucsc_regions_file} class_level gene

local cmd make_gene_ucsc_pdf_file=$fetch_ucsc_cmd !{input,-r,gene_ucsc_regions_file} !{input,-t,pheno_ucsc_tracks_file} !{input,-u,pheno_ucsc_browser_file} !{output,--output-file,gene_ucsc_pdf_file} class_level gene

prop use_transcripts=list

short cmd make_gene_variant_list_file=$pseq_qc_plus_all_analysis_cmd_pheno_variant_subset(v-matrix) $show_id --mask $pseq_gene_mask $mono_ex_mask | $split_parsed_id | cut -f1-3 | tail -n+2 | $add_gene_annot_cmd --in-delim $tab --print-multiple --chr-col 1 --pos-col 2 --gene-file !{input,,project_expanded_exon_target_file} --out-delim $tab --gene-file-num-ids 2 --gene-id-join-char $tab | $smart_cut_cmd --in-delim $tab --select-row 0,1,!{prop,,gene,external_id} | cut -f3- | cut -f3 | sort -u > !{output,,gene_variant_list_file} class_level gene

short cmd make_gene_all_annot_file=$smart_join_cmd --in-delim $tab --header 1 --exec "cut -f1 !{input,,project_variant_subset_full_var_annot_file} | sort -u | cat - !{input,,gene_variant_list_file} | sort | uniq -d | sed '1 s/^/ID\n/'" --exec "cat !{input,,project_variant_subset_full_var_annot_file} | awk -F\"\t\" -v OFS=\"\t\" 'NR == 1 {for (i=1;i<=NF;i++) {m[\\$i]=i}} NR > 1 {\\$m[\"$vep_trans_annot\"]=\"$consensus_transcript\"} NR > 1 {print}' | $smart_cut_cmd --in-delim $tab !{input,--file,project_variant_subset_full_annot_file}" --extra 2 --multiple 2 > !{output,,gene_all_annot_file} class_level gene


#Take variants both in burden file and in the gene file; use these to join with
#The detail reg file with non CCDS transcripts that have transcripts in the all annot file

replace_consensus=awk -v OFS=\\\"\t\\\" -F\\\"\t\\\" '\\\\$1 == \\\"!{prop,,gene,external_id}\\\" {\\\\$1=\\\"$consensus_transcript\\\"} {print}'

#get_burden_transcripts=$smart_join_cmd --in-delim $tab --exec "cat !{input,,burden_all_variant_list_file} !{input,,gene_variant_list_file} | sort | uniq -d" --rest-extra 1 --multiple 2 --exec "$smart_join_cmd --in-delim $tab --exec \"$smart_cut_cmd --in-delim $tab !{input,--file,gene_all_annot_file} --select-col 1,1,$vep_trans_annot --select-row 1,1,$vep_trans_annot,eq:$consensus_transcript --select-row 1,1,$vep_ccds_annot,ne:$annot_missing_field --exclude-row 1,1 --exact --require-col-match | sort -u | $smart_cut_cmd --in-delim $tab --exec \\\"$smart_cut_cmd --in-delim $tab !{input,--file,burden_locdb_detail_reg_file} --select-col 1,1,ID --exclude-row 1,1 --exact --require-col-match | sort -u\\\" | sort | uniq -d\" --exec \"$smart_cut_cmd --in-delim $tab !{input,--file,burden_locdb_detail_reg_file} --select-col 1,1,'ID VAR' --exclude-row 1,1 --exact --require-col-match | $replace_consensus\" --extra 2 --multiple 2 | $smart_cut_cmd --in-delim $tab --select-col 0,'2 1'" | cut -f2 | sort -u

get_burden_transcripts=$smart_join_cmd --in-delim $tab --exec "cat !{input,,burden_all_variant_list_file} !{input,,gene_variant_list_file} | sort | uniq -d" --rest-extra 1 --multiple 2 --exec "$smart_cut_cmd --in-delim $tab !{input,--file,burden_locdb_detail_reg_file} --select-col 1,1,'VAR ID' --exclude-row 1,1 --exact --require-col-match" | cut -f2 | awk -v OFS="\t" -F"\t" '\$1 == "!{prop,,gene,external_id}" {\$1="$consensus_transcript"} {print}' | $smart_cut_cmd --in-delim $tab --exec "$smart_cut_cmd !{input,--file,gene_all_annot_file} --select-col 1,1,$vep_trans_annot --select-row 1,1,$vep_trans_annot,eq:$consensus_transcript --select-row 1,1,$vep_ccds_annot,ne:$annot_missing_field --exclude-row 1,1 --exact --require-col-match | sort -u" | sort | uniq -d

short cmd make_gene_burden_transcript_burdens_dat_file=$get_burden_transcripts | sed 's/\(.*\)/\1 !{prop,,gene_burden}/' > !{output,,gene_burden_transcript_burdens_dat_file} class_level gene_burden skip_if use_transcripts with transcript_burden 

short cmd make_custom_gene_transcript_burdens_dat_file=$get_burden_transcripts | $smart_cut_cmd --in-delim $tab --exec "perl -e '{print qq(!{prop,,gene,use_transcripts,sep=\n})}' | sort -u" | sort | uniq -d | sed 's/\(.*\)/\1 !{prop,,gene_burden}/' > !{output,,gene_burden_transcript_burdens_dat_file} class_level gene_burden run_if use_transcripts with transcript_burden

local cmd make_gene_transcript_burdens_meta_file=cat !{input,,gene_burden_transcript_burdens_dat_file} | sed 's/\(\S\S*\)\s\s*\(\S\S*\)/\1 \2 !{prop,,gene}_\1/' | sed 's/^\(\S\S*\)\s\s*\(\S\S*\)\s\s*\(\S\S*\)/\3 class transcript_burden\n!select:!{prop,,project}:\2 \3 parent !{prop,,gene}\n\3 disp \1\n\3 external_id \1/' > !{output,,gene_transcript_burdens_meta_file} class_level gene

vassoc_subset_helper=$smart_cut_cmd !{input,--file,pheno_vassoc_annot_file} --in-delim $tab --select-row 1,1,$vcf_type_annot,@1 --and-row-all | sed 's/$/\t@2/g'

max_gene_var_counts_maf=.1

gene_var_counts_selector=$smart_cut_cmd --in-delim $tab --select-row 0,1 --select-row 0,1,GENE,!{prop,,gene,external_id} --exact

locus_var_counts_selector=$smart_cut_cmd --in-delim $tab --select-row 0,1 --select-row 0,1,CHROM,!{prop,,locus,ref_chrom} $locus_pos_selector(0,POS) --and-row-all !{input,locus_range_info_file}

var_counts_nonsense_type=Nonsense
var_counts_missense_type=Missense
var_counts_synonymous_type=Synonymous
var_counts_other_type=Other


var_counts_types="$var_counts_synonymous_type,$var_counts_missense_type,$var_counts_other_type,$var_counts_nonsense_type"

var_counts_dat_helper=$smart_join_cmd --in-delim $tab --extra 1 \
   									--exec "$smart_cut_cmd --in-delim $tab !{input,--file,project_clean_gene_variant_file} --select-col 1,1,'ID' --exact --require-col-match" \
         --exec "$smart_cut_cmd --in-delim $tab --out-delim $tab \
				 --exec \"$smart_cut_cmd !{input,--file,pheno_vassoc_annot_file} --in-delim $tab --select-row 1,1 | sed 's/$/\tVAR_TYPE/'\" \
				 --exec \"$vassoc_subset_helper($vcf_type_nonsense_annot,$var_counts_nonsense_type)\" \
				 --exec \"$vassoc_subset_helper($vcf_type_missense_annot,$var_counts_missense_type)\" \
				 --exec \"$vassoc_subset_helper($vcf_type_synonymous_annot,$var_counts_synonymous_type)\" \
				 --exec \"$vassoc_subset_helper(.,$var_counts_other_type)\" \
  | awk '!map[\\$1] {print; map[\\$1] = 1}' "\
  | @1 \
  | $smart_cut_cmd --in-delim $tab --select-col 0,1,'ID POS $vcf_protein_change_annot VAR_TYPE OBSA OBSU MINA MINU MAF MAFA MAFU !{raw::pheno_test:${p_col_disp}_\@test_tag:if_prop=use_for_display}' --exact --require-col-match | sed '1! s/^var_//' | sed '1! s/^\(\S\S\*\)\(\s\s\*\S\S\*\)\(\s\s\*\)NA/\1\2\3\1/' | $smart_cut_cmd --in-delim $tab --select-row 0,1 --select-row 0,1,MINA,gt:0 --select-row 0,1,MINU,gt:0

short cmd make_gene_var_counts_dat_file=$var_counts_dat_helper($gene_var_counts_selector) > !{output,,gene_var_counts_dat_file} class_level gene

local cmd make_gene_rare_var_counts_dat_file=$smart_cut_cmd --in-delim $tab !{input,--file,gene_var_counts_dat_file} --select-row 1,1 --select-row 1,1,MAF,lt:$max_gene_var_counts_maf > !{output,,gene_rare_var_counts_dat_file} class_level gene

local cmd make_gene_var_counts_pdf_file=$draw_bar_plot_cmd("!{input,,gene_rare_var_counts_dat_file},!{input,,gene_rare_var_counts_dat_file} !{output,,gene_var_counts_pdf_file} 'Variants in !{prop,,gene,disp}: MAF < $max_gene_var_counts_maf' 'Frequency' MAFA $vcf_protein_change_annot sep=$tab value.cols=MAFU label.colors.col=VAR_TYPE max.label.size=15") class_level gene

!!expand:curpheno:case:control! \
cmd make_gene_curpheno_position_coverage_file=awk 'NR == 1 || (\$1 == !{prop,,gene,chrom} && \$2 >= !{prop,,gene,gene_start} && \$2 <= !{prop,,gene,gene_end})' !{input,,locus_curpheno_position_coverage_file} > !{output,,gene_curpheno_position_coverage_file} class_level gene skip_if no_coverage

#(for f in `cat !{input,,pheno_curpheno_sample_coverage_file_list} !{input,sample_coverage_file,unless_prop=failed}`; do zcat \$f | tail -n+2; done) | sed 's/^chr//' | sed 's/^\(\S*\):\(\S\S*\)/\1\t\2/' | awk -v OFS="\t" '\$1 == !{prop,,gene,chrom} && \$2 >= !{prop,,gene,gene_start} && \$2 <= !{prop,,gene,gene_end} {print \$1,\$2,\$3}' | sort | $table_sum_stats_cmd --in-delim $tab --group-col 1 --group-col 2 --col 3 --summaries --threshold $threshold --out-delim $tab --print-header --groups-sorted  > !{output,,gene_curpheno_position_coverage_file} class_level gene

local cmd make_gene_exon_target_file=awk -v OFS="\t" -F"\t" 'BEGIN {print "EXON","START","END"} \$1 == "!{prop,,gene,disp}" {print \$2,\$4,\$5}' !{input,,project_expanded_exon_target_file} > !{output,,gene_exon_target_file} class_level gene

var_coverage_helper=$draw_var_coverage_plot_cmd !{input,,@{1}_exon_target_file} !{input,,@{1}_var_counts_dat_file} 'Variants @3 for !{prop,,@{1},disp}' !{output,,@{1}_@{2}_pdf_file} !{input,case.coverage.file=,@{1}_case_position_coverage_file,unless_prop=no_coverage,allow_empty=1} !{input,control.coverage.file=,@{1}_control_position_coverage_file,unless_prop=no_coverage,allow_empty=1} coverage.cols=2,$frac_above_threshold var.cols=POS,VAR_TYPE,!{raw::pheno_test:${p_col_disp}_\@test_tag:if_prop=use_for_display:limit=1},MAFA,MAFU,MAF coverage.label='Percent samples above ${threshold}x' sep=$tab @4 known.var.types=$var_counts_types

var_helper=$draw_var_coverage_plot_cmd !{input,,@{1}_exon_target_file} !{input,,@{1}_var_counts_dat_file} 'Variants@3 for !{prop,,@{1},disp}' !{output,,@{1}_@{2}_pdf_file} var.cols=POS,VAR_TYPE,!{raw::pheno_test:${p_col_disp}_\@test_tag:if_prop=use_for_display:limit=1},MAFA,MAFU,MAF sep=$tab @4 known.var.types=$var_counts_types

local cmd make_gene_var_pdf_file=$var_helper(gene,var,,) class_level gene

short cmd make_gene_qq_pdf_file=$get_gene_vassoc_file(1,le:1,) | $burden_vassoc_qq_pdf_helper(/dev/stdin,gene_qq_pdf_file,'Variant associations for !{prop\,\,gene\,disp}: !{prop\,\,pheno\,disp}',gene,nrow=2 ncol=3) class_level gene

local cmd make_gene_var_coverage_pdf_file=$var_coverage_helper(gene,var_coverage, and coverage,draw.cov.lines=TRUE) class_level gene

make_gene_or_variant_qc_metrics_tex_file=$smart_cut_cmd !{input,--file,project_@{1}_outlier_file} --select-row 1,1,LABEL,!{prop,,@{1},external_id} --exact --select-row 1,1 --in-delim , --out-delim $tab --exclude-col 1,1,LABEL | $format_columns_cmd --in-delim $tab --number-format %.4g  | $table_to_beamer_cmd --in-delim $tab --header-rows 1 --header-cols 1 --title "!{prop,,@{1},disp} QC Metrics" > !{output,,@{1}_qc_metrics_tex_file} 

local cmd make_gene_qc_metrics_tex_file=$make_gene_or_variant_qc_metrics_tex_file(gene) class_level gene

local cmd make_gene_qc_metrics_pdf_file=$run_latex_cmd(gene_qc_metrics_tex_file,gene_qc_metrics_pdf_file) class_level gene

pseq_gene_mask=reg.req=!{prop,,gene,chrom}:!{prop,,gene,gene_start}..!{prop,,gene,gene_end}

pseq_all_data_analysis_helper=${pseq_@{1}_cmd_pheno_variant_subset}(@2) --mask $pseq_gene_mask

mono_ex_mask=--mask monomorphic.ex

!|expand:;:fname;pseq_cmd_type;tex_title;extrarunif:all_data;all_analysis;All Variants, All Samples;:all_variants;filter_only_samples_all_analysis;All Variants, QC/Popgen/Strat+ Samples, All Genotypes;run_if !no_filters| \
cmd make_gene_fname_tex_file=$smart_join_cmd --header 1 --in-delim $tab --exec "$pseq_all_data_analysis_helper(pseq_cmd_type,$vassoc) $show_id $mono_ex_mask !{prop,--phenotype,pheno} --perm 0 | $parse_out_id | cut -f1 | cat - !{input,,project_variant_subset_full_var_annot_file} | cut -f1 | sort | uniq -d | sed '1 s/^/ID\n/'" --exec "cat !{input,,project_variant_subset_full_var_annot_file} | $smart_cut_cmd --in-delim $tab --select-col 0,1,'$vep_id_annot $vcf_protein_change_annot' --exact --require-col-match" --exec "$pseq_all_data_analysis_helper(pseq_cmd_type,$vassoc) $show_id $mono_ex_mask !{prop,--phenotype,pheno} --perm 0 | $parse_out_id"  --ignore-err $plinkseq_okay_err --rest-extra 1 | $add_function_cmd --in-delim $tab --header 1 --col1 MINA --col2 OBSA --val-header MAFA --type divide | $add_function_cmd --in-delim $tab --header 1 --col1 MINU --col2 OBSU --val-header MAFU --type divide | $pheno_process_slide_variants_helper(ID FILTER $vcf_protein_change_annot MINA MINU MAFA MAFU P,,P,.,) | $replace_var_id | awk -F"\t" -v OFS="\t" '\$2!="PASS" && NR > 1 {\$2="FAIL"} {print}' | $format_columns_cmd --in-delim $tab --header 1 --number-format MAFA,%.2g --number-format MAFU,%.2g --number-format P,%.2g --percentage MAFA --percentage MAFU | $truncate_cols($vassoc_max_chars_per_col) | tail -n+2 | sed '1 s/^/Variant\tFilter\tProt Change\tCounts\tCounts\tMAF\tMAF\tOR\nVariant\tFilter\tProt Change\tCase\tCtrl\tCase\tCtrl\tP\n/' | $table_to_beamer_cmd --allow-breaks --multi-row 1-3,1-2 --multi-row 8,1-2 --multi-col 1,4-5 --multi-col 1,6-7 --font-size 8pt --bottom-margin 0in --left-margin 0in --right-margin 0in --title "tex_title: !{prop,,gene,disp}" --in-delim $tab --header-rows 2 > !{output,,gene_fname_tex_file} class_level gene extrarunif skip_if pheno_qt

!!expand:fname:all_data:all_variants! \
local cmd make_gene_fname_pdf_file=$run_latex_cmd(gene_fname_tex_file,gene_fname_pdf_file) class_level gene



#short cmd make_gene_associated_tex_file=$pheno_slide_variants_helper(.,.,^!{prop\\,\\,gene\\,external_id}$,GENE ID !{prop::pheno:vassoc_meta_disp} $dp_helper GENO HWE P_MISSING MINA MINU MAFA MAFU OR P_RAW P,,P,.,pheno_vassoc_annot_file,,1) | $gene_associated_tex_helper("'!{prop,,gene,disp} variants for !{prop,,pheno,disp}'") > !{output,,gene_associated_tex_file} class_level gene skip_if pheno_qt

#short cmd make_gene_qt_associated_tex_file=$pheno_qt_slide_variants_helper(.,.,^!{prop\\,\\,gene\\,external_id}$,GENE ID !{prop::pheno:vassoc_meta_disp} $dp_helper GENO HWE MAF MINA_EX MINU_EX BETA SE P_RAW P,,P,.,pheno_vassoc_annot_file,,1) | $gene_qt_associated_tex_helper("'!{prop,,gene,disp} variants for !{prop,,pheno,disp}'") > !{output,,gene_associated_tex_file} class_level gene run_if pheno_qt

#local cmd make_gene_associated_pdf_file=$run_latex_cmd(gene_associated_tex_file,gene_associated_pdf_file) class_level gene

replace_nan=sed 's/\b\(NA\|na\|nan\|NaN\|NAN\)\b/@1/g'

!!expand%;%ctype;width;traitselector;extrased;runif%all;1;related_traits;;run_if related_traits%meta;3;meta_trait_inv;| sed 's/^/MAF\t/';run_if meta_trait_inv! \
local cmd make_gene_ctype_trait_associated_tex_file=let w=`perl -e "print int(.5 + 6 + width * \`echo !{prop,,pheno,traitselector,sep=:} | sed 's/:/\n/g' | wc -l\`)"` && $smart_cut_cmd --in-delim $tab !{input,--file,pheno_ctype_trait_vassoc_annot_file} --select-row 1,1 --exact --select-row 1,1,GENE,!{prop,,gene,external_id} | $sort_name_col_with_header(!{raw::pheno_test:${p_col_disp}_@{test_tag}:if_prop=use_for_display:limit=1}_!{prop::pheno:disp},) | $transpose_cmd --in-delim $tab | $smart_cut_cmd --in-delim $tab --vec-delim @  --select-row 0,1,ID --select-row 0,1,'^(!{prop,,pheno,vassoc_meta_disp,sep=|})$' --select-row 0,1,'eq:${or_col_disp_pheno_test}_!{prop::pheno:disp}' --select-row 0,1,eq:MAF --select-row 0,1,'eq:!{raw::pheno_test:${p_col_disp}_@{test_tag}:limit=1}_!{prop::pheno:disp}' !{raw;;pheno;--select-row 0,1,"^(`head -n1 *pheno_small_vassoc_annot_file | rev | cut -f1-2 | rev extrased | sed 's/\(\S\S*\)/\1_@disp/g' | sed 's/)/\\\\)/g' | sed 's/(/\\\\(/g' | sed 's/\t/\|/g'`)$";all_instances=1;if_prop=pheno:eq:@traitselector;if_prop=project:eq:@project} | sed 's/^\([^\t][^\t]*\)/\1\t\1/' | sed 's/^[^\t][^\t]*\(\s\s*\)\([^\t][^\t]*\)_\(!{prop,,pheno,disp}\)\t/\3\1\2\t/' !{raw;;pheno;| sed 's/^[^\t][^\t]*\(\s\s*\)\([^\t][^\t]*\)_\(@disp\)\t/\3\1\2\t/';all_instances=1;if_prop=pheno:eq:@traitselector;if_prop=project:eq:@project} |  $transpose_cmd --in-delim $tab | $smart_cut_cmd --in-delim $tab --exclude-row 0,1,MAF,eq:0 | $swap_header(!{prop::pheno:vassoc_meta_disp},!{prop::pheno:vassoc_meta_headers},1\,2) | $translate_variant_type | $replace_var_id | $replace_nan(-) | $format_columns_cmd --in-delim $tab --number-format %.2g | $table_to_beamer_cmd --allow-breaks --font-size 8pt --auto-dim --bottom-margin 0in --left-margin 0in --right-margin -in --title "!{prop,,gene,disp} variants: ctype trait values" --in-delim $tab --header-rows 2 --multi-row .,2 --multi-col 1-2 > !{output,,gene_ctype_trait_associated_tex_file} class_level gene runif

!!expand:ctype:all:meta! \
local cmd make_gene_ctype_trait_associated_pdf_file=$run_latex_cmd(gene_ctype_trait_associated_tex_file,gene_ctype_trait_associated_pdf_file) class_level gene

short cmd make_gene_gassoc_tex_file=(head -n2 !{input,,transcript_burden_gassoc_file,if_prop=burden_test,limit=1} && tail -qn+3 !{input,,transcript_burden_gassoc_file,if_prop=burden_test,sort_prop=sort}) | awk -F"\t" -v OFS="\t" '!m[\$1] {m[\$1]=NR} NR <= 2 {print NR,m[\$1],\$0} NR > 2 {print 3,m[\$1],\$0}' | sort -k1,1n -k2,2n -k4,4 | cut -f3- | $format_columns_cmd --in-delim $tab --number-format 3,%d --number-format 4,%d --number-format 5,%d --number-format 6,%d --number-format %.2g | $table_to_beamer_cmd --in-delim $tab --force-multi-row-break 1 --header-rows 2 --multi-col 1-2 --multi-row . --auto-dim  --font-size 8pt --title "Variant counts per group for !{prop,,gene,disp}: !{prop,,pheno,disp}" > !{output,,gene_gassoc_tex_file} class_level gene run_if gene_burden

local cmd make_gene_gassoc_pdf_file=$run_latex_cmd(gene_gassoc_tex_file,gene_gassoc_pdf_file) class_level gene

#gene_burden cmds

#fix run_if to pull from consistent???
local cmd make_transcript_burden_annot_variant_list_file=$annot_variant_list_helper(gene_all_annot_file,--select-row 1\,1\,$vep_trans_annot\,eq:!{prop::transcript_burden:external_id},) > !{output,,transcript_burden_annot_variant_list_file} class_level transcript_burden run_if annot_mask

local cmd make_transcript_burden_all_variant_list_file=$smart_cut_cmd --in-delim $tab !{input,--file,gene_all_annot_file} --select-col 1,1 --select-row 1,1,$vep_trans_annot,eq:!{prop::transcript_burden:external_id} !{raw,,burden,| cat - *burden_non_annot_variant_list_file | sort | uniq -d,if_prop=burden_maf,if_prop=burden_mac_lb,if_prop=burden_mac_ub,or_if_prop=1,allow_empty=1} !{raw,,annot,| cat - *annot_non_annot_variant_list_file | sort | uniq -d,if_prop=annot_maf,if_prop=annot_mac_lb,if_prop=annot_mac_ub,if_prop=apply_extended_qc,if_prop=apply_extended_strict_qc,or_if_prop=1,allow_empty=1} !{input,burden_non_annot_variant_list_file,if_prop=burden_maf,if_prop=burden_mac_lb,if_prop=burden_mac_ub} !{input,annot_non_annot_variant_list_file,if_prop=annot_maf,if_prop=annot_mac_lb,if_prop=annot_mac_ub,or_if_prop=1,allow_empty=1} !{raw,,transcript_burden,| cat - *transcript_burden_annot_variant_list_file | sort | uniq -d,if_prop=annot_mask,allow_empty=1,max=1} !{input,transcript_burden_annot_variant_list_file,if_prop=annot_mask,allow_empty=1,max=1} > !{output,,transcript_burden_all_variant_list_file} class_level transcript_burden class_level transcript_burden

short cmd make_transcript_burden_reg_list_file=$smart_join_cmd !{input,--file,transcript_burden_all_variant_list_file} --exec "$smart_cut_cmd --in-delim $tab !{input,--file,project_clean_gene_variant_file} --select-col 1,1,'ID CHROM POS' --exclude-row 1,1" --extra 2 | cut -f2-3 | sed 's/\s\s*/:/' | sed 's/^/chr/' | sed 's/^chrchr/chr/' > !{output,,transcript_burden_reg_list_file} class_level transcript_burden

short cmd make_transcript_burden_vassoc_annot_file=$smart_join_cmd --in-delim $tab --header 1 --exec "sed '1 s/^/ID\n/' !{input,,transcript_burden_all_variant_list_file}" --exec "$smart_cut_cmd --in-delim $tab !{input,--file,gene_all_annot_file} --select-row 1,1 --select-row 1,1,$vep_trans_annot,eq:!{prop::transcript_burden:external_id} --select-col 1,1 --select-col 1,1,'$vassoc_meta_fields' --exact --require-col-match" --exec "$smart_cut_cmd --in-delim $tab !{input,--file,pheno_vassoc_annot_file}  --exclude-col 1,1,'$vassoc_meta_fields' --exact --require-col-match" --rest-extra 1 > !{output,,transcript_burden_vassoc_annot_file} class_level transcript_burden

case_count_helper=$smart_join_cmd --in-delim $tab --exec "$smart_join_cmd --in-delim $tab --header 1 --exec \"cut -f1 !{input,,transcript_burden_sample_list_file} | sed '1 s/^/ID\n/'\" !{input,--file,pheno_sequenced_all_sample_info_file} --extra 2 | $smart_cut_cmd --in-delim $tab --select-col 0,1,'ID !{prop,,pheno}' | $table_sum_stats_cmd --has-header --in-delim $tab --out-delim $tab --print-header --col !{prop,,pheno} --totals --group-col !{prop,,pheno} | $smart_cut_cmd --in-delim $tab --select-col 0,1 --select-col 0,1,!{prop,,pheno}_num --require-col-match --select-row 0,1,'$case_pheno_helper $control_pheno_helper' --exact" --exec "perl -e 'print \"$case_pheno_helper\t0\n$control_pheno_helper\t0\n\"'" --merge | $transpose_cmd --in-delim $tab | $smart_cut_cmd --in-delim $tab --select-col 0,1,'$case_pheno_helper $control_pheno_helper' --exact | tail -n+2

local cmd make_transcript_burden_gassoc_file=a=`$case_count_helper` && $pseq_qc_plus_all_assoc_cmd_pheno_variant_subset(v-assoc) $show_id --mask reg.req=@!{input,,transcript_burden_reg_list_file} --perm 1 !{prop,--phenotype,pheno} | $smart_cut_cmd --in-delim $tab --select-col 0,1,'MINA MINU OBSA OBSU' | $table_sum_stats_cmd --in-delim $tab --out-delim $tab --totals --col MINA --col MINU --col OBSA --col OBSU --has-header --print-header | $add_function_cmd --in-delim $tab --header 1 --col1 OBSA_tot --col2 OBSA_num --type divide --val-header OBSA | $add_function_cmd --in-delim $tab --header 1 --col1 OBSU_tot --col2 OBSU_num --type divide --val-header OBSU | $add_function_cmd --in-delim $tab --header 1 --col1 OBSU --val2 2 --type multiply --val-header OBSU2 | $add_function_cmd --in-delim $tab --header 1 --col1 OBSA --val2 2 --type multiply --val-header OBSA2 | $smart_cut_cmd --in-delim $tab --exact --select-col 0,1,'OBSA OBSU OBSA2 OBSU2 MINA_tot MINU_tot' | sed '1! s/^/!{prop,,gene_burden,disp}\t!{prop,,transcript_burden,disp}\t/' | sed '1 s/^/Variant\tTranscript\t/' | sed "1! s/$/\t\$a/" | sed '1 s/$/\tCase_carrier_count\tControl_carrier_count/' | $add_function_cmd --in-delim $tab --header 1 --col1 Case_carrier_count --col2 OBSA2 --type divide --val-header Case_carrier | $add_function_cmd --in-delim $tab --header 1 --col1 Control_carrier_count --col2 OBSU2 --type divide --val-header Control_carrier | $add_function_cmd --in-delim $tab --header 1 --col1 MINA_tot --col2 OBSA2 --type divide --val-header Case_load | $add_function_cmd --in-delim $tab --header 1 --col1 MINU_tot --col2 OBSU2 --type divide --val-header Control_load | $smart_cut_cmd --in-delim $tab --select-col 0,1,'Variant Transcript OBSA OBSU MINA_tot MINU_tot Case_load Control_load Case_carrier Control_carrier' --exclude-row 0,1 --exact --require-col-match | sed '1 s/^/Variants\tTranscript\tN\tN\tTot Counts\tTot Counts\tMean Count\tMean Count\tCarrier Frequency\tCarrier Frequency\nVariants\tTranscript\tCase\tControl\tCase\tControl\tCase\tControl\tCase\tControl\n/' | $smart_cut_cmd --in-delim $tab --exec "sed '1 s/\(.*\)/\1\n\1/' !{input,,burden_flat_gassoc_file}" --exact --require-col-match --select-col 1,1,'!{prop,,burden_test,test_tag,missing_prop=test_name,uc=1,if_prop=burden:eq:@burden}' --select-row 1,1 --select-row 1,2 `if [[ !{prop,,transcript_burden,external_id} == $consensus_transcript ]]; then echo --select-row 1,1,GENE,!{prop,,gene,external_id}; fi` --select-row 1,1,TRANSCRIPT,!{prop,,transcript_burden,external_id}  --and-row-all --paste --stdin-first  > !{output,,transcript_burden_gassoc_file} class_level transcript_burden skip_if pheno_qt run_if burden_test

transcript_burden_sample_list_helper=$burden_sample_list_helper_int(transcript_burden_all_variant_list_file,transcript_burden_reg_list_file,@1,@2,@3)

transcript_burden_sstats_helper=$gene_burden_or_variant_sstats_helper(transcript_burden,@1,@2)

pheno_pdf_helper1=$@{1}_sstats_helper(pheno_sequenced_all_sample_box_info_file,$tab) | $smart_cut_cmd --in-delim $tab --vec-delim : --exact --require-col-match --select-col 0,1,"`echo 'ID:Variant:Disp:!{prop,,pheno,disp} | sed 's/(/\\(/g' | sed 's/)/\\)/g'`" 
pheno_pdf_helper2=$draw_box_plot_cmd("/dev/stdin !{output,,@{1}_pheno_pdf_file} 'Effect of @2 on !{prop,,pheno,disp}' '' '!{prop,,pheno,disp} @3' '!{prop,,pheno,disp}' sep=$tab label=Disp order=Variant title.newline=: max.ncol=7")

pheno_pdf_helper=$pheno_pdf_helper1(@1) | $pheno_pdf_helper2(@1,@2,)

short cmd make_transcript_burden_sample_list_file=$transcript_burden_sample_list_helper(gt,transcript_burden_sample_list_file,'1 3') class_level transcript_burden

short cmd make_transcript_burden_sample_without_list_file=$transcript_burden_sample_list_helper(le,transcript_burden_sample_without_list_file,1) class_level transcript_burden

local cmd make_transcript_burden_pheno_pdf_file=$pheno_pdf_helper(transcript_burden,!{prop\\,\\,transcript_burden\\,disp} variants:in !{prop\\,\\,gene\\,disp}) class_level transcript_burden run_if burden_test

all_pheno_pdf_helper1=$@{1}_sstats_helper(pheno_sequenced_all_trait_all_sample_box_info_file,$tab) | $smart_cut_cmd --in-delim $tab --vec-delim : --exact --require-col-match --select-col 0,1,"`echo ID:Variant:Disp:!{prop,,pheno,disp}:!{prop,,pheno,disp,if_prop=pheno:eq:\@related_traits,if_prop=project:eq:\@project,all_instances=1,sep=:} | sed 's/(/\\(/g' | sed 's/)/\\)/g`" 
all_pheno_pdf_helper2=$draw_box_plot_cmd("/dev/stdin !{output,,@{1}_all_pheno_pdf_file} 'Effect of @2 on !{prop,,pheno,disp} and related traits' '' '' -ID,Variant,Disp sep=$tab label=Disp order=Variant title.newline=: max.ncol=7")

all_pheno_pdf_helper=$all_pheno_pdf_helper1(@1) | $all_pheno_pdf_helper2(@1,@2, fraction)

local cmd make_transcript_burden_all_pheno_pdf_file=$all_pheno_pdf_helper(transcript_burden,!{prop\\,\\,transcript_burden\\,disp} variants:in !{prop\\,\\,gene\\,disp}) class_level transcript_burden run_if related_traits run_if burden_test

short cmd make_transcript_burden_qq_pdf_file=cat !{input,,transcript_burden_vassoc_annot_file} $get_vassoc_file_helper(1,le:1,,transcript_burden) | $burden_vassoc_qq_pdf_helper(/dev/stdin,transcript_burden_qq_pdf_file,'!{prop\,\,gene_burden\,disp} variant associations for !{prop\,\,transcript_burden\,disp}: !{prop\,\,pheno\,disp}',transcript_burden,nrow=2 ncol=3) class_level transcript_burden skip_if no_var_qq

local cmd make_gene_burden_vassoc_tex_file=(head -n1 !{input,,transcript_burden_vassoc_annot_file,limit=1} | sed 's/^/Transcript\t/' && $smart_cut_cmd --in-delim $tab --exclude-row .,1 !{raw,,transcript_burden,--exec "sed 's/^/@disp\t/' *transcript_burden_vassoc_annot_file"} !{input,transcript_burden_vassoc_annot_file}) | $smart_cut_cmd --in-delim $tab --select-col 0,1,'ID Transcript !{prop::pheno:vassoc_meta_disp} $dp_helper GENO HWE P_MISSING MINA MINU MAFA MAFU $or_col_disp_pheno_test !{raw::pheno_test:${p_col_disp}_@test_tag:if_prop=use_for_display}' --exact --require-col-match | $sort_name_col_with_header(!{raw::pheno_test:${p_col_disp}_@test_tag:if_prop=use_for_display:limit=1},) | $translate_variant_type | $replace_var_id | $head_cmd(500) | $process_associated_variants_helper("!{prop::gene_burden:disp} variants for !{prop::gene:disp}: !{prop::pheno:disp}",11,--number-format P_MISSING\,%.2g --number-format HWE\,%.2g --number-format GENO\,%.2g !{raw::pheno:--number-format DP\,%d:if_prop=include_dp:allow_empty=1},10,20,1) > !{output,,gene_burden_vassoc_tex_file} class_level gene_burden run_if transcript_burden run_with transcript_burden skip_if no_var_filter

local cmd make_gene_burden_vassoc_pdf_file=$run_latex_cmd(gene_burden_vassoc_tex_file,gene_burden_vassoc_pdf_file) class_level gene_burden 

#variant cmds

variant_sample_list_helper=$pseq_qc_plus_all_analysis_cmd_pheno_variant_subset(v-matrix) $show_id --mask reg=!{prop,,variant,chrom}:!{prop,,variant,pos} | $smart_cut_cmd --exclude-col 0,1-3 --select-row 0,1 --select-row 0,1,!{prop,,variant,external_id} --in-delim $tab | $transpose_cmd --in-delim $tab | $smart_cut_cmd --select-col 0,1 --select-row 0,2,@1:0 --in-delim $tab | sed 's/\t/\n/g' > !{output,,@2}

variant_maf_helper_int=\$with = \`cat !{input,,variant_sample_list_file} | wc -l\`; \$without = \`cat !{input,,variant_sample_without_list_file} | wc -l\`; \$freq = \$with / (\$with + \$without); \$nsamp = \$with + \$without; \$dev = sqrt(\$freq * (1 - \$freq) / \$nsamp)

variant_maf_helper=`perl -e '$variant_maf_helper_int; print \$freq'`
variant_maf_lb_helper=`perl -e '$variant_maf_helper_int; \$lb = \$freq - 2 * \$dev; \$lb = 0 if \$lb < 0; print \$lb'`
variant_maf_ub_helper=`perl -e '$variant_maf_helper_int; \$ub = \$freq + 2 * \$dev; \$ub = 1 if \$ub > 1; print \$ub'`


local cmd make_variant_sample_list_file=$variant_sample_list_helper(gt,variant_sample_list_file) class_level variant

local cmd make_variant_sample_without_list_file=$variant_sample_list_helper(eq,variant_sample_without_list_file) class_level variant

!!expand:;:cmdtype;caselabel;ctrllabel;extrarunif\
:;Case;Ctrl;skip_if pheno_qt\
:qt_;$qt_top_disp;$qt_bottom_disp;run_if pheno_qt! \
local cmd make_variant_cmdtypetitle_slide_tex_file=perl -e 'print "Gene\t!{prop,,gene,disp}\nConsequence\t!{prop,,variant,consequence}\nChange\t!{prop,,variant,proteinchange}\n$disp_for_var_annot\t!{prop,,variant,var_annot}\ncaselabel:ctrllabel\t!{prop,,variant,ncase}:!{prop,,variant,ncontrol}\n"' | $table_to_beamer_cmd --no-border --col-emph 1 --title "Variant !{prop,,variant,chrom}:!{prop,,variant,pos}" --in-delim $tab --header-cols 1  > !{output,,variant_title_slide_tex_file} class_level variant extrarunif

local cmd make_variant_title_slide_pdf_file=$run_latex_cmd(variant_title_slide_tex_file,variant_title_slide_pdf_file) class_level variant

has_var_col_name=HAS_VAR

local cmd make_variant_mds_dat_file=$smart_join_cmd --exec "$smart_cut_cmd --exec \"sed 's/$/\tHas Variant/' !{input,,variant_sample_list_file}\" --exec \"sed 's/$/\tNo Variant/' !{input,,variant_sample_without_list_file}\" --in-delim $tab --out-delim $tab | sed '1 s/^/ID\t$has_var_col_name\n/'" --exec "$smart_join_cmd --exec \"$smart_cut_cmd !{input,--file,variant_sample_list_file} !{input,--file,variant_sample_without_list_file} !{input,--file,pheno_annotated_mds_file} --exclude-row 3,1 --select-col 3,1,ID --in-delim $tab --require-col-match | sort | uniq -d | sed '1 s/^/IID\n/'\" --exec \"$smart_cut_cmd !{input,--file,pheno_annotated_mds_file} --select-col 1,1,'ID ^C[0-9]' --in-delim $tab --require-col-match\" --header 1 --extra 2 --in-delim $tab" --header 1 --extra 1 --in-delim $tab > !{output,,variant_mds_dat_file} class_level variant

get_mds_cols_int=perl -e 'print join(@3"@2@3", map {@3"C@3\$_@3"} (1..@1))'
get_mds_cols=$get_mds_cols_int(@1,@2,)

variant_disp_helper=!{prop,,variant,proteinchange,if_prop=proteinchange:ne:NA,allow_empty=1}!{prop,,variant,disp,if_prop=proteinchange:eq:NA,allow_empty=1}

!|expand:;:type;colsarg:top;C1,C2:all;`$get_mds_cols(!{prop\\,\\,pheno\\,num_mds_plot},\\,)`| \
local cmd make_variant_type_mds_pdf_file=$draw_matrix_plot_cmd !{input,,variant_mds_dat_file} !{output,,variant_type_mds_pdf_file} 'Sample MDS Values: $variant_disp_helper' colsarg color.col=$has_var_col_name  sep=$tab cex=$mds_cex $mds_color class_level variant

#variant_sstats_helper=$smart_join_cmd --out-delim $tab --header 1 --exec "cut -d@2 -f1 !{input,,@1} | cat - !{input,,variant_sample_without_list_file} !{input,,variant_sample_list_file} | sort | uniq -d | sed '1 s/^/ID\n/'" --exec "$smart_cut_cmd --in-delim $tab --exec \"sed 's/$/\t1\tHas Variant/' !{input,,variant_sample_list_file}\" --exec \"sed 's/$/\t0\tNo Variant/' !{input,,variant_sample_without_list_file}\" | sed '1 s/^/ID\tVariant\tDisp\n/'" !{input,--file,@1} --rest-extra 1 --arg-delim : --in-delim 3:@2 --in-delim 2:$tab
variant_sstats_helper=$gene_burden_or_variant_sstats_helper(variant,@1,@2)

#local cmd make_variant_pheno_pdf_file=$variant_sstats_helper(pheno_sequenced_all_sample_info_file,$tab) | $smart_cut_cmd --in-delim $tab --vec-delim : --exact --require-col-match --select-col 0,1,'ID:Variant:Disp:!{prop,,pheno}' | awk -F"\t" '\$4 != !{prop,,pheno,pheno_missing}' | $draw_box_plot_cmd("/dev/stdin !{output,,variant_pheno_pdf_file} 'Effect of !{prop,,variant,disp} on !{prop,,pheno,disp}' '' '!{prop,,pheno,disp}' !{prop,,pheno} sep=$tab label=Disp order=Variant")  class_level variant run_if pheno_qt

local cmd make_variant_pheno_pdf_file=$pheno_pdf_helper(variant,!{prop\\,\\,gene\\,disp} $variant_disp_helper) class_level variant 

local cmd make_variant_all_pheno_pdf_file=$all_pheno_pdf_helper(variant,$variant_disp_helper) class_level variant run_if related_traits

local cmd make_variant_sstats_highlight_file=sed 's/$/,Variant/' !{input,,variant_sample_list_file} | sed '1 s/^/LABEL,MEASURE\n/' > !{output,,variant_sstats_highlight_file} class_level variant

!!expand:;:slidetype;dispcols:;-1,$display_col_name,$order_col_name,NVAR:slide_;Variant,$all_major_sstats_cols! \
local cmd make_variant_slidetypesstats_pdf_file=$variant_sstats_helper(pheno_sstats_file,\\,) | $smart_cut_cmd --in-delim $tab --exclude-col 0,1,Disp --exact | $draw_box_plot_cmd("/dev/stdin !{output,,variant_slidetypesstats_pdf_file} 'Sample QC properties for $variant_disp_helper' '' 'Sample Values' 'dispcols' label=$display_col_name order=$order_col_name sep=$tab $pheno_highlight_helper highlight.list.file=!{input,,variant_sstats_highlight_file} highlight.label.col=2")  class_level variant

short cmd make_variant_qc_metrics_tex_file=$make_gene_or_variant_qc_metrics_tex_file(variant) class_level variant

local cmd make_variant_qc_metrics_pdf_file=$run_latex_cmd(variant_qc_metrics_tex_file,variant_qc_metrics_pdf_file) class_level variant

short cmd make_variant_genome_pdf_file=zcat !{input,,pheno_annotated_genome_file} | perl -lne 'BEGIN {\$first = 1; \$h="Has variant"; \$n = "No variant"; %o = (\$h=>0, \$n=>1); open WITH, "!{input,,variant_sample_list_file}" or die "Cannot read !{input,,variant_sample_list_file\n"; while (<WITH>) { chomp; \$a{\$_}="Has Variant" } open WITHOUT, "!{input,,variant_sample_without_list_file}" or die "Cannot read !{input,,variant_sample_list_file\n"; while (<WITHOUT>) { chomp; \$a{\$_}="No variant" }} if (\$first) {\$first = 0; print && next} chomp; @F=split("\t"); if (\$a{\$F[0]} && \$a{\$F[1]}) { @v = (\$a{\$F[0]}, \$a{\$F[1]}); @o = map {\$o{\$_}} @v; \$F[2] = join("/", sort(@v)); \$F[3] = join("/", sort(@o)); print join("\t", @F)}' | $draw_box_plot_cmd(/dev/stdin !{output\,\,variant_genome_pdf_file} 'IBD sharing by $variant_disp_helper carrier' '' 'PI_HAT' PI_HAT sep=$tab label=$display_col_name order=$order_col_name max.plot.points=1000) class_level variant rusage_mod $genome_pdf_mem


num_per_igv_snapshot=3
igv_wait=5
#PREFER CMD BELOW WITHOUT PORT
#local cmd make_variant_igv_png_file=$open_vnc_display && python $targeted_bin_dir/write_igv_png.py --port $igv_port --locus chr!{prop,,variant,chrom}:!{prop,,variant,pos} `$smart_join_cmd --in-delim $tab !{input,--file,variant_sample_list_file} !{input,--file,project_sample_bam_list_file} --extra 2 | cut -f2 | $head_cmd($num_per_igv_snapshot) | sed 's/^/--bam-file /' | tr '\n' ' '` --igv-jar $igv_jar --hg-build $hg_build !{output,--out-png,variant_igv_png_file}; $close_vnc_display class_level variant timeout 300
local cmd make_variant_igv_png_file=$open_vnc_display && python $targeted_bin_dir/write_igv_png.py --locus chr!{prop,,variant,chrom}:!{prop,,variant,pos} `$smart_join_cmd --in-delim $tab !{input,--file,variant_sample_list_file} !{input,--file,project_sample_bam_list_file} --extra 2 | cut -f2 | $head_cmd($num_per_igv_snapshot) | sed 's/^/--bam-file /' | tr '\n' ' '` --igv-jar $igv_jar --hg-build $hg_build !{output,--out-png,variant_igv_png_file}; $close_vnc_display class_level variant timeout 300

local cmd make_variant_igv_pdf_file=convert !{input,,variant_igv_png_file} !{output,,variant_igv_pdf_file} class_level variant

ucsc_variant_buffer=10

local cmd make_variant_ucsc_regions_file=(echo $variant_disp_helper, human, hg$hg_build, chr!{prop,,variant,chrom}, !{prop,,variant,pos}, !{prop,,variant,pos}, \"$variant_disp_helper\", $(($ucsc_variant_buffer-1)), $(($ucsc_variant_buffer+1))) > !{output,,variant_ucsc_regions_file} class_level variant

local cmd make_variant_ucsc_pdf_file=$fetch_ucsc_cmd !{input,-r,variant_ucsc_regions_file} !{input,-t,pheno_ucsc_tracks_file} !{input,-u,pheno_ucsc_browser_file} !{output,--output-file,variant_ucsc_pdf_file} class_level variant

local cmd make_variant_r2_ld_file=$plink_cmd !{raw,--tfile,gene,*locus_combined_plink_file} !{input,locus_combined_tped_file} !{input,locus_combined_tfam_file} --ld-snp `awk '\$1 == !{prop,,variant,chrom} && \$4 == !{prop,,variant,pos} {print \$2} END {print "$variant_disp_helper"}' !{input,,locus_combined_tped_file} | awk 'NR == 1'` --r2 $ld_window_params !{raw,--out,variant,*variant_r2_trunk} !{output,variant_r2_ld_file} !{output,variant_r2_ld_log_file} class_level variant

local cmd make_variant_r2_annotated_ld_file=$smart_join_cmd --in-delim $tab --header 1 --extra 2 --exec "$smart_cut_cmd --out-delim $tab !{input,--file,variant_r2_ld_file} --select-col 1,1,'BP_B R2'" --exec "$smart_cut_cmd --out-delim $tab --exec \"sed 's/$/ Marker/' !{input,,locus_all_marker_bim_file}\" --exec \"sed 's/$/ Sequence/' !{input,,locus_non_marker_seq_bim_file}\" --select-col 1,'4 7' --select-col 2,'4 7' | sed '1 s/^/POS\tLABEL\n/'" > !{output,,variant_r2_annotated_ld_file} class_level variant

local cmd make_variant_r2_pdf_file=$draw_matrix_plot_cmd !{input,,variant_r2_annotated_ld_file} !{output,,variant_r2_pdf_file} 'LD with $variant_disp_helper' BP_B,R2 color.col=LABEL color.at=!{prop,,variant,pos},black,$variant_disp_helper class_level variant

max_var_ld_show=15

local cmd make_variant_r2_table_tex_file=$smart_cut_cmd !{input,--file,variant_r2_ld_file} --select-col 1,1,'SNP_B R2' | sort -grk2 | awk "NR <= $(($max_var_ld_show+1))" | sed '1 s/.*/SNP\t\$r^2\$/' | $table_to_beamer_cmd --header-rows 1 --title "Variants in LD with $variant_disp_helper"  > !{output,,variant_r2_table_tex_file} class_level variant

local cmd make_variant_r2_table_pdf_file=$run_latex_cmd(variant_r2_table_tex_file,variant_r2_table_pdf_file) class_level variant


cmd make_variant_beagle_phased_file=perl $targeted_bin_dir/make_hap_analysis_beagle_file.pl --variant $variant_disp_helper !{prop,--chr,variant,chrom} !{prop,--start,variant,pos} !{input,--beagle,locus_beagle_phased_file} !{input,--with-sample-list,variant_sample_list_file} !{input,--without-sample-list,variant_sample_without_list_file} > !{output,,variant_beagle_phased_file} class_level variant

analyze_haplotypes_cmd=$targeted_bin_dir/analyze_haplotypes.py
create_haplotype_tree_cmd=$targeted_bin_dir/create_haplotype_tree.py

num_additional_haplotype_analysis_samples=500
num_haplotype_samples_plot=200
hap_share_pct=.51
haplotype_analysis_perm=250
haplotype_analysis_one_error_perm=100
cmd make_variant_haplotype_analysis_files=python $analyze_haplotypes_cmd !{input,--haps-file,variant_beagle_phased_file} --hap-share-pct $hap_share_pct --num-additional-samples `$num_without_cmd` !{output,--write-best-hap,variant_best_hap_file,if_prop=nind:gt:1,allow_empty=1} --max-perm $haplotype_analysis_perm --max-one-error-perm $haplotype_analysis_one_error_perm > !{output,,variant_haplotype_analysis_file} class_level variant

hap_analysis_p_value_line=random sample haplotype uniqueness empirical p-value:
hap_analysis_shared_p_value_line=random shared marker sample haplotype uniqueness empirical p-value:
median_sharing_variant_line=Median shared CNV samps:
median_sharing_random_line=Median sharing random:
median_sharing_shared_line=Median sharing random with shared marker:


local cmd make_variant_haplotype_analysis_info_tex_file=(echo "Haplotype uniqueness empirical p-values" && \
  grep '$hap_analysis_p_value_line' !{input,,variant_haplotype_analysis_file} | head -n1 | sed 's/$hap_analysis_p_value_line/\tRelative to random samples:/' && \
  grep '$hap_analysis_shared_p_value_line' !{input,,variant_haplotype_analysis_file} | head -n1 | sed 's/$hap_analysis_shared_p_value_line/\tRelative to samples that share a SNP nearby:/' && \
	echo "Median haplotype sharing between sample pairs " && \
  grep '$median_sharing_variant_line' !{input,,variant_haplotype_analysis_file} | head -n1 | sed 's/$median_sharing_variant_line/\tWith rare variant:/' && \
  grep '$median_sharing_random_line' !{input,,variant_haplotype_analysis_file} | head -n1 | sed 's/$median_sharing_random_line/\tRandom:/' && \
  grep '$median_sharing_shared_line' !{input,,variant_haplotype_analysis_file} | head -n1 | sed 's/$median_sharing_shared_line/\tRandom that share a SNP nearby:/') \
  | perl -pe '\$_ = "\u\$_"' | sed 's/</\$<\$/' | $text_to_beamer_cmd --list-indent $tab --title "`echo \"Information about haplotype sharing: $variant_disp_helper\" | sed 's/\_/\\\_/g'`" > !{output,,variant_haplotype_analysis_info_tex_file,if_prop=nind:gt:1,allow_empty=1} class_level variant


local cmd make_variant_haplotype_analysis_info_pdf_file=$run_latex_cmd(variant_haplotype_analysis_info_tex_file,variant_haplotype_analysis_info_pdf_file) class_level variant

num_without_cmd=head -n1 !{input,,variant_beagle_phased_file} | sed 's/\s\s\*/\n/g' | tail -n+2 | sort -u | cat - !{input,,variant_sample_without_list_file} | sort | uniq -d | wc -l

create_haplotype_tree_helper=python $create_haplotype_tree_cmd !{input,--haps-file,variant_beagle_phased_file} --num-without `$num_without_cmd` !{input,--best-hap-file,variant_best_hap_file,if_prop=nind:gt:1,allow_empty=1} !{input,--phe-file,pheno_marker_pheno_file,if_prop=project_all_marker_pheno_file,if_prop=pheno_marker_initial_pheno_file,or_if_prop=1,allow_empty=1} --num-to-plot $num_haplotype_samples_plot --map-file $genetic_map_file("!{prop,,variant,chrom}")

short cmd make_variant_haplotype_analysis_pdf_file=$create_haplotype_tree_helper !{output,--out-pdf-file,variant_haplotype_analysis_pdf_file} --title "$variant_disp_helper haplotype sharing: sequenced samples" class_level variant

short cmd make_variant_haplotype_analysis_longest_pdf_file=$create_haplotype_tree_helper !{output,--out-pdf-file,variant_haplotype_analysis_longest_pdf_file} --plot-longest --label-all !{output,--out-freq-file,variant_haplotype_analysis_freq_file} !{output,--out-seg-file,variant_haplotype_analysis_initial_seg_file} --title "$variant_disp_helper haplotype sharing: longest shared" class_level variant

local cmd make_variant_haplotype_analysis_seg_file=perl $targeted_bin_dir/annotate_initial_seg_file.pl !{input,--fam-file,locus_common_marker_tfam_file} !{input,--map-file,locus_common_marker_tped_file} !{input,--pheno-file,pheno_marker_pheno_file} < !{input,,variant_haplotype_analysis_initial_seg_file} > !{output,,variant_haplotype_analysis_seg_file} class_level variant

local cmd make_variant_hap_posterior_file=$predict_log_reg_cmd("!{input,,variant_haplotype_analysis_initial_seg_file} !{output,,variant_hap_posterior_file} START,STOP,SHARES_MIN CARRIER out.sep=$tab") class_level variant

count_posterior_samp_include=!{input,--exclude-samps,variant_sample_list_file} !{input,--exclude-samps,variant_sample_without_list_file} !{input,--include-samps,project_all_marker_assoc_sample_keep_file,if_prop=project_all_marker_assoc_sample_keep_file,unless_prop=pheno_all_marker_assoc_sample_keep_file,allow_empty=1} !{input,--include-samps,pheno_all_marker_assoc_sample_keep_file,if_prop=pheno_all_marker_assoc_sample_keep_file,allow_empty=1}

local cmd make_variant_hap_count_posterior_file=perl $targeted_bin_dir/make_var_count_posterior.pl $count_posterior_samp_include < !{input,,variant_hap_posterior_file} > !{output,,variant_hap_count_posterior_file} class_level variant

#use the genotype file as backup
local cmd make_variant_traditional_count_posterior_file=cat !{input,,locus_combined_merged_impute2_file} | perl $targeted_bin_dir/make_var_count_posterior.pl $count_posterior_samp_include !{prop,--only-pos,variant,pos} !{input,--samp-file,locus_combined_sample_file}  --impute2-format > !{output,,variant_traditional_count_posterior_file} class_level variant

!!expand:impute_type:hap:traditional! \
cmd make_variant_impute_type_threshold_vassoc_file=$threshold_vassoc_cmd("!{input,,variant_impute_type_count_posterior_file} !{output,,variant_impute_type_threshold_vassoc_file} !{input,,pheno_marker_pheno_file} 1 2 pheno.has.header=FALSE !{input,covar.file=,project_all_marker_assoc_covars_file,if_prop=project_all_marker_assoc_covars_file,allow_empty=1} !{raw,covar.cols.delim=,project,:,if_prop=project_all_marker_assoc_covars_file,allow_empty=1} !{raw,covar.id.col=,project,IID,if_prop=project_all_marker_assoc_covars_file,allow_empty=1} !{raw,covar.covar.cols=,project,-FID:IID,if_prop=project_all_marker_assoc_covars_file,allow_empty=1}") class_level variant

add_na_row_helper=perl -pe 'END {print \"NA\tNA\tNA\n\"}' | sed '1! s/^NA.\*//'  | sed '/^\$/d'

!!expand:,:impute_type:hap:traditional! \
local cmd make_variant_impute_type_summary_file=$smart_cut_cmd --in-delim $tab \
			--exec "perl -e 'print \"VAR\n!{prop,,variant,disp}\n\"'" \
			--exec "perl -e 'print \"CHROM\n!{prop,,variant,chrom}\n\"'" \
			--exec "perl -e 'print \"POS\n!{prop,,variant,pos}\n\"'" \
  --exec "perl $targeted_bin_dir/summarize_threshold_vassoc.pl $variant_maf_lb_helper $variant_maf_ub_helper < !{input,,variant_impute_type_threshold_vassoc_file}" \
	--exec "(grep '$hap_analysis_p_value_line' !{input,,variant_haplotype_analysis_file} | head -n1 | sed 's/$hap_analysis_p_value_line\s*//' | sed 's/<//' || echo NA) | sed '1 s/^/P_UNIQUE\n/'" \
	--paste > !{output,,variant_impute_type_summary_file} class_level variant

threshold_vassoc_plot_width=10
threshold_vassoc_plot_height=6

!!expand:,:impute_type,impute_disp:hap,haplotype:traditional,Impute2! \
local cmd make_variant_impute_type_threshold_vassoc_pdf_file=$draw_line_plot_cmd !{input,,variant_impute_type_threshold_vassoc_file} !{output,,variant_impute_type_threshold_vassoc_pdf_file} '!{prop,,pheno,disp} association score for $variant_disp_helper --- impute_disp imputation' 'Posterior Threshold' 'Assoc P-value' THRESHOLD 'P' sep=$tab y2.col=F,F_CASE,F_CONTROL y2.label=Frequency hline=0.05 hline.name='P .05' hline2=$variant_maf_helper hline2.name='Seq MAF' x.log=T y2.log=T y.minus.log=T legend.pos="bottomleft" plot.width=$threshold_vassoc_plot_width plot.height=$threshold_vassoc_plot_height class_level variant


threshold_vassoc

#the master slide files

!|expand:;:curlevel;Curlevel;dispprop;extra:project;Project level;disp;:pheno;Phenotype level;pheno_description;:burden;Variant group;disp; variants:gene;Gene level;disp;\n!{prop,,pheno,pheno_description}\n:locus;Locus level;disp;\n!{prop,,pheno,pheno_description}\n| \
local cmd make_curlevel_title_slide_tex_file=perl -e 'print "!{prop,,curlevel,dispprop}extra"' | $table_to_beamer_cmd --no-border --row-emph 1 --title "Curlevel summary" --in-delim $tab --header-cols 1 > !{output,,curlevel_title_slide_tex_file} class_level curlevel

local cmd make_project_additional_slide_tex_file=perl -e 'print "Additional slides"' | $table_to_beamer_cmd --no-border --row-emph 1 --in-delim $tab > !{output,,project_additional_slide_tex_file} class_level project

!!expand:,:titletype,Titletype:qc,QC:assoc,Association:gene,Top genes! \
local cmd make_pheno_titletype_title_slide_tex_file=perl -e 'print "!{prop,,pheno,pheno_description}"' | $table_to_beamer_cmd --no-border --row-emph 1 --title "Titletype summary" --in-delim $tab --header-cols 1 > !{output,,pheno_titletype_title_slide_tex_file} class_level pheno


!!expand:,:curlevel,extra:project,:pheno,:burden,:pheno,_gene:pheno,_qc:pheno,_assoc:gene,:variant,:locus,! \
local cmd make_curlevelextra_title_slide_pdf_file=$run_latex_cmd(curlevelextra_title_slide_tex_file,curlevelextra_title_slide_pdf_file) class_level curlevel

local cmd make_project_additional_slide_pdf_file=$run_latex_cmd(project_additional_slide_tex_file,project_additional_slide_pdf_file) class_level project


optional_cat=if [ -e @1 ]; then cat @1; else true; fi
optional_pdftops=if [ -e @1 ]; then pdftops @1 -; else true; fi
optional_converttops=if [ -e @1 ]; then convert @1 ps:-; else true; fi

mpjh=!{raw,,@1,--exec "$optional_pdftops(*@2)"} !{input,@2,optional=1}
mpjhf=!{raw,,@1,--exec "$optional_pdftops(*@2)",@3} !{input,@2,optional=1}

mcjh=!{raw,,@1,--exec "$optional_converttops(*@2)"} !{input,@2,optional=1}
mcjhf=!{raw,,@1,--exec "$optional_converttops(*@2)",@3} !{input,@2,optional=1}

mph=!{raw,,@1,--exec "$optional_cat(*@2)"} !{input,@2,optional=1}
mphf=!{raw,,@1,--exec "$optional_cat(*@2)",@3} !{input,@2,optional=1}

local cmd make_project_slide_master_ps_file=$smart_cut_cmd \
 $mpjh(project,project_title_slide_pdf_file) \
 $mpjh(project,project_slide_failures_pdf_file) \
 $mpjhf(seq_batch,seq_batch_picard_pdf_file,allow_empty=1) \
 $mpjhf(pheno,pheno_slide_failures_bar_pdf_file,if_prop=not_trait\,allow_empty=1) \
 $mpjhf(pheno,pheno_slide_failures_pdf_file,if_prop=not_trait\,allow_empty=1) \
 $mpjhf(pheno,pheno_slide_cross_failures_pdf_file,if_prop=not_trait\,allow_empty=1) \
 $mpjh(project,project_sample_cum_coverage_pdf_file) \
 $mpjhf(pheno,pheno_sample_coverage_pdf_file,if_prop=not_trait\,allow_empty=1) \
 $mpjh(project,project_slide_genes_pdf_file) \
 $mpjh(project,project_gene_cum_coverage_pdf_file) \
 $mpjhf(project,project_gene_dist_coverage_pdf_file,unless_prop=whole_exome\,allow_empty=1) \
 $mpjhf(project,project_lowest_gene_dist_coverage_pdf_file,unless_prop=whole_exome\,allow_empty=1) \
 $mpjh(project,project_gene_gc_pdf_file) \
 $mpjh(project,project_slide_exons_pdf_file) \
 $mpjh(project,project_exon_cum_coverage_pdf_file) \
 $mpjh(project,project_slide_baits_pdf_file) \
 $mpjh(project,project_bait_cum_coverage_pdf_file) \
 $mpjh(project,project_slide_vcounts_pdf_file) \
 $mpjh(project,project_slide_titv_pdf_file) \
 $mpjh(project,project_titv_ac_pdf_file) \
 $mpjh(project,project_slide_theta_pdf_file) \
 $mpjh(project,project_slide_ref_theta_pdf_file) \
 $mpjhf(marker,marker_positive_control_genotype_concordance_sum_pdf_file,if_prop=marker\,allow_empty=1) \
 $mpjh(project,project_sstats_initial_pdf_file) \
 $mpjhf(pheno,pheno_all_sstats_pdf_file,if_prop=qc_trait) \
 $mpjhf(pheno,pheno_slide_all_sstats_pdf_file,if_prop=qc_trait) \
 $mpjh(project,project_sstats_highlighted_pdf_file) \
 $mpjhf(pheno,pheno_highlighted_sstats_pdf_file,if_prop=qc_trait) \
 $mpjh(project,project_slide_sstats_highlighted_pdf_file) \
 $mpjh(project,project_slide_seq_qc_failures_pdf_file) \
 $mpjh(project,project_sstats_final_pdf_file) \
 $mpjh(project,project_slide_sstats_final_pdf_file) \
 $mpjhf(pheno,pheno_top_mds_pdf_file,if_prop=not_trait\,allow_empty=1) \
 $mpjhf(pheno,pheno_all_mds_pdf_file,if_prop=not_trait\,allow_empty=1) \
 $mpjh(project,project_vstats_initial_pdf_file) \
 $mpjh(project,project_vstats_highlighted_pdf_file) \
 $mpjh(project,project_vstats_final_pdf_file) \
 $mpjh(project,project_slide_var_qc_failures_pdf_file) \
 $mpjh(project,project_slide_var_pass_counts_pdf_file) \
 $mpjh(project,project_slide_sample_var_pass_counts_pdf_file) \
 $mpjh(project,project_gstats_pdf_file) \
 $mpjh(project,project_gstats_highlighted_pdf_file) \
 > !{output,,project_slide_master_ps_file} class_level project

local cmd make_project_slide_master_pdf_file=epstopdf !{input,,project_slide_master_ps_file} !{output,--outfile=,project_slide_master_pdf_file} class_level project

local cmd make_burden_slide_master_ps_file=$smart_cut_cmd \
 $mpjh(burden,burden_title_slide_pdf_file) \
 $mpjhf(burden,pheno_pheno_test_info_pdf_file,unless_prop=no_var_qq\,unless_prop=no_var_filter\,or_if_prop=1\,allow_empty=1) \
 $mpjhf(burden,burden_common_vassoc_qq_pdf_file,unless_prop=no_var_qq\,allow_empty=1) \
 $mpjhf(burden,burden_uncommon_vassoc_qq_pdf_file,unless_prop=no_var_qq\,allow_empty=1) \
 $mpjhf(burden,burden_rare_vassoc_qq_pdf_file,unless_prop=no_var_qq\,allow_empty=1) \
 $mpjhf(burden,burden_slide_common_vassoc_pdf_file,unless_prop=no_var_filter\,allow_empty=1) \
 $mpjhf(burden,burden_slide_common_vassoc_meta_trait_pdf_file,unless_prop=no_var_filter\,if_prop=meta_trait_inv\,allow_empty=1) \
 $mpjhf(burden,burden_slide_vassoc_pdf_file,unless_prop=no_var_filter\,allow_empty=1) \
 $mpjhf(burden,burden_slide_vassoc_meta_trait_pdf_file,unless_prop=no_var_filter\,if_prop=meta_trait_inv\,allow_empty=1) \
 $mpjhf(burden,burden_slide_unique_pdf_file,unless_prop=no_var_filter\,allow_empty=1) \
 $mpjhf(burden,burden_slide_unique_meta_trait_pdf_file,unless_prop=no_var_filter\,if_prop=meta_trait_inv\,allow_empty=1) \
 $mpjhf(burden,burden_burden_test_info_pdf_file,if_prop=burden_test\,allow_empty=1) \
 $mpjhf(burden,burden_gassoc_qq_pdf_file,if_prop=burden_test\,unless_prop=no_gene_qq\,allow_empty=1) \
 $mpjhf(burden,burden_slide_gassoc_pdf_file,if_prop=burden_test\,allow_empty=1) \
 > !{output,,burden_slide_master_ps_file} class_level burden

local cmd make_burden_slide_master_pdf_file=epstopdf !{input,,burden_slide_master_ps_file} !{output,--outfile=,burden_slide_master_pdf_file} class_level burden

local cmd make_pheno_slide_master_pdf_file=epstopdf !{input,,pheno_slide_master_ps_file} !{output,--outfile=,pheno_slide_master_pdf_file} class_level pheno


local cmd make_pheno_slide_master_qc_ps_file=$smart_cut_cmd \
 $mpjh(pheno,pheno_qc_title_slide_pdf_file) \
 $mpjh(pheno,pheno_slide_failures_bar_pdf_file) \
 $mpjh(pheno,pheno_slide_failures_pdf_file) \
 $mpjhf(pheno,pheno_slide_cross_failures_pdf_file,unless_prop=is_cross_classification\,allow_empty=1) \
 $mpjhf(pheno,pheno_trait_hist_pdf_file,if_prop=pheno_qt\,allow_empty=1) \
 $mpjh(pheno,pheno_sample_coverage_pdf_file) \
 $mpjh(pheno,pheno_slide_filtered_sstats_pdf_file) \
 $mpjh(pheno,pheno_top_mds_pdf_file) \
 $mpjh(pheno,pheno_all_mds_pdf_file) \
 $mpjh(pheno,pheno_all_related_pdf_file) \
 $mpjh(pheno,pheno_unrelated_related_pdf_file) \
 $mpjh(pheno,pheno_popgen_all_pdf_file) \
 $mpjh(pheno,pheno_popgen_highlighted_pdf_file) \
 $mpjh(pheno,pheno_slide_popgen_qc_failures_pdf_file) \
 $mpjh(pheno,pheno_popgen_final_pdf_file) \
 $mpjh(pheno,pheno_popgen_unrelated_pdf_file) \
 $mpjh(pheno,pheno_slide_popgen_sstats_pdf_file) \
 $mpjh(pheno,pheno_genome_pdf_file) \
 $mpjhf(pheno,pheno_cluster_assign_mds_pdf_file,allow_empty=1) \
 $mpjhf(pheno,pheno_cluster_stats_pdf_file,allow_empty=1) \
 > !{output,,pheno_slide_master_qc_ps_file} class_level pheno skip_if not_trait

local cmd make_pheno_slide_master_assoc_ps_file=$smart_cut_cmd \
 $mpjh(pheno,pheno_assoc_title_slide_pdf_file) \
 $mph(burden,burden_slide_master_ps_file) \
 $mpjh(pheno,pheno_interesting_counts_pdf_file) \
 > !{output,,pheno_slide_master_assoc_ps_file} class_level pheno skip_if not_trait

local cmd make_pheno_slide_master_ps_file=$smart_cut_cmd \
 $mpjh(pheno,pheno_title_slide_pdf_file) \
 $mph(pheno,pheno_slide_master_qc_ps_file) \
 $mph(pheno,pheno_slide_master_assoc_ps_file) \
 > !{output,,pheno_slide_master_ps_file} class_level pheno skip_if not_trait


local cmd make_pheno_slide_master_pdf_file=epstopdf !{input,,pheno_slide_master_ps_file} !{output,--outfile=,pheno_slide_master_pdf_file} class_level pheno

local cmd make_pheno_slide_master_genes_ps_file=$smart_cut_cmd \
 $mpjh(pheno,pheno_gene_title_slide_pdf_file) \
 $mph(gene,gene_slide_master_sum_ps_file) \
 > !{output,,pheno_slide_master_genes_ps_file} class_level pheno skip_if not_trait

!!expand:titletype:qc:assoc:genes! \
local cmd make_pheno_slide_master_titletype_pdf_file=epstopdf !{input,,pheno_slide_master_titletype_ps_file} !{output,--outfile=,pheno_slide_master_titletype_pdf_file} class_level pheno


local cmd make_locus_slide_master_ps_file=$smart_cut_cmd \
 $mpjh(locus,locus_title_slide_pdf_file) \
 $mpjh(locus,locus_fancy_marker_plot_pdf_file) \
 $mpjh(locus,locus_fancy_plot_pdf_file) \
 $mpjh(locus,locus_var_coverage_pdf_file) \
 $mpjhf(gene,gene_var_pdf_file,allow_empty=1) \
 > !{output,,locus_slide_master_ps_file} class_level locus

local cmd make_locus_slide_master_pdf_file=epstopdf !{input,,locus_slide_master_ps_file} !{output,--outfile=,locus_slide_master_pdf_file} class_level locus

local cmd make_gene_slide_master_ps_file=$smart_cut_cmd \
 $mpjh(gene,gene_title_slide_pdf_file) \
 $mpjh(locus,locus_fancy_marker_plot_pdf_file) \
 $mpjh(gene,gene_ucsc_pdf_file) \
 $mpjh(gene,gene_qq_pdf_file) \
 $mpjh(gene,gene_var_pdf_file) \
 $mpjhf(gene_burden,gene_burden_vassoc_pdf_file,unless_prop=no_var_filter) \
 $mpjhf(gene,gene_meta_trait_associated_pdf_file,if_prop=meta_trait_inv\,allow_empty=1) \
 $mpjhf(gene,gene_all_trait_associated_pdf_file,if_prop=related_traits\,allow_empty=1) \
 $mpjh(gene,gene_gassoc_pdf_file) \
 $mpjh(project,project_additional_slide_pdf_file) \ 
 $mpjh(gene,gene_var_counts_pdf_file) \
 $mpjh(gene,gene_var_coverage_pdf_file) \
 $mpjh(gene,gene_qc_metrics_pdf_file) \
 $mpjh(gene,gene_all_variants_pdf_file) \
 $mpjh(gene,gene_all_data_pdf_file) \
 $mphf(variant,variant_slide_master_ps_file,allow_empty=1) \
 > !{output,,gene_slide_master_ps_file} class_level gene

local cmd make_gene_slide_master_pdf_file=epstopdf !{input,,gene_slide_master_ps_file} !{output,--outfile=,gene_slide_master_pdf_file} class_level gene

local cmd make_gene_burden_slide_master_ps_file=$smart_cut_cmd \
 $mpjhf(gene_burden,gene_burden_vassoc_pdf_file,unless_prop=no_var_filter\,allow_empty=1) \
 $mpjhf(transcript_burden,transcript_burden_pheno_pdf_file,if_prop=burden_test\,allow_empty=1) \
 $mpjhf(transcript_burden,transcript_burden_all_pheno_pdf_file,if_prop=related_traits\,if_prop=burden_test\,allow_empty=1) \
 > !{output,,gene_burden_slide_master_ps_file} class_level gene_burden skip_if and,no_var_filter,no_var_qq,no_burden_test

local cmd make_gene_burden_slide_master_pdf_file=epstopdf !{input,,gene_burden_slide_master_ps_file} !{output,--outfile=,gene_burden_slide_master_pdf_file} class_level gene_burden

local cmd make_gene_slide_master_sum_ps_file=$smart_cut_cmd \
 $mpjh(gene,gene_title_slide_pdf_file) \
 $mpjh(gene,gene_var_pdf_file) \
 > !{output,,gene_slide_master_sum_ps_file} class_level gene

local cmd make_gene_slide_master_sum_pdf_file=epstopdf !{input,,gene_slide_master_sum_ps_file} !{output,--outfile=,gene_slide_master_sum_pdf_file} class_level gene


local cmd make_variant_slide_master_ps_file=$smart_cut_cmd \
 $mpjh(variant,variant_title_slide_pdf_file) \
 $mpjh(variant,variant_ucsc_pdf_file) \
 $mpjh(variant,variant_pheno_pdf_file) \
 $mpjhf(variant,variant_all_pheno_pdf_file,if_prop=related_traits\,allow_empty=1) \
 $mpjh(variant,variant_slide_sstats_pdf_file) \
 $mpjh(variant,variant_sstats_pdf_file) \
 $mpjh(variant,variant_igv_pdf_file) \
 $mpjh(variant,variant_top_mds_pdf_file) \
 $mpjh(variant,variant_all_mds_pdf_file) \
 $mpjh(variant,variant_genome_pdf_file) \
 $mpjhf(variant,variant_r2_pdf_file,if_prop=nind:gt:1\,allow_empty=1) \
 $mpjhf(variant,variant_r2_table_pdf_file,if_prop=nind:gt:1\,allow_empty=1) \
 $mpjhf(variant,variant_haplotype_analysis_info_pdf_file,if_prop=nind:gt:1\,allow_empty=1) \
 $mpjhf(variant,variant_haplotype_analysis_pdf_file,if_prop=nind:gt:1\,allow_empty=1) \
 $mpjhf(variant,variant_haplotype_analysis_longest_pdf_file,if_prop=nind:gt:1\,allow_empty=1) \
 $mpjhf(variant,variant_hap_threshold_vassoc_pdf_file,if_prop=nind:gt:1\,allow_empty=1) \
 $mpjhf(variant,variant_traditional_threshold_vassoc_pdf_file,if_prop=nind:gt:1\,allow_empty=1) \
 > !{output,,variant_slide_master_ps_file} class_level variant

local cmd make_variant_slide_master_pdf_file=epstopdf !{input,,variant_slide_master_ps_file} !{output,--outfile=,variant_slide_master_pdf_file} class_level variant
